{"Title":"Azure AD Connect 同步：更改 Azure AD Connect 同步服务帐户","Description":"本主题文档介绍加密密钥，以及如何在更改密码后将其放弃。","Content":"# <a name=\"changing-the-azure-ad-connect-sync-service-account-password\"></a>更改 Azure AD Connect 同步服务帐户密码\r\n如果更改了 Azure AD Connect 同步服务帐户密码，则无法正常启动同步服务，除非已弃用加密密钥并重新初始化 Azure AD Connect 同步服务帐户密码。 \r\n\r\nAzure AD Connect 是同步服务的一部分，使用加密密钥来存储 AD DS 和 Azure AD 服务帐户的密码。  这些帐户在存储到数据库之前会进行加密。 \r\n\r\n所使用的加密密钥通过 [Windows 数据保护 (DPAPI)](https://msdn.microsoft.com/library/ms995355.aspx) 进行保护。 DPAPI 使用 **Azure AD Connect 同步服务帐户的密码**来保护加密密钥。 \r\n\r\n如果需要更改服务帐户密码，可以使用[放弃 Azure AD Connect 同步加密密钥](#abandoning-the-azure-ad-connect-sync-encryption-key)中的过程来完成该操作。  不管出于何种原因需要放弃加密密钥，都应该可以使用这些过程。\r\n\r\n##<a name=\"issues-that-arise-from-changing-the-password\"></a>更改密码导致的问题\r\n更改服务帐户密码时，需要完成两项操作。\r\n\r\n首先，需要在 Windows 服务控制管理器下更改密码。  在此问题解决之前，会一直显示以下错误：\r\n\r\n\r\n- 如果尝试在 Windows 服务控制管理器中启动同步服务，会收到“Windows 无法在本地计算机上启动 Azure AD 同步服务”错误。 **错误 1069：服务因登录失败而无法启动。**\r\n- 在 Windows 事件查看器中，系统事件日志包含**事件 ID 为 7038** 且内容为“ADSync 服务无法通过当前配置的密码登录，因为出现以下错误: 用户名或密码不正确”的错误。\r\n\r\n其次，在特定条件下，如果密码已更新，则同步服务无法再通过 DPAPI 检索加密密钥。 没有加密密钥，同步服务就不能解密在本地 AD 和 Azure AD 之间进行同步所需的密码。\r\n此时会出现错误，例如：\r\n\r\n- 如果尝试在 Windows 服务控制管理器中启动同步服务，但却无法检索加密密钥，则该服务会失败，并且会出现错误“**Windows 无法在本地计算机上启动 Azure AD 同步”错误。 有关详细信息，请查看系统事件日志。 如果该服务是 非 Microsoft 服务，请联系服务供应商，并请参阅特定于服务的错误代码 **-21451857952****。”\r\n- 在 Windows 事件查看器中，应用程序事件日志包含**事件 ID 为 6028** 且内容为“服务器加密密钥无法访问”的错误消息。\r\n\r\n若要确保不收到这些错误，请在更改密码时，按[放弃 Azure AD Connect 同步加密密钥](#abandoning-the-azure-ad-connect-sync-encryption-key)中的过程操作。\r\n \r\n## <a name=\"abandoning-the-azure-ad-connect-sync-encryption-key\"></a>放弃 Azure AD Connect 同步加密密钥\r\n>[!IMPORTANT]\r\n>以下过程仅适用于 Azure AD Connect 1.1.443.0 或更低版本。\r\n\r\n请按以下过程操作，放弃加密密钥。\r\n\r\n### <a name=\"what-to-do-if-you-need-to-abandon-the-encryption-key\"></a>如果需要放弃加密密钥，该怎么办\r\n\r\n如果需要放弃加密密钥，请执行以下过程。\r\n\r\n1. [放弃现有的加密密钥](#abandon-the-existing-encryption-key)\r\n\r\n2. [提供 AD DS 帐户的密码](#provide-the-password-of-the-ad-ds-account)\r\n\r\n3. [重新初始化 Azure AD 同步帐户的密码](#reinitialize-the-password-of-the-azure-ad-sync-account)\r\n\r\n4. [启动同步服务](#start-the-synchronization-service)\r\n\r\n#### <a name=\"abandon-the-existing-encryption-key\"></a>放弃现有的加密密钥\r\n放弃现有的加密密钥，以便创建新的加密密钥：\r\n\r\n1. 以管理员身份登录到 Azure AD Connect 服务器。\r\n\r\n2. 启动新的 PowerShell 会话。\r\n\r\n3. 导航到文件夹 `$env:Program Files\\Azure AD Sync\\bin\\`\r\n\r\n4. 运行命令 `./miiskmu.exe /a`\r\n\r\n    ![Azure AD Connect 同步加密密钥实用工具](./media/active-directory-aadconnectsync-encryption-key/key5.png)\r\n\r\n#### <a name=\"provide-the-password-of-the-ad-ds-account\"></a>提供 AD DS 帐户的密码\r\n由于存储在数据库中的现有密码再也不能解密，因此需提供同步服务以及 AD DS 帐户的密码。 同步服务使用新的加密密钥对密码加密：\r\n\r\n1. 启动 Synchronization Service Manager（“开始”→“同步服务”）。\r\n</br>![Sync Service Manager](./media/active-directory-aadconnectsync-service-manager-ui/startmenu.png)  \r\n2. 转到“连接器”选项卡。\r\n3. 选择与本地 AD 对应的“AD 连接器”。 如果有多个 AD 连接器，请针对每个连接器重复以下步骤。\r\n4. 在“操作”下面，选择“属性”。\r\n5. 在弹出对话框中，选择“连接到 Active Directory 林”：\r\n6. 在“密码”文本框中输入 AD DS 帐户的密码。 如果不知道该密码，则必须将其设置为某个已知值，再执行此步骤。\r\n7. 单击“确定”保存新密码并关闭弹出对话框。\r\n\r\n    ![Azure AD Connect 同步加密密钥实用工具](./media/active-directory-aadconnectsync-encryption-key/key6.png)\r\n\r\n#### <a name=\"reinitialize-the-password-of-the-azure-ad-sync-account\"></a>重新初始化 Azure AD 同步帐户的密码\r\n不能直接向同步服务提供 Azure AD 服务帐户的密码， 而只能使用 cmdlet **Add-ADSyncAADServiceAccount** 重新初始化 Azure AD 服务帐户。 该 cmdlet 重置帐户密码，并使其可供同步服务使用：\r\n\r\n1. 在 Azure AD Connect 服务器上启动新的 PowerShell 会话。\r\n2. 运行 cmdlet `Add-ADSyncAADServiceAccount`。\r\n3. 在弹出对话框中，为 Azure AD 租户提供 Azure AD 全局管理员凭据。\r\n![Azure AD Connect 同步加密密钥实用工具](./media/active-directory-aadconnectsync-encryption-key/key7.png)\r\n4. 如果成功，会看到 PowerShell 命令提示符。\r\n\r\n#### <a name=\"start-the-synchronization-service\"></a>启动同步服务\r\n同步服务可以访问加密密钥及其所需的所有密码以后，即可在 Windows 服务控制管理器中重新启动该服务：\r\n\r\n\r\n1. 转到“Windows 服务控制管理器”（“启动”→“服务”）。\r\n2. 选择“Azure AD 同步”，并单击“重新启动”。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n**概述主题**\r\n\r\n- [Azure AD Connect 同步：理解和自定义同步](active-directory-aadconnectsync-whatis.md)\r\n\r\n- [将本地标识与 Azure Active Directory 集成](active-directory-aadconnect.md)\r\n\r\n<!-- Update_Description: update meta properties -->"}