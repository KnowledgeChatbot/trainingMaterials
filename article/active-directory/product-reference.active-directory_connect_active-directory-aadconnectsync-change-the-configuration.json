{"Title":"Azure AD Connect 同步：在 Azure AD Connect 同步中进行配置更改","Description":"介绍如何对 Azure AD Connect 同步中的配置进行更改。","Content":"# <a name=\"azure-ad-connect-sync-how-to-make-a-change-to-the-default-configuration\"></a>Azure AD Connect 同步：如何更改默认配置\r\n本主题旨在介绍如何对 Azure AD Connect 同步中的默认配置进行更改。 其中提供了一些常见方案的步骤。 了解这些知识后，用户应该能够根据自己的业务规则对自己的配置进行一些简单的更改。\r\n\r\n## <a name=\"synchronization-rules-editor\"></a>同步规则编辑器\r\n同步规则编辑器用于查看和更改默认配置。 可以在 **Azure AD Connect** 组下的开始菜单中找到它。  \r\n![具有同步规则编辑器的开始菜单](./media/active-directory-aadconnectsync-change-the-configuration/startmenu2.png)\r\n\r\n打开时，会看到现成可用的默认规则。\r\n\r\n![同步规则编辑器](./media/active-directory-aadconnectsync-change-the-configuration/sre2.png)\r\n\r\n### <a name=\"navigating-in-the-editor\"></a>在编辑器中导航\r\n通过编辑器顶部的下拉列表可以快速查找特定规则。 例如，如果想要查看包含属性 proxyAddresses 的规则，可将下拉列表更改为：  \r\n![SRE 筛选](./media/active-directory-aadconnectsync-change-the-configuration/filtering.png)  \r\n若要重置筛选并加载新配置，请按键盘上的 **F5** 。\r\n\r\n右上角上有一个“添加新规则” 按钮。 此按钮用于创建自定义规则。\r\n\r\n顶部有用于执行所选同步规则的按钮。 “编辑”和“删除”按钮可执行其应有的操作。  按钮可生成用于创建同步规则的 PowerShell 脚本。 可通过此过程将同步规则从一台服务器移到另一台服务器。\r\n\r\n## <a name=\"create-your-first-custom-rule\"></a>创建第一个自定义规则\r\n最常见的更改是对属性流的更改。 源目录中的数据可能与 Azure AD 中的不同。 在本部分的示例中，需要确保用户的给定名称始终为 **首字母大写**。\r\n\r\n### <a name=\"disable-the-scheduler\"></a>禁用计划程序\r\n默认情况下，[计划程序](active-directory-aadconnectsync-feature-scheduler.md)每 30 分钟运行一次。 进行更改以及排查新规则错误时，需要确保其未启动。 如果要临时禁用计划程序，请启动 PowerShell，并运行 `Set-ADSyncScheduler -SyncCycleEnabled $false`\r\n\r\n![禁用计划程序](./media/active-directory-aadconnectsync-change-the-configuration/schedulerdisable.png)  \r\n\r\n### <a name=\"create-the-rule\"></a>创建规则\r\n1. 单击“添加新规则” 。\r\n2. 在“说明”页上输入以下内容：  \r\n   ![入站规则筛选](./media/active-directory-aadconnectsync-change-the-configuration/description2.png)  \r\n   - 名称：为规则提供说明性名称。\r\n   - 说明：提供一些说明以便他人可以理解规则的用途。\r\n   - 连接的系统：可从中找到对象的系统。 这种情况下，选择 Active Directory 连接器。\r\n   - 连接的系统/Metaverse 对象类型：分别选择“用户”和“人员”。\r\n   - 链接类型：将该值更改为“联接”。\r\n   - 优先级：提供系统中唯一的值。 较低的数值表示较高的优先级。\r\n   - 标记：留空。 只有 Microsoft 中现成可用的规则应该会要求在此框中填入值。\r\n3. 在“范围筛选器”页上，输入“givenName ISNOTNULL”。  \r\n   ![入站规则范围筛选器](./media/active-directory-aadconnectsync-change-the-configuration/scopingfilter.png)  \r\n   此部分用于定义规则应该应用到哪些对象。 如果留空，该规则会应用到所有用户对象。 但也可包括会议室、服务帐户和其他非个人用户对象。\r\n4. 在“联接规则”上，将其留空。\r\n5. 在“转换”页上，将 FlowType 更改为 Expression。 选择目标属性 givenName，在“源”中输入 `PCase([givenName])`。\r\n   ![入站规则转换](./media/active-directory-aadconnectsync-change-the-configuration/transformations.png)  \r\n   函数名称和属性名称上的同步引擎要区分大小写。 如果键入出错，则添加规则时会看到警告。 编辑器允许保存并继续，因此必须重新打开规则并进行更正。\r\n6.  单击“添加”保存规则。\r\n\r\n新的自定义规则应该与系统中的其他同步规则一起显示。\r\n\r\n### <a name=\"verify-the-change\"></a>验证更改\r\n采用此新更改后，需要确保其按预期方式工作并且不会引发任何错误。 根据拥有的对象数量，有两种不同的方法执行此步骤。\r\n\r\n1. 在所有对象上运行完全同步\r\n2. 在单个对象上运行预览和完全同步\r\n\r\n从“开始”菜单启动“同步服务”。 本部分中所述步骤全部使用此工具。\r\n\r\n1. 针对所有对象的完全同步  \r\n   从“操作”中选择“运行”  。 标识在前面部分中进行过更改的连接器（在本例中为 Active Directory 域服务），并选中它。 从“操作”中选择“运行”，然后选择“完全同步”和“确定”。\r\n\r\n   ![完全同步](./media/active-directory-aadconnectsync-change-the-configuration/fullsync.png)  \r\n\r\n   现已更新了 metaverse 中的对象。 用户想要查看 metaverse 中的对象。\r\n2. 针对单个对象的预览和完全同步  \r\n   从“操作”中选择“运行”  。 标识在前面部分中进行过更改的连接器（在本例中为 Active Directory 域服务），并选中它。 选择“搜索连接器空间”。 使用范围来查找想要用于测试更改的对象。 选择该对象，并单击“预览” 。 在新的屏幕中，选择“提交预览” 。  \r\n   ![Commit preview](./media/active-directory-aadconnectsync-change-the-configuration/commitpreview.png)  \r\n   现已将更改提交到 metaverse。\r\n\r\n查看 metaverse 中的对象  \r\n现在挑选几个示例对象，确保其值符合预期并且已应用规则。 从顶部选择“Metaverse 搜索”。 添加查找相关对象所需的筛选器。 从搜索结果中，打开对象。 查看属性值，同时还要在按预期方式应用规则的“同步规则”列中进行验证。  \r\n![Metaverse 搜索](./media/active-directory-aadconnectsync-change-the-configuration/mvsearch.png)  \r\n\r\n### <a name=\"enable-the-scheduler\"></a>启用计划程序\r\n如果一切按预期方式进行，可以再次启用计划程序。 从 PowerShell 中运行 `Set-ADSyncScheduler -SyncCycleEnabled $true`。\r\n\r\n## <a name=\"other-common-attribute-flow-changes\"></a>其他常见的属性流更改\r\n前面部分介绍了如何更改属性流。 本部分提供了另外一些示例。 虽然创建同步规则的步骤已缩简，但可以在前面部分中找到完整步骤。\r\n\r\n### <a name=\"use-another-attribute-than-the-default\"></a>使用其他属性而不是默认属性\r\nFabrikam 中有对名字、姓氏和显示名称使用本地字母的林。 以拉丁字母表示的这些属性可在扩展属性中找到。 在 Azure AD 和 Office 365 中创建全局地址列表时，组织反而想要使用这些属性。\r\n\r\n使用默认配置时，本地林中的对象如下所示：  \r\n![属性流 1](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp1.png)\r\n\r\n若要使用其他属性流创建规则，请执行以下操作：\r\n\r\n- 从开始菜单启动“同步规则编辑器”  。\r\n- 在左侧依然选定了“入站”的情况下，单击“添加新规则”按钮。\r\n- 为规则指定名称和说明。 选择本地 Active Directory 和相关的对象类型。 在“链接类型”中选择“联接”。 为优先级选择一个未被其他规则使用的数字。 现成的规则从 100 开始，因此该示例可以使用值 50。\r\n\r\n  ![属性流 2](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp2.png)\r\n- 将范围留空（即应该应用到林中的所有用户对象）。\r\n- 将联接规则留空（即让现成的规则处理所有联接）。\r\n- 在“转换”中创建以下流：  \r\n  ![属性流 3](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp3.png)\r\n-  单击“添加”保存规则。\r\n- 转到“同步服务管理器” 。 在“连接器” 上，选择我们已在其中添加了规则的“连接器”。 选择“运行”和“完全同步”。 完全同步使用当前规则重新计算所有对象。\r\n\r\n这是使用此自定义规则的同一对象的结果：  \r\n![属性流 4](./media/active-directory-aadconnectsync-change-the-configuration/attributeflowjp4.png)\r\n\r\n### <a name=\"length-of-attributes\"></a>属性的长度\r\n字符串属性在默认情况下设置为可编制索引，并且最大长度为 448 个字符。 如果正在使用其中可能包含更多字符的字符串属性，请确保属性流中包括以下内容：  \r\n`attributeName` <- `Left([attributeName],448)`\r\n\r\n### <a name=\"changing-the-userprincipalsuffix\"></a>更改 userPrincipalSuffix\r\nActive Directory 中的 userPrincipalName 属性并非始终被用户知晓，并且可能不适合作为登录 ID。 Azure AD Connect 同步安装向导允许选择不同的属性，例如 mail。 但在某些情况下，必须计算该属性。 例如：公司 Contoso 具有两个 Azure AD 目录，一个用于生产，另一个用于测试。 他们希望测试租户中的用户使用登录 ID 中的另一后缀。  \r\n`userPrincipalName` <- `Word([userPrincipalName],1,\"@\") & \"@contosotest.com\"`\r\n\r\n在此表达式中，使用第一个 @-sign (Word) 左侧的所有内容，并与固定字符串连接。\r\n\r\n### <a name=\"convert-a-multi-value-to-a-single-value\"></a>将多值转换为单值\r\nActive Directory 中的某些属性在架构中是多值，不过它们在 Active Directory 用户和计算机中看上去是单值。 例如，说明属性。  \r\n`description` <- `IIF(IsNullOrEmpty([description]),NULL,Left(Trim(Item([description],1)),448))`\r\n\r\n在此表达式中，如果属性具有值，请使用属性中的第一项 (Item)，删除前导空格和尾随空格 (Trim)，然后保留字符串中的前 448 个字符（左）。\r\n\r\n### <a name=\"do-not-flow-an-attribute\"></a>不要流送属性\r\n有关本部分方案的背景信息，请参阅[控制属性流过程](active-directory-aadconnectsync-understanding-declarative-provisioning.md#control-the-attribute-flow-process)。\r\n\r\n有两种方法可防止流送属性。 第一种方法可在安装向导中使用，允许用户[删除选定的属性](active-directory-aadconnect-get-started-custom.md#azure-ad-app-and-attribute-filtering)。 如果以前未曾同步该属性，则可以使用这个选项。 但是，如果已开始同步此属性，后来使用此功能将它删除，则同步引擎将停止管理属性，现有值将保留在 Azure AD 中。\r\n\r\n如果想要删除某个属性的值并确保将来不会流送该属性，则需要改为创建自定义规则。\r\n\r\n在 Fabrikam 上，我们在同步到云的属性中发现了一些不应该存在的属性。 我们希望确保从 Azure AD 中删除这些属性。  \r\n![错误的扩展属性](./media/active-directory-aadconnectsync-change-the-configuration/badextensionattribute.png)\r\n\r\n- 创建新的入站同步规则并填充![说明](./media/active-directory-aadconnectsync-change-the-configuration/syncruledescription.png)部分\r\n- 创建类型为 **Expression** 且源为 **AuthoritativeNull** 的属性流。 即使优先顺序较低的同步规则尝试填充值，文本值“AuthoritativeNull”  也会指出 MV 中的值应该为空。\r\n\r\n  ![扩展属性的转换](./media/active-directory-aadconnectsync-change-the-configuration/syncruletransformations.png)\r\n- 保存同步规则。 启动“同步服务”，查找“连接器”，然后依次选择“运行”和“完全同步”。 此步骤会重新计算所有属性流。\r\n- 通过搜索连接器空间来验证是否即将导出所需的更改。\r\n\r\n  ![分阶段删除](./media/active-directory-aadconnectsync-change-the-configuration/deletetobeexported.png)\r\n\r\n## <a name=\"create-rules-with-powershell\"></a>使用 PowerShell 创建规则\r\n只需稍作更改时，可以使用同步规则编辑器。 若需进行大量的更改，则使用 PowerShell 可能会更好。 一些高级功能仅在 PowerShell 中提供。\r\n\r\n### <a name=\"get-the-powershell-script-for-an-out-of-box-rule\"></a>获取现成规则的 PowerShell 脚本\r\n若要查看创建现成规则的 PowerShell 脚本，在同步规则编辑器中选择此规则，然后单击“导出”。 此操作会提供创建该规则的 PowerShell 脚本。\r\n\r\n### <a name=\"advanced-precedence\"></a>高级优先级\r\n现成的同步规则一开始的优先级值为 100。 如果有多个林，且需进行大量自定义更改，则 99 个同步规则可能不够。\r\n\r\n可以告知同步引擎：需要在现成规则之前插入更多的规则。 若要实现此行为，请完成以下步骤：\r\n\r\n1. 在同步规则编辑器中标记第一个现成同步规则（此规则为 In from AD-User Join），并选择“导出”。 复制 SR 标识符值。  \r\n![更改之前的 PowerShell](./media/active-directory-aadconnectsync-change-the-configuration/powershell1.png)  \r\n2. 创建新的同步规则。 可以使用同步规则编辑器进行创建。 将规则导出到 PowerShell 脚本。\r\n3. 在属性 **PrecedenceBefore**中插入现成规则中的标识符值。 将“优先级”设置为“0”。 请确保 Identifier 属性唯一，不能重复使用其他规则中的 GUID。 另请确保 **ImmutableTag** 属性未设置；只有现成规则才应设置该属性。 保存并运行 PowerShell 脚本。 结果是，为自定义规则分配了优先级值 100，所有其他现成规则的值递增。  \r\n![更改之后的 PowerShell](./media/active-directory-aadconnectsync-change-the-configuration/powershell2.png)  \r\n\r\n可以根据需要让许多自定义同步规则使用同一 **PrecedenceBefore** 值。\r\n\r\n\r\n## <a name=\"enable-synchronization-of-preferreddatalocation\"></a>启用 PreferredDataLocation 同步\r\nAzure AD Connect 支持 1.1.524.0 及更高版本中 **User** 对象的 **PreferredDataLocation** 属性同步。 更具体地讲，已引入以下更改：\r\n\r\n- Azure AD 连接器中对象类型 **User** 的架构经过扩展，包含字符串类型的单值 PreferredDataLocation 属性。\r\n\r\n- Metaverse 中对象类型 **Person** 的架构经过扩展，包含字符串类型的单值 PreferredDataLocation 属性。\r\n\r\n默认情况下，PreferredDataLocation 属性未启用同步，因为在本地 Active Directory 中没有相应的 PreferredDataLocation 属性。 必须手动启用同步。\r\n\r\n> [!IMPORTANT]\r\n> 目前，Azure AD 允许同步用户对象和云用户的 PreferredDataLocation 属性对象要直接使用 Azure AD PowerShell 配置。 启用 PreferredDataLocation 属性同步后，必须停止使用 Azure AD PowerShell 来配置**同步用户对象**中的属性，因为 Azure AD Connect 会根据本地 Active Directory 中的源属性值替代这些属性。\r\n\r\n> [!IMPORTANT]\r\n> 从 2017 年 9 月 1 日开始，Azure AD 不再允许直接使用 Azure AD PowerShell 配置**同步用户对象**中的 PreferredDataLocation 属性。 若要在同步的用户对象上配置 PreferredLocation 属性，必须使用 Azure AD Connect。\r\n\r\n在启用 PreferredDataLocation 属性同步之前，必须：\r\n\r\n - 首先，确定要用作源属性的本地 Active Directory 属性。 它应该采用**字符串**类型并且是**单值**。\r\n\r\n - 如果之前配置 PreferredDataLocation 属性上现有在使用 Azure AD PowerShell 的 Azure AD 中同步用户对象，则必须**向后移植**本地 Active Directory 中的相应用户对象的属性值。\r\n \r\n    > [!IMPORTANT]\r\n    > 如果不向后移植到本地 Active Directory 中的相应用户对象的属性值，Azure AD Connect 会在启用同步 PreferredDataLocation 属性时的 Azure AD 中删除现有的属性值。\r\n\r\n - 建议配置的源属性上至少几个本地 AD 用户对象现在，可以用于验证更高版本。\r\n \r\n启用 PreferredDataLocation 属性同步的步骤可归纳如下：\r\n\r\n1. 禁用同步计划程序，并验证是否没有正在进行的同步操作\r\n\r\n2. 将源属性添加到本地 AD 连接器架构\r\n\r\n3. 将 PreferredDataLocation 添加到 Azure AD 连接器架构\r\n\r\n4. 创建流从本地 Active Directory 的属性值的入站的同步规则\r\n\r\n5. 创建流到 Azure AD 的属性值的出站同步规则\r\n\r\n6. 运行完全同步周期\r\n\r\n7. 启用同步计划程序\r\n\r\n> [!NOTE]\r\n> 本部分的其余部分介绍这些步骤的详细信息。 在 Azure AD 部署使用单林拓扑和不使用自定义同步规则的上下文中描述它们。 如果有多林拓扑、自定义同步规则配置或者过渡服务器，则需要相应地调整步骤。\r\n\r\n### <a name=\"step-1-disable-sync-scheduler-and-verify-there-is-no-synchronization-in-progress\"></a>步骤 1：禁用同步计划程序，并验证是否没有正在进行的同步操作\r\n确保实现新同步规则的中途不会发生同步，以免将意外的更改导出到 Azure AD。 若要禁用内置的同步计划程序，请执行以下操作：\r\n\r\n 1. 在 Azure AD Connect 服务器上启动 PowerShell 会话。\r\n\r\n 2. 通过运行以下 cmdlet 来禁用计划的同步：`Set-ADSyncScheduler -SyncCycleEnabled $false`\r\n \r\n 3. 转到“开始”→“同步服务”，启动“Synchronization Service Manager”。\r\n \r\n 4. 转到“操作”选项卡，确认是否不存在状态为“正在进行”的操作。\r\n\r\n![Synchronization Service Manager - 检查没有正在进行的操作](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step1.png)\r\n\r\n### <a name=\"step-2-add-the-source-attribute-to-the-on-premises-ad-connector-schema\"></a>步骤 2：将源属性添加到本地 AD 连接器架构\r\n并非所有 AD 属性都将导入本地 AD 连接器空间。 要将源属性添加到导入属性的列表：\r\n\r\n 1. 在 Synchronization Service Manager 中转到“连接器”选项卡。\r\n \r\n 2. 右键单击“本地 AD 连接器”，并选择“属性”。\r\n \r\n 3. 在弹出对话框中，转到“选择属性”选项卡。\r\n \r\n 4. 确保在属性列表中选中源属性。\r\n \r\n 5. 单击“确定”保存。\r\n\r\n![将源属性添加到本地 AD 连接器架构](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step2.png)\r\n\r\n### <a name=\"step-3-add-preferreddatalocation-to-the-azure-ad-connector-schema\"></a>步骤 3：将 PreferredDataLocation 添加到 Azure AD 连接器架构\r\n默认情况下，PreferredDataLocation 属性不会导入 Azure AD 连接空间。 要将 PreferredDataLocation 属性添加到导入属性的列表：\r\n\r\n 1. 在 Synchronization Service Manager 中转到“连接器”选项卡。\r\n\r\n 2. 右键单击“Azure AD 连接器”，并选择“属性”。\r\n\r\n 3. 在弹出对话框中，转到“选择属性”选项卡。\r\n\r\n 4. 确保在属性列表中选中 PreferredDataLocation 属性。\r\n\r\n 5. 单击“确定”保存。\r\n\r\n![将源属性添加到 Azure AD 连接器架构](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step3.png)\r\n\r\n### <a name=\"step-4-create-an-inbound-synchronization-rule-to-flow-the-attribute-value-from-on-premises-active-directory\"></a>步骤 4：创建流从本地 Active Directory 的属性值的入站的同步规则\r\n入站同步规则允许要流到 Metaverse 源属性从本地 Active Directory 中的属性值：\r\n\r\n1. 转到“开始”→“同步规则编辑器”，启动“同步规则编辑器”。\r\n\r\n2. 将搜索筛选器的“方向”设置为“入站”。\r\n\r\n3. 单击“添加新规则”按钮创建新的入站规则。\r\n\r\n4. 在“说明”选项卡下面提供以下配置：\r\n \r\n    | 属性 | 值 | 详细信息 |\r\n    | --- | --- | --- |\r\n    | 名称 | *提供名称* | 例如，“In from AD – User PreferredDataLocation” |\r\n    | 说明 | *提供说明* |  |\r\n    | 连接的系统 | 选择本地 AD 连接器 |  |\r\n    | 连接的系统对象类型 | **User** |  |\r\n    | Metaverse 对象类型 | **Person** |  |\r\n    | 链接类型 | **Join** |  |\r\n    | 优先级 | 选择介于 1 和 99 之间的数字 | 1-99 是为自定义同步规则保留的值。 请不要选择已被其他同步规则使用的值。 |\r\n\r\n5. 转到“范围筛选器”选项卡，并添加**包含以下子句的单个范围筛选器组**：\r\n \r\n    | 属性 | 运算符 | 值 |\r\n    | --- | --- | --- |\r\n    | adminDescription | NOTSTARTWITH | 用户\\_ | \r\n \r\n    范围筛选器确定要将此入站同步规则应用到哪些本地 AD 对象。 在本示例中，我们将使用用作“In from AD – User Common”OOB 同步规则的相同范围筛选器，防止将同步规则应用到通过 Azure AD 用户写回功能创建的 User 对象。 可能需要根据 Azure AD Connect 部署调整范围筛选器。\r\n\r\n6. 转到“转换”选项卡并实现以下转换规则：\r\n \r\n    | 流类型 | 目标属性 | 源 | 应用一次 | 合并类型 |\r\n    | --- | --- | --- | --- | --- |\r\n    | 直接 | PreferredDataLocation | 选择源属性 | 未选中 | 更新 |\r\n\r\n7. 单击“添加”创建入站规则。\r\n\r\n![创建入站同步规则](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step4.png)\r\n\r\n### <a name=\"step-5-create-an-outbound-synchronization-rule-to-flow-the-attribute-value-to-azure-ad\"></a>步骤 5：创建流到 Azure AD 的属性值的出站同步规则\r\n出站同步规则允许要在 Azure AD 中从 Metaverse 流向 PreferredDataLocation 属性的属性值：\r\n\r\n1. 转到“同步规则”编辑器。\r\n\r\n2. 将搜索筛选器的“方向”设置为“出站”。\r\n\r\n3. 单击“添加新规则”按钮。\r\n\r\n4. 在“说明”选项卡下面提供以下配置：\r\n\r\n    | 属性 | 值 | 详细信息 |\r\n    | --- | --- | --- |\r\n    | 名称 | *提供名称* | 例如，“Out to AAD - User PreferredDataLocation” |\r\n    | 说明 | *提供说明* |\r\n    | 连接的系统 | 选择 AAD 连接器 |\r\n    | 连接的系统对象类型 | 用户 ||\r\n    | Metaverse 对象类型 | **Person** ||\r\n    | 链接类型 | **Join** ||\r\n    | 优先级 | 选择介于 1 和 99 之间的数字 | 1-99 是为自定义同步规则保留的值。 不要选择已被其他同步规则使用的值。 |\r\n\r\n5. 转到“范围筛选器”选项卡，并添加**包含两个子句的单个范围筛选器组**：\r\n \r\n    | 属性 | 运算符 | 值 |\r\n    | --- | --- | --- |\r\n    | sourceObjectType | EQUAL | User |\r\n    | cloudMastered | NOTEQUAL | True |\r\n\r\n    范围筛选器确定要将此出站同步规则应用到哪些 Azure AD 对象。 在本示例中，我们将使用“Out to AD – User Identity”OOB 同步规则中的相同范围筛选器。 它可以防止将同步规则应用到未从本地 Active Directory 同步的 User 对象。 可能需要根据 Azure AD Connect 部署调整范围筛选器。\r\n    \r\n6. 转到“转换”选项卡并实现以下转换规则：\r\n\r\n    | 流类型 | 目标属性 | 源 | 应用一次 | 合并类型 |\r\n    | --- | --- | --- | --- | --- |\r\n    | 直接 | PreferredDataLocation | PreferredDataLocation | 未选中 | 更新 |\r\n\r\n7. 关闭“添加”创建出站规则。\r\n\r\n![创建出站同步规则](./media/active-directory-aadconnectsync-change-the-configuration/preferredDataLocation-step5.png)\r\n\r\n### <a name=\"step-6-run-full-synchronization-cycle\"></a>步骤 6：运行完全同步周期\r\n一般情况下，完全同步周期是必需的，因为我们已添加到这两个 AD 的新属性和 Azure AD 连接器架构和引入的自定义同步规则。 建议在将其导出到 Azure AD 之前验证所做的更改。 可使用以下步骤手动运行完全同步周期所构成的步骤时验证更改。 \r\n\r\n1. 在**本地 AD 连接器**上运行**完全导入**步骤：\r\n\r\n   1. 在 Synchronization Service Manager 中转到“操作”选项卡。\r\n\r\n   2. 右键单击“本地 AD 连接器”，并选择“运行...”\r\n\r\n   3. 在弹出对话框中，选择“完全导入”，并单击“确定”。\r\n    \r\n   4. 等待操作完成。\r\n\r\n    > [!NOTE]\r\n    > 如果源属性已包含在导入属性列表中，则可以在本地 AD 连接器上跳过“完全导入”。 换而言之，不需要在执行[步骤 2：将源属性添加到本地 AD 连接器架构](#step-2-add-the-source-attribute-to-the-on-premises-ad-connector-schema)期间进行任何更改。\r\n\r\n2. 在**Azure AD 连接器**上运行**完全导入**步骤：\r\n\r\n   1. 右键单击“Azure AD”连接器，并选择“运行...”\r\n\r\n   2. 在弹出对话框中，选择“完全导入”，并单击“确定”。\r\n   \r\n   3. 等待操作完成。\r\n\r\n3. 验证现有 User 对象上的同步规则更改：\r\n\r\n源属性已从本地 Active Directory 和 Azure AD 中的 PreferredDataLocation 导入相应的连接器空间。 然后再继续进行完全同步步骤。我们建议对本地 AD 连接器空间中的现有用户对象执行**预览**。 选择的对象应具有填充的源属性。 成功**预览**填充在 Metaverse 中的 PreferredDataLocation 是一个很好的指标，表示已配置同步规则正确。 有关如何执行**预览**的信息，请参阅[验证更改](#verify-the-change)部分。\r\n\r\n4. 在**本地 AD 连接器**上运行**完全同步**步骤：\r\n\r\n   1. 右键单击“本地 AD 连接器”，并选择“运行...”\r\n  \r\n   2. 在弹出对话框中，选择“完全同步”，并单击“确定”。\r\n   \r\n   3. 等待操作完成。\r\n\r\n5. 验证 Azure AD 的**挂起的导出**：\r\n\r\n   1. 右键单击“Azure AD”连接器，并选择“搜索连接器空间”。\r\n\r\n   2. 在“搜索连接器空间”弹出对话框中：\r\n\r\n      1. 将“范围”设置为“挂起的导出”。\r\n      \r\n      2. 选中所有三个复选框，包括“添加”、“修改”和“删除”。\r\n      \r\n      3. 单击“搜索”按钮获取要导出其更改的对象列表。 若要检查给定对象的更改，请双击该对象。\r\n      \r\n      4. 验证更改是否符合需要。\r\n\r\n6. 在**Azure AD 连接器**上运行**导出**步骤\r\n      \r\n   1. 右键单击“Azure AD 连接器”，并选择“运行...”\r\n   \r\n   2. 在“运行连接器”弹出对话框中选择“导出”，并单击“确定”。\r\n   \r\n   3. 等待导出到 Azure AD 完成。\r\n\r\n> [!NOTE]\r\n> 可能注意到这些步骤不包括完全同步步骤和 Azure AD 连接器上的导出步骤。 由于属性值只会从本地 Active Directory 流向 Azure AD，因此不需要执行这些步骤。\r\n\r\n### <a name=\"step-7-re-enable-sync-scheduler\"></a>步骤 7：重新启用同步计划程序\r\n重新启用内置的同步计划程序：\r\n\r\n1. 启动 PowerShell 会话。\r\n\r\n2. 通过运行以下 cmdlet 来重新启用计划的同步：`Set-ADSyncScheduler -SyncCycleEnabled $true`\r\n\r\n\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n- 在[了解声明性预配](active-directory-aadconnectsync-understanding-declarative-provisioning.md)中阅读有关配置模型的详细信息。\r\n- 在[了解声明性预配表达式](active-directory-aadconnectsync-understanding-declarative-provisioning-expressions.md)中阅读有关表达式语言的详细信息。\r\n\r\n**概述主题**\r\n\r\n- [Azure AD Connect 同步：理解和自定义同步](active-directory-aadconnectsync-whatis.md)\r\n- [将本地标识与 Azure Active Directory 集成](active-directory-aadconnect.md)\r\n\r\n<!-- Update_Description: wording update -->"}