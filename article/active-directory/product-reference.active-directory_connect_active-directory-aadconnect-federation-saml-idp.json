{"Title":"Azure AD Connect：使用 SAML 2.0 标识提供者进行单一登录","Description":"本主题介绍如何使用兼容 SAML 2.0 的 Idp 进行单一登录。","Content":"#  <a name=\"use-a-saml-20-identity-provider-idp-for-single-sign-on\"></a>使用 SAML 2.0 标识提供者 (IdP) 进行单一登录\r\n\r\n本主题介绍如何将兼容 SAML 2.0 且基于 SP-Lite 配置文件的标识提供者用作首选的安全令牌服务 (STS)/标识提供者。 在你已经有了一个能够使用 SAML 2.0 访问的本地用户目录和密码存储的情况下，这很有用。 可以使用这个现有的用户目录登录到 Office 365 和其他受 Azure AD 保护的资源。 SAML 2.0 SP-Lite 配置文件基于基于广泛使用的安全断言标记语言 (SAML) 联合标识标准，可提供登录和属性交换框架。\r\n\r\n>[!NOTE]\r\n>如需经测试可用于 Azure AD 的第三方 Idp 的列表，请参阅 [Azure AD 联合身份验证兼容性列表](active-directory-aadconnect-federation-compatibility.md)\r\n\r\nMicrosoft 支持此登录体验，允许你将 Microsoft 云服务（例如 Office 365）与正确配置的基于 SAML 2.0 配置文件的 IdP 集成。 SAML 2.0 标识提供者是第三方产品，因此 Microsoft 不会对与之相关的部署、配置、故障排除最佳实践提供支持。 正确配置以后，即可使用 Microsoft Connectivity Analyzer 工具（在下面详细介绍）对云服务与 SAML 2.0 标识提供者的集成进行测试，看配置是否确实正确。 若要详细了解基于 SAML 2.0 SP-Lite 配置文件的标识提供者，请咨询提供它的组织。\r\n\r\n>[!IMPORTANT]\r\n>在使用 SAML 2.0 标识提供者的这个登录方案中，仅可使用有限的一组客户端，其中包括：\r\n\r\n>- 基于 Web 的客户端，例如 Outlook Web Access 和 SharePoint Online\r\n- 多重格式电子邮件客户端，使用基本身份验证以及受支持的 Exchange 访问方法，例如 IMAP、POP、Active Sync、MAPI 等（需部署增强型客户端协议终结点）。此类客户端包括：\r\n    - Microsoft Outlook 2010/Outlook 2013/Outlook 2016、Apple iPhone（各种 iOS 版本）\r\n    - 各种 Google Android 设备\r\n    - Windows Phone 7、Windows Phone 7.8 和 Windows Phone 8.0\r\n    - Windows 8 邮件客户端和 Windows 8.1 邮件客户端\r\n    - Windows 10 邮件客户端\r\n\r\n在使用 SAML 2.0 标识提供者的这个登录方案中，所有其他客户端均不可用。 例如，Lync 2010 桌面客户端不能登录到已将 SAML 2.0 标识提供者配置为进行单一登录的服务。\r\n\r\n## <a name=\"azure-ad-saml-20-protocol-requirements\"></a>Azure AD SAML 2.0 协议要求\r\n本主题包含与 Azure AD 一起进行联合身份验证以便登录到一个或多个 Microsoft 云服务（例如 Office 365）时，SAML 2.0 标识提供者必须实现的协议和消息格式设置的详细要求。 本方案中使用的 Microsoft 云服务的 SAML 2.0 信赖方 (SP-STS) 为 Azure AD。\r\n\r\n建议你确保 SAML 2.0 标识提供者输出消息尽可能与提供的示例跟踪类似。 另外，请尽可能使用来自所提供的 Azure AD 元数据的特定属性值。 对输出消息满意以后，即可使用 Microsoft Connectivity Analyzer 进行测试，如下所述。\r\n\r\n可从以下 URL 下载 Azure AD 元数据：[https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml](https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml)。\r\n对于使用特定于中国的 Office 365 实例的中国客户来说，应使用以下联合身份验证终结点：[https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml](https://nexus.partner.microsoftonline-p.cn/federationmetadata/saml20/federationmetadata.xml)。\r\n\r\n## <a name=\"saml-protocol-requirements\"></a>SAML 协议要求\r\n本部署详述如何将请求和响应消息对放置在一起，以便正确设置消息格式。\r\n\r\nAzure AD 在进行配置后可以用于标识提供者，后者使用 SAML 2.0 SP Lite 配置文件，其中的部分具体要求已在下面列出。 可以使用示例性的 SAML 请求和响应消息进行自动和手动测试，从而实现与 Azure AD 的互操作性。\r\n\r\n## <a name=\"signature-block-requirements\"></a>签名块要求\r\n在 SAML 响应消息中，“签名”节点包含有关消息本身数字签名的信息。 签名块具有以下要求：\r\n\r\n1. 断言节点本身必须签名\r\n2.  必须使用 RSA-sha1 算法作为 DigestMethod。 不接受其他数字签名算法。\r\n   `<ds:DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"/>`\r\n3.  也可对 XML 文档签名。 \r\n4.  转换算法必须与以下示例中的值匹配：`<ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/>\r\n       <ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/>`\r\n9.  SignatureMethod 算法必须与以下示例匹配：`<ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"/>`\r\n\r\n## <a name=\"supported-bindings\"></a>支持的绑定\r\n绑定是与传输相关的通信参数，是必需的。 以下要求适用于绑定：\r\n\r\n1. HTTPS 是所需的传输。\r\n2.  Azure AD 将需要使用 HTTP POST 在登录期间提交令牌。\r\n3.  Azure AD 将使用 HTTP POST 向标识提供者提交身份验证请求，并使用 REDIRECT 向标识提供者发送“注销”消息。\r\n\r\n## <a name=\"required-attributes\"></a>必需属性\r\n下表显示了针对 SAML 2.0 消息中的特定属性的要求。\r\n \r\n|属性|说明|\r\n| ----- | ----- |\r\n|NameID|此断言语句的值必须与 Azure AD 用户的 ImmutableID 相同。 它最多可以有 64 个字母数字字符。 任何非 HTML 安全型字符都必须进行编码，例如，“+”字符必须显示为“.2B”。|\r\n|IDPEmail|用户主体名称 (UPN) 在 SAML 响应中以名为 IDPEmail 的元素形式列出。这在 Azure AD/Office 365 中是用户的 UserPrincipalName (UPN)。 UPN 采用电子邮件地址格式。 Windows Office 365 (Azure Active Directory) 中的 UPN 值。|\r\n|颁发者|此项必须是标识提供者的 URI。 不应重复使用示例消息中的 Issuer。 如果在 Azure AD 租户中有多个顶级域，则 Issuer 必须与针对每个域配置的指定 URI 设置匹配。|\r\n\r\n>[!IMPORTANT]\r\n>Azure AD 目前支持下述适用于 SAML 2.0 的 NameID 格式 URI：urn:oasis:names:tc:SAML:2.0:nameid-format:persistent。\r\n\r\n## <a name=\"sample-saml-request-and-response-messages\"></a>SAML 请求与响应消息示例\r\n显示的请求与响应消息对是针对登录消息交换的。\r\n下面是从 Azure AD 发送到示例 SAML 2.0 标识提供者的示例请求消息。 示例 SAML 2.0 标识提供者为 Active Directory 联合身份验证服务 (AD FS)，已配置为使用 SAML-P 协议。 此外，还针对其他 SAML 2.0 标识提供者完成了互操作性测试。\r\n\r\n    `<samlp:AuthnRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" ID=\"_7171b0b2-19f2-4ba2-8f94-24b5e56b7f1e\" IssueInstant=\"2014-01-30T16:18:35Z\" Version=\"2.0\" AssertionConsumerServiceIndex=\"0\" >\r\n    <saml:Issuer>urn:federation:MicrosoftOnline</saml:Issuer>\r\n    <samlp:NameIDPolicy Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent\"/>\r\n    </samlp:AuthnRequest>`\r\n\r\n下面是从兼容 SAML 2.0 的示例标识提供者发送到 Azure AD/Office 365 的示例响应消息。\r\n\r\n    `<samlp:Response ID=\"_592c022f-e85e-4d23-b55b-9141c95cd2a5\" Version=\"2.0\" IssueInstant=\"2014-01-31T15:36:31.357Z\" Destination=\"https://login.partner.microsoftonline.cn/login.srf\" Consent=\"urn:oasis:names:tc:SAML:2.0:consent:unspecified\" InResponseTo=\"_049917a6-1183-42fd-a190-1d2cbaf9b144\" xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\">\r\n    <Issuer xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\">http://WS2012R2-0.contoso.com/adfs/services/trust</Issuer>\r\n    <samlp:Status>\r\n    <samlp:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Success\" />\r\n    </samlp:Status>\r\n    <Assertion ID=\"_7e3c1bcd-f180-4f78-83e1-7680920793aa\" IssueInstant=\"2014-01-31T15:36:31.279Z\" Version=\"2.0\" xmlns=\"urn:oasis:names:tc:SAML:2.0:assertion\">\r\n    <Issuer>http://WS2012R2-0.contoso.com/adfs/services/trust</Issuer>\r\n    <ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\r\n      <ds:SignedInfo>\r\n        <ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n        <ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\" />\r\n        <ds:Reference URI=\"#_7e3c1bcd-f180-4f78-83e1-7680920793aa\">\r\n          <ds:Transforms>\r\n            <ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" />\r\n            <ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n          </ds:Transforms>\r\n          <ds:DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\" />\r\n          <ds:DigestValue>CBn/5YqbheaJP425c0pHva9PhNY=</ds:DigestValue>\r\n        </ds:Reference>\r\n      </ds:SignedInfo>\r\n      <ds:SignatureValue>TciWMyHW2ZODrh/2xrvp5ggmcHBFEd9vrp6DYXp+hZWJzmXMmzwmwS8KNRJKy8H7XqBsdELA1Msqi8I3TmWdnoIRfM/ZAyUppo8suMu6Zw+boE32hoQRnX9EWN/f0vH6zA/YKTzrjca6JQ8gAV1ErwvRWDpyMcwdYCiWALv9ScbkAcebOE1s1JctZ5RBXggdZWrYi72X+I4i6WgyZcIGai/rZ4v2otoWAEHS0y1yh1qT7NDPpl/McDaTGkNU6C+8VfjD78DrUXEcAfKvPgKlKrOMZnD1lCGsViimGY+LSuIdY45MLmyaa5UT4KWph6dA==</ds:SignatureValue>\r\n      <KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\">\r\n        <ds:X509Data>\r\n          <ds:X509Certificate>MIIC7jCCAdagAwIBAgIQRrjsbFPaXIlOG3GTv50fkjANBgkqhkiG9w0BAQsFADAzMTEwLwYDVQQDEyhBREZTIFNpZ25pbmcgLSBXUzIwMTJSMi0wLnN3aW5mb3JtZXIuY29tMB4XDTE0MDEyMDE1MTY0MFoXDTE1MDEyMDE1MTY0MFowMzExMC8GA1UEAxMoQURGUyBTaWduaW5nIC0gV1MyMDEyUjItMC5zd2luZm9ybWVyLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKe+rLVmXy1QwCwZwqgbbp1/+3ZWxd9T/jV0hpLIIWr+LCOHqq8n8beJvlivgLmDJo8f+EITnAxWcsJUvVai/35AhHCUq9tc9sqMp5PWtabAEMb2AU72/QlX/72D2/NbGQq1BWYbqUpgpCZ2nSgvlWDHlCiUo//UGsvfox01kjTFlmqQInsJVfRxF5AcCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEAi8c6C4zaTEc7aQiUgvnGQgCbMZbhUXXLGRpjvFLKaQzkwa9eq7WLJibcSNyGXBa/SfT5wJgsm3TPKgSehGAOTirhcqHheZyvBObAScY7GOT+u9pVYp6raFrc7ez3c+CGHeV/tNvy1hJNs12FYH4X+ZCNFIT9tprieR25NCdi5SWUbPZL0tVzJsHc1y92b2M2FxqRDohxQgJvyJOpcg2mSBzZZIkvDg7gfPSUXHVS1MQs0RHSbwq/XdQocUUhl9/e/YWCbNNxlM84BxFsBUok1dH/gzBySx+Fc8zYi7cOq9yaBT3RLT6cGmFGVYZJW4FyhPZOCLVNsLlnPQcX3dDg9A==</ds:X509Certificate>\r\n        </ds:X509Data>\r\n      </KeyInfo>\r\n    </ds:Signature>\r\n    <Subject>\r\n      <NameID Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent\">ABCDEG1234567890</NameID>\r\n      <SubjectConfirmation Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\">\r\n        <SubjectConfirmationData InResponseTo=\"_049917a6-1183-42fd-a190-1d2cbaf9b144\" NotOnOrAfter=\"2014-01-31T15:41:31.357Z\" Recipient=\"https://login.partner.microsoftonline.cn/login.srf\" />\r\n      </SubjectConfirmation>\r\n    </Subject>\r\n    <Conditions NotBefore=\"2014-01-31T15:36:31.263Z\" NotOnOrAfter=\"2014-01-31T16:36:31.263Z\">\r\n      <AudienceRestriction>\r\n        <Audience>urn:federation:MicrosoftOnline</Audience>\r\n      </AudienceRestriction>\r\n    </Conditions>\r\n    <AttributeStatement>\r\n      <Attribute Name=\"IDPEmail\">\r\n        <AttributeValue>administrator@contoso.com</AttributeValue>\r\n      </Attribute>\r\n    </AttributeStatement>\r\n    <AuthnStatement AuthnInstant=\"2014-01-31T15:36:30.200Z\" SessionIndex=\"_7e3c1bcd-f180-4f78-83e1-7680920793aa\">\r\n      <AuthnContext>\r\n        <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</AuthnContextClassRef>\r\n      </AuthnContext>\r\n    </AuthnStatement>\r\n    </Assertion>\r\n    </samlp:Response>`\r\n\r\n## <a name=\"configure-your-saml-20-compliant-identity-provider\"></a>配置兼容 SAML 2.0 的标识提供者\r\n本主题包含的准则适用于配置 SAML 2.0 标识提供者，目的是通过与 Azure AD 一起进行联合身份验证，使用 SAML 2.0 协议以单一登录方式访问一个或多个 Microsoft 云服务（例如 Office 365）。 本方案中使用的 Microsoft 云服务的 SAML 2.0 信赖方为 Azure AD。\r\n\r\n## <a name=\"add-azure-ad-metadata\"></a>添加 Azure AD 元数据\r\nSAML 2.0 标识提供者需遵循有关 Azure AD 信赖方的信息要求。 Azure AD 将元数据发布到 https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml。\r\n\r\n建议你在配置 SAML 2.0 标识提供者时，始终导入最新的 Azure AD 元数据。 请注意，Azure AD 不从标识提供者读取元数据。\r\n\r\n## <a name=\"add-azure-ad-as-a-relying-party\"></a>将 Azure AD 作为信赖方添加\r\n必须允许在 SAML 2.0 标识提供者与 Azure AD 之间通信。 此配置取决于具体的的标识提供者，请参阅其文档。 通常应将信赖方 ID 设置为与 Azure AD 元数据中的 entityID 相同。\r\n\r\n>[!NOTE]\r\n>请验证 SAML 2.0 标识提供者服务器上的时钟是否已与准确的时间源同步。 时钟的时间不准确可能导致联合身份验证登录失败。\r\n\r\n## <a name=\"install-windows-powershell-for-sign-on-with-saml-20-identity-provider\"></a>安装 Windows PowerShell 以使用 SAML 2.0 标识提供者进行登录\r\n配置用于 Azure AD 登录的 SAML 2.0 标识提供者以后，下一步是下载并安装用于 Windows PowerShell 的 Azure Active Directory 模块。 安装以后，即可使用这些 cmdlet 将 Azure AD 域配置为联合域。\r\n\r\n用于 Windows PowerShell 的 Azure Active Directory 模块在下载后可用于管理 Azure AD 中的组织数据。 该模块可将一组 cmdlet 安装到 Windows PowerShell；运行这些 cmdlet 即可设置对 Azure AD 以及所有已订阅云服务的单一登录访问。 有关如何下载和安装 cmdlet 的说明，请参阅 [http://technet.microsoft.com/library/jj151815.aspx](http://technet.microsoft.com/library/jj151815.aspx)\r\n\r\n## <a name=\"set-up-a-trust-between-your-saml-identity-provider-and-azure-ad\"></a>在 SAML 标识提供者与 Azure AD 之间建立信任\r\n在 Azure AD 域上配置联合身份验证之前，必须已配置自定义域。 不能联合 Microsoft 提供的默认域。 Microsoft 提供的默认域以“partner.onmschina.cn”结尾。\r\n需在 Windows PowerShell 命令行界面中运行一系列 cmdlet，以便添加或转换单一登录的域。\r\n\r\n每个需要使用 SAML 2.0 标识提供者进行联合身份验证的 Azure Active Directory 域都必须作为单一登录域添加，或者必须从标准域转换为单一登录域。 添加或转换域可以在 SAML 2.0 标识提供者和 Azure AD 之间建立信任。\r\n\r\n以下过程演示如何使用 SAML 2.0 SP-Lite 将现有的标准域转换为联合身份验证域。 请注意，域可能会出现中断情况，严重时在执行此步骤后 2 小时仍会影响用户。\r\n\r\n## <a name=\"configuring-a-domain-in-your-azure-ad-directory-for-federation\"></a>在 Azure AD Directory 中配置进行联合身份验证的域\r\n\r\n\r\n1. 以租户管理员身份连接到 Azure AD Directory：Connect-MsolService。\r\n2.  通过 SAML 2.0 将所需的 Office 365 域配置为使用联合：`$dom = \"contoso.com\" $BrandName - \"Sample SAML 2.0 IDP\" $LogOnUrl = \"https://WS2012R2-0.contoso.com/passiveLogon\" $LogOffUrl = \"https://WS2012R2-0.contoso.com/passiveLogOff\" $ecpUrl = \"https://WS2012R2-0.contoso.com/PAOS\" $MyURI = \"urn:uri:MySamlp2IDP\" $MySigningCert = @\" MIIC7jCCAdagAwIBAgIQRrjsbFPaXIlOG3GTv50fkjANBgkqhkiG9w0BAQsFADAzMTEwLwYDVQQDEyh BREZTIFNpZ25pbmcgLSBXUzIwMTJSMi0wLnN3aW5mb3JtZXIuY29tMB4XDTE0MDEyMDE1MTY0MFoXDT E1MDEyMDE1MTY0MFowMzExMC8GA1UEAxMoQURGUyBTaWduaW5nIC0gV1MyMDEyUjItMC5zd2luZm9yb WVyLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKe+rLVmXy1QwCwZwqgbbp1/kupQ VcjKuKLitVDbssFyqbDTjP7WRjlVMWAHBI3kgNT7oE362Gf2WMJFf1b0HcrsgLin7daRXpq4Qi6OA57 sW1YFMj3sqyuTP0eZV3S4+ZbDVob6amsZIdIwxaLP9Zfywg2bLsGnVldB0+XKedZwDbCLCVg+3ZWxd9 T/jV0hpLIIWr+LCOHqq8n8beJvlivgLmDJo8f+EITnAxWcsJUvVai/35AhHCUq9tc9sqMp5PWtabAEM b2AU72/QlX/72D2/NbGQq1BWYbqUpgpCZ2nSgvlWDHlCiUo//UGsvfox01kjTFlmqQInsJVfRxF5AcC AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAi8c6C4zaTEc7aQiUgvnGQgCbMZbhUXXLGRpjvFLKaQzkwa9 eq7WLJibcSNyGXBa/SfT5wJgsm3TPKgSehGAOTirhcqHheZyvBObAScY7GOT+u9pVYp6raFrc7ez3c+ CGHeV/tNvy1hJNs12FYH4X+ZCNFIT9tprieR25NCdi5SWUbPZL0tVzJsHc1y92b2M2FxqRDohxQgJvy JOpcg2mSBzZZIkvDg7gfPSUXHVS1MQs0RHSbwq/XdQocUUhl9/e/YWCbNNxlM84BxFsBUok1dH/gzBy Sx+Fc8zYi7cOq9yaBT3RLT6cGmFGVYZJW4FyhPZOCLVNsLlnPQcX3dDg9A==\" \"@ $uri = \"http://WS2012R2-0.contoso.com/adfs/services/trust\" $Protocol = \"SAMLP\" Set-MsolDomainAuthentication -DomainName $dom -FederationBrandName $dom -Authentication Federated -PassiveLogOnUri $MyURI -ActiveLogOnUri $ecpUrl -SigningCertificate $MySigningCert -IssuerUri $uri -LogOffUri $url -PreferredAuthenticationProtocol $Protocol` \r\n\r\n3.  可以从 IDP 元数据文件中获取签名证书的 base64 编码字符串。 已提供此位置的示例，但该示例视实现情况可能稍有不同。\r\n\r\n    `<IDPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"> <KeyDescriptor use=\"signing\"> <KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"> <X509Data> <X509Certificate>MIIC5jCCAc6gAwIBAgIQLnaxUPzay6ZJsC8HVv/QfTANBgkqhkiG9w0BAQsFADAvMS0wKwYDVQQDEyRBREZTIFNpZ25pbmcgLSBmcy50ZWNobGFiY2VudHJhbC5vcmcwHhcNMTMxMTA0MTgxMzMyWhcNMTQxMTA0MTgxMzMyWjAvMS0wKwYDVQQDEyRBREZTIFNpZ25pbmcgLSBmcy50ZWNobGFiY2VudHJhbC5vcmcwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCwMdVLTr5YTSRp+ccbSpuuFeXMfABD9mVCi2wtkRwC30TIyPdORz642MkurdxdPCWjwgJ0HW6TvXwcO9afH3OC5V//wEGDoNcI8PV4enCzTYFe/h//w51uqyv48Fbb3lEXs+aVl8155OAj2sO9IX64OJWKey82GQWK3g7LfhWWpp17j5bKpSd9DBH5pvrV+Q1ESU3mx71TEOvikHGCZYitEPywNeVMLRKrevdWI3FAhFjcCSO6nWDiMqCqiTDYOURXIcHVYTSof1YotkJ4tG6mP5Kpjzd4VQvnR7Pjb47nhIYG6iZ3mR1F85Ns9+hBWukQWNN2hcD/uGdPXhpdMVpBAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAK7h7jF7wPzhZ1dPl4e+XMAr8I7TNbhgEU3+oxKyW/IioQbvZVw1mYVCbGq9Rsw4KE06eSMybqHln3w5EeBbLS0MEkApqHY+p68iRpguqa+W7UHKXXQVgPMCpqxMFKonX6VlSQOR64FgpBme2uG+LJ8reTgypEKspQIN0WvtPWmiq4zAwBp08hAacgv868c0MM4WbOYU0rzMIR6Q+ceGVRImlCwZ5b7XKp4mJZ9hlaRjeuyVrDuzBkzROSurX1OXoci08yJvhbtiBJLf3uPOJHrhjKRwIt2TnzS9ElgFZlJiDIA26Athe73n43CT0af2IG6yC7e6sK4L3NEXJrwwUZk=</X509Certificate> </X509Data> </KeyInfo> </KeyDescriptor>` \r\n\r\n有关“Set-MsolDomainAuthentication”的详细信息，请参阅：[http://technet.microsoft.com/library/dn194112.aspx](http://technet.microsoft.com/library/dn194112.aspx)。\r\n\r\n>[!NOTE]\r\n>只有在为标识提供者设置 ECP 扩展的情况下，才必须使用“$ecpUrl = “https://WS2012R2-0.contoso.com/PAOS”来运行。 除 Outlook Web Application (OWA) 之外的 Exchange Online 客户端依赖于基于 POST 的活动终结点。 如果 SAML 2.0 STS 实现的活动终结点类似于 Shibboleth 对活动终结点的 ECP 实现，则这些富客户端可能会与 Exchange Online 服务交互。\r\n\r\n配置联合身份验证以后，可以切换回“非联合身份验证”（或“托管”）模式，但这种更改最长需要两小时才能完成，并且需要为每个用户分配新的随机密码，以便进行基于云的登录。 在某些情况下，可能需切换回“托管”模式才能在设置中重置错误。 有关域转换的详细信息，请参阅：[http://msdn.microsoft.com/library/windowsazure/dn194122.aspx](http://msdn.microsoft.com/library/windowsazure/dn194122.aspx)。\r\n\r\n## <a name=\"provision-user-principals-to-azure-ad--office-365\"></a>预配 Azure AD/Office 365 的用户主体\r\n向 Office 365 进行用户身份验证之前，必须根据 SAML 2.0 声明中的断言语句为 Azure AD 预配用户主体。 如果不提前让 Azure AD 了解这些用户主体，则不能使用它们进行联合身份验证登录。 可以使用 Azure AD Connect 或 Windows PowerShell 来预配用户主体。\r\n\r\n可以使用 Azure AD Connect 从本地 Active Directory 预配 Azure AD 目录中域的主体。 如需更多详细信息，请参阅[将本地目录与 Azure Active Directory 集成](active-directory-aadconnect.md)。\r\n\r\n也可使用 Windows PowerShell 自动将新用户添加到 Azure AD 并同步本地目录中的更改。 若要使用 Windows PowerShell cmdlet，必须下载 [Azure Active Directory 模块](https://docs.microsoft.com/powershell/azure/install-adv2?view=azureadps-2.0)。\r\n\r\n以下过程演示如何向 Azure AD 添加单个用户。\r\n\r\n\r\n1. 以租户管理员身份连接到 Azure AD Directory：Connect-MsolService。\r\n2.  创建新用户主体：` New-MsolUser\r\n        -UserPrincipalName elwoodf1@contoso.com\r\n        -ImmutableId ABCDEFG1234567890\r\n        -DisplayName \"Elwood Folk\"\r\n        -FirstName Elwood \r\n        -LastName Folk \r\n        -AlternateEmailAddresses \"Elwood.Folk@contoso.com\" \r\n        -LicenseAssignment \"samlp2test:ENTERPRISEPACK\" \r\n        -UsageLocation \"US\" ` \r\n\r\n有关“New-MsolUser”的详细信息，请查看 [http://technet.microsoft.com/library/dn194096.aspx](http://technet.microsoft.com/library/dn194096.aspx)\r\n\r\n>[!NOTE]\r\n>“UserPrinciplName”值必须与将在 SAML 2.0 声明中为“IDPEmail”发送的值匹配，“ImmutableID”值必须与在“NameID”断言语句中发送的值匹配。\r\n\r\n## <a name=\"verify-single-sign-on-with-your-saml-20-idp\"></a>通过 SAML 2.0 IDP 验证单一登录\r\n在以管理员身份验证和管理单一登录（也称联合身份验证）之前，请查看以下文章中的信息并执行相关步骤，以便通过基于 SAML 2.0 SP-Lite 的标识提供者设置单一登录：\r\n\r\n\r\n1.  查看 Azure AD SAML 2.0 协议要求\r\n2.  配置 SAML 2.0 标识提供者\r\n3.  安装 Windows PowerShell 以使用 SAML 2.0 标识提供者进行单一登录\r\n4.  在 SAML 2.0 标识提供者与 Azure AD 之间建立信任\r\n5.  通过 Windows PowerShell 或 Azure AD Connect 预配 Azure Active Directory (Office 365) 的已知测试用户主体。\r\n6.  使用 [Azure AD Connect](active-directory-aadconnect.md) 配置目录同步。\r\n\r\n通过基于 SAML 2.0 SP-Lite 的标识提供者设置单一登录以后，应验证其是否正常工作。\r\n\r\n>[!NOTE]\r\n>如果转换而不是添加域，则可能需要长达 24 小时来设置单一登录。\r\n在验证单一登录之前，应完成 Active Directory 同步的设置，对目录进行同步，并激活同步的用户。\r\n\r\n### <a name=\"use-the-tool-to-verify-that-single-sign-on-has-been-set-up-correctly\"></a>使用工具验证单一登录是否已正确设置\r\n若要验证是否已正确设置单一登录，可执行以下过程，确认你能够使用公司凭据登录到云服务。\r\n\r\nMicrosoft 提供了一种工具，用于测试基于 SAML 2.0 的标识提供者。 在运行测试工具之前，必须已将 Azure AD 租户配置为通过标识提供者进行联合身份验证。\r\n\r\n>[!NOTE]\r\n>Connectivity Analyzer 需要 Internet Explorer 10 或更高版本。\r\n\r\n\r\n\r\n1. 从 [https://testconnectivity.microsoft.com/?tabid=Client](https://testconnectivity.microsoft.com/?tabid=Client) 下载 Connectivity Analyzer。\r\n2.  单击“立即安装”开始下载并安装工具。\r\n3.  选择“我不能通过 Office 365、Azure 或其他使用 Azure Active Directory 的服务设置联合身份验证”。\r\n4.  下载并运行该工具后，即可看到“连接性诊断”窗口。 该工具将逐步引导你测试联合身份验证连接。\r\n5.  Connectivity Analyzer 会打开 SAML 2.0 IDP，此时你可以登录，输入要测试的用户主体的凭据：![SAML](./media/active-directory-aadconnect-federation-saml-idp/saml1.png)\r\n6.  在联合身份验证测试登录窗口，应输入 Azure AD 租户的帐户名称和密码，该租户已配置为通过 SAML 2.0 标识提供者进行联合身份验证。 该工具会尝试使用这些凭据登录，并会提供在登录尝试期间执行的测试的详细结果作为输出。\r\n![SAML](./media/active-directory-aadconnect-federation-saml-idp/saml2.png)\r\n7. 此窗口显示失败的测试结果。 单击“查看详细结果”会显示所执行的每次测试的结果的相关信息。 也可将结果保存到磁盘，以便进行共享。\r\n \r\n>[!NOTE]\r\n>Connectivity Analyzer 也使用基于 WS* 的协议和 ECP/PAOS 协议测试活动联合身份验证。 如果不使用这些，则可忽略以下错误：正在使用标识提供者的活动联合身份验证终结点测试活动登录流。\r\n\r\n### <a name=\"manually-verify-that-single-sign-on-has-been-set-up-correctly\"></a>手动验证单一登录是否已正确设置\r\n手动验证提供更多的步骤，可以利用这些步骤来确保 SAML 2.0 标识提供者在多种情形下正常运行。\r\n若要验证单一登录是否已正确设置，请完成以下步骤：\r\n\r\n\r\n1. 在已加入域的计算机上，使用登录名称登录到云服务，该名称与用于公司凭据的名称相同。\r\n2.  在密码框内单击。 如果设置了单一登录，则密码框会灰显，同时会显示以下消息：“你现在需在 <your company> 登录。”\r\n3.  单击“在 <your company> 登录”链接。 如果可以登录，则已设置单一登录。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n\r\n- [使用 Azure AD Connect 进行 Active Directory 联合身份验证服务的管理和自定义](active-directory-aadconnect-federation-management.md)\r\n- [Azure AD 联合身份验证兼容性列表](active-directory-aadconnect-federation-compatibility.md)\r\n- [Azure AD Connect 自定义安装](active-directory-aadconnect-get-started-custom.md)\r\n\r\n<!-- Update_Description: update meta properties -->"}