{"Title":"如何通过 PHP 获取 Azure Active Directory 令牌","Description":"通过 PHP 获取 调用 Azure Rest API 所需的 Azure Active Directory 令牌","Content":"\r\n# 如何通过 PHP 获取 Azure Active Directory 令牌\r\n\r\n在调用 Azure Rest API 时，如果是属于 Azure Resource Manager 的 API，则需要使用 Azure Active Directory (Azure AD)认证获取令牌（Token),然后才能够进行访问。\r\n\r\n>[!NOTE]\r\n>以下认证方式，只适用于 Azure Resource Manager 的 API。 即 endpoint 为 `management.chinacloudapi.cn` 的 API，不适用于 Azure Service Manager 的 API（endpoint 为 `management.core.chinacloudapi.cn` 的 API）。\r\n\r\n以下是创建 Azure AD 应用，并授权其可以访问管理 Azure 的资源的步骤：\r\n\r\n## 登录 Azure 账户（PowerShell）\r\n\r\n![login](./media/aog-active-directory-howto-get-arm-token-by-php/login.jpg)\r\n\r\n记录获取到的 TenantID 以供后续程序使用。\r\n\r\n## 选择当前订阅 ID\r\n\r\n设置当前订阅，多订阅环境下需要执行该步骤 :\r\n\r\n```\r\nSet-AzureRmContext -SubscriptionId <subscription ID>\r\n```\r\n\r\n## 创建 AD 应用\r\n\r\n查看新创建的应用对象，属性 ApplicationId,在后续会用来创建服务凭证，角色设置和 Access Token。\r\n\r\n```\r\n$azureAdApplication = New-AzureRmADApplication -DisplayName \"exampleapp\" -HomePage \"https://www.contoso.org\" -IdentifierUris \"https://www.contoso.org/example\" -Password \"<Your_Password>\"\r\n```\r\n\r\n![new-azurermadapplication](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermadapplication.jpg)\r\n\r\n## 创建服务凭证\r\n\r\nAzure AD 应用创建服务凭证:\r\n\r\n```\r\nNew-AzureRmADServicePrincipal -ApplicationId $azureAdApplication.ApplicationId\r\n```\r\n\r\n![new-azurermadserviceprincipal.jpg](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermadserviceprincipal.jpg)\r\n\r\n当创建完成服务凭证后，初始是没有任何权限的，我们需要为其设置权限范围。\r\n\r\n## 授权\r\n\r\n为您的服务凭证添加角色设置，在该例中，为您的服务凭证设置访问您订阅下所有资源的读权限。 如果想了解更多内容，请参考：[Azure Role-based Access Control](https://azure.microsoft.com/en-us/documentation/articles/role-based-access-control-what-is/)。\r\n\r\n```\r\nNew-AzureRmRoleAssignment -RoleDefinitionName Contributor -ServicePrincipalName $azureAdApplication.ApplicationId\r\n```\r\n\r\n其中 `RoleDefinitionName` 有三种权限设置：\r\n\r\n1. Reader      对Azure资源有读取权限。\r\n2. Contributor 对Azure资源有管理权限，但无法授权他人。\r\n3. Owner       对Azure资源拥有管理权限，也可以授权他人管理。\r\n\r\n![new-azurermroleassignment](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermroleassignment.jpg)\r\n\r\n## 调用 Oauth2 API 获取 Token\r\n\r\n这样 Azure AD Application 就创建完成了，我们可以使用以下三个信息，来获取认证的 Token。\r\n\r\n1. telent-id      对应订阅信息上使用的 telentID。\r\n2. application-id 创建应用返回的 ApplicationID。\r\n3. app password   创建应用时填写的密码。\r\n\r\n获取 Token 的方式，使用 Azure login oauth2 的认证接口，如果想了解更多，请参考此文档：[Using the Azure Resource Manager REST API](https://blogs.msdn.microsoft.com/cloud_solution_architect/2016/02/20/using-the-azure-resource-manager-rest-api/)。\r\n\r\n请参考以下代码：\r\n\r\n```\r\n$tenlent_id = 'Your Sub Tenlent ID';\r\n$client_id = 'Application ID';\r\n$client_secret = 'Application Password';\r\n\r\n$auth_url = 'https://login.chinacloudapi.cn/'.$tenlent_id.'/oauth2/token?api-version=1.0';\r\n$auth = curl_init($auth_url);\r\n$post_data= 'grant_type=client_credentials&resource=https://management.chinacloudapi.cn/&client_id='.$client_id.'&client_secret='.urlencode($client_secret);\r\n\r\ncurl_setopt_array($auth, array(\r\nCURLOPT_VERBOSE => 1,\r\nCURLOPT_POST => 1,\r\nCURLOPT_POSTFIELDS => $post_data,\r\nCURLOPT_SSL_VERIFYPEER => false,\r\nCURLOPT_SSL_VERIFYHOST => false,\r\nCURLOPT_HTTPHEADER => array(\r\n'Content-Type: application/x-www-form-urlencoded'\r\n)\r\n));\r\ncurl_exec($atuh);\r\necho \"\\n\";\r\n```\r\n\r\n执行查询后会得到 Token 数据， access_token 即为访问 Token。\r\n\r\n```\r\n{\r\n\"token_type\": \"Bearer\",\r\n\"expires_in\": \"3600\",\r\n\"expires_on\": \"1455680701\",\r\n\"not_before\": \"1455676801\",\r\n\"resource\": \"https://management.azure.com/\",\r\n\"access_token\": \"eyJ0eXAiOi…\"\r\n}\r\n```\r\n\r\n然后将您要访问的 API 请求头上加上 Authorization 的 Header 设置，并将其值设置为：\r\n\r\n![token](./media/aog-active-directory-howto-get-arm-token-by-php/token.jpg)\r\n\r\n>[!NOTE]\r\n>Token 之前要加上 Bearer。\r\n\r\n调用示例：\r\n\r\n```\r\n$token = 'eyJ0eXA…';\r\n$host = 'management.chinacloudapi.cn';\r\n$version = '2015-09-01';\r\n$url = 'https://'.$host.'/subscriptions/5bbf0cbb-647d-4bd8-b4e6-26629f109bd7/resourceGroups/Default-MySql-ChinaNorth/providers/Microsoft.MySql/servers/poddbtest/databases/kevintest?api-version='.$version;\r\n$ch = curl_init($url);\r\n$data = array(\r\n'properties' => array(\r\n'charset' => 'utf8',\r\n'collation' => 'utf8_general_ci'\r\n),\r\n);\r\n$json = json_encode($data);\r\n\r\ncurl_setopt_array($ch, array(\r\nCURLOPT_VERBOSE => 1,\r\nCURLOPT_CUSTOMREQUEST => 'PUT',\r\nCURLOPT_POSTFIELDS => $json,\r\nCURLOPT_SSL_VERIFYPEER => false,\r\nCURLOPT_SSL_VERIFYHOST => false,\r\nCURLOPT_HTTPHEADER => array(\r\n'Content-type:application/json',\r\n'Authorization:Bearer '.$token\r\n)\r\n));\r\n\r\n$ret =curl_exec($ch);\r\nif (empty($ret)) {\r\n    // some kind of an error happened\r\n    echo 'Curl error: ' . curl_error($ch);\r\n} else {\r\n    $info = curl_getinfo($ch);\r\n}\r\necho \"\\n\";\r\n```"}