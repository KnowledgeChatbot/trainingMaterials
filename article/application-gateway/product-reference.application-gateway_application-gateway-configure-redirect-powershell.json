{"Title":"为 Azure 应用程序网关配置重定向 - PowerShell","Description":"本页提供有关使用 PowerShell 为应用程序网关配置重定向的方案","Content":"# <a name=\"configure-redirection-on-application-gateway-with-powershell\"></a>使用 PowerShell 在应用程序网关上配置重定向\r\n\r\n应用程序网关支持基于定义的配置重定向流量的功能。 若要详细了解有关重定向的一般信息，请访问[应用程序网关重定向概述](application-gateway-redirect-overview.md)。 本文提供 HTTP 到 HTTPS 的重定向、基于路径的重定向、多站点重定向以及到外部站点的重定向的示例。\r\n\r\n## <a name=\"http-to-https-redirect-on-an-existing-application-gateway\"></a>现有应用程序网关上的 HTTP 到 HTTPS 的重定向\r\n\r\n以下示例在端口 80 上创建一个新的 HTTP 侦听器，用于将请求重定向到端口 443 上的现有侦听器。\r\n\r\n```powershell\r\n# Get the application gateway\r\n$gw = Get-AzureRmApplicationGateway -Name AdatumAppGateway -ResourceGroupName testChinaNorthGroup\r\n\r\n# Get the existing HTTPS listener\r\n$httpslistener = Get-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener -ApplicationGateway $gw\r\n\r\n# Get the existing front end IP configuration\r\n$fipconfig = Get-AzureRmApplicationGatewayFrontendIPConfig -Name appgatewayfrontendip -ApplicationGateway $gw\r\n\r\n# Add a new front end port to support HTTP traffic\r\nAdd-AzureRmApplicationGatewayFrontendPort -Name appGatewayFrontendPort2  -Port 80 -ApplicationGateway $gw\r\n\r\n# Get the recently created port\r\n$fp = Get-AzureRmApplicationGatewayFrontendPort -Name appGatewayFrontendPort2 -ApplicationGateway $gw\r\n\r\n# Create a new HTTP listener using the port created earlier\r\nAdd-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener2  -Protocol Http -FrontendPort $fp -FrontendIPConfiguration $fipconfig -ApplicationGateway $gw \r\n\r\n# Get the new listener\r\n$listener = Get-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener2 -ApplicationGateway $gw\r\n\r\n# Add a redirection configuration using a permanent redirect and targeting the existing listener\r\nAdd-AzureRmApplicationGatewayRedirectConfiguration -Name redirectHttptoHttps -RedirectType Permanent -TargetListener $httpslistener -IncludePath $true -IncludeQueryString $true -ApplicationGateway $gw\r\n\r\n# Get the redirect configuration\r\n$redirectconfig = Get-AzureRmApplicationGatewayRedirectConfiguration -Name redirectHttptoHttps -ApplicationGateway $gw\r\n\r\n\r\n# Add a new rule to handle the redirect and use the new listener\r\nAdd-AzureRmApplicationGatewayRequestRoutingRule -Name rule02 -RuleType Basic -HttpListener $listener -RedirectConfiguration $redirectconfig -ApplicationGateway $gw\r\n\r\n# Update the application gateway\r\nSet-AzureRmApplicationGateway -ApplicationGateway $gw \r\n```\r\n\r\n更新应用程序网关后，请测试端口 80 上的新侦听器。  以下示例演示如何使用 `curl` 测试重定向。\r\n\r\n```\r\ncurl http://40.69.161.221 -i\r\nHTTP/1.1 301 Moved Permanently\r\nContent-Type: text/html; charset=UTF-8\r\nLocation: https://40.69.161.221/\r\nServer: Microsoft-IIS/10.0\r\nDate: Tue, 11 Jul 2017 20:54:00 GMT\r\nContent-Length: 145\r\n\r\n<head><title>Document Moved</title></head>\r\n<body><h1>Object Moved</h1>This document may be found <a HREF=\"https://40.69.161.221/\">here</a></body>\r\n```\r\n\r\n## <a name=\"path-based-redirect\"></a>基于路径的重定向\r\n\r\n以下示例在现有应用程序网关上创建新的侦听器和基于路径的规则，以便只重定向符合特定 URL 路径的流量。\r\n\r\n```powershell\r\n# Get the application gateway\r\n$gw = Get-AzureRmApplicationGateway -Name AdatumAppGateway -ResourceGroupName testChinaNorthGroup\r\n\r\n# Get the existing HTTPS listener\r\n$httpslistener = Get-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener -ApplicationGateway $gw\r\n\r\n# Get the existing front end IP configuration\r\n$fipconfig = Get-AzureRmApplicationGatewayFrontendIPConfig -Name appgatewayfrontendip -ApplicationGateway $gw\r\n\r\n# Add a new front end port to support HTTP traffic\r\nAdd-AzureRmApplicationGatewayFrontendPort -Name appGatewayFrontendPort2  -Port 80 -ApplicationGateway $gw\r\n\r\n# Get the recently created port\r\n$fp = Get-AzureRmApplicationGatewayFrontendPort -Name appGatewayFrontendPort2 -ApplicationGateway $gw\r\n\r\n# Create a new HTTP listener using the port created earlier\r\nAdd-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener2  -Protocol Http -FrontendPort $fp -FrontendIPConfiguration $fipconfig -ApplicationGateway $gw \r\n\r\n# Get the new listener\r\n$listener = Get-AzureRmApplicationGatewayHttpListener -Name appgatewayhttplistener2 -ApplicationGateway $gw\r\n\r\n# Add a redirection configuration using a permanent redirect and targeting the existing listener\r\n$redirectconfig = Get-AzureRmApplicationGatewayRedirectConfiguration -Name redirectpath6 -ApplicationGateway $gw\r\n\r\n# Retrieve the existing backend http settings to be used\r\n$poolSetting = Get-AzureRmApplicationGatewayBackendHttpSettings -Name \"appGatewayBackendHttpSettings\" -ApplicationGateway $gw\r\n\r\n# Retrieve an existing backend pool\r\n$pool = Get-AzureRmApplicationGatewayBackendAddressPool -Name appGatewayBackendPool -ApplicationGateway $gw\r\n\r\n# Create a new path based rule\r\n$pathRule = New-AzureRmApplicationGatewayPathRuleConfig -Name \"pathrule6\" -Paths \"/image/*\" -BackendAddressPool $pool -BackendHttpSettings $poolSetting\r\n\r\n# Create a path map to add to the rule\r\nAdd-AzureRmApplicationGatewayUrlPathMapConfig -Name \"urlpathmap\" -PathRules $pathRule -DefaultBackendAddressPool $pool -DefaultBackendHttpSettings $poolSetting -ApplicationGateway $gw\r\n\r\n# Retrieve the url path map created\r\n$urlPathMap = Get-AzureRmApplicationGatewayUrlPathMapConfig -Name \"urlpathmap\" -ApplicationGateway $gw\r\n\r\n# Add a new rule to handle the redirect and use the new listener\r\nAdd-AzureRmApplicationGatewayRequestRoutingRule -Name \"rule6\" -RuleType PathBasedRouting -HttpListener $listener -UrlPathMap $urlPathMap -RedirectConfiguration $redirectconfig -ApplicationGateway $gw\r\n\r\n# Update the application gateway\r\nSet-AzureRmApplicationGateway -ApplicationGateway $gw \r\n```\r\n\r\n## <a name=\"multi-site-redirect\"></a>多站点重定向\r\n\r\n以下示例在端口 80 上创建包含 2 个多站点侦听器的新应用程序网关。 这些侦听器针对 adatum.com 和 adatum.org。示例中创建了一个重定向规则，用于将流量从 adatum.org 重定向到 adatum.com。要将 CNAME 别名配置为应用程序网关的公共 IP 地址，需要进行其他配置。\r\n\r\n```powershell\r\n# Create a new resource group for the application gateway\r\nNew-AzureRmResourceGroup -Name appgw-rg -Location \"China North\"\r\n\r\n# Create a subnet configuration object for the application gateway subnet. A subnet for an application should have a minimum of 28 mask bits. This value leaves 10 available addresses in the subnet for Application Gateway instances. With a smaller subnet, you may not be able to add more instance of your application gateway in the future.\r\n$gwSubnet = New-AzureRmVirtualNetworkSubnetConfig -Name 'appgwsubnet' -AddressPrefix 10.0.0.0/24\r\n\r\n# Create a subnet configuration object for the backend pool members subnet\r\n$nicSubnet = New-AzureRmVirtualNetworkSubnetConfig  -Name 'appsubnet' -AddressPrefix 10.0.2.0/24\r\n\r\n# Create the virtual network with the previous created subnets\r\n$vnet = New-AzureRmvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg -Location \"China North\" -AddressPrefix 10.0.0.0/16 -Subnet $gwSubnet, $nicSubnet\r\n\r\n# Create a public IP address for use with the application gateway. Defining the domainnamelabel during creation is not supported for use with application gateway\r\n$publicip = New-AzureRmPublicIpAddress -ResourceGroupName appgw-rg -name 'appgwpip' -Location \"China North\" -AllocationMethod Dynamic\r\n\r\n# Create a IP configuration. This configures what subnet the Application Gateway uses. When Application Gateway starts, it picks up an IP address from the subnet configured and routes network traffic to the IP addresses in the back-end IP pool.\r\n$gipconfig = New-AzureRmApplicationGatewayIPConfiguration -Name 'gwconfig' -Subnet $vnet.Subnets[0]\r\n\r\n# Create a backend pool to hold the addresses or NICs for the application that application gateway is protecting.\r\n$pool = New-AzureRmApplicationGatewayBackendAddressPool -Name 'pool01' -BackendIPAddresses 1.1.1.1, 2.2.2.2, 3.3.3.3\r\n\r\n# Conifugre the backend HTTP settings to be used to define how traffic is routed to the backend pool. The authenication certificate used in the previous step is added to the backend http settings.\r\n$poolSetting = New-AzureRmApplicationGatewayBackendHttpSettings -Name 'setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled\r\n\r\n# Create a frontend port to be used by the listener.\r\n$fp = New-AzureRmApplicationGatewayFrontendPort -Name 'port01'  -Port 80\r\n\r\n# Create a frontend IP configuration to associate the public IP address with the application gateway\r\n$fipconfig = New-AzureRmApplicationGatewayFrontendIPConfig -Name 'fip01' -PublicIPAddress $publicip\r\n\r\n# Create the HTTP listener for the application gateway for adatum.com. Assign the front-end ip configuration, and port.\r\n$listener1 = New-AzureRmApplicationGatewayHttpListener -Name listener01 -Protocol Http -FrontendIPConfiguration $fipconfig -FrontendPort $fp -HostName adatum.com\r\n\r\n# Create the HTTP listener for the application gateway for adatum.org this listener will redirect to the abc.com listener. Assign the front-end ip configuration, and port.\r\n$listener2 = New-AzureRmApplicationGatewayHttpListener -Name listener02 -Protocol Http -FrontendIPConfiguration $fipconfig -FrontendPort $fp -HostName adatum.org\r\n\r\n# Create the redirect configuration that will point traffic to the \r\n$redirectconfig = New-AzureRmApplicationGatewayRedirectConfiguration -Name redirectOrgtoCom -RedirectType Found -TargetListener $listener1 -IncludePath $true -IncludeQueryString $true\r\n\r\n#Create a load balancer routing rule that configures the load balancer behavior. In this example, a basic round robin rule is created.\r\n$rule1 = New-AzureRmApplicationGatewayRequestRoutingRule -Name rule01 -RuleType Basic -HttpListener $listener1 -BackendHttpSettings $poolSetting -BackendAddressPool $pool\r\n\r\n#Create a load balancer routing rule that redirects traffic to the adatum.com listener\r\n$rule2 = New-AzureRmApplicationGatewayRequestRoutingRule -Name rule02 -RuleType Basic -HttpListener $listener2 -RedirectConfiguration $redirectconfig\r\n\r\n# Configure the SKU of the application gateway\r\n$sku = New-AzureRmApplicationGatewaySku -Name Standard_Medium -Tier Standard -Capacity 2\r\n\r\n# Create the application gateway utilizing all the previously created configuration objects\r\n$appgw = New-AzureRmApplicationGateway -Name appgwtest -ResourceGroupName appgw-rg -Location \"China North\" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting -FrontendIpConfigurations $fipconfig  -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener,$listener2 -RequestRoutingRules $rule1,$rule2 -RedirectConfigurations $redirectconfig -Sku $sku\r\n```\r\n\r\n## <a name=\"redirect-to-an-external-site\"></a>到外部站点的重定向\r\n\r\n以下示例将传入应用程序网关的流量重定向到外部网站 (bing.com)。 使用 `TargetUrl` 开关时，不允许使用 `IncludePath` 和 `IncludeQuery` 开关。\r\n\r\n```powershell\r\n# Create a new resource group for the application gateway\r\nNew-AzureRmResourceGroup -Name appgw-rg -Location \"China North\"\r\n\r\n# Create a subnet configuration object for the application gateway subnet. A subnet for an application should have a minimum of 28 mask bits. This value leaves 10 available addresses in the subnet for Application Gateway instances. With a smaller subnet, you may not be able to add more instance of your application gateway in the future.\r\n$gwSubnet = New-AzureRmVirtualNetworkSubnetConfig -Name 'appgwsubnet' -AddressPrefix 10.0.0.0/24\r\n\r\n# Create a subnet configuration object for the backend pool members subnet\r\n$nicSubnet = New-AzureRmVirtualNetworkSubnetConfig  -Name 'appsubnet' -AddressPrefix 10.0.2.0/24\r\n\r\n# Create the virtual network with the previous created subnets\r\n$vnet = New-AzureRmvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg -Location \"China North\" -AddressPrefix 10.0.0.0/16 -Subnet $gwSubnet, $nicSubnet\r\n\r\n# Create a public IP address for use with the application gateway. Defining the domainnamelabel during creation is not supported for use with application gateway\r\n$publicip = New-AzureRmPublicIpAddress -ResourceGroupName appgw-rg -name 'appgwpip' -Location \"China North\" -AllocationMethod Dynamic\r\n\r\n# Create a IP configuration. This configures what subnet the Application Gateway uses. When Application Gateway starts, it picks up an IP address from the subnet configured and routes network traffic to the IP addresses in the back-end IP pool.\r\n$gipconfig = New-AzureRmApplicationGatewayIPConfiguration -Name 'gwconfig' -Subnet $vnet.Subnets[0]\r\n\r\n# Create a backend pool to hold the addresses or NICs for the application that application gateway is protecting.\r\n$pool = New-AzureRmApplicationGatewayBackendAddressPool -Name 'pool01' -BackendIPAddresses 1.1.1.1, 2.2.2.2, 3.3.3.3\r\n\r\n# Conifugre the backend HTTP settings to be used to define how traffic is routed to the backend pool. The authenication certificate used in the previous step is added to the backend http settings.\r\n$poolSetting = New-AzureRmApplicationGatewayBackendHttpSettings -Name 'setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled\r\n\r\n# Create a frontend port to be used by the listener.\r\n$fp = New-AzureRmApplicationGatewayFrontendPort -Name 'port01'  -Port 80\r\n\r\n# Create a frontend IP configuration to associate the public IP address with the application gateway\r\n$fipconfig = New-AzureRmApplicationGatewayFrontendIPConfig -Name 'fip01' -PublicIPAddress $publicip\r\n\r\n# Create the HTTP listener for the application gateway. Assign the front-end ip configuration, and port.\r\n$listener = New-AzureRmApplicationGatewayHttpListener -Name listener01 -Protocol Http -FrontendIPConfiguration $fipconfig -FrontendPort $fp \r\n\r\n# Create the redirect configuration that will point traffic to the \r\n$redirectconfig = New-AzureRmApplicationGatewayRedirectConfiguration -Name myredirect -RedirectType Temporary -TargetUrl \"http://bing.com\" -IncludePath $true -IncludeQueryString $true\r\n\r\n#Create a load balancer routing rule that configures the load balancer behavior. In this example, a basic round robin rule is created.\r\n$rule = New-AzureRmApplicationGatewayRequestRoutingRule -Name rule01 -RuleType Basic -HttpListener $listener -RedirectConfiguration $redirectconfig \r\n\r\n# Configure the SKU of the application gateway\r\n$sku = New-AzureRmApplicationGatewaySku -Name WAF_Medium -Tier WAF -Capacity 2\r\n\r\n# Create the application gateway utilizing all the previously created configuration objects\r\n$appgw = New-AzureRmApplicationGateway -Name appgwtest -ResourceGroupName appgw-rg -Location \"China North\" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting -FrontendIpConfigurations $fipconfig  -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener -RequestRoutingRules $rule -RedirectConfigurations $redirectconfig -Sku $sku\r\n```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n访问[使用 PowerShell 为应用程序网关配置端到端 SSL](application-gateway-end-to-end-ssl-powershell.md)\r\n\r\n"}