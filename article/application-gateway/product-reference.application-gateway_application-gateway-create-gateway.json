{"Title":"创建、启动或删除应用程序网关","Description":"此页提供有关创建、配置、启动和删除 Azure 应用程序网关的说明","Content":"# <a name=\"create-start-or-delete-an-application-gateway-with-powershell\"></a>使用 PowerShell 创建、启动或删除应用程序网关 \r\n\r\n> [!div class=\"op_single_selector\"]\r\n> * [Azure 门户](application-gateway-create-gateway-portal.md)\r\n> * [Azure Resource Manager PowerShell](application-gateway-create-gateway-arm.md)\r\n> * [Azure 经典 PowerShell](application-gateway-create-gateway.md)\r\n> * [Azure Resource Manager 模板](application-gateway-create-gateway-arm-template.md)\r\n> * [Azure CLI](application-gateway-create-gateway-cli.md)\r\n\r\nAzure 应用程序网关是第 7 层负载均衡器。 它在不同服务器之间提供故障转移和性能路由 HTTP 请求，而不管它们是在云中还是本地。 应用程序网关提供许多应用程序传送控制器 (ADC) 功能，包括 HTTP 负载均衡、基于 Cookie 的会话相关性、安全套接字层 (SSL) 卸载、自定义运行状况探测、多站点支持，以及许多其他功能。 若要查找支持的功能的完整列表，请参阅[应用程序网关概述](application-gateway-introduction.md)\r\n\r\n本文指导你完成创建、配置、启动和删除应用程序网关的步骤。\r\n\r\n## <a name=\"before-you-begin\"></a>开始之前\r\n\r\n1. 使用 Web 平台安装程序安装最新版本的 Azure PowerShell cmdlet。 可以从[下载页](/downloads/)的“Windows PowerShell”部分下载并安装最新版本。\r\n2. 如果有现有的虚拟网络，请选择现有一个空子网，或者在现有虚拟网络中创建一个新子网，专门供应用程序网关使用。 应用程序网关部署到的虚拟网络必须与要部署在应用程序网关后面的资源相同，除非使用 vnet 对等互连。 若要了解详细信息，请访问 [Vnet 对等互连](../virtual-network/virtual-network-peering-overview.md)\r\n3. 请确认已创建包含有效子网、可正常运行的虚拟网络。 请确保没有虚拟机或云部署正在使用子网。 应用程序网关必须单独位于虚拟网络子网中。\r\n4. 必须存在配置为使用应用程序网关的服务器，或者必须在虚拟网络中为其创建终结点，或者必须为其分配公共 IP/VIP。\r\n\r\n## <a name=\"what-is-required-to-create-an-application-gateway\"></a>创建应用程序网关需要什么？\r\n\r\n使用 `New-AzureApplicationGateway` 命令创建应用程序网关时，暂时不需要设置任何配置，新建的资源使用 XML 或配置对象配置。\r\n\r\n有效值为：\r\n\r\n- **后端服务器池：** 后端服务器的 IP 地址列表。 列出的 IP 地址应属于虚拟网络子网，或者是公共 IP/VIP。\r\n- **后端服务器池设置：** 每个池都有一些设置，例如端口、协议和基于 Cookie 的关联性。 这些设置绑定到池，并会应用到池中的所有服务器。\r\n- **前端端口：** 此端口是应用程序网关上打开的公共端口。 流量将抵达此端口，并重定向到后端服务器之一。\r\n- **侦听器：**侦听器具有前端端口、协议（Http 或 Https，这些值区分大小写）和 SSL 证书名称（如果要配置 SSL 卸载）。\r\n- \r\n            **规则：** 规则会绑定侦听器和后端服务器池，并定义当流量抵达特定侦听器时应定向到的后端服务器池。\r\n\r\n## <a name=\"create-an-application-gateway\"></a>创建应用程序网关\r\n\r\n创建应用程序网关：\r\n\r\n1. 创建应用程序网关资源。\r\n2. 创建配置 XML 文件或配置对象。\r\n3. 将配置提交到新建的应用程序网关资源。\r\n\r\n> [!NOTE]\r\n> 如果需要为应用程序网关配置自定义探测，请参阅 [Create an application gateway with custom probes by using PowerShell](application-gateway-create-probe-classic-ps.md)（使用 PowerShell 创建带自定义探测的应用程序网关）。 有关详细信息，请查看 [custom probes and health monitoring](application-gateway-probe-overview.md)（自定义探测和运行状况监视）。\r\n\r\n![方案示例][scenario]\r\n\r\n### <a name=\"create-an-application-gateway-resource\"></a>创建应用程序网关资源\r\n\r\n要创建网关，请使用 `New-AzureApplicationGateway` cmdlet，并将值替换为你自己的值。 此时不会开始计收网关的费用。 计费会在后面已成功启动网关时开始。\r\n\r\n以下示例使用名为“testvnet1”的虚拟网络和名为“subnet-1”的子网创建应用程序网关：\r\n\r\n```powershell\r\nNew-AzureApplicationGateway -Name AppGwTest -VnetName testvnet1 -Subnets @(\"Subnet-1\")\r\n```\r\n\r\nDescription、InstanceCount 和 GatewaySize 是可选参数。\r\n\r\n若要验证是否已创建网关，可以使用 `Get-AzureApplicationGateway` cmdlet。\r\n\r\n```powershell\r\nGet-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n```\r\nName          : AppGwTest\r\nDescription   :\r\nVnetName      : testvnet1\r\nSubnets       : {Subnet-1}\r\nInstanceCount : 2\r\nGatewaySize   : Medium\r\nState         : Stopped\r\nVirtualIPs    : {}\r\nDnsName       :\r\n```\r\n\r\n> [!NOTE]\r\n> *InstanceCount* 的默认值为 2，最大值为 10。 *GatewaySize* 的默认值为 Medium。 可以选择 Small、Medium 或 Large。\r\n\r\nVirtualIPs 和 DnsName 显示为空白，因为网关尚未启动。 这些值在网关进入运行状态后立即创建。\r\n\r\n## <a name=\"configure-the-application-gateway\"></a>配置应用程序网关\r\n\r\n可以使用 XML 或配置对象配置应用程序网关。\r\n\r\n### <a name=\"configure-the-application-gateway-by-using-xml\"></a>使用 XML 配置应用程序网关\r\n\r\n在以下示例中，使用 XML 文件配置所有应用程序网关设置，并将这些设置提交到应用程序网关资源。  \r\n\r\n#### <a name=\"step-1\"></a>步骤 1\r\n\r\n将以下文本复制到记事本中。\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<ApplicationGatewayConfiguration xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://schemas.microsoft.com/windowsazure\">\r\n    <FrontendPorts>\r\n        <FrontendPort>\r\n            <Name>(name-of-your-frontend-port)</Name>\r\n            <Port>(port number)</Port>\r\n        </FrontendPort>\r\n    </FrontendPorts>\r\n    <BackendAddressPools>\r\n        <BackendAddressPool>\r\n            <Name>(name-of-your-backend-pool)</Name>\r\n            <IPAddresses>\r\n                <IPAddress>(your-IP-address-for-backend-pool)</IPAddress>\r\n                <IPAddress>(your-second-IP-address-for-backend-pool)</IPAddress>\r\n            </IPAddresses>\r\n        </BackendAddressPool>\r\n    </BackendAddressPools>\r\n    <BackendHttpSettingsList>\r\n        <BackendHttpSettings>\r\n            <Name>(backend-setting-name-to-configure-rule)</Name>\r\n            <Port>80</Port>\r\n            <Protocol>[Http|Https]</Protocol>\r\n            <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r\n        </BackendHttpSettings>\r\n    </BackendHttpSettingsList>\r\n    <HttpListeners>\r\n        <HttpListener>\r\n            <Name>(name-of-the-listener)</Name>\r\n            <FrontendPort>(name-of-your-frontend-port)</FrontendPort>\r\n            <Protocol>[Http|Https]</Protocol>\r\n        </HttpListener>\r\n    </HttpListeners>\r\n    <HttpLoadBalancingRules>\r\n        <HttpLoadBalancingRule>\r\n            <Name>(name-of-load-balancing-rule)</Name>\r\n            <Type>basic</Type>\r\n            <BackendHttpSettings>(backend-setting-name-to-configure-rule)</BackendHttpSettings>\r\n            <Listener>(name-of-the-listener)</Listener>\r\n            <BackendAddressPool>(name-of-your-backend-pool)</BackendAddressPool>\r\n        </HttpLoadBalancingRule>\r\n    </HttpLoadBalancingRules>\r\n</ApplicationGatewayConfiguration>\r\n```\r\n\r\n编辑配置项的括号之间的值。 使用扩展名 .xml 保存文件。\r\n\r\n> [!IMPORTANT]\r\n> 协议项 Http 或 Https 区分大小写。\r\n\r\n以下示例演示如何使用配置文件设置应用程序网关。 此示例对公共端口 80 上的 HTTP 流量进行负载均衡，将网络流量发送到两个 IP 地址之间的后端端口 80。\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<ApplicationGatewayConfiguration xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://schemas.microsoft.com/windowsazure\">\r\n    <FrontendPorts>\r\n        <FrontendPort>\r\n            <Name>FrontendPort1</Name>\r\n            <Port>80</Port>\r\n        </FrontendPort>\r\n    </FrontendPorts>\r\n    <BackendAddressPools>\r\n        <BackendAddressPool>\r\n            <Name>BackendPool1</Name>\r\n            <IPAddresses>\r\n                <IPAddress>10.0.0.1</IPAddress>\r\n                <IPAddress>10.0.0.2</IPAddress>\r\n            </IPAddresses>\r\n        </BackendAddressPool>\r\n    </BackendAddressPools>\r\n    <BackendHttpSettingsList>\r\n        <BackendHttpSettings>\r\n            <Name>BackendSetting1</Name>\r\n            <Port>80</Port>\r\n            <Protocol>Http</Protocol>\r\n            <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r\n        </BackendHttpSettings>\r\n    </BackendHttpSettingsList>\r\n    <HttpListeners>\r\n        <HttpListener>\r\n            <Name>HTTPListener1</Name>\r\n            <FrontendPort>FrontendPort1</FrontendPort>\r\n            <Protocol>Http</Protocol>\r\n        </HttpListener>\r\n    </HttpListeners>\r\n    <HttpLoadBalancingRules>\r\n        <HttpLoadBalancingRule>\r\n            <Name>HttpLBRule1</Name>\r\n            <Type>basic</Type>\r\n            <BackendHttpSettings>BackendSetting1</BackendHttpSettings>\r\n            <Listener>HTTPListener1</Listener>\r\n            <BackendAddressPool>BackendPool1</BackendAddressPool>\r\n        </HttpLoadBalancingRule>\r\n    </HttpLoadBalancingRules>\r\n</ApplicationGatewayConfiguration>\r\n```\r\n\r\n#### <a name=\"step-2\"></a>步骤 2\r\n\r\n下一步，设置应用程序网关。 将 `Set-AzureApplicationGatewayConfig` cmdlet 与配置 XML 文件配合使用。\r\n\r\n```powershell\r\nSet-AzureApplicationGatewayConfig -Name AppGwTest -ConfigFile \"D:\\config.xml\"\r\n```\r\n\r\n### <a name=\"configure-the-application-gateway-by-using-a-configuration-object\"></a>使用配置对象配置应用程序网关\r\n\r\n以下示例演示如何使用配置对象配置应用程序网关。 必须单独配置所有的配置项，并将其添加到应用程序网关配置对象。 创建配置对象之后，使用 `Set-AzureApplicationGateway` 命令将配置提交到之前创建的应用程序网关资源。\r\n\r\n> [!NOTE]\r\n> 在为每个配置对象分配值之前，需要声明 PowerShell 用于存储的对象类型。 创建各项的第一行定义了所使用的 `Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model(object name)`。\r\n\r\n#### <a name=\"step-1\"></a>步骤 1\r\n\r\n创建每个配置项。\r\n\r\n按以下示例中所示创建前端 IP。\r\n\r\n```powershell\r\n$fip = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.FrontendIPConfiguration\r\n$fip.Name = \"fip1\"\r\n$fip.Type = \"Private\"\r\n$fip.StaticIPAddress = \"10.0.0.5\"\r\n```\r\n\r\n按以下示例中所示创建前端端口。\r\n\r\n```powershell\r\n$fep = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.FrontendPort\r\n$fep.Name = \"fep1\"\r\n$fep.Port = 80\r\n```\r\n\r\n创建后端服务器池。\r\n\r\n按以下示例中所示定义要添加到后端服务器池的 IP 地址。\r\n\r\n```powershell\r\n$servers = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.BackendServerCollection\r\n$servers.Add(\"10.0.0.1\")\r\n$servers.Add(\"10.0.0.2\")\r\n```\r\n\r\n使用 $server 对象将值添加到后端池对象 ($pool)。\r\n\r\n```powershell\r\n$pool = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.BackendAddressPool\r\n$pool.BackendServers = $servers\r\n$pool.Name = \"pool1\"\r\n```\r\n\r\n创建后端服务器池设置。\r\n\r\n```powershell\r\n$setting = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.BackendHttpSettings\r\n$setting.Name = \"setting1\"\r\n$setting.CookieBasedAffinity = \"enabled\"\r\n$setting.Port = 80\r\n$setting.Protocol = \"http\"\r\n```\r\n\r\n创建侦听器。\r\n\r\n```powershell\r\n$listener = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.HttpListener\r\n$listener.Name = \"listener1\"\r\n$listener.FrontendPort = \"fep1\"\r\n$listener.FrontendIP = \"fip1\"\r\n$listener.Protocol = \"http\"\r\n$listener.SslCert = \"\"\r\n```\r\n\r\n创建规则。\r\n\r\n```powershell\r\n$rule = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.HttpLoadBalancingRule\r\n$rule.Name = \"rule1\"\r\n$rule.Type = \"basic\"\r\n$rule.BackendHttpSettings = \"setting1\"\r\n$rule.Listener = \"listener1\"\r\n$rule.BackendAddressPool = \"pool1\"\r\n```\r\n\r\n#### <a name=\"step-2\"></a>步骤 2\r\n\r\n将每个配置项分配给应用程序网关配置对象 ($appgwconfig)。\r\n\r\n将前端 IP 添加到配置。\r\n\r\n```powershell\r\n$appgwconfig = New-Object Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.ApplicationGatewayConfiguration\r\n$appgwconfig.FrontendIPConfigurations = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.FrontendIPConfiguration]\"\r\n$appgwconfig.FrontendIPConfigurations.Add($fip)\r\n```\r\n\r\n将前端端口添加到配置。\r\n\r\n```powershell\r\n$appgwconfig.FrontendPorts = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.FrontendPort]\"\r\n$appgwconfig.FrontendPorts.Add($fep)\r\n```\r\n将后端服务器池添加到配置。\r\n\r\n```powershell\r\n$appgwconfig.BackendAddressPools = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.BackendAddressPool]\"\r\n$appgwconfig.BackendAddressPools.Add($pool)\r\n```\r\n\r\n将后端池设置添加到配置。\r\n\r\n```powershell\r\n$appgwconfig.BackendHttpSettingsList = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.BackendHttpSettings]\"\r\n$appgwconfig.BackendHttpSettingsList.Add($setting)\r\n```\r\n\r\n将侦听器添加到配置。\r\n\r\n```powershell\r\n$appgwconfig.HttpListeners = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.HttpListener]\"\r\n$appgwconfig.HttpListeners.Add($listener)\r\n```\r\n\r\n将规则添加到配置。\r\n\r\n```powershell\r\n$appgwconfig.HttpLoadBalancingRules = New-Object \"System.Collections.Generic.List[Microsoft.WindowsAzure.Commands.ServiceManagement.Network.ApplicationGateway.Model.HttpLoadBalancingRule]\"\r\n$appgwconfig.HttpLoadBalancingRules.Add($rule)\r\n```\r\n\r\n### <a name=\"step-3\"></a>步骤 3\r\n使用 `Set-AzureApplicationGatewayConfig` 将配置对象提交到应用程序网关资源。\r\n\r\n```powershell\r\nSet-AzureApplicationGatewayConfig -Name AppGwTest -Config $appgwconfig\r\n```\r\n\r\n## <a name=\"start-the-gateway\"></a>启动网关\r\n\r\n配置网关后，使用 `Start-AzureApplicationGateway` cmdlet 来启动网关。 成功启动网关后，将开始计收应用程序网关的费用。\r\n\r\n> [!NOTE]\r\n> `Start-AzureApplicationGateway` cmdlet 最多可能需要 15 到 20 分钟才能完成。\r\n\r\n```powershell\r\nStart-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n## <a name=\"verify-the-gateway-status\"></a>验证网关状态\r\n\r\n使用 `Get-AzureApplicationGateway` cmdlet 检查网关状态。 如果前一步骤中的 `Start-AzureApplicationGateway` 成功，则“状态”应为“正在运行”，Vip 和 DnsName 应包含有效的条目。\r\n\r\n以下示例演示了一个正常运行并已准备好将流量定向到 `http://<generated-dns-name>.chinacloudapp.cn`的应用程序网关。\r\n\r\n```powershell\r\nGet-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n```\r\nVERBOSE: 8:09:28 PM - Begin Operation: Get-AzureApplicationGateway\r\nVERBOSE: 8:09:30 PM - Completed Operation: Get-AzureApplicationGateway\r\nName          : AppGwTest\r\nDescription   :\r\nVnetName      : testvnet1\r\nSubnets       : {Subnet-1}\r\nInstanceCount : 2\r\nGatewaySize   : Medium\r\nState         : Running\r\nVip           : 138.91.170.26\r\nDnsName       : appgw-1b8402e8-3e0d-428d-b661-289c16c82101.chinacloudapp.cn\r\n```\r\n\r\n## <a name=\"delete-the-application-gateway\"></a>删除应用程序网关\r\n\r\n删除应用程序网关：\r\n\r\n1. 使用 `Stop-AzureApplicationGateway` cmdlet 停止该网关。\r\n2. 使用 `Remove-AzureApplicationGateway` cmdlet 删除该网关。\r\n3. 使用 `Get-AzureApplicationGateway` cmdlet 验证是否已删除该网关。\r\n\r\n以下示例在第一行显示 `Stop-AzureApplicationGateway` cmdlet，接着显示输出。\r\n\r\n```powershell\r\nStop-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n```\r\nVERBOSE: 9:49:34 PM - Begin Operation: Stop-AzureApplicationGateway\r\nVERBOSE: 10:10:06 PM - Completed Operation: Stop-AzureApplicationGateway\r\nName       HTTP Status Code     Operation ID                             Error\r\n----       ----------------     ------------                             ----\r\nSuccessful OK                   ce6c6c95-77b4-2118-9d65-e29defadffb8\r\n```\r\n\r\n应用程序网关进入停止状态后，请使用 `Remove-AzureApplicationGateway` cmdlet 删除该服务。\r\n\r\n```powershell\r\nRemove-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n```\r\nVERBOSE: 10:49:34 PM - Begin Operation: Remove-AzureApplicationGateway\r\nVERBOSE: 10:50:36 PM - Completed Operation: Remove-AzureApplicationGateway\r\nName       HTTP Status Code     Operation ID                             Error\r\n----       ----------------     ------------                             ----\r\nSuccessful OK                   055f3a96-8681-2094-a304-8d9a11ad8301\r\n```\r\n\r\n若要验证是否已删除服务，可以使用 `Get-AzureApplicationGateway` cmdlet。 此步骤不是必需的。\r\n\r\n```powershell\r\nGet-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n```\r\nVERBOSE: 10:52:46 PM - Begin Operation: Get-AzureApplicationGateway\r\n\r\nGet-AzureApplicationGateway : ResourceNotFound: The gateway does not exist.\r\n.....\r\n```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n若要配置 SSL 卸载，请参阅[配置应用程序网关以进行 SSL 卸载](application-gateway-ssl.md)。\r\n\r\n如果要将应用程序网关配置为与内部负载均衡器配合使用，请参阅[创建具有内部负载均衡器 (ILB) 的应用程序网关](application-gateway-ilb.md)。\r\n\r\n如需大体上更详细地了解负载均衡选项，请参阅：\r\n\r\n* [Azure 负载均衡器](/load-balancer/)\r\n* [Azure 流量管理器](/traffic-manager/)\r\n\r\n[scenario]: ./media/application-gateway-create-gateway/scenario.png\r\n\r\n<!--Update_Description: metadata properties update-->\r\n"}