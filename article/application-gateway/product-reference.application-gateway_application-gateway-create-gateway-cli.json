{"Title":"创建应用程序网关 - Azure CLI 2.0","Description":"了解如何在资源管理器中使用 Azure CLI 2.0 创建应用程序网关。","Content":"# <a name=\"create-an-application-gateway-by-using-the-azure-cli-20\"></a>使用 Azure CLI 2.0 创建应用程序网关\r\n\r\n> [!div class=\"op_single_selector\"]\r\n> * [Azure 门户](application-gateway-create-gateway-portal.md)\r\n> * [Azure Resource Manager PowerShell](application-gateway-create-gateway-arm.md)\r\n> * [Azure 经典 PowerShell](application-gateway-create-gateway.md)\r\n> * [Azure Resource Manager 模板](application-gateway-create-gateway-arm-template.md)\r\n> * [Azure CLI 1.0](application-gateway-create-gateway-cli.md)\r\n> * [Azure CLI 2.0](application-gateway-create-gateway-cli.md)\r\n\r\nAzure 应用程序网关是专用虚拟设备，以服务形式提供应用程序传送控制器 (ADC)，为应用程序提供各种第 7 层负载均衡功能。\r\n\r\n## <a name=\"cli-versions\"></a>CLI 版本\r\n\r\n可以使用下面一种版本的命令行接口 (CLI) 创建应用程序网关：\r\n\r\n- [Azure CLI 1.0](application-gateway-create-gateway-cli-nodejs.md)：适用于经典部署模型和 Azure 资源管理器部署模型的 Azure CLI\r\n- [Azure CLI 2.0](application-gateway-create-gateway-cli.md)：适用于资源管理器部署模型的新一代 CLI\r\n\r\n## <a name=\"prerequisite-install-the-azure-cli-20\"></a>先决条件：安装 Azure CLI 2.0\r\n\r\n若要执行本文中的步骤，需要[安装适用于 macOS、Linux 和 Windows 的 Azure CLI](/cli/install-az-cli2)。\r\n\r\n> [!NOTE]\r\n> 必须有 Azure 帐户，才能创建应用程序网关。 如果没有，请注册[试用版](../active-directory/sign-up-organization.md)。\r\n\r\n## <a name=\"scenario\"></a>方案\r\n\r\n在此方案中，将了解如何使用 Azure 门户创建应用程序网关。\r\n\r\n此方案将：\r\n\r\n- 创建包含两个实例的中型应用程序网关。\r\n- 创建名为 AdatumAppGatewayVNET 且包含 10.0.0.0/16 保留 CIDR 块的虚拟网络。\r\n- 创建名为 Appgatewaysubnet 且使用 10.0.0.0/28 作为其 CIDR 块的子网。\r\n\r\n> [!NOTE]\r\n> 在应用程序网关创建后（而不是在初始部署期间），进一步配置应用程序网关，包括自定义运行状况探测、后端池地址和其他规则。\r\n\r\n## <a name=\"before-you-begin\"></a>开始之前\r\n\r\n应用程序网关需要自己的子网。 创建虚拟网络时，请务必为多个子网留出足够的地址空间。 将应用程序网关部署到子网后，只能向此子网添加其他应用程序网关。\r\n\r\n## <a name=\"sign-in-to-azure\"></a>登录 Azure\r\n\r\n打开 **Azure 命令提示符**，并登录：\r\n\r\n```azurecli\r\naz cloud set -n AzureChinaCloud\r\naz login -u \"username\"\r\n```\r\n\r\n> [!NOTE]\r\n> 还可以使用不带开关的 `az login` 进行设备登录，登录时需要在 https://aka.ms/deviceloginchina 中输入代码。\r\n\r\n输入上一命令后，便会收到代码。 在浏览器中，转到 https://aka.ms/deviceloginchina, 继续登录过程。\r\n\r\n![显示设备登录信息的命令提示符][1]\r\n\r\n在浏览器中，输入收到的代码。 这样，可以重定向到登录页。\r\n\r\n![用于输入代码的浏览器][2]\r\n\r\n输入代码进行登录，再关闭浏览器，以便继续操作。\r\n\r\n![已成功登录][3]\r\n\r\n## <a name=\"create-the-resource-group\"></a>创建资源组\r\n\r\n创建应用程序网关前，先创建一个用于容纳它的资源组。 请使用以下命令：\r\n\r\n```azurecli\r\naz group create --name myresourcegroup --location \"chinanorth\"\r\n```\r\n\r\n## <a name=\"create-the-application-gateway\"></a>创建应用程序网关\r\n\r\n对后端服务器 IP 地址使用后端 IP 地址。 这些值可以是虚拟网络中的专用 IP、公共 IP 或后端服务器的完全限定域名。 下面的示例创建应用程序网关，针对 HTTP 设置、端口和规则进行了其他配置：\r\n\r\n```azurecli\r\naz network application-gateway create \\\r\n--name \"AdatumAppGateway\" \\\r\n--location \"chinanorth\" \\\r\n--resource-group \"myresourcegroup\" \\\r\n--vnet-name \"AdatumAppGatewayVNET\" \\\r\n--vnet-address-prefix \"10.0.0.0/16\" \\\r\n--subnet \"Appgatewaysubnet\" \\\r\n--subnet-address-prefix \"10.0.0.0/28\" \\\r\n--servers 10.0.0.4 10.0.0.5 \\\r\n--capacity 2 \\\r\n--sku Standard_Small \\\r\n--http-settings-cookie-based-affinity Enabled \\\r\n--http-settings-protocol Http \\\r\n--frontend-port 80 \\\r\n--routing-rule-type Basic \\\r\n--http-settings-port 80 \\\r\n--public-ip-address \"pip2\" \\\r\n--public-ip-address-allocation \"dynamic\" \\\r\n\r\n```\r\n\r\n上一示例展示了应用程序网关创建期间的可选属性。 以下代码示例使用必需属性创建应用程序网关：\r\n\r\n```azurecli\r\naz network application-gateway create \\\r\n--name \"AdatumAppGateway\" \\\r\n--location \"chinanorth\" \\\r\n--resource-group \"myresourcegroup\" \\\r\n--vnet-name \"AdatumAppGatewayVNET\" \\\r\n--vnet-address-prefix \"10.0.0.0/16\" \\\r\n--subnet \"Appgatewaysubnet\" \\\r\n--subnet-address-prefix \"10.0.0.0/28\" \\\r\n--servers \"10.0.0.5\"  \\\r\n--public-ip-address pip\r\n```\r\n \r\n> [!NOTE]\r\n> 有关要在创建期间使用的参数列表，请运行以下命令：`az network application-gateway create --help`。\r\n\r\n此示例使用侦听器、后端池、后端 HTTP 设置和规则的默认设置，创建基本应用程序网关。 预配成功后，即可根据部署需求修改这些设置。\r\n\r\n如果 Web 应用程序是通过前面步骤中的后端池进行定义，负载均衡便会立即生效。\r\n\r\n## <a name=\"get-the-application-gateway-dns-name\"></a>获取应用程序网关 DNS 名称\r\n创建网关后，需要配置用于通信的前端。 使用公共 IP 时，应用程序网关需要动态分配的 DNS 名称，但这并不易用。 为了确保用户能够访问应用程序网关，可以使用 CNAME 记录，指向应用程序网关的公共终结点。 \r\n\r\n若要配置别名，可使用附加到应用程序网关的 PublicIPAddress 元素检索应用程序网关及其关联的 IP/DNS 名称的详细信息。 使用应用程序网关的 DNS 名称来创建 CNAME 记录，使两个 Web 应用程序都指向此 DNS 名称。 请勿使用 A 记录，因为重启应用程序网关后 VIP 可能会发生变化。\r\n\r\n\r\n```azurecli\r\naz network public-ip show --name \"pip\" --resource-group \"AdatumAppGatewayRG\"\r\n```\r\n\r\n```\r\n{\r\n  \"dnsSettings\": {\r\n    \"domainNameLabel\": null,\r\n    \"fqdn\": \"8c786058-96d4-4f3e-bb41-660860ceae4c.chinacloudapp.cn\",\r\n    \"reverseFqdn\": null\r\n  },\r\n  \"etag\": \"W/\\\"3b0ac031-01f0-4860-b572-e3c25e0c57ad\\\"\",\r\n  \"id\": \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/AdatumAppGatewayRG/providers/Microsoft.Network/publicIPAddresses/pip2\",\r\n  \"idleTimeoutInMinutes\": 4,\r\n  \"ipAddress\": \"40.121.167.250\",\r\n  \"ipConfiguration\": {\r\n    \"etag\": null,\r\n    \"id\": \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/AdatumAppGatewayRG/providers/Microsoft.Network/applicationGateways/AdatumAppGateway2/frontendIPConfigurations/appGatewayFrontendIP\",\r\n    \"name\": null,\r\n    \"privateIpAddress\": null,\r\n    \"privateIpAllocationMethod\": null,\r\n    \"provisioningState\": null,\r\n    \"publicIpAddress\": null,\r\n    \"resourceGroup\": \"AdatumAppGatewayRG\",\r\n    \"subnet\": null\r\n  },\r\n  \"location\": \"chinanorth\",\r\n  \"name\": \"pip2\",\r\n  \"provisioningState\": \"Succeeded\",\r\n  \"publicIpAddressVersion\": \"IPv4\",\r\n  \"publicIpAllocationMethod\": \"Dynamic\",\r\n  \"resourceGroup\": \"AdatumAppGatewayRG\",\r\n  \"resourceGuid\": \"3c30d310-c543-4e9d-9c72-bbacd7fe9b05\",\r\n  \"tags\": {\r\n    \"cli[2] owner[administrator]\": \"\"\r\n  },\r\n  \"type\": \"Microsoft.Network/publicIPAddresses\"\r\n}\r\n```\r\n\r\n## <a name=\"delete-all-resources\"></a>删除所有资源\r\n\r\n若要删除在本文中创建的所有资源，请运行以下命令：\r\n\r\n```azurecli\r\naz group delete --name AdatumAppGatewayRG\r\n```\r\n \r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n若要了解如何创建自定义运行状况探测，请转到[使用门户创建应用程序网关的自定义探测](application-gateway-create-probe-portal.md)。\r\n\r\n若要了解如何配置 SSL 卸载，并从 Web 服务器中移除成本高昂的 SSL 解密，请参阅[使用 Azure 资源管理器配置应用程序网关以进行 SSL 卸载](application-gateway-ssl-arm.md)。\r\n\r\n<!--Image references-->\r\n\r\n[scenario]: ./media/application-gateway-create-gateway-cli/scenario.png\r\n[1]: ./media/application-gateway-create-gateway-cli/figure1.png\r\n[2]: ./media/application-gateway-create-gateway-cli/figure2.png\r\n[3]: ./media/application-gateway-create-gateway-cli/figure3.png\r\n\r\n<!--Update_Description: wording update-->\r\n"}