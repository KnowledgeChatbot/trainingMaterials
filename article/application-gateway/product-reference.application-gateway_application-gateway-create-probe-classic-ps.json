{"Title":"创建自定义探测 - Azure 应用程序网关 - PowerShell 经典","Description":"了解如何使用经典部署模型中的 PowerShell 创建应用程序网关的自定义探测","Content":"\r\n# 使用 PowerShell 创建 Azure 应用程序网关（经典）的自定义探测\r\n\r\n> [!div class=\"op_single_selector\"]\r\n>- [Azure 门户](./application-gateway-create-probe-portal.md)\r\n>- [Azure Resource Manager PowerShell](./application-gateway-create-probe-ps.md)\r\n>- [Azure 经典 PowerShell](./application-gateway-create-probe-classic-ps.md)\r\n\r\n[!INCLUDE [azure-probe-intro-include](../../includes/application-gateway-create-probe-intro-include.md)]\r\n\r\n> [!IMPORTANT]\r\n> Azure 具有用于创建和处理资源的两个不同的部署模型：[资源管理器和经典](../azure-resource-manager/resource-manager-deployment-model.md)。本文介绍使用经典部署模型。Azure 建议大多数新部署使用 Resource Manager 模型。了解如何[使用 Resource Manager 模型执行这些步骤](./application-gateway-create-probe-ps.md)。\r\n\r\n[!INCLUDE [azure-ps-prerequisites-include.md](../../includes/azure-ps-prerequisites-include.md)]\r\n\r\n## 创建应用程序网关\r\n\r\n创建应用程序网关：\r\n\r\n1. 创建应用程序网关资源。\r\n2. 创建配置 XML 文件或配置对象。\r\n3. 将配置提交到新建的应用程序网关资源。\r\n\r\n### 创建应用程序网关资源\r\n\r\n若要创建网关，请使用 `New-AzureApplicationGateway` cmdlet，并将值替换为你自己的值。此时不会开始计收网关的费用。计费将在后面已成功启动网关时开始。\r\n\r\n以下示例使用名为“testvnet1”的虚拟网络和名为“subnet-1”的子网创建应用程序网关。\r\n\r\n```powershell\r\nNew-AzureApplicationGateway -Name AppGwTest -VnetName testvnet1 -Subnets @(\"Subnet-1\")\r\n```\r\n\r\n若要验证是否已创建网关，可以使用 `Get-AzureApplicationGateway` cmdlet。\r\n\r\n```powershell\r\nGet-AzureApplicationGateway AppGwTest\r\n```\r\n\r\n> [!NOTE]\r\n> *InstanceCount* 的默认值为 2，最大值为 10。*GatewaySize* 的默认值为 Medium。可以选择 Small、Medium 或 Large。\r\n> \r\n> \r\n\r\n*VirtualIPs* 和 *DnsName* 显示为空白，因为网关尚未启动。这些值在网关进入运行状态后立即创建。\r\n\r\n## 配置应用程序网关\r\n\r\n可以使用 XML 或配置对象配置应用程序网关。\r\n\r\n## 使用 XML 配置应用程序网关\r\n\r\n在以下示例中，使用 XML 文件配置所有应用程序网关设置，并将这些设置提交到应用程序网关资源。\r\n\r\n### 步骤 1\r\n\r\n将以下文本复制到记事本中。\r\n\r\n```xml\r\n<ApplicationGatewayConfiguration xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://schemas.microsoft.com/windowsazure\">\r\n<FrontendIPConfigurations>\r\n    <FrontendIPConfiguration>\r\n        <Name>fip1</Name>\r\n        <Type>Private</Type>\r\n    </FrontendIPConfiguration>\r\n</FrontendIPConfigurations>\r\n<FrontendPorts>\r\n    <FrontendPort>\r\n        <Name>port1</Name>\r\n        <Port>80</Port>\r\n    </FrontendPort>\r\n</FrontendPorts>\r\n<Probes>\r\n    <Probe>\r\n        <Name>Probe01</Name>\r\n        <Protocol>Http</Protocol>\r\n        <Host>contoso.com</Host>\r\n        <Path>/path/custompath.htm</Path>\r\n        <Interval>15</Interval>\r\n        <Timeout>15</Timeout>\r\n        <UnhealthyThreshold>5</UnhealthyThreshold>\r\n    </Probe>\r\n    </Probes>\r\n    <BackendAddressPools>\r\n    <BackendAddressPool>\r\n        <Name>pool1</Name>\r\n        <IPAddresses>\r\n            <IPAddress>1.1.1.1</IPAddress>\r\n            <IPAddress>2.2.2.2</IPAddress>\r\n        </IPAddresses>\r\n    </BackendAddressPool>\r\n</BackendAddressPools>\r\n<BackendHttpSettingsList>\r\n    <BackendHttpSettings>\r\n        <Name>setting1</Name>\r\n        <Port>80</Port>\r\n        <Protocol>Http</Protocol>\r\n        <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r\n        <RequestTimeout>120</RequestTimeout>\r\n        <Probe>Probe01</Probe>\r\n    </BackendHttpSettings>\r\n</BackendHttpSettingsList>\r\n<HttpListeners>\r\n    <HttpListener>\r\n        <Name>listener1</Name>\r\n        <FrontendIP>fip1</FrontendIP>\r\n    <FrontendPort>port1</FrontendPort>\r\n        <Protocol>Http</Protocol>\r\n    </HttpListener>\r\n</HttpListeners>\r\n<HttpLoadBalancingRules>\r\n    <HttpLoadBalancingRule>\r\n        <Name>lbrule1</Name>\r\n        <Type>basic</Type>\r\n        <BackendHttpSettings>setting1</BackendHttpSettings>\r\n        <Listener>listener1</Listener>\r\n        <BackendAddressPool>pool1</BackendAddressPool>\r\n    </HttpLoadBalancingRule>\r\n</HttpLoadBalancingRules>\r\n</ApplicationGatewayConfiguration>\r\n```\r\n\r\n编辑配置项的括号之间的值。使用扩展名 .xml 保存文件。\r\n\r\n以下示例演示如何使用配置文件设置应用程序网关以负载均衡公共端口 80 上的 HTTP 流量，然后使用自定义探测将网络流量发送到两个 IP 地址之间的后端端口 80。\r\n\r\n>[!IMPORTANT]\r\n> 协议项 Http 或 Https 区分大小写。\r\n\r\n已添加用于配置自定义探测的新配置项 \\<Probe\\>。\r\n\r\n配置参数为：\r\n\r\n* **Name** - 自定义探测的引用名称。\r\n* **Protocol** - 使用的协议（可能的值为 HTTP 或 HTTPS）。\r\n* **Host** 和 **Path** - 应用程序网关为了确定实例运行状况而调用的完整 URL 路径。例如，如果网站为 http://contoso.com/ ，则可以为 \"http://contoso.com/path/custompath.htm\" 配置自定义探测，使探测检查能够获得成功的 HTTP 响应。\r\n* **Interval** - 配置探测检查间隔，以秒为单位。\r\n* **Timeout** - 定义 HTTP 响应检查的探测超时。\r\n* **UnhealthyThreshold** - 将后端实例标记为*不正常* 所需的失败 HTTP 响应数目。\r\n\r\n在 \\<BackendHttpSettings\\> 配置中引用探测名称，分配使用自定义探测设置的后端池。\r\n\r\n## 将自定义探测配置添加到现有应用程序网关\r\n\r\n更改当前的应用程序网关配置需要完成三个步骤：获取当前的 XML 配置文件，对其进行修改以创建自定义探测，使用新的 XML 设置来配置应用程序网关。\r\n\r\n### 步骤 1\r\n\r\n使用 Get-AzureApplicationGatewayConfig 获取 XML 文件。这会导出要修改的配置 XML 以添加探测设置。\r\n\r\n```powershell\r\nGet-AzureApplicationGatewayConfig -Name \"<application gateway name>\" -Exporttofile \"<path to file>\"\r\n```\r\n\r\n### 步骤 2\r\n\r\n在文本编辑器中打开 XML 文件。将 `<probe>` 节添加到 `<frontendport>` 的后面。\r\n\r\n```xml\r\n<Probes>\r\n    <Probe>\r\n        <Name>Probe01</Name>\r\n        <Protocol>Http</Protocol>\r\n        <Host>contoso.com</Host>\r\n        <Path>/path/custompath.htm</Path>\r\n        <Interval>15</Interval>\r\n        <Timeout>15</Timeout>\r\n        <UnhealthyThreshold>5</UnhealthyThreshold>\r\n    </Probe>\r\n</Probes>\r\n```\r\n\r\n在 XML 的 backendHttpSettings 节中，添加以下示例中所示的探测名称：\r\n\r\n```xml\r\n    <BackendHttpSettings>\r\n        <Name>setting1</Name>\r\n        <Port>80</Port>\r\n        <Protocol>Http</Protocol>\r\n        <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r\n        <RequestTimeout>120</RequestTimeout>\r\n        <Probe>Probe01</Probe>\r\n    </BackendHttpSettings>\r\n```\r\n\r\n保存该 XML 文件。\r\n\r\n### 步骤 3\r\n\r\n使用 `Set-AzureApplicationGatewayConfig` 在新的 XML 文件中更新应用程序网关配置。这将以新的配置更新应用程序网关。\r\n\r\n```powershell\r\nSet-AzureApplicationGatewayConfig -Name \"<application gateway name>\" -Configfile \"<path to file>\"\r\n```\r\n\r\n## 后续步骤\r\n\r\n如果要配置安全套接字层 (SSL) 卸载，请参阅[配置应用程序网关以进行 SSL 卸载](./application-gateway-ssl.md)。\r\n\r\n如果你想要将应用程序网关配置为与内部负载均衡器配合使用，请参阅[创建具有内部负载均衡器 (ILB) 的应用程序网关](./application-gateway-ilb.md)。\r\n\r\n<!---HONumber=Mooncake_Quality_Review_0104_2017-->"}