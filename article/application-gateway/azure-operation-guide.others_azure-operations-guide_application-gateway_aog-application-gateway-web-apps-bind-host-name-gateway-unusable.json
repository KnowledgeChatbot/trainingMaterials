{"Title":"如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题","Description":"如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题。","Content":"\r\n# 如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题 #\r\n\r\n### 问题描述 ###\r\n\r\n当 Web 应用绑定了主机名并使用 Azure 应用程序网关作为负载均衡器的情形下，该网页可能无法正常访问。\r\n\r\n### 问题分析 ###\r\n\r\n访问网页时，浏览器会直接弹出下面的报错：\r\n\r\n```\r\n502 - Web server received an invalid response while acting as a gateway or proxy server.\r\nThere is a problem with the page you are looking for, and it cannot be displayed. When the Web server (while acting as a gateway or proxy) contacted the upstream content server, it received an invalid response from the content server.\r\n```\r\n\r\n### 解决方法 ###\r\n\r\nAzure 应用程序网关会通过探测机制去了解后端服务器的健康状态，其默认会使用 HTTP 协议作为探测机制。如果我们没有配置自定义探针，应用程序网关会发送主机名为 127.0.0.1 路径为 “/ ” 的 HTTP GET 请求。当后端 Web 服务器绑定了主机名，这会导致 Web 服务器不会对应用程序网关的 HTTP 请求返回正确的 HTTP 响应，进而会导致应用程序网关向客户端抛出 502 的报错。\r\n\r\n下面的网络数据报文显示了程序网关发送的默认探测包，可以看到请求路径为 “/ ”，请求主机名为 127.0.0.1。\r\n\r\n```\r\nFrame: Number = 895, Captured Frame Length = 131, MediaType = ETHERNET\r\n+ Ethernet: Etype = Internet IP (IPv4),DestinationAddress:[00-17-FA-00-64-54],SourceAddress:[F8-72-EA-E0-26-81]\r\n+ Ipv4: Src = 10.30.0.56, Dest = 10.30.0.52, Next Protocol = TCP, Packet ID = 13920, Total IP Length = 117\r\n+ Tcp: Flags=...AP..., SrcPort=64902, DstPort=HTTP(80), PayloadLen=77, Seq=2534951712 - 2534951789, Ack=3462157853, Win=4121 (scale factor 0x8) = 1054976\r\n- Http: Request, GET / \r\n  Command: GET\r\n- URI: /\r\n  Location: / \r\n  ProtocolVersion: HTTP/1.1\r\n  Connection:  Keep-Alive\r\n  Host:  127.0.0.1\r\n  Max-Forwards:  10\r\n  HeaderEnd: CRLF\r\n```\r\n\r\n要解决该问题，我们需要对应用程序网关配置自定义探针。应用程序网关可以配置的自定义探针配置如下：\r\n\r\n- Name - 自定义探测的引用名称。\r\n- Protocol - 使用的协议（可能的值为 HTTP 或 HTTPS）。\r\n- Host 和 Path - 应用程序网关为了确定实例运行状况而调用的完整 URL 路径。例如，如果网站为 [http://www.contoso.com/](http://www.contoso.com/)，则可以为 “[http://www.contoso.com/path/custompath.htm](http://www.contoso.com/path/custompath.htm)” 配置自定义探测，使探测检查能够获得成功的 HTTP 响应。\r\n- Interval - 配置探测检查间隔，以秒为单位。\r\n- Timeout - 定义 HTTP 响应检查的探测超时。\r\n- UnhealthyThreshold - 将后端实例标记为不正常所需的失败 HTTP 响应数目。\r\n\r\n对于使用经典模式创建的应用程序网关只能使用 PowerShell 来进行操作。具体操作步骤如下：\r\n\r\n1. 运行下面的 PowerShell 命令导出应用程序网关的配置信息。\r\n\r\n    ```\r\n    Get-AzureApplicationGatewayConfig -Name <application gateway name> -Exporttofile \"<path to file>\"\r\n    ```\r\n\r\n2. 打开导出的文件并找到 FrontendPorts 部分，并在其之后添加 Probes 字段。Host 部分就填写 Web 服务器中所绑定的主机名，其他部分可以根据实际需求进行配置。\r\n\r\n    ```\r\n    <FrontendPorts>\r\n       <FrontendPort>\r\n           <Name>FrontendPort1</Name>\r\n           <Port>80</Port>\r\n       </FrontendPort>\r\n    </FrontendPorts>\r\n       <Probes>\r\n           <Probe>\r\n           <Name>Probe01</Name>\r\n           <Protocol>Http</Protocol>\r\n           <Host>www.contoso.com</Host>\r\n           <Path>/</Path>\r\n           <Interval>15</Interval>\r\n           <Timeout>15</Timeout>\r\n           <UnhealthyThreshold>5</UnhealthyThreshold>\r\n       </Probe>\r\n    </Probes>\r\n    ```\r\n\r\n3. 在 XML 的 backendHttpSettings 节中，添加字段 “<Probe>Probe01</Probe>” 启用在步骤 2 中创建的探针，示例如下：\r\n\r\n    ```\r\n    <BackendHttpSettings>\r\n       <Name>setting1</Name>\r\n       <Port>80</Port>\r\n       <Protocol>Http</Protocol>\r\n       <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r\n       <RequestTimeout>30</RequestTimeout>\r\n       <Probe>Probe01</Probe>\r\n    </BackendHttpSettings>\r\n    ```\r\n\r\n4. 运行下面的命令对应用程序网关进行配置。\r\n\r\n    ```\r\n    Set-AzureApplicationGatewayConfig -Name <application gateway name> -Configfile \"<path to file>\"\r\n    ```\r\n\r\n>注意：请使用最新版本的 Azure PowerShell 来进行配置，如果使用的 PowerShell 版本较老可能会导致该操作不成功。\r\n\r\n对于使用 ARM 模式创建的应用程序网关，我们可以直接在 Portal 直接进行配置。\r\n\r\n1. 如下图所示，点击“运行状况探测”，添加自定义探测并指定自定义探测的名称和主机名。\r\n\r\n    ![Portal-ARMAppGw](./media/aog-application-gateway-web-apps-bind-host-name-gateway-unusable/status-detection.png)\r\n\r\n2. 点击 “HTTP 设置”，找到对应的 HTTP 设置然后勾选 “使用自定义探测” 并选择刚才定义的探测规则，保存设置即可。\r\n\r\n    ![Portal-ARMAppGw](./media/aog-application-gateway-web-apps-bind-host-name-gateway-unusable/HTTP-setting.png)"}