{"Title":"如何将 Web 应用部署槽连接到 Azure 虚拟网络","Description":"如何将 Web 应用部署槽连接到 Azure 虚拟网络","Content":"\r\n# 如何将 Web 应用部署槽连接到 Azure 虚拟网络\r\n\r\n## 准备工作\r\n\r\n- Web 应用处于标准或高级的定价层\r\n- 具有点到站点连接配置网关的虚拟网络\r\n\r\n## 操作步骤\r\n\r\n通过以下步骤完成 Web 应用部署槽连接到虚拟网络：\r\n\r\n1. 通过 PowerShell 配置相应的参数并生成证书。\r\n\r\n    ```\r\n    $Configuration = @{}\r\n    $Configuration.WebAppResourceGroup = \"[Your web app resource group]\"\r\n    $Configuration.WebAppName = \"[websitename/slotname]\"\r\n    $Configuration.VnetSubscriptionId = \"[Your vnet subscription id]\"\r\n    $Configuration.VnetResourceGroup = \"[Your vnet resource group]\"\r\n    $Configuration.VnetName = \"[Your vnet name]\"\r\n    $Configuration.WebAppLocation = \"[Your web app Location]\"、$Configuration.GeneratedCertificatePath = \"[Your local path\\Certificate.cer]\"\r\n\r\n    $vnet = New-AzureRmResource -Name \"$($Configuration.WebAppName)/$($Configuration.VnetName)\" -ResourceGroupName $Configuration.WebAppResourceGroup -ResourceType \"Microsoft.Web/sites/virtualNetworkConnections\" -PropertyObject @{\"VnetResourceId\" = \"/subscriptions/$($Configuration.VnetSubscriptionId)/resourceGroups/$($Configuration.VnetResourceGroup)/providers/Microsoft.ClassicNetwork/virtualNetworks/$($Configuration.VnetName)\"} -Location $Configuration.WebAppLocation -ApiVersion 2015-07-01\r\n\r\n    #create certificate , run once befroe\r\n    $certBytes = [System.Convert]::FromBase64String($vnet.Properties.certBlob)\r\n    [System.IO.File]::WriteAllBytes(\"$($Configuration.GeneratedCertificatePath)\", $certBytes)\r\n    ```\r\n\r\n2. 将上一步骤生成的证书上传到已经创建好的 VNET 中。\r\n\r\n    ![certificates](./media/aog-web-apps-howto-connect-deployment-slot-to-vnet/certificates.jpg)\r\n\r\n3. 获取点到站点包，并将其供给 Web 应用。将如下内容的 GetNetworkPackageUri.json 文件，保存到本地环境中，例如：D:\\cert\\GetNetworkPackageUri.json。\r\n\r\n    ```\r\n    {\r\n        \"$schema\": \"http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#\",\r\n        \"contentVersion\": \"1.0.0.0\",\r\n        \"parameters\": {\r\n            \"certData\": {\r\n                \"type\": \"string\"\r\n            },\r\n            \"certThumbprint\": {\r\n                \"type\": \"string\"\r\n            },\r\n            \"networkName\": {\r\n                \"type\": \"string\"\r\n            }\r\n        },\r\n        \"variables\": {\r\n            \"legacyVnetName\": \"[concat('Group ', resourceGroup().name, ' ', parameters('networkName'))]\"\r\n            },\r\n            \"resources\": [\r\n            ],\r\n        \"outputs\" : {\r\n            \"PackageUri\" :\r\n            {\r\n            \"value\" : \"[listPackage(resourceId('Microsoft.ClassicNetwork/virtualNetworks/gateways/clientRootCertificates', parameters('networkName'), 'primary', parameters('certThumbprint')), '2014-06-01').packageUri]\", \"type\" : \"string\"\r\n            }\r\n        }\r\n    }\r\n    ```\r\n\r\n    执行下面部署的脚本：\r\n\r\n    ```\r\n    $parameters = @{\"certData\" = $vnet.Properties.certBlob ;certThumbprint = $vnet.Properties.certThumbprint ;\"networkName\" = $Configuration.VnetName }\r\n    $output = New-AzureRmResourceGroupDeployment -Name unused -ResourceGroupName $Configuration.VnetResourceGroup -TemplateParameterObject $parameters -TemplateFile  D:\\cert\\GetNetworkPackageUri.json\r\n    ```\r\n\r\n    将点到站点包上载到应用：\r\n\r\n    ```\r\n    $vnet = New-AzureRmResource -Name \"$($Configuration.WebAppName)/$($Configuration.VnetName)/primary\" -ResourceGroupName $Configuration.WebAppResourceGroup -ResourceType \"Microsoft.Web/sites /virtualNetworkConnections/gateways\" -ApiVersion 2015-07-01 -PropertyObject @{\"VnetName\" = $Configuration.VnetName ; \"VpnPackageUri\" = $($output.Outputs.packageUri).Value } -Location $Configuration.WebAppLocation\r\n    ```\r\n\r\n4. 执行成功后，等待几分钟，就可以通过 Portal 看到 VNET 中已经连接了一个客户端。\r\n\r\n    ![vnet](./media/aog-web-apps-howto-connect-deployment-slot-to-vnet/vnet.jpg)"}