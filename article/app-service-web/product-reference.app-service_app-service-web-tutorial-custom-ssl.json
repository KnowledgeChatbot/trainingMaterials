{"Title":"将现有的自定义 SSL 证书绑定到 Azure Web 应用","Description":"了解如何将自定义 SSL 证书绑定到 Azure 应用服务中的 Web 应用、移动应用后端或 API 应用。","Content":"# <a name=\"bind-an-existing-custom-ssl-certificate-to-azure-web-apps\"></a>将现有的自定义 SSL 证书绑定到 Azure Web 应用\r\n\r\nAzure Web 应用提供高度可缩放、自修补的 Web 托管服务。 本教程介绍如何将从受信任证书颁发机构那里购买的自定义 SSL 证书绑定到 [Azure Web 应用](app-service-web-overview.md)。 完成本教程后，你便可以访问自定义 DNS 域的 HTTPS 终结点上的 Web 应用。\r\n\r\n![包含自定义 SSL 证书的 Web 应用](./media/app-service-web-tutorial-custom-ssl/app-with-custom-ssl.png)\r\n\r\n本教程介绍如何执行下列操作：\r\n\r\n> [!div class=\"checklist\"]\r\n> * 升级应用的定价层\r\n> * 将自定义 SSL 证书绑定到应用服务\r\n> * 为应用实施 HTTPS\r\n> * 使用脚本自动执行 SSL 证书绑定\r\n\r\n## <a name=\"prerequisites\"></a>先决条件\r\n\r\n若要完成本教程，需执行以下操作：\r\n\r\n- [创建应用服务应用](/app-service/)\r\n- [将自定义 DNS 名称映射到 Web 应用](app-service-web-tutorial-custom-domain.md)\r\n- 从受信任的证书颁发机构获取 SSL 证书\r\n- 拥有用于对 SSL 证书请求进行签名的私钥\r\n\r\n<a name=\"requirements\"></a>\r\n\r\n### <a name=\"requirements-for-your-ssl-certificate\"></a>SSL 证书的要求\r\n\r\n若要在应用服务中使用证书，该证书必须满足以下所有要求：\r\n\r\n* 已由受信任的证书颁发机构签名\r\n* 已导出为受密码保护的 PFX 文件\r\n* 包含长度至少为 2048 位的私钥\r\n* 包含证书链中的所有中间证书\r\n\r\n## <a name=\"prepare-your-web-app\"></a>准备 Web 应用\r\n\r\n若要将自定义 SSL 证书绑定到 Web 应用，[应用服务计划](https://www.azure.cn/pricing/details/app-service/)必须位于“基本”、“标准”或“高级”层。 在此步骤中，请确保 Web 应用位于受支持的定价层。\r\n\r\n### <a name=\"log-in-to-azure\"></a>登录 Azure\r\n\r\n打开 [Azure 门户](https://portal.azure.cn)。\r\n\r\n### <a name=\"navigate-to-your-web-app\"></a>导航到 Web 应用\r\n\r\n在左侧菜单中单击“应用服务”，然后单击你的 Web 应用的名称。\r\n\r\n![选择 Web 应用](./media/app-service-web-tutorial-custom-ssl/select-app.png)\r\n\r\n你已登录到了 Web 应用的管理页面。  \r\n\r\n### <a name=\"check-the-pricing-tier\"></a>检查定价层\r\n\r\n在 Web 应用页面的左侧导航窗格中，向下滚动到“设置”部分，然后选择“扩大(应用服务计划)”。\r\n\r\n![扩展菜单](./media/app-service-web-tutorial-custom-ssl/scale-up-menu.png)\r\n\r\n检查以确保 Web 应用不在“免费”或“共享”层中。 深蓝色的框突出显示了 Web 应用的当前层。\r\n\r\n![检查定价层](./media/app-service-web-tutorial-custom-ssl/check-pricing-tier.png)\r\n\r\n“免费”和“共享”层不支持自定义 SSL。 如果需要进行扩展，请遵循下一部分中的步骤。 否则，请关闭“选择定价层”页面并跳到[上传和绑定 SSL 证书](#upload)。\r\n\r\n### <a name=\"scale-up-your-app-service-plan\"></a>扩展应用服务计划\r\n\r\n选择“基本”、“标准”或“高级”层。\r\n\r\n单击“选择”。\r\n\r\n![选择定价层](./media/app-service-web-tutorial-custom-ssl/choose-pricing-tier.png)\r\n\r\n如果看到以下通知，则表示缩放操作已完成。\r\n\r\n![扩展通知](./media/app-service-web-tutorial-custom-ssl/scale-notification.png)\r\n\r\n<a name=\"upload\"></a>\r\n\r\n## <a name=\"bind-your-ssl-certificate\"></a>绑定 SSL 证书\r\n\r\n现在已准备就绪，可以将 SSL 证书上传到 Web 应用了。\r\n\r\n### <a name=\"merge-intermediate-certificates\"></a>合并中间证书\r\n\r\n如果证书颁发机构在证书链中提供了多个证书，则需按顺序合并证书。 \r\n\r\n若要执行此操作，请在文本编辑器中打开收到的每个证书。 \r\n\r\n创建名为 mergedcertificate.crt 的合并证书文件。 在文本编辑器中，将每个证书的内容复制到此文件。 证书的顺序应遵循证书链中的顺序，以你的证书开头，以根证书结尾， 如以下示例所示：\r\n\r\n```\r\n-----BEGIN CERTIFICATE-----\r\n<your entire Base64 encoded SSL certificate>\r\n-----END CERTIFICATE-----\r\n\r\n-----BEGIN CERTIFICATE-----\r\n<The entire Base64 encoded intermediate certificate 1>\r\n-----END CERTIFICATE-----\r\n\r\n-----BEGIN CERTIFICATE-----\r\n<The entire Base64 encoded intermediate certificate 2>\r\n-----END CERTIFICATE-----\r\n\r\n-----BEGIN CERTIFICATE-----\r\n<The entire Base64 encoded root certificate>\r\n-----END CERTIFICATE-----\r\n```\r\n\r\n### <a name=\"export-certificate-to-pfx\"></a>将证书导出为 PFX\r\n\r\n导出合并的 SSL 证书（其中包含生成证书请求时所用的私钥）。\r\n\r\n如果使用 OpenSSL 生成证书请求，则已创建私钥文件。 若要将证书导出为 PFX，请运行以下命令。 将占位符 _&lt;private-key-file>_ 和 _&lt;merged-certificate-file>_ 分别替换为私钥和合并证书文件的路径。\r\n\r\n```bash\r\nopenssl pkcs12 -export -out myserver.pfx -inkey <private-key-file> -in <merged-certificate-file>  \r\n```\r\n\r\n出现提示时，定义导出密码。 稍后将 SSL 证书上传到应用服务时需使用此密码。\r\n\r\n如果使用了 IIS 或 _Certreq.exe_ 来生成证书请求，请将证书安装到你的本地计算机，然后[将证书导出为 PFX](https://technet.microsoft.com/library/cc754329(v=ws.11).aspx)。\r\n\r\n### <a name=\"upload-your-ssl-certificate\"></a>上传 SSL 证书\r\n\r\n若要上传 SSL 证书，请在 Web 应用的左侧导航窗格中单击“SSL 证书”。\r\n\r\n单击“上传证书”。\r\n\r\n在“PFX 证书文件”中，选择你的 PFX 文件。 在“证书密码”中，键入导出 PFX 文件时创建的密码。\r\n\r\n单击“上传”。\r\n\r\n![上传证书](./media/app-service-web-tutorial-custom-ssl/upload-certificate-private1.png)\r\n\r\n应用服务上传完证书后，该证书将显示在“SSL 证书”页中。\r\n\r\n![上传的证书](./media/app-service-web-tutorial-custom-ssl/certificate-uploaded.png)\r\n\r\n### <a name=\"bind-your-ssl-certificate\"></a>绑定 SSL 证书\r\n\r\n在“SSL 绑定”部分中，单击“添加绑定”。\r\n\r\n在“添加 SSL 绑定”页面中，使用下拉列表选择要保护的域名，然后选择要使用的证书。\r\n\r\n> [!NOTE]\r\n> 如果已上传证书，但未在“主机名”下拉列表中看到域名，请尝试刷新浏览器页面。\r\n>\r\n>\r\n\r\n在“SSL 类型”中，选择是要使用**[服务器名称指示 (SNI)](http://en.wikipedia.org/wiki/Server_Name_Indication)** 还是使用基于 IP 的 SSL。\r\n\r\n- **基于 SNI 的 SSL** - 可添加多个基于 SNI 的 SSL 绑定。 选择此选项可以使用多个 SSL 证书来保护同一 IP 地址上的多个域。 大多数新式浏览器（包括 Internet Explorer、Chrome、Firefox 和 Opera）都支持 SNI（可以在[服务器名称指示](http://wikipedia.org/wiki/Server_Name_Indication)中了解更全面的浏览器支持信息）。\r\n- **基于 IP 的 SSL** - 只能添加一个基于 IP 的 SSL 绑定。 选择此选项只能使用一个 SSL 证书来保护专用公共 IP 地址。 若要保护多个域，必须使用同一个 SSL 证书来保护所有这些域。 这是 SSL 绑定的传统选项。\r\n\r\n单击“添加绑定”。\r\n\r\n![绑定 SSL 证书](./media/app-service-web-tutorial-custom-ssl/bind-certificate.png)\r\n\r\n应用服务上传完证书后，该证书将显示在“SSL 绑定”部分中。\r\n\r\n![证书已绑定到 Web 应用](./media/app-service-web-tutorial-custom-ssl/certificate-bound.png)\r\n\r\n## <a name=\"remap-a-record-for-ip-ssl\"></a>重新映射 IP SSL 的 A 记录\r\n\r\n如果不在 Web 应用中使用基于 IP 的 SSL，请跳到[针对自定义域测试 HTTPS](#test)。\r\n\r\n默认情况下，Web 应用使用共享的公共 IP 地址。 将证书与基于 IP 的 SSL 绑定后，应用服务会立即为 Web 应用创建一个新的专用 IP 地址。\r\n\r\n如果已将 A 记录映射到 Web 应用，请使用这个新的专用 IP 地址更新域注册表。\r\n\r\n将使用新的专用 IP 地址更新 Web 应用的“自定义域”页。 [复制此 IP 地址](app-service-web-tutorial-custom-domain.md#info)，然后[将 A 记录重新映射](app-service-web-tutorial-custom-domain.md#map-an-a-record)到此新 IP 地址。\r\n\r\n<a name=\"test\"></a>\r\n\r\n## <a name=\"test-https\"></a>测试 HTTPS\r\n\r\n接下来只需确保 HTTPS 适用于自定义域。 在各种浏览器中浏览到 `https://<your.custom.domain>`，查看是否能够打开你的 Web 应用。\r\n\r\n![在门户中导航到 Azure 应用](./media/app-service-web-tutorial-custom-ssl/app-with-custom-ssl.png)\r\n\r\n> [!NOTE]\r\n> 如果 Web 应用显示证书验证错误，可能是因为使用了自签名证书。\r\n>\r\n> 如果不是这样，可能是在将证书导出为 PFX 文件时遗漏了中间证书。\r\n\r\n<a name=\"bkmk_enforce\"></a>\r\n\r\n## <a name=\"enforce-https\"></a>实施 HTTPS\r\n\r\n应用服务*不*强制实施 HTTPS，因此任何人仍可使用 HTTP 访问你的 Web 应用。 如果想要对 Web 应用强制实施 HTTPS，请在 Web 应用的 web.config 文件中定义重写规则。 无论 Web 应用的语言框架如何，应用服务都会使用此文件。\r\n\r\n> [!NOTE]\r\n> 存在语言特定的请求重定向。 ASP.NET MVC 可使用 [RequireHttps](http://msdn.microsoft.com/library/system.web.mvc.requirehttpsattribute.aspx) 筛选器，而非 _web.config_ 中的重写规则。\r\n\r\n如果你是 .NET 开发人员，应该比较熟悉此文件。 此文件位于解决方案的根目录中。\r\n\r\n或者，如果你使用 PHP、Node.js、Python 或 Java 进行开发，我们可能会在应用服务中替你生成此文件。\r\n\r\n遵循[使用 FTP/S 将应用部署到 Azure 应用服务](app-service-deploy-ftp.md)中的说明连接到 Web 应用的 FTP 终结点。\r\n\r\n此文件应位于 _/home/site/wwwroot_ 中。 如果不是，请使用以下 XML 在此文件夹中创建 _web.config_ 文件：\r\n\r\n```xml   \r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<configuration>\r\n  <system.webServer>\r\n    <rewrite>\r\n      <rules>\r\n        <!-- BEGIN rule ELEMENT FOR HTTPS REDIRECT -->\r\n        <rule name=\"Force HTTPS\" enabled=\"true\">\r\n          <match url=\"(.*)\" ignoreCase=\"false\" />\r\n          <conditions>\r\n            <add input=\"{HTTPS}\" pattern=\"off\" />\r\n          </conditions>\r\n          <action type=\"Redirect\" url=\"https://{HTTP_HOST}/{R:1}\" appendQueryString=\"true\" redirectType=\"Permanent\" />\r\n        </rule>\r\n        <!-- END rule ELEMENT FOR HTTPS REDIRECT -->\r\n      </rules>\r\n    </rewrite>\r\n  </system.webServer>\r\n</configuration>\r\n```\r\n\r\n对于现有的 _web.config_ 文件，将整个 `<rule>` 元素复制到 _web.config_ 的 `configuration/system.webServer/rewrite/rules` 元素中。 如果 _web.config_ 中已有其他 `<rule>` 元素，请将复制的 `<rule>` 元素放置在其他 `<rule>` 元素的前面。\r\n\r\n每当用户对你的 Web 应用发出 HTTP 请求时，此规则都会将 HTTP 301（永久重定向）返回到 HTTPS 协议。 例如，它从 `http://contoso.com` 重定向到 `https://contoso.com`。\r\n\r\n有关 IIS URL 重写模块的详细信息，请参阅 [URL 重写](http://www.iis.net/downloads/microsoft/url-rewrite) 文档。\r\n\r\n## <a name=\"enforce-https-for-web-apps-on-linux\"></a>对 Linux 上的 Web 应用强制实施 HTTPS\r\n\r\nLinux 上的应用服务不会强制实施 HTTPS，因此所有人仍可使用 HTTP 访问你的 Web 应用。 若要对 Web 应用强制实施 HTTPS，请在 Web 应用的 .htaccess 文件中定义重写规则。 \r\n\r\n遵循[使用 FTP/S 将应用部署到 Azure 应用服务](app-service-deploy-ftp.md)中的说明连接到 Web 应用的 FTP 终结点。\r\n\r\n在 /home/site/wwwroot 中，使用以下代码创建 .htaccess 文件：\r\n\r\n```\r\nRewriteEngine On\r\nRewriteCond %{HTTP:X-ARR-SSL} ^$\r\nRewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]\r\n```\r\n\r\n每当用户对你的 Web 应用发出 HTTP 请求时，此规则都会将 HTTP 301（永久重定向）返回到 HTTPS 协议。 例如，将请求从 `http://contoso.com` 重定向到 `https://contoso.com`。\r\n\r\n## <a name=\"automate-with-scripts\"></a>使用脚本自动化\r\n\r\n可以在 [Azure CLI](https://docs.azure.cn/zh-cn/cli/install-azure-cli?view=azure-cli-lastest) 或 [Azure PowerShell](https://docs.microsoft.com/en-us/powershell/azure/overview) 中使用脚本自动完成 Web 应用的 SSL 绑定。\r\n\r\n### <a name=\"azure-cli\"></a>Azure CLI\r\n\r\n[!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r\n\r\n以下命令上传已导出的 PFX 文件并获取指纹。\r\n\r\n```bash\r\nthumbprint=$(az webapp config ssl upload \\\r\n    --name <app_name> \\\r\n    --resource-group <resource_group_name> \\\r\n    --certificate-file <path_to_PFX_file> \\\r\n    --certificate-password <PFX_password> \\\r\n    --query thumbprint \\\r\n    --output tsv)\r\n```\r\n\r\n以下命令使用前一命令获取的指纹添加基于 SNI 的 SSL 绑定。\r\n\r\n```bash\r\naz webapp config ssl bind \\\r\n    --name <app_name> \\\r\n    --resource-group <resource_group_name>\r\n    --certificate-thumbprint $thumbprint \\\r\n    --ssl-type SNI \\\r\n```\r\n\r\n### <a name=\"azure-powershell\"></a>Azure PowerShell\r\n\r\n以下命令上传已导出的 PFX 文件并添加基于 SNI 的 SSL 绑定。\r\n\r\n```PowerShell\r\nNew-AzureRmWebAppSSLBinding `\r\n    -WebAppName <app_name> `\r\n    -ResourceGroupName <resource_group_name> `\r\n    -Name <dns_name> `\r\n    -CertificateFilePath <path_to_PFX_file> `\r\n    -CertificatePassword <PFX_password> `\r\n    -SslState SniEnabled\r\n```\r\n## <a name=\"public-certificates-optional\"></a>公用证书（可选）\r\n可向自己的 Web 应用上传[公用证书](https://blogs.msdn.microsoft.com/appserviceteam/2017/11/01/app-service-certificates-now-supports-public-certificates-cer/)。 可在应用服务或应用服务环境 (ASE) 中，通过 Web 应用使用公用证书。 若要将证书存储在 LocalMachine 证书存储中，则需要在应用服务环境中使用 Web 应用。 有关详细信息，请参阅[如何向 Web 应用配置公用证书](https://blogs.msdn.microsoft.com/appserviceteam/2017/11/01/app-service-certificates-now-supports-public-certificates-cer)。\r\n\r\n![上传公用证书](./media/app-service-web-tutorial-custom-ssl/upload-certificate-public1.png)\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n在本教程中，你已学习了如何执行以下操作：\r\n\r\n> [!div class=\"checklist\"]\r\n> * 升级应用的定价层\r\n> * 将自定义 SSL 证书绑定到应用服务\r\n> * 为应用实施 HTTPS\r\n> * 使用脚本自动执行 SSL 证书绑定\r\n\r\n<!--Update_Description: update wording and code-->"}