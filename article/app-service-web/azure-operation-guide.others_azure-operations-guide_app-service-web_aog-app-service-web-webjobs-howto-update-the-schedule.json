{"Title":"如何更改计划 Web 作业的 Schedule 时间","Description":"如何更改计划 Web 作业的 Schedule 时间","Content":"\r\n# 如何更改计划 Web 作业的 Schedule 时间\r\n\r\n## 问题描述\r\n\r\n在添加完计划 Web 作业之后，如何更改 Web 作业的 Schedule 时间。\r\n\r\n## 问题分析\r\n\r\n通过在门户中输入 CRON 表达式，或者在 Web 作业 .zip 文件的根目录中包含一个 settings.job 文件可以去设置 Web 作业的 Schedule 时间， 如果想要更改 Schedule 时间，可以通过 Kudu 在根目录中找到 settings.job 文件进行修改。另外也可以通过 [WebJobs API](https://github.com/projectkudu/kudu/wiki/WebJobs-API) 修改 settings.job 配置。\r\n\r\n## 前提/要求\r\n\r\n使用 CRON 表达式创建计划的 Web 作业可用于在基本、标准或高级模式下运行的 Web 应用，但需要应用上启用 “ **AlwaysOn** ”设置。\r\n\r\n如果使用 WebJobs API 修改 settings.job，需要下载网站的发布配置文件，获取用户名和密码。\r\n\r\n![publishfile](./media/aog-app-service-web-webjobs-howto-update-the-schedule/publishfile.PNG)\r\n\r\n## 解决方案\r\n\r\n### 方案一：通过 Kudu 修改 settings.job 文件。\r\n\r\n使用以下 URL: `https://<site_name>.scm.chinacloudsites.cn` 登录到 Kudu 。\r\n\r\n导航到：`D:\\home\\site\\wwwroot\\app_data\\jobs\\triggered\\<job_name>\\bin\\Debug>` , 找到 settings.job 文件。\r\n\r\n修改 settings.job 中的 CRON 表达式， 例如：若要每 15 分钟触发一次 WebJobs，可以改为：\r\n\r\n```json\r\n{\r\n    \"schedule\": \"0 */15 * * * *\"\r\n}\r\n```\r\n\r\n截图如下：\r\n\r\n![schedule1.PNG](./media/aog-app-service-web-webjobs-howto-update-the-schedule/schedule.PNG)\r\n\r\n### 方案二： 通过调用 WebJobs API 修改 settings.job 配置。\r\n\r\n该方案可以有多种方式去实现，这里主要包含了三种方法去调用 WebJobs API.\r\n\r\n#### 方法1. 使用 C# 调用 WebJobs API , 代码如下：\r\n\r\n```C#\r\nHttpClient client = new HttpClient();\r\n// 从网站发布配置文件中获取用户名和密码。\r\nvar byteArray = Encoding.ASCII.GetBytes(\"<username>:<password>\");\r\nclient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Basic\", Convert.ToBase64String(byteArray));\r\nvar content = new StringContent(\"{\\\"schedule\\\": \\\"0 */50 * * * *\\\"}\", Encoding.UTF8, \"application/json\");\r\n// 使用 Put 方法调用 API。\r\nvar response = await client.PutAsync(\"https://<site_name>.scm.chinacloudsites.cn/api/triggeredwebjobs/<job_name>/settings\", content);\r\n```\r\n\r\n#### 方法2. 使用 Postman 调用 WebJobs API 。\r\n\r\nURL：`https://<username>:<password>@<site_name>.scm.chinacloudsites.cn/api/triggeredwebjobs/<job_name>/settings`\r\n\r\n截图如下：\r\n\r\n![postman](./media/aog-app-service-web-webjobs-howto-update-the-schedule/postmanwebjob.PNG)\r\n\r\n#### 方法3. 使用 Windows PowerShell 调用 WebJobs API , 代码如下：\r\n\r\n```PowerShell\r\nPS C:\\Users\\dillion> $username = \"`<username>\"\r\nPS C:\\Users\\dillion> $password = \"<password>\"\r\nPS C:\\Users\\dillion> $base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes((\"{0}:{1}\" -f $username ,$password)))\r\nPS C:\\Users\\dillion> $contentType='application/json'\r\nPS C:\\Users\\dillion> $data= @{schedule='0 */30 * * * *'}\r\nPS C:\\Users\\dillion> $body = $data | ConvertTo-JSON\r\nPS C:\\Users\\dillion> $apiUrl = \"https://<site_name>.scm.chinacloudsites.cn/api/triggeredwebjobs/<job_name>/settings\"\r\nPS C:\\Users\\dillion> Invoke-RestMethod -Uri $apiUrl -Headers @{Authorization=(\"Basic {0}\" -f $base64AuthInfo)} -Method Put -Body $body -ContentType $contentType\r\n```\r\n\r\n![powershell](./media/aog-app-service-web-webjobs-howto-update-the-schedule/powershell.PNG)\r\n\r\n修改后可以使用 Kudu 查看修改后的结果。\r\n\r\n## 参考文档\r\n\r\n- [创建的 WebJobs 无法按照 CRON 的设置来启动](https://docs.azure.cn/articles/azure-operations-guide/app-service-web/aog-web-apps-qa-webjob-cron-boot-error)\r\n- [Web Job API](https://github.com/projectkudu/kudu/wiki/WebJobs-API)"}