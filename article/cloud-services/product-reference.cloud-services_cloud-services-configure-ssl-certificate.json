{"Title":"为云服务配置 SSL（经典）","Description":"了解如何为 Web 角色指定 HTTPS 终结点以及如何上传 SSL 证书来保护应用程序。","Content":"# <a name=\"configuring-ssl-for-an-application-in-azure\"></a>在 Azure 中为应用程序配置 SSL\r\n\r\n> [!div class=\"op_single_selector\"]\r\n>- [Azure 门户](./cloud-services-configure-ssl-certificate-portal.md)\r\n>- [Azure 经典管理门户](./cloud-services-configure-ssl-certificate.md)\r\n> \r\n> \r\n\r\n安全套接字层 (SSL) 加密是用于保护通过 Internet 发送的数据的最常见方法。 此常见任务讨论了如何为 Web 角色指定 HTTPS 终结点以及如何上传 SSL 证书来保护应用程序。\r\n\r\n> [!NOTE]\r\n> 本任务中的过程适用于 Azure 云服务；对于应用服务，请参阅[此文章](../app-service/app-service-web-tutorial-custom-ssl.md)。\r\n> \r\n> \r\n\r\n此任务使用生产部署。 本主题的末尾提供了有关如何使用过渡部署的信息。\r\n\r\n如果尚未创建云服务，请首先阅读[此文章](cloud-services-how-to-create-deploy.md)。\r\n\r\n## <a name=\"step-1-get-an-ssl-certificate\"></a>步骤 1：获取 SSL 证书\r\n\r\n若要为应用程序配置 SSL，首先需要获取已由证书颁发机构 (CA)（出于此目的颁发证书的受信任的第三方）签署的 SSL 证书。如果尚未获取 SSL 证书，需要从销售 SSL 证书的公司购买一个 SSL 证书。\r\n\r\n该证书必须满足 Azure 中的以下 SSL 证书要求：\r\n\r\n-   证书必须包含私钥。\r\n-   必须为密钥交换创建证书，并且该证书可导出到个人信息交换 (.pfx) 文件。\r\n-   证书的使用者名称必须与用于访问云服务的域匹配。 无法从证书颁发机构 (CA) 处获取针对 chinacloudapp.cn 域的 SSL 证书。 必须获取在访问服务时要使用的自定义域名。 从 CA 处请求证书时，该证书的使用者名称必须与用于访问应用程序的自定义域名匹配。 例如，如果自定义域名为 contoso.com，则将要从 CA 请求用于 *.contoso.com 或 www.contoso.com 的证书。\r\n-   该证书必须使用至少 2048 位加密。\r\n\r\n出于测试目的，可以[创建](./cloud-services-certs-create.md)和使用自签名的证书。 自签名证书不通过 CA 进行身份验证，并且可以使用 chinacloudapp.cn 域作为网站 URL。 例如，以下任务使用公用名 (CN) 为 sslexample.chinacloudapp.cn 的自签名证书。\r\n\r\n接下来，必须在服务定义和服务配置文件中包含有关此证书的信息。\r\n\r\n## <a name=\"step-2-modify-the-service-definition-and-configuration-files\"></a> 步骤 2：修改服务定义和配置文件\r\n\r\n必须将应用程序配置为使用该证书，并且必须添加 HTTPS 终结点。 因此，需要更新服务定义和服务配置文件。\r\n\r\n1.  在开发环境中，打开服务定义文件 (CSDEF)，在 WebRole 部分中添加“证书”部分，并包含以下关于证书（和中间证书）的信息：\r\n\r\n    ```xml\r\n    <WebRole name=\"CertificateTesting\" vmsize=\"Small\">\r\n    ...\r\n        <Certificates>\r\n            <Certificate name=\"SampleCertificate\" \r\n                         storeLocation=\"LocalMachine\" \r\n                         storeName=\"My\"\r\n                         permissionLevel=\"limitedOrElevated\" />\r\n            <!-- IMPORTANT! Unless your certificate is either\r\n            self-signed or signed directly by the CA root, you\r\n            must include all the intermediate certificates\r\n            here. You must list them here, even if they are\r\n            not bound to any endpoints. Failing to list any of\r\n            the intermediate certificates may cause hard-to-reproduce\r\n            interoperability problems on some clients.-->\r\n            <Certificate name=\"CAForSampleCertificate\"\r\n                         storeLocation=\"LocalMachine\"\r\n                         storeName=\"CA\"\r\n                         permissionLevel=\"limitedOrElevated\" />\r\n        </Certificates>\r\n    ...\r\n    </WebRole>\r\n    ```\r\n\r\n    **Certificates** 节定义了证书的名称、位置及其所在存储的名称。\r\n\r\n    权限（`permisionLevel` 属性）可以设置为下列值之一：\r\n\r\n    | 权限值 | 说明 |\r\n    | ----------------  | ----------- |\r\n    | limitedOrElevated | （默认）所有角色进程都可以访问该私钥。 |\r\n    | 提升的          | 仅提升的进程可以访问该私钥。|\r\n\r\n2.  在服务定义文件中，在“终结点”部分中添加 InputEndpoint 元素以启用 HTTPS：\r\n\r\n    ```xml\r\n    <WebRole name=\"CertificateTesting\" vmsize=\"Small\">\r\n    ...\r\n        <Endpoints>\r\n            <InputEndpoint name=\"HttpsIn\" protocol=\"https\" port=\"443\" \r\n                certificate=\"SampleCertificate\" />\r\n        </Endpoints>\r\n    ...\r\n    </WebRole>\r\n    ```\r\n\r\n3.  在服务定义文件中，在“站点”部分中添加 Binding 元素。 此节添加 HTTPS 绑定以将终结点映射到网站：\r\n\r\n    ```xml\r\n    <WebRole name=\"CertificateTesting\" vmsize=\"Small\">\r\n    ...\r\n        <Sites>\r\n            <Site name=\"Web\">\r\n                <Bindings>\r\n                    <Binding name=\"HttpsIn\" endpointName=\"HttpsIn\" />\r\n                </Bindings>\r\n            </Site>\r\n        </Sites>\r\n    ...\r\n    </WebRole>\r\n    ```\r\n\r\n    对服务定义文件进行的所有必需更改已完成，但还需要将证书信息添加到服务配置文件中。\r\n\r\n4.  在服务配置文件 (CSCFG) ServiceConfiguration.Cloud.cscfg 中，在“角色”部分中添加“证书”部分，并将下面显示的示例指纹值替换为证书的指纹值：\r\n\r\n    ```xml\r\n    <Role name=\"Deployment\">\r\n    ...\r\n        <Certificates>\r\n            <Certificate name=\"SampleCertificate\" \r\n                thumbprint=\"9427befa18ec6865a9ebdc79d4c38de50e6316ff\" \r\n                thumbprintAlgorithm=\"sha1\" />\r\n            <Certificate name=\"CAForSampleCertificate\"\r\n                thumbprint=\"79d4c38de50e6316ff9427befa18ec6865a9ebdc\" \r\n                thumbprintAlgorithm=\"sha1\" />\r\n        </Certificates>\r\n    ...\r\n    </Role>\r\n    ```\r\n\r\n（以上示例将 sha1 用于指纹算法。 请为证书的指纹算法指定相应值。）\r\n\r\n现在已更新服务定义和服务配置文件，请打包部署以上传到 Azure。 如果使用 cspack，请勿使用 /generateConfigurationFile 标志，否则会覆盖插入的证书信息。\r\n\r\n## <a name=\"step-3-upload-a-certificate\"></a>步骤 3：上传证书\r\n\r\n已将部署包更新为使用此证书，并且已添加 HTTPS 终结点。 现在可以使用 Azure 经典门户将包和证书上传到 Azure。\r\n\r\n1. 登录到 [Azure 经典管理门户][]。 \r\n2. 在左侧导航窗格中单击“**云服务**”。\r\n3. 单击所需的云服务。\r\n4. 单击“证书”选项卡。\r\n\r\n    ![单击“证书”选项卡](./media/cloud-services-configure-ssl-certificate/click-cert.png)  \r\n\r\n5. 单击“上传”按钮  。\r\n\r\n    ![上传](./media/cloud-services-configure-ssl-certificate/upload-button.png)\r\n\r\n6. 提供“文件”、“密码”，然后单击“完成”（复选标记）。\r\n\r\n## <a name=\"step-4-connect-to-the-role-instance-by-using-https\"></a>步骤 4：使用 HTTPS 连接到角色实例\r\n\r\n在 Azure 中启动并运行部署后，便可以使用 HTTPS 连接到该部署。\r\n\r\n1.  在 Azure 经典管理门户中选择你的部署，然后单击“站点 URL”下的链接。\r\n\r\n    ![确定网站 URL][2]\r\n\r\n2. 在 Web 浏览器中，修改链接以使用 https 而不是 http，然后访问该页。\r\n\r\n    >[!NOTE]\r\n    > 如果使用自签名证书，浏览到与自签名证书关联的 HTTPS 终结点时，浏览器中可能会显示一个证书错误。 使用由受信任证书颁发机构签名的证书可消除此问题；同时，你可以忽略此错误。 （也可以将自签名证书添加到用户的受信任证书颁发机构证书存储中。）\r\n    > \r\n    > \r\n    \r\n    ![SSL 示例网站][3]  \r\n\r\n要对过渡部署而非生产部署使用 SSL，首先需要确定用于过渡部署的 URL。 将云服务部署到过渡环境，而不包括证书或任何证书信息。 部署完成后，可确定基于 GUID 的 URL，此 URL 将在 Azure 经典管理门户的“站点 URL”字段中列出。 使用与基于 GUID 的 URL（例如 **32818777-6e77-4ced-a8fc-57609d404462.cloudapp.net**）等同的公用名 (CN) 创建证书。 使用 Azure 经典门户将证书添加到过渡云服务。 然后，将证书信息添加到 CSDEF 和 CSCFG 文件，重新打包应用程序，并更新过渡部署以使用新的程序包。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n* [云服务的常规配置](./cloud-services-how-to-configure.md)。\r\n* 了解如何[部署云服务](./cloud-services-how-to-create-deploy.md)。\r\n* 配置[自定义域名](./cloud-services-custom-domain-name.md)。\r\n* [管理云服务](./cloud-services-how-to-manage.md)。\r\n\r\n  [Azure 经典管理门户]: http://manage.windowsazure.cn\r\n  [0]: ./media/cloud-services-configure-ssl-certificate/CreateCloudService.png\r\n  [1]: ./media/cloud-services-configure-ssl-certificate/AddCertificate.png\r\n  [2]: ./media/cloud-services-configure-ssl-certificate/CopyURL.png\r\n  [3]: ./media/cloud-services-configure-ssl-certificate/SSLCloudService.png\r\n  [4]: ./media/cloud-services-configure-ssl-certificate/AddCertificateComplete.png\r\n\r\n\r\n<!--Update_Description:update meta properties and wording-->"}