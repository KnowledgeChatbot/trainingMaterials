{"Title":"对无法启动的角色进行故障排除","Description":"以下是云服务角色无法启动的一些常见原因。 此外还提供了这些问题的解决方案。","Content":"# <a name=\"troubleshoot-cloud-service-roles-that-fail-to-start\"></a>对无法启动的云服务角色进行故障排除\r\n\r\n以下是一些与无法启动的 Azure 云服务角色相关的常见问题和解决方案。\r\n\r\n[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]\r\n\r\n## <a name=\"missing-dlls-or-dependencies\"></a>缺少 DLL 或依赖项\r\n\r\nDLL 或程序集缺失可能导致出现不响应的角色以及在“正在初始化”、“忙”和“正在停止”状态之间循环的角色。\r\n\r\nDLL 或程序集缺失的症状可能为：\r\n\r\n- 角色实例的状态在“正在初始化”、“忙”、“正在停止”之间循环。\r\n- 角色实例已转为“就绪”状态，但导航到 Web 应用程序后未显示相应页面。\r\n\r\n若要调查这些问题，可采用几种推荐的方法。\r\n\r\n## <a name=\"diagnose-missing-dll-issues-in-a-web-role\"></a>在 Web 角色中诊断缺失 DLL 的问题\r\n\r\n如果导航到 Web 角色中部署的网站，且浏览器显示类似于下面的服务器错误，可能指示 DLL 缺失。\r\n\r\n!['/' 应用程序中出现服务器错误。](./media/cloud-services-troubleshoot-roles-that-fail-start/ic503388.png)\r\n\r\n## <a name=\"diagnose-issues-by-turning-off-custom-errors\"></a>通过关闭自定义错误来诊断问题\r\n\r\n可通过配置 Web 角色的 web.config，将自定义错误模式设置为“关闭”并重新部署服务，来查看更完整的错误信息。\r\n\r\n若要在不使用远程桌面的情况下查看更完整的错误，请执行以下操作：\r\n\r\n1. 在 Microsoft Visual Studio 中打开解决方案。\r\n\r\n2. 在“**解决方案资源管理器**”中，找到 web.config 文件并打开。\r\n\r\n3. 在 web.config 文件中，找到 system.web 部分并添加以下行：\r\n\r\n    ```xml\r\n    <customErrors mode=\"Off\" />\r\n    ```\r\n\r\n4. 保存文件。\r\n\r\n5. 重新打包并重新部署服务。\r\n\r\n重新部署服务后，会看到错误消息，其中包含缺失的程序集或 DLL 的名称。\r\n\r\n## <a name=\"diagnose-issues-by-viewing-the-error-remotely\"></a>通过远程查看错误来诊断问题\r\n\r\n可使用远程桌面来访问角色并远程查看更完整的错误信息。通过以下步骤使用远程桌面来查看错误：\r\n\r\n1. 确保安装了 Azure SDK 1.3 或更高版本。\r\n\r\n2. 在使用 Visual Studio 部署解决方案的过程中，选择“配置远程桌面连接...”。 有关配置远程桌面连接的详细信息，请参阅[将远程桌面与 Azure 角色一起使用](../vs-azure-tools-remote-desktop-roles.md)。\r\n\r\n3. 在 Azure 经典管理门户中，实例显示“就绪”状态后，请单击其中一个角色实例。\r\n\r\n4. 在功能区的“远程访问”区域中单击“连接”图标。\r\n\r\n5. 使用在远程桌面配置期间指定的凭据登录到虚拟机。\r\n\r\n6. 打开命令窗口。\r\n\r\n7. 键入 `IPconfig`。\r\n\r\n8. 记录 IPV4 地址值。\r\n\r\n9. 打开 Internet Explorer。\r\n\r\n10. 键入 Web 应用程序的地址和名称。例如，`http://<IPV4 Address>/default.aspx`。\r\n\r\n现在，导航到网站返回更明确的错误消息：\r\n\r\n* '/' 应用程序中出现服务器错误。\r\n\r\n* 说明：执行当前 Web 请求期间，出现未处理的异常。请检查堆栈跟踪信息，以了解有关该错误以及代码中导致错误的出处的详细信息。\r\n\r\n* 异常详细信息：System.IO.FIleNotFoundException：未能加载文件或程序集“Microsoft.WindowsAzure.StorageClient, Version=1.1.0.0, Culture=neutral, PublicKeyToken=31bf856ad364e35”或它的某一个依赖项。系统找不到指定的文件。\r\n\r\n例如：\r\n\r\n!['/' 应用程序中出现显式服务器错误](./media/cloud-services-troubleshoot-roles-that-fail-start/ic503389.png)\r\n\r\n## <a name=\"diagnose-issues-by-using-the-compute-emulator\"></a>使用计算模拟器诊断问题\r\n\r\n可以使用 Azure 计算模拟器来诊断并解决缺失依赖项和出现 web.config 错误的问题。\r\n\r\n为了在使用此诊断方法时获得最佳结果，应使用包含 Windows 的干净安装的计算机或虚拟机。 若要以最佳效果模拟 Azure 环境，请使用 Windows Server 2008 R2 x64。\r\n\r\n1. 安装独立版本的 [Azure SDK](https://www.azure.cn/downloads)\r\n\r\n2. 在开发计算机上生成云服务项目。\r\n\r\n3. 在 Windows 资源管理器中，导航到云服务项目的 bin\\debug 文件夹。\r\n\r\n4. 将 .csx 文件夹和 .cscfg 文件复制到用于调试问题的计算机。\r\n\r\n5. 在干净的计算机上打开 Azure SDK 命令提示符窗口并键入 `csrun.exe /devstore:start`。\r\n\r\n6. 在命令提示符处，键入 `run csrun <path to .csx folder> <path to .cscfg file> /launchBrowser`。\r\n\r\n7. 角色启动后，会在 Internet Explorer 中看到详细的错误信息。还可使用标准的 Windows 故障排除工具来进一步诊断问题。\r\n\r\n## <a name=\"diagnose-issues-by-using-intellitrace\"></a>使用 IntelliTrace 诊断问题\r\n对于使用 .NET Framework 4 的辅助角色和 Web 角色，可以使用 Microsoft Visual Studio Enterprise 中提供的 [IntelliTrace](https://msdn.microsoft.com/library/dd264915.aspx)。\r\n\r\n请按照以下步骤操作来部署启用了 IntelliTrace 的服务：\r\n\r\n1. 确认已安装 Azure SDK 1.3 或更高版本。\r\n\r\n2. 使用 Visual Studio 部署解决方案。在部署期间，请选中“为 .NET 4 角色启用 IntelliTrace”复选框。\r\n\r\n3. 实例启动后，打开“服务器资源管理器”。\r\n\r\n4. 展开“Azure\\\\Cloud Services”节点并查找部署。\r\n\r\n5. 展开部署，直至看到角色实例。右键单击其中一个实例。\r\n\r\n6. 选择“查看 IntelliTrace 日志”。此时会打开“IntelliTrace 摘要”。\r\n\r\n7. 查找摘要的异常部分。 如果存在异常，则会将该部分标记为“**异常数据**”。\r\n\r\n8. 展开“异常数据”并查找类似如下内容的 System.IO.FileNotFoundException 错误：\r\n\r\n    ![异常数据、缺少文件或程序集](./media/cloud-services-troubleshoot-roles-that-fail-start/ic503390.png)\r\n\r\n## <a name=\"address-missing-dlls-and-assemblies\"></a>解决缺失 DLL 和程序集的问题\r\n\r\n若要纠正丢失 DLL 和程序集错误，请按照以下步骤进行操作：\r\n\r\n1. 在 Visual Studio 中打开解决方案。\r\n\r\n2. 在“解决方案资源管理器”中，打开 References 文件夹。\r\n\r\n3. 单击错误中标识的程序集。\r\n\r\n4. 在“属性”窗格中，找到“复制本地属性”并将值设置为“True”。\r\n\r\n5. 重新部署云服务。\r\n\r\n确认所有错误均已更正后，可以在不选中“为 .NET 4 角色启用 IntelliTrace”复选框的情况下部署服务。\r\n\r\n\r\n\r\n<!--Update_Description:update meta properties and wording-->"}