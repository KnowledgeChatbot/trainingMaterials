{"Title":"将云服务连接到自定义域控制器","Description":"了解如何使用 Powershell 和 AD 域扩展将 Web/辅助角色连接到自定义 AD 域","Content":"# <a name=\"connecting-azure-cloud-services-roles-to-a-custom-ad-domain-controller-hosted-in-azure\"></a>将 Azure 云服务角色连接到 Azure 中托管的自定义 AD 域控制器\r\n我们先在 Azure 中设置一个虚拟网络 (VNet)。 然后将 Active Directory 域控制器（托管在 Azure 虚拟机上）添加到该 VNet。 接下来，将现有云服务角色添加预先创建的 VNet，然后将它们连接到域控制器。\r\n\r\n在开始之前，请特别注意以下几点：\r\n\r\n1. 本教程使用 Powershell，因此请确保已安装 Azure Powershell 并已准备就绪。有关设置 Azure Powershell 的帮助，请参阅[如何安装和配置 Azure PowerShell](../powershell-install-configure.md)。\r\n\r\n2. AD 域控制器和 Web/辅助角色实例需要在 VNET 中。\r\n\r\n请遵循以下分步指南。如果遇到任何问题，请在本文末尾留言。 我们将回复你（没错，我们真的会阅读留言）。\r\n\r\n由云服务引用的网络必须为**经典虚拟网络**。\r\n\r\n## <a name=\"create-a-virtual-network\"></a>创建虚拟网络\r\n可以使用 Azure 门户或 PowerShell 在 Azure 中创建虚拟网络。 本教程将使用 PowerShell。 若要使用 Azure 门户创建虚拟网络，请参阅[创建虚拟网络](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)。\r\n\r\n```powershell\r\n#Create Virtual Network\r\n\r\n$vnetStr =\r\n@\"<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<NetworkConfiguration xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration\">\r\n  <VirtualNetworkConfiguration>\r\n    <VirtualNetworkSites>\r\n      <VirtualNetworkSite name=\"[your-vnet-name]\" Location=\"China North\">\r\n        <AddressSpace>\r\n          <AddressPrefix>[your-address-prefix]</AddressPrefix>\r\n        </AddressSpace>\r\n        <Subnets>\r\n          <Subnet name=\"[your-subnet-name]\">\r\n            <AddressPrefix>[your-subnet-range]</AddressPrefix>\r\n          </Subnet>\r\n        </Subnets>\r\n      </VirtualNetworkSite>\r\n    </VirtualNetworkSites>\r\n  </VirtualNetworkConfiguration>\r\n</NetworkConfiguration>\r\n\"@;\r\n\r\n$vnetConfigPath = \"<path-to-vnet-config>\"\r\nSet-AzureVNetConfig -ConfigurationPath $vnetConfigPath\r\n```\r\n\r\n## <a name=\"create-a-virtual-machine\"></a>创建虚拟机\r\n\r\n完成虚拟网络的设置后，需要创建 AD 域控制器。 在本教程中，我们会在 Azure 虚拟机上设置 AD 域控制器。\r\n\r\n为此，请在 PowerShell 中使用以下命令创建虚拟机：\r\n\r\n```powershell\r\n# Initialize variables\r\n# VNet and subnet must be classic virtual network resources, not Azure Resource Manager resources.\r\n\r\n$vnetname = '<your-vnet-name>'\r\n$subnetname = '<your-subnet-name>'\r\n$vmsvc1 = '<your-hosted-service>'\r\n$vm1 = '<your-vm-name>'\r\n$username = '<your-username>'\r\n$password = '<your-password>'\r\n$affgrp = '<your- affgrp>'\r\n\r\n# Create a VM and add it to the Virtual Network\r\n\r\nNew-AzureQuickVM -Windows -ServiceName $vmsvc1 -Name $vm1 -ImageName $imgname -AdminUsername $username -Password $password -AffinityGroup $affgrp -SubnetNames $subnetname -VNetName $vnetname\r\n```\r\n\r\n## <a name=\"promote-your-virtual-machine-to-a-domain-controller\"></a>将虚拟机提升为域控制器\r\n要将虚拟机配置为 AD 域控制器，需要登录 VM 并对其进行配置。\r\n\r\n若要登录 VM，你可以通过 PowerShell 获取 RDP 文件；请使用以下命令：\r\n\r\n```powershell\r\n# Get RDP file\r\nGet-AzureRemoteDesktopFile -ServiceName $vmsvc1 -Name $vm1 -LocalPath <rdp-file-path>\r\n```\r\n\r\n登录 VM 后，请根据[如何设置客户 AD 域控制器](http://social.technet.microsoft.com/wiki/contents/articles/12370.windows-server-2012-set-up-your-first-domain-controller-step-by-step.aspx)中的分步指导，将虚拟机设置为 AD 域控制器。\r\n\r\n## <a name=\"add-your-cloud-service-to-the-virtual-network\"></a>将云服务添加到虚拟网络\r\n接下来，需要将云服务部署添加到新的 VNet。 为此，请使用 Visual Studio 或选择的编辑器将相关节添加到 cscfg，以修改云服务 cscfg。\r\n\r\n```xml\r\n<ServiceConfiguration serviceName=\"[hosted-service-name]\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceConfiguration\" osFamily=\"[os-family]\" osVersion=\"*\">\r\n    <Role name=\"[role-name]\">\r\n    <Instances count=\"[number-of-instances]\" />\r\n  </Role>\r\n  <NetworkConfiguration>\r\n\r\n    <!--optional-->\r\n    <Dns>\r\n      <DnsServers><DnsServer name=\"[dns-server-name]\" IPAddress=\"[ip-address]\" /></DnsServers>\r\n    </Dns>\r\n    <!--optional-->\r\n\r\n<!--VNet settings\r\n    VNet and subnet must be classic virtual network resources, not Azure Resource Manager resources.-->\r\n<VirtualNetworkSite name=\"[virtual-network-name]\" />\r\n<AddressAssignments>\r\n    <InstanceAddress roleName=\"[role-name]\">\r\n    <Subnets>\r\n        <Subnet name=\"[subnet-name]\" />\r\n    </Subnets>\r\n    </InstanceAddress>\r\n</AddressAssignments>\r\n<!--VNet settings-->\r\n\r\n  </NetworkConfiguration>\r\n</ServiceConfiguration>\r\n```\r\n\r\n接下来，请生成云服务项目并将它部署到 Azure。 有关将云服务包部署到 Azure 的帮助，请参阅[如何创建和部署云服务](cloud-services-how-to-create-deploy-portal.md)\r\n\r\n## <a name=\"connect-your-webworker-roles-to-the-domain\"></a>将 Web/辅助角色连接到域\r\n在 Azure 上部署云服务项目后，请使用 AD 域扩展将角色实例连接到自定义 AD 域。 若要将 AD 域扩展添加到现有云服务部署并加入自定义域，请在 PowerShell 中执行以下命令：\r\n\r\n```powershell\r\n# Initialize domain variables\r\n$domain = '<your-domain-name>'\r\n$dmuser = '$domain<your-username>'\r\n$dmpswd = '<your-domain-password>'\r\n$dmspwd = ConvertTo-SecureString $dmpswd -AsPlainText -Force\r\n$dmcred = New-Object System.Management.Automation.PSCredential ($dmuser, $dmspwd)\r\n\r\n# Add AD Domain Extension to the cloud service roles\r\nSet-AzureServiceADDomainExtension -Service <your-cloud-service-hosted-service-name> -Role <your-role-name> -Slot <staging-or-production> -DomainName $domain -Credential $dmcred -JoinOption 35\r\n```\r\n\r\n这就是所有的操作。\r\n\r\n云服务现在应已加入自定义域控制器。如果想要详细了解可用于配置 AD 域扩展的其他选项，请如下所示使用 PowerShell 帮助。\r\n\r\n```powershell\r\nhelp Set-AzureServiceADDomainExtension\r\nhelp New-AzureServiceADDomainExtensionConfig\r\n```\r\n\r\n<!--Update_Description:update meta properties and wording-->"}