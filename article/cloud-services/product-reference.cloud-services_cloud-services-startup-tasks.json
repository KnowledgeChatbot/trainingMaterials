{"Title":"在 Azure 云服务中运行启动任务","Description":"启动任务可帮助为你的应用准备云服务环境。这将讲授启动任务的工作方式以及如何生成启动任务","Content":"\r\n# 如何配置和运行云服务的启动任务\r\n\r\n角色启动之前，可以使用启动任务执行操作。可能需要执行的操作包括安装组件、注册 COM 组件、设置注册表项或启动长时间运行的进程。\r\n\r\n>[!NOTE]\r\n> 启动任务不适用于虚拟机，只适用于云服务 Web 角色和辅助角色。\r\n\r\n## 启动任务的工作方式\r\n\r\n启动任务是在角色开始之前执行的操作，并在 [ServiceDefinition.csdef] 文件中定义（通过使用 [Startup] 元素内的 [Task] 元素）。启动任务通常是批处理文件，但它们也可以是控制台应用程序或启动 PowerShell 脚本的批处理文件。\r\n\r\n环境变量将信息传递给启动任务，而本地存储可用于从启动任务中传出信息。例如，环境变量可以指定要安装的程序的路径，并可以将文件写入到本地存储，然后角色可以稍后读取这些文件。\r\n\r\n启动任务可以将信息和错误记录到 **TEMP** 环境变量指定的目录。启动任务期间，在云中运行时，**TEMP** 环境变量将解析为 *C:\\\\Resources\\\\temp\\\\[guid].[rolename]\\\\RoleTemp* 目录。\r\n\r\n此外，启动任务还可以在重新启动之间执行多次。例如，每次角色回收时都会运行启动任务，但角色回收可能并非始终包括重新启动。应以这样的方式编写启动任务：使其能够多次运行而不会出现问题。\r\n\r\n启动任务必须以为零的 **errorlevel**（或退出代码）结束，才能完成启动过程。如果启动任务以非零的 **errorlevel** 结束，则角色将不会启动。\r\n\r\n## 角色启动顺序\r\n\r\n下面列出了 Azure 中的角色启动过程：\r\n\r\n1. 实例将标记为“正在启动”并且不接收流量。\r\n\r\n2. 所有启动任务均根据其 **taskType** 属性执行。\r\n    - **simple** 任务以同步方式执行（一次一个任务）。\r\n    - **background** 和 **foreground** 任务与启动任务并行，以异步方式启动。\r\n\r\n    > [!WARNING]\r\n    > 在启动过程中的启动任务阶段，IIS 可能未完全配置，因此角色特定的数据可能不可用。需要角色特定的数据的启动任务应使用 [Microsoft.WindowsAzure.ServiceRuntime.RoleEntryPoint.OnStart](https://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx)。\r\n\r\n3. 将启动角色主机进程并在 IIS 中创建站点。\r\n\r\n4. 将调用 [Microsoft.WindowsAzure.ServiceRuntime.RoleEntryPoint.OnStart](https://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) 方法。\r\n\r\n5. 实例将标记为“准备就绪”，并且流量将路由到实例。\r\n\r\n6. 将调用 [Microsoft.WindowsAzure.ServiceRuntime.RoleEntryPoint.Run](https://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) 方法。\r\n\r\n## 启动任务的示例\r\n\r\n启动任务在 [ServiceDefinition.csdef] 文件的 **Task** 元素中定义。**commandLine** 属性指定启动批处理文件或控制台命令的名称和参数，**executionContext** 属性指定启动任务的权限级别，**taskType** 属性指定将如何执行该任务。\r\n\r\n在此示例中，将为启动任务创建环境变量 **MyVersionNumber**，并将该变量设为值“**1.0.0.0**”。\r\n\r\n**ServiceDefinition.csdef**：\r\n\r\n```xml\r\n    <Startup>\r\n        <Task commandLine=\"Startup.cmd\" executionContext=\"limited\" taskType=\"simple\" >\r\n            <Environment>\r\n                <Variable name=\"MyVersionNumber\" value=\"1.0.0.0\" />\r\n            </Environment>\r\n        </Task>\r\n    </Startup>\r\n```\r\n\r\n在下面的示例中，**Startup.cmd** 批处理文件会将行“当前版本是 1.0.0.0”写入到由 TEMP 环境变量指定的目录下的 StartupLog.txt 文件中。`EXIT /B 0` 行确保启动任务以为零的 **errorlevel** 结尾。\r\n\r\n```cmd\r\n    ECHO The current version is %MyVersionNumber% >> \"%TEMP%\\StartupLog.txt\" 2>&1\r\n    EXIT /B 0\r\n```\r\n\r\n> [!NOTE]\r\n> 在 Visual Studio 中，启动批处理文件的“复制到输出目录”属性应设为“始终复制”，以确保将启动批处理文件正确地部署到 Azure 上的项目（对于 Web 角色，为 **approot\\\\bin**；对于辅助角色，为 **approot**）。\r\n\r\n## 任务属性的说明\r\n\r\n下面介绍 [ServiceDefinition.csdef] 文件中的 **Task** 元素的属性：\r\n\r\n**commandLine** - 为启动任务指定命令行：\r\n\r\n- 该命令具有可选的命令行参数，用于开始启动任务。\r\n- 通常它是 .cmd 或 .bat 批处理文件的文件名。\r\n- 该任务相对于部署的 AppRoot\\\\Bin 文件夹。在确定任务的路径和文件时不扩展环境变量。如果需要环境扩展，则可以创建用于调用启动任务的小型 .cmd 脚本。\r\n- 可以是一个启动 [PowerShell 脚本](./cloud-services-startup-tasks-common.md#create-a-powershell-startup-task)的控制台应用程序或批处理文件。\r\n\r\n**executionContext** - 为启动任务指定权限级别。权限级别可以为 limited 或 elevated：\r\n\r\n- **limited**  \r\n启动任务以与角色相同的权限运行。当 [Runtime] 元素的 **executionContext** 属性也是 **limited** 时，则使用用户权限。\r\n\r\n- **elevated**  \r\n启动任务以管理员特权运行。这将允许启动任务安装程序、更改 IIS 配置、执行注册表更改和其他管理员级别任务，而不会提高角色本身的权限级别。\r\n\r\n> [!NOTE]\r\n> 启动任务的权限级别不需要与角色本身相同。\r\n\r\n**taskType** - 指定启动任务的执行方式。\r\n\r\n- **simple**  \r\n任务按照 [ServiceDefinition.csdef] 文件中指定的顺序一次一个地以同步方式执行。当一个 **simple** 启动任务以为零的 **errorlevel** 结束时，将执行下一个 **simple** 启动任务。如果没有更多 **simple** 启动任务要执行，则将启动角色本身。   \r\n\r\n    > [!NOTE]\r\n    > 如果 **simple** 任务以非零 **errorlevel** 结束，则将阻止该实例。后续 **simple** 启动任务和角色本身将不会启动。\r\n\r\n    若要确保批处理文件以为零的 **errorlevel** 结束，请在批处理文件进程结束时执行命令 `EXIT /B 0`。\r\n\r\n- **background**  \r\n任务与角色同时启动，并以异步方式执行。\r\n\r\n- **foreground**  \r\n任务与角色同时启动，并以异步方式执行。**foreground** 任务与 **background** 任务之间的主要区别在于 **foreground** 任务阻止角色回收或关闭，直到任务结束。**background** 任务没有此限制。\r\n\r\n## 环境变量\r\n\r\n环境变量是一种将信息传递给启动任务的方法。例如，可以放置一个 blob 的路径，该 blob 包含要安装的程序或角色将使用的端口号，或用于控制启动任务的功能的设置。\r\n\r\n启动任务有两种类型的环境变量；静态环境变量和基于 [RoleEnvironment] 类成员的环境变量。这两种环境变量都在 [ServiceDefinition.csdef] 文件的 [Environment] 节中，并且都使用 [Variable] 元素和 **name** 属性。\r\n\r\n静态环境变量使用 [Variable] 元素的 **value** 属性。上面的示例创建了环境变量 **MyVersionNumber**，该变量具有静态值 **1.0.0.0**。另一个示例就是创建 **StagingOrProduction** 环境变量，你可以手动将该变量设置为值 **staging** 或 **production**，以根据 **StagingOrProduction** 环境变量的值执行不同的启动操作。\r\n\r\n基于 RoleEnvironment 类成员的环境变量不使用 [Variable] 元素的 **value** 属性。而是使用具有相应 **XPath** 属性值的 [RoleInstanceValue] 子元素，创建基于 [RoleEnvironment] 类的特定成员的环境变量。用于访问各种 [RoleEnvironment] 值的 **XPath** 属性的值可以在[此处](./cloud-services-role-config-xpath.md)找到。\r\n\r\n例如，若要创建这样一个环境变量（当实例在计算模拟器中运行时为**“true”**，在云中运行时为**“false”**），请使用以下 [Variable] 和 [RoleInstanceValue] 元素：\r\n\r\n```xml\r\n    <Startup>\r\n        <Task commandLine=\"Startup.cmd\" executionContext=\"limited\" taskType=\"simple\">\r\n            <Environment>\r\n\r\n                <!-- Create the environment variable that informs the startup task whether it is running\r\n                    in the Compute Emulator or in the cloud. \"%ComputeEmulatorRunning%\"==\"true\" when\r\n                    running in the Compute Emulator, \"%ComputeEmulatorRunning%\"==\"false\" when running\r\n                    in the cloud. -->\r\n\r\n                <Variable name=\"ComputeEmulatorRunning\">\r\n                    <RoleInstanceValue xpath=\"/RoleEnvironment/Deployment/@emulated\" />\r\n                </Variable>\r\n\r\n            </Environment>\r\n        </Task>\r\n    </Startup>\r\n```\r\n\r\n## 后续步骤\r\n了解如何使用云服务执行一些[常见的启动任务](./cloud-services-startup-tasks-common.md)。\r\n\r\n[打包](./cloud-services-model-and-package.md)你的云服务。\r\n\r\n[ServiceDefinition.csdef]: ./cloud-services-model-and-package.md#csdef\r\n[Task]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#Task\r\n[Startup]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#Startup\r\n[Runtime]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#Runtime\r\n[Environment]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#Environment\r\n[Variable]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#Variable\r\n[RoleInstanceValue]: https://msdn.microsoft.com/zh-cn/library/azure/gg557552.aspx#RoleInstanceValue\r\n[RoleEnvironment]: https://msdn.microsoft.com/zh-cn/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.aspx\r\n\r\n<!---HONumber=Mooncake_Quality_Review_1202_2016-->"}