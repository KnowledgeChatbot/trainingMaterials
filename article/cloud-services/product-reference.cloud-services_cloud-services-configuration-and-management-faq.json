{"Title":"Azure 云服务的配置和管理常见问题解答","Description":"本文列出有关 Microsoft Azure 云服务的配置和管理的常见问题。","Content":"# <a name=\"configuration-and-management-issues-for-azure-cloud-services-frequently-asked-questions-faqs\"></a>Azure 云服务的配置和管理问题：常见问题解答 (FAQ)\r\n\r\n本文包含有关 [Azure 云服务](/cloud-services/)的配置和管理的常见问题。 还可以参阅[云服务 VM 大小页面](./cloud-services-sizes-specs.md)，了解大小信息。\r\n\r\n[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]\r\n\r\n## <a name=\"how-do-i-add-nosniff-to-my-website\"></a>如何将“nosniff”添加到网站？\r\n若要防止客户端探查 MIME 类型，请在 *web.config* 文件中添加设置。\r\n\r\n```xml\r\n<configuration>\r\n   <system.webServer>\r\n      <httpProtocol>\r\n         <customHeaders>\r\n            <add name=\"X-Content-Type-Options\" value=\"nosniff\" />\r\n         </customHeaders>\r\n      </httpProtocol>\r\n   </system.webServer>\r\n</configuration>\r\n```\r\n\r\n也可以将此项作为 IIS 中的设置添加。 使用[常见启动任务](./cloud-services-startup-tasks-common.md#configure-iis-startup-with-appcmdexe)一文中的以下命令。\r\n\r\n```cmd\r\n%windir%\\system32\\inetsrv\\appcmd set config /section:httpProtocol /+customHeaders.[name='X-Content-Type-Options',value='nosniff']\r\n```\r\n\r\n## <a name=\"how-do-i-customize-iis-for-a-web-role\"></a>如何自定义 Web 角色的 IIS\r\n使用[常见启动任务](./cloud-services-startup-tasks-common.md#configure-iis-startup-with-appcmdexe)一文中的 IIS 启动脚本。\r\n\r\n## <a name=\"i-cannot-scale-beyond-x-instances\"></a>无法扩展到 X 个实例以上\r\nAzure 订阅对可以使用的内核数存在限制。 如果已使用所有可用的内核，缩放无法执行。 例如，如果限制为 100 个核心，这意味着云服务可以有大小为 100 A1 的虚拟机实例或大小为 50 A2 的虚拟机实例。\r\n\r\n## <a name=\"how-can-i-implement-role-based-access-for-cloud-services\"></a>如何为云服务实现基于角色的访问？\r\n云服务不支持基于角色的访问控制 (RBAC) 模型，因为它不是基于 Azure Resource Manager 的服务。\r\n\r\n请参阅 [Azure RBAC 与经典订阅管理员](../active-directory/role-based-access-control-what-is.md#azure-rbac-vs-classic-subscription-administrators)。\r\n\r\n## <a name=\"how-do-i-set-the-idle-timeout-for-azure-load-balancer\"></a>如何为 Azure 负载均衡器设置空闲超时？\r\n可以在服务定义 (csdef) 文件中指定超时，如下所示：\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<ServiceDefinition name=\"mgVS2015Worker\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition\" schemaVersion=\"2015-04.2.6\">\r\n  <WorkerRole name=\"WorkerRole1\" vmsize=\"Small\">\r\n    <ConfigurationSettings>\r\n      <Setting name=\"Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString\" />\r\n    </ConfigurationSettings>\r\n    <Imports>\r\n      <Import moduleName=\"RemoteAccess\" />\r\n      <Import moduleName=\"RemoteForwarder\" />\r\n    </Imports>\r\n    <Endpoints>\r\n      <InputEndpoint name=\"Endpoint1\" protocol=\"tcp\" port=\"10100\"   idleTimeoutInMinutes=\"30\" />\r\n    </Endpoints>\r\n  </WorkerRole>\r\n```\r\n有关详细信息，请参阅[新功能：Azure 负载均衡器的可配置空闲超时](https://azure.microsoft.com/blog/new-configurable-idle-timeout-for-azure-load-balancer/)。\r\n\r\n## <a name=\"can-microsoft-internal-engineers-rdp-to-cloud-service-instances-without-permission\"></a>无需权限的 Microsoft 内部工程师是否可以通过 RDP 连接到云服务实例？\r\nMicrosoft 遵循严格的流程，在没有云服务所有者或其受托人的书面许可（电子邮件或其他书面通讯）的情况下，内部工程师不可以通过 RDP 连接到该云服务。\r\n\r\n## <a name=\"why-is-the-certificate-chain-of-my-cloud-service-ssl-certificate-incomplete\"></a>云服务 SSL 证书的证书链为何不完整？\r\n我们建议客户安装完整的证书链（叶证书、中间证书和根证书），而不要只安装叶证书。 如果只是安装叶证书，则要依赖 Windows 通过遍历 CTL 来构建证书链。 当 Windows 尝试验证证书时，如果 Azure 或 Windows 更新中发生间歇性网络问题或 DNS 问题，可能会将该证书视为无效。 如果安装完整的证书链，则可避免此问题。 \r\n\r\n## <a name=\"how-do-i-associate-a-static-ip-address-to-my-cloud-service\"></a>如何将静态 IP 地址关联到云服务？\r\n若要设置静态 IP 地址，需要创建保留 IP。 此保留 IP 可关联到新的云服务或现有的部署。 请参阅以下文档了解详细信息：\r\n* [如何创建保留 IP 地址](../virtual-network/virtual-networks-reserved-public-ip.md#manage-reserved-vips)\r\n* [保留现有云服务的 IP 地址](../virtual-network/virtual-networks-reserved-public-ip.md#reserve-the-ip-address-of-an-existing-cloud-service)\r\n* [将保留 IP 关联到新的云服务](../virtual-network/virtual-networks-reserved-public-ip.md#associate-a-reserved-ip-to-a-new-cloud-service)\r\n* [将保留 IP 关联到正在运行的部署](../virtual-network/virtual-networks-reserved-public-ip.md#associate-a-reserved-ip-to-a-running-deployment)\r\n* [使用服务配置文件将保留 IP 关联到云服务](../virtual-network/virtual-networks-reserved-public-ip.md#associate-a-reserved-ip-to-a-cloud-service-by-using-a-service-configuration-file)\r\n\r\n## <a name=\"why-does-the-drive-on-my-cloud-service-vm-show-very-little-free-disk-space\"></a>为何云服务 VM 上的驱动器显示可用磁盘空间极少？\r\n这是预期的行为，不会导致应用程序出现任何问题。 为 Azure PaaS VM 中的 %uproot% 驱动器启用了日记，因此，占用的空间量在实际上是文件平时占用的空间量的两倍。 但是，有几个因素会在本质上消除此状态造成的问题。\r\n\r\n%approot% 的大小计算为 <.cspkg 大小 + 最大日记大小 + 富余的可用空间> 或 1.5 GB，以较大者为准。 VM 大小对于计算结果没有任何影响。 （VM 大小只会影响临时 C: 驱动器的大小。） \r\n\r\n不支持写入 %approot% 驱动器。 如果要写入 Azure VM，必须在临时 LocalStorage 资源中执行此操作（或使用其他选项，例如 Blob 存储、Azure 文件，等等）。 因此，%approot% 文件夹的可用空间量没有意义。 如果不确定应用程序是否写入 %approot% 驱动器，始终可以让服务运行数日，然后比较“之前”和“之后”的大小。 \r\n\r\nAzure 不会将任何数据写入 %approot% 驱动器。 从 .cspkg 创建 VHD 并将其装载到 Azure VM 之后，就只有你的应用程序可能会写入此驱动器。 \r\n\r\n日记设置不可配置，因此无法将其禁用。\r\n\r\n## <a name=\"what-are-the-features-and-capabilities-that-azure-basic-ipsids-and-ddos-provides\"></a>Azure 基本 IPS/IDS 和 DDOS 提供哪些特性和功能？\r\nAzure 在数据中心物理服务器上使用 IPS/IDS 来抵御威胁。 此外，客户可以部署第三方安全解决方案，例如 Web 应用程序防火墙、网络防火墙、反恶意软件、入侵检测、防护系统 (IDS/IPS)，等等。 有关详细信息，请参阅[保护数据和资产并遵守全局安全标准](https://www.microsoft.com/en-us/trustcenter/Security/AzureSecurity)。\r\n\r\nMicrosoft 会持续监视服务器、网络和应用程序以检测威胁。 Azure 的全方位威胁管理方法使用入侵检测、分布式拒绝服务 (DDoS) 攻击防护、渗透测试、行为分析、异常检测和机器学习来不断增强其防御能力并降低风险。 适用于 Azure 的 Microsoft 反恶意软件可保护 Azure 云服务和虚拟机。 此外，你可以选择部署第三方安全解决方案，例如 Web 应用程序防火墙、网络防火墙、反恶意软件、入侵检测和防护系统 (IDS/IPS)，等等。\r\n\r\n## <a name=\"why-does-iis-stop-writing-to-the-log-directory\"></a>IIS 为何阻止写入日志目录？\r\n与写入日志目录相关的本地存储配额已用完。 若要解决此问题，可采取以下三种措施之一：\r\n* 为 IIS 启用诊断，并定期将诊断信息移到 Blob 存储。\r\n* 从日志目录中手动删除日志文件。\r\n* 提高本地资源的配额限制。\r\n\r\n有关详细信息，请参阅以下文档：\r\n* [在 Azure 存储中存储和查看诊断数据](./cloud-services-dotnet-diagnostics-storage.md)\r\n* [IIS 日志阻止在云服务中写入](https://blogs.msdn.microsoft.com/cie/2013/12/21/iis-logs-stops-writing-in-cloud-service/)\r\n\r\n## <a name=\"what-is-the-purpose-of-the-windows-azure-tools-encryption-certificate-for-extensions\"></a>“Windows Azure Tools Encryption Certificate for Extensions”的用途是什么？\r\n每当向云服务添加扩展时，就会自动创建这些证书。 在大多数情况下，这是 WAD 扩展或 RDP 扩展，但也可能是其他扩展，例如反恶意软件或日志收集器扩展。 这些证书仅用于加密和解密扩展的专用配置。 系统永远不会检查过期日期，因此，证书是否已过期并不重要。 \r\n\r\n可以忽略这些证书。 如果想要清理证书，可以尝试删除所有证书。 如果你尝试删除正在使用的证书，Azure 将引发错误。\r\n\r\n## <a name=\"how-can-i-generate-a-certificate-signing-request-csr-without-rdp-ing-in-to-the-instance\"></a>如何在不通过 RDP 连接到实例的情况下生成证书签名请求 (CSR)？\r\n请参阅以下指导文档：\r\n\r\n>[获取用于 Windows Azure 网站 (WAWS) 的证书](https://azure.microsoft.com/blog/obtaining-a-certificate-for-use-with-windows-azure-web-sites-waws/)\r\n\r\n请注意，CSR 只是一个文本文件。 不一定要在最终使用该证书的计算机上创建 CSR。 尽管本文档是针对应用服务编写的，但 CSR 创建过程是通用的，同样适用于云服务。\r\n\r\n## <a name=\"how-can-i-add-an-antimalware-extension-for-my-cloud-services-in-an-automated-way\"></a>如何以自动化方法为云服务添加反恶意软件扩展？\r\n\r\n可在启动任务中使用 PowerShell 脚本启用反恶意软件扩展。 请遵循以下文章中的步骤实现此目的： \r\n \r\n- [创建 PowerShell 启动任务](cloud-services-startup-tasks-common.md#create-a-powershell-startup-task)\r\n- [Set-AzureServiceAntimalwareExtension](https://docs.microsoft.com/powershell/module/Azure/Set-AzureServiceAntimalwareExtension?view=azuresmps-4.0.0 )\r\n\r\n有关反恶意软件部署方案以及如何在门户中启用此类方案的详细信息，请参阅[反恶意软件部署方案](../security/azure-security-antimalware.md)。\r\n\r\n## <a name=\"how-to-enable-server-name-indication-sni-for-cloud-services\"></a>如何为云服务启用服务器名称指示 (SNI)？\r\n\r\n可使用以下方法之一在云服务中启用 SNI：\r\n\r\n### <a name=\"method-1-use-powershell\"></a>方法 1：使用 PowerShell\r\n\r\n可在启动任务中使用 PowerShell cmdlet **New-WebBinding** 为云服务角色实例配置 SNI 绑定，如下所示：\r\n    \r\n    New-WebBinding -Name $WebsiteName -Protocol \"https\" -Port 443 -IPAddress $IPAddress -HostHeader $HostHeader -SslFlags $sslFlags \r\n    \r\n如[此文](https://technet.microsoft.com/library/ee790567.aspx)所述，$sslFlags 可为以下值之一：\r\n\r\n|值|含义|\r\n------|------\r\n|0|没有 SNI|\r\n|1|已启用 SNI |\r\n|2 |使用中心证书存储的非 SNI 绑定|\r\n|3|使用中心证书存储的 SNI 绑定 |\r\n \r\n### <a name=\"method-2-use-code\"></a>方法 2：使用代码\r\n\r\n也可以根据此[博客文章](https://blogs.msdn.microsoft.com/jianwu/2014/12/17/expose-ssl-service-to-multi-domains-from-the-same-cloud-service/)中所述，通过角色启动中的代码配置 SNI 绑定：\r\n\r\n    \r\n    //<code snip> \r\n                    var serverManager = new ServerManager(); \r\n                    var site = serverManager.Sites[0]; \r\n                    var binding = site.Bindings.Add(“:443:www.test1.com”, newCert.GetCertHash(), “My”); \r\n                    binding.SetAttributeValue(“sslFlags”, 1); //enables the SNI \r\n                    serverManager.CommitChanges(); \r\n    //</code snip> \r\n    \r\n使用上述任一方法时，必须先使用启动任务或通过代码在角色实例上安装特定主机名的相应证书 (*.pfx)，这样才能使 SNI 绑定生效。\r\n\r\n## <a name=\"how-can-i-add-tags-to-my-azure-cloud-service\"></a>如何将标记添加到 Azure 云服务？ \r\n\r\n云服务是一个经典资源。 只有通过 Azure 资源管理器创建的资源才支持标记。 无法将标记应用到云服务等经典资源。 \r\n\r\n## <a name=\"what-are-the-upcoming-cloud-service-capabilities-in-the-azure-portal-which-can-help-manage-and-monitor-applications\"></a>Azure 门户中即将推出的可帮助管理和监视应用程序的云服务功能是什么？\r\n\r\n* 即将推出为远程桌面协议 (RDP) 生成新证书的功能。 或者，可运行以下脚本：\r\n\r\n```powershell\r\n$cert = New-SelfSignedCertificate -DnsName yourdomain.cloudapp.net -CertStoreLocation \"cert:\\LocalMachine\\My\" -KeyLength 20 48 -KeySpec \"KeyExchange\"\r\n$password = ConvertTo-SecureString -String \"your-password\" -Force -AsPlainText\r\nExport-PfxCertificate -Cert $cert -FilePath \".\\my-cert-file.pfx\" -Password $password\r\n```\r\n* 选择 blob 或本地作为 csdef 和 cscfg 上传位置的功能即将推出。 使用 [New-AzureDeployment](https://docs.microsoft.com/en-us/powershell/module/azure/new-azuredeployment?view=azuresmps-4.0.0)，可以设置每个位置值。\r\n* 能够监视实例级别的指标。 其他监视功能在[如何监视云服务](cloud-services-how-to-monitor.md)中提供。\r\n\r\n\r\n## <a name=\"how-to-enable-http2-on-cloud-services-vm\"></a>如何在云服务 VM 上启用 HTTP/2？\r\n\r\nWindows 10 和 Windows Server 2016 随附了对客户端和服务器端上的 HTTP/2 的支持。 如果客户端（浏览器）通过 TLS（通过 TLS 扩展协商 HTTP/2）连接到 IIS 服务器，则不需要在服务器端进行任何更改。 这是因为，默认情况下会通过 TLS 来发送指定使用 HTTP/2 的 h2-14 标头。 如果在另一方面，客户端要发送升级标头以升级到 HTTP/2，则需要在服务器端进行以下更改，确保能够正常进行升级，并最终建立 HTTP/2 连接。 \r\n\r\n1. 运行 regedit.exe。\r\n2. 浏览到注册表项：HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\HTTP\\Parameters。\r\n3. 创建名为 **DuoEnabled** 的新 DWORD 值。\r\n4. 将其值设置为 1。\r\n5. 重启服务器。\r\n6. 转到“默认网站”，在“绑定”下，使用刚刚创建的自签名证书创建新的 TLS 绑定。 \r\n\r\n有关详细信息，请参阅：\r\n\r\n- [IIS 上的 HTTP/2](https://blogs.iis.net/davidso/http2)\r\n         \r\n\r\n请注意，可通过启动任务自动完成上述步骤，这样，每次创建新的 PaaS 实例后，都可以在系统注册表中执行上述更改。 有关详细信息，请参阅[如何配置和运行云服务的启动任务](cloud-services-startup-tasks.md)。\r\n\r\n \r\n完成此过程后，可使用以下方法之一验证是否已启用 HTTP/2：\r\n\r\n- 在 IIS 日志中启用协议版本，并查看 IIS 日志。 日志中会显示 HTTP/2。 \r\n- 在 Internet Explorer/Edge 中启用 F12 开发人员工具，并切换到“网络”选项卡来验证协议。 \r\n\r\n有关详细信息，请参阅 [IIS 上的 HTTP/2](https://blogs.iis.net/davidso/http2)。\r\n\r\n<!--Update_Description: add the section of feature to manage and monitor applications-->"}