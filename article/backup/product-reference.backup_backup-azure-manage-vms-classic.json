{"Title":"管理和监视 Azure 虚拟机备份","Description":"了解如何管理和监视 Azure 虚拟机备份","Content":"# <a name=\"manage-common-azure-backup-jobs-and-trigger-alerts-in-the-classic-management-portal\"></a>在经典管理门户中管理常见的 Azure 备份作业和触发器警报\r\n> [!div class=\"op_single_selector\"]\r\n> * [管理 Azure VM 备份](backup-azure-manage-vms.md)\r\n> * [管理经典 VM 备份](backup-azure-manage-vms-classic.md)\r\n>\r\n>\r\n\r\n本文针对在 Azure 中受保护的经典模型虚拟机介绍了几种常见的管理和监视任务。  \r\n\r\n> [!NOTE]\r\n> Azure 有两种用于创建和使用资源的部署模型： [Resource Manager 部署模型和经典部署模型](../azure-resource-manager/resource-manager-deployment-model.md)。 有关使用经典部署模型 VM 的详细信息，请参阅[准备好环境以备份 Azure 虚拟机](backup-azure-vms-prepare.md)。\r\n>\r\n> [!IMPORTANT]\r\n>从 2017 年 3 月开始，无法再使用经典管理门户来创建备份保管库。\r\n>\r\n> 现在可将备份保管库升级到恢复服务保管库。 有关详细信息，请参阅文章[将备份保管库升级到恢复服务保管库](backup-azure-upgrade-backup-to-recovery-services.md)。 Microsoft 鼓励将备份保管库升级到恢复服务保管库。<br/> 2017 年 11 月 30 日之后，将无法使用 PowerShell 创建备份保管库。 在 2017 年 11 月 30 日之前：\r\n>- 其余所有备份保管库都将自动升级到恢复服务保管库。\r\n>- 无法在经典管理门户中访问备份数据。 应使用 Azure 门户在恢复服务保管库中访问备份数据。\r\n\r\n## <a name=\"manage-protected-virtual-machines\"></a>管理受保护的虚拟机\r\n若要管理受保护的虚拟机，请执行以下操作：\r\n\r\n1. 若要查看和管理某个虚拟机的备份设置，请单击“受保护的项”  选项卡。\r\n2. 单击受保护项的名称可以查看“备份详细信息”选项卡，其中显示了有关上次备份的信息  。\r\n\r\n    ![虚拟机备份](./media/backup-azure-manage-vms/backup-vmdetails.png)\r\n3. 若要查看和管理某个虚拟机的备份策略设置，请单击“策略”选项卡。\r\n\r\n    ![虚拟机策略](./media/backup-azure-manage-vms/manage-policy-settings.png)\r\n\r\n    “备份策略”  选项卡会显示现有策略。 可以根据需要进行更改。 如果需要创建新策略，请在“策略”页上单击“创建”。 请注意，如果要删除某个策略，则它不应当具有与之关联的任何虚拟机。\r\n\r\n    ![虚拟机策略](./media/backup-azure-manage-vms/backup-vmpolicy.png)\r\n4. 可以在“作业”  页上获取有关虚拟机的操作或状态的更多信息。 单击列表中的某个作业可获取更多详细信息，还可以筛选特定虚拟机的作业。\r\n\r\n    ![作业](./media/backup-azure-manage-vms/backup-job.png)\r\n\r\n## <a name=\"on-demand-backup-of-a-virtual-machine\"></a>虚拟机的按需备份\r\n为虚拟机配置保护后，可以对它执行按需备份。 如果虚拟机的初始备份已挂起，则按需备份会在 Azure 备份保管库中创建虚拟机的完整副本。 如果已完成第一个备份，按需备份只会以前备份的更改发送到 Azure 备份保管库，即始终进行增量备份。\r\n\r\n> [!NOTE]\r\n> 按需备份的保留期范围设置为保留期值，该值在备份策略中根据 VM 针对“每日”保留期来指定。  \r\n>\r\n>\r\n\r\n若要执行虚拟机的按需备份，请执行以下操作：\r\n\r\n1. 导航到“受保护的项”页，选择“Azure 虚拟机”作为“类型”（如果尚未选择），然后单击“选择”按钮。\r\n\r\n    ![VM 类型](./media/backup-azure-manage-vms/vm-type.png)\r\n2. 选择用户要进行按需备份的虚拟机，并单击页底部的“立即备份”按钮  。\r\n\r\n    ![立即备份](./media/backup-azure-manage-vms/backup-now.png)\r\n\r\n    这会在选定的虚拟机上创建备份作业。 通过此作业创建的恢复点保留范围与在虚拟机关联的策略中指定的保留范围相同。\r\n\r\n    ![创建备份作业](./media/backup-azure-manage-vms/creating-job.png)\r\n\r\n   > [!NOTE]\r\n   > 若要查看与虚拟机关联的策略，请向下钻取到“受保护的项”页中的虚拟机，然后转到“备份策略”选项卡。\r\n   >\r\n   >\r\n3. 创建作业后，可以单击 Toast 栏中的“查看作业”按钮，以在“作业”页中查看相应的作业  。\r\n\r\n    ![已创建备份作业](./media/backup-azure-manage-vms/created-job.png)\r\n4. 成功完成作业后，即会创建可用来还原虚拟机的恢复点。 这还会使“受保护的项”页中的恢复点列值递增 1  。\r\n\r\n## <a name=\"stop-protecting-virtual-machines\"></a>停止保护虚拟机\r\n可以使用以下选项来选择停止虚拟机的将来备份：\r\n\r\n- 保留 Azure 备份保管库中与虚拟机关联的备份数据\r\n- 删除与虚拟机关联的备份数据\r\n\r\n如果已选择保留与虚拟机关联的备份数据，则可使用该备份数据来还原虚拟机。 有关此类虚拟机的定价详细信息，请单击[此处](https://www.azure.cn/pricing/details/backup/)。\r\n\r\n若要停止保护虚拟机，请执行以下操作：\r\n\r\n1. 导航到“受保护的项”页，选择“Azure 虚拟机”作为筛选类型（如果尚未选择），然后单击“选择”按钮。\r\n\r\n    ![VM 类型](./media/backup-azure-manage-vms/vm-type.png)\r\n2. 选择虚拟机，并单击页底部的“停止保护”  。\r\n\r\n    ![停止保护](./media/backup-azure-manage-vms/stop-protection.png)\r\n3. 默认情况下，Azure 备份不会删除与虚拟机关联的备份数据。\r\n\r\n    ![确认停止保护](./media/backup-azure-manage-vms/confirm-stop-protection.png)\r\n\r\n    如果要删除备份数据，请选中该复选框。\r\n\r\n    ![复选框](./media/backup-azure-manage-vms/checkbox.png)\r\n\r\n    请选择停止备份的理由。 尽管理由是选填的，但提供理由可帮助 Azure 备份处理反馈，并根据客户的情况设置处理优先级。\r\n4. 单击“提交”按钮提交“停止保护”作业。 单击“查看作业”，在“作业”页中查看相应的作业。\r\n\r\n    ![停止保护](./media/backup-azure-manage-vms/stop-protect-success.png)\r\n\r\n    如果尚未在“停止保护”向导中选择“删除关联的备份数据”选项，则在作业完成后，保护状态将更改为“已停止保护”。 数据会使用 Azure 备份保留，直到被显式删除。 随时都可通过在“受保护的项”页中选择虚拟机，然后单击“删除”来删除数据。\r\n\r\n    ![已停止保护](./media/backup-azure-manage-vms/protection-stopped-status.png)\r\n\r\n    如果已选择“删除关联的备份数据”选项，则虚拟机不会出现在“受保护的项”页中。\r\n\r\n## <a name=\"re-protect-virtual-machine\"></a>重新保护虚拟机\r\n如果尚未在“停止保护”中选择“删除关联的备份数据”选项，可以通过遵循类似于备份已注册虚拟机的步骤，重新保护虚拟机。 受保护后，此虚拟机会在停止保护之前保留备份数据，并在重新保护后创建恢复点。\r\n\r\n重新保护后，如果有“停止保护”之前的恢复点，则虚拟机的保护状态将更改为“受保护”。\r\n\r\n  ![重新保护 VM](./media/backup-azure-manage-vms/reprotected-status.png)\r\n\r\n> [!NOTE]\r\n> 重新保护虚拟机时，可以选择一个不同的策略，而不是最初用于保护虚拟机的策略。\r\n>\r\n>\r\n\r\n## <a name=\"unregister-virtual-machines\"></a>取消注册虚拟机\r\n如果想要从备份保管库中删除虚拟机，请执行以下操作：\r\n\r\n1. 单击页底部的“取消注册”按钮  。\r\n\r\n    ![禁用保护](./media/backup-azure-manage-vms/unregister-button.png)\r\n\r\n    屏幕底部会显示要求进行确认的 Toast 通知。 单击“是”继续  。\r\n\r\n    ![禁用保护](./media/backup-azure-manage-vms/confirm-unregister.png)\r\n\r\n## <a name=\"delete-backup-data\"></a>删除备份数据\r\n可以通过以下方法之一删除与虚拟机关联的备份数据：\r\n\r\n- 在停止保护作业期间\r\n- 在虚拟机上完成停止保护作业之后\r\n\r\n对于在成功完成“停止备份”作业后处于“已停止保护”状态的虚拟机，若要删除其上的备份数据，请执行以下操作：\r\n\r\n1. 导航到“受保护的项”页，选择“Azure 虚拟机”作为类型，然后单击“选择”按钮。\r\n\r\n    ![VM 类型](./media/backup-azure-manage-vms/vm-type.png)\r\n2. 选择虚拟机。 虚拟机会显示为“**已停止保护**”状态。\r\n\r\n    ![已停止保护](./media/backup-azure-manage-vms/protection-stopped-b.png)\r\n3. 单击页底部的“删除”按钮。\r\n\r\n    ![删除备份](./media/backup-azure-manage-vms/delete-backup.png)\r\n4. 在“删除备份数据”向导中，选择删除备份数据的原因（强烈建议），然后单击“提交”。\r\n\r\n    ![删除备份数据](./media/backup-azure-manage-vms/delete-backup-data.png)\r\n5. 这将创建一个作业，用于删除选定虚拟机的备份数据。 单击“查看作业”，在“作业”页中查看相应的作业。\r\n\r\n    ![已成功删除数据](./media/backup-azure-manage-vms/delete-data-success.png)\r\n\r\n    完成该作业后，与虚拟机对应的条目将从“受保护的项”页中删除。\r\n\r\n## <a name=\"dashboard\"></a>仪表板\r\n在“仪表板”页中，可以查看有关 Azure 虚拟机、其存储和过去 24 小时内关联作业的信息  。 可以查看备份状态和任何关联的备份错误。\r\n\r\n![仪表板](./media/backup-azure-manage-vms/dashboard-protectedvms.png)\r\n\r\n> [!NOTE]\r\n> 仪表板中的值每 24 小时刷新一次。\r\n>\r\n>\r\n\r\n## <a name=\"auditing-operations\"></a>审核操作\r\n可以通过 Azure 备份来查看客户触发的备份操作的“操作日志”，因此可以轻松地确切了解针对备份保管库执行了哪些管理操作。 通过操作日志，可以针对备份操作进行很好的事后总结和审核。\r\n\r\n操作日志中记录了以下操作：\r\n\r\n- 注册\r\n- Unregister\r\n- 配置保护\r\n- 备份（按计划备份以及通过 BackupNow 按需备份）\r\n- 还原\r\n- 停止保护\r\n- 删除备份数据\r\n- 添加策略\r\n- 删除策略\r\n- 更新策略\r\n- 取消作业\r\n\r\n若要查看某个备份保管库的相应操作日志，请执行以下操作：\r\n\r\n1. 导航到 Azure 门户中的“管理服务”，然后单击“操作日志”选项卡。\r\n\r\n    ![操作日志](./media/backup-azure-manage-vms/ops-logs.png)\r\n2. 在筛选器中选择“备份”作为“类型”，在“服务名称”中指定备份保管库名称，然后单击“提交”。\r\n\r\n    ![操作日志筛选器](./media/backup-azure-manage-vms/ops-logs-filter.png)\r\n3. 在操作日志中，选择任意操作，然后单击“详细信息”查看与操作相对应的详细信息。\r\n\r\n    ![操作日志提取详细信息](./media/backup-azure-manage-vms/ops-logs-details.png)\r\n\r\n    “详细信息向导”包含与触发的操作、作业 ID、触发此操作时所在的资源以及操作启动时间相关的信息。\r\n\r\n    ![操作详细信息](./media/backup-azure-manage-vms/ops-logs-details-window.png)\r\n\r\n## <a name=\"alert-notifications\"></a>警报通知\r\n可以获取门户中作业的自定义警报通知。 为此，需要针对操作日志事件定义基于 PowerShell 的警报规则。 我们建议使用 *PowerShell 1.3.0 或更高版本*。\r\n\r\n若要定义自定义通知以便在备份失败时发出警报，可使用如下所示的示例命令：\r\n\r\n```\r\nPS C:\\> $actionEmail = New-AzureRmAlertRuleEmail -CustomEmail contoso@microsoft.com\r\nPS C:\\> Add-AzureRmLogAlertRule -Name backupFailedAlert -Location \"China East\" -ResourceGroup RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-China-East -OperationName Microsoft.Backup/backupVault/Backup -Status Failed -TargetResourceId /subscriptions/86eeac34-eth9a-4de3-84db-7a27d121967e/resourceGroups/RecoveryServices-DP2RCXUGWS3MLJF4LKPI3A3OMJ2DI4SRJK6HIJH22HFIHZVVELRQ-China-East/providers/microsoft.backupbvtd2/BackupVault/trinadhVault -Actions $actionEmail\r\n```\r\n\r\n**ResourceId**：可以从“操作日志”弹出窗口中获取此项，如以上部分所述。 操作的详细信息弹出窗口中的 ResourceUri 是要针对此 cmdlet 提交的 ResourceId。\r\n\r\nOperationName：采用“Microsoft.Backup/backupvault/<EventName>”格式，其中，EventName 的值为 Register、Unregister、ConfigureProtection、Backup、Restore、StopProtection、DeleteBackupData、CreateProtectionPolicy、DeleteProtectionPolicy、UpdateProtectionPolicy 中的一个\r\n\r\n**Status**：支持的值包括 Started、Succeeded 和 Failed。\r\n\r\n**ResourceGroup**：触发操作时所在的资源的 ResourceGroup。 可以从 ResourceId 值获取此项。 ResourceId 值中字段“/resourceGroups/”与字段“/providers/”之间的值是 ResourceGroup 的值。\r\n\r\n**Name**：警报规则的名称。\r\n\r\n**CustomEmail**：指定要向其发送警报通知的自定义电子邮件地址\r\n\r\n**SendToServiceOwners**：此选项会将警报通知发送给订阅的所有管理员和共同管理员。 可以在 **New-AzureRmAlertRuleEmail** cmdlet 中使用\r\n\r\n### <a name=\"limitations-on-alerts\"></a>对警报的限制\r\n基于事件的警报会受到以下限制：\r\n\r\n1. 警报在备份保管库的所有虚拟机上触发。 不能通过自定义来获取备份保管库中特定虚拟机集的警报。\r\n2. 此功能以预览版提供。 [了解详细信息](../monitoring-and-diagnostics/insights-powershell-samples.md)\r\n3. 用户将收到来自“alerts-noreply@mail.windowsazure.cn”的警报。 目前无法修改电子邮件发件人。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n- [还原 Azure VM](backup-azure-restore-vms.md)\r\n\r\n<!--Update_Description: wording update -->\r\n"}