{"Title":"通过 PowerShell 为 Azure VM 部署和管理备份","Description":"了解如何使用 PowerShell 部署和管理 Azure 备份。","Content":"# <a name=\"use-azurermbackup-cmdlets-to-back-up-virtual-machines\"></a>使用 AzureRM.Backup cmdlet 备份虚拟机\r\n> [!div class=\"op_single_selector\"]\r\n> * [Resource Manager](backup-azure-vms-automation.md)\r\n> * [经典](backup-azure-vms-classic-automation.md)\r\n>\r\n>\r\n\r\n本文演示如何使用 Azure PowerShell 来备份和恢复 Azure VM。 Azure 具有用于创建和处理资源的两个不同的部署模型：Resource Manager 和经典。 本文介绍如何使用经典部署模型将数据备份到备份保管库。 如果尚未在订阅中创建备份保管库，请参阅[使用 AzureRM.RecoveryServices.Backup cmdlet 备份虚拟机](backup-azure-vms-automation.md)一文中的 Resource Manager 版本。 Microsoft 建议大多数新部署使用 Resource Manager 模型。\r\n\r\n> [!IMPORTANT]\r\n> 现在可将备份保管库升级到恢复服务保管库。 有关详细信息，请参阅文章[将备份保管库升级到恢复服务保管库](backup-azure-upgrade-backup-to-recovery-services.md)。 Microsoft 鼓励将备份保管库升级到恢复服务保管库。<br/> 2017 年 11 月 30 日之后，将无法使用 PowerShell 创建备份保管库。<br/> 在 2017 年 11 月 30 日之前：\r\n>- 其余所有备份保管库都将自动升级到恢复服务保管库。\r\n>- 无法在经典管理门户中访问备份数据。 应使用 Azure 门户在恢复服务保管库中访问备份数据。\r\n>\r\n\r\n## <a name=\"concepts\"></a>概念\r\n本文专门介绍用于备份虚拟机的 PowerShell cmdlet。 有关如何保护 Azure VM 的介绍，请参阅[在 Azure 中计划 VM 备份基础结构](backup-azure-vms-introduction.md)。\r\n\r\n> [!NOTE]\r\n> 在开始之前，请阅读使用 Azure 备份所需的[先决条件](backup-azure-vms-prepare.md)，以及当前 VM 备份解决方案的[限制](backup-azure-vms-prepare.md#limitations-when-backing-up-and-restoring-a-vm)。\r\n>\r\n>\r\n\r\n为了提高 PowerShell 使用效率，请抽时间了解对象的层次结构以及从何处开始。\r\n\r\n![对象层次结构](./media/backup-azure-vms-classic-automation/object-hierarchy.png)\r\n\r\n两大流程包括启用对 VM 的保护，以及从恢复点还原数据。 本文的重点是帮助你熟练使用这两项方案所需的 PowerShell cmdlet。\r\n\r\n## <a name=\"setup-and-registration\"></a>设置和注册\r\n开始时，请执行以下操作：\r\n\r\n1. [下载最新的 PowerShell](https://github.com/Azure/azure-powershell/releases)（要求的最低版本：1.0.0）\r\n2. 键入以下命令查找可用的 Azure 备份 PowerShell cmdlet：\r\n\r\n```\r\nPS C:\\> Get-Command *azurermbackup*\r\n\r\nCommandType     Name                                               Version    Source\r\n-----------     ----                                               -------    ------\r\nCmdlet          Backup-AzureRmBackupItem                           1.0.1      AzureRM.Backup\r\nCmdlet          Disable-AzureRmBackupProtection                    1.0.1      AzureRM.Backup\r\nCmdlet          Enable-AzureRmBackupContainerReregistration        1.0.1      AzureRM.Backup\r\nCmdlet          Enable-AzureRmBackupProtection                     1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupContainer                         1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupItem                              1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupJob                               1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupJobDetails                        1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupProtectionPolicy                  1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupRecoveryPoint                     1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupVault                             1.0.1      AzureRM.Backup\r\nCmdlet          Get-AzureRmBackupVaultCredentials                  1.0.1      AzureRM.Backup\r\nCmdlet          New-AzureRmBackupProtectionPolicy                  1.0.1      AzureRM.Backup\r\nCmdlet          New-AzureRmBackupRetentionPolicyObject             1.0.1      AzureRM.Backup\r\nCmdlet          New-AzureRmBackupVault                             1.0.1      AzureRM.Backup\r\nCmdlet          Register-AzureRmBackupContainer                    1.0.1      AzureRM.Backup\r\nCmdlet          Remove-AzureRmBackupProtectionPolicy               1.0.1      AzureRM.Backup\r\nCmdlet          Remove-AzureRmBackupVault                          1.0.1      AzureRM.Backup\r\nCmdlet          Restore-AzureRmBackupItem                          1.0.1      AzureRM.Backup\r\nCmdlet          Set-AzureRmBackupProtectionPolicy                  1.0.1      AzureRM.Backup\r\nCmdlet          Set-AzureRmBackupVault                             1.0.1      AzureRM.Backup\r\nCmdlet          Stop-AzureRmBackupJob                              1.0.1      AzureRM.Backup\r\nCmdlet          Unregister-AzureRmBackupContainer                  1.0.1      AzureRM.Backup\r\nCmdlet          Wait-AzureRmBackupJob                              1.0.1      AzureRM.Backup\r\n```\r\n\r\n使用 PowerShell 可以自动化以下设置和注册任务：\r\n\r\n- 创建备份保管库\r\n- 将 VM 注册到 Azure 备份服务\r\n\r\n### <a name=\"create-a-backup-vault\"></a>创建备份保管库\r\n> [!WARNING]\r\n> 对于首次使用 Azure 备份的客户，需要注册用于订阅的 Azure 备份提供程序。 可通过运行以下命令来执行此操作：Register-AzureRmResourceProvider -ProviderNamespace \"Microsoft.Backup\"\r\n>\r\n>\r\n\r\n可以使用 **New-AzureRmBackupVault** cmdlet 创建新的备份保管库。 备份保管库是一种 ARM 资源，因此需要将它放置在资源组中。 在权限提升的 Azure PowerShell 控制台中运行以下命令：\r\n\r\n```\r\nPS C:\\> New-AzureRmResourceGroup -Name \"test-rg\" -Location \"China North\"\r\nPS C:\\> $backupvault = New-AzureRmBackupVault -ResourceGroupName \"test-rg\" -Name \"test-vault\" -Region \"China North\" -Storage GeoRedundant\r\n```\r\n\r\n可以使用 **Get-AzureRmBackupVault** cmdlet 获取给定订阅中所有备份保管库的列表。\r\n\r\n> [!NOTE]\r\n> 可以方便地将备份保管库对象保存到一个变量中。 许多 Azure 备份 cmdlet 需要输入保管库对象。\r\n>\r\n>\r\n\r\n### <a name=\"registering-the-vms\"></a>注册 VM\r\n要使用 Azure 备份配置备份，第一步是将计算机或 VM 注册到 Azure 备份保管库。 **Register-AzureRmBackupContainer** cmdlet 采用 Azure IaaS 虚拟机的输入信息，并将其注册到指定保管库。 注册操作将 Azure 虚拟机与备份保管库关联在一起，并跟踪备份生命周期中 VM 的活动。\r\n\r\n将 VM 注册到 Azure 备份服务会创建顶级容器对象。 一个容器通常保护多个可以备份的项，但在使用 VM 的情况下，容器将只有一个备份项。\r\n\r\n```\r\nPS C:\\> $registerjob = Register-AzureRmBackupContainer -Vault $backupvault -Name \"testvm\" -ServiceName \"testvm\"\r\n```\r\n\r\n## <a name=\"backup-azure-vms\"></a>备份 Azure VM\r\n### <a name=\"create-a-protection-policy\"></a>创建保护策略\r\n不必创建新的保护策略即可开始 VM 的备份。 使用保管库附带的“默认策略”，可快速启用保护功能，稍后再使用适当的详细信息对该策略进行编辑。 可以使用 **Get-AzureRmBackupProtectionPolicy cmdlet** 获取保管库中提供的策略的列表：\r\n\r\n```\r\nPS C:\\> Get-AzureRmBackupProtectionPolicy -Vault $backupvault\r\n\r\nName                      Type               ScheduleType       BackupTime\r\n----                      ----               ------------       ----------\r\nDefaultPolicy             AzureVM            Daily              26-Aug-15 12:30:00 AM\r\n```\r\n\r\n> [!NOTE]\r\n> PowerShell 中 BackupTime 字段的时区是 UTC。 但是，在 Azure 门户中显示备份时间时，时区会调整为本地系统并附带 UTC 时差。\r\n>\r\n>\r\n\r\n一个备份策略至少与一个保留策略相关联。 保留策略定义在 Azure 备份中保留恢复点的时限。 **New-AzureRmBackupRetentionPolicy** cmdlet 创建的 PowerShell 对象用于存储保留策略信息。 这些保留策略对象可以用作 New-AzureRmBackupProtectionPolicy cmdlet 的输入，也可以直接用于 Enable-AzureRmBackupProtection cmdlet。\r\n\r\n备份策略定义对某个项目进行备份的时间和频率。 **New-AzureRmBackupProtectionPolicy** cmdlet 创建的 PowerShell 对象用于存储备份策略信息。 该备份策略用作 *Enable-AzureRmBackupProtection* cmdlet 的输入。\r\n\r\n```\r\nPS C:\\> $Daily = New-AzureRmBackupRetentionPolicyObject -DailyRetention -Retention 30\r\nPS C:\\> $newpolicy = New-AzureRmBackupProtectionPolicy -Name DailyBackup01 -Type AzureVM -Daily -BackupTime ([datetime]\"3:30 PM\") -RetentionPolicy $Daily -Vault $backupvault\r\n\r\nName                      Type               ScheduleType       BackupTime\r\n----                      ----               ------------       ----------\r\nDailyBackup01             AzureVM            Daily              01-Sep-15 3:30:00 PM\r\n```\r\n\r\n### <a name=\"enable-protection\"></a>启用保护\r\n启用保护涉及两个对象 - 项目和策略，二者必须属于同一保管库。 将策略与项目关联以后，即可按定义的计划执行备份工作流。\r\n\r\n```\r\nPS C:\\> Get-AzureRmBackupContainer -Type AzureVM -Status Registered -Vault $backupvault | Get-AzureRmBackupItem | Enable-AzureRmBackupProtection -Policy $newpolicy\r\n```\r\n\r\n### <a name=\"initial-backup\"></a>初始备份\r\n备份计划需要考虑的是如何为项目执行完整的初始复制，以及如何为后续备份执行增量复制。 不过，如果想要强制初始备份在某个时间发生或者甚至是立刻发生，则可使用 **Backup-AzureRmBackupItem** cmdlet：\r\n\r\n```\r\nPS C:\\> $container = Get-AzureRmBackupContainer -Vault $backupvault -Type AzureVM -Name \"testvm\"\r\nPS C:\\> $backupjob = Get-AzureRmBackupItem -Container $container | Backup-AzureRmBackupItem\r\nPS C:\\> $backupjob\r\n\r\nWorkloadName    Operation       Status          StartTime              EndTime\r\n------------    ---------       ------          ---------              -------\r\ntestvm          Backup          InProgress      01-Sep-15 12:24:01 PM  01-Jan-01 12:00:00 AM\r\n```\r\n\r\n> [!NOTE]\r\n> PowerShell 中显示的 StartTime 和 EndTime 字段的时区是 UTC。 但是，在 Azure 门户中显示类似信息时，时区会调整为本地系统时钟。\r\n>\r\n>\r\n\r\n### <a name=\"monitoring-a-backup-job\"></a>监视备份作业\r\n在 Azure 备份中，大多数长时间运行的操作都是作为作业来建模的。 这样可以轻松地跟踪相关进度，而不必始终打开 Azure 门户。\r\n\r\n若要获取正在进行的作业的最新状态，请使用 **Get-AzureRmBackupJob** cmdlet。\r\n\r\n```\r\nPS C:\\> $joblist = Get-AzureRmBackupJob -Vault $backupvault -Status InProgress\r\nPS C:\\> $joblist[0]\r\n\r\nWorkloadName    Operation       Status          StartTime              EndTime\r\n------------    ---------       ------          ---------              -------\r\ntestvm          Backup          InProgress      01-Sep-15 12:24:01 PM  01-Jan-01 12:00:00 AM\r\n```\r\n\r\n与其使用额外的不必要的代码来轮询这些作业的完成情况，不如使用更简单的方式： **Wait-AzureRmBackupJob** cmdlet。 在脚本中使用时，该 cmdlet 会暂停操作的执行，直到作业完成或达到了指定的超时值。\r\n\r\n```\r\nPS C:\\> Wait-AzureRmBackupJob -Job $joblist[0] -Timeout 43200\r\n```\r\n\r\n\r\n## <a name=\"restore-an-azure-vm\"></a>还原 Azure VM\r\n若要还原备份数据，请确定已备份项目以及保留了时间点数据的恢复点。 此信息将提供给 Restore-AzureRmBackupItem cmdlet，以便启动还原过程，将数据从保管库还原到客户的帐户。\r\n\r\n### <a name=\"select-the-vm\"></a>选择 VM\r\n若要获取用于标识正确备份项目的 PowerShell 对象，请从保管库中的容器开始，按对象层次结构进行操作。 若要选择代表 VM 的容器，可使用 Get-AzureRmBackupContainer cmdlet，然后通过管道将其传输给 Get-AzureRmBackupItem cmdlet。\r\n\r\n```\r\nPS C:\\> $backupitem = Get-AzureRmBackupContainer -Vault $backupvault -Type AzureVM -name \"testvm\" | Get-AzureRmBackupItem\r\n```\r\n\r\n### <a name=\"choose-a-recovery-point\"></a>选择恢复点\r\n现在可以使用 **Get-AzureRmBackupRecoveryPoint** cmdlet 列出备份项目的所有恢复点，并选择要还原的恢复点。 通常情况下，用户会选取列表中在时间上最近的 *AppConsistent* 点。\r\n\r\n```\r\nPS C:\\> $rp =  Get-AzureRmBackupRecoveryPoint -Item $backupitem\r\nPS C:\\> $rp\r\n\r\nRecoveryPointId    RecoveryPointType  RecoveryPointTime      ContainerName\r\n---------------    -----------------  -----------------      -------------\r\n15273496567119     AppConsistent      01-Sep-15 12:27:38 PM  iaasvmcontainer;testvm;testv...\r\n```\r\n\r\n变量 ```$rp``` 是选定备份项的恢复点数组，已按时间逆序排序 - 最新的恢复点位于索引 0 处。 使用标准 PowerShell 数组索引选取恢复点。 例如：```$rp[0]``` 将选择最新的恢复点。\r\n\r\n### <a name=\"restoring-disks\"></a>还原磁盘\r\n通过 Azure 门户执行还原操作与通过 Azure PowerShell 执行还原操作存在很大的不同。 如果使用 PowerShell，还原操作会在从恢复点还原磁盘和配置信息时停止。 它不会创建虚拟机。\r\n\r\n> [!WARNING]\r\n> Restore-AzureRmBackupItem 不创建 VM。 它仅将磁盘还原到指定的存储帐户。 这种行为不同于在 Azure 门户中体验到的行为。\r\n>\r\n>\r\n\r\n```\r\nPS C:\\> $restorejob = Restore-AzureRmBackupItem -StorageAccountName \"DestAccount\" -RecoveryPoint $rp[0]\r\nPS C:\\> $restorejob\r\n\r\nWorkloadName    Operation       Status          StartTime              EndTime\r\n------------    ---------       ------          ---------              -------\r\ntestvm          Restore         InProgress      01-Sep-15 1:14:01 PM   01-Jan-01 12:00:00 AM\r\n```\r\n\r\n还原作业完成后，可使用 **Get-AzureRmBackupJobDetails** cmdlet 获取还原操作的详细信息。 *ErrorDetails* 属性将提供重建 VM 所需的信息。\r\n\r\n```\r\nPS C:\\> $restorejob = Get-AzureRmBackupJob -Job $restorejob\r\nPS C:\\> $details = Get-AzureRmBackupJobDetails -Job $restorejob\r\n```\r\n\r\n### <a name=\"build-the-vm\"></a>构建 VM\r\n从还原的磁盘构建 VM 时，可以使用旧版 Azure 服务管理 PowerShell cmdlet、新的 Azure 资源管理器模板甚至 Azure 门户。 在快速示例中，我们将演示如何使用 Azure 服务管理 cmdlet 来实现此目的。\r\n\r\n```\r\n$properties  = $details.Properties\r\n\r\n$storageAccountName = $properties[\"Target Storage Account Name\"]\r\n$containerName = $properties[\"Config Blob Container Name\"]\r\n$blobName = $properties[\"Config Blob Name\"]\r\n\r\n$keys = Get-AzureStorageKey -StorageAccountName $storageAccountName\r\n$storageAccountKey = $keys.Primary\r\n$storageContext = New-AzureStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey\r\n\r\n\r\n$destination_path = \"C:\\Users\\admin\\Desktop\\vmconfig.xml\"\r\nGet-AzureStorageBlobContent -Container $containerName -Blob $blobName -Destination $destination_path -Context $storageContext\r\n\r\n\r\n$obj = [xml](((Get-Content -Path $destination_path -Encoding UniCode)).TrimEnd([char]0x00))\r\n$pvr = $obj.PersistentVMRole\r\n$os = $pvr.OSVirtualHardDisk\r\n$dds = $pvr.DataVirtualHardDisks\r\n$osDisk = Add-AzureDisk -MediaLocation $os.MediaLink -OS $os.OS -DiskName \"panbhaosdisk\"\r\n$vm = New-AzureVMConfig -Name $pvr.RoleName -InstanceSize $pvr.RoleSize -DiskName $osDisk.DiskName\r\n\r\nif (!($dds -eq $null))\r\n{\r\n    foreach($d in $dds.DataVirtualHardDisk)\r\n    {\r\n        $lun = 0\r\n        if(!($d.Lun -eq $null))\r\n        {\r\n            $lun = $d.Lun\r\n        }\r\n        $name = \"panbhadataDisk\" + $lun\r\n        Add-AzureDisk -DiskName $name -MediaLocation $d.MediaLink\r\n        $vm | Add-AzureDataDisk -Import -DiskName $name -LUN $lun\r\n    }\r\n}\r\n\r\nNew-AzureVM -ServiceName \"panbhasample\" -Location \"China East\" -VM $vm\r\n```\r\n\r\n有关如何从还原的磁盘构建 VM 的详细信息，请阅读与下述 cmdlet 相关的内容：\r\n\r\n- [Add-AzureDisk](https://msdn.microsoft.com/library/azure/dn495252.aspx)\r\n- [New-AzureVMConfig](https://msdn.microsoft.com/library/azure/dn495159.aspx)\r\n- [New-AzureVM](https://msdn.microsoft.com/library/azure/dn495254.aspx)\r\n\r\n## <a name=\"code-samples\"></a>代码示例\r\n### <a name=\"1-get-the-completion-status-of-job-sub-tasks\"></a>1.获取作业子任务的完成状态\r\n若要跟踪单个子任务的完成状态，可以使用 **Get-AzureRmBackupJobDetails** cmdlet：\r\n\r\n```\r\nPS C:\\> $details = Get-AzureRmBackupJobDetails -JobId $backupjob.InstanceId -Vault $backupvault\r\nPS C:\\> $details.SubTasks\r\n\r\nName                                                        Status\r\n----                                                        ------\r\nTake Snapshot                                               Completed\r\nTransfer data to Backup vault                               InProgress\r\n```\r\n\r\n### <a name=\"2-create-a-dailyweekly-report-of-backup-jobs\"></a>2.创建备份作业的每日/每周报告\r\n管理员通常想要知道过去 24 小时运行了哪些备份作业以及这些备份作业的状态。 此外，管理员可以借助数据传输量来估算每月数据使用量。 以下脚本将从 Azure 备份服务提取原始数据，并在 PowerShell 控制台上显示信息。\r\n\r\n```\r\nparam(  [Parameter(Mandatory=$True,Position=1)]\r\n        [string]$backupvaultname,\r\n\r\n        [Parameter(Mandatory=$False,Position=2)]\r\n        [int]$numberofdays = 7)\r\n\r\n\r\n#Initialize variables\r\n$DAILYBACKUPSTATS = @()\r\n$backupvault = Get-AzureRmBackupVault -Name $backupvaultname\r\n$enddate = ([datetime]::Today).AddDays(1)\r\n$startdate = ([datetime]::Today)\r\n\r\nfor( $i = 1; $i -le $numberofdays; $i++ )\r\n{\r\n    # We query one day at a time because pulling 7 days of data might be too much\r\n    $dailyjoblist = Get-AzureRmBackupJob -Vault $backupvault -From $startdate -To $enddate -Type AzureVM -Operation Backup\r\n    Write-Progress -Activity \"Getting job information for the last $numberofdays days\" -Status \"Day -$i\" -PercentComplete ([int]([decimal]$i*100/$numberofdays))\r\n\r\n    foreach( $job in $dailyjoblist )\r\n    {\r\n        #Extract the information for the reports\r\n        $newstatsobj = New-Object System.Object\r\n        $newstatsobj | Add-Member -Type NoteProperty -Name Date -Value $startdate\r\n        $newstatsobj | Add-Member -Type NoteProperty -Name VMName -Value $job.WorkloadName\r\n        $newstatsobj | Add-Member -Type NoteProperty -Name Duration -Value $job.Duration\r\n        $newstatsobj | Add-Member -Type NoteProperty -Name Status -Value $job.Status\r\n\r\n        $details = Get-AzureRmBackupJobDetails -Job $job\r\n        $newstatsobj | Add-Member -Type NoteProperty -Name BackupSize -Value $details.Properties[\"Backup Size\"]\r\n        $DAILYBACKUPSTATS += $newstatsobj\r\n    }\r\n\r\n    $enddate = $enddate.AddDays(-1)\r\n    $startdate = $startdate.AddDays(-1)\r\n}\r\n\r\n$DAILYBACKUPSTATS | Out-GridView\r\n```\r\n\r\n如果想要为此报告输出添加图表功能，可通过 TechNet 博客文章 [使用 PowerShell 绘制图表](http://blogs.technet.com/b/richard_macdonald/archive/2009/04/28/3231887.aspx)\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n如果更愿意使用 PowerShell 来处理 Azure 资源，则请查看有关如何保护 Windows Server 的 PowerShell 文章：[为 Windows Server 部署和管理备份](backup-client-automation-classic.md)。 此外还有一篇有关如何管理 DPM 备份的 PowerShell 文章：[为 DPM 部署和管理备份](backup-dpm-automation-classic.md)。 这两篇文章都为 Resource Manager 部署和经典部署提供了一个版本。\r\n\r\n<!--Update_Description: wording update -->\r\n"}