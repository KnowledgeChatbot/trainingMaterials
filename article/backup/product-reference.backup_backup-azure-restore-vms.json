{"Title":"从备份中还原虚拟机","Description":"了解如何从恢复点还原 Azure 虚拟机","Content":"# <a name=\"restore-virtual-machines-in-azure\"></a>还原 Azure 中的虚拟机\r\n> [!div class=\"op_single_selector\"]\r\n> * [在 Azure 门户中还原 VM](backup-azure-arm-restore-vms.md)\r\n> * [在经典管理门户中还原 VM](backup-azure-restore-vms.md)\r\n>\r\n>\r\n\r\n执行以下步骤，通过存储在 Azure 备份保管库中的备份将虚拟机还原到新的 VM。\r\n\r\n> [!IMPORTANT]\r\n> 现在可将备份保管库升级到恢复服务保管库。 有关详细信息，请参阅文章[将备份保管库升级到恢复服务保管库](backup-azure-upgrade-backup-to-recovery-services.md)。 Microsoft 鼓励将备份保管库升级到恢复服务保管库。 之后 <br/> 2017 年 11 月 30 日之后，将不再能够使用 PowerShell 创建备份保管库。 <br/> 在 2017 年 11 月 30 日之前：\r\n>- 其余所有备份保管库都将自动升级到恢复服务保管库。\r\n>- 无法在经典管理门户中访问备份数据。 应使用 Azure 门户在恢复服务保管库中访问备份数据。\r\n>\r\n\r\n## <a name=\"restore-workflow\"></a>还原工作流\r\n### 步骤 1：选择要还原的项<a name=\"choosing-a-vm-restore-configuration\"></a>\r\n1. 导航到“受保护的项”选项卡，并选择用户要还原到新 VM 的虚拟机  。\r\n\r\n    ![受保护的项](./media/backup-azure-restore-vms/protected-items.png)\r\n\r\n    “受保护的项”页中的“恢复点”字段显示虚拟机的恢复点数目。 “最新恢复点”字段显示了可从中还原虚拟机的最近备份  。\r\n2. 单击“还原”打开“还原项”向导。\r\n\r\n    ![还原项](./media/backup-azure-restore-vms/restore-item.png)\r\n\r\n### <a name=\"step-2-pick-a-recovery-point\"></a>步骤 2：选择恢复点\r\n1. 在“选择恢复点”屏幕中，可以从最新的恢复点进行恢复，或者从以前的某个时间点进行恢复。 向导打开时默认选择的选项是“最新恢复点” 。\r\n\r\n    ![选择恢复点](./media/backup-azure-restore-vms/select-recovery-point.png)\r\n2. 若要选择更早的时间点，请在下拉列表中选择“选择日期”选项，并通过单击“日历图标”，在日历控件中选择一个日期。 在控件中，所有具有恢复点的日期以浅灰色阴影填充，并可供用户选择。\r\n\r\n    ![选择日期](./media/backup-azure-restore-vms/select-date.png)\r\n\r\n    单击日历控件中的日期后，当日可用的恢复点显示在下面的恢复点表中。 “时间”列指示生成快照的时间  。 “类型”列显示恢复点的[一致性](/backup/backup-azure-vms#consistency-of-recovery-points)。 表标题在括号中显示该日期可用的恢复点数目。\r\n\r\n    ![恢复点](./media/backup-azure-restore-vms/recovery-points.png)\r\n3. 从“恢复点”表中选择恢复点，并单击“下一步”箭头转到下一个屏幕  。\r\n\r\n### <a name=\"step-3-specify-a-destination-location\"></a>步骤 3：指定目标位置\r\n1. 在“选择还原实例”屏幕中，指定有关要将虚拟机还原到何处的详细信息。\r\n\r\n   - 指定虚拟机名称：在指定的云服务中，虚拟机名称应该是唯一的。 不支持覆盖现有 VM。\r\n   - 选择 VM 的云服务：这是创建 VM 的必要步骤。 可选择使用现有的云服务，或创建新的云服务。\r\n\r\n        选取的任何云服务名称都应是全局唯一的。 通常，云服务名称与面向公众的 URL 相关联，采用 [cloudservice].chinacloudapp.cn 形式。 如果名称已使用，Azure 将不允许创建新的云服务。 如果选择创建新的云服务，它的名称将与虚拟机的名称一样，在这种情况下，选择的 VM 名称应足够唯一，以应用于关联的云服务。\r\n\r\n        仅显示不与还原实例详细信息中的任何地缘组相关联的云服务和虚拟网络。 [了解详细信息](../virtual-network/virtual-networks-migrate-to-regional-vnet.md)。\r\n2. 选择 VM 的存储帐户：这是创建 VM 的必要步骤。 可选择与 Azure 备份保管库位于相同区域的现有存储帐户。 不支持区域冗余或高级存储类型的存储帐户。\r\n\r\n    如果没有受支持配置的存储帐户，请在启动还原操作之前创建一个具有受支持配置的存储帐户。\r\n\r\n    ![选择虚拟网络](./media/backup-azure-restore-vms/restore-sa.png)\r\n3. 选择虚拟网络：在创建 VM 时应该已经选择了虚拟机的虚拟网络 (VNET)。 还原 UI 显示此订阅中所有可用的 VNET。 为已还原的 VM 选择 VNET 不是必要步骤 - 即使不应用 VNET，也可通过 Internet 连接到已还原的虚拟机。\r\n\r\n    如果选择的云服务与虚拟网络关联，则你无法更改虚拟网络。\r\n\r\n    ![选择虚拟网络](./media/backup-azure-restore-vms/restore-cs-vnet.png)\r\n4. 选择子网：如果 VNET 有子网，默认选择的选项为第一个子网。 从下拉选项中选择所需子网。 有关子网详细信息，请转到[门户主页](https://manage.windowsazure.cn/)中的“网络”扩展，然后转到“虚拟网络”，并在选择虚拟网络后，向下钻取到“配置”以查看子网详细信息。\r\n\r\n    ![选择子网](./media/backup-azure-restore-vms/select-subnet.png)\r\n5. 在向导中单击“提交”图标以提交详细信息并创建还原作业  。\r\n\r\n## <a name=\"track-the-restore-operation\"></a>跟踪还原操作\r\n在还原向导中输入所有信息并提交后，Azure 备份将尝试创建一个作业来跟踪还原操作。\r\n\r\n![创建还原作业](./media/backup-azure-restore-vms/create-restore-job.png)\r\n\r\n如果成功创建作业，会出现一条 toast 通知，指出作业已创建。 可单击“查看作业”按钮进入“作业”选项卡，以获取更多详细信息。\r\n\r\n![已创建还原作业](./media/backup-azure-restore-vms/restore-job-created.png)\r\n\r\n还原操作完成后，系统将在“作业”选项卡中将其标记为已完成。\r\n\r\n![还原作业已完成](./media/backup-azure-restore-vms/restore-job-complete.png)\r\n\r\n还原虚拟机后，可能需要重新安装原始 VM 上的扩展，并在 Azure 门户中为虚拟机[修改终结点](../virtual-machines/windows/classic/setup-endpoints.md)。\r\n\r\n## <a name=\"post-restore-steps\"></a>还原后的步骤\r\n如果使用的是基于 cloud-init 的 Linux 分发（例如 Ubuntu），则会出于安全原因在还原后阻止密码。 请在还原的 VM 上使用 VMAccess 扩展[重置密码](../virtual-machines/linux/classic/reset-access.md)。 建议在这些分发上使用 SSH 密钥来避免在还原后重置密码。\r\n\r\n## <a name=\"backup-for-restored-vms\"></a>备份已还原的 VM\r\n如果将 VM 还原到的云服务与最初备份 VM 时所在的云服务同名，则还原之后，会继续备份该 VM。 如果将 VM 还原到了不同的云服务或者为还原的 VM 指定了不同的名称，则系统会将此 VM 视为新 VM，因此需为还原的 VM 设置备份。\r\n\r\n## <a name=\"restoring-a-vm-during-azure-datacenter-disaster\"></a>在发生 Azure 数据中心灾难期间还原 VM\r\n如果运行已备份 VM 的主数据中心遇到灾难性故障，并且已将备份保管库配置为异地冗余，则 Azure 备份允许将该 VM 还原到配对的数据中心。 在这种情况下，需要选择一个在配对数据中心内存在的存储帐户，而余下的还原过程将保持不变。 Azure 备份使用配对地区中的计算服务来创建还原的虚拟机。 详细了解 [Azure 数据中心复原](../resiliency/resiliency-technical-guidance-recovery-loss-azure-region.md)\r\n\r\n## <a name=\"restoring-domain-controller-vms\"></a>还原域控制器 VM\r\nAzure 备份支持对域控制器 (DC) 虚拟机进行备份的方案。 但是，在还原过程中，必须谨慎操作。 还原过程是否正确取决于域的结构。 最简单的情况是单个域中有单个 DC。 对于生产负载，更常见的情况是一个域中包含多个 DC，其中某些 DC 可能位于本地。 最终，可能拥有一个包含多个域的林。\r\n\r\n从 Active Directory 的角度来看，Azure VM 与受支持的新式虚拟机监控程序上任何其他 VM 类似。 本地虚拟机监控程序的主要差异是 Azure 中不提供 VM 控制台。 某些方案（如使用裸机恢复 (BMR) 类型备份进行恢复）需要控制台。 但是，通过备份保管库进行 VM 还原完全取代了 BMR。 还可使用 Active Directory 还原模式 (DSRM)，因此所有 Active Directory 恢复方案都是可行的。 有关更多背景信息，请查看[虚拟化域控制器的备份和还原注意事项](https://technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv(v=ws.10).aspx#backup_and_restore_considerations_for_virtualized_domain_controllers)和[规划 Active Directory 林恢复](https://technet.microsoft.com/en-us/library/planning-active-directory-forest-recovery(v=ws.10).aspx)。\r\n\r\n### <a name=\"single-dc-in-a-single-domain\"></a>单个域中有单个 DC\r\n可以通过 Azure 门户或 PowerShell 还原该 VM（与任何其他 VM 一样）。\r\n\r\n### <a name=\"multiple-dcs-in-a-single-domain\"></a>单个域中有多个 DC\r\n可通过网络访问同一域中的其他 DC 时，可像还原任何 VM 一样还原 DC。 对于域中剩余的最后一个 DC，或者在隔离网络中执行的恢复，必须遵循林恢复过程。\r\n\r\n### <a name=\"multiple-domains-in-one-forest\"></a>一个林中有多个域\r\n可通过网络访问同一域中的其他 DC 时，可像还原任何 VM 一样还原 DC。 但是，建议在所有其他情况下恢复林。\r\n\r\n<!--- WK: this following original supportability statement is incorrect, taking it out.\r\nThe challenge arises because DSRM mode is not present in Azure. So to restore such a VM, you cannot use the Azure portal. The only supported restore mechanism is disk-based restore using PowerShell.\r\n\r\n> [!WARNING]\r\n> For Domain Controller VMs in a multi-DC environment, do not use the Azure portal for restore! Only PowerShell based restore is supported\r\n>\r\n>\r\n\r\nRead more about the [USN rollback problem](https://technet.microsoft.com/library/dd363553) and the strategies suggested to fix it.\r\n--->\r\n\r\n## <a name=\"restoring-vms-with-special-network-configurations\"></a>还原采用特殊网络配置的 VM\r\nAzure 备份支持备份虚拟机的以下特殊网络配置。\r\n\r\n- 采用负载均衡器的 VM（内部和外部）\r\n- 具有多个保留 IP 的 VM\r\n- 具有多个 NIC 的 VM\r\n\r\n还原这些配置时，必须注意以下事项。\r\n\r\n> [!TIP]\r\n> 还原后，请使用基于 PowerShell 的还原流程来重新创建 VM 的特殊网络配置。\r\n>\r\n>\r\n\r\n### <a name=\"restoring-from-the-ui\"></a>从 UI 还原：\r\n从 UI 还原时，请 **始终选择新的云服务**。 请注意，由于门户在执行还原流程时只接受强制参数，因此使用 UI 还原的 VM 会丢失它们拥有的特殊网络配置。 也就是说，还原后的 VM 会是普通的 VM，而没有负载均衡器配置、多个 NIC 或多个保留 IP。\r\n\r\n### <a name=\"restoring-from-powershell\"></a>从 PowerShell 还原：\r\nPowerShell 能够只从备份还原 VM 磁盘，而不建立虚拟机。 当还原需要上述特殊网络配置的虚拟机时，此方法很有用。\r\n\r\n若要在还原磁盘后完全重新创建虚拟机，请执行以下步骤：\r\n\r\n1. 使用 [Azure 备份 PowerShell](backup-azure-vms-classic-automation.md#restore-an-azure-vm) 从备份保管库还原磁盘\r\n2. 使用 PowerShell cmdlet 创建负载均衡器/多个 NIC/多个保留 IP 所需的 VM 配置，并使用该配置创建具有所需配置的 VM。\r\n\r\n   - 使用内部负载均衡器在云服务中创建 VM\r\n   - 创建 VM 以连接到面向 Internet 的负载均衡器\r\n   - 创建具有[多个 NIC](../virtual-network/virtual-networks-multiple-nics.md) 的 VM\r\n   - 创建具有[多个保留 IP](../virtual-network/virtual-networks-reserved-public-ip.md) 的 VM\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n- [排查错误](backup-azure-vms-troubleshoot.md#restore)\r\n- [管理虚拟机](backup-azure-manage-vms.md)\r\n\r\n<!--Update_Description: wording update -->\r\n"}