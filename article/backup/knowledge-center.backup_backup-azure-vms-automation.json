{"Title":"使用 PowerShell 部署和管理 Resource Manager 部署型 VM 的备份","Description":"使用 PowerShell 在 Azure 中部署和管理 Resource Manager 部署型 VM 的备份","Content":"# <a name=\"use-azurermrecoveryservicesbackup-cmdlets-to-back-up-virtual-machines\"></a>使用 AzureRM.RecoveryServices.Backup cmdlet 来备份虚拟机\r\n> [!div class=\"op_single_selector\"]\r\n> * [Resource Manager](backup-azure-vms-automation.md)\r\n> * [经典](backup-azure-vms-classic-automation.md)\r\n>\r\n>\r\n\r\n本文说明如何使用 Azure PowerShell cmdlet 从恢复服务保管库备份和恢复 Azure 虚拟机 (VM)。 恢复服务保管库是一种 Azure Resource Manager 资源，用于保护 Azure 备份和 Azure Site Recovery 服务中的数据与资产。 可以使用恢复服务保管库来保护 Azure Service Manager 部署型 VM 以及 Azure Resource Manager 部署型 VM。\r\n\r\n> [!NOTE]\r\n> Azure 有两种用于创建和使用资源的部署模型： [Resource Manager 部署模型和经典部署模型](../azure-resource-manager/resource-manager-deployment-model.md)。 本文针对使用 Resource Manager 模型创建的 VM。\r\n>\r\n>\r\n\r\n本文逐步指导用户使用 PowerShell 来保护 VM，以及从恢复点还原数据。\r\n\r\n## <a name=\"concepts\"></a>概念\r\n如果不熟悉 Azure 备份服务，请查看[什么是 Azure 备份？](backup-introduction-to-azure-backup.md)，即可大致了解该服务。 在开始之前，请确保已掌握与系统必备组件相关的基础知识（这些必备组件是使用 Azure 备份所必需的），并了解当前 VM 备份解决方案的限制。\r\n\r\n若要有效地使用 PowerShell，必须了解对象的层次结构以及从何处开始。\r\n\r\n![恢复服务对象层次结构](./media/backup-azure-vms-arm-automation/recovery-services-object-hierarchy.png)\r\n\r\n若要查看 AzureRm.RecoveryServices.Backup PowerShell cmdlet 参考，请参阅 Azure 库中的 [Azure Backup - Recovery Services Cmdlets](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup)（Azure 备份 - 恢复服务 Cmdlet）。\r\n\r\n## <a name=\"setup-and-registration\"></a>设置和注册\r\n开始时，请执行以下操作：\r\n\r\n1. [下载最新版本的 PowerShell](https://docs.microsoft.com/powershell/azure/install-azurerm-ps)（所需的最低版本为 1.4.0）\r\n2. 键入以下命令查找可用的 Azure 备份 PowerShell cmdlet：\r\n\r\n    ```\r\n    PS C:\\> Get-Command *azurermrecoveryservices*\r\n\r\n    CommandType     Name                                               Version    Source\r\n    -----------     ----                                               -------    ------\r\n    Cmdlet          Backup-AzureRmRecoveryServicesBackupItem           1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Disable-AzureRmRecoveryServicesBackupProtection    1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Enable-AzureRmRecoveryServicesBackupProtection     1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupContainer         1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupItem              1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupJob               1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupJobDetails        1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupManagementServer  1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupProperties        1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupProtectionPolicy  1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRMRecoveryServicesBackupRecoveryPoint     1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupRetentionPolic... 1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesBackupSchedulePolicy... 1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Get-AzureRmRecoveryServicesVault                   1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Get-AzureRmRecoveryServicesVaultSettingsFile       1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          New-AzureRmRecoveryServicesBackupProtectionPolicy  1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          New-AzureRmRecoveryServicesVault                   1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Remove-AzureRmRecoveryServicesProtectionPolicy     1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Remove-AzureRmRecoveryServicesVault                1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Restore-AzureRMRecoveryServicesBackupItem          1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Set-AzureRmRecoveryServicesBackupProperties        1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Set-AzureRmRecoveryServicesBackupProtectionPolicy  1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Set-AzureRmRecoveryServicesVaultContext            1.4.0      AzureRM.RecoveryServices\r\n    Cmdlet          Stop-AzureRmRecoveryServicesBackupJob              1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Unregister-AzureRmRecoveryServicesBackupContainer  1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Unregister-AzureRmRecoveryServicesBackupManagem... 1.4.0      AzureRM.RecoveryServices.Backup\r\n    Cmdlet          Wait-AzureRmRecoveryServicesBackupJob              1.4.0      AzureRM.RecoveryServices.Backup\r\n    ```\r\n\r\n\r\n使用 PowerShell 可以自动化以下任务：\r\n\r\n- 创建恢复服务保管库\r\n- 备份 Azure VM\r\n- 触发备份作业\r\n- 监视备份作业\r\n- 还原 Azure VM\r\n\r\n## <a name=\"create-a-recovery-services-vault\"></a>创建恢复服务保管库\r\n\r\n以下步骤引导用户创建恢复服务保管库。 恢复服务保管库不同于备份保管库。\r\n\r\n1. 如果你是首次使用 Azure 备份，必须使用 **[Register-AzureRmResourceProvider](https://docs.microsoft.com/powershell/module/azurerm.resources/register-azurermresourceprovider)** cmdlet 将 Azure 恢复服务提供程序注册到订阅。\r\n\r\n    ```\r\n    PS C:\\> Register-AzureRmResourceProvider -ProviderNamespace \"Microsoft.RecoveryServices\"\r\n    ```\r\n2. 恢复服务保管库是一种 Resource Manager 资源，因此需要将它放在资源组中。 可以使用现有的资源组，也可以使用 **[New-AzureRmResourceGroup](https://docs.microsoft.com/powershell/module/azurerm.resources/new-azurermresourcegroup)** cmdlet 创建资源组。 创建资源组时，请指定资源组的名称和位置。  \r\n\r\n    ```\r\n    PS C:\\> New-AzureRmResourceGroup -Name \"test-rg\" -Location \"China North\"\r\n    ```\r\n3. 使用 **[New-AzureRmRecoveryServicesVault](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices/new-azurermrecoveryservicesvault)** cmdlet 创建恢复服务保管库。 确保为保管库指定的位置与用于资源组的位置是相同的。\r\n\r\n    ```\r\n    PS C:\\> New-AzureRmRecoveryServicesVault -Name \"testvault\" -ResourceGroupName \" test-rg\" -Location \"China North\"\r\n    ```\r\n4. 指定要使用的存储冗余类型；可以使用[本地冗余存储 (LRS)](../storage/common/storage-redundancy.md#locally-redundant-storage) 或[异地冗余存储 (GRS)](../storage/common/storage-redundancy.md#geo-redundant-storage)。 以下示例显示，testvault 的 -BackupStorageRedundancy 选项设置为 GeoRedundant。\r\n\r\n    ```\r\n    PS C:\\> $vault1 = Get-AzureRmRecoveryServicesVault -Name \"testvault\"\r\n    PS C:\\> Set-AzureRmRecoveryServicesBackupProperties  -Vault $vault1 -BackupStorageRedundancy GeoRedundant\r\n    ```\r\n\r\n   > [!TIP]\r\n   > 许多 Azure 备份 cmdlet 要求使用恢复服务保管库对象作为输入。 因此，在变量中存储备份恢复服务保管库对象可提供方便。\r\n   >\r\n   >\r\n\r\n## <a name=\"view-the-vaults-in-a-subscription\"></a>在订阅中查看保管库\r\n使用 **[Get-AzureRmRecoveryServicesVault](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices/get-azurermrecoveryservicesvault)** 查看当前订阅中所有保管库的列表。 可以使用此命令来查看是否创建了新的保管库，或者查看订阅中的可用保管库。\r\n\r\n运行 Get-AzureRmRecoveryServicesVault 命令可查看订阅中的所有保管库。 以下示例展示了为每个保管库显示的信息。\r\n\r\n```\r\nPS C:\\> Get-AzureRmRecoveryServicesVault\r\nName              : Contoso-vault\r\nID                : /subscriptions/1234\r\nType              : Microsoft.RecoveryServices/vaults\r\nLocation          : ChinaNorth\r\nResourceGroupName : Contoso-docs-rg\r\nSubscriptionId    : 1234-567f-8910-abc\r\nProperties        : Microsoft.Azure.Commands.RecoveryServices.ARSVaultProperties\r\n```\r\n\r\n\r\n## <a name=\"backup-azure-vms\"></a>备份 Azure VM\r\n使用恢复服务保管库保护虚拟机。 应用保护前，请先设置保管库上下文（保管库中受保护的数据类型）并验证保护策略。 保护策略是指备份作业运行时以及每个备份快照的保留时长的计划。\r\n\r\n### <a name=\"set-vault-context\"></a>设置保管库上下文\r\n在 VM 上启用保护之前，请使用 **[Set-AzureRmRecoveryServicesVaultContext](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices/set-azurermrecoveryservicesvaultcontext)** 来设置保管库上下文。 设置保管库上下文后，它将应用于所有后续 cmdlet。 以下示例为保管库 *testvault* 设置保管库上下文。\r\n\r\n```\r\nPS C:\\> Get-AzureRmRecoveryServicesVault -Name \"testvault\" | Set-AzureRmRecoveryServicesVaultContext\r\n```\r\n\r\n### <a name=\"create-a-protection-policy\"></a>创建保护策略\r\n在创建恢复服务保管库时，它附带了默认的保护和保留策略。 默认保护策略在每天的指定时间触发备份作业。 默认保留策略将每日恢复点保留 30 天。 可以使用默认策略快速保护 VM，以后再使用不同的详细信息编辑该策略。\r\n\r\n若要查看保管库中的保护策略，请使用 **[Get-AzureRmRecoveryServicesBackupProtectionPolicy](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupprotectionpolicy)**。 可以使用此 cmdlet 获取特定策略，或者查看与某个工作负荷类型关联的策略。 以下示例获取适用于工作负荷类型 AzureVM 的策略。\r\n\r\n```\r\nPS C:\\> Get-AzureRmRecoveryServicesBackupProtectionPolicy -WorkloadType \"AzureVM\"\r\nName                 WorkloadType       BackupManagementType BackupTime                DaysOfWeek\r\n----                 ------------       -------------------- ----------                ----------\r\nDefaultPolicy        AzureVM            AzureVM              4/14/2016 5:00:00 PM\r\n```\r\n\r\n> [!NOTE]\r\n> PowerShell 中 BackupTime 字段的时区是 UTC。 但是，在 Azure 门户中显示备份时间时，时间根据本地时区调整。\r\n>\r\n>\r\n\r\n一个备份保护策略至少与一个保留策略相关联。 保留策略定义了在将恢复点删除之前将其保留多长时间。 可以使用 **[Get-AzureRmRecoveryServicesBackupRetentionPolicyObject](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupretentionpolicyobject)** 查看默认保留策略。  类似地，可以使用 **[Get-AzureRmRecoveryServicesBackupSchedulePolicyObject](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupschedulepolicyobject)** 获取默认计划策略。 **[New-AzureRmRecoveryServicesBackupProtectionPolicy](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/new-azurermrecoveryservicesbackupprotectionpolicy)** cmdlet 创建用于保存备份策略信息的 PowerShell 对象。 计划和保留策略对象将用作 **[New-AzureRmRecoveryServicesBackupProtectionPolicy](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/new-azurermrecoveryservicesbackupprotectionpolicy)** cmdlet 的输入。 以下示例将计划策略和保留策略存储在变量中。 此示例使用这些变量来定义在创建保护策略 *NewPolicy* 时要使用的参数。\r\n\r\n```\r\nPS C:\\> $schPol = Get-AzureRmRecoveryServicesBackupSchedulePolicyObject -WorkloadType \"AzureVM\"\r\nPS C:\\> $retPol = Get-AzureRmRecoveryServicesBackupRetentionPolicyObject -WorkloadType \"AzureVM\"\r\nPS C:\\> New-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\" -WorkloadType \"AzureVM\" -RetentionPolicy $retPol -SchedulePolicy $schPol\r\nName                 WorkloadType       BackupManagementType BackupTime                DaysOfWeek\r\n----                 ------------       -------------------- ----------                ----------\r\nNewPolicy           AzureVM            AzureVM              4/24/2016 1:30:00 AM\r\n```\r\n\r\n\r\n### <a name=\"enable-protection\"></a>启用保护\r\n在定义备份保护策略后，还必须为相应的项启用该策略。 可以使用 **[Enable-AzureRmRecoveryServicesBackupProtection](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/enable-azurermrecoveryservicesbackupprotection)** 来启用保护。 启用保护需要两个对象 - 项和策略。 将策略与保管库关联之后，将在策略计划中定义的时间触发备份工作流。\r\n\r\n以下示例使用策略 NewPolicy 为项 V2VM 启用保护。 在非加密型 Resource Manager VM 上启用保护\r\n\r\n```\r\nPS C:\\> $pol=Get-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\"\r\nPS C:\\> Enable-AzureRmRecoveryServicesBackupProtection -Policy $pol -Name \"V2VM\" -ResourceGroupName \"RGName1\"\r\n```\r\n\r\n若要在加密型 VM 上启用保护（使用 BEK 和 KEK 加密），需要向 Azure 备份服务授予权限来读取 Key Vault 中的密钥和密码。\r\n\r\n```\r\nPS C:\\> Set-AzureRmKeyVaultAccessPolicy -VaultName \"KeyVaultName\" -ResourceGroupName \"RGNameOfKeyVault\" -PermissionsToKeys backup,get,list -PermissionsToSecrets get,list -ServicePrincipalName 262044b1-e2ce-469f-a196-69ab7ada62d3\r\nPS C:\\> $pol=Get-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\"\r\nPS C:\\> Enable-AzureRmRecoveryServicesBackupProtection -Policy $pol -Name \"V2VM\" -ResourceGroupName \"RGName1\"\r\n```\r\n\r\n若要在加密型 VM（仅使用 BEK 加密）上启用保护，需要向 Azure 备份服务授予权限来读取密钥保管库中的密码。\r\n\r\n```\r\nPS C:\\> Set-AzureRmKeyVaultAccessPolicy -VaultName \"KeyVaultName\" -ResourceGroupName \"RGNameOfKeyVault\" -PermissionsToSecrets backup,get,list -ServicePrincipalName 262044b1-e2ce-469f-a196-69ab7ada62d3\r\nPS C:\\> $pol=Get-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\"\r\nPS C:\\> Enable-AzureRmRecoveryServicesBackupProtection -Policy $pol -Name \"V2VM\" -ResourceGroupName \"RGName1\"\r\n```\r\n\r\n> [!NOTE]\r\n> 如果使用 Azure 政府云，请为 [Set-AzureRmKeyVaultAccessPolicy](https://docs.microsoft.com/powershell/module/azurerm.keyvault/set-azurermkeyvaultaccesspolicy) cmdlet 中的参数 **-ServicePrincipalName** 使用值 ff281ffe-705c-4f53-9f37-a40e6f2c68f3。\r\n>\r\n>\r\n\r\n针对经典 VM\r\n\r\n```\r\nPS C:\\> $pol=Get-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\"\r\nPS C:\\> Enable-AzureRmRecoveryServicesBackupProtection -Policy $pol -Name \"V1VM\" -ServiceName \"ServiceName1\"\r\n```\r\n\r\n### <a name=\"modify-a-protection-policy\"></a>修改保护策略\r\n若要修改保护策略，请使用 [Set-AzureRmRecoveryServicesBackupProtectionPolicy](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/set-azurermrecoveryservicesbackupprotectionpolicy) 修改 SchedulePolicy 或 RetentionPolicy 对象。\r\n\r\n以下示例将恢复点保留期更改为 365 天。\r\n\r\n```\r\nPS C:\\> $retPol = Get-AzureRmRecoveryServicesBackupRetentionPolicyObject -WorkloadType \"AzureVM\"\r\nPS C:\\> $retPol.DailySchedule.DurationCountInDays = 365\r\nPS C:\\> $pol= Get-AzureRmRecoveryServicesBackupProtectionPolicy -Name \"NewPolicy\"\r\nPS C:\\> Set-AzureRmRecoveryServicesBackupProtectionPolicy -Policy $pol  -RetentionPolicy $RetPol\r\n```\r\n\r\n## <a name=\"trigger-a-backup\"></a>触发备份\r\n可以使用 **[Backup-AzureRmRecoveryServicesBackupItem](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/backup-azurermrecoveryservicesbackupitem)** 来触发备份作业。 如果它是初始备份，则是一个完整备份。 后续备份将创建增量副本。 在触发备份作业之前，请确保使用 **[Set-AzureRmRecoveryServicesVaultContext](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices/set-azurermrecoveryservicesvaultcontext)** 来设置保管库上下文。 以下示例假定已设置了保管库上下文。\r\n\r\n```\r\nPS C:\\> $namedContainer = Get-AzureRmRecoveryServicesBackupContainer -ContainerType \"AzureVM\" -Status \"Registered\" -FriendlyName \"V2VM\"\r\nPS C:\\> $item = Get-AzureRmRecoveryServicesBackupItem -Container $namedContainer -WorkloadType \"AzureVM\"\r\nPS C:\\> $job = Backup-AzureRmRecoveryServicesBackupItem -Item $item\r\nWorkloadName     Operation            Status               StartTime                 EndTime                   JobID\r\n------------     ---------            ------               ---------                 -------                   ----------\r\nV2VM              Backup               InProgress            4/23/2016 5:00:30 PM                       cf4b3ef5-2fac-4c8e-a215-d2eba4124f27\r\n```\r\n\r\n> [!NOTE]\r\n> PowerShell 中 StartTime 和 EndTime 字段的时区是 UTC。 但是，在 Azure 门户中显示时间时，时间根据本地时区调整。\r\n>\r\n>\r\n\r\n## <a name=\"monitoring-a-backup-job\"></a>监视备份作业\r\n可以在不使用 Azure 门户的情况下监视长时间运行的操作，例如备份作业。 若要获取正在进行的作业的状态，请使用 **[Get-AzureRmRecoveryservicesBackupJob](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupjob)** cmdlet。 此 cmdlet 获取特定保管库的备份作业，并且该保管库是在保管库上下文中指定的。 以下示例将正在进行的作业的状态获取为数组，并将状态存储在 $joblist 变量中。\r\n\r\n```\r\nPS C:\\> $joblist = Get-AzureRmRecoveryservicesBackupJob -Status \"InProgress\"\r\nPS C:\\> $joblist[0]\r\nWorkloadName     Operation            Status               StartTime                 EndTime                   JobID\r\n------------     ---------            ------               ---------                 -------                   ----------\r\nV2VM             Backup               InProgress            4/23/2016 5:00:30 PM           cf4b3ef5-2fac-4c8e-a215-d2eba4124f27\r\n```\r\n\r\n与其使用额外的不必要的代码来轮询这些作业的完成情况，不如使用 **[Wait-AzureRmRecoveryServicesBackupJob](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/wait-azurermrecoveryservicesbackupjob)** cmdlet。 该 cmdlet 暂停操作的执行，直到作业完成或达到了指定的超时值。\r\n\r\n```\r\nPS C:\\> Wait-AzureRmRecoveryServicesBackupJob -Job $joblist[0] -Timeout 43200\r\n```\r\n\r\n## <a name=\"restore-an-azure-vm\"></a> 还原 Azure VM\r\n使用 Azure 门户还原 VM 与使用 PowerShell 还原 VM 存在很大区别。 如果使用 PowerShell，从恢复点创建磁盘和配置信息即可完成还原操作。\r\n\r\n> [!NOTE]\r\n> 还原操作不会创建虚拟机。\r\n>\r\n>\r\n\r\n若要通过磁盘创建虚拟机，请参阅[通过存储磁盘创建 VM](backup-azure-vms-automation.md#create-a-vm-from-stored-disks)。 还原 Azure VM 的基本步骤是：\r\n\r\n- 选择 VM\r\n- 选择恢复点\r\n- 还原磁盘\r\n- 通过存储磁盘创建 VM\r\n\r\n下图显示了从 RecoveryServicesVault 到 BackupRecoveryPoint 的对象层次结构。\r\n\r\n![显示 BackupContainer 的恢复服务对象层次结构](./media/backup-azure-vms-arm-automation/backuprecoverypoint-only.png)\r\n\r\n若要还原备份数据，请确定已备份项目以及保留了时间点数据的恢复点。 使用 **[Restore-AzureRmRecoveryServicesBackupItem](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/restore-azurermrecoveryservicesbackupitem)** cmdlet 将数据从保管库还原到客户的帐户。\r\n\r\n### <a name=\"select-the-vm\"></a>选择 VM\r\n若要获取用于标识正确备份项的 PowerShell 对象，请从保管库中的容器开始，按对象层次结构进行操作。 要选择代表 VM 的容器，请使用 **[Get-AzureRmRecoveryServicesBackupContainer](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupcontainer)** cmdlet，然后通过管道将其传递给 **[Get-AzureRmRecoveryServicesBackupItem](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupitem)** cmdlet。\r\n\r\n```\r\nPS C:\\> $namedContainer = Get-AzureRmRecoveryServicesBackupContainer  -ContainerType \"AzureVM\" -Status \"Registered\" -FriendlyName \"V2VM\"\r\nPS C:\\> $backupitem = Get-AzureRmRecoveryServicesBackupItem -Container $namedContainer  -WorkloadType \"AzureVM\"\r\n```\r\n\r\n### <a name=\"choose-a-recovery-point\"></a>选择恢复点\r\n使用 **[Get-AzureRmRecoveryServicesBackupRecoveryPoint](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackuprecoverypoint)** cmdlet 列出备份项的所有恢复点。 然后选择要还原的恢复点。 如果不确定要使用的恢复点，最好选择列表中最新的 RecoveryPointType = AppConsistent 恢复点。\r\n\r\n在以下脚本中，变量 **$rp** 是一个数组，其中包含所选备份项在过去七天的恢复点。 该数组按时间进行反向排序，以最新的恢复点作为索引 0。 使用标准 PowerShell 数组索引选取恢复点。 在示例中，$rp[0] 选择最新的恢复点。\r\n\r\n```\r\nPS C:\\> $startDate = (Get-Date).AddDays(-7)\r\nPS C:\\> $endDate = Get-Date\r\nPS C:\\> $rp = Get-AzureRmRecoveryServicesBackupRecoveryPoint -Item $backupitem -StartDate $startdate.ToUniversalTime() -EndDate $enddate.ToUniversalTime()\r\nPS C:\\> $rp[0]\r\nRecoveryPointAdditionalInfo :\r\nSourceVMStorageType         : NormalStorage\r\nName                        : 15260861925810\r\nItemName                    : VM;iaasvmcontainer;RGName1;V2VM\r\nRecoveryPointId             : /subscriptions/XX/resourceGroups/ RGName1/providers/Microsoft.RecoveryServices/vaults/testvault/backupFabrics/Azure/protectionContainers/IaasVMContainer;iaasvmcontainer;RGName1;V2VM/protectedItems/VM;iaasvmcontainer; RGName1;V2VM/recoveryPoints/15260861925810\r\nRecoveryPointType           : AppConsistent\r\nRecoveryPointTime           : 4/23/2016 5:02:04 PM\r\nWorkloadType                : AzureVM\r\nContainerName               : IaasVMContainer;iaasvmcontainer; RGName1;V2VM\r\nContainerType               : AzureVM\r\nBackupManagementType        : AzureVM\r\n```\r\n\r\n\r\n\r\n### <a name=\"restore-the-disks\"></a>还原磁盘\r\n使用 **[Restore-AzureRmRecoveryServicesBackupItem](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/restore-azurermrecoveryservicesbackupitem)** cmdlet 将备份项的数据和配置还原到某个恢复点。 确定某个恢复点后，即可使用它作为 **-RecoveryPoint** 参数的值。 在上面的示例代码中，**$rp[0]** 是要使用的恢复点。 在下面的示例代码中，**$rp[0]** 是还原磁盘时要使用的恢复点。\r\n\r\n还原磁盘和配置信息：\r\n\r\n```\r\nPS C:\\> $restorejob = Restore-AzureRmRecoveryServicesBackupItem -RecoveryPoint $rp[0] -StorageAccountName \"DestAccount\" -StorageAccountResourceGroupName \"DestRG\"\r\nPS C:\\> $restorejob\r\nWorkloadName     Operation          Status               StartTime                 EndTime            JobID\r\n------------     ---------          ------               ---------                 -------          ----------\r\nV2VM              Restore           InProgress           4/23/2016 5:00:30 PM                        cf4b3ef5-2fac-4c8e-a215-d2eba4124f27\r\n```\r\n\r\n使用 **[Wait-AzureRmRecoveryServicesBackupJob](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/wait-azurermrecoveryservicesbackupjob)** cmdlet 等待还原作业完成。\r\n\r\n```\r\nPS C:\\> Wait-AzureRmRecoveryServicesBackupJob -Job $restorejob -Timeout 43200\r\n```\r\n\r\n还原作业完成后，可以使用 **[Get-AzureRmRecoveryServicesBackupJobDetails](https://docs.microsoft.com/powershell/module/azurerm.recoveryservices.backup/get-azurermrecoveryservicesbackupjobdetails)** cmdlet 获取还原操作的详细信息。 JobDetails 属性提供重建 VM 所需的信息。\r\n\r\n```\r\nPS C:\\> $restorejob = Get-AzureRmRecoveryServicesBackupJob -Job $restorejob\r\nPS C:\\> $details = Get-AzureRmRecoveryServicesBackupJobDetails -Job $restorejob\r\n```\r\n\r\n还原磁盘以后，转到下一部分来了解如何创建 VM。\r\n\r\n## <a name=\"create-a-vm-from-restored-disks\"></a>从还原的磁盘创建 VM\r\n还原磁盘以后，即可通过以下步骤从磁盘创建和配置虚拟机。\r\n\r\n> [!NOTE]\r\n> 若要使用已还原的磁盘创建加密 VM，则 Azure 角色必须有权执行 **Microsoft.KeyVault/vaults/deploy/action** 操作。 如果用户角色不具有此权限，请创建具有此操作的自定义角色。 有关详细信息，请参阅 [Custom Roles in Azure RBAC](../active-directory/role-based-access-control-custom-roles.md)（Azure RBAC 中的自定义角色）。\r\n>\r\n>\r\n\r\n1. 查询已还原磁盘属性以获取作业详细信息。\r\n\r\n    ```\r\n    PS C:\\> $properties = $details.properties\r\n    PS C:\\> $storageAccountName = $properties[\"Target Storage Account Name\"]\r\n    PS C:\\> $containerName = $properties[\"Config Blob Container Name\"]\r\n    PS C:\\> $blobName = $properties[\"Config Blob Name\"]\r\n    ```\r\n2. 设置 Azure 存储上下文和还原 JSON 配置文件。\r\n\r\n    ```\r\n    PS C:\\> Set-AzureRmCurrentStorageAccount -Name $storageaccountname -ResourceGroupName \"testvault\"\r\n    PS C:\\> $destination_path = \"C:\\vmconfig.json\"\r\n    PS C:\\> Get-AzureStorageBlobContent -Container $containerName -Blob $blobName -Destination $destination_path\r\n    PS C:\\> $obj = ((Get-Content -Path $destination_path -Raw -Encoding Unicode)).TrimEnd([char]0x00) | ConvertFrom-Json\r\n    ```\r\n\r\n3. 使用 JSON 配置文件来创建 VM 配置。\r\n\r\n    ```\r\n   PS C:\\> $vm = New-AzureRmVMConfig -VMSize $obj.'properties.hardwareProfile'.vmSize -VMName \"testrestore\"\r\n    ```\r\n\r\n4. 附加 OS 磁盘和数据磁盘。 请根据 VM 配置，参阅相关部分内容，查看各自的 cmdlet：\r\n\r\n    #### <a name=\"non-managed-non-encrypted-vms\"></a>非托管、非加密型 VM\r\n\r\n    对于非托管、非加密型 VM，请使用以下示例。\r\n\r\n    ```\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -Name \"osdisk\" -VhdUri $obj.'properties.StorageProfile'.osDisk.vhd.Uri -CreateOption \"Attach\"\r\n    PS C:\\> $vm.StorageProfile.OsDisk.OsType = $obj.'properties.StorageProfile'.OsDisk.OsType\r\n    PS C:\\> foreach($dd in $obj.'properties.StorageProfile'.DataDisks)\r\n    {\r\n    $vm = Add-AzureRmVMDataDisk -VM $vm -Name \"datadisk1\" -VhdUri $dd.vhd.Uri -DiskSizeInGB 127 -Lun $dd.Lun -CreateOption \"Attach\"\r\n    }\r\n    ```\r\n\r\n    #### <a name=\"non-managed-encrypted-vms-bek-only\"></a>非托管、加密型 VM（仅限 BEK）\r\n\r\n    对于非托管的加密 VM（仅使用 BEK 加密），需要先将密码还原到密钥保管库，然后才能附加磁盘。 有关详细信息，请参阅[从 Azure 备份恢复点还原加密虚拟机](backup-azure-restore-key-secret.md)一文。 以下示例展示了如何为加密的 VM 附加 OS 和数据磁盘。\r\n\r\n    ```\r\n    PS C:\\> $dekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/secrets/ContosoSecret007/xx000000xx0849999f3xx30000003163\"\r\n    PS C:\\> $keyVaultId = \"/subscriptions/abcdedf007-4xyz-1a2b-0000-12a2b345675c/resourceGroups/ContosoRG108/providers/Microsoft.KeyVault/vaults/ContosoKeyVault\"\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -Name \"osdisk\" -VhdUri $obj.'properties.storageProfile'.osDisk.vhd.uri -DiskEncryptionKeyUrl $dekUrl -DiskEncryptionKeyVaultId $keyVaultId -CreateOption \"Attach\" -Windows\r\n    PS C:\\> $vm.StorageProfile.OsDisk.OsType = $obj.'properties.storageProfile'.osDisk.osType\r\n    PS C:\\> foreach($dd in $obj.'properties.storageProfile'.dataDisks)\r\n     {\r\n     $vm = Add-AzureRmVMDataDisk -VM $vm -Name \"datadisk1\" -VhdUri $dd.vhd.Uri -DiskSizeInGB 127 -Lun $dd.Lun -CreateOption \"Attach\"\r\n     }\r\n    ```\r\n\r\n    #### <a name=\"non-managed-encrypted-vms-bek-and-kek\"></a>非托管、加密型 VM（BEK 和 KEK）\r\n\r\n    对于非托管的加密 VM（使用 BEK 和 KEK 加密），需要先将密钥和密码还原到密钥保管库，然后才能附加磁盘。 有关详细信息，请参阅[从 Azure 备份恢复点还原加密虚拟机](backup-azure-restore-key-secret.md)一文。 以下示例展示了如何为加密的 VM 附加 OS 和数据磁盘。\r\n\r\n    ```\r\n    PS C:\\> $dekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/secrets/ContosoSecret007/xx000000xx0849999f3xx30000003163\"\r\n    PS C:\\> $kekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/keys/ContosoKey007/x9xxx00000x0000x9b9949999xx0x006\"\r\n    PS C:\\> $keyVaultId = \"/subscriptions/abcdedf007-4xyz-1a2b-0000-12a2b345675c/resourceGroups/ContosoRG108/providers/Microsoft.KeyVault/vaults/ContosoKeyVault\"\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -Name \"osdisk\" -VhdUri $obj.'properties.storageProfile'.osDisk.vhd.uri -DiskEncryptionKeyUrl $dekUrl -DiskEncryptionKeyVaultId $keyVaultId -KeyEncryptionKeyUrl $kekUrl -KeyEncryptionKeyVaultId $keyVaultId -CreateOption \"Attach\" -Windows\r\n    PS C:\\> $vm.StorageProfile.OsDisk.OsType = $obj.'properties.storageProfile'.osDisk.osType\r\n    PS C:\\> foreach($dd in $obj.'properties.storageProfile'.dataDisks)\r\n     {\r\n     $vm = Add-AzureRmVMDataDisk -VM $vm -Name \"datadisk1\" -VhdUri $dd.vhd.Uri -DiskSizeInGB 127 -Lun $dd.Lun -CreateOption \"Attach\"\r\n     }\r\n    ```\r\n\r\n    #### <a name=\"managed-non-encrypted-vms\"></a>托管、非加密型 VM\r\n\r\n    对于托管非加密型 VM，需从 blob 存储创建托管磁盘，然后附加磁盘。 有关详细信息，请参阅[使用 PowerShell 将数据磁盘附加到 Windows VM](../virtual-machines/windows/attach-disk-ps.md) 一文。 以下示例代码展示了如何为托管非加密型 VM 附加数据磁盘。\r\n\r\n    ```\r\n    PS C:\\> $storageType = \"StandardLRS\"\r\n    PS C:\\> $osDiskName = $vm.Name + \"_osdisk\"\r\n    PS C:\\> $osVhdUri = $obj.'properties.storageProfile'.osDisk.vhd.uri\r\n    PS C:\\> $diskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $osVhdUri\r\n    PS C:\\> $osDisk = New-AzureRmDisk -DiskName $osDiskName -Disk $diskConfig -ResourceGroupName \"test\"\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -ManagedDiskId $osDisk.Id -CreateOption \"Attach\" -Windows\r\n    PS C:\\> foreach($dd in $obj.'properties.storageProfile'.dataDisks)\r\n     {\r\n     $dataDiskName = $vm.Name + $dd.name ;\r\n     $dataVhdUri = $dd.vhd.uri ;\r\n     $dataDiskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $dataVhdUri ;\r\n     $dataDisk2 = New-AzureRmDisk -DiskName $dataDiskName -Disk $dataDiskConfig -ResourceGroupName \"test\" ;\r\n     Add-AzureRmVMDataDisk -VM $vm -Name $dataDiskName -ManagedDiskId $dataDisk2.Id -Lun $dd.Lun -CreateOption \"Attach\"\r\n    }\r\n    ```\r\n\r\n    #### <a name=\"managed-encrypted-vms-bek-only\"></a>托管加密型 VM（仅限 BEK）\r\n\r\n    对于托管加密型 VM（仅使用 BEK 加密），需要从 Blob 存储创建托管磁盘，然后附加磁盘。 有关详细信息，请参阅[使用 PowerShell 将数据磁盘附加到 Windows VM](../virtual-machines/windows/attach-disk-ps.md) 一文。 以下示例代码展示了如何为托管加密 VM 附加数据磁盘。\r\n\r\n     ```\r\n    PS C:\\> $dekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/secrets/ContosoSecret007/xx000000xx0849999f3xx30000003163\"\r\n    PS C:\\> $keyVaultId = \"/subscriptions/abcdedf007-4xyz-1a2b-0000-12a2b345675c/resourceGroups/ContosoRG108/providers/Microsoft.KeyVault/vaults/ContosoKeyVault\"\r\n    PS C:\\> $storageType = \"StandardLRS\"\r\n    PS C:\\> $osDiskName = $vm.Name + \"_osdisk\"\r\n    PS C:\\> $osVhdUri = $obj.'properties.storageProfile'.osDisk.vhd.uri\r\n    PS C:\\> $diskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $osVhdUri\r\n    PS C:\\> $osDisk = New-AzureRmDisk -DiskName $osDiskName -Disk $diskConfig -ResourceGroupName \"test\"\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -ManagedDiskId $osDisk.Id -DiskEncryptionKeyUrl $dekUrl -DiskEncryptionKeyVaultId $keyVaultId -CreateOption \"Attach\" -Windows\r\n    PS C:\\> foreach($dd in $obj.'properties.storageProfile'.dataDisks)\r\n     {\r\n     $dataDiskName = $vm.Name + $dd.name ;\r\n     $dataVhdUri = $dd.vhd.uri ;\r\n     $dataDiskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $dataVhdUri ;\r\n     $dataDisk2 = New-AzureRmDisk -DiskName $dataDiskName -Disk $dataDiskConfig -ResourceGroupName \"test\" ;\r\n     Add-AzureRmVMDataDisk -VM $vm -Name $dataDiskName -ManagedDiskId $dataDisk2.Id -Lun $dd.Lun -CreateOption \"Attach\"\r\n     }\r\n    ```\r\n\r\n    #### <a name=\"managed-encrypted-vms-bek-and-kek\"></a>托管加密型 VM（BEK 和 KEK）\r\n\r\n    对于托管加密 VM（使用 BEK 和 KEK 加密），需要从 Blob 存储创建托管磁盘，然后附加磁盘。 有关详细信息，请参阅[使用 PowerShell 将数据磁盘附加到 Windows VM](../virtual-machines/windows/attach-disk-ps.md) 一文。 以下示例代码展示了如何为托管加密 VM 附加数据磁盘。\r\n\r\n     ```\r\n    PS C:\\> $dekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/secrets/ContosoSecret007/xx000000xx0849999f3xx30000003163\"\r\n    PS C:\\> $kekUrl = \"https://ContosoKeyVault.vault.azure.cn:443/keys/ContosoKey007/x9xxx00000x0000x9b9949999xx0x006\"\r\n    PS C:\\> $keyVaultId = \"/subscriptions/abcdedf007-4xyz-1a2b-0000-12a2b345675c/resourceGroups/ContosoRG108/providers/Microsoft.KeyVault/vaults/ContosoKeyVault\"\r\n    PS C:\\> $storageType = \"StandardLRS\"\r\n    PS C:\\> $osDiskName = $vm.Name + \"_osdisk\"\r\n    PS C:\\> $osVhdUri = $obj.'properties.storageProfile'.osDisk.vhd.uri\r\n    PS C:\\> $diskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $osVhdUri\r\n    PS C:\\> $osDisk = New-AzureRmDisk -DiskName $osDiskName -Disk $diskConfig -ResourceGroupName \"test\"\r\n    PS C:\\> Set-AzureRmVMOSDisk -VM $vm -ManagedDiskId $osDisk.Id -DiskEncryptionKeyUrl $dekUrl -DiskEncryptionKeyVaultId $keyVaultId -KeyEncryptionKeyUrl $kekUrl -KeyEncryptionKeyVaultId $keyVaultId -CreateOption \"Attach\" -Windows\r\n    PS C:\\> foreach($dd in $obj.'properties.storageProfile'.dataDisks)\r\n     {\r\n     $dataDiskName = $vm.Name + $dd.name ;\r\n     $dataVhdUri = $dd.vhd.uri ;\r\n     $dataDiskConfig = New-AzureRmDiskConfig -AccountType $storageType -Location \"China North\" -CreateOption Import -SourceUri $dataVhdUri ;\r\n     $dataDisk2 = New-AzureRmDisk -DiskName $dataDiskName -Disk $dataDiskConfig -ResourceGroupName \"test\" ;\r\n     Add-AzureRmVMDataDisk -VM $vm -Name $dataDiskName -ManagedDiskId $dataDisk2.Id -Lun $dd.Lun -CreateOption \"Attach\"\r\n     }\r\n    ```\r\n\r\n5. 设置网络设置。\r\n\r\n    ```\r\n    PS C:\\> $nicName=\"p1234\"\r\n    PS C:\\> $pip = New-AzureRmPublicIpAddress -Name $nicName -ResourceGroupName \"test\" -Location \"ChinaNorth\" -AllocationMethod Dynamic\r\n    PS C:\\> $vnet = Get-AzureRmVirtualNetwork -Name \"testvNET\" -ResourceGroupName \"test\"\r\n    PS C:\\> $nic = New-AzureRmNetworkInterface -Name $nicName -ResourceGroupName \"test\" -Location \"ChinaNorth\" -SubnetId $vnet.Subnets[$subnetindex].Id -PublicIpAddressId $pip.Id\r\n    PS C:\\> $vm=Add-AzureRmVMNetworkInterface -VM $vm -Id $nic.Id\r\n    ```\r\n6. 创建虚拟机。\r\n\r\n    ```    \r\n    PS C:\\> New-AzureRmVM -ResourceGroupName \"test\" -Location \"ChinaNorth\" -VM $vm\r\n    ```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n如果你更愿意使用 PowerShell 来处理 Azure 资源，请查看 PowerShell 文章：[为 Windows Server 部署和管理备份](backup-client-automation.md)。 如果管理 DPM 备份，请参阅[为 DPM 部署和管理备份](backup-dpm-automation.md)。 这两篇文章都为 Resource Manager 部署和经典部署提供了一个版本。  \r\n\r\n<!--Update_Description: wording update-->\r\n"}