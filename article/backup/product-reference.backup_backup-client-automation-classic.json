{"Title":"在 Azure 中使用 PowerShell 管理 Windows Server 备份","Description":"使用 PowerShell 部署和管理 Windows Server 备份。","Content":"# <a name=\"deploy-and-manage-backup-to-azure-for-windows-serverwindows-client-using-powershell\"></a>使用 PowerShell 部署和管理 Windows Server/Windows 客户端的 Azure 备份\r\n> [!div class=\"op_single_selector\"]\r\n> * [ARM](backup-client-automation.md)\r\n> * [经典](backup-client-automation-classic.md)\r\n>\r\n>\r\n\r\n本文介绍如何使用 PowerShell 将 Windows Server 或 Windows 工作站数据备份到备份保管库。 Microsoft 建议对所有新部署使用恢复服务保管库。 如果你是新的 Azure 备份用户，并且在订阅中未创建过备份保管库，请参阅文章[使用 PowerShell 将 Data Protection Manager 数据部署到 Azure 并管理这些数据](backup-client-automation.md)，然后将数据存储在恢复服务保管库中。 \r\n\r\n> [!IMPORTANT]\r\n> 现在可将备份保管库升级到恢复服务保管库。 有关详细信息，请参阅文章[将备份保管库升级到恢复服务保管库](backup-azure-upgrade-backup-to-recovery-services.md)。 Microsoft 鼓励将备份保管库升级到恢复服务保管库。<br/> 2017 年 11 月 30 日之后，将不再能够使用 PowerShell 创建备份保管库。 在 2017 年 11 月 30 日之前：\r\n>- 其余所有备份保管库都将自动升级到恢复服务保管库。\r\n>- 无法在经典管理门户中访问备份数据。 应使用 Azure 门户在恢复服务保管库中访问备份数据。\r\n>\r\n\r\n## <a name=\"install-azure-powershell\"></a>安装 Azure PowerShell\r\n[!INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-include.md)]\r\n\r\nAzure PowerShell 1.0 已在 2015 年 10 月发布。 此版本在 0.9.8 版本的基础上进行了一些重大的更改，尤其是对 cmdlet 的命名方式进行了更改。 1.0 版 cmdlet 遵循命名模式 {谓词}-AzureRm{名词}；而 0.9.8 名称不包括 Rm（例如，使用 New-AzureResourceGroup 而不是 New-AzureRmResourceGroup）。 在使用 Azure PowerShell 0.9.8 时，首先必须通过运行 **Switch-AzureMode AzureResourceManager** 命令启用 Resource Manager 模式。 1.0 或更高版中并不需要此命令在。\r\n\r\n要将针对 0.9.8 环境编写的脚本用在 1.0 或更高版本的环境中，应在预生产环境中对脚本进行仔细的测试，然后才能将其用在生产中，以免造成意外影响。\r\n\r\n[下载最新的 PowerShell 版本](https://github.com/Azure/azure-powershell/releases)（所需最低版本：1.0.0）\r\n\r\n[!INCLUDE [arm-getting-setup-powershell](../../includes/arm-getting-setup-powershell.md)]\r\n\r\n## <a name=\"create-a-backup-vault\"></a>创建备份保管库\r\n> [!WARNING]\r\n> 对于首次使用 Azure 备份的客户，需要注册用于订阅的 Azure 备份提供程序。 可通过运行以下命令来执行此操作：Register-AzureProvider -ProviderNamespace \"Microsoft.Backup\"\r\n>\r\n>\r\n\r\n可以使用 **New-AzureRMBackupVault** cmdlet 创建新的备份保管库。 备份保管库是一种 ARM 资源，因此需要将它放置在资源组中。 在权限提升的 Azure PowerShell 控制台中运行以下命令：\r\n\r\n```\r\nPS C:\\> New-AzureResourceGroup -Name “test-rg” -Region “China North”\r\nPS C:\\> $backupvault = New-AzureRMBackupVault -ResourceGroupName “test-rg” -Name “test-vault” -Region “China North” -Storage GeoRedundant\r\n```\r\n\r\n使用 **Get-AzureRMBackupVault** cmdlet 列出订阅中的备份保管库。\r\n\r\n## <a name=\"installing-the-azure-backup-agent\"></a>安装 Azure 备份代理\r\n在安装 Azure 备份代理之前，必须先将安装程序下载到 Windows Server 上。 可以从 [Microsoft 下载中心](http://aka.ms/azurebackup_agent)或者备份保管库的“仪表板”页获取最新版本的安装程序。 将安装程序保存到方便访问的位置，例如 *C:\\Downloads\\*。\r\n\r\n若要安装代理，请在已提升权限的 PowerShell 控制台中运行以下命令：\r\n\r\n```\r\nPS C:\\> MARSAgentInstaller.exe /q\r\n```\r\n\r\n这以所有默认选项安装代理。 将在后台执行安装几分钟。 如果没有指定 /nu 选项，则安装结束时，会打开“Windows 更新”窗口，检查是否有任何更新。 安装之后，代理会显示在已安装程序列表中。\r\n\r\n若要查看已安装的程序列表，请转到“**控制面板**”“ > **程序** > ”“**程序和功能**”。\r\n\r\n![已安装代理](./media/backup-client-automation/installed-agent-listing.png)\r\n\r\n### <a name=\"installation-options\"></a>安装选项\r\n若要查看可通过命令行运行的所有选项，请使用以下命令：\r\n\r\n```\r\nPS C:\\> MARSAgentInstaller.exe /?\r\n```\r\n\r\n可用选项包括：\r\n\r\n| 选项 | 详细信息 | 默认 |\r\n| --- | --- | --- |\r\n| /q |静默安装 |- |\r\n| /p:\"location\" |Azure 备份代理的安装文件夹路径。 |C:\\Program Files\\Azure Recovery Services Agent |\r\n| /s:\"location\" |Azure 备份代理的缓存文件夹路径。 |C:\\Program Files\\Azure Recovery Services Agent\\Scratch |\r\n| /m |选择启用 Microsoft Update |- |\r\n| /nu |安装完成后不要检查更新 |- |\r\n| /d |卸载 Azure 恢复服务代理 |- |\r\n| /ph |代理主机地址 |- |\r\n| /po |代理主机端口号 |- |\r\n| /pu |代理主机用户名 |- |\r\n| /pw |代理密码 |- |\r\n\r\n## <a name=\"registering-with-the-azure-backup-service\"></a>注册到 Azure 备份服务\r\n在可注册 Azure 备份服务之前，需要确保符合[先决条件](backup-configure-vault.md)。 必须具备以下条件：\r\n\r\n- 具备有效的 Azure 订阅\r\n- 有一个备份保管库\r\n\r\n若要下载保管库凭据，请在 Azure PowerShell 控制台中运行 Get-AzureRMBackupVaultCredentials cmdlet，并将其存储在方便的位置，例如 C:\\Downloads\\*。\r\n\r\n```\r\nPS C:\\> $credspath = \"C:\\\"\r\nPS C:\\> $credsfilename = Get-AzureRMBackupVaultCredentials -Vault $backupvault -TargetLocation $credspath\r\nPS C:\\> $credsfilename\r\nf5303a0b-fae4-4cdb-b44d-0e4c032dde26_backuprg_backuprn_2015-08-11--06-22-35.VaultCredentials\r\n```\r\n\r\n使用 [Start-OBRegistration](https://technet.microsoft.com/library/hh770398%28v=wps.630%29.aspx) cmdlet 即可向保管库注册计算机：\r\n\r\n```\r\nPS C:\\> $cred = $credspath + $credsfilename\r\nPS C:\\> Start-OBRegistration -VaultCredentials $cred -Confirm:$false\r\n\r\nCertThumbprint      : 7a2ef2caa2e74b6ed1222a5e89288ddad438df2\r\nSubscriptionID      : ef4ab577-c2c0-43e4-af80-af49f485f3d1\r\nServiceResourceName : test-vault\r\nRegion              : China North\r\n\r\nMachine registration succeeded.\r\n```\r\n\r\n> [!IMPORTANT]\r\n> 请勿使用相对路径来指定保管库凭据文件。 必须提供绝对路径作为 cmdlet 的输入。\r\n>\r\n>\r\n\r\n## <a name=\"networking-settings\"></a>网络设置\r\n如果 Windows 计算机通过代理服务器连接到 Internet，则也可以向代理提供代理设置。 此示例未使用代理服务器，因此我们会显式清除任何与代理相关的信息。\r\n\r\n也可以针对给定的一组星期日期，使用 ```work hour bandwidth``` 和 ```non-work hour bandwidth``` 选项控制带宽使用。\r\n\r\n使用 [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409%28v=wps.630%29.aspx) cmdlet 即可设置代理和带宽详细信息：\r\n\r\n```\r\nPS C:\\> Set-OBMachineSetting -NoProxy\r\nServer properties updated successfully.\r\n\r\nPS C:\\> Set-OBMachineSetting -NoThrottle\r\nServer properties updated successfully.\r\n```\r\n\r\n## <a name=\"encryption-settings\"></a>加密设置\r\n发送到 Azure 备份的备份数据会加密，以保护数据的机密性。 加密通行短语是在还原时用于解密数据的“密码”。\r\n\r\n```\r\nPS C:\\> ConvertTo-SecureString -String \"Complex!123_STRING\" -AsPlainText -Force | Set-OBMachineSetting\r\nServer properties updated successfully\r\n```\r\n\r\n> [!IMPORTANT]\r\n> 请妥善保管设置好的通行短语，并保证其安全。 如果没有此通行短语，则无法从 Azure 还原数据。\r\n>\r\n>\r\n\r\n## <a name=\"back-up-files-and-folders\"></a>备份文件和文件夹\r\n从 Windows Server 和客户端到 Azure 备份的所有备份由策略控制。 策略由三个部分组成：\r\n\r\n1. **备份计划** ，用于指定需要备份并与服务保持同步的时间。\r\n2. **保留计划** ，用于指定要在 Azure 中保留恢复点的时长。\r\n3. **文件包含/排除规范** ，用于指示应备份的内容。\r\n\r\n在本文档中，由于我们要自动备份，因此假设尚未配置任何选项。 首先，我们使用 [New-OBPolicy](https://technet.microsoft.com/library/hh770416.aspx) cmdlet 创建新的备份策略，并使用该策略。\r\n\r\n```\r\nPS C:\\> $newpolicy = New-OBPolicy\r\n```\r\n\r\n该策略暂时是空的，需要使用其他 cmdlet 来定义要包含或排除的项、运行备份的时间，以及备份的存储位置。\r\n\r\n### <a name=\"configuring-the-backup-schedule\"></a>配置备份计划\r\n在策略的 3 个组成部分中，第 1 个部分是备份计划，它是使用 [New-OBSchedule](https://technet.microsoft.com/library/hh770401) cmdlet 创建的。 备份计划将定义何时需要备份。 创建计划时，需要指定 2 个输入参数：\r\n\r\n- 应运行备份的“星期日期”。 可以只选一天或选择一周的每天运行备份作业，或选择星期日期的任意组合。\r\n- **日期时间** 。 最多可以定义一天的 3 个不同日期时间来触发备份\r\n\r\n例如，可以配置在每个星期六和星期日下午 4 点运行备份策略。\r\n\r\n```\r\nPS C:\\> $sched = New-OBSchedule -DaysofWeek Saturday, Sunday -TimesofDay 16:00\r\n```\r\n\r\n备份计划需要与策略相关联，这可以使用 [Set-OBSchedule](https://technet.microsoft.com/library/hh770407) cmdlet 来实现。\r\n\r\n```\r\nPS C:> Set-OBSchedule -Policy $newpolicy -Schedule $sched\r\nBackupSchedule : 4:00 PM Saturday, Sunday, Every 1 week(s) DsList : PolicyName : RetentionPolicy : State : New PolicyState : Valid\r\n```\r\n### <a name=\"configuring-a-retention-policy\"></a>配置保留策略\r\n保留策略定义基于备份作业创建的恢复点的保留时间。 使用 [New-OBRetentionPolicy](https://technet.microsoft.com/library/hh770425) cmdlet 创建新的保留策略时，可以使用 Azure 备份来指定需要保留备份恢复点的天数。 以下示例将保留策略设置为 7 天。\r\n\r\n```\r\nPS C:\\> $retentionpolicy = New-OBRetentionPolicy -RetentionDays 7\r\n```\r\n\r\n必须使用 cmdlet [Set-OBRetentionPolicy](https://technet.microsoft.com/library/hh770405) 将保留策略与主要策略相关联：\r\n\r\n```\r\nPS C:\\> Set-OBRetentionPolicy -Policy $newpolicy -RetentionPolicy $retentionpolicy\r\n\r\nBackupSchedule  : 4:00 PM\r\n                  Saturday, Sunday,\r\n                  Every 1 week(s)\r\nDsList          :\r\nPolicyName      :\r\nRetentionPolicy : Retention Days : 7\r\n\r\n                  WeeklyLTRSchedule :\r\n                  Weekly schedule is not set\r\n\r\n                  MonthlyLTRSchedule :\r\n                  Monthly schedule is not set\r\n\r\n                  YearlyLTRSchedule :\r\n                  Yearly schedule is not set\r\n\r\nState           : New\r\nPolicyState     : Valid\r\n```\r\n### <a name=\"including-and-excluding-files-to-be-backed-up\"></a>包含和排除要备份的文件\r\n```OBFileSpec``` 对象定义要在备份中包含与排除的文件。 这组规则可划分出计算机上要保护的文件和文件夹。 可以设置任意数量的文件包含或排除规则，并将其与策略相关联。 创建新的 OBFileSpec 对象时，可执行以下操作：\r\n\r\n- 指定要包含的文件和文件夹\r\n- 指定要排除的文件和文件夹\r\n- 指定要递归备份文件夹中的数据，或是否仅备份指定文件夹中的顶级文件。\r\n\r\n可以在 New-OBFileSpec 命令中使用 -NonRecursive 标志来完成后一种指定。\r\n\r\n在以下示例中，备份卷 C: 和 D:，并排除 Windows 文件夹和任何临时文件夹中的操作系统二进制文件。 为此，我们将使用 [New-OBFileSpec](https://technet.microsoft.com/library/hh770408) cmdlet 创建两个文件规范 - 一个用于包含，一个用于排除。 创建文件规范后，使用 [Add-OBFileSpec](https://technet.microsoft.com/library/hh770424) cmdlet 将它们与策略相关联。\r\n\r\n```\r\nPS C:\\> $inclusions = New-OBFileSpec -FileSpec @(\"C:\\\", \"D:\\\")\r\n\r\nPS C:\\> $exclusions = New-OBFileSpec -FileSpec @(\"C:\\windows\", \"C:\\temp\") -Exclude\r\n\r\nPS C:\\> Add-OBFileSpec -Policy $newpolicy -FileSpec $inclusions\r\n\r\nBackupSchedule  : 4:00 PM\r\n                  Saturday, Sunday,\r\n                  Every 1 week(s)\r\nDsList          : {DataSource\r\n                  DatasourceId:0\r\n                  Name:C:\\\r\n                  FileSpec:FileSpec\r\n                  FileSpec:C:\\\r\n                  IsExclude:False\r\n                  IsRecursive:True\r\n\r\n                  , DataSource\r\n                  DatasourceId:0\r\n                  Name:D:\\\r\n                  FileSpec:FileSpec\r\n                  FileSpec:D:\\\r\n                  IsExclude:False\r\n                  IsRecursive:True\r\n\r\n                  }\r\nPolicyName      :\r\nRetentionPolicy : Retention Days : 7\r\n\r\n                  WeeklyLTRSchedule :\r\n                  Weekly schedule is not set\r\n\r\n                  MonthlyLTRSchedule :\r\n                  Monthly schedule is not set\r\n\r\n                  YearlyLTRSchedule :\r\n                  Yearly schedule is not set\r\n\r\nState           : New\r\nPolicyState     : Valid\r\n\r\n\r\nPS C:\\> Add-OBFileSpec -Policy $newpolicy -FileSpec $exclusions\r\n\r\nBackupSchedule  : 4:00 PM\r\n                  Saturday, Sunday,\r\n                  Every 1 week(s)\r\nDsList          : {DataSource\r\n                  DatasourceId:0\r\n                  Name:C:\\\r\n                  FileSpec:FileSpec\r\n                  FileSpec:C:\\\r\n                  IsExclude:False\r\n                  IsRecursive:True\r\n                  ,FileSpec\r\n                  FileSpec:C:\\windows\r\n                  IsExclude:True\r\n                  IsRecursive:True\r\n                  ,FileSpec\r\n                  FileSpec:C:\\temp\r\n                  IsExclude:True\r\n                  IsRecursive:True\r\n\r\n                  , DataSource\r\n                  DatasourceId:0\r\n                  Name:D:\\\r\n                  FileSpec:FileSpec\r\n                  FileSpec:D:\\\r\n                  IsExclude:False\r\n                  IsRecursive:True\r\n\r\n                  }\r\nPolicyName      :\r\nRetentionPolicy : Retention Days : 7\r\n\r\n                  WeeklyLTRSchedule :\r\n                  Weekly schedule is not set\r\n\r\n                  MonthlyLTRSchedule :\r\n                  Monthly schedule is not set\r\n\r\n                  YearlyLTRSchedule :\r\n                  Yearly schedule is not set\r\n\r\nState           : New\r\nPolicyState     : Valid\r\n```\r\n\r\n### <a name=\"applying-the-policy\"></a>应用策略\r\n现在已完成策略对象，并且具有关联的备份计划、保留策略及文件包含/排除列表。 现在可以提交此策略以供 Azure 备份使用。 应用新建策略之前，请使用 [Remove-OBPolicy](https://technet.microsoft.com/library/hh770415) cmdlet 确保没有任何现有备份策略与服务器相关联。 删除策略时，系统会提示确认。 若要跳过确认，请在 cmdlet 中请使用 ```-Confirm:$false``` 标志。\r\n\r\n```\r\nPS C:> Get-OBPolicy | Remove-OBPolicy\r\nAzure Backup Are you sure you want to remove this backup policy? This will delete all the backed up data. [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is \"Y\"):\r\n```\r\n\r\n使用 [Set-OBPolicy](https://technet.microsoft.com/library/hh770421) cmdlet 可以提交策略对象。 系统会提示确认。 若要跳过确认，请在 cmdlet 中请使用 ```-Confirm:$false``` 标志。\r\n\r\n```\r\nPS C:> Set-OBPolicy -Policy $newpolicy\r\nAzure Backup Do you want to save this backup policy ? [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is \"Y\"):\r\nBackupSchedule : 4:00 PM Saturday, Sunday, Every 1 week(s)\r\nDsList : {DataSource\r\n         DatasourceId:4508156004108672185\r\n         Name:C:\\\r\n         FileSpec:FileSpec\r\n         FileSpec:C:\\\r\n         IsExclude:False\r\n         IsRecursive:True,\r\n\r\n         FileSpec\r\n         FileSpec:C:\\windows\r\n         IsExclude:True\r\n         IsRecursive:True,\r\n\r\n         FileSpec\r\n         FileSpec:C:\\temp\r\n         IsExclude:True\r\n         IsRecursive:True,\r\n\r\n         DataSource\r\n         DatasourceId:4508156005178868542\r\n         Name:D:\\\r\n         FileSpec:FileSpec\r\n         FileSpec:D:\\\r\n         IsExclude:False\r\n         IsRecursive:True\r\n    }\r\nPolicyName : c2eb6568-8a06-49f4-a20e-3019ae411bac\r\nRetentionPolicy : Retention Days : 7\r\n              WeeklyLTRSchedule :\r\n              Weekly schedule is not set\r\n\r\n              MonthlyLTRSchedule :\r\n              Monthly schedule is not set\r\n\r\n              YearlyLTRSchedule :\r\n              Yearly schedule is not set\r\nState : Existing PolicyState : Valid\r\n```\r\n\r\n可以使用 [Get-OBPolicy](https://technet.microsoft.com/library/hh770406) cmdlet 来查看现有备份策略的详细信息。 可以使用 [Get-OBSchedule](https://technet.microsoft.com/library/hh770423) cmdlet（适用于备份计划）和 [Get-OBRetentionPolicy](https://technet.microsoft.com/library/hh770427) cmdlet（适用于保留策略）进一步向下钻取\r\n\r\n```\r\nPS C:> Get-OBPolicy | Get-OBSchedule\r\nSchedulePolicyName : 71944081-9950-4f7e-841d-32f0a0a1359a\r\nScheduleRunDays : {Saturday, Sunday}\r\nScheduleRunTimes : {16:00:00}\r\nState : Existing\r\n\r\nPS C:> Get-OBPolicy | Get-OBRetentionPolicy\r\nRetentionDays : 7\r\nRetentionPolicyName : ca3574ec-8331-46fd-a605-c01743a5265e\r\nState : Existing\r\n\r\nPS C:> Get-OBPolicy | Get-OBFileSpec\r\nFileName : *\r\nFilePath : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\r\nFileSpec : D:\\\r\nIsExclude : False\r\nIsRecursive : True\r\n\r\nFileName : *\r\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\\r\nFileSpec : C:\\\r\nIsExclude : False\r\nIsRecursive : True\r\n\r\nFileName : *\r\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\windows\r\nFileSpec : C:\\windows\r\nIsExclude : True\r\nIsRecursive : True\r\n\r\nFileName : *\r\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\temp\r\nFileSpec : C:\\temp\r\nIsExclude : True\r\nIsRecursive : True\r\n```\r\n\r\n### <a name=\"performing-an-ad-hoc-backup\"></a>执行即席备份\r\n设置备份策略之后，会根据计划进行备份。 也可以使用 [Start-OBBackup](https://technet.microsoft.com/library/hh770426) cmdlet 来触发即席备份：\r\n\r\n```\r\nPS C:> Get-OBPolicy | Start-OBBackup\r\nTaking snapshot of volumes...\r\nPreparing storage...\r\nEstimating size of backup items...\r\nEstimating size of backup items...\r\nTransferring data...\r\nVerifying backup...\r\nJob completed.\r\nThe backup operation completed successfully.\r\n```\r\n\r\n## <a name=\"restore-data-from-azure-backup\"></a>从 Azure 备份还原数据\r\n本部分将引导完成自动从 Azure 备份恢复数据的步骤。 此过程涉及以下步骤：\r\n\r\n1. 选取源卷\r\n2. 选择要还原的备份点\r\n3. 选择要还原的项\r\n4. 触发还原过程\r\n\r\n### <a name=\"picking-the-source-volume\"></a>选取源卷\r\n若要从 Azure 备份还原某个项，需要先识别该项的源。 由于我们要在 Windows Server 或 Windows 客户端的上下文中执行命令，因此已识别了计算机。 识别源的下一步是识别它所在的卷。 运行 [Get-OBRecoverableSource](https://technet.microsoft.com/library/hh770410) cmdlet 可以检索正在从此计算机备份的卷或源的列表。 此命令将返回从此服务器/客户端备份的所有源的数组。\r\n\r\n```\r\nPS C:> $source = Get-OBRecoverableSource\r\nPS C:> $source\r\nFriendlyName : C:\\\r\nRecoverySourceName : C:\\\r\nServerName : myserver.microsoft.com\r\n\r\nFriendlyName : D:\\\r\nRecoverySourceName : D:\\\r\nServerName : myserver.microsoft.com\r\n```\r\n\r\n### <a name=\"choosing-a-backup-point-to-restore\"></a>选择要还原的备份点\r\n结合适当的参数运行 [Get-OBRecoverableItem](https://technet.microsoft.com/library/hh770399.aspx) cmdlet 可以检索备份点列表。 在本示例中，我们选择源卷 *D:* 的最新备份点，并使用它还原特定的文件。\r\n\r\n```\r\nPS C:> $rps = Get-OBRecoverableItem -Source $source[1]\r\nIsDir : False\r\nItemNameFriendly : D:\\\r\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\r\nLocalMountPoint : D:\\\r\nMountPointName : D:\\\r\nName : D:\\\r\nPointInTime : 18-Jun-15 6:41:52 AM\r\nServerName : myserver.microsoft.com\r\nItemSize :\r\nItemLastModifiedTime :\r\n\r\nIsDir : False\r\nItemNameFriendly : D:\\\r\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\r\nLocalMountPoint : D:\\\r\nMountPointName : D:\\\r\nName : D:\\\r\nPointInTime : 17-Jun-15 6:31:31 AM\r\nServerName : myserver.microsoft.com\r\nItemSize :\r\nItemLastModifiedTime :\r\n```\r\n对象 ```$rps``` 是备份点数组。 第一个元素是最新备份点，第 N 个元素是最旧的备份点。 为了选择最新的点，我们会使用 ```$rps[0]```。\r\n\r\n### <a name=\"choosing-an-item-to-restore\"></a>选择要还原的项\r\n为了识别要还原的确切文件或文件夹，请以递归方式使用 [Get-OBRecoverableItem](https://technet.microsoft.com/library/hh770399.aspx) cmdlet。 这样，只需使用 ```Get-OBRecoverableItem```便可浏览文件夹层次结构。\r\n\r\n在本示例中，如果我们要还原文件 finances.xls，可以使用对象 ```$filesFolders[1]``` 引用该文件。\r\n\r\n```\r\nPS C:> $filesFolders = Get-OBRecoverableItem $rps[0]\r\nPS C:> $filesFolders\r\nIsDir : True\r\nItemNameFriendly : D:\\MyData\\\r\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\\r\nLocalMountPoint : D:\\\r\nMountPointName : D:\\\r\nName : MyData\r\nPointInTime : 18-Jun-15 6:41:52 AM\r\nServerName : myserver.microsoft.com\r\nItemSize :\r\nItemLastModifiedTime : 15-Jun-15 8:49:29 AM\r\n\r\nPS C:> $filesFolders = Get-OBRecoverableItem $filesFolders[0]\r\nPS C:> $filesFolders\r\nIsDir : False\r\nItemNameFriendly : D:\\MyData\\screenshot.oxps\r\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\screenshot.oxps\r\nLocalMountPoint : D:\\\r\nMountPointName : D:\\\r\nName : screenshot.oxps\r\nPointInTime : 18-Jun-15 6:41:52 AM\r\nServerName : myserver.microsoft.com\r\nItemSize : 228313\r\nItemLastModifiedTime : 21-Jun-14 6:45:09 AM\r\n\r\nIsDir : False\r\nItemNameFriendly : D:\\MyData\\finances.xls\r\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\finances.xls\r\nLocalMountPoint : D:\\\r\nMountPointName : D:\\\r\nName : finances.xls\r\nPointInTime : 18-Jun-15 6:41:52 AM\r\nServerName : myserver.microsoft.com\r\nItemSize : 96256\r\nItemLastModifiedTime : 21-Jun-14 6:43:02 AM\r\n```\r\n\r\n也可以使用 ```Get-OBRecoverableItem``` cmdlet 来搜索要还原的项。 在本示例中，为了搜索 *finances.xls* ，我们可以运行以下命令来获取该文件上的句柄：\r\n\r\n```\r\nPS C:\\> $item = Get-OBRecoverableItem -RecoveryPoint $rps[0] -Location \"D:\\MyData\" -SearchString \"finance*\"\r\n```\r\n\r\n### <a name=\"triggering-the-restore-process\"></a>触发还原过程\r\n为了触发还原过程，首先需要指定恢复选项。 这可以使用 [New-OBRecoveryOption](https://technet.microsoft.com/library/hh770417.aspx) cmdlet 来完成。 在本示例中，我们假设要将文件还原到 C:\\temp。此外，我们假设要跳过目标文件夹 C:\\temp 中已存在的文件。若要创建此类恢复选项，请使用以下命令：\r\n\r\n```\r\nPS C:\\> $recovery_option = New-OBRecoveryOption -DestinationPath \"C:\\temp\" -OverwriteType Skip\r\n```\r\n\r\n现在，请对 ```Get-OBRecoverableItem``` cmdlet 输出中的选定 ```$item``` 使用 [Start-OBRecovery](https://technet.microsoft.com/library/hh770402.aspx) 命令，触发还原：\r\n\r\n```\r\nPS C:\\> Start-OBRecovery -RecoverableItem $item -RecoveryOption $recover_option\r\nEstimating size of backup items...\r\nEstimating size of backup items...\r\nEstimating size of backup items...\r\nEstimating size of backup items...\r\nJob completed.\r\nThe recovery operation completed successfully.\r\n```\r\n\r\n\r\n## <a name=\"uninstalling-the-azure-backup-agent\"></a>卸载 Azure 备份代理\r\n可以使用以下命令卸载 Azure 备份代理：\r\n\r\n```\r\nPS C:\\> .\\MARSAgentInstaller.exe /d /q\r\n```\r\n\r\n若要从计算机中卸载代理二进制文件，请注意以下部分后果：\r\n\r\n- 这会从计算机中删除文件筛选器，并停止跟踪更改。\r\n- 将从计算机中删除所有策略信息，但服务中会继续存储这些策略信息。\r\n- 将删除所有备份计划，且不会进一步创建备份。\r\n\r\n不过，Azure 中存储的数据会根据你设置的保留策略继续保留。 较旧的恢复点会自动过时。\r\n\r\n## <a name=\"remote-management\"></a>远程管理\r\n围绕 Azure 备份代理、策略和数据源的所有管理工作都可通过 Azure PowerShell 远程完成。 要远程管理的计算机需要经过适当的准备。\r\n\r\n默认情况下，WinRM 服务已配置为手动启动。 必须将启动类型设置为“自动”，并且应该启动该服务。 若要确认 WinRM 服务正在运行，“状态”属性的值应该是“正在运行” 。\r\n\r\n```\r\nPS C:\\> Get-Service WinRM\r\n\r\nStatus   Name               DisplayName\r\n------   ----               -----------\r\nRunning  winrm              Windows Remote Management (WS-Manag...\r\n```\r\n\r\n应该针对远程管理配置 PowerShell。\r\n\r\n```\r\nPS C:\\> Enable-PSRemoting -force\r\nWinRM is already set up to receive requests on this computer.\r\nWinRM has been updated for remote management.\r\nWinRM firewall exception enabled.\r\n\r\nPS C:\\> Set-ExecutionPolicy unrestricted -force\r\n```\r\n\r\n现在可以远程管理计算机 - 从代理的安装开始。 例如，以下脚本会将代理复制到远程计算机并安装代理。\r\n\r\n```\r\nPS C:\\> $dloc = \"\\\\REMOTESERVER01\\c$\\Windows\\Temp\"\r\nPS C:\\> $agent = \"\\\\REMOTESERVER01\\c$\\Windows\\Temp\\MARSAgentInstaller.exe\"\r\nPS C:\\> $args = \"/q\"\r\nPS C:\\> Copy-Item \"C:\\Downloads\\MARSAgentInstaller.exe\" -Destination $dloc - force\r\n\r\nPS C:\\> $s = New-PSSession -ComputerName REMOTESERVER01\r\nPS C:\\> Invoke-Command -Session $s -Script { param($d, $a) Start-Process -FilePath $d $a -Wait } -ArgumentList $agent $args\r\n```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n有关适用于 Windows Server/客户端的 Azure 备份的详细信息，请参阅\r\n\r\n- [Azure 备份简介](backup-introduction-to-azure-backup.md)\r\n- [备份 Windows Server](backup-configure-vault.md)\r\n\r\n<!--Update_Description: wording update -->\r\n"}