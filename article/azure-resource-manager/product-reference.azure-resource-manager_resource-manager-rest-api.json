{"Title":"Resource Manager REST API","Description":"概述 Resource Manager REST API 身份验证和用例","Content":"# Resource Manager REST API\r\n<a name=\"resource-manager-rest-apis\" ></a>\r\n> [!div class=\"op_single_selector\"]\r\n> * [Azure PowerShell](powershell-azure-resource-manager.md)\r\n> * [Azure CLI](xplat-cli-azure-resource-manager.md)\r\n> * [门户](resource-group-portal.md) \r\n> * [REST API](resource-manager-rest-api.md)\r\n> \r\n> \r\n\r\n在每次调用 Azure Resource Manager、每次部署模板以及每次配置存储帐户时，都会对 Azure Resource Manager 的 RESTful API 进行一次或多次调用。 本主题专门介绍这些 API 以及如何在完全不使用任何 SDK 的情况下调用它们。 如果想要完全控制对 Azure 发出的请求，或者偏好语言的 SDK 不可用或不支持所需的操作，这种方法可能十分有用。\r\n\r\n本文不逐一介绍 Azure 中公开的每个 API，而是使用某些操作举例说明如何连接到这些 API。 了解基础知识后，可继续阅读 [Azure Resource Manager REST API Reference](https://docs.microsoft.com/rest/api/resources/) （Azure Resource Manager REST API 参考），查找有关如何使用其余 API 的详细信息。\r\n\r\n## 身份验证\r\n<a name=\"authentication\" ></a>\r\nResource Manager 的身份验证由 Azure Active Directory (Azure AD) 处理。 若要连接到任何 API，首先需要使用 Azure AD 进行身份验证，接收可传递给每个请求的身份验证令牌。 由于我们讨论的是如何直接对 REST API 进行单纯调用，因此假设你不想要根据用户名和密码提示进行身份验证。 另外，假设你不使用双重身份验证机制。 因此，我们将创建用于登录的所谓 Azure AD 应用程序和服务主体。 但请记住，Azure AD 支持多个身份验证过程，而这些过程全都可用于检索后续 API 请求所需的身份验证令牌。\r\n有关分步说明，请参阅 [Create Azure AD Application and Service Principal](resource-group-create-service-principal-portal.md)（创建 Azure AD 应用程序和服务主体）。\r\n\r\n### 生成访问令牌\r\n<a name=\"generating-an-access-token\" ></a>\r\n通过调用位于 login.chinacloudapi.cn 的 Azure AD 来对 Azure AD 进行身份验证。 若要进行身份验证，需要提供以下信息：\r\n\r\n* Azure AD 租户 ID（用于登录的 Azure AD 名称，通常与你的公司同名，但不一定总是如此）\r\n* 应用程序 ID（在创建 Azure AD 应用程序期间获取）\r\n* 密码（在创建 Azure AD 应用程序时选择）\r\n\r\n在以下 HTTP 请求中，请确保将“Azure AD Tenant ID”、“Application ID”和“Password”替换为正确的值。\r\n\r\n**常规 HTTP 请求：**\r\n\r\n```HTTP\r\nPOST /<Azure AD Tenant ID>/oauth2/token?api-version=1.0 HTTP/1.1 HTTP/1.1\r\nHost: login.chinacloudapi.cn\r\nCache-Control: no-cache\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\ngrant_type=client_credentials&resource=https%3A%2F%2Fmanagement.core.chinacloudapi.cn%2F&client_id=<Application ID>&client_secret=<Password>\r\n```\r\n\r\n... 将（如果身份验证成功）导致类似于下面的响应：\r\n\r\n```json\r\n{\r\n  \"token_type\": \"Bearer\",\r\n  \"expires_in\": \"3600\",\r\n  \"expires_on\": \"1448199959\",\r\n  \"not_before\": \"1448196059\",\r\n  \"resource\": \"https://management.core.chinacloudapi.cn/\",\r\n  \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhb...86U3JI_0InPUk_lZqWvKiEWsayA\"\r\n}\r\n```\r\n（为了方便阅读，上述响应中的 access_token 已缩短）\r\n\r\n**使用 Bash 生成访问令牌：**\r\n\r\n```console\r\ncurl -X POST -H \"Content-Type: application/x-www-form-urlencoded\" -d \"grant_type=client_credentials&resource=https://management.core.chinacloudapi.cn/&client_id=<application id>&client_secret=<password you selected for authentication>\" https://login.chinacloudapi.cn/<Azure AD Tenant ID>/oauth2/token?api-version=1.0\r\n```\r\n\r\n**使用 PowerShell 生成访问令牌：**\r\n\r\n```powershell\r\nInvoke-RestMethod -Uri https://login.chinacloudapi.cn/<Azure AD Tenant ID>/oauth2/token?api-version=1.0 -Method Post\r\n -Body @{\"grant_type\" = \"client_credentials\"; \"resource\" = \"https://management.core.chinacloudapi.cn/\"; \"client_id\" = \"<application id>\"; \"client_secret\" = \"<password you selected for authentication>\" }\r\n```\r\n\r\n响应包含访问令牌和令牌有效期限的相关信息，以及可以将该令牌用于哪项资源的相关信息。\r\n在前面的 HTTP 调用中收到的访问令牌必须针对所有请求传递到 Resource Manager API。 请将它作为名为“Authorization”、值为“Bearer YOUR_ACCESS_TOKEN”的标头值传递。 请注意“Bearer”与访问令牌之间有空格。\r\n\r\n从上面的 HTTP 结果可以看到，令牌在特定时间段内保持有效状态，你应在这段期间缓存并重复使用同一令牌。 即使你可以在每次调用 API 时对 Azure AD 进行身份验证，但这样做的效率很低。\r\n\r\n## 调用 Resource Manager REST API\r\n<a name=\"calling-resource-manager-rest-apis\" ></a>\r\n本主题只使用几个 API 来说明 REST 操作的基本用法。 有关所有操作的信息，请参阅 [Azure Resource Manager REST API](https://docs.microsoft.com/rest/api/resources/)。\r\n\r\n### 列出所有订阅\r\n<a name=\"list-all-subscriptions\" ></a>\r\n可以执行的最简单操作之一是列出可以访问的可用订阅。 在以下请求中，可以看到如何以标头的形式传入访问令牌：\r\n\r\n（将 YOUR_ACCESS_TOKEN 替换为实际访问令牌。）\r\n\r\n```HTTP\r\nGET /subscriptions?api-version=2015-01-01 HTTP/1.1\r\nHost: management.chinacloudapi.cn\r\nAuthorization: Bearer YOUR_ACCESS_TOKEN\r\nContent-Type: application/json\r\n```\r\n\r\n...因此，会收到此服务主体可以访问的订阅列表\r\n\r\n（为方便阅读，订阅 ID 已缩短）\r\n\r\n```json\r\n{\r\n  \"value\": [\r\n    {\r\n      \"id\": \"/subscriptions/3a8555...555995\",\r\n      \"subscriptionId\": \"3a8555...555995\",\r\n      \"displayName\": \"Azure Subscription\",\r\n      \"state\": \"Enabled\",\r\n      \"subscriptionPolicies\": {\r\n        \"locationPlacementId\": \"Internal_2014-09-01\",\r\n        \"quotaId\": \"Internal_2014-09-01\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### 列出特定订阅中的所有资源组\r\n<a name=\"list-all-resource-groups-in-a-specific-subscription\" ></a>\r\n适用于 Resource Manager API 的所有资源嵌套在资源组中。 可以使用以下 HTTP GET 请求，在 Resource Manager 中查询订阅中现有的资源组。 请注意这一次如何将订阅 ID 作为 URL 的一部分传入。\r\n\r\n（将 YOUR_ACCESS_TOKEN 和 SUBSCRIPTION_ID 替换为实际的访问令牌和订阅 ID）\r\n\r\n```HTTP\r\nGET /subscriptions/SUBSCRIPTION_ID/resourcegroups?api-version=2015-01-01 HTTP/1.1\r\nHost: management.chinacloudapi.cn\r\nAuthorization: Bearer YOUR_ACCESS_TOKEN\r\nContent-Type: application/json\r\n```\r\n\r\n收到的响应取决于是否已定义任何资源组以及定义了多少个（如果已定义）。\r\n\r\n（为方便阅读，订阅 ID 已缩短）\r\n\r\n```json\r\n{\r\n    \"value\": [\r\n        {\r\n            \"id\": \"/subscriptions/3a8555...555995/resourceGroups/myfirstresourcegroup\",\r\n            \"name\": \"myfirstresourcegroup\",\r\n            \"location\": \"chinaeast\",\r\n            \"properties\": {\r\n                \"provisioningState\": \"Succeeded\"\r\n            }\r\n        },\r\n        {\r\n            \"id\": \"/subscriptions/3a8555...555995/resourceGroups/mysecondresourcegroup\",\r\n            \"name\": \"mysecondresourcegroup\",\r\n            \"location\": \"chinaeast\",\r\n            \"tags\": {\r\n                \"tagname1\": \"My first tag\"\r\n            },\r\n            \"properties\": {\r\n                \"provisioningState\": \"Succeeded\"\r\n            }\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n### 创建资源组\r\n<a name=\"create-a-resource-group\" ></a>\r\n到目前为止，我们只是通过 Resource Manager API 查询了信息。 接下来可以创建一些资源。让我们从最简单的资源组开始。 以下 HTTP 请求在所选的区域/位置创建一个资源组并在其中添加一个标记。\r\n\r\n（将 YOUR_ACCESS_TOKEN、SUBSCRIPTION_ID、RESOURCE_GROUP_NAME 替换为实际的访问令牌、订阅 ID 和要创建的资源组名称）\r\n\r\n```HTTP\r\nPUT /subscriptions/SUBSCRIPTION_ID/resourcegroups/RESOURCE_GROUP_NAME?api-version=2015-01-01 HTTP/1.1\r\nHost: management.chinacloudapi.cn\r\nAuthorization: Bearer YOUR_ACCESS_TOKEN\r\nContent-Type: application/json\r\n\r\n{\r\n  \"location\": \"chinaeast\",\r\n  \"tags\": {\r\n    \"tagname1\": \"test-tag\"\r\n  }\r\n}\r\n```\r\n\r\n如果成功，将返回类似于下面的响应：\r\n\r\n```json\r\n{\r\n  \"id\": \"/subscriptions/3a8555...555995/resourceGroups/RESOURCE_GROUP_NAME\",\r\n  \"name\": \"RESOURCE_GROUP_NAME\",\r\n  \"location\": \"chinaeast\",\r\n  \"tags\": {\r\n    \"tagname1\": \"test-tag\"\r\n  },\r\n  \"properties\": {\r\n    \"provisioningState\": \"Succeeded\"\r\n  }\r\n}\r\n```\r\n\r\n现已在 Azure 中成功创建一个资源组。 祝贺你！\r\n\r\n### 使用 Resource Manager 模板将资源部署到资源组\r\n<a name=\"deploy-resources-to-a-resource-group-using-a-resource-manager-template\" ></a>\r\n在 Resource Manager 中，可以使用模板部署资源。 模板定义多个资源及其依赖项。 本部分假设读者熟悉 Resource Manager 模板，演示如何进行 API 调用以开始部署。 有关构造模板的详细信息，请参阅[创作 Azure Resource Manager 模板](resource-group-authoring-templates.md)。\r\n\r\n模板的部署与调用其他 API 的方式并没有太大差别。 一个重要方面就是模板部署需要相当长的时间。 API 调用只会返回，开发人员需负责查询部署状态，了解部署何时完成。 有关详细信息，请参阅[跟踪异步 Azure 操作](resource-manager-async-operations.md)。\r\n\r\n本示例使用 [GitHub](https://github.com/Azure/azure-quickstart-templates)上提供的一个公开模板。 使用的模板将 Linux VM 部署到中国北部区域。 尽管本示例使用了公共存储库（如 GitHub）中提供的模板，但你也可以传递整个模板作为请求的一部分。 请注意，在请求中提供的值是部署的模板中使用的值。\r\n\r\n（将 SUBSCRIPTION_ID、RESOURCE_GROUP_NAME、DEPLOYMENT_NAME、YOUR_ACCESS_TOKEN、GLOBALY_UNIQUE_STORAGE_ACCOUNT_NAME、ADMIN_USER_NAME、ADMIN_PASSWORD 和 DNS_NAME_FOR_PUBLIC_IP 替换为请求适用的值）\r\n\r\n```HTTP\r\nPUT /subscriptions/SUBSCRIPTION_ID/resourcegroups/RESOURCE_GROUP_NAME/providers/microsoft.resources/deployments/DEPLOYMENT_NAME?api-version=2015-01-01 HTTP/1.1\r\nHost: management.chinacloudapi.cn\r\nAuthorization: Bearer YOUR_ACCESS_TOKEN\r\nContent-Type: application/json\r\n\r\n{\r\n  \"properties\": {\r\n    \"templateLink\": {\r\n      \"uri\": \"https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-simple-linux-vm/azuredeploy.json\",\r\n      \"contentVersion\": \"1.0.0.0\",\r\n    },\r\n    \"mode\": \"Incremental\",\r\n    \"parameters\": {\r\n        \"newStorageAccountName\": {\r\n          \"value\": \"GLOBALY_UNIQUE_STORAGE_ACCOUNT_NAME\"\r\n        },\r\n        \"adminUsername\": {\r\n          \"value\": \"ADMIN_USER_NAME\"\r\n        },\r\n        \"adminPassword\": {\r\n          \"value\": \"ADMIN_PASSWORD\"\r\n        },\r\n        \"dnsNameForPublicIP\": {\r\n          \"value\": \"DNS_NAME_FOR_PUBLIC_IP\"\r\n        },\r\n        \"ubuntuOSVersion\": {\r\n          \"value\": \"15.04\"\r\n        }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n为方便阅读本文档，此处省略了此请求的较长 JSON 响应。 响应中包含创建的样板化部署的相关信息。\r\n\r\n## 后续步骤\r\n<a name=\"next-steps\" ></a>\r\n\r\n- 若要了解如何处理异步 REST 操作，请参阅[跟踪异步 Azure 操作](resource-manager-async-operations.md)。"}