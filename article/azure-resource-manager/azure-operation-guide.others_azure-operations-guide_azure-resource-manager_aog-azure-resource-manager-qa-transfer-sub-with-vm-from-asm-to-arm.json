{"Title":"从 ASM 升级到 ARM 的虚拟机在进行跨订阅迁移时报错","Description":"解决当尝试将 Azure 资源组迁移到另外一个订阅，而资源组中包含有从 ASM 迁移到 ARM 的虚拟机时的报错问题","Content":"\r\n# 从 ASM 升级到 ARM 的虚拟机在进行跨订阅迁移时报错\r\n\r\n## 问题描述\r\n\r\n当您尝试在将 Azure 资源组迁移到另外一个订阅，而资源组中包含有从 ASM 迁移到 ARM 的虚拟机,这种情况下，您可能收到报错如下：\r\n\r\n```\r\n“移动资源请求包含由请求中一个或多个 VM 引用的 KeyVault 资源。跨订阅移动中当前不支持此操作。请查看 KeyVault 资源 ID 的错误详细信息 （代码：CrossSubscriptionMoveWithKeyVaultResources）”\r\n“The Move resources request contains KeyVault resources which are referenced by one or more VMs in the request“\r\n```\r\n\r\n![01](media/aog-azure-resource-manager-qa-transfer-sub-with-vm-from-asm-to-arm/01.png)\r\n\r\n## 问题分析\r\n\r\nASM 模式下的云服务启用的证书 (每个云服务有一个证书) 在迁移到 ARM 模式后，被转移到 Azure 密钥保管库 (Key Vault)下，而虚拟机将会引用该密钥保管库中的证书。但被虚拟机引用的 Key Vault 无法进行跨订阅迁移，从而导致错误发生。\r\n\r\n## 解决方法\r\n\r\n在迁移之前去除虚拟机对这些证书的引用。\r\n\r\n```PowerShell\r\n$vmName = \"vmName\"\r\n$rgName = \"rgName\"\r\n$vm = Get-AzureRmVM -ResourceGroupName $rgName -Name $vmName\r\n$vm.OSProfile.Secrets = New-Object -TypeName \"System.Collections.Generic.List[Microsoft.Azure.Management.Compute.Models.VaultSecretGroup]\"\r\nUpdate-AzureRmVM -ResourceGroupName $rgName -VM $vm -Debug\r\n```\r\n\r\n> [!NOTE]\r\n> 请正确定义:\r\n> $vmname: 虚拟机名\r\n> $rgName: 资源组名\r\n\r\n您也可以使用 CLI 2.0 :\r\n\r\n```Azure CLI\r\naz vm update -g rgname -n vmname --set osProfile.Secrets=[]\r\n```\r\n\r\n成功去除虚拟机对证书的引用后请再次尝试迁移。"}