{"Title":"Azure Resource Manager 模板函数 - 部署","Description":"介绍可在 Azure Resource Manager 模板中使用的用于检索部署信息的函数。","Content":"# <a name=\"deployment-functions-for-azure-resource-manager-templates\"></a>用于 Azure Resource Manager 模板的部署函数 \r\n\r\nResource Manager 提供以下函数，用于从与部署相关的模板和值部分获取值：\r\n\r\n* [部署](#deployment)\r\n* [参数](#parameters)\r\n* [variables](#variables)\r\n\r\n若要从资源、资源组或订阅获取值，请参阅 [Resource functions](resource-group-template-functions-resource.md)（资源函数）。\r\n\r\n<a id=\"deployment\" />\r\n\r\n## <a name=\"deployment\"></a>部署\r\n`deployment()`\r\n\r\n返回有关当前部署操作的信息。\r\n\r\n### <a name=\"return-value\"></a>返回值\r\n\r\n此函数返回部署期间传递的对象。 根据部署对象是作为链接还是内联对象传递，所返回对象中的属性将有所不同。 如果部署对象是以内联形式传递的（例如使用 Azure PowerShell 中的 **-TemplateFile** 参数指向本地文件时），所返回的对象采用以下格式：\r\n\r\n```json\r\n{\r\n    \"name\": \"\",\r\n    \"properties\": {\r\n        \"template\": {\r\n            \"$schema\": \"\",\r\n            \"contentVersion\": \"\",\r\n            \"parameters\": {},\r\n            \"variables\": {},\r\n            \"resources\": [\r\n            ],\r\n            \"outputs\": {}\r\n        },\r\n        \"parameters\": {},\r\n        \"mode\": \"\",\r\n        \"provisioningState\": \"\"\r\n    }\r\n}\r\n```\r\n\r\n如果对象是以链接形式传递的（例如使用 **-TemplateUri** 参数指向远程文件时），所返回的对象采用以下格式： \r\n\r\n```json\r\n{\r\n    \"name\": \"\",\r\n    \"properties\": {\r\n        \"templateLink\": {\r\n            \"uri\": \"\"\r\n        },\r\n        \"template\": {\r\n            \"$schema\": \"\",\r\n            \"contentVersion\": \"\",\r\n            \"parameters\": {},\r\n            \"variables\": {},\r\n            \"resources\": [],\r\n            \"outputs\": {}\r\n        },\r\n        \"parameters\": {},\r\n        \"mode\": \"\",\r\n        \"provisioningState\": \"\"\r\n    }\r\n}\r\n```\r\n\r\n### <a name=\"remarks\"></a>备注\r\n\r\n如何根据父模板的 URI，使用 deployment() 链接到另一个模板。\r\n\r\n```json\r\n\"variables\": {  \r\n    \"sharedTemplateUrl\": \"[uri(deployment().properties.templateLink.uri, 'shared-resources.json')]\"  \r\n}\r\n```  \r\n\r\n### <a name=\"example\"></a>示例\r\n\r\n下面的[示例模板](https://github.com/Azure/azure-docs-json-samples/blob/master/azure-resource-manager/functions/deployment.json)返回部署对象：\r\n\r\n```json\r\n{\r\n    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n    \"contentVersion\": \"1.0.0.0\",\r\n    \"resources\": [],\r\n    \"outputs\": {\r\n        \"subscriptionOutput\": {\r\n            \"value\": \"[deployment()]\",\r\n            \"type\" : \"object\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n前面的示例返回以下对象：\r\n\r\n```json\r\n{\r\n  \"name\": \"deployment\",\r\n  \"properties\": {\r\n    \"template\": {\r\n      \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n      \"contentVersion\": \"1.0.0.0\",\r\n      \"resources\": [],\r\n      \"outputs\": {\r\n        \"subscriptionOutput\": {\r\n          \"type\": \"Object\",\r\n          \"value\": \"[deployment()]\"\r\n        }\r\n      }\r\n    },\r\n    \"parameters\": {},\r\n    \"mode\": \"Incremental\",\r\n    \"provisioningState\": \"Accepted\"\r\n  }\r\n}\r\n```\r\n\r\n要使用 Azure CLI 部署此示例模板，请使用：\r\n\r\n```azurecli\r\naz group deployment create -g functionexamplegroup --template-uri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/deployment.json\r\n```\r\n\r\n要使用 PowerShell 部署此示例模板，请使用：\r\n\r\n```powershell\r\nNew-AzureRmResourceGroupDeployment -ResourceGroupName functionexamplegroup -TemplateUri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/deployment.json\r\n```\r\n\r\n<a id=\"parameters\" />\r\n\r\n## <a name=\"parameters\"></a>参数\r\n`parameters(parameterName)`\r\n\r\n返回一个参数值。 指定的参数名称必须已在模板的 parameters 节中定义。\r\n\r\n### <a name=\"parameters\"></a>Parameters\r\n\r\n| 参数 | 必选 | 类型 | 说明 |\r\n|:--- |:--- |:--- |:--- |\r\n| parameterName |是 |字符串 |要返回的参数名称。 |\r\n\r\n### <a name=\"return-value\"></a>返回值\r\n\r\n指定的参数的值。\r\n\r\n### <a name=\"remarks\"></a>备注\r\n\r\n通常，使用参数设置资源值。 以下示例将 Web 站点的名称设置为在部署过程中传递的参数值。\r\n\r\n```json\r\n\"parameters\": { \r\n  \"siteName\": {\r\n      \"type\": \"string\"\r\n  }\r\n},\r\n\"resources\": [\r\n   {\r\n      \"apiVersion\": \"2016-08-01\",\r\n      \"name\": \"[parameters('siteName')]\",\r\n      \"type\": \"Microsoft.Web/Sites\",\r\n      ...\r\n   }\r\n]\r\n```\r\n\r\n### <a name=\"example\"></a>示例\r\n\r\n以下[示例模板](https://github.com/Azure/azure-docs-json-samples/blob/master/azure-resource-manager/functions/parameters.json)演示了 parameters 函数的简化用法。\r\n\r\n```json\r\n{\r\n    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n    \"contentVersion\": \"1.0.0.0\",\r\n    \"parameters\": {\r\n        \"stringParameter\": {\r\n            \"type\" : \"string\",\r\n            \"defaultValue\": \"option 1\"\r\n        },\r\n        \"intParameter\": {\r\n            \"type\": \"int\",\r\n            \"defaultValue\": 1\r\n        },\r\n        \"objectParameter\": {\r\n            \"type\": \"object\",\r\n            \"defaultValue\": {\"one\": \"a\", \"two\": \"b\"}\r\n        },\r\n        \"arrayParameter\": {\r\n            \"type\": \"array\",\r\n            \"defaultValue\": [1, 2, 3]\r\n        },\r\n        \"crossParameter\": {\r\n            \"type\": \"string\",\r\n            \"defaultValue\": \"[parameters('stringParameter')]\"\r\n        }\r\n    },\r\n    \"variables\": {},\r\n    \"resources\": [],\r\n    \"outputs\": {\r\n        \"stringOutput\": {\r\n            \"value\": \"[parameters('stringParameter')]\",\r\n            \"type\" : \"string\"\r\n        },\r\n        \"intOutput\": {\r\n            \"value\": \"[parameters('intParameter')]\",\r\n            \"type\" : \"int\"\r\n        },\r\n        \"objectOutput\": {\r\n            \"value\": \"[parameters('objectParameter')]\",\r\n            \"type\" : \"object\"\r\n        },\r\n        \"arrayOutput\": {\r\n            \"value\": \"[parameters('arrayParameter')]\",\r\n            \"type\" : \"array\"\r\n        },\r\n        \"crossOutput\": {\r\n            \"value\": \"[parameters('crossParameter')]\",\r\n            \"type\" : \"string\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n上述示例中使用默认值的输出为：\r\n\r\n| 名称 | 类型 | 值 |\r\n| ---- | ---- | ----- |\r\n| stringOutput | String | 选项 1 |\r\n| intOutput | int | 1 |\r\n| objectOutput | 对象 | {\"one\": \"a\", \"two\": \"b\"} |\r\n| arrayOutput | Array | [1, 2, 3] |\r\n| crossOutput | String | 选项 1 |\r\n\r\n要使用 Azure CLI 部署此示例模板，请使用：\r\n\r\n```azurecli\r\naz group deployment create -g functionexamplegroup --template-uri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/parameters.json\r\n```\r\n\r\n要使用 PowerShell 部署此示例模板，请使用：\r\n\r\n```powershell\r\nNew-AzureRmResourceGroupDeployment -ResourceGroupName functionexamplegroup -TemplateUri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/parameters.json\r\n```\r\n\r\n<a id=\"variables\" />\r\n\r\n## <a name=\"variables\"></a>variables\r\n`variables(variableName)`\r\n\r\n返回变量的值。 指定的变量名称必须已在模板的 variables 节中定义。\r\n\r\n### <a name=\"parameters\"></a>Parameters\r\n\r\n| 参数 | 必选 | 类型 | 说明 |\r\n|:--- |:--- |:--- |:--- |\r\n| variableName |是 |字符串 |要返回的变量名称。 |\r\n\r\n### <a name=\"return-value\"></a>返回值\r\n\r\n指定的变量的值。\r\n\r\n### <a name=\"remarks\"></a>备注\r\n\r\n通常，使用变量通过只构造一次复杂值来简化模板。 以下示例构造存储帐户的唯一名称。\r\n\r\n```json\r\n\"variables\": {\r\n    \"storageName\": \"[concat('storage', uniqueString(resourceGroup().id))]\"\r\n},\r\n\"resources\": [\r\n    {\r\n        \"type\": \"Microsoft.Storage/storageAccounts\",\r\n        \"name\": \"[variables('storageName')]\",\r\n        ...\r\n    },\r\n    {\r\n        \"type\": \"Microsoft.Compute/virtualMachines\",\r\n        \"dependsOn\": [\r\n            \"[variables('storageName')]\"\r\n        ],\r\n        ...\r\n    }\r\n],\r\n```\r\n\r\n### <a name=\"example\"></a>示例\r\n\r\n以下[示例模板](https://github.com/Azure/azure-docs-json-samples/blob/master/azure-resource-manager/functions/variables.json)返回了不同的变量值。\r\n\r\n```json\r\n{\r\n    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n    \"contentVersion\": \"1.0.0.0\",\r\n    \"parameters\": {},\r\n    \"variables\": {\r\n        \"var1\": \"myVariable\",\r\n        \"var2\": [ 1,2,3,4 ],\r\n        \"var3\": \"[ variables('var1') ]\",\r\n        \"var4\": {\r\n            \"property1\": \"value1\",\r\n            \"property2\": \"value2\"\r\n        }\r\n    },\r\n    \"resources\": [],\r\n    \"outputs\": {\r\n        \"exampleOutput1\": {\r\n            \"value\": \"[variables('var1')]\",\r\n            \"type\" : \"string\"\r\n        },\r\n        \"exampleOutput2\": {\r\n            \"value\": \"[variables('var2')]\",\r\n            \"type\" : \"array\"\r\n        },\r\n        \"exampleOutput3\": {\r\n            \"value\": \"[variables('var3')]\",\r\n            \"type\" : \"string\"\r\n        },\r\n        \"exampleOutput4\": {\r\n            \"value\": \"[variables('var4')]\",\r\n            \"type\" : \"object\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n上述示例中使用默认值的输出为：\r\n\r\n| 名称 | 类型 | 值 |\r\n| ---- | ---- | ----- |\r\n| exampleOutput1 | String | myVariable |\r\n| exampleOutput2 | Array | [1, 2, 3, 4] |\r\n| exampleOutput3 | String | myVariable |\r\n| exampleOutput4 |  对象 | {\"property1\": \"value1\", \"property2\": \"value2\"} |\r\n\r\n要使用 Azure CLI 部署此示例模板，请使用：\r\n\r\n```azurecli\r\naz group deployment create -g functionexamplegroup --template-uri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/variables.json\r\n```\r\n\r\n要使用 PowerShell 部署此示例模板，请使用：\r\n\r\n```powershell\r\nNew-AzureRmResourceGroupDeployment -ResourceGroupName functionexamplegroup -TemplateUri https://raw.githubusercontent.com/Azure/azure-docs-json-samples/master/azure-resource-manager/functions/variables.json\r\n```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n* 有关 Azure Resource Manager 模板中各部分的说明，请参阅 [Authoring Azure Resource Manager templates](resource-group-authoring-templates.md)（创作 Azure Resource Manager 模板）。\r\n* 若要合并多个模板，请参阅[将链接的模板与 Azure Resource Manager 配合使用](resource-group-linked-templates.md)。\r\n* 若要在创建资源类型时迭代指定的次数，请参阅[在 Azure Resource Manager 中创建多个资源实例](resource-group-create-multiple.md)。\r\n* 若要查看如何部署已创建的模板，请参阅[使用 Azure Resource Manager 模板部署应用程序](resource-group-template-deploy.md)。\r\n\r\n<!--Update_Description: update meta properties, add azure cli and powershell command example block-->"}