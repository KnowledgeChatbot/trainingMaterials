{"Title":"使用 PowerShell 管理 Azure 解决方案","Description":"使用 Azure PowerShell 和 Resource Manager 管理资源。","Content":"\r\n# <a name=\"manage-resources-with-azure-powershell-and-resource-manager\"></a>使用 Azure PowerShell 和 Resource Manager 管理资源\r\n\r\n本文介绍如何使用 Azure PowerShell 和 Azure Resource Manager 管理解决方案。 如果不熟悉 Resource Manager，请参阅 [Resource Manager 概述](resource-group-overview.md)。 本文重点介绍管理任务。 用户能够：\r\n\r\n1. 创建资源组\r\n2. 将资源添加到资源组\r\n3. 向资源添加标记\r\n4. 根据名称或标记值查询资源\r\n5. 向资源应用和删除锁\r\n6. 删除资源组\r\n\r\n本文不演示如何将 Resource Manager 模板部署到订阅。 有关详细信息，请参阅[使用 Resource Manager 模板和 Azure PowerShell 部署资源](resource-group-template-deploy.md)。\r\n\r\n## <a name=\"get-started-with-azure-powershell\"></a>Azure PowerShell 入门\r\n\r\n如果未安装 Azure PowerShell，请参阅[如何安装和配置 Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview)。\r\n\r\n如果过去安装了 Azure PowerShell，但最近未更新它，请考虑安装最新版本。 可通过用于安装的方法更新版本。 例如，如果使用 Web 平台安装程序，请再次启动它以查找更新。\r\n\r\n若要检查 Azure 资源模块的版本，请使用以下 cmdlet：\r\n\r\n```powershell\r\nGet-Module -ListAvailable -Name AzureRm.Resources | Select Version\r\n```\r\n\r\n本文已针对版本 3.3.0 更新。 如果使用更旧的版本，体验可能与本文中所示步骤不完全相同。 有关此版本中 cmdlet 的文档，请参阅 [AzureRM.Resources 模块](https://docs.microsoft.com/powershell/module/azurerm.resources)。\r\n\r\n## <a name=\"log-in-to-your-azure-account\"></a>登录到 Azure 帐户\r\n处理解决方案之前，必须登录到帐户。\r\n\r\n若要登录到 Azure 帐户，请使用 **Login-AzureRmAccount -EnvironmentName AzureChinaCloud** cmdlet。\r\n\r\n```powershell\r\nLogin-AzureRmAccount -EnvironmentName AzureChinaCloud\r\n```\r\n\r\n该 cmdlet 会提示你提供自己的 Azure 帐户的登录凭据。 登录后它会下载帐户设置，供 Azure PowerShell 使用。\r\n\r\n该 cmdlet 将返回有关帐户和用于任务的订阅的信息。\r\n\r\n```powershell\r\nEnvironment           : AzureChinaCloud\r\nAccount               : example@contoso.com\r\nTenantId              : {guid}\r\nSubscriptionId        : {guid}\r\nSubscriptionName      : Example Subscription One\r\nCurrentStorageAccount :\r\n\r\n```\r\n\r\n如果有多个订阅，可切换到其他订阅。 首先，请看帐户的所有订阅。\r\n\r\n```powershell\r\nGet-AzureRmSubscription\r\n```\r\n\r\n它将返回已启用和已禁用的订阅。\r\n\r\n```powershell\r\nSubscriptionName : Example Subscription One\r\nSubscriptionId   : {guid}\r\nTenantId         : {guid}\r\nState            : Enabled\r\n\r\nSubscriptionName : Example Subscription Two\r\nSubscriptionId   : {guid}\r\nTenantId         : {guid}\r\nState            : Enabled\r\n\r\nSubscriptionName : Example Subscription Three\r\nSubscriptionId   : {guid}\r\nTenantId         : {guid}\r\nState            : Disabled\r\n```\r\n\r\n若要切换到其他订阅，请使用 **Set-AzureRmContext** cmdlet 提供订阅名称。\r\n\r\n```powershell\r\nSet-AzureRmContext -SubscriptionName \"Example Subscription Two\"\r\n```\r\n\r\n## <a name=\"create-a-resource-group\"></a>创建资源组\r\n\r\n必须先创建将包含资源的资源组，才能向订阅部署任何资源。\r\n\r\n若要创建资源组，请使用 **New-AzureRmResourceGroup** cmdlet。 该命令使用 **Name** 参数指定资源组的名称，并使用 **Location** 参数指定其位置。\r\n\r\n```powershell\r\nNew-AzureRmResourceGroup -Name TestRG1 -Location \"China East\"\r\n```\r\n\r\n输入格式如下：\r\n\r\n```powershell\r\nResourceGroupName : TestRG1\r\nLocation          : chinaeast\r\nProvisioningState : Succeeded\r\nTags              :\r\nResourceId        : /subscriptions/{guid}/resourceGroups/TestRG1\r\n```\r\n\r\n如果稍后需要检索资源组，请使用以下 cmdlet：\r\n\r\n```powershell\r\nGet-AzureRmResourceGroup -ResourceGroupName TestRG1\r\n```\r\n\r\n若要获取订阅中的所有资源组，请勿指定名称：\r\n\r\n```powershell\r\nGet-AzureRmResourceGroup\r\n```\r\n\r\n## <a name=\"add-resources-to-a-resource-group\"></a>将资源添加到资源组\r\n\r\n若要将资源添加到资源组中，可使用 **New-AzureRmResource** cmdlet 或特定于要创建的资源类型的 cmdlet（例如 **New-AzureRmStorageAccount**）。 使用特定于资源类型的 cmdlet 可能更轻松，因为它包含新资源组所需属性的参数。 要使用 **New-AzureRmResource**，必须了解，不会提示而设置所有属性。\r\n\r\n但是，通过 cmdlet 添加资源可能导致将来出现混乱，因为新的资源不存在于 Resource Manager 模板中。 Azure 建议在 Resource Manager 模板中定义 Azure 解决方案的基础结构。 通过模板，可以可靠地重复部署解决方案。 本文使用 PowerShell cmdlet 创建存储帐户，但稍后从资源组生成模板。\r\n\r\n以下 cmdlet 可创建存储帐户。 请勿使用示例所示的名称，而是为存储帐户提供唯一名称。 此名称必须为 3 到 24 个字符，只能使用数字和小写字母。 如果使用示例所示名称，将收到错误，因为该名称被使用。\r\n\r\n```powershell\r\nNew-AzureRmStorageAccount -ResourceGroupName TestRG1 -AccountName mystoragename -Type \"Standard_LRS\" -Location \"China East\"\r\n```\r\n\r\n如果稍后需要检索此资源组，请使用以下 cmdlet：\r\n\r\n```powershell\r\nGet-AzureRmResource -ResourceName mystoragename -ResourceGroupName TestRG1\r\n```\r\n\r\n## <a name=\"add-a-tag\"></a>添加标记\r\n\r\n标记可用于根据属性组织资源。 例如，可能有不同资源组中的多项资源属于同一部门。 可对这些资源应用部门标签和值，将其标记为属于同一类别。 也可标记资源是用于生产环境还是测试环境。 在本文中，只对一项资源应用标记，但在环境中最好向所有资源应用标记。\r\n\r\n以下 cmdlet 将向你的存储帐户应用两个标记：\r\n\r\n```powershell\r\nSet-AzureRmResource -Tag @{ Dept=\"IT\"; Environment=\"Test\" } -ResourceName mystoragename -ResourceGroupName TestRG1 -ResourceType Microsoft.Storage/storageAccounts\r\n```\r\n\r\n各个标记作为单个对象更新。 若要向已包含标记的资源添加标记，请首先检索现有标记。 将新标记添加到包含现有标记的对象，并将所有标记重新应用到资源。\r\n\r\n```powershell\r\n$tags = (Get-AzureRmResource -ResourceName mystoragename -ResourceGroupName TestRG1).Tags\r\n$tags += @{Status=\"Approved\"}\r\nSet-AzureRmResource -Tag $tags -ResourceName mystoragename -ResourceGroupName TestRG1 -ResourceType Microsoft.Storage/storageAccounts\r\n```\r\n\r\n## <a name=\"search-for-resources\"></a>搜索资源\r\n\r\n使用 **Find-AzureRmResource** cmdlet 可按不同搜索条件检索资源。\r\n\r\n* 若要按名称获取资源，请提供 **ResourceNameContains** 参数：\r\n\r\n    ```powershell\r\n    Find-AzureRmResource -ResourceNameContains mystoragename\r\n    ```\r\n\r\n* 若要获取资源组中的所有资源，请提供 **ResourceGroupNameContains** 参数：\r\n\r\n    ```powershell\r\n    Find-AzureRmResource -ResourceGroupNameContains TestRG1\r\n    ```\r\n\r\n* 若要获取具有某个标记名称和值的所有资源，请提供 **TagName** 和 **TagValue** 参数：\r\n\r\n    ```powershell\r\n    Find-AzureRmResource -TagName Dept -TagValue IT\r\n    ```\r\n\r\n* 若要获取具有特定资源类型的所有资源，请提供 **ResourceType** 参数：\r\n\r\n    ```powershell\r\n    Find-AzureRmResource -ResourceType Microsoft.Storage/storageAccounts\r\n    ```\r\n\r\n## <a name=\"get-resource-id\"></a>获取资源 ID\r\n\r\n很多命令采用资源 ID 作为参数。 若要获取资源 ID 并将其存储在变量中，请使用：\r\n\r\n```powershell\r\n$webappID = (Get-AzureRmResource -ResourceGroupName exampleGroup -ResourceName exampleSite).ResourceId\r\n```\r\n\r\n## <a name=\"lock-a-resource\"></a>锁定资源\r\n\r\n需要确保不会意外删除或修改关键资源时，请对资源应用锁定。 可指定 **CanNotDelete** 或 **ReadOnly**。\r\n\r\n若要创建或删除管理锁，必须有权执行 `Microsoft.Authorization/*` 或 `Microsoft.Authorization/locks/*` 操作。 在内置角色中，只有“所有者”和“用户访问管理员”有权执行这些操作。\r\n\r\n若要应用锁定，请使用以下 cmdlet：\r\n\r\n```powershell\r\nNew-AzureRmResourceLock -LockLevel CanNotDelete -LockName LockStorage -ResourceName mystoragename -ResourceType Microsoft.Storage/storageAccounts -ResourceGroupName TestRG1\r\n```\r\n\r\n上例中，在删除锁之前，无法删除锁定的资源。 若要删除所，请使用：\r\n\r\n```powershell\r\nRemove-AzureRmResourceLock -LockName LockStorage -ResourceName mystoragename -ResourceType Microsoft.Storage/storageAccounts -ResourceGroupName TestRG1\r\n```\r\n\r\n有关设置锁的详细信息，请参阅[使用 Azure Resource Manager 锁定资源](resource-group-lock-resources.md)。\r\n\r\n## <a name=\"remove-resources-or-resource-group\"></a>删除资源或资源组\r\n可以删除资源或资源组。 删除资源组时，还会删除该资源组中的所有资源。\r\n\r\n* 若要从资源组中删除资源，请使用 **Remove-AzureRmResource** cmdlet。 此 cmdlet 将删除该资源，但不会删除该资源组。\r\n\r\n    ```powershell\r\n    Remove-AzureRmResource -ResourceName mystoragename -ResourceType Microsoft.Storage/storageAccounts -ResourceGroupName TestRG1\r\n    ```\r\n\r\n* 若要删除资源组及其所有资源，请使用 **Remove-AzureRmResourceGroup** cmdlet。\r\n\r\n    ```powershell\r\n    Remove-AzureRmResourceGroup -Name TestRG1\r\n    ```\r\n\r\n使用这两个 cmdlet，都会要求确认要删除的资源或资源组。 如果操作成功删除资源或资源组，会返回 **True**。\r\n\r\n## <a name=\"run-resource-manager-scripts-with-azure-automation\"></a>使用 Azure 自动化运行 Resource Manager 脚本\r\n\r\n本文演示如何通过 Azure PowerShell 对资源执行基本操作。 如果使用更高级的管理方案，通常需要创建脚本，并按需或按计划重复使用该脚本。 通过 [Azure 自动化](../automation/automation-intro.md)，可自动执行用于管理 Azure 解决方案的常用脚本。\r\n\r\n以下主题演示如何使用 Azure 自动化、Resource Manager 和 PowerShell 来有效执行管理任务：\r\n\r\n<!-- Not Available - For information about creating a runbook, see [My first PowerShell runbook](../automation/automation-first-runbook-textual-powershell.md). -->\r\n- 有关使用脚本库的信息，请参阅 [Azure 自动化的 Runbook 和模块库](../automation/automation-runbook-gallery.md)。\r\n<!-- Not Available - For runbooks that start and stop virtual machines, see [Azure Automation scenario: Using JSON-formatted tags to create a schedule for Azure VM startup and shutdown](../automation/automation-scenario-start-stop-vm-wjson-tags.md). -->\r\n<!-- Not Available - For runbooks that start and stop virtual machines off-hours, see [Start/Stop VMs during off-hours solution in Automation](../automation/automation-solution-vm-management.md). -->\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n* 若要了解如何创建 Resource Manager 模板，请参阅[创作 Azure Resource Manager 模板](resource-group-authoring-templates.md)。\r\n* 若要了解如何部署模板，请参阅[使用 Azure Resource Manager 模板部署应用程序](resource-group-template-deploy.md)。\r\n* 可以将现有资源移动到新的资源组。 有关示例，请参阅[将资源移动到新的资源组或订阅中](resource-group-move-resources.md)。\r\n* 有关企业可如何使用 Resource Manager 有效管理订阅的指南，请参阅 [Azure 企业基架 - 出于合规目的监管订阅](resource-manager-subscription-governance.md)。\r\n\r\n<!--Update_Description: add new feature on getting resource id, wording update-->"}