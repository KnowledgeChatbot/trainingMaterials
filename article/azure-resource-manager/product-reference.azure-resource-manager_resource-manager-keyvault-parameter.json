{"Title":"Key Vault 机密与 Azure 资源管理器模板","Description":"说明在部署期间如何以参数形式从密钥保管库传递机密。","Content":"# <a name=\"use-azure-key-vault-to-pass-secure-parameter-value-during-deployment\"></a>在部署过程中使用 Azure Key Vault 传递安全参数值\r\n\r\n在部署过程中，需要将安全值（例如密码）作为参数传递时，可从 [Azure Key Vault](../key-vault/key-vault-whatis.md) 检索值。 通过引用参数文件中的密钥保管库和密钥来检索值。 值永远不会公开，因为仅引用其密钥保管库 ID。 不需要每次部署资源时手动输入机密的值。 密钥保管库与部署到的资源组不需要位于同一订阅中。 引用密钥保管库时，需要包括订阅 ID。\r\n\r\n创建密钥保管库时，将 enabledForTemplateDeployment 属性设置为 true。 通过将该值设置为 true，在部署过程中可允许来自资源管理器模板的访问。\r\n\r\n## <a name=\"deploy-a-key-vault-and-secret\"></a>部署密钥保管库和机密\r\n\r\n若要创建密钥保管库和机密，请使用 Azure CLI 或 PowerShell。 请注意，已为模板部署启用密钥保管库。 \r\n\r\n对于 Azure CLI，请使用：\r\n\r\n```azurecli\r\nvaultname={your-unique-vault-name}\r\npassword={password-value}\r\n\r\naz group create --name examplegroup --location 'China East'\r\naz keyvault create \\\r\n  --name $vaultname \\\r\n  --resource-group examplegroup \\\r\n  --location 'China East' \\\r\n  --enabled-for-template-deployment true\r\naz keyvault secret set --vault-name $vaultname --name examplesecret --value $password\r\n```\r\n\r\n对于 PowerShell，请使用：\r\n\r\n```powershell\r\n$vaultname = \"{your-unique-vault-name}\"\r\n$password = \"{password-value}\"\r\n\r\nNew-AzureRmResourceGroup -Name examplegroup -Location \"China East\"\r\nNew-AzureRmKeyVault `\r\n  -VaultName $vaultname `\r\n  -ResourceGroupName examplegroup `\r\n  -Location \"China East\" `\r\n  -EnabledForTemplateDeployment\r\n$secretvalue = ConvertTo-SecureString $password -AsPlainText -Force\r\nSet-AzureKeyVaultSecret -VaultName $vaultname -Name \"examplesecret\" -SecretValue $secretvalue\r\n```\r\n\r\n## <a name=\"enable-access-to-the-secret\"></a>启用密钥访问权限\r\n\r\n无论使用的是新密钥保管库还是现有密钥保管库，请确保部署模板的用户可以访问密钥。 部署引用某个密钥的模板的用户必须具有密钥保管库的 `Microsoft.KeyVault/vaults/deploy/action` 权限。 [所有者](../active-directory/role-based-access-built-in-roles.md#owner)和[参与者](../active-directory/role-based-access-built-in-roles.md#contributor)角色均授予该访问权限。\r\n\r\n## <a name=\"reference-a-secret-with-static-id\"></a>通过静态 ID 引用机密\r\n\r\n接收 key vault 机密的模板与任何其他模板类似。 这是因为在参数文件（而不是在模板）中引用 key vault。 例如，以下模板部署包含管理员密码的 SQL 数据库。 密码参数设置为安全字符串。 但是，此模板未指定该值的来源。\r\n\r\n```json\r\n{\r\n  \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n  \"contentVersion\": \"1.0.0.0\",\r\n  \"parameters\": {\r\n    \"adminLogin\": {\r\n      \"type\": \"string\"\r\n    },\r\n    \"adminPassword\": {\r\n      \"type\": \"securestring\"\r\n    },\r\n    \"sqlServerName\": {\r\n      \"type\": \"string\"\r\n    }\r\n  },\r\n  \"resources\": [\r\n    {\r\n      \"name\": \"[parameters('sqlServerName')]\",\r\n      \"type\": \"Microsoft.Sql/servers\",\r\n      \"apiVersion\": \"2015-05-01-preview\",\r\n      \"location\": \"[resourceGroup().location]\",\r\n      \"tags\": {},\r\n      \"properties\": {\r\n        \"administratorLogin\": \"[parameters('adminLogin')]\",\r\n        \"administratorLoginPassword\": \"[parameters('adminPassword')]\",\r\n        \"version\": \"12.0\"\r\n      }\r\n    }\r\n  ],\r\n  \"outputs\": {\r\n  }\r\n}\r\n```\r\n\r\n现在，为上述模板创建参数文件。 在参数文件中，指定与模板中的参数名称匹配的参数。 对于参数值，请从密钥保管库中引用机密。 可以通过传递密钥保管库的资源标识符和机密的名称来引用机密。 在以下示例中，密钥保管库机密必须已存在，而且用户提供其资源 ID 的静态值。\r\n\r\n```json\r\n{\r\n    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#\",\r\n    \"contentVersion\": \"1.0.0.0\",\r\n    \"parameters\": {\r\n        \"adminLogin\": {\r\n            \"value\": \"exampleadmin\"\r\n        },\r\n        \"adminPassword\": {\r\n            \"reference\": {\r\n              \"keyVault\": {\r\n                \"id\": \"/subscriptions/<subscription-id>/resourceGroups/examplegroup/providers/Microsoft.KeyVault/vaults/<vault-name>\"\r\n              },\r\n              \"secretName\": \"examplesecret\"\r\n            }\r\n        },\r\n        \"sqlServerName\": {\r\n            \"value\": \"<your-server-name>\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n现在，部署模板并传入参数文件。 对于 Azure CLI，请使用：\r\n\r\n```azurecli\r\naz group create --name datagroup --location \"China North\"\r\naz group deployment create \\\r\n    --name exampledeployment \\\r\n    --resource-group datagroup \\\r\n    --template-file sqlserver.json \\\r\n    --parameters @sqlserver.parameters.json\r\n```\r\n\r\n对于 PowerShell，请使用：\r\n\r\n```powershell\r\nNew-AzureRmResourceGroup -Name datagroup -Location \"China North\"\r\nNew-AzureRmResourceGroupDeployment `\r\n  -Name exampledeployment `\r\n  -ResourceGroupName datagroup `\r\n  -TemplateFile sqlserver.json `\r\n  -TemplateParameterFile sqlserver.parameters.json\r\n```\r\n\r\n## <a name=\"reference-a-secret-with-dynamic-id\"></a>通过动态 ID 引用机密\r\n\r\n上一节介绍了如何传递密钥保管库机密的静态资源 ID。 但是，在某些情况下，需要引用随当前部署而变的密钥保管库机密。 在这种情况下，不能在参数文件中对资源 ID 进行硬编码。 遗憾的是，不能在参数文件中动态生成资源 ID，因为参数文件中不允许模板表达式。\r\n\r\n要动态生成密钥保管库机密的资源 ID，必须将需要机密的资源移至嵌套式模板中。 需要在主模板中添加嵌套式模板，并传入包含动态生成的资源 ID 的参数。 嵌套模板必须通过外部 URI 提供。 本文的其余部分假定已将前面的模板添加到存储帐户，并可通过 URI (`https://<storage-name>.blob.core.chinacloudapi.cn/templatecontainer/sqlserver.json`) 获得该模板。\r\n\r\n```json\r\n{\r\n    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\r\n    \"contentVersion\": \"1.0.0.0\",\r\n    \"parameters\": {\r\n      \"vaultName\": {\r\n        \"type\": \"string\"\r\n      },\r\n      \"vaultResourceGroup\": {\r\n        \"type\": \"string\"\r\n      },\r\n      \"secretName\": {\r\n        \"type\": \"string\"\r\n      },\r\n      \"adminLogin\": {\r\n        \"type\": \"string\"\r\n      },\r\n      \"sqlServerName\": {\r\n        \"type\": \"string\"\r\n      }\r\n    },\r\n    \"resources\": [\r\n    {\r\n      \"apiVersion\": \"2015-01-01\",\r\n      \"name\": \"nestedTemplate\",\r\n      \"type\": \"Microsoft.Resources/deployments\",\r\n      \"properties\": {\r\n        \"mode\": \"incremental\",\r\n        \"templateLink\": {\r\n          \"uri\": \"https://<storage-name>.blob.core.chinacloudapi.cn/templatecontainer/sqlserver.json\",\r\n          \"contentVersion\": \"1.0.0.0\"\r\n        },\r\n        \"parameters\": {\r\n          \"adminPassword\": {\r\n            \"reference\": {\r\n              \"keyVault\": {\r\n                \"id\": \"[resourceId(subscription().subscriptionId,  parameters('vaultResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('vaultName'))]\"\r\n              },\r\n              \"secretName\": \"[parameters('secretName')]\"\r\n            }\r\n          },\r\n          \"adminLogin\": { \"value\": \"[parameters('adminLogin')]\" },\r\n          \"sqlServerName\": {\"value\": \"[parameters('sqlServerName')]\"}\r\n        }\r\n      }\r\n    }],\r\n    \"outputs\": {}\r\n}\r\n```\r\n\r\n部署前面的模板，并为参数提供值。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n* 有关密钥保管库的一般信息，请参阅 [Azure 密钥保管库入门](../key-vault/key-vault-get-started.md)。\r\n* 有关引用密钥机密的完整示例，请参阅 [密钥保管库示例](https://github.com/rjmax/ArmExamples/tree/master/keyvaultexamples)。\r\n\r\n<!--Update_Description: update meta properties, wording update, update cmdlet sample -->"}