{"Title":"如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别","Description":"如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别","Content":"\r\n# 如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别\r\n\r\n## 问题描述\r\n\r\n在文档[使用 IoT 中心发送和接收消息](/iot-hub/iot-hub-devguide-messaging)中，描述云到设备（CloudToDevice, 以下简称 C2D）消息的默认 TTL 最小可以设置为 1 分钟：\r\n\r\n![portal](media/aog-iot-hub-qa-c2d-message-ttl-set-minute-level/portal.png)\r\n\r\n然而 Azure 门户预览上，默认值为 1 小时，无法设置为分钟级别：\r\n\r\n![portal-2](media/aog-iot-hub-qa-c2d-message-ttl-set-minute-level/portal-2.png)\r\n\r\n## 实现方案\r\n\r\nC2D 消息的默认 TTL 确实可以设置为最小 1 mins，但是目前只能通过代码实现，而无法通过 Azure 门户预览来操作。目前，使用代码可以通过两种方式操作:\r\n\r\n- 发送 C2D 消息的时候，可以指定某条 / 某几条消息里的 `ExpiryTimeUtc` 属性为您需要过期的时间，例如：\r\n\r\n    ```\r\n    var commandMessage = new Message(\r\n        Encoding.ASCII.GetBytes(\"Cloud to device message.\"));\r\n    commandMessage.ExpiryTimeUtc = System.DateTime.UtcNow.AddMinutes(1);\r\n    messageToSend.setExpiryTimeUtc(expireDate);\r\n    ```\r\n\r\n- 可以通过设置 CloudToDevice 里的 `DefaultTtlAsIso8601` 属性来设置默认 TTL，这种方法是为整个 IoT 中心下所有设备的 C2D 的消息设置为同一默认 TTL。\r\n\r\n    ```\r\n    var iothubClient = new IotHubClient(\r\n    new Uri(\"https://management.chinacloudapi.cn/\"), \r\n    tokenCredential, \r\n    new RetryDelegatingHandler());\r\n    iothubClient.SubscriptionId = subscriptionId;\r\n\r\n    var iothubResource = iothubClient.IotHubResource;\r\n\r\n    // get iothub description\r\n    var resourceDescription = iothubResource.Get(rgName, resourceName);\r\n    Console.WriteLine(resourceDescription.Name);\r\n\r\n    // set C2D message default ttl to 1 minute\r\n    resourceDescription.Properties.CloudToDevice.DefaultTtlAsIso8601 = TimeSpan.FromMinutes(1);\r\n\r\n    try\r\n    { \r\n        // commit the change                 \r\n        iothubResource.CreateOrUpdate(rgName, resourceName, resourceDescription);\r\n        Console.WriteLine(\"Update successfully!\");\r\n    }\r\n    catch (Exception ex)\r\n    {\r\n        Console.WriteLine(ex.Message);\r\n    }\r\n    Console.WriteLine(\"Press ENTER to exit!\");\r\n    Console.ReadLine();            \r\n\r\n    ```\r\n"}