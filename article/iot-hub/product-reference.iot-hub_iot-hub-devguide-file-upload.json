{"Title":"了解 Azure IoT 中心文件上传","Description":"开发人员指南 - 使用 IoT 中心的文件上传功能，管理从设备到 Azure 存储 blob 容器的文件上传。","Content":"# <a name=\"upload-files-with-iot-hub\"></a>使用 IoT 中心上传文件\r\n\r\n如 [IoT 中心终结点][lnk-endpoints]一文中详述，设备可以通过面向设备的终结点 (**/devices/{deviceId}/files**) 发送通知以启动文件上传。 当设备通知 IoT 中心已完成某个上传时，IoT 中心会通过面向服务的终结点 (**/messages/servicebound/filenotifications**) 发送文件上传通知消息。\r\n\r\nIoT 中心本身不中转消息，而是充当关联 Azure 存储帐户的调度程序。 设备请求来自 IoT 中心的存储令牌，该令牌特定于设备要上传的文件。 设备使用 SAS URI 将文件上传到存储，上传完成后，设备将完成通知发送到 IoT 中心。 IoT 中心检查文件上传是否已完成，然后将文件上传通知消息添加到面向服务的文件通知终结点。\r\n\r\n从设备将文件上传到 IoT 中心之前，必须配置中心，通过为其[关联 Azure 存储][lnk-associate-storage]帐户实现配置。\r\n\r\n然后，设备就能[初始化上传][lnk-initialize]，并在上传完成后[通知 IoT 中心][lnk-notify]。 （可选）当设备通知 IoT 中心上传完成以后，服务就可以生成 [通知消息][lnk-service-notification]。\r\n\r\n### <a name=\"when-to-use\"></a>使用时机\r\n使用文件上传功能发送连接的设备间歇性地上传的媒体文件和大型遥测批文件（或者是经过压缩的文件以节省带宽）。\r\n\r\n如果在使用报告属性、设备到云消息或文件上传方面有任何疑问，请参阅 [设备到云通信指南][lnk-d2c-guidance] 。\r\n\r\n## <a name=\"associate-an-azure-storage-account-with-iot-hub\"></a>将 Azure 存储帐户与 IoT 中心相关联\r\n要使用文件上传功能，必须首先将 Azure 存储帐户链接到 IoT 中心。 可通过 [Azure 门户][lnk-management-portal]完成此任务，或通过 [IoT 中心资源提供程序 REST API][lnk-resource-provider-apis] 以编程方式完成此任务。 将 Azure 存储帐户与 IoT 中心关联后，当设备发起文件上传请求时，此服务将向该设备返回 SAS URI。\r\n\r\n> [!NOTE]\r\n> [Azure IoT SDK][lnk-sdks] 自动处理检索 SAS URI、上传文件和通知 IoT 中心已完成上传等操作。\r\n> \r\n> \r\n\r\n## <a name=\"initialize-a-file-upload\"></a>初始化文件上传\r\nIoT 中心有一个终结点，专供设备在上传文件时请求用于存储的 SAS URI。 为了启动文件上传过程，设备会使用以下 JSON 正文向 `{iot hub}.azure-devices.cn/devices/{deviceId}/files` 发送 POST 请求：\r\n\r\n```json\r\n    {\r\n        \"blobName\": \"{name of the file for which a SAS URI will be generated}\"\r\n    }\r\n```\r\n\r\nIoT 中心返回以下数据，供设备用来上传文件：\r\n\r\n```json\r\n    {\r\n        \"correlationId\": \"somecorrelationid\",\r\n        \"hostname\": \"contoso.azure-devices.cn\",\r\n        \"containerName\": \"testcontainer\",\r\n        \"blobName\": \"test-device1/image.jpg\",\r\n        \"sasToken\": \"1234asdfSAStoken\"\r\n    }\r\n```\r\n\r\n### <a name=\"deprecated-initialize-a-file-upload-with-a-get\"></a>已弃用：使用 GET 初始化文件上传\r\n> [!NOTE]\r\n> 本部分介绍已弃用的功能，这些功能用于从 IoT 中心接收 SAS URI。 使用前面所述的 POST 方法。\r\n\r\nIoT 中心有两个 REST 终结点支持文件上传，一个用于获取存储的 SAS URI，另一个用于通知 IoT 中心已完成上传。 设备通过在 `{iot hub}.azure-devices.cn/devices/{deviceId}/files/{filename}` 向 IoT 中心发送 GET 来启动文件上传过程。 IoT 中心返回：\r\n\r\n* 特定于要上传的文件的 SAS URI。\r\n* 上传完成后要使用的相关 ID。\r\n\r\n## <a name=\"notify-iot-hub-of-a-completed-file-upload\"></a>通知 IoT 中心已完成文件上传\r\n\r\n设备负责使用 Azure 存储 SDK 将文件上传到存储。 上传完成后，设备会使用以下 JSON 正文向 `{iot hub}.azure-devices.cn/devices/{deviceId}/files/notifications` 发送 POST 请求：\r\n\r\n```json\r\n    {\r\n        \"correlationId\": \"{correlation ID received from the initial request}\",\r\n        \"isSuccess\": bool,\r\n        \"statusCode\": XXX,\r\n        \"statusDescription\": \"Description of status\"\r\n    }\r\n```\r\n\r\n`isSuccess` 的值为布尔值，表示文件是否上传成功。 `statusCode` 的状态代码表示将文件上传到存储时的状态，`statusDescription` 对应于 `statusCode`。\r\n\r\n## <a name=\"reference-topics\"></a>参考主题：\r\n以下参考主题详细介绍了如何从设备上传文件。\r\n\r\n## <a name=\"file-upload-notifications\"></a>文件上传通知\r\n\r\n（可选）当设备通知 IoT 中心上传完成时，IoT 中心可以生成包含文件名称和存储位置的通知消息。\r\n\r\n如[终结点][lnk-endpoints]中所述，IoT 中心通过面向服务的终结点 (**/messages/servicebound/fileuploadnotifications**) 以消息的形式传递文件上传通知。 文件上传通知的接收语义与云到设备的消息的接收语义相同，并且具有相同的 [消息生命周期][lnk-lifecycle]。 从文件上传通知终结点检索到的每条消息都是具有以下属性的 JSON 记录：\r\n\r\n| 属性 | 说明 |\r\n| --- | --- |\r\n| EnqueuedTimeUtc |指示通知创建时间的时间戳。 |\r\n| DeviceId |**DeviceId** 。 |\r\n| BlobUri |已上传文件的 URI。 |\r\n| BlobName |已上传文件的名称。 |\r\n| LastUpdatedTime |指示文件更新时间的时间戳。 |\r\n| BlobSizeInBytes |已上传文件的大小。 |\r\n\r\n**示例**。 此示例显示文件上传通知消息的正文。\r\n\r\n```json\r\n    {\r\n        \"deviceId\":\"mydevice\",\r\n        \"blobUri\":\"https://{storage account}.blob.core.chinacloudapi.cn/{container name}/mydevice/myfile.jpg\",\r\n        \"blobName\":\"mydevice/myfile.jpg\",\r\n        \"lastUpdatedTime\":\"2016-06-01T21:22:41+00:00\",\r\n        \"blobSizeInBytes\":1234,\r\n        \"enqueuedTimeUtc\":\"2016-06-01T21:22:43.7996883Z\"\r\n    }\r\n```\r\n\r\n## <a name=\"file-upload-notification-configuration-options\"></a>文件上传通知配置选项\r\n每个 IoT 中心都为文件上传通知公开以下配置选项：\r\n\r\n| 属性 | 说明 | 范围和默认值 |\r\n| --- | --- | --- |\r\n| **enableFileUploadNotifications** |控制是否将文件上传通知写入文件通知终结点。 |布尔型。 默认值：True。 |\r\n| **fileNotifications.ttlAsIso8601** |文件上传通知的默认 TTL。 |ISO_8601 间隔上限为 48 小时（下限为 1 分钟）。 默认值：1 小时。 |\r\n| **fileNotifications.lockDuration** |文件上传通知队列的锁定持续时间。 |5 到 300 秒（最小为 5 秒）。 默认值：60 秒。 |\r\n| **fileNotifications.maxDeliveryCount** |文件上传通知队列的最大传递计数。 |1 到 100。 默认值：100。 |\r\n\r\n## <a name=\"additional-reference-material\"></a>其他参考资料\r\nIoT 中心开发人员指南中的其他参考主题包括：\r\n\r\n* [IoT 中心终结点][lnk-endpoints]，介绍了每个 IoT 中心针对运行时和管理操作公开的各种终结点。\r\n* [限制和配额][lnk-quotas]介绍了适用于 IoT 中心服务的配额和限制行为。\r\n* [Azure IoT 设备和服务 SDK][lnk-sdks] 列出了开发与 IoT 中心交互的设备和服务应用时可使用的各种语言 SDK。\r\n* [IoT 中心查询语言][lnk-query]介绍了可用来从 IoT 中心检索设备克隆和作业相关信息的查询语言。\r\n* [IoT 中心 MQTT 支持][lnk-devguide-mqtt]提供有关 IoT 中心对 MQTT 协议的支持的详细信息。\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n了解如何使用 IoT 中心从设备上传文件以后，可以根据兴趣参阅以下 IoT 中心开发人员指南主题：\r\n\r\n* [管理 IoT 中心中的设备标识][lnk-devguide-identities]\r\n* [控制 IoT 中心的访问权限][lnk-devguide-security]\r\n* [使用设备孪生同步状态和配置][lnk-devguide-device-twins]\r\n* [在设备上调用直接方法][lnk-devguide-directmethods]\r\n* [Schedule jobs on multiple devices（在多台设备上计划作业）][lnk-devguide-jobs]\r\n\r\n若要尝试本文中介绍的一些概念，可以根据兴趣学习以下 IoT 中心教程：\r\n\r\n- [如何通过 IoT 中心将文件从设备上传到云中][lnk-fileupload-tutorial]\r\n\r\n[lnk-resource-provider-apis]: https://docs.microsoft.com/rest/api/iothub/iothubresource\r\n[lnk-endpoints]: ./iot-hub-devguide-endpoints.md\r\n[lnk-quotas]: ./iot-hub-devguide-quotas-throttling.md\r\n[lnk-sdks]: ./iot-hub-devguide-sdks.md\r\n[lnk-query]: ./iot-hub-devguide-query-language.md\r\n[lnk-devguide-mqtt]: ./iot-hub-mqtt-support.md\r\n[lnk-management-portal]: https://portal.azure.cn\r\n[lnk-fileupload-tutorial]: ./iot-hub-csharp-csharp-file-upload.md\r\n[lnk-associate-storage]: ./iot-hub-devguide-file-upload.md#associate-an-azure-storage-account-with-iot-hub\r\n[lnk-initialize]: ./iot-hub-devguide-file-upload.md#initialize-a-file-upload\r\n[lnk-notify]: ./iot-hub-devguide-file-upload.md#notify-iot-hub-of-a-completed-file-upload\r\n[lnk-service-notification]: ./iot-hub-devguide-file-upload.md#file-upload-notifications\r\n[lnk-lifecycle]: ./iot-hub-devguide-messages-c2d.md#the-cloud-to-device-message-lifecycle\r\n[lnk-d2c-guidance]: ./iot-hub-devguide-d2c-guidance.md\r\n\r\n[lnk-devguide-identities]: ./iot-hub-devguide-identity-registry.md\r\n[lnk-devguide-security]: ./iot-hub-devguide-security.md\r\n[lnk-devguide-device-twins]: ./iot-hub-devguide-device-twins.md\r\n[lnk-devguide-directmethods]: ./iot-hub-devguide-direct-methods.md\r\n[lnk-devguide-jobs]: ./iot-hub-devguide-jobs.md\r\n\r\n<!--Update_Description:update wording-->"}