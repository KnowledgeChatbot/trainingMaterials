{"Title":"通过 Azure IoT Edge 在 IoT 网关上进行数据转换","Description":"通过 Azure IoT Edge 的自定义模块，使用 IoT 网关转换传感器数据的格式。","Content":"# <a name=\"use-iot-gateway-for-sensor-data-transformation-with-azure-iot-edge\"></a>通过 Azure IoT Edge，使用 IoT 网关进行传感器数据转换\r\n\r\n> [!NOTE]\r\n> 在开始本教程之前，请确保已按顺序完成以下课程：\r\n> * [将 Intel NUC 设置为 IoT 网关](./iot-hub-gateway-kit-c-lesson1-set-up-nuc.md)\r\n> * [使用 IoT 网关将事项连接到云 - SensorTag 到 Azure IoT 中心](./iot-hub-gateway-kit-c-iot-gateway-connect-device-to-cloud.md)\r\n\r\nIoT 网关的一个用途是在将收集的数据发送到云之前，先处理这些数据。 Azure IoT Edge 引入了可创建并组合形成数据处理工作流的模块。 模块接收消息，对其执行某些操作，并将其转手供其他模块处理。\r\n\r\n## <a name=\"what-you-learn\"></a>学习内容\r\n\r\n了解如何创建一个模块，将消息从 SensorTag 转换为其他格式。\r\n\r\n## <a name=\"what-you-do\"></a>准备工作\r\n\r\n* 创建一个模块，将收到的消息转换为 .json 格式。\r\n* 编译该模块。\r\n* 通过 Azure IoT Edge，将模块添加到 BLE 示例应用程序。\r\n* 运行示例应用程序。\r\n\r\n## <a name=\"what-you-need\"></a>所需条件\r\n\r\n* 按顺序完成以下教程：\r\n  * [将 Intel NUC 设置为 IoT 网关](./iot-hub-gateway-kit-c-lesson1-set-up-nuc.md)\r\n  * [使用 IoT 网关将事项连接到云 - SensorTag 到 Azure IoT 中心](./iot-hub-gateway-kit-c-iot-gateway-connect-device-to-cloud.md)\r\n* 在主计算机上运行的 SSH 客户端。 建议在 Windows 上使用 PuTTY。 Linux 和 macOS 已附带 SSH 客户端。\r\n* IP 地址以及访问 SSH 客户端网关的用户名和密码。\r\n* Internet 连接。\r\n\r\n## <a name=\"create-a-module\"></a>创建模块\r\n\r\n1. 在主计算机上，运行 SSH 客户端并连接到 IoT 网关。\r\n1. 运行以下命令，将转换模块的源文件从 GitHub 克隆到 IoT 网关的主目录：\r\n\r\n   ```bash\r\n   cd ~\r\n   git clone https://github.com/Azure-Samples/iot-hub-c-intel-nuc-gateway-customized-module.git\r\n   ```\r\n\r\n   这是采用 C 编程语言编写的本机 Azure Edge 模块。 该模块将收到的消息转换为以下格式：\r\n\r\n   ```json\r\n   {\"deviceId\": \"Intel NUC Gateway\", \"messageId\": 0, \"temperature\": 0.0}\r\n   ```\r\n\r\n## <a name=\"compile-the-module\"></a>编译模块\r\n\r\n若要编译模块，请运行以下命令：\r\n\r\n```bash\r\ncd iot-hub-c-intel-nuc-gateway-customized-module/my_module\r\n# change the build script runnable\r\nchmod 777 build.sh\r\n# remove the invalid windows character\r\nsed -i -e \"s/\\r$//\" build.sh\r\n# run the build shell script\r\n./build.sh\r\n```\r\n\r\n编译完成后会获取 `libmy_module.so` 文件。 记下此文件的绝对路径。\r\n\r\n## <a name=\"add-the-module-to-the-ble-sample-application\"></a>将模块添加到 BLE 示例应用程序\r\n\r\n1. 运行以下命令转到示例文件夹：\r\n\r\n   ```bash\r\n   cd /usr/share/azureiotgatewaysdk/samples\r\n   ```\r\n\r\n1. 运行以下命令打开配置文件：\r\n\r\n   ```bash\r\n   vi ble_gateway.json\r\n   ```\r\n\r\n1. 将以下代码插入 `modules` 节以添加模块。\r\n\r\n   ```json\r\n   {\r\n       \"name\": \"MyModule\",\r\n       \"loader\": {\r\n           \"name\": \"native\",\r\n           \"entrypoint\":{\r\n               \"module.path\": \"[Your libmy_module.so path]\"\r\n               }\r\n            },\r\n        \"args\": null\r\n    },\r\n    ```\r\n\r\n1. 将代码中的 `[Your libmy_module.so path]` 替换为 libmy_module.so` 文件的绝对路径。\r\n1. 将 `links` 部分中的代码替换为以下代码：\r\n\r\n   ```json\r\n   {\r\n       \"source\": \"SensorTag\",\r\n       \"sink\": \"MyModule\"\r\n   },\r\n   {\r\n       \"source\": \"MyModule\",\r\n       \"sink\": \"mapping\"\r\n   }\r\n   ```\r\n\r\n1. 按 `ESC`，并键入 `:wq` 保存文件。\r\n\r\n## <a name=\"run-the-sample-application\"></a>运行示例应用程序\r\n\r\n1. 打开 SensorTag。\r\n1. 通过运行以下命令，设置 SSL_CERT_FILE 环境变量：\r\n\r\n   ```bash\r\n   export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt\r\n   ```\r\n\r\n1. 通过运行以下命令，运行具有所添加模块的示例应用程序：\r\n\r\n   ```bash\r\n   ./ble_gateway ble_gateway.json\r\n   ```\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n已成功使用 IoT 网关将消息从 SensorTag 转换为 .json 格式。\r\n\r\n[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]\r\n\r\n<!--Update_Description: update wording -->"}