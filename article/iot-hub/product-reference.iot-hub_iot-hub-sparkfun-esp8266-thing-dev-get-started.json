{"Title":"ESP8266 到云 - 将 Sparkfun ESP8266 Thing Dev 连接到 Azure IoT 中心","Description":"在本教程中了解如何设置 Sparkfun ESP8266 Thing Dev 并将其连接到 Azure IoT 中心，使其能够将数据发送到 Azure 云平台。","Content":"# <a name=\"connect-sparkfun-esp8266-thing-dev-to-azure-iot-hub-in-the-cloud\"></a>将 Sparkfun ESP8266 Thing Dev 连接到云中的 Azure IoT 中心\r\n\r\n[!INCLUDE [iot-hub-get-started-device-selector](../../includes/iot-hub-get-started-device-selector.md)]\r\n\r\n![DHT22、Thing Dev 与 IoT 中心之间的连接](./media/iot-hub-sparkfun-thing-dev-get-started/1_connection-hdt22-thing-dev-iot-hub.png)\r\n\r\n## <a name=\"what-you-will-do\"></a>执行的操作\r\n\r\n将 Sparkfun ESP8266 Thing Dev 连接到要创建的 IoT 中心。 然后，在 ESP8266 上运行一个示例应用程序，用于从 DHT22 传感器收集温度和湿度数据。 最后，将传感器数据发送到 IoT 中心。\r\n\r\n> [!NOTE]\r\n> 如果使用其他 ESP8266 开发板，仍可遵循这些步骤将它连接到 IoT 中心。 根据所用的 ESP8266 开发板，可能需要重新配置 `LED_PIN`。 例如，如果使用 AI-Thinker 提供的 ESP8266，可将此参数从 `0` 更改为 `2`。 \r\n\r\n## <a name=\"what-you-will-learn\"></a>要学习的知识\r\n\r\n* 如何创建 IoT 中心以及注册 Thing Dev 的设备。\r\n* 如何将 Thing Dev 与传感器和计算机相连接。\r\n* 如何在 Thing Dev 上运行示例应用程序来收集传感器数据。\r\n* 如何将传感器数据发送到 IoT 中心。\r\n\r\n## <a name=\"what-you-will-need\"></a>所需的项目\r\n\r\n![本教程所需的部件](./media/iot-hub-sparkfun-thing-dev-get-started/2_parts-needed-for-the-tutorial.png)\r\n\r\n若要完成此操作，需要使用 Thing Dev 初学者工具包中的以下部件：\r\n\r\n* Sparkfun ESP8266 Thing Dev 开发板。\r\n* Micro USB 转 Type A USB 线缆。\r\n\r\n还需要为开发环境做好以下准备：\r\n\r\n* 一个有效的 Azure 订阅。 如果没有 Azure 帐户，只需花费几分钟就能[创建一个 Azure 试用帐户](https://www.azure.cn/pricing/1rmb-trial/)。\r\n* 运行 Windows 或 Ubuntu 的 Mac 或 PC。\r\n* Sparkfun ESP8266 Thing Dev 要连接到的无线网络。\r\n* 建立 Internet 连接，以便下载配置工具。\r\n* [Arduino IDE](https://www.arduino.cc/en/main/software) 版本 1.6.8（或更高版本），早期版本不适用于 AzureIoT 库。\r\n\r\n如果没有传感器，以下各项是可选的。 也可以使用模拟的传感器数据。\r\n\r\n* Adafruit DHT22 温度和湿度传感器。\r\n* 试验板。\r\n* M/M 跳线。\r\n\r\n[!INCLUDE [iot-hub-get-started-create-hub-and-device](../../includes/iot-hub-get-started-create-hub-and-device.md)]\r\n\r\n## <a name=\"connect-esp8266-thing-dev-with-the-sensor-and-your-computer\"></a>将 ESP8266 Thing Dev 与传感器和计算机相连接\r\n\r\n### <a name=\"connect-a-dht22-temperature-and-humidity-sensor-to-esp8266-thing-dev\"></a>将 DHT22 温度和湿度传感器连接到 ESP8266 Thing Dev\r\n\r\n按如下所示，使用试验板和跳线建立连接。 如果没有传感器，请跳过本部分，因为可以改用模拟的传感器数据。\r\n\r\n![连接参考](./media/iot-hub-sparkfun-thing-dev-get-started/15_connections_on_breadboard.png)\r\n\r\n我们使用以下传感器引脚连线方式：\r\n\r\n| 启动（传感器）           | 结束（开发板）           | 线缆颜色   |\r\n| -----------------------  | ---------------------- | ------------: |\r\n| VDD（引脚 27F）            | 3V（引脚 8A）           | 红线     |\r\n| DATA（引脚 28F）           | GPIO 2（引脚 9A）       | 白线    |\r\n| GND（引脚 30F）            | GND（引脚 7J）          | 黑线   |\r\n\r\n\r\n- 有关详细信息，请参阅：[DHT22 传感器设置](http://cdn.sparkfun.com/datasheets/Sensors/Weather/RHT03.pdf)和 [Sparkfun ESP8266 Thing Dev 规范](https://www.sparkfun.com/products/13711)\r\n\r\n现在，Sparkfun ESP8266 Thing Dev 应已连接到正常工作的传感器。\r\n\r\n![将 dht22 与 ESP8266 Thing Dev 相连接](./media/iot-hub-sparkfun-thing-dev-get-started/8_connect-dht22-thing-dev.png)\r\n\r\n### <a name=\"connect-sparkfun-esp8266-thing-dev-to-your-computer\"></a>将 Sparkfun ESP8266 Thing Dev 连接到计算机\r\n\r\n按如下所示，使用 Micro USB 转 Type A USB 电缆将 Sparkfun ESP8266 Thing Dev 连接到计算机。\r\n\r\n![将 feather huzzah 连接到计算机](./media/iot-hub-sparkfun-thing-dev-get-started/9_connect-thing-dev-computer.png)\r\n\r\n### <a name=\"add-serial-port-permissions--ubuntu-only\"></a>添加串行端口权限 - 仅适用于 Ubuntu\r\n\r\n如果使用 Ubuntu，请确保普通用户有权在 Sparkfun ESP8266 Thing Dev 的 USB 端口上操作。 若要为普通用户添加串行端口权限，请执行以下步骤：\r\n\r\n1. 在终端中运行以下命令：\r\n\r\n   ```bash\r\n   ls -l /dev/ttyUSB*\r\n   ls -l /dev/ttyACM*\r\n   ```\r\n\r\n   返回以下输出之一：\r\n\r\n   * crw-rw---- 1 root uucp xxxxxxxx\r\n   * crw-rw---- 1 root dialout xxxxxxxx\r\n\r\n   请注意，在输出中，`uucp` 或 `dialout` 是 USB 端口的组所有者名称。\r\n\r\n1. 运行以下命令，将用户添加到该组中：\r\n\r\n   ```bash\r\n   sudo usermod -a -G <group-owner-name> <username>\r\n   ```\r\n\r\n   `<group-owner-name>` 是在上一步骤中获取的组所有者名称。 `<username>` 是 Ubuntu 用户名。\r\n\r\n1. 从 Ubuntu 中注销，并再次登录，使更改生效。\r\n\r\n## <a name=\"collect-sensor-data-and-send-it-to-your-iot-hub\"></a>收集传感器数据并将其发送到 IoT 中心\r\n\r\n在本部分，会在 Sparkfun ESP8266 Thing Dev 上部署并运行一个示例应用程序。 该示例应用程序会使 Sparkfun ESP8266 Thing Dev 上的 LED 闪烁，并将从 DHT22 传感器收集的温度和湿度数据发送到 IoT 中心。\r\n\r\n### <a name=\"get-the-sample-application-from-github\"></a>从 GitHub 获取示例应用程序\r\n\r\n该示例应用程序托管在 GitHub 中。 从 GitHub 中克隆包含该示例应用程序的示例存储库。 若要克隆示例存储库，请执行以下步骤：\r\n\r\n1. 打开命令提示符或终端窗口。\r\n1. 转到用于存储示例应用程序的文件夹。\r\n1. 运行以下命令：\r\n\r\n   ```bash\r\n   git clone https://github.com/Azure-Samples/iot-hub-SparkFun-ThingDev-client-app.git\r\n   ```\r\n\r\n在 Arduino IDE 中安装 Sparkfun ESP8266 Thing Dev 的程序包：\r\n\r\n1. 打开存储示例应用程序的文件夹。\r\n1. 在 Arduino IDE 中打开 app 文件夹中的 app.ino 文件。\r\n\r\n   ![在 arduino ide 中打开示例应用程序](./media/iot-hub-sparkfun-thing-dev-get-started/10_arduino-ide-open-sample-app.png)\r\n\r\n1. 在 Arduino IDE 中，单击“File”（文件） > “Preferences”（首选项）。\r\n1. 在“Preferences”（首选项）对话框中，单击“Additional Boards Manager URLs”（其他 Boards Manager URL）文本框旁边的图标。\r\n1. 在弹出窗口中输入以下 URL，然后单击“OK”（确定）。\r\n\r\n   `http://arduino.esp8266.com/stable/package_esp8266com_index.json`\r\n\r\n   ![指向 arduino ide 中的包 url](./media/iot-hub-sparkfun-thing-dev-get-started/11_arduino-ide-package-url.png)\r\n\r\n1. 在“Preference”（首选项）对话框中，单击“OK”（确定）。\r\n1. 单击“Tools”（工具） > “Board”（开发板） > “Boards Manager”，然后搜索 esp8266。\r\n   应安装 2.2.0 或更高版本的 ESP8266。\r\n\r\n   ![已安装 esp8266 包](./media/iot-hub-sparkfun-thing-dev-get-started/12_arduino-ide-esp8266-installed.png)\r\n\r\n1. 单击“Tools”（工具） > “Board”（开发板） > “Sparkfun ESP8266 Thing Dev”。\r\n\r\n### <a name=\"install-necessary-libraries\"></a>安装所需的库\r\n\r\n1. 在 Arduino IDE 中，单击“Sketch” > “Include Library”（包含库） > “Manage Libraries”（管理库）。\r\n1. 逐个搜索以下库名称。 对于找到的每个库，单击“Install”（安装）。\r\n   * `AzureIoTHub`\r\n   * `AzureIoTUtility`\r\n   * `AzureIoTProtocol_MQTT`\r\n   * `ArduinoJson`\r\n   * `DHT sensor library`\r\n   * `Adafruit Unified Sensor`\r\n\r\n### <a name=\"dont-have-a-real-dht22-sensor\"></a>没有真正的 DHT22 传感器？\r\n\r\n如果没有真正的 DHT22 传感器，示例应用程序可以模拟温度和湿度数据。 若要让示例应用程序使用模拟的数据，请执行以下步骤：\r\n\r\n1. 打开 `app` 文件夹中的 `config.h` 文件。\r\n1. 找到以下代码行并将值从 `false` 更改为 `true`：\r\n   ```c\r\n   define SIMULATED_DATA true\r\n   ```\r\n   ![将示例应用程序配置为使用模拟数据](./media/iot-hub-sparkfun-thing-dev-get-started/13_arduino-ide-configure-app-use-simulated-data.png)\r\n   \r\n1. 使用 `Control-s` 保存该文件。\r\n\r\n### <a name=\"deploy-the-sample-application-to-sparkfun-esp8266-thing-dev\"></a>将示例应用程序部署到 Sparkfun ESP8266 Thing Dev\r\n\r\n1. 在 Arduino IDE 中，单击“Tool”（工具） > “Port”（端口），然后单击 Sparkfun ESP8266 Thing Dev 的串行端口。\r\n1. 单击 “Sketch” > “Upload”（上传），生成示例应用程序并将其部署到 Sparkfun ESP8266 Thing Dev。\r\n\r\n> [!Note]\r\n> 如果你使用 macOS，那么可能会在上传期间看到以下消息。 `warning: espcomm_sync failed`,`error: espcomm_open failed`. 请打开终端窗口，然后完成以下操作来解决此问题。\r\n> ```bash\r\n> cd /System/Library/Extensions/IOUSBFamily.kext/Contents/PlugIns\r\n> sudo mv AppleUSBFTDI.kext AppleUSBFTDI.disabled\r\n> sudo touch /System/Library/Extensions\r\n> ```\r\n\r\n### <a name=\"enter-your-credentials\"></a>输入凭据\r\n\r\n上传成功完成后，请执行以下步骤输入凭据：\r\n\r\n1. 在 Arduino IDE 中，单击“Tools”（工具） > “Serial Monitor”（串行监视器）。\r\n1. 在串行监视器窗口的右下角，可以看到两个下拉列表。\r\n1. 在左侧下拉列表中选择“No line ending”（无行尾）。\r\n1. 在右侧下拉列表中选择“115200 baud”（115200 波特率）。\r\n1. 在串行监视器窗口顶部的输入框中输入以下信息（如果系统要求提供），并单击“Send”（发送）。\r\n   * Wi-Fi SSID\r\n   * Wi-Fi 密码\r\n   * 设备连接字符串\r\n\r\n> [!Note]\r\n> 凭据信息存储在 Sparkfun ESP8266 Thing Dev 的 EEPROM 中。 如果在 Sparkfun ESP8266 Thing Dev 开发板上单击重置按钮，示例应用程序会询问是否要擦除这些信息。 输入 `Y` 可擦除信息，系统会再次要求提供这些信息。\r\n\r\n### <a name=\"verify-the-sample-application-is-running-successfully\"></a>验证示例应用程序是否成功运行\r\n\r\n如果串行监视器窗口中显示以下输出并且 Sparkfun ESP8266 Thing Dev 上的 LED 闪烁，则表示示例应用程序已成功运行。\r\n\r\n![arduino ide 中的最终输出](./media/iot-hub-sparkfun-thing-dev-get-started/14_arduino-ide-final-output.png)\r\n\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n现已成功将 Sparkfun ESP8266 Thing Dev 连接到 IoT 中心，并将捕获的传感器数据发送到了 IoT 中心。 \r\n\r\n[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]\r\n\r\n<!--Update_Description:update meta properties and wording-->"}