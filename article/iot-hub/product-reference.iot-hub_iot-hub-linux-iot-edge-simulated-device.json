{"Title":"使用 Azure IoT Edge 模拟设备 (Linux)","Description":"如何在 Linux 上使用 Azure IoT Edge 创建模拟设备，从而通过 IoT Edge 网关将遥测数据发送到 IoT 中心。","Content":"<a id=\"use-azure-iot-edge-to-send-device-to-cloud-messages-with-a-simulated-device-linux\"></a>\r\n\r\n# 使用 Azure IoT Edge，通过模拟设备发送设备到云的消息 (Linux)\r\n\r\n[!INCLUDE [iot-hub-iot-edge-simulated-selector](../../includes/iot-hub-iot-edge-simulated-selector.md)]\r\n\r\n[!INCLUDE [iot-hub-iot-edge-install-build-linux](../../includes/iot-hub-iot-edge-install-build-linux.md)]\r\n\r\n<a id=\"how-to-run-the-sample\"></a>\r\n\r\n## 如何运行示例\r\n\r\n**build.sh** 脚本在 **iot-edge** 存储库本地副本的 **build** 文件夹中生成输出。 该输出包括此示例中使用的四个 IoT Edge 模块。\r\n\r\n生成脚本将会：\r\n\r\n* 将 **liblogger.so** 放在 **build/modules/logger** 文件夹中。\r\n* 将 **libiothub.so** 放在 **build/modules/iothub** 文件夹中。\r\n* 将 **lib\\_identity\\_map.so** 放在 **build/modules/identitymap** 文件夹中。\r\n* 将 **libsimulated\\_device.so** 放在 **build/modules/simulated\\_device** 文件夹中。\r\n\r\n如以下 JSON 设置文件中所示，将这些路径用于 **module path** 值：\r\n\r\nsimulated\\_device\\_cloud\\_upload\\_sample 过程使用 JSON 配置文件的路径作为命令行参数。 以下示例 JSON 文件在 SDK 存储库的 **samples\\\\simulated\\_device\\_cloud\\_upload\\_sample\\\\src\\\\simulated\\_device\\_cloud\\_upload\\_sample\\_lin.json** 路径中提供。 除非修改了生成脚本，将 IoT Edge 模块或示例可执行文件放置在非默认位置，否则，此配置文件可按原样工作。\r\n\r\n> [!NOTE]\r\n> 模块路径相对于从中运行 simulated\\_device\\_cloud\\_upload\\_sample 可执行文件的目录，而不是可执行文件所在的目录。 示例 JSON 配置文件默认写入到当前工作目录中的“deviceCloudUploadGatewaylog.log”。\r\n\r\n在文本编辑器中，打开 **iot-edge** 存储库本地副本中的文件 **samples/simulated\\_device\\_cloud\\_upload\\_sample/src/simulated\\_device\\_cloud\\_upload\\_lin.json**。 此文件配置示例网关中的 IoT Edge 模块：\r\n\r\n* **IoTHub** 模块连接到 IoT 中心。 将该模块配置为将数据发送到 IoT 中心。 具体而言，将 **IoTHubName** 值设置为 IoT 中心的名称，将 **IoTHubSuffix** 值设置为 **azure-devices.cn**。 将“传输”值设置为“HTTP”、“AMQP”或“MQTT”其中的一个。 目前只有“HTTP”会针对所有设备消息共享一个 TCP 连接。 如果将值设置为“AMQP”或“MQTT”，则网关将为每个设备维护与 IoT 中心的单独 TCP 连接。\r\n* **mapping** 模块将模拟设备的 MAC 地址映射到 IoT 中心设备 ID。 确保 **deviceId** 值与添加到 IoT 中心的两台设备的 ID 一致，确保 **deviceKey** 值包含两台设备的密钥。\r\n* **BLE1** 和 **BLE2** 模块是模拟设备。 注意模块 MAC 地址如何与“映射”模块中的地址匹配。\r\n* **Logger** 模块将网关活动记录到一个文件中。\r\n* 示例中所示的 **module path** 值假定将从 **iot-edge** 存储库本地副本的 **build** 文件夹运行示例。\r\n* JSON 文件底部的 **links** 数组将 **BLE1** 和 **BLE2** 模块连接到 **mapping** 模块，并将 **mapping** 模块连接到 **IoTHub** 模块。 它还确保 **Logger** 模块记录所有消息。\r\n\r\n```json\r\n{\r\n    \"modules\": [\r\n        {\r\n            \"name\": \"IotHub\",\r\n          \"loader\": {\r\n            \"name\": \"native\",\r\n            \"entrypoint\": {\r\n              \"module.path\": \"./modules/iothub/libiothub.so\"\r\n            }\r\n            },\r\n            \"args\": {\r\n              \"IoTHubName\": \"<<insert here IoTHubName>>\",\r\n              \"IoTHubSuffix\": \"<<insert here IoTHubSuffix>>\",\r\n              \"Transport\": \"HTTP\"\r\n            }\r\n          },\r\n        {\r\n            \"name\": \"mapping\",\r\n          \"loader\": {\r\n            \"name\": \"native\",\r\n            \"entrypoint\": {\r\n              \"module.path\": \"./modules/identitymap/libidentity_map.so\"\r\n            }\r\n            },\r\n            \"args\": [\r\n              {\r\n                \"macAddress\": \"01:01:01:01:01:01\",\r\n                \"deviceId\": \"<<insert here deviceId>>\",\r\n                \"deviceKey\": \"<<insert here deviceKey>>\"\r\n              },\r\n              {\r\n                \"macAddress\": \"02:02:02:02:02:02\",\r\n                \"deviceId\": \"<<insert here deviceId>>\",\r\n                \"deviceKey\": \"<<insert here deviceKey>>\"\r\n              }\r\n            ]\r\n          },\r\n        {\r\n            \"name\": \"BLE1\",\r\n          \"loader\": {\r\n            \"name\": \"native\",\r\n            \"entrypoint\": {\r\n              \"module.path\": \"./modules/simulated_device/libsimulated_device.so\"\r\n            }\r\n            },\r\n            \"args\": {\r\n              \"macAddress\": \"01:01:01:01:01:01\"\r\n            }\r\n          },\r\n        {\r\n            \"name\": \"BLE2\",\r\n          \"loader\": {\r\n            \"name\": \"native\",\r\n            \"entrypoint\": {\r\n              \"module.path\": \"./modules/simulated_device/libsimulated_device.so\"\r\n            }\r\n            },\r\n            \"args\": {\r\n              \"macAddress\": \"02:02:02:02:02:02\"\r\n            }\r\n          },\r\n        {\r\n            \"name\": \"Logger\",\r\n          \"loader\": {\r\n            \"name\": \"native\",\r\n            \"entrypoint\": {\r\n              \"module.path\": \"./modules/logger/liblogger.so\"\r\n            }\r\n            },\r\n            \"args\": {\r\n              \"filename\": \"deviceCloudUploadGatewaylog.log\"\r\n            }\r\n          }\r\n    ],\r\n    \"links\": [\r\n        {\r\n            \"source\": \"*\",\r\n            \"sink\": \"Logger\"\r\n        },\r\n        {\r\n            \"source\": \"BLE1\",\r\n            \"sink\": \"mapping\"\r\n        },\r\n        {\r\n            \"source\": \"BLE2\",\r\n            \"sink\": \"mapping\"\r\n        },\r\n        {\r\n            \"source\": \"mapping\",\r\n            \"sink\": \"IotHub\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n保存对配置文件所做的更改。\r\n\r\n运行示例：\r\n\r\n1. 在 shell 中，浏览到 **iot-edge/build** 文件夹。\r\n2. 运行以下命令：\r\n   \r\n    ```sh\r\n    ./samples/simulated_device_cloud_upload/simulated_device_cloud_upload_sample ../samples/simulated_device_cloud_upload/src/simulated_device_cloud_upload_lin.json\r\n    ```\r\n3. 可使用[设备资源管理器][lnk-device-explorer]或 [iothub-explorer][lnk-iothub-explorer] 工具监视 IoT 中心从网关接收的消息。 例如，若使用 iothub-explorer，可通过以下命令监视设备到云的消息：\r\n\r\n    ```sh\r\n    iothub-explorer monitor-events --login \"HostName={Your iot hub name}.azure-devices.cn;SharedAccessKeyName=iothubowner;SharedAccessKey={Your IoT Hub key}\"\r\n    ```\r\n\r\n<a id=\"next-steps\"></a>\r\n\r\n## 后续步骤\r\n\r\n若要深入了解 Azure IoT Edge 并尝试一些代码示例，请访问以下开发人员教程和资源：\r\n\r\n* [使用 Azure IoT Edge 从物理设备发送设备到云的消息][lnk-physical-device]\r\n* [Azure IoT Edge][lnk-iot-edge]\r\n\r\n若要进一步探索 IoT 中心的功能，请参阅：\r\n\r\n* [IoT 中心开发人员指南][lnk-devguide]\r\n* [从根本上保护 IoT 解决方案][lnk-securing]\r\n\r\n<!-- Links -->\r\n[lnk-iot-edge]: https://github.com/Azure/iot-edge/\r\n[lnk-physical-device]: ./iot-hub-iot-edge-physical-device.md\r\n[lnk-devguide]: ./iot-hub-devguide.md\r\n[lnk-securing]: ./iot-hub-security-ground-up.md\r\n[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/tools/DeviceExplorer\r\n[lnk-iothub-explorer]: https://github.com/Azure/iothub-explorer/blob/master/readme.md\r\n"}