{"Title":"CDN REST 接口调用及说明","Description":"CDN REST 接口调用及说明","Content":"# CDN REST 接口调用及说明\r\n\r\n有些客户在尝试使用 REST 接口访问 CDN 服务会遇到了一些问题，导致调用失败。比如，在请求时不清楚 Authorization 的构建、或者在构建 Authorization 时出现各种异常，这篇文章将对这些问题进行解答。\r\n\r\n需要注意的是，目前 CDN 提供了两套 REST 接口，一套是 ASM（经典模式），另外一套是 ARM（资源管理器），API 接口地址参考：\r\n\r\n- ASM CDN：https://docs.azure.cn/zh-cn/cdn/cdn-api \r\n- ARM CDN：https://docs.microsoft.com/zh-cn/rest/api/cdn/\r\n\r\n本节我们重点介绍以下 3 个 ASM CDN REST 接口的使用，如果对于 ARM CDN 的使用有更多问题，可以联系通过 400-085-0319 联系开发技术支持团队。\r\n\r\n- [创建节点 (JAVA 示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-create-endpoint)\r\n- [节点管理 - 获取节点信息 (JAVA 示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-get-endpoint)\r\n- [缓存刷新 (C#示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-add-purge)\r\n\r\n## 创建节点调用详解\r\n\r\n- Endpoint：\r\n\r\n    `POST https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints?apiVersion=1.0`\r\n\r\n- 请求参数：\r\n\r\n    | 参数名称 | 参数值 |\r\n    | ------- | ------ |\r\n    | x-azurecdn-request-date | 必填。符合 yyyy-MM-dd hh:mm:ss 格式的 UTC 当前请求时间 |\r\n    | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r\n    | content-type |\t必填。application/json |\r\n    | Body | 必填。参考 API 连接中的解释 |\r\n\r\n    这里我们主要解释 Authorization 的生成，[CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature)中提供了不同语言生成认证头的代码示例，这里我们以 Java 作为说明，方法定义如下：\r\n\r\n    ```Java\r\n    public static String calculateAuthorizationHeader(\r\n        String requestURL, \r\n        String requestTime, \r\n        String keyID, \r\n        String keyValue, \r\n        String httpMethod) throws Exception {\r\n    …\r\n    }\r\n    ```\r\n\r\n- requestURL\r\n\r\n    即填充后的 Endpoint 值，subscriptionId 需要设置为实际值，参考示例：\r\n    https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints?apiVersion=1.0\r\n\r\n- requestTime\r\n\r\n    该参数的设置与请求中 `x-azurecdn-request-date` 的值一致，符合 `yyyy-MM-dd hh:mm:ss` 格式的 UTC 时间即可。参数示例：\r\n\r\n    `2017-09-01 09:00:00`\r\n\r\n- keyID 与 keyValue\r\n\r\n    通过 Azure 门户登录 CDN 节点管理门户，在 “**安全管理**” - “**秘钥管理**” 中获取秘钥，需要注意的是，秘钥的读写权限需要与请求的 URL 方法权限吻合。比如 “**Post**” 或 “**Put**” 类的请求，需要 “**写**” 权限的秘钥，对于 “**Get**” 请求则需要 “**读**” 权限的秘钥。\r\n\r\n    ![portal](media/aog-cdn-rest-api-interface-and-introduction/portal.png)\r\n\r\n- httpMethod\r\n\r\n    请求方法类型，参数值示例：`POST`。\r\n\r\n### 测试用例\r\n\r\n```Java\r\nString requestURL = \"https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints?apiVersion=1.0\";\r\n \r\nString requestTimestamp = TimeUtil.getUTCTime();\r\nString keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r\nString keyValue = \"<cdn-key>\";\r\nString httpMethod = \"POST\";\r\n\r\nCdnOperation cOperation = new CdnOperation();\r\nString authorization = cOperation.calculateAuthorizationHeader(\r\n            requestURL, \r\n            requestTimestamp,\r\n            keyID, \r\n            keyValue, \r\n            httpMethod);\r\n            \r\n// 创建节点\r\nString requestBody = Files.toString(\r\nnew File(\"D:\\\\workspace\\\\java\\\\azure-cdn-\r\ndemo\\\\src\\\\test\\\\java\\\\geo\\\\azure\\\\cdn\\\\request_body.json\",\r\n            Charsets.UTF_8);\r\n\r\nString result = cOperation.postRequest(\r\n            requestURL,\r\n            authorization, \r\n            requestBody,\r\n            requestTimestamp);\r\nSystem.out.println(result);\r\n\r\n2017-7-26 5:37:18\r\nAzureCDN cc65a046-2a32-4f7d-ab22-9ae49507d719:CB82B4555573CCE40FF2BAB1C5AA256C35CFDA5175F4B3E7C5A4905A98E08BF9\r\n{\"EndpointId\":\"8137ecc4-71c4-11e7-8259-0017fa00a611\",\"Settings\":{\"CustomDomain\":\"file.azurecloudapi.cn\",\"Host\":\"file.azurecloudapi.cn\",\"Origin\":{\"Addresses\":[\"devstoragerm.blob.core.chinacloudapi.cn\"]},\"ICP\":\"?ICP?16013159?\",\"ServiceType\":\"Download\",\"AllowedScheme\":0},\"Status\":{\"Enabled\":false,\"IcpVerifyStatus\":\"IcpVerifying\",\"LifetimeStatus\":\"Creating\",\"CNameConfigured\":false,\"FreeTrialExpired\":false,\"TimeLastUpdated\":\"2017-07-26T05:37:47.4718609+00:00\"}}\r\n```\r\n\r\n## 获取节点信息调用详解\r\n\r\n- Endpoint\r\n\r\n    `GET https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints/{endpointId}?apiVersion=1.0`\r\n\r\n- 请求参数\r\n\r\n    | 参数名称 | 参数值 |\r\n    | ------- | ------ |\r\n    | x-azurecdn-request-date | 必填。符合yyyy-MM-dd hh:mm:ss格式的UTC当前请求时间 |\r\n    | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r\n\r\n### 测试用例\r\n\r\n```Java\r\nString requestURL = \"https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints/8137ecc4-71c4-11e7-8259-0017fa00a611?apiVersion=1.0\";\r\n \r\nString requestTimestamp = TimeUtil.getUTCTime();\r\nString keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r\nString keyValue = \"<cdn-key>\";\r\nString httpMethod = \"GET\";\r\n\r\nCdnOperation cOperation = new CdnOperation();\r\nString authorization = cOperation.calculateAuthorizationHeader(\r\n            requestURL, \r\n            requestTimestamp,\r\n            keyID, \r\n            keyValue, \r\n            httpMethod);\r\n      \r\nString result = cOperation.getRequest(\r\n            requestURL,\r\n            authorization, \r\n            requestTimestamp);\r\nSystem.out.println(result);\r\n\r\nAzureCDN cc65a046-2a32-4f7d-ab22-9ae49507d719:AE889EA579556251F5CA57B19361BE57C22550F0D8E4941E50819CB9F0296967\r\n{\"EndpointId\":\"8137ecc4-71c4-11e7-8259-0017fa00a611\",\"Settings\":{\"CustomDomain\":\"file.azurecloudapi.cn\",\"Host\":\"file.azurecloudapi.cn\",\"Origin\":{\"Addresses\":[\"devstoragerm.blob.core.chinacloudapi.cn\"],\"SchemePort\":{\"Scheme\":\"Http\",\"HttpPort\":80}},\"ICP\":\"?ICP?16013159?\",\"ServiceType\":\"Download\",\"AllowedScheme\":\"Http\",\"CName\":\"file.azurecloudapi.cn.mschcdn.com\"},\"Status\":{\"Enabled\":true,\"IcpVerifyStatus\":\"IcpVerified\",\"LifetimeStatus\":\"Normal\",\"CNameConfigured\":false,\"FreeTrialExpired\":false,\"TimeLastUpdated\":\"2017-07-26T05:46:00+00:00\"}}\r\n```\r\n\r\n## 刷新缓存调用详解\r\n\r\n- Endpoint：\r\n\r\n    `POST https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints/{endpointId}/purges?apiVersion=1.0`\r\n\r\n- 请求参数\r\n\r\n    | 参数名称 | 参数值 |\r\n    | ------- | ------ |\r\n    | x-azurecdn-request-date | 必填。符合yyyy-MM-dd hh:mm:ss格式的UTC当前请求时间 |\r\n    | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r\n    | content-type | application/json |\r\n\r\n### 测试用例\r\n\r\n```Java\r\nstatic void Main(string[] args)\r\n{\r\n// get\r\n    var requestUrl = string.Format(\"https://restapi.cdn.azure.cn/subscriptions/{0}/endpoints?apiVersion=1.0\", \"e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb\");\r\n    var requestTime = DateTime.Now.AddHours(-8)\r\n        .ToString(\"yyyy-MM-dd hh:mm:ss\");\r\n    var keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r\n    var keySecret = \"秘钥\";\r\n    var requestAuth = CalculateAuthorizationHeader(\r\n\t\trequestUrl, requestTime, keyID, keySecret, \"GET\");\r\n    Console.WriteLine(requestTime);\r\n    Console.WriteLine(requestAuth);   \r\n    get(requestUrl, requestAuth, requestTime);\r\n\r\n    requestUrl = string.Format(\"https://restapi.cdn.azure.cn/subscriptions/{0}/endpoints/{1}/purges?apiVersion=1.0\", \"e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb\", \"4f7e4141-83d0-11e7-8259-0017fa00a611\");\r\n    requestTime = DateTime.Now.AddHours(-8)\r\n\t\t.ToString(\"yyyy-MM-dd hh:mm:ss\");\r\n    keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r\n    keySecret = \"秘钥\";\r\n    requestAuth = CalculateAuthorizationHeader(\r\n        requestUrl, requestTime, keyID, keySecret, \"POST\");\r\n    var requestBody = \"{\\\"Files\\\": [\\\"http://azurecloudapi.cn/wp-content/uploads/2016/09/logo2-1.png\\\"],\\\"Directories\\\": [ \\\"http://azurecloudapi.cn/wp-content/uploads/2016/09/\\\"]}\";\r\n    post(requestUrl, requestAuth, requestTime,requestBody);\r\n    Console.ReadLine();\r\n}\r\n\r\nstatic  void get(string requestUrl, string requestAuth, string requestTime)\r\n{\r\n\r\n    Uri uri = new Uri(requestUrl);\r\n    HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri);\r\n    request.Method = \"GET\";\r\n    request.Headers[\"x-azurecdn-request-date\"] = requestTime;\r\n    request.Headers[\"Authorization\"] = requestAuth;\r\n\r\n    try\r\n    {\r\n        HttpWebResponse response = (HttpWebResponse)request.GetResponse();\r\n        using (StreamReader reader = new \r\n        StreamReader(response.GetResponseStream()))\r\n        {\r\n            var result = reader.ReadToEnd();\r\n            Console.WriteLine(result);\r\n        }\r\n        response.Close();\r\n\r\n    }\r\n    catch (WebException ex)\r\n    {\r\n        Console.WriteLine(ex);\r\n    }\r\n}\r\n\r\nstatic async void post(string requestUrl, string requestAuth, string requestTime, string requestBody)\r\n{\r\n    Uri uri = new Uri(requestUrl);\r\n    HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri);\r\n    request.Method = \"POST\";\r\n    request.Headers[\"x-azurecdn-request-date\"] = requestTime;\r\n    request.Headers[\"Authorization\"] = requestAuth;\r\n\r\n    byte[] byteArray = Encoding.UTF8.GetBytes(requestBody);\r\n    request.ContentLength = byteArray.Length;\r\n    Stream newStream = request.GetRequestStream();\r\n    newStream.Write(byteArray, 0, byteArray.Length);\r\n    newStream.Close();\r\n\r\n    try\r\n    {\r\n        HttpWebResponse response = (HttpWebResponse)request.GetResponse();\r\n\r\n        using (StreamReader reader = new StreamReader(response.GetResponseStream()))\r\n        {\r\n            var result = reader.ReadToEnd();\r\n            Console.WriteLine(result);\r\n        }\r\n        response.Close();\r\n    }\r\n    catch (WebException ex)\r\n    {\r\n        Console.WriteLine(ex);\r\n    }\r\n}\r\n```\r\n\r\n## 示例代码\r\n\r\n[Azure CDN Demo](https://github.com/wacn/AOG-CodeSample/tree/master/cdn/Java/azure-cdn-demo-master)"}