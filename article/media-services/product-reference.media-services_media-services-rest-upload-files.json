{"Title":"使用 REST 将文件上传到媒体服务帐户","Description":"了解如何通过创建和上传资产将媒体内容加入媒体服务。","Content":"# <a name=\"upload-files-into-a-media-services-account-using-rest\"></a>使用 REST 将文件上传到媒体服务帐户\r\n> [!div class=\"op_single_selector\"]\r\n> * [.NET](media-services-dotnet-upload-files.md)\r\n> * [REST](media-services-rest-upload-files.md)\r\n> * [门户](media-services-portal-upload-files.md)\r\n> \r\n> \r\n\r\n在媒体服务中，可以将数字文件上传到资产中。 [资产](https://docs.microsoft.com/rest/api/media/operations/asset)实体可以包含视频、音频、图像、缩略图集合、文本轨道和隐藏式字幕文件（以及这些文件的相关元数据。）将文件上传到资产后，相关内容即安全地存储在云中供后续处理和流式处理。 \r\n\r\n> [!NOTE]\r\n> 请注意以下事项：\r\n> \r\n> * 构建流内容的 URL 时，媒体服务会使用 IAssetFile.Name 属性的值（如 http://{AMSAccount}.origin.mediaservices.chinacloudapi.cn/{GUID}/{IAssetFile.Name}/streamingParameters。）出于这个原因，不允许使用百分号编码。 **Name** 属性的值不能含有任何以下[百分号编码保留字符](http://zh.wikipedia.org/wiki/百分号编码#.E4.BF.9D.E7.95.99.E5.AD.97.E7.AC.A6.E7.9A.84.E7.99.BE.E5.88.86.E5.8F.B7.E7.BC.96.E7.A0.81)：!*'();:@&=+$,/?%#[]\"。 此外，文件扩展名中只能含有一个“.”。\r\n> * 名称长度不应超过 260 个字符。\r\n> * 在媒体服务中进行处理时，系统支持的最大文件大小存在限制。 有关文件大小限制的详细信息，请参阅[此主题](media-services-quotas-and-limitations.md)。\r\n> \r\n\r\n上传资产的基本工作流分为下列各节：\r\n\r\n* 创建资产\r\n* 对资产加密（可选）\r\n* 将文件上传到 blob 存储\r\n\r\nAMS 还可用于批量上传资产。 有关详细信息，请参阅[此](media-services-rest-upload-files.md#upload_in_bulk)部分。\r\n\r\n> [!NOTE]\r\n> 访问媒体服务中的实体时，必须在 HTTP 请求中设置特定标头字段和值。 有关详细信息，请参阅[媒体服务 REST API 开发的设置](media-services-rest-how-to-use.md)。\r\n> \r\n\r\n## <a name=\"connect-to-media-services\"></a>连接到媒体服务\r\n\r\n若要了解如何连接到 AMS API，请参阅[通过 Azure AD 身份验证访问 Azure 媒体服务 API](media-services-use-aad-auth-to-access-ams-api.md)。 \r\n\r\n\r\n## <a name=\"upload-assets\"></a>上传资产\r\n\r\n### <a name=\"create-an-asset\"></a>创建资产\r\n\r\n资产是媒体服务中多种类型的对象或多组对象（包括视频、音频、图像、缩略图集合、文本轨道和隐藏的解释性字幕文件）的容器。 在 REST API 中，创建资产需要向媒体服务发送 POST 请求，并将任何有关资产的属性信息放入请求正文中。\r\n\r\n创建资产时可以指定的属性之一是 **Options**。 **Options** 是一个枚举值，描述可用于创建资产的加密选项。 有效值为以下列表中的某个值，而不是这些值的组合。 \r\n\r\n* None = 0：不使用加密。 这是默认值。 请注意，使用此选项时，内容在传送过程中或静态存储过程中都不会受到保护。\r\n    如果计划使用渐进式下载交付 MP4，则使用此选项。 \r\n* StorageEncrypted = 1：如果要使用 AES-256 位加密法对文件加密以方便上传和存储，请指定此值。\r\n  \r\n    如果资产已经过存储加密，则必须配置资产传送策略。 有关详细信息，请参阅[配置资产传送策略](media-services-rest-configure-asset-delivery-policy.md)。\r\n* CommonEncryptionProtected = 2：如果要上传使用通用加密法（例如 PlayReady）保护的文件，请指定此值。 \r\n* EnvelopeEncryptionProtected = 4：如果要上传使用 AES 文件加密的 HLS，请指定此值。 请注意，Transform Manager 必须已对文件进行编码和加密。\r\n\r\n> [!NOTE]\r\n> 如果资产要使用加密，必须按以下主题中所述创建 ContentKey 并将其链接到资产：[如何创建 ContentKey](media-services-rest-create-contentkey.md)。 请注意，将文件上传到资产后，需要使用加密资产期间获取的值更新 AssetFile 实体上的加密属性。 使用 **MERGE** HTTP 请求完成此操作。 \r\n> \r\n> \r\n\r\n以下示例说明了如何创建资产。\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Assets HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-2233-b1ae-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421640053&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=vlG%2fPYdFDMS1zKc36qcFVWnaNh07UCkhYj3B71%2fk1YA%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n\r\n{\"Name\":\"BigBuckBunny.mp4\"}\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n如果成功，返回以下响应：\r\n\r\n```\r\nHTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 452\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Assets('nb%3Acid%3AUUID%3A9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1')\r\nServer: Microsoft-IIS/8.5\r\nx-ms-client-request-id: c59de965-bc89-4295-9a57-75d897e5221e\r\nrequest-id: e98be122-ae09-473a-8072-0ccd234a0657\r\nx-ms-request-id: e98be122-ae09-473a-8072-0ccd234a0657\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Sun, 18 Jan 2015 22:06:40 GMT\r\n{  \r\n   \"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#Assets/@Element\",\r\n   \"Id\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\",\r\n   \"State\":0,\r\n   \"Created\":\"2015-01-18T22:06:40.6010903Z\",\r\n   \"LastModified\":\"2015-01-18T22:06:40.6010903Z\",\r\n   \"AlternateId\":null,\r\n   \"Name\":\"BigBuckBunny.mp4\",\r\n   \"Options\":0,\r\n   \"Uri\":\"https://storagetestaccount001.blob.core.chinacloudapi.cn/asset-9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\",\r\n   \"StorageAccountName\":\"storagetestaccount001\"\r\n}\r\n```\r\n\r\n### <a name=\"create-an-assetfile\"></a>创建 AssetFile\r\n[AssetFile](https://docs.microsoft.com/rest/api/media/operations/assetfile) 实体表示 blob 容器中存储的视频或音频文件。 一个资产文件始终与一个资产关联，而一个资产则可能包含一个或多个资产文件。 如果资产文件对象未与 blob 容器中的数字文件关联，则媒体服务编码器任务将失败。\r\n\r\n请注意， **AssetFile** 实例和实际媒体文件是两个不同的对象。 AssetFile 实例包含有关媒体文件的元数据，而媒体文件包含实际媒体内容。\r\n\r\n将数字媒体文件上传到 blob 容器后，需要使用 MERGE HTTP 请求来更新 AssetFile 中有关媒体文件的信息（如本主题稍后所述）。 \r\n\r\n**HTTP 请求**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Files HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-4ca2-2233-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421640053&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=vlG%2fPYdFDMS1zKc36qcFVWnaNh07UCkhYj3B71%2fk1YA%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 164\r\n\r\n{  \r\n   \"IsEncrypted\":\"false\",\r\n   \"IsPrimary\":\"false\",\r\n   \"MimeType\":\"video/mp4\",\r\n   \"Name\":\"BigBuckBunny.mp4\",\r\n   \"ParentAssetId\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\"\r\n}\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nHTTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 535\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Files('nb%3Acid%3AUUID%3Af13a0137-0a62-9d4c-b3b9-ca944b5142c5')\r\nServer: Microsoft-IIS/8.5\r\nrequest-id: 98a30e2d-f379-4495-988e-0b79edc9b80e\r\nx-ms-request-id: 98a30e2d-f379-4495-988e-0b79edc9b80e\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nX-Powered-By: ASP.NET\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Mon, 19 Jan 2015 00:34:07 GMT\r\n\r\n{  \r\n   \"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#Files/@Element\",\r\n   \"Id\":\"nb:cid:UUID:f13a0137-0a62-9d4c-b3b9-ca944b5142c5\",\r\n   \"Name\":\"BigBuckBunny.mp4\",\r\n   \"ContentFileSize\":\"0\",\r\n   \"ParentAssetId\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\",\r\n   \"EncryptionVersion\":null,\r\n   \"EncryptionScheme\":null,\r\n   \"IsEncrypted\":false,\r\n   \"EncryptionKeyId\":null,\r\n   \"InitializationVector\":null,\r\n   \"IsPrimary\":false,\r\n   \"LastModified\":\"2015-01-19T00:34:08.1934137Z\",\r\n   \"Created\":\"2015-01-19T00:34:08.1934137Z\",\r\n   \"MimeType\":\"video/mp4\",\r\n   \"ContentChecksum\":null\r\n}\r\n```\r\n\r\n### <a name=\"creating-the-accesspolicy-with-write-permission\"></a>创建具有写入权限的 AccessPolicy。\r\n\r\n>[!NOTE]\r\n>不同 AMS 策略的策略限制为 1,000,000 个（例如，对于定位器策略或 ContentKeyAuthorizationPolicy）。 如果始终使用相同的日期/访问权限，则应使用相同的策略 ID，例如，用于要长期就地保留的定位符的策略（非上传策略）。 有关详细信息，请参阅[此](media-services-dotnet-manage-entities.md#limit-access-policies)主题。\r\n\r\n将任何文件上传到 blob 存储之前，请设置用于对资产执行写入操作的访问策略权限。 为此，请向 AccessPolicy 实体集发送一个 HTTP POST 请求。 请在执行创建操作时定义 DurationInMinutes 值，否则会在响应中收到 500 内部服务器错误消息。 有关 AccessPolicies 的详细信息，请参阅 [AccessPolicy](https://docs.microsoft.com/rest/api/media/operations/accesspolicy)。\r\n\r\n以下示例说明了如何创建 AccessPolicy：\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-2233-b1ae-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421640053&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=vlG%2fPYdFDMS1zKc36qcFVWnaNh07UCkhYj3B71%2fk1YA%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n\r\n{\"Name\":\"NewUploadPolicy\", \"DurationInMinutes\":\"440\", \"Permissions\":\"2\"} \r\n```\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nIf successful, the following response is returned:\r\n\r\nHTTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 312\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies('nb%3Apid%3AUUID%3Abe0ac48d-af7d-4877-9d60-1805d68bffae')\r\nServer: Microsoft-IIS/8.5\r\nrequest-id: 74c74545-7e0a-4cd6-a440-c1c48074a970\r\nx-ms-request-id: 74c74545-7e0a-4cd6-a440-c1c48074a970\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Sun, 18 Jan 2015 22:18:06 GMT\r\n\r\n{  \r\n   \"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#AccessPolicies/@Element\",\r\n   \"Id\":\"nb:pid:UUID:be0ac48d-af7d-4877-9d60-1805d68bffae\",\r\n   \"Created\":\"2015-01-18T22:18:06.6370575Z\",\r\n   \"LastModified\":\"2015-01-18T22:18:06.6370575Z\",\r\n   \"Name\":\"NewUploadPolicy\",\r\n   \"DurationInMinutes\":440.0,\r\n   \"Permissions\":2\r\n}\r\n```\r\n\r\n### <a name=\"get-the-upload-url\"></a>获取上传 URL\r\n若要检索实际上传 URL，请创建一个 SAS 定位符。 定位符为希望访问资产中文件的客户端定义连接终结点的开始时间和类型。 可以为给定 AccessPolicy 和资产对创建多个定位符实体，以处理不同的客户端请求和需求。 这其中的任一定位符都可使用 AccessPolicy 的 StartTime 值和 DurationInMinutes 值来确定可以使用某 URL 的时间长度。 有关详细信息，请参阅 [定位符](https://docs.microsoft.com/rest/api/media/operations/locator)。\r\n\r\nSAS URL 采用以下格式：\r\n\r\n```\r\n{https://myaccount.blob.core.chinacloudapi.cn}/{asset name}/{video file name}?{SAS signature}\r\n```\r\n\r\n请注意以下事项：\r\n\r\n* 一项给定的资产一次最多只能与五个唯一的定位符相关联。 有关详细信息，请参阅定位符。\r\n* 如果需要立即上传文件，应将 StartTime 值设置为当前时间前五分钟。 这是因为客户端计算机与媒体服务之间可能存在时钟偏差。 此外，StartTime 值必须采用以下 DateTime 格式：YYYY-MM-DDTHH:mm:ssZ（例如，“2014-05-23T17:53:50Z”）。    \r\n* 定位符从创建到可用可能会有 30-40 秒的延迟。 SAS URL 和源定位符都会出现这个问题。\r\n\r\n以下示例说明了如何创建 SAS URL 定位符，由请求正文中的 Type 属性定义（“1”表示 SAS 定位符，“2”表示按需来源定位符）。 返回的 **Path** 属性包含上传文件时必须使用的 URL。\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-4ca2-2233-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421640053&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=vlG%2fPYdFDMS1zKc36qcFVWnaNh07UCkhYj3B71%2fk1YA%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n{  \r\n   \"AccessPolicyId\":\"nb:pid:UUID:be0ac48d-af7d-4877-9d60-1805d68bffae\",\r\n   \"AssetId\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\",\r\n   \"StartTime\":\"2015-02-18T16:45:53\",\r\n   \"Type\":1\r\n}\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n如果成功，返回以下响应：\r\n\r\n```\r\nHTTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 949\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators('nb%3Alid%3AUUID%3Aaf57bdd8-6751-4e84-b403-f3c140444b54')\r\nServer: Microsoft-IIS/8.5\r\nrequest-id: 2adeb1f8-89c5-4cc8-aa4f-08cdfef33ae0\r\nx-ms-request-id: 2adeb1f8-89c5-4cc8-aa4f-08cdfef33ae0\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nX-Powered-By: ASP.NET\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Mon, 19 Jan 2015 03:01:29 GMT\r\n\r\n{  \r\n   \"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#Locators/@Element\",\r\n   \"Id\":\"nb:lid:UUID:af57bdd8-6751-4e84-b403-f3c140444b54\",\r\n   \"ExpirationDateTime\":\"2015-02-19T00:05:53\",\r\n   \"Type\":1,\r\n   \"Path\":\"https://storagetestaccount001.blob.core.chinacloudapi.cn/asset-f438649c-313c-46e2-8d68-7d2550288247?sv=2012-02-12&sr=c&si=af57bdd8-6751-4e84-b403-f3c140444b54&sig=fE4btwEfZtVQFeC0Wh3Kwks2OFPQfzl5qTMW5YytiuY%3D&st=2015-02-18T16%3A45%3A53Z&se=2015-02-19T00%3A05%3A53Z\",\r\n   \"BaseUri\":\"https://storagetestaccount001.blob.core.chinacloudapi.cn/asset-f438649c-313c-46e2-8d68-7d2550288247\",\r\n   \"ContentAccessComponent\":\"?sv=2012-02-12&sr=c&si=af57bdd8-6751-4e84-b403-f3c140444b54&sig=fE4btwEfZtVQFeC0Wh3Kwks2OFPQfzl5qTMW5YytiuY%3D&st=2015-02-18T16%3A45%3A53Z&se=2015-02-19T00%3A05%3A53Z\",\r\n   \"AccessPolicyId\":\"nb:pid:UUID:be0ac48d-af7d-4877-9d60-1805d68bffae\",\r\n   \"AssetId\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\",\r\n   \"StartTime\":\"2015-02-18T16:45:53\",\r\n   \"Name\":null\r\n}\r\n```\r\n\r\n### <a name=\"upload-a-file-into-a-blob-storage-container\"></a>将文件上传到 Blob 存储容器\r\n设置 AccessPolicy 和定位符后，即可使用 Azure 存储 REST API 将实际文件上传到 Azure BLOB 存储容器。 必须将文件作为块 blob 上传。 页 blob 不受 Azure 媒体服务支持。  \r\n\r\n>[!NOTE]\r\n> 必须将要上传的文件的文件名添加到上一部分中收到的定位符 **Path** 值中。 例如，https://storagetestaccount001.blob.core.chinacloudapi.cn/asset-e7b02da4-5a69-40e7-a8db-e8f4f697aac0/BigBuckBunny.mp4? 。 。 。 \r\n\r\n有关使用 Azure 存储 blob 的详细信息，请参阅 [Blob 服务 REST API](https://docs.microsoft.com/rest/api/storageservices/fileservices/Blob-Service-REST-API)。\r\n\r\n### <a name=\"update-the-assetfile\"></a>更新 AssetFile \r\n\r\n上传文件后，请更新 FileAsset 大小（和其他）信息。 例如：\r\n\r\n```\r\nMERGE https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Files('nb%3Acid%3AUUID%3Af13a0137-0a62-9d4c-b3b9-ca944b5142c5') HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-4ca2-2233-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421662918&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=utmoXXbm9Q7j4tW1yJuMVA3egRiQy5FPygwadkmPeaY%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n\r\n{  \r\n   \"ContentFileSize\":\"1186540\",\r\n   \"Id\":\"nb:cid:UUID:f13a0137-0a62-9d4c-b3b9-ca944b5142c5\",\r\n   \"MimeType\":\"video/mp4\",\r\n   \"Name\":\"BigBuckBunny.mp4\",\r\n   \"ParentAssetId\":\"nb:cid:UUID:9bc8ff20-24fb-4fdb-9d7c-b04c7ee573a1\"\r\n}\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n如果成功，将返回以下响应：HTTP/1.1 204 无内容\r\n\r\n### <a name=\"delete-the-locator-and-accesspolicy\"></a>删除定位符和 AccessPolicy\r\n**HTTP 请求**\r\n\r\n```\r\nDELETE https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators('nb%3Alid%3AUUID%3Aaf57bdd8-6751-4e84-b403-f3c140444b54') HTTP/1.1\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-2233-b1ae-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421662918&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=utmoXXbm9Q7j4tW1yJuMVA3egRiQy5FPygwadkmPeaY%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n如果成功，返回以下响应：\r\n\r\n```\r\nHTTP/1.1 204 No Content \r\n...\r\n```\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nDELETE https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies('nb%3Apid%3AUUID%3Abe0ac48d-af7d-4877-9d60-1805d68bffae') HTTP/1.1\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstestaccount001&urn%3aSubscriptionId=z7f09258-6753-2233-b1ae-193798e2c9d8&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1421662918&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=utmoXXbm9Q7j4tW1yJuMVA3egRiQy5FPygwadkmPeaY%3d\r\nx-ms-version: 2.11\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n如果成功，返回以下响应：\r\n\r\n```\r\nHTTP/1.1 204 No Content \r\n...\r\n```\r\n\r\n## <a id=\"upload_in_bulk\"></a>批量上传资产\r\n### <a name=\"create-the-ingestmanifest\"></a>创建 IngestManifest\r\nIngestManifest 是一个容器，用于放置一组资产、资产文件以及可用于确定该组资产或文件的批量引入进度的统计信息。\r\n\r\n**HTTP 请求**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/IngestManifests HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 36\r\nExpect: 100-continue\r\n\r\n{ \"Name\" : \"ExampleManifestREST\" }\r\n```\r\n\r\n### <a name=\"create-assets\"></a>创建资产\r\n在创建 IngestManifestAsset 之前，需要创建将使用批量引入完成的资产。 资产是媒体服务中多种类型的对象或多组对象（包括视频、音频、图像、缩略图集合、文本轨道和隐藏的解释性字幕文件）的容器。 在 REST API 中，创建资产需要向 Microsoft Azure 媒体服务发送 HTTP POST 请求，并在请求正文中放置资产属性信息。在本示例中，资产是使用请求正文中包含的 StorageEncrption(1) 选项创建的。\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/Assets HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 55\r\nExpect: 100-continue\r\n\r\n{ \"Name\" : \"ExampleManifestREST_Asset\", \"Options\" : 1 }\r\n```\r\n\r\n### <a name=\"create-the-ingestmanifestassets\"></a>创建 IngestManifestAsset\r\nIngestManifestAsset 表示 IngestManifest 内与批量引入一起使用的资产。 IngestManifestAsset 主要用于将资产链接到清单。 Azure 媒体服务会在内部根据关联到 IngestManifestAsset 的 IngestManifestFile 集合来监视文件上传。 上传这些文件后，即完成资产操作。 可以使用 HTTP POST 请求创建新的 IngestManifestAsset。 在请求正文中包括 IngestManifest ID 和资产 ID，以便 IngestManifestAsset 将其链接到一起进行批量引入。\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/IngestManifestAssets HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 152\r\nExpect: 100-continue\r\n{ \"ParentIngestManifestId\" : \"nb:mid:UUID:5c77f186-414f-8b48-8231-17f9264e2048\", \"Asset\" : { \"Id\" : \"nb:cid:UUID:b757929a-5a57-430b-b33e-c05c6cbef02e\"}}\r\n```\r\n\r\n### <a name=\"create-the-ingestmanifestfiles-for-each-asset\"></a>为每个资产创建 IngestManifestFile\r\nIngestManifestFile 表示将在批量引入资产的过程中上传的实际视频或音频 blob 对象。 除非资产使用加密选项，否则不需要与加密相关的属性。 本部分使用的示例演示了如何创建 IngestManifestFile，以便将 StorageEncryption 用于之前创建的资产。\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/IngestManifestFiles HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 367\r\nExpect: 100-continue\r\n\r\n{ \"Name\" : \"REST_Example_File.wmv\", \"ParentIngestManifestId\" : \"nb:mid:UUID:5c77f186-414f-8b48-8231-17f9264e2048\", \"ParentIngestManifestAssetId\" : \"nb:maid:UUID:beed8531-9a03-9043-b1d8-6a6d1044cdda\", \"IsEncrypted\" : \"true\", \"EncryptionScheme\" : \"StorageEncryption\", \"EncryptionVersion\" : \"1.0\", \"EncryptionKeyId\" : \"nb:kid:UUID:32e6efaf-5fba-4538-b115-9d1cefe43510\" }\r\n```\r\n\r\n### <a name=\"upload-the-files-to-blob-storage\"></a>将文件上传到 Blob 存储\r\n可以使用任何能够将资产文件上传到 Blob 存储容器 URI（由 IngestManifest 的 BlobStorageUriForUpload 属性提供）的高速客户端应用程序。 \r\n\r\n### <a name=\"monitor-bulk-ingest-progress\"></a>监视批量引入进度\r\n可以通过轮询 IngestManifest 的 Statistics 属性来监视 IngestManifest 的批量引入操作的进度。 该属性为复杂类型，即 [IngestManifestStatistics](https://docs.microsoft.com/rest/api/media/operations/ingestmanifeststatistics)。 若要轮询 Statistics 属性，请提交一个传递 IngestManifest ID 的 HTTP GET 请求。\r\n\r\n## <a name=\"create-contentkeys-used-for-encryption\"></a>创建用于加密的 ContentKey\r\n如果资产要使用加密，则在创建资产文件之前，必须创建用于加密的 ContentKey。 对于存储加密，应在请求正文中包括以下属性。\r\n\r\n| 请求正文属性 | 说明 |\r\n| --- | --- |\r\n| ID |使用以下格式自行生成的 ContentKey Id：“nb:kid:UUID:<NEW GUID>”。 |\r\n| ContentKeyType |这是此内容密钥的内容密钥类型（为整数）。 我们为存储加密传递了值 1。 |\r\n| EncryptedContentKey |我们创建一个新的内容密钥值，这是一个 256 位（32 字节）的值。 该密钥通过使用存储加密 X.509 证书进行加密，我们通过执行 GetProtectionKeyId 和 GetProtectionKey 方法的 HTTP GET 请求从 Azure 媒体服务中检索该证书。 |\r\n| ProtectionKeyId |这是存储加密 X.509 证书的保护密钥 ID，用于加密内容密钥。 |\r\n| ProtectionKeyType |这是用于加密内容密钥的保护密钥的加密类型。 对于示例，此值为 StorageEncryption (1)。 |\r\n| 校验和 |内容密钥的 MD5 计算的校验和。 它通过使用内容密钥加密内容 ID 计算得出。 此示例代码演示了如何计算校验和。 |\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeys HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 572\r\nExpect: 100-continue\r\n\r\n{\"Id\" : \"nb:kid:UUID:316d14d4-b603-4d90-b8db-0fede8aa48f8\", \"ContentKeyType\" : 1, \"EncryptedContentKey\" : \"Y4NPej7heOFa2vsd8ZEOcjjpu/qOq3RJ6GRfxa8CCwtAM83d6J2mKOeQFUmMyVXUSsBCCOdufmieTKi+hOUtNAbyNM4lY4AXI537b9GaY8oSeje0NGU8+QCOuf7jGdRac5B9uIk7WwD76RAJnqyep6U/OdvQV4RLvvZ9w7nO4bY8RHaUaLxC2u4aIRRaZtLu5rm8GKBPy87OzQVXNgnLM01I8s3Z4wJ3i7jXqkknDy4VkIyLBSQvIvUzxYHeNdMVWDmS+jPN9ScVmolUwGzH1A23td8UWFHOjTjXHLjNm5Yq+7MIOoaxeMlKPYXRFKofRY8Qh5o5tqvycSAJ9KUqfg==\", \"ProtectionKeyId\" : \"7D9BB04D9D0A4A24800CADBFEF232689E048F69C\", \"ProtectionKeyType\" : 1, \"Checksum\" : \"TfXtjCIlq1Y=\" }\r\n```\r\n\r\n### <a name=\"link-the-contentkey-to-the-asset\"></a>将 ContentKey 链接到资产\r\n\r\nContentKey 通过发送 HTTP POST 请求关联到一个或多个资产。 以下请求是一个示例，说明了如何按 ID 将示例 ContentKey 链接到示例资产。\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/Assets('nb:cid:UUID:b3023475-09b4-4647-9d6d-6fc242822e68')/$links/ContentKeys HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 113\r\nExpect: 100-continue\r\n\r\n{ \"uri\": \"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeys('nb%3Akid%3AUUID%3A32e6efaf-5fba-4538-b115-9d1cefe43510')\"}\r\n```\r\n\r\n**HTTP 响应**\r\n\r\n```\r\nGET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/IngestManifests(('nb:mid:UUID:5c77f186-414f-8b48-8231-17f9264e2048') HTTP/1.1\r\nContent-Type: application/json;odata=verbose\r\nAccept: application/json;odata=verbose\r\nDataServiceVersion: 3.0\r\nMaxDataServiceVersion: 3.0\r\nx-ms-version: 2.11\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=070500D0-F35C-4A5A-9249-485BBF4EC70B&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1334275521&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=GxdBb%2fmEyN7iHdNxbawawHRftLhPFFqxX1JZckuv3hY%3d\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\n```\r\n## <a name=\"next-steps\"></a>后续步骤\r\n\r\n现即可编码已上传的资产。 有关详细信息，请参阅[对资产进行编码](media-services-portal-encode.md)。\r\n\r\n\r\n[How to Get a Media Processor]: media-services-get-media-processor.md\r\n"}