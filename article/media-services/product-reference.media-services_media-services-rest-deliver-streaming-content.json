{"Title":"使用 REST 发布 Azure 媒体服务内容","Description":"了解如何创建用于生成流式处理 URL 的定位符。 代码使用 REST API。","Content":"# <a name=\"publish-azure-media-services-content-using-rest\"></a>使用 REST 发布 Azure 媒体服务内容\r\n> [!div class=\"op_single_selector\"]\r\n> * [.NET](media-services-deliver-streaming-content.md)\r\n> * [REST](media-services-rest-deliver-streaming-content.md)\r\n> * [门户](media-services-portal-publish.md)\r\n> \r\n> \r\n\r\n## <a name=\"overview\"></a>概述\r\n可通过创建 OnDemand 流式处理定位符并生成流式处理 URL，来流式处理自适应比特率 MP4 集。 [对资产进行编码](media-services-rest-encode-asset.md)主题说明了如何编码成自适应比特率 MP4 集。 如果内容已加密，则在创建定位符之前配置资产传送策略（如[本主题](media-services-rest-configure-asset-delivery-policy.md)中所述）。 \r\n\r\n也可以使用 OnDemand 流式处理定位符生成指向可渐进式下载的 MP4 文件的 URL。  \r\n\r\n本主题说明如何创建 OnDemand 流式处理定位符，以发布资产及生成平滑流式处理、MPEG DASH 和 HLS 流式处理 URL。 此外，还会示范如何生成渐进式下载 URL。\r\n\r\n\r\n            [以下](#types) 部分显示了其值会在 REST 调用中使用的枚举类型。   \r\n\r\n> [!NOTE]\r\n> 访问媒体服务中的实体时，必须在 HTTP 请求中设置特定标头字段和值。 有关详细信息，请参阅[媒体服务 REST API 开发的设置](media-services-rest-how-to-use.md)。\r\n> \r\n\r\n## <a name=\"connect-to-media-services\"></a>连接到媒体服务\r\n\r\n若要了解如何连接到 AMS API，请参阅[通过 Azure AD 身份验证访问 Azure 媒体服务 API](media-services-use-aad-auth-to-access-ams-api.md)。 \r\n\r\n\r\n## <a name=\"create-an-ondemand-streaming-locator\"></a>创建 OnDemand 流式处理定位符\r\n若要创建 OnDemand 流式处理定位符并获取 URL，需执行以下操作：\r\n\r\n1. 如果内容已加密，请定义访问策略。\r\n2. 创建 OnDemand 流式处理定位符。\r\n3. 如果计划进行流式处理，请获取资产中的流式处理清单文件 (.ism)。 \r\n   \r\n   若计划进行渐进式下载，请获取资产中的 MP4 文件名。 \r\n4. 生成清单文件或 MP4 文件的 URL。 \r\n5. 请注意，不能使用包含写入或删除权限的 AccessPolicy 创建流式处理定位符。\r\n\r\n### <a name=\"create-an-access-policy\"></a>创建访问策略\r\n\r\n>[!NOTE]\r\n>不同 AMS 策略的策略限制为 1,000,000 个（例如，对于定位器策略或 ContentKeyAuthorizationPolicy）。 如果始终使用相同的日期/访问权限，则应使用相同的策略 ID，例如，用于要长期就地保留的定位符的策略（非上传策略）。 有关详细信息，请参阅[此](media-services-dotnet-manage-entities.md#limit-access-policies)主题。\r\n\r\n请求：\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstest1&urn%3aSubscriptionId=zbbef702-e769-2233-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1424263184&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=NWE%2f986Hr5lZTzVGKtC%2ftzHm9n6U%2fxpTFULItxKUGC4%3d\r\nx-ms-version: 2.11\r\nx-ms-client-request-id: 6bcfd511-a561-448d-a022-a319a89ecffa\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 68\r\n\r\n{\"Name\":\"access policy\",\"DurationInMinutes\":43200.0,\"Permissions\":1}\r\n```\r\n\r\n响应：\r\n\r\n```\r\nHTTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 311\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies('nb%3Apid%3AUUID%3A69c80d98-7830-407f-a9af-e25f4b0d3e5f')\r\nServer: Microsoft-IIS/8.5\r\nrequest-id: a877528a-bdb4-4414-9862-273f8e64f882\r\nx-ms-request-id: a877528a-bdb4-4414-9862-273f8e64f882\r\nx-ms-client-request-id: 6bcfd511-a561-448d-a022-a319a89ecffa\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nX-Powered-By: ASP.NET\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Wed, 18 Feb 2015 06:52:09 GMT\r\n\r\n{\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#AccessPolicies/@Element\",\"Id\":\"nb:pid:UUID:69c80d98-7830-407f-a9af-e25f4b0d3e5f\",\"Created\":\"2015-02-18T06:52:09.8862191Z\",\"LastModified\":\"2015-02-18T06:52:09.8862191Z\",\"Name\":\"access policy\",\"DurationInMinutes\":43200.0,\"Permissions\":1}\r\n```\r\n\r\n###<a name=\"create-an-ondemand-streaming-locator\"></a>创建 OnDemand 流式处理定位符\r\n\r\n创建指定资产和资产策略的定位符。\r\n\r\n请求：\r\n\r\n```\r\nPOST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators HTTP/1.1\r\nContent-Type: application/json\r\nDataServiceVersion: 1.0;NetFx\r\nMaxDataServiceVersion: 3.0;NetFx\r\nAccept: application/json\r\nAccept-Charset: UTF-8\r\nAuthorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstest1&urn%3aSubscriptionId=zbbef702-e769-2233-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1424263184&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=NWE%2f986Hr5lZTzVGKtC%2ftzHm9n6U%2fxpTFULItxKUGC4%3d\r\nx-ms-version: 2.11\r\nx-ms-client-request-id: ac159492-9a0c-40c3-aacc-551b1b4c5f62\r\nHost: wamsshaclus001rest-hs.chinacloudapp.cn\r\nContent-Length: 181\r\n\r\n{\"AccessPolicyId\":\"nb:pid:UUID:1480030d-c481-430a-9687-535c6a5cb272\",\"AssetId\":\"nb:cid:UUID:cc1e445d-1500-80bd-538e-f1e4b71b465e\",\"StartTime\":\"2015-02-18T06:34:47.267872Z\",\"Type\":2}\r\n```\r\n\r\n响应：\r\n\r\n```\r\nHTTP/1.1 201 Created\r\nCache-Control: no-cache\r\nContent-Length: 637\r\nContent-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r\nLocation: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators('nb%3Alid%3AUUID%3Abe245661-2bbd-4fc6-b14f-9cf9a1492e5e')\r\nServer: Microsoft-IIS/8.5\r\nrequest-id: 5bd5864a-0afd-44c0-a67a-4044a2c9043b\r\nx-ms-request-id: 5bd5864a-0afd-44c0-a67a-4044a2c9043b\r\nx-ms-client-request-id: ac159492-9a0c-40c3-aacc-551b1b4c5f62\r\nX-Content-Type-Options: nosniff\r\nDataServiceVersion: 3.0;\r\nX-Powered-By: ASP.NET\r\nStrict-Transport-Security: max-age=31536000; includeSubDomains\r\nDate: Wed, 18 Feb 2015 06:58:37 GMT\r\n\r\n{\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#Locators/@Element\",\"Id\":\"nb:lid:UUID:be245661-2bbd-4fc6-b14f-9cf9a1492e5e\",\"ExpirationDateTime\":\"2015-03-20T06:34:47.267872+00:00\",\"Type\":2,\"Path\":\"http://amstest1.streaming.mediaservices.chinacloudapi.cn/be245661-2bbd-4fc6-b14f-9cf9a1492e5e/\",\"BaseUri\":\"http://amstest1.streaming.mediaservices.chinacloudapi.cn\",\"ContentAccessComponent\":\"be245661-2bbd-4fc6-b14f-9cf9a1492e5e\",\"AccessPolicyId\":\"nb:pid:UUID:1480030d-c481-430a-9687-535c6a5cb272\",\"AssetId\":\"nb:cid:UUID:cc1e445d-1500-80bd-538e-f1e4b71b465e\",\"StartTime\":\"2015-02-18T06:34:47.267872+00:00\",\"Name\":null}\r\n```\r\n\r\n###<a name=\"build-streaming-urls\"></a>生成流式处理 URL\r\n\r\n使用创建定位符后返回的 **路径** 值生成平滑流式处理、HLS 和 MPEG DASH URL。 \r\n\r\n平滑流式处理： **路径** + 清单文件名 +“/manifest”\r\n\r\n示例：\r\n\r\n```\r\nhttp://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest\r\n```\r\n\r\nHLS：路径 + 清单文件名 + \"/manifest(format=m3u8-aapl)\"\r\n\r\n示例：\r\n\r\n```\r\nhttp://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest(format=m3u8-aapl)\r\n```\r\n\r\nDASH：路径 + 清单文件名 + \"/manifest(format=mpd-time-csf)\"\r\n\r\n示例：\r\n\r\n```\r\nhttp://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest(format=mpd-time-csf)\r\n```\r\n\r\n###<a name=\"build-progressive-download-urls\"></a>生成渐进式下载 URL\r\n\r\n使用创建定位符后返回的 **路径** 值生成渐进式下载 URL。   \r\n\r\nURL： **路径** + 资产文件 mp4 名称\r\n\r\n示例：\r\n\r\n```\r\nhttp://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny_H264_650kbps_AAC_und_ch2_96kbps.mp4\r\n```\r\n\r\n##<a id=\"types\"></a>枚举类型\r\n\r\n```\r\n[Flags]\r\npublic enum AccessPermissions\r\n{\r\n    None = 0,\r\n    Read = 1,\r\n    Write = 2,\r\n    Delete = 4,\r\n    List = 8,\r\n}\r\n\r\npublic enum LocatorType\r\n{\r\n    None = 0,\r\n    Sas = 1,\r\n    OnDemandOrigin = 2,\r\n}\r\n```\r\n\r\n## <a name=\"see-also\"></a>另请参阅\r\n[媒体服务操作 REST API 概述](media-services-rest-how-to-use.md)\r\n\r\n[配置资产传送策略](media-services-rest-configure-asset-delivery-policy.md)\r\n\r\n"}