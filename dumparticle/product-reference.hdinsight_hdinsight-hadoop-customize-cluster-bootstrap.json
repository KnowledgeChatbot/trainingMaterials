{"Title":"使用 bootstrap 自定义 HDInsight 群集 - Azure","Description":"了解如何使用 Bootstrap 自定义 HDInsight 群集。","Content":"# <a name=\"customize-hdinsight-clusters-using-bootstrap\"></a>使用 Bootstrap 自定义 HDInsight 群集\r \r [!INCLUDE [azure-sdk-developer-differences](../../includes/azure-sdk-developer-differences.md)]\r \r 有时，可能需要配置配置文件，包括：\r \r * clusterIdentity.xml\r * core-site.xml\r * gateway.xml\r * hbase-env.xml\r * hbase-site.xml\r * hdfs-site.xml\r * hive-env.xml\r * hive-site.xml\r * mapred-site\r * oozie-site.xml\r * oozie-env.xml\r * storm-site.xml\r * tez-site.xml\r * webhcat-site.xml\r * yarn-site.xml\r * server.properties（kafka-broker 配置）\r \r bootstrap 的使用方式有 3 种：\r \r * 使用 Azure PowerShell\r * 使用 .NET SDK\r * 使用 Azure Resource Manager 模板\r \r [!INCLUDE [upgrade-powershell](../../includes/hdinsight-use-latest-powershell.md)]\r \r 有关在创建时在 HDInsight 群集上安装其他组件的信息，请参阅：\r \r * [使用脚本操作自定义 HDInsight 群集 (Linux)](hdinsight-hadoop-customize-cluster-linux.md)\r \r ## <a name=\"use-azure-powershell\"></a>使用 Azure PowerShell\r 以下 PowerShell 代码自定义 Hive 配置：\r \r ```powershell\r # hive-site.xml configuration\r $hiveConfigValues = @{ \"hive.metastore.client.socket.timeout\"=\"90\" }\r \r     $config = New-AzureRmHDInsightClusterConfig `\r         | Set-AzureRmHDInsightDefaultStorage `\r             -StorageAccountName \"$defaultStorageAccountName.blob.core.chinacloudapi.cn\" `\r             -StorageAccountKey $defaultStorageAccountKey `\r         | Add-AzureRmHDInsightConfigValues `\r             -HiveSite $hiveConfigValues \r \r     New-AzureRmHDInsightCluster `\r         -ResourceGroupName $existingResourceGroupName `\r         -ClusterName $clusterName `\r         -Location $location `\r         -ClusterSizeInNodes $clusterSizeInNodes `\r         -ClusterType Hadoop `\r         -OSType Linux `\r         -Version \"3.5\" `\r         -HttpCredential $httpCredential `\r         -Config $config \r ```\r 可在 [附录 A](#appx-a:-powershell-sample)中找到完整的有效 PowerShell 脚本。\r \r **若要验证更改，请执行以下操作：**\r \r 1. 登录到 [Azure 门户](https://portal.azure.cn)。\r 2. 在左侧菜单中，单击“HDInsight 群集” 。 如果看不到该项，请先单击“更多服务”  。\r 3. 单击刚刚使用 PowerShell 脚本创建的群集。\r 4. 单击边栏选项卡顶部的“仪表板”  打开 Ambari UI。\r 5. 在左侧菜单中，单击“Hive”。\r 6. 在“摘要”中单击“HiveServer2”。\r 7. 单击“配置”选项卡  。\r 8. 在左侧菜单中，单击“Hive”。\r 9. 单击“高级”选项卡  。\r 10. 向下滚动，然后展开“高级 hive 站点” 。\r 11. 在此部分中查找 **hive.metastore.client.socket.timeout** 。\r \r 下面是有关自定义其他配置文件的更多示例：\r \r     # hdfs-site.xml configuration\r     $HdfsConfigValues = @{ \"dfs.blocksize\"=\"64m\" } #default is 128MB in HDI 3.0 and 256MB in HDI 2.1\r \r     # core-site.xml configuration\r     $CoreConfigValues = @{ \"ipc.client.connect.max.retries\"=\"60\" } #default 50\r \r     # mapred-site.xml configuration\r     $MapRedConfigValues = @{ \"mapreduce.task.timeout\"=\"1200000\" } #default 600000\r \r     # oozie-site.xml configuration\r     $OozieConfigValues = @{ \"oozie.service.coord.normal.default.timeout\"=\"150\" }  # default 120\r \r 有关详细信息，请参阅 Azim Uddin 的标题为 [自定义 HDInsight 群集创建](http://blogs.msdn.com/b/bigdatasupport/archive/2014/04/15/customizing-hdinsight-cluster-provisioning-via-powershell-and-net-sdk.aspx)的博客。\r \r ## <a name=\"use-net-sdk\"></a>使用 .NET SDK\r 请参阅[使用 .NET SDK 在 HDInsight 中创建基于 Linux 的群集](hdinsight-hadoop-create-linux-clusters-dotnet-sdk.md#use-bootstrap)。\r \r ## <a name=\"use-resource-manager-template\"></a>使用 Resource Manager 模板\r 可以在 Resource Manager 模板中使用 bootstrap：\r \r ```json\r \"configurations\": {\r     …\r     \"hive-site\": {\r         \"hive.metastore.client.connect.retry.delay\": \"5\",\r         \"hive.execution.engine\": \"mr\",\r         \"hive.security.authorization.manager\": \"org.apache.hadoop.hive.ql.security.authorization.DefaultHiveAuthorizationProvider\"\r     }\r }\r ```\r \r ![HDInsight Hadoop, 自定义群集, bootstrap, Azure Resource Manager 模板](./media/hdinsight-hadoop-customize-cluster-bootstrap/hdinsight-customize-cluster-bootstrap-arm.png)\r \r ## <a name=\"see-also\"></a>另请参阅\r * [在 HDInsight 中创建 Hadoop 群集][hdinsight-provision-cluster] 说明了如何使用其他自定义选项创建 HDInsight 群集。\r * [为 HDInsight 开发脚本操作脚本][hdinsight-write-script]\r * [在 HDInsight 群集上安装并使用 Spark][hdinsight-install-spark]\r * [在 HDInsight 群集上安装并使用 R][hdinsight-install-r]\r * [在 HDInsight 群集上安装并使用 Solr](hdinsight-hadoop-solr-install.md)。\r * [在 HDInsight 群集上安装并使用 Giraph](hdinsight-hadoop-giraph-install.md)。\r \r [hdinsight-install-spark]: spark/apache-spark-jupyter-spark-sql.md\r [hdinsight-install-r]: hdinsight-hadoop-r-scripts.md\r [hdinsight-write-script]: hdinsight-hadoop-script-actions.md\r [hdinsight-provision-cluster]: hdinsight-hadoop-provision-linux-clusters.md\r [powershell-install-configure]: https://docs.microsoft.com/powershell/azureps-cmdlets-docs\r \r [img-hdi-cluster-states]: ./media/hdinsight-hadoop-customize-cluster/HDI-Cluster-state.png \"群集创建期间的阶段\"\r \r ## <a name=\"appendix-powershell-sample\"></a>附录：PowerShell 示例\r 此 PowerShell 脚本创建一个 HDInsight 群集并自定义 Hive 设置：\r \r ```powershell\r ####################################\r # Set these variables\r ####################################\r #region - used for creating Azure service names\r $nameToken = \"<ENTER AN ALIAS>\" \r #endregion\r \r #region - cluster user accounts\r $httpUserName = \"admin\"  #HDInsight cluster username\r $httpPassword = \"<ENTER A PASSWORD>\" #\"<Enter a Password>\"\r \r $sshUserName = \"sshuser\" #HDInsight ssh user name\r $sshPassword = \"<ENTER A PASSWORD>\" #\"<Enter a Password>\"\r #endregion\r \r ####################################\r # Service names and varialbes\r ####################################\r #region - service names\r $namePrefix = $nameToken.ToLower() + (Get-Date -Format \"MMdd\")\r \r $resourceGroupName = $namePrefix + \"rg\"\r $hdinsightClusterName = $namePrefix + \"hdi\"\r $defaultStorageAccountName = $namePrefix + \"store\"\r $defaultBlobContainerName = $hdinsightClusterName\r \r $location = \"China East\"\r #endregion\r \r # Treat all errors as terminating\r $ErrorActionPreference = \"Stop\"\r \r ####################################\r # Connect to Azure\r ####################################\r #region - Connect to Azure subscription\r Write-Host \"`nConnecting to your Azure subscription ...\" -ForegroundColor Green\r try{Get-AzureRmContext}\r catch{Login-AzureRmAccount -EnvironmentName AzureChinaCloud}\r #endregion\r \r #region - Create an HDInsight cluster\r ####################################\r # Create dependent components\r ####################################\r Write-Host \"Creating a resource group ...\" -ForegroundColor Green\r New-AzureRmResourceGroup `\r     -Name  $resourceGroupName `\r     -Location $location\r \r Write-Host \"Creating the default storage account and default blob container ...\"  -ForegroundColor Green\r New-AzureRmStorageAccount `\r     -ResourceGroupName $resourceGroupName `\r     -Name $defaultStorageAccountName `\r     -Location $location `\r     -Type Standard_GRS\r \r $defaultStorageAccountKey = (Get-AzureRmStorageAccountKey `\r                                 -ResourceGroupName $resourceGroupName `\r                                 -Name $defaultStorageAccountName)[0].Value\r $defaultStorageContext = New-AzureStorageContext `\r                                 -StorageAccountName $defaultStorageAccountName `\r                                 -StorageAccountKey $defaultStorageAccountKey\r New-AzureStorageContainer `\r     -Name $defaultBlobContainerName `\r     -Context $defaultStorageContext #use the cluster name as the container name\r \r ####################################\r # Create a configuration object\r ####################################\r $hiveConfigValues = @{ \"hive.metastore.client.socket.timeout\"=\"90\" }\r \r $config = New-AzureRmHDInsightClusterConfig `\r     | Set-AzureRmHDInsightDefaultStorage `\r         -StorageAccountName \"$defaultStorageAccountName.blob.core.chinacloudapi.cn\" `\r         -StorageAccountKey $defaultStorageAccountKey `\r     | Add-AzureRmHDInsightConfigValues `\r         -HiveSite $hiveConfigValues \r \r ####################################\r # Create an HDInsight cluster\r ####################################\r $httpPW = ConvertTo-SecureString -String $httpPassword -AsPlainText -Force\r $httpCredential = New-Object System.Management.Automation.PSCredential($httpUserName,$httpPW)\r \r $sshPW = ConvertTo-SecureString -String $sshPassword -AsPlainText -Force\r $sshCredential = New-Object System.Management.Automation.PSCredential($sshUserName,$sshPW)\r \r New-AzureRmHDInsightCluster `\r     -ResourceGroupName $resourceGroupName `\r     -ClusterName $hdinsightClusterName `\r     -Location $location `\r     -ClusterSizeInNodes 1 `\r     -ClusterType Hadoop `\r     -OSType Linux `\r     -Version \"3.5\" `\r     -HttpCredential $httpCredential `\r     -SshCredential $sshCredential `\r     -Config $config\r \r ####################################\r # Verify the cluster\r ####################################\r Get-AzureRmHDInsightCluster -ClusterName $hdinsightClusterName\r \r #endregion\r ```\r "}