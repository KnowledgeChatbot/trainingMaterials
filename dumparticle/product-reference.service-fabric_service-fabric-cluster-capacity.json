{"Title":"规划 Service Fabric 群集容量","Description":"Service Fabric 群集容量规划注意事项。 节点类型、操作、耐久性和可靠性层","Content":"# <a name=\"service-fabric-cluster-capacity-planning-considerations\"></a>Service Fabric 群集容量规划注意事项\r 对于任何生产部署，容量规划都是一个重要的步骤。 下面是在规划过程中必须注意的一些事项。\r \r * 群集一开始需要的节点类型数目\r * 每个节点类型的属性（大小、是否为主节点、是否面向 Internet、VM 数目，等等）\r * 群集的可靠性和持久性特征\r \r 让我们简单地了解其中每一项。\r \r ## <a name=\"the-number-of-node-types-your-cluster-needs-to-start-out-with\"></a>群集一开始需要的节点类型数目\r 首先，需要确定要创建的群集用于什么目的，以及打算要将哪些类型的应用程序部署到此群集中。 如果不清楚群集的用途，则很可能还未准备好进入容量规划流程。\r \r 确定群集一开始需要的节点类型数目。  每个节点类型会映射到虚拟机规模集。 然后，每个节点类型可以独立扩展或缩减、打开不同的端口集，并可以有不同的容量指标。 因此，节点类型数目的确定基本上可归结为以下考虑因素：\r \r * 应用程序是否有多个服务，其中是否有任何服务需面向公众或面向 Internet？ 典型的应用程序包含可从客户端接收输入的前端网关服务，以及一个或多个与前端服务通信的后端服务。 因此，在此情况下，必须至少有两个节点类型。\r * （构成应用程序的）服务是否有不同的基础结构要求，例如，更多的 RAM 或更高的 CPU 周期？ 例如，假设要部署的应用程序包含前端服务和后端服务。 前端服务可以在容量较小（如 D2 的 VM 大小）且向 Internet 开放了端口的 VM 上运行。  但是，后端服务是计算密集型的服务，需要放在容量较大（D4、D6、D15 等的 VM 大小）且不面向 Internet 的 VM 上运行。\r \r   在本示例中，可以决定将所有服务都放在一个节点类型上，但我们建议将它们分别放在群集中的两个节点类型上。  这样，每个节点类型的属性（如 Internet 连接或 VM 大小）都会有所不同。 也可以单独缩放 VM 的数目。  \r * 由于无法预见未来，因此，请利用所知道的事实，确定应用程序一开始需要的节点类型数目。 以后，随时可以添加或删除节点类型。 Service Fabric 群集必须至少有一个节点类型。\r \r ## <a name=\"the-properties-of-each-node-type\"></a>每个节点类型的属性\r **节点类型** 相当于云服务中的角色。 节点类型定义 VM 大小、VM 数目及其属性。 在 Service Fabric 群集中定义的每个节点类型将设置为不同的虚拟机规模集。 虚拟机规模集是一种 Azure 计算资源，可用于将一组 VM 作为一个集进行部署和管理。 如果定义为不同的虚拟机规模集，则每个节点类型可以独立扩展或缩减、打开不同的端口集，并可以有不同的容量指标。\r \r 有关节点类型与虚拟机规模集之间的关系、如何 RDP 到某个实例、打开新端口等方面的更多详细信息，请阅读[此文档](service-fabric-cluster-nodetypes.md)。\r \r 群集可以有多个节点类型，但主节点类型（在门户定义的第一个节点类型）必须至少有 5 个 VM 供群集用于生产工作负荷（或至少有 3 个 VM 用于测试群集）。 如果要使用资源管理器模板创建群集，请在节点类型定义下查找“is Primary”属性。 主节点类型是 Service Fabric 系统服务所在的节点类型。  \r \r ### <a name=\"primary-node-type\"></a>主节点类型\r 对于包含多个节点类型的群集，需要选择其中一个作为主节点类型。 下面是主节点类型的特征：\r \r * 主节点类型的 **VM 大小下限**取决于选择的**持久性层**。 持久性层的默认值为 Bronze。 有关持久性层的定义以及可采用的值的详细信息，请向下滚动。  \r * 主节点类型的 **VM 数目下限**取决于选择的**可靠性层**。 可靠性层的默认值为 Silver。 向下滚动，可查看有关可靠性层的定义以及可采用的值的详细信息。 \r \r * Service Fabric 系统服务（例如，群集管理器服务或映像存储服务）放在主节点类型上，因此，群集的可靠性和持久性取决于为主节点类型选择的可靠性层值与持久性层值。\r \r ![显示具有两个节点类型的群集的屏幕截图 ][SystemServices]\r \r ### <a name=\"non-primary-node-type\"></a>非主节点类型\r 包含多个节点类型的群集有一个主节点类型，其余的则是非主节点类型。 下面是非主节点类型的特征：\r \r * 此节点类型的 VM 大小下限取决于选择的持久性层。 持久性层的默认值为 Bronze。 向下滚动，可查看有关持久性层的定义以及可采用的值的详细信息。  \r * 此节点类型的 VM 数目下限可以是 1。 但是，应该根据想要在此节点类型中运行的应用程序/服务的副本数目选择此数目。 部署群集之后，节点类型中的 VM 数目可能会增加。\r \r ## <a name=\"the-durability-characteristics-of-the-cluster\"></a>群集的持久性特征\r 持久性层用于向系统指示 VM 对于基本 Azure 基础结构拥有的权限。 在主节点类型中，此权限可让 Service Fabric 暂停影响系统服务及有状态服务的仲裁要求的任何 VM 级别基础结构请求（例如，VM 重启、VM 重置映像或 VM 迁移）。 在非主节点类型中，此特权可让 Service Fabric 暂停影响其中运行的有状态服务的仲裁要求的任何 VM 级别基础结构请求，例如，VM 重新启动、VM 重置映像、VM 迁移，等等。\r \r 此权限表示为以下值：\r \r * 黄金 - 每个 UD 可持续暂停基础结构作业 2 小时。 仅可在 D15_V2、G5 等完整节点 VM sku 上启用 Gold 持续性。\r * 白银 - 可以为每个 UD 持续暂停基础结构作业 10 分钟，并且可在所有单核及多核的标准 VM 上使用。\r * 青铜 - 无权限。 这是默认值。 仅将此持续性级别用于只运行无状态工作负载的节点类型。 \r \r > [!WARNING]\r > 以青铜级持续性运行的节点类型不具有任何特权。 这意味着，不会停止或延迟对无状态工作负载产生影响的基础结构作业。 此类作业仍可能会影响工作负载，从而导致运行中断或其他问题。 对于任何种类的生产工作负载，建议至少以白银级别运行。 对于耐久性为“黄金”或“白银”的任何节点类型，必须至少保留 5 个节点。 \r > \r \r 可以为每个节点类型选择持续性级别。可以为群集中的一个节点类型选择“黄金”持续性级别，为同一群集中的另一个节点类型选择“青铜”持续性级别。对于持续性为“黄金”或“白银”的任何节点类型，必须至少保留 5 个节点。 \r \r **使用“白银”或“黄金”耐久性级别的优点**\r \r 1. 减少了“缩小规模”操作所需的步骤数（即自动调用节点停用和 Remove-ServiceFabricNodeState）\r 2. 减少了由于客户启动的就地 VM SKU 更改操作或 Azure 基础结构操作而导致的数据丢失的风险。\r \r **使用“白银”或“黄金”耐久性级别的缺点**\r \r 1. 部署到虚拟机规模集和其他相关 Azure 资源可能会由于群集中的问题或基础结构级别的问题而延迟、超时或被完全阻止。 \r 2. 由于 Azure 基础结构操作期间发生的自动节点停用而增加了[副本生命周期事件](service-fabric-reliable-services-advanced-usage.md#stateful-service-replica-lifecycle )（例如，主交换）的数量。\r \r ### <a name=\"recommendations-on-when-to-use-silver-or-gold-durability-levels\"></a>有关何时使用“白银”或“黄金”耐久性级别的建议\r \r 对于托管要频繁缩小规模（减小 VM 实例计数）的有状态服务，并且希望延迟部署操作以利于简化这些“缩小规模”操作的所有节点类型，请使用“白银”或“黄金”耐久性。 “扩大规模”的情况（添加 VM 实例）不会受所选耐久性层的影响，只有“缩小规模”的情况才受其影响。\r \r ### <a name=\"changing-durability-levels\"></a>更改耐久性级别\r - 耐久性级别为“白银”或“黄金”的节点类型不能降级为“青铜”。\r - 从“青铜”升级到“白银”或“黄金”可能需要几个小时。\r - 更改耐久性级别时，请务必在 VMSS 资源中的 Service Fabric 扩展配置以及 Service Fabric 群集资源中的节点类型定义中同时进行更新。 这些值必须匹配。\r \r ### <a name=\"operational-recommendations-for-the-node-type-that-you-have-set-to-silver-or-gold-durability-level\"></a>适用于已设置为“白银”或“黄金”耐久性级别的节点类型的操作建议。\r \r 1. 使群集和应用程序在任何时间都正常工作，并确保应用程序及时响应所有[服务副本生命周期事件](service-fabric-reliable-services-advanced-usage.md#stateful-service-replica-lifecycle)（例如，生成副本时出现停滞）。\r 2. 采用更安全的方式更改 VM SKU（增加/减少）：更改虚拟机规模集的 VM SKU 本质上是一项不安全的操作，如有可能，应尽量避免此操作。 可以遵循以下过程来避免常见问题。\r     - 对于非主节点类型：建议创建新的虚拟机规模集，修改服务放置约束以包括新的虚拟机规模集/节点类型，然后将旧的虚拟机规模集实例计数降低到 0，一次一个节点（这是为了确保删除节点不会影响群集的可靠性）。\r     - **对于主节点类型：**建议不要更改主节点类型的 VM SKU。 不支持更改主节点类型 SKU。 如果使用新 SKU 是为了增大容量，建议添加更多实例。 如果那不可行，请创建新群集并从旧群集[还原应用程序状态](service-fabric-reliable-services-backup-restore.md)（如果适用）。 不需要还原任何系统服务状态，在将应用程序部署到新群集时就已重新创建它们。 如果只在群集上运行无状态应用程序，则只需将应用程序部署到新群集即可，无需还原任何内容。 如果一定要进行不受支持的操作，更改 VM SKU，请修改虚拟机规模集模型定义以反映新的 SKU。 如果群集只有一个节点类型，请确保所有有状态应用程序及时响应所有[服务副本生命周期事件](service-fabric-reliable-services-advanced-usage.md#stateful-service-replica-lifecycle)（例如，在生成副本时出现停滞），并且重新生成服务副本的持续时间小于 5 分钟（适用于“白银”持续性级别）。 \r \r > [!WARNING]\r > 对于存在持续性运行级别低于白银级这种情况的 VM 规模集，不建议更改其 VM SKU 大小。 更改 VM SKU 大小是一种破坏数据的就地基础结构操作。 由于无法延迟或监视此更改，此操作可能会导致有状态服务的数据丢失或其他意外操作问题（甚至可能影响无状态工作负载）。 \r > \r \r 3. 为任何已启用“黄金”或“白银”耐久性级别的虚拟机规模集至少保留五个节点\r 4. 不要删除随机 VM 实例，请始终使用虚拟机规模集缩减功能。 删除随机 VM 实例可能会造成分布在 UD 和 FD 的 VM 实例失衡。 这一失衡可能会对系统在服务实例/服务副本之间进行适当负载均衡的能力产生负面影响。\r 5. 如果使用自动缩放，请设置规则，以便一次只有一个节点执行“缩小规模”操作（删除 VM 实例）。 一次减少多个实例是不安全的。\r 6. 如果减少某个主节点类型，则绝不应将其缩减到超出可靠性层允许的数目。\r \r ## <a name=\"the-reliability-characteristics-of-the-cluster\"></a>群集的可靠性特征\r 可靠性层用于设置想要在此群集中的主节点类型上运行的系统服务副本数。 副本数越大，群集中的系统服务越可靠。  \r \r 可靠性层可以采用以下值：\r \r * 白金 - 运行包含 9 个目标副本集的系统服务\r * 黄金 - 运行包含 7 个目标副本集的系统服务\r * 白银 - 运行包含 5 个目标副本集的系统服务 \r * 青铜 - 运行包含 3 个目标副本集的系统服务\r \r > [!NOTE]\r > 选择的可靠性层决定了主节点类型必须具有的节点数下限。 \r > \r > \r \r ### <a name=\"recommendations-for-the-reliability-tier\"></a>针对可靠性层的建议。\r \r  扩大或减小群集规模（所有节点类型中的 VM 实例总和）时，必须将群集的可靠性从一个层更新到另一层。 这样做会触发更改系统服务副本集计数所需的群集升级。 等待升级完成，然后对群集做出其他任何更改，例如添加节点。  可以在 Service Fabric Explorer 中运行 [Get-ServiceFabricClusterUpgrade](https://docs.microsoft.com/powershell/module/servicefabric/get-servicefabricclusterupgrade?view=azureservicefabricps) 来监视升级进度\r \r 下面是有关选择可靠性层的建议。\r \r | **群集大小** | 可靠性层 |\r | --- | --- |\r | 1 |不要指定“可靠性层”参数，系统会计算该参数 |\r | 3 |青铜 |\r | 5 或 6|白银 |\r | 7 或 8 |黄金 |\r | 9 及以上 |白金 |\r \r ## <a name=\"primary-node-type---capacity-guidance\"></a>主节点类型 - 容量指导\r \r 下面是用于规划主节点类型容量的指导\r \r 1. 要在 Azure 中运行任何生产工作负荷的 VM 实例数：必须将最小主节点类型大小指定为 5。 \r 2. 要在 Azure 中运行测试工作负荷的 VM 实例数：可以将最小主节点类型大小指定为 1 或 3。 单节点群集，采用特殊配置来运行，因此不支持对该群集进行扩展。 单节点群集，不具备可靠性，因此，必须在 Resource Manager 模板中删除/不指定该配置（单纯不设置配置值还不够）。 如果设置通过门户设置的单节点群集，则系统会自动处理该配置。 不支持使用单节点群集和三节点群集运行生产工作负荷。 \r 3. **VM SKU：** 主节点类型是运行系统服务的位置，因此，在为它选择 VM SKU 时，必须考虑到计划在其中放置的总峰值负载。 下面这个类比用来说明此处我要表达的意思 - 将主节点类型想象成“肺”，它向大脑提供氧气，如果大脑不能获得足够的氧气，身体会痛苦。 \r \r 由于群集的容量需求是由你计划在群集中运行的工作负荷决定的，因此，我们无法针对具体工作负荷提供定性指导，但是下面的宽泛指导可帮助你入门\r \r 对于生产工作负荷 \r \r - 建议的 VM SKU 为标准 D3 或标准 D3_V2，或者相当于一块至少 14 GB 的本地 SSD 的容量。\r - 支持使用的最小 VM SKU 为标准 D1 或标准 D1_V2，或者相当于一块至少 14 GB 的本地 SSD 的容量。 \r - 生产工作负荷不支持不完整的核心 VM SKU，例如标准 A0。\r - 由于性能原因，不支持将标准 A1 SKU 用于生产工作负荷。\r \r > [!WARNING]\r > 目前，不支持更改正在运行的群集上的主节点 VM SKU 大小。 因此请将来的容量需求考虑在内，谨慎选择主节点类型 VM SKU。 此时，将主节点类型移动到新 VM SKU（较小或更大）的唯一支持方法是创建具有正确容量的新群集，向其部署应用程序，然后从取自旧群集中的[最新服务备份](service-fabric-reliable-services-backup-restore.md)还原应用程序状态（如果适用）。 不需要还原任何系统服务状态，在将应用程序部署到新群集时就已重新创建它们。 如果只在群集上运行无状态应用程序，则只需将应用程序部署到新群集即可，无需还原任何内容。\r > \r \r ## <a name=\"non-primary-node-type---capacity-guidance-for-stateful-workloads\"></a>非主节点类型 - 有状态工作负荷的容量指导\r \r 本指南适用于使用 Service Fabric [可靠集合或可靠角色](service-fabric-choose-framework.md)（在非主节点类型上运行）的有状态工作负荷。\r \r **VM 实例数：**对于有状态生产工作负荷，建议使用最小值和目标副本计数 5 运行它们。 这意味着，在稳定的状态下，最终在每个容错域和升级域中都将具有一个副本（来自副本集）。 主节点类型的整体可靠性层概念实际上只是一种为系统服务指定此设置的方法。 因此，这一注意事项同样适用于有状态服务。\r \r 因此，对于生产工作负荷，如果在节点中运行有状态工作负荷，建议使用的最小非主节点类型大小为 5。\r \r **VM SKU：**这是运行应用程序服务的节点类型，因此，为其选择的 VM SKU 必须将你计划在每个节点中放置的峰值负荷考虑在内。 节点类型的容量需求是由你计划在群集中运行的工作负荷决定的，因此，我们无法针对具体工作负荷提供定性指导，但是下面的宽泛指导可帮助你入门\r \r 对于生产工作负荷 \r \r - 建议的 VM SKU 为标准 D3 或标准 D3_V2，或者相当于一块至少 14 GB 的本地 SSD 的容量。\r - 支持使用的最小 VM SKU 为标准 D1 或标准 D1_V2，或者相当于一块至少 14 GB 的本地 SSD 的容量。 \r - 生产工作负荷不支持不完整的核心 VM SKU，例如标准 A0。\r - 具体而言，出于性能原因，生产工作负荷不支持标准 A1 SKU。\r \r ## <a name=\"non-primary-node-type---capacity-guidance-for-stateless-workloads\"></a>非主节点类型 - 针对无状态工作负荷的容量指导\r \r 在非主节点类型上运行的无状态工作负荷指南。\r \r **VM 实例数：**对于无状态生产工作负荷，支持的最小非主节点类型大小为 2。 这允许运行应用程序的两个无状态实例，并允许服务在某个 VM 实例丢失的情况下继续运行。 \r \r > [!NOTE]\r > 当群集在低于 5.6 的 Service Fabric 版本上运行时，由于运行时中的一个缺陷（此问题已在 5.6 中修复），如果将非主节点类型缩减为小于 5，则会导致群集运行状况变为不正常，直到你使用相应的节点名称调用 [Remove-ServiceFabricNodeState cmd](https://docs.microsoft.com/powershell/servicefabric/vlatest/Remove-ServiceFabricNodeState)。 有关更多详细信息，请阅读[执行 Service Fabric 群集缩放](service-fabric-cluster-scale-up-down.md)。\r > \r >\r \r **VM SKU：**这是运行应用程序服务的节点类型，因此，为其选择的 VM SKU 必须将你计划在每个节点中放置的峰值负荷考虑在内。 节点类型的容量需求是由你计划在群集中运行的工作负荷决定的，因此，我们无法针对具体工作负荷提供定性指导，但是下面的宽泛指导可帮助你入门\r \r 对于生产工作负荷 \r \r <!-- Not Avaialble - 建议的 VM SKU 为标准 D3、标准 D3_V2 或相当的容量。 -->\r - 支持使用的最小 VM SKU 为标准 D1、标准 D1_V2 或相当的容量。 \r - 部分核心 VM SKU（例如标准 A0）不支持用于生产工作负荷。\r - 由于性能原因，不支持将标准 A1 SKU 用于生产工作负荷。\r \r <!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->\r \r ## <a name=\"next-steps\"></a>后续步骤\r 完成容量规划并设置群集后，请阅读以下文章：\r \r * [Service Fabric 群集安全性](service-fabric-cluster-security.md)\r * [灾难恢复规划](service-fabric-disaster-recovery.md)\r * [Nodetype 与虚拟机规模集的关系](service-fabric-cluster-nodetypes.md)\r \r <!--Image references-->\r [SystemServices]: ./media/service-fabric-cluster-capacity/SystemServices.png\r \r <!--Update_Description: add Changing durability levels content, wording update -->"}