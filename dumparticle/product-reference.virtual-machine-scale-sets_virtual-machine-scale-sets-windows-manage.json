{"Title":"管理虚拟机规模集中的 VM","Description":"使用 Azure PowerShell 在虚拟机规模集中管理虚拟机。","Content":"\r # 在虚拟机规模集中管理虚拟机\r \r 使用本文中的任务在虚拟机规模集中管理虚拟机。\r \r 在执行大多数涉及到在规模集中管理虚拟机的任务时，需要知道要管理的虚拟机的实例 ID。\r \r 有关安装最新版本的 Azure PowerShell、选择订阅和登录帐户的信息，请参阅[如何安装和配置 Azure PowerShell](https://docs.microsoft.com/powershell/azureps-cmdlets-docs)。\r \r ## 显示有关规模集的信息\r \r 可获取有关规模集的常规信息，也称为实例视图。或者可以获取更具体的信息，如规模集中资源的相关信息。\r \r 将带引号的值替换为资源组和规模集的名称，然后运行该命令：\r \r ```\r Get-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\"\r ```\r \r 它会返回类似于下面的内容：\r \r ```\r Id                                          : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Compute/virtualMachineScaleSets/myvmss1\r Name                                        : myvmss1\r Type                                        : Microsoft.Compute/virtualMachineScaleSets\r Location                                    : chinaeast\r Sku                                         :\r   Name                                      : Standard_A0\r   Tier                                      : Standard\r   Capacity                                  : 3\r UpgradePolicy                               :\r   Mode                                      : Manual\r VirtualMachineProfile                       :\r   OsProfile                                 :\r     ComputerNamePrefix                      : vmss1\r     AdminUsername                           : admin1\r     WindowsConfiguration                    :\r       ProvisionVMAgent                      : True\r       EnableAutomaticUpdates                : True\r StorageProfile                              :\r   ImageReference                            :\r     Publisher                               : MicrosoftWindowsServer\r     Offer                                   : WindowsServer\r     Sku                                     : 2012-R2-Datacenter\r     Version                                 : latest\r   OsDisk                                    :\r     Name                                    : vmssosdisk\r     Caching                                 : ReadOnly\r     CreateOption                            : FromImage\r     VhdContainers[0]                        : https://astore.blob.core.chinacloudapi.cn/vmss\r     VhdContainers[1]                        : https://gstore.blob.core.chinacloudapi.cn/vmss\r     VhdContainers[2]                        : https://mstore.blob.core.chinacloudapi.cn/vmss\r     VhdContainers[3]                        : https://sstore.blob.core.chinacloudapi.cn/vmss\r     VhdContainers[4]                        : https://ystore.blob.core.chinacloudapi.cn/vmss\r NetworkProfile                              :\r   NetworkInterfaceConfigurations[0]         :\r     Name                                    : mync1\r     Primary                                 : True\r     IpConfigurations[0]                     :\r       Name                                  : ip1\r       Subnet                                :\r         Id                                  : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Network/virtualNetworks/myvn1/subnets/mysn1\r       LoadBalancerBackendAddressPools[0]    :\r         Id                                  : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Network/loadBalancers/mylb1/backendAddressPools/bepool1\r     LoadBalancerInboundNatPools[0]          :\r         Id                                  : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Network/loadBalancers/mylb1/inboundNatPools/natpool1\r ExtensionProfile                            :\r   Extensions[0]                             :\r     Name                                    : Microsoft.Insights.VMDiagnosticsSettings\r     Publisher                               : Microsoft.Azure.Diagnostics\r     Type                                    : IaaSDiagnostics\r     TypeHandlerVersion                      : 1.5\r     AutoUpgradeMinorVersion                 : True\r     Settings                                : {\"xmlCfg\":\"...\",\"storageAccount\":\"astore\"}\r ProvisioningState                           : Succeeded\r ```\r \r 将带引号的值替换为资源组和规模集的名称。将 *#* 替换为要获取其相关信息的虚拟机的实例标识符，然后运行该命令：\r \r ```\r Get-AzureRmVmssVM -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\" -InstanceId #\r ```\r \r 它会返回与此示例类似的内容：\r \r ```\r Id                            : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Compute/\r                                 virtualMachineScaleSets/myvmss1/virtualMachines/0\r Name                          : myvmss1_0\r Type                          : Microsoft.Compute/virtualMachineScaleSets/virtualMachines\r Location                      : chinaeast\r InstanceId                    : 0\r Sku                           :\r   Name                        : Standard_A0\r   Tier                        : Standard\r LatestModelApplied            : True\r StorageProfile                :\r   ImageReference              :\r     Publisher                 : MicrosoftWindowsServer\r     Offer                     : WindowsServer\r     Sku                       : 2012-R2-Datacenter\r     Version                   : 4.0.20160617\r   OsDisk                      :\r     OsType                    : Windows\r     Name                      : vmssosdisk-os-0-e11cad52959b4b76a8d9f26c5190c4f8\r     Vhd                       :\r       Uri                     : https://astore.blob.core.chinacloudapi.cn/vmss/vmssosdisk-os-0-e11cad52959b4b76a8d9f26c5190c4f8.vhd\r     Caching                   : ReadOnly\r     CreateOption              : FromImage\r OsProfile                     :\r   ComputerName                : myvmss1-0\r   AdminUsername               : admin1\r   WindowsConfiguration        :\r     ProvisionVMAgent          : True\r     EnableAutomaticUpdates    : True\r NetworkProfile                :\r   NetworkInterfaces[0]        :\r     Id                        : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Compute/virtualMachineScaleSets/\r                                 myvmss1/virtualMachines/0/networkInterfaces/mync1\r ProvisioningState             : Succeeded\r Resources[0]                  :\r   Id                          : /subscriptions/{sub-id}/resourceGroups/myrg1/providers/Microsoft.Compute/virtualMachines/\r                                 myvmss1_0/extensions/Microsoft.Insights.VMDiagnosticsSettings\r   Name                        : Microsoft.Insights.VMDiagnosticsSettings\r   Type                        : Microsoft.Compute/virtualMachines/extensions\r   Location                    : chinaeast\r   Publisher                   : Microsoft.Azure.Diagnostics\r   VirtualMachineExtensionType : IaaSDiagnostics\r   TypeHandlerVersion          : 1.5\r   AutoUpgradeMinorVersion     : True\r   Settings                    : {\"xmlCfg\":\"...\",\"storageAccount\":\"astore\"}\r   ProvisioningState           : Succeeded\r ```\r \r ## 启动规模集中的虚拟机\r \r 将带引号的值替换为资源组和规模集的名称。将 *#* 替换为要启动的虚拟机的标识符，然后运行该命令：\r \r ```\r Start-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\" -InstanceId #\r ```\r \r 在资源浏览器中，我们可以看到该实例的状态是**正在运行**：\r \r ```\r \"statuses\": [\r   {\r     \"code\": \"ProvisioningState/succeeded\",\r     \"level\": \"Info\",\r     \"displayStatus\": \"Provisioning succeeded\",\r     \"time\": \"2016-03-15T02:10:08.0730839+00:00\"\r   },\r   {\r     \"code\": \"PowerState/running\",\r     \"level\": \"Info\",\r     \"displayStatus\": \"VM running\"\r   }\r ]\r ```\r \r 不使用 -InstanceId 参数即可启动规模集中的所有虚拟机。\r \r ## 停止规模集中的虚拟机\r \r 将带引号的值替换为资源组和规模集的名称。将 *#* 替换为要停止的虚拟机的标识符，然后运行该命令：\r \r ```\r Stop-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\" -InstanceId #\r ```\r \r 在资源浏览器中，我们可以看到该实例的状态是“已解除分配”：\r \r ```\r \"statuses\": [\r   {\r     \"code\": \"ProvisioningState/succeeded\",\r     \"level\": \"Info\",\r     \"displayStatus\": \"Provisioning succeeded\",\r     \"time\": \"2016-03-15T01:25:17.8792929+00:00\"\r   },\r   {\r     \"code\": \"PowerState/deallocated\",\r     \"level\": \"Info\",\r     \"displayStatus\": \"VM deallocated\"\r   }\r ]\r ```\r \r 若要停止但不解除分配虚拟机，请使用 -StayProvisioned 参数。不使用 -InstanceId 参数即可停止规模集中的所有虚拟机。\r \r ## 重启规模集中的虚拟机\r \r 将带引号的值替换为资源组和规模集的名称。将 *#* 替换为要重启的虚拟机的标识符，然后运行该命令：\r \r ```\r Restart-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\" -InstanceId #\r ```\r \r 不使用 -InstanceId 参数即可重启规模集中的所有虚拟机。\r \r ## 从规模集中删除虚拟机\r \r 将带引号的值替换为资源组和规模集的名称。将 *#* 替换为要删除的虚拟机的标识符，然后运行该命令：\r \r ```\r Remove-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\" -InstanceId #\r ```\r \r 不使用 -InstanceId 参数即可一次性删除整个虚拟机规模集。\r \r ## 更改规模集的容量\r \r 通过更改规模集的容量，可添加或删除虚拟机。获取要更改的规模集，按需设置容量，然后使用新容量更新规模集。在这些命令中，将带引号的值替换为资源组和规模集的名称。\r \r     $vmss = Get-AzureRmVmss -ResourceGroupName \"resource group name\" -VMScaleSetName \"scale set name\"\r     $vmss.sku.capacity = 5\r     Update-AzureRmVmss -ResourceGroupName \"resource group name\" -Name \"scale set name\" -VirtualMachineScaleSet $vmss \r \r 如果要从规模集中删除虚拟机，则首先需要删除 ID 最高的虚拟机。\r \r <!---HONumber=Mooncake_1024_2016-->"}