{"Title":"使用 Azure API 管理保护 API","Description":"了解如何使用配额和限制（速率限制）策略保护 API。","Content":"# <a name=\"protect-your-api-with-rate-limits-using-azure-api-management\"></a>使用 Azure API 管理借助速率限制保护 API\r 本指南演示如何通过使用 Azure API 管理配置速率限制和配额策略轻松地为后端 API 添加保护。\r \r 在本教程中，将使用[限制每个订阅的调用速率](https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRate)和[设置每个订阅的使用配额](https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuota)策略创建一个“免费试用版”API 产品，该产品允许开发人员对 API 每分钟最多进行 10 次调用且每周最多进行 200 次调用。 然后会发布 API，并测试速率限制策略。\r \r 有关使用 [rate-limit-by-key](https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRateByKey) 和 [quota-by-key](https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuotaByKey) 策略的更高级限制方案，请参阅[使用 Azure API 管理设置高级请求限制](./api-management-sample-flexible-throttling.md)。\r \r ## <a name=\"create-product\"></a>创建产品\r 在此步骤中，将创建一种不需要订阅审批的免费试用版产品。\r \r > [!NOTE]\r > 如果已配置产品并想要在本教程中使用它，可以向前跳转到[配置调用速率限制和配额策略][Configure call rate limit and quota policies]，从那里按照教程进行操作，操作时使用你的产品替代免费试用版产品。\r > \r > \r \r 若要开始，请单击 API 管理服务的 Azure 门户中的“发布者门户”。\r \r ![发布者门户][api-management-management-console]\r \r > 如果尚未创建 API 管理服务实例，请参阅[在 Azure API 管理中管理你的第一个 API][Manage your first API in Azure API Management] 教程中的[创建 API 管理服务实例][Create an API Management service instance]。\r > \r > \r \r 单击左侧“API 管理”菜单中的“产品”以显示“产品”页。\r \r ![添加产品][api-management-add-product]\r \r 单击“添加产品”以显示“添加新产品”对话框。\r \r ![添加新产品][api-management-new-product-window]\r \r 在“标题”框中，键入“免费试用版”。\r \r 在“说明”框中，键入以下文本：“订阅者能够每分钟运行 10 次调用，最多每周运行 200 次调用，此后，访问会被拒绝。”\r \r API 管理中的产品可以是受保护的产品，也可以是开放的产品。 受保护的产品必须先订阅，才能使用。 开放的产品无需订阅即可使用。 若要创建需要订阅的受保护产品，请确保选中“需要订阅”。 此设置为默认设置。\r \r 如果希望管理员审查并接受或拒绝此产品的订阅尝试，请选中“需要订阅审批”。 如果未选中该复选框，则订阅尝试会被自动批准。 在此示例中，订阅是自动批准的，因此请不要选中该框。\r \r 若要允许开发人员帐户多次订阅新产品，请选中“允许多个同时存在的订阅”复选框。 本教程不使用多个同时存在的订阅，因此将它保留为未选中状态。\r \r 输入所有值后，单击“保存”创建产品。\r \r ![已添加产品][api-management-product-added]\r \r 默认情况下，新产品对“管理员”组中的用户可见。 我们要添加“开发人员”组。 单击“免费试用版”，并单击“可见性”选项卡。\r \r > 在 API 管理中，组用来管理产品对开发人员的可见性。 产品向组授予可见性，并且开发人员可以查看和订阅对他们所属的组可见的产品。 有关详细信息，请参阅[如何在 Azure API 管理中创建和使用组][How to create and use groups in Azure API Management]。\r > \r > \r \r ![添加开发人员组][api-management-add-developers-group]\r \r 选中“开发人员”复选框，并单击“保存”。\r \r ## <a name=\"add-api\"></a>将 API 添加到产品\r 在教程的此步骤中，我们将 Echo API 添加到新的免费试用版产品。\r \r > 每个预先配置 Echo API 的 API 管理服务实例都可用于试验和了解 API 管理。 有关详细信息，请参阅[在 Azure API 管理中管理你的第一个 API][Manage your first API in Azure API Management]。\r > \r > \r \r 单击左侧“API 管理”菜单中的“产品”，并单击“免费试用版”以配置该产品。\r \r ![配置产品][api-management-configure-product]\r \r 单击“将 API 添加到产品”。\r \r ![将 API 添加到产品][api-management-add-api]\r \r 选择“Echo API”，并单击“保存”。\r \r ![添加 Echo API][api-management-add-echo-api]\r \r ## <a name=\"policies\"></a>配置调用速率限制和配额策略\r 速率限制和配额是在策略编辑器中配置的。 我们会在本教程中添加的两个策略是[限制每个订阅的调用速率](https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRate)策略和[设置每个订阅的使用配额](https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuota)策略。 这些策略必须在产品范围内应用。\r \r 单击左侧“API 管理”菜单下的“策略”。 在“产品”列表中，单击“免费试用版”。\r \r ![产品策略][api-management-product-policy]\r \r 单击“添加策略”导入策略模板，并开始创建速率限制和配额策略  。\r \r ![添加策略][api-management-add-policy]\r \r 速率限制和配额策略是入站的策略，因此将光标定位在入站元素中。\r \r ![策略编辑器][api-management-policy-editor-inbound]\r \r 滚动访问策略列表，找到“限制每个订阅的调用速率”策略条目。\r \r ![策略语句][api-management-limit-policies]\r \r 将光标放置在 **inbound** 策略元素中后，单击“限制每个订阅的调用速率”旁边的箭头以插入其策略模板。\r \r ```xml\r <rate-limit calls=\"number\" renewal-period=\"seconds\">\r <api name=\"name\" calls=\"number\">\r <operation name=\"name\" calls=\"number\" />\r </api>\r </rate-limit>\r ```\r \r 从代码片段中可以看到，策略允许对产品的 API 和操作设置限制。 在本教程中，我们不会使用该功能，因此请从 **rate-limit** 元素中删除 **api** 和 **operation** 元素，使得只有外部的 **rate-limit** 元素仍然保留，如以下示例所示。\r \r ```xml\r <rate-limit calls=\"number\" renewal-period=\"seconds\">\r </rate-limit>\r ```\r \r 在“免费试用版”产品中，可允许的最高调用速率是每分钟调用 10 次，因此请键入 **10** 作为 **calls** 属性的值，键入 **60** 作为 **renewal-period** 属性的值。\r \r ```xml\r <rate-limit calls=\"10\" renewal-period=\"60\">\r </rate-limit>\r ```\r \r 若要配置“设置每个订阅的使用配额”策略，请将光标置于紧邻 **inbound** 元素中新添加的 **rate-limit** 元素下面，然后找到并单击“设置每个订阅的使用配额”左侧的箭头。\r \r ```xml\r <quota calls=\"number\" bandwidth=\"kilobytes\" renewal-period=\"seconds\">\r <api name=\"name\" calls=\"number\" bandwidth=\"kilobytes\">\r <operation name=\"name\" calls=\"number\" bandwidth=\"kilobytes\" />\r </api>\r </quota>\r ```\r \r 与“限制每个订阅的调用速率”策略类似，“设置每个订阅的使用配额”策略也允许对产品的 API 和操作进行设置限制。 在本教程中，我们不会使用该功能，因此请从 **quota** 元素中删除 **api** 和 **operation** 元素，如以下示例所示。\r \r ```xml\r <quota calls=\"number\" bandwidth=\"kilobytes\" renewal-period=\"seconds\">\r </quota>\r ```\r \r 配额可基于每个时间间隔、带宽或这两者的调用次数。 在本教程中，我们不基于带宽进行限制，因此请删除 **bandwidth** 属性。\r \r ```xml\r <quota calls=\"number\" renewal-period=\"seconds\">\r </quota>\r ```\r \r 在免费试用版产品中，该配额是每周 200 次调用。 指定 **200** 作为 **calls** 属性的值，并指定 **604800** 作为 **renewal-period** 属性的值。\r \r ```xml\r <quota calls=\"200\" renewal-period=\"604800\">\r </quota>\r ```\r \r > 策略间隔是以秒为单位指定的。 若要计算一周的时间间隔，可将天数 (7) 乘以一天的小时数 (24) 乘以每小时的分钟数 (60) 再乘以一分钟的秒数 (60)：7 * 24 * 60 * 60 = 604800。\r > \r > \r \r 完成配置策略后，它应与下面的示例匹配。\r \r ```xml\r <policies>\r     <inbound>\r         <rate-limit calls=\"10\" renewal-period=\"60\">\r         </rate-limit>\r         <quota calls=\"200\" renewal-period=\"604800\">\r         </quota>\r         <base />\r \r </inbound>\r <outbound>\r \r     <base />\r \r     </outbound>\r </policies>\r ```\r \r 配置所需的策略后，请单击“保存”。\r \r ![保存策略][api-management-policy-save]\r \r ## <a name=\"publish-product\"></a>发布产品\r 现在已添加 API 且已配置策略，该产品必须发布以供开发人员使用。 单击左侧“API 管理”菜单中的“产品”，并单击“免费试用版”以配置该产品。\r \r ![配置产品][api-management-configure-product]\r \r 单击“发布”，并单击“是，发布”确认。\r \r ![发布产品][api-management-publish-product]\r \r ## <a name=\"subscribe-account\"></a>为开发人员帐户订阅产品\r 现在产品已发布，可供开发人员订阅和使用。\r \r > API 管理实例的管理员自动订阅到每个产品。 在此教程步骤中，将为非管理员开发人员帐户之一订阅“免费试用版”产品。 如果开发人员帐户属于管理员角色，则可以按照此步骤操作，即使已订阅也是如此。\r > \r > \r \r 单击左侧“API 管理”菜单上的“用户”，并单击开发人员帐户的名称。 在此示例中，将使用 **Clayton Gragg** 开发人员帐户。\r \r ![配置开发人员][api-management-configure-developer]\r \r 单击“添加订阅”。\r \r ![添加订阅][api-management-add-subscription-menu]\r \r 选择“免费试用版”，并单击“订阅”。\r \r ![添加订阅][api-management-add-subscription]\r \r > [!NOTE]\r > 在本教程中，未为免费试用版产品启用多个同时存在的订阅。 如果已启用，则用户会被提示命名该订阅，如下面的示例所示。\r > \r > \r \r ![添加订阅][api-management-add-subscription-multiple]\r \r 单击“订阅”后，该产品将出现在用户的“订阅”列表中。\r \r ![已添加订阅][api-management-subscription-added]\r \r ## <a name=\"test-rate-limit\"></a>调用操作并测试速率限制\r 现在已配置并发布免费试用版产品，可以调用某些操作并测试速率限制策略了。\r 通过单击右上方菜单中的“开发人员门户”切换到开发人员门户。\r \r ![开发人员门户][api-management-developer-portal-menu]\r \r 单击顶部菜单中的“API”，并单击“Echo API”。\r \r ![开发人员门户][api-management-developer-portal-api-menu]\r \r 单击“GET 资源”，并单击“试用”。\r \r ![打开控制台][api-management-open-console]\r \r 保留默认参数值，并选择免费试用版产品的订阅密钥。\r \r ![订阅密钥][api-management-select-key]\r \r > [!NOTE]\r > 如果有多个订阅，请务必选择**免费试用版**的密钥，否则在前面步骤中配置的策略不会生效。\r > \r > \r \r 单击“发送”，并查看响应。 请注意响应状态为“200 正常”。\r \r ![操作结果][api-management-http-get-results]\r \r 以高于速率限制策略的每分钟 10 次调用的速率单击“发送”。 超出速率限制策略后，将返回响应状态“429 太多请求”。\r \r ![操作结果][api-management-http-get-429]\r \r “响应内容”指示重试成功前的剩余时间间隔。\r \r 每分钟 10 次调用的速率限制策略生效时，后续调用会失败，直到从超出速率限制前对产品进行前 10 次成功调用起已经过 60 秒。 此示例中的剩余时间间隔为 54 秒。\r \r \r [api-management-management-console]: ./media/api-management-howto-product-with-rules/api-management-management-console.png\r [api-management-add-product]: ./media/api-management-howto-product-with-rules/api-management-add-product.png\r [api-management-new-product-window]: ./media/api-management-howto-product-with-rules/api-management-new-product-window.png\r [api-management-product-added]: ./media/api-management-howto-product-with-rules/api-management-product-added.png\r [api-management-add-policy]: ./media/api-management-howto-product-with-rules/api-management-add-policy.png\r [api-management-policy-editor-inbound]: ./media/api-management-howto-product-with-rules/api-management-policy-editor-inbound.png\r [api-management-limit-policies]: ./media/api-management-howto-product-with-rules/api-management-limit-policies.png\r [api-management-policy-save]: ./media/api-management-howto-product-with-rules/api-management-policy-save.png\r [api-management-configure-product]: ./media/api-management-howto-product-with-rules/api-management-configure-product.png\r [api-management-add-api]: ./media/api-management-howto-product-with-rules/api-management-add-api.png\r [api-management-add-echo-api]: ./media/api-management-howto-product-with-rules/api-management-add-echo-api.png\r [api-management-developer-portal-menu]: ./media/api-management-howto-product-with-rules/api-management-developer-portal-menu.png\r [api-management-publish-product]: ./media/api-management-howto-product-with-rules/api-management-publish-product.png\r [api-management-configure-developer]: ./media/api-management-howto-product-with-rules/api-management-configure-developer.png\r [api-management-add-subscription-menu]: ./media/api-management-howto-product-with-rules/api-management-add-subscription-menu.png\r [api-management-add-subscription]: ./media/api-management-howto-product-with-rules/api-management-add-subscription.png\r [api-management-developer-portal-api-menu]: ./media/api-management-howto-product-with-rules/api-management-developer-portal-api-menu.png\r [api-management-open-console]: ./media/api-management-howto-product-with-rules/api-management-open-console.png\r [api-management-http-get]: ./media/api-management-howto-product-with-rules/api-management-http-get.png\r [api-management-http-get-results]: ./media/api-management-howto-product-with-rules/api-management-http-get-results.png\r [api-management-http-get-429]: ./media/api-management-howto-product-with-rules/api-management-http-get-429.png\r [api-management-product-policy]: ./media/api-management-howto-product-with-rules/api-management-product-policy.png\r [api-management-add-developers-group]: ./media/api-management-howto-product-with-rules/api-management-add-developers-group.png\r [api-management-select-key]: ./media/api-management-howto-product-with-rules/api-management-select-key.png\r [api-management-subscription-added]: ./media/api-management-howto-product-with-rules/api-management-subscription-added.png\r [api-management-add-subscription-multiple]: ./media/api-management-howto-product-with-rules/api-management-add-subscription-multiple.png\r \r [How to add operations to an API]: ./api-management-howto-add-operations.md\r [How to add and publish a product]: ./api-management-howto-add-products.md\r [Monitoring and analytics]: ../api-management-monitoring.md\r [Add APIs to a product]: ./api-management-howto-add-products.md#add-apis\r [Publish a product]: ./api-management-howto-add-products.md#publish-product\r [Manage your first API in Azure API Management]: ./api-management-get-started.md\r [How to create and use groups in Azure API Management]: ./api-management-howto-create-groups.md\r [View subscribers to a product]: ./api-management-howto-add-products.md#view-subscribers\r [Get started with Azure API Management]: ./api-management-get-started.md\r [Create an API Management service instance]: ./api-management-get-started.md#create-service-instance\r [Next steps]: #next-steps\r \r [Create a product]: #create-product\r [Configure call rate limit and quota policies]: #policies\r [Add an API to the product]: #add-api\r [Publish the product]: #publish-product\r [Subscribe a developer account to the product]: #subscribe-account\r [Call an operation and test the rate limit]: #test-rate-limit\r \r [Limit call rate]: https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRate\r [Set usage quota]: https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuota\r "}