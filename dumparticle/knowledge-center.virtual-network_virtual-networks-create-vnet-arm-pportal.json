{"Title":"创建包含多个子网的 Azure 虚拟网络","Description":"了解如何在 Azure 中创建包含多个子网的虚拟网络。","Content":"# <a name=\"create-a-virtual-network-with-multiple-subnets\"></a>创建包含多个子网的虚拟网络\r \r 本教程介绍如何创建包含独立公共子网和专用子网的基本 Azure 虚拟网络。 虚拟网络中的资源可以彼此通信，并可以与连接到虚拟网络的其他网络中的资源通信。 可在虚拟网络中相同或不同的子网中创建 Azure 资源，如虚拟机、应用服务环境、虚拟机规模集、Azure HDInsight 和云服务。 通过在不同的子网中创建资源，可以筛选出[网络安全组](virtual-networks-create-nsg-arm-pportal.md)以外的进出子网的网络流量，还可通过网络虚拟设备（如防火墙）[路由子网之间的流量](virtual-network-create-udr-arm-ps.md)（如果选择这样做）。 \r \r 以下部分提供了使用 [Azure 门户](#portal)、Azure 命令行接口 ([Azure CLI](#azure-cli))、[Azure PowerShell](#powershell) 和 [Azure 资源管理器模板](#resource-manager-template)创建虚拟网络的步骤。 不管使用哪种工具来创建虚拟网络，结果都是一样的。 单击工具链接，转到教程中该工具的对应部分。 详细了解所有[虚拟网络](virtual-network-manage-network.md)和[子网](virtual-network-manage-subnet.md)设置。\r \r 本文提供通过资源管理器部署模型（创建新虚拟网络时建议使用的部署模型）创建虚拟网络的步骤。 如果需要创建虚拟网络（经典），请参阅[创建虚拟网络（经典）](create-virtual-network-classic.md)。 如果不熟悉 Azure 的部署模型，请阅读[了解 Azure 部署模型](../azure-resource-manager/resource-manager-deployment-model.md?toc=%2fvirtual-network%2ftoc.json)。\r \r ## <a name=\"portal\"></a>Azure 门户\r \r 1. 在 Internet 浏览器中，转到 [Azure 门户](https://portal.azure.cn)。 使用 [Azure 帐户](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#account)登录。 如果没有 Azure 帐户，可以注册 [试用版](https://www.azure.cn/pricing/1rmb-trial-full)。\r 2. 在门户中，单击“+新建” > “网络” > “虚拟网络”。\r 3. 在“创建虚拟网络”边栏选项卡中，输入以下值，然后单击“创建”：\r \r     |设置|值|\r     |---|---|\r     |名称|myVnet|\r     |地址空间|10.0.0.0/16|\r     |子网名称|公共|\r     |子网地址范围|10.0.0.0/24|\r     |资源组|保留选中“新建”，输入 **myResourceGroup**。|\r     |订阅和位置|选择订阅和位置。\r \r     如果你不熟悉 Azure，请详细了解[资源组](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#resource-group)、[订阅](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#subscription)和[位置](https://azure.microsoft.com/regions)（也称为“区域”）。\r 4. 在门户中创建虚拟网络时，只能创建一个子网。 在本教程中，将在创建虚拟网络之后创建第二个子网。 随后可在“公共”子网中创建可通过 Internet 访问的资源。 还可以在“专用”子网中创建无法通过 Internet 访问的资源。 若要创建第二个子网，请在页面顶部的“搜索资源”框中输入 **myVnet**。 在搜索结果中，单击“myVnet”。 如果在订阅中存在多个同名的虚拟网络，请检查每个虚拟网络下列出的资源组。 确保单击的是包含“myResourceGroup”资源组的“myVnet”搜索结果。\r 5. 在“myVnet”边栏选项卡中，单击“设置”下面的“子网”。\r 6. 在“myVnet - 子网”边栏选项卡中单击“+子网”。\r 7. 在“添加子网”边栏选项卡中，在“名称”处输入“私有”。 为“地址范围”输入 **10.0.1.0/24**。  单击 **“确定”**。\r 8. 在“myVnet - 子网”边栏选项卡中查看子网。 可以看到所创建的“公共”和“专用”子网。\r 9. 可选：完成[后续步骤](#next-steps)下列出的其他教程，以便使用网络安全组筛选出进出每个子网的网络流量，以及通过网络虚拟设备路由子网之间的流量，或将虚拟网络连接到其他虚拟网络或本地网络。\r 10. 可选：若要删除在本教程中创建的资源，请完成[删除资源](#delete-portal)中所述的步骤。\r \r ## <a name=\"azure-cli\"></a>Azure CLI\r \r 无论是在 Windows、Linux 还是 macOS 上，执行 Azure CLI 命令的结果都是相同的。 不过在操作系统 shell 之间存在脚本差异。 以下步骤中的脚本在 Bash shell 中执行。 \r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r 1. [安装并配置 Azure CLI](https://docs.azure.cn/zh-cn/cli/install-azure-cli?toc=%2fazure%2fvirtual-network%2ftoc.json?view=azure-cli-latest)。 确保已安装最新版本的 Azure CLI。 若要获取 CLI 命令的帮助，请键入 `az <command> --help`。\r <!-- Not Available  Azure Cloud Shell.-->\r 2. 如果在本地运行 CLI，请使用 `az cloud set -n AzureChinaCloud` 和 `az login` 命令登录到 Azure。\r 3. 查看以下脚本及其注释。 在浏览器中，复制该脚本并将其粘贴到 CLI 会话中：\r \r     ```azurecli\r     #!/bin/bash\r \r     # Create a resource group.\r     az group create \\\r       --name myResourceGroup \\\r       --location chinaeast\r \r     # Create a virtual network with one subnet named Public.\r     az network vnet create \\\r       --name myVnet \\\r       --resource-group myResourceGroup \\\r       --subnet-name Public\r \r     # Create an additional subnet named Private in the virtual network.\r     az network vnet subnet create \\\r       --name Private \\\r       --address-prefix 10.0.1.0/24 \\\r       --vnet-name myVnet \\\r       --resource-group myResourceGroup\r     ```\r \r 4. 运行完脚本后，请查看虚拟网络的子网。 复制以下命令，并将其粘贴到 CLI 会话中：\r \r     ```azurecli\r     az network vnet subnet list --resource-group myResourceGroup --vnet-name myVnet --output table\r     ```\r \r 5. 可选：完成[后续步骤](#next-steps)下列出的其他教程，以便使用网络安全组筛选出进出每个子网的网络流量，以及通过网络虚拟设备路由子网之间的流量，或将虚拟网络连接到其他虚拟网络或本地网络。\r 6. 可选：若要删除在本教程中创建的资源，请完成[删除资源](#delete-cli)中所述的步骤。\r \r ## <a name=\"powershell\"></a>PowerShell\r \r 1. 安装最新版本的 PowerShell [AzureRm](https://www.powershellgallery.com/packages/AzureRM/) 模块。 如果不熟悉 Azure PowerShell，请参阅 [Azure PowerShell 概述](https://docs.microsoft.com/powershell/azure/overview?toc=%2fazure%2fvirtual-network%2ftoc.json)。\r 2. 在 PowerShell 会话中，使用 `login-azurermaccount` 命令以 [Azure 帐户](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#account)登录到 Azure。\r \r 3. 查看以下脚本及其注释。 在浏览器中，复制该脚本并将其粘贴到 PowerShell 会话中：\r \r     ```powershell\r     # Create a resource group.\r     New-AzureRmResourceGroup `\r       -Name myResourceGroup `\r       -Location chinaeast\r \r     # Create the public and private subnets.\r     $Subnet1 = New-AzureRmVirtualNetworkSubnetConfig `\r       -Name Public `\r       -AddressPrefix 10.0.0.0/24\r     $Subnet2 = New-AzureRmVirtualNetworkSubnetConfig `\r       -Name Private `\r       -AddressPrefix 10.0.1.0/24\r \r     # Create a virtual network.\r     $Vnet=New-AzureRmVirtualNetwork `\r       -ResourceGroupName myResourceGroup `\r       -Location chinaeast `\r       -Name myVnet `\r       -AddressPrefix 10.0.0.0/16 `\r       -Subnet $Subnet1,$Subnet2\r     ```\r \r 4. 若要查看虚拟网络的子网，请复制以下命令，并将其粘贴到 PowerShell 会话中：\r \r     ```powershell\r     $Vnet.subnets | Format-Table Name, AddressPrefix\r     ```\r \r 5. 可选：完成[后续步骤](#next-steps)下列出的其他教程，以便使用网络安全组筛选出进出每个子网的网络流量，以及通过网络虚拟设备路由子网之间的流量，或将虚拟网络连接到其他虚拟网络或本地网络。\r 6. 可选：若要删除在本教程中创建的资源，请完成[删除资源](#delete-powershell)中所述的步骤。\r \r ## <a name=\"resource-manager-template\"></a>Resource Manager 模板\r \r 可以使用 Azure Resource Manager 模板部署虚拟网络。 若要详细了解模板，请参阅[什么是 Resource Manager](../azure-resource-manager/resource-group-overview.md?toc=%2fvirtual-network%2ftoc.json#template-deployment)。 若要访问模板并了解其参数，请参阅[创建包含两个子网的虚拟网络](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vnet-two-subnets/)模板。 可以使用[门户](#template-portal)、[Azure CLI](#template-cli) 或 [PowerShell](#template-powershell) 部署模板。\r \r 部署模板后可选择执行的步骤：\r \r 1. 完成[后续步骤](#next-steps)下列出的其他教程，以便使用网络安全组筛选出进出每个子网的网络流量，以及通过网络虚拟设备路由子网之间的流量，或将虚拟网络连接到其他虚拟网络或本地网络。\r 2. 若要删除在本教程中创建的资源，请完成[删除资源](#delete)任何子节中的步骤。\r \r ### <a name=\"template-portal\"></a>Azure 门户\r \r 1. 在浏览器中打开[模板页](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vnet-two-subnets)。\r 2. 单击“**部署到 Azure**”按钮。 如果尚未登录到 Azure，请在显示的 Azure 门户登录屏幕中登录。\r 3. 使用 [Azure 帐户](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#account)登录到门户。 如果没有 Azure 帐户，可以注册 [试用版](https://www.azure.cn/pricing/1rmb-trial-full/)。\r 4. 输入以下参数值：\r \r     |参数|值|\r     |---|---|\r     |订阅|选择订阅|\r     |资源组|myResourceGroup|\r     |位置|选择位置|\r     |VNet 名称|myVnet|\r     |VNet 地址前缀|10.0.0.0/16|\r     |Subnet1Prefix|10.0.0.0/24|\r     |Subnet1Name|公共|\r     |Subnet2Prefix|10.0.1.0/24|\r     |Subnet2Name|专用|\r \r 5. 同意条款和条件，然后单击“购买”部署虚拟网络。\r \r ### <a name=\"template-cli\"></a>Azure CLI\r \r 1. [安装并配置 Azure CLI](https://docs.azure.cn/zh-cn/cli/install-azure-cli?toc=%2fazure%2fvirtual-network%2ftoc.json?view=azure-cli-latest)。 确保已安装最新版本的 Azure CLI。 若要获取 CLI 命令的帮助，请键入 `az <command> --help`。\r 2. 如果在本地运行 CLI，请使用 `az cloud set -n AzureChinaCloud'  'az login` 命令登录到 Azure。 \r 3. 若要为虚拟网络创建资源组，请复制以下命令，并将其粘贴到 CLI 会话中：\r \r     ```azurecli\r     az group create --name myResourceGroup --location chinaeast\r     ```\r \r 4. 可以使用下列参数选项之一来部署模板：\r     - 默认参数值。 输入以下命令：\r \r         ```azurecli\r         az group deployment create --resource-group myResourceGroup --name VnetTutorial --template-uri https://raw.githubusercontent.com/azure/azure-quickstart-templates/master/101-vnet-two-subnets/azuredeploy.json`\r         ```\r     - 自定义参数值。 部署模板之前下载并修改模板。 还可以在命令行中使用参数来部署模板，或使用单独的参数文件来部署模板。 若要下载模板和参数文件，请在[创建包含两个子网的虚拟网络](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vnet-two-subnets/)模板页上单击“在 GitHub 上浏览”按钮。 在 GitHub 中单击 **azuredeploy.parameters.json** 或 **azuredeploy.json** 文件。 然后单击该文件对应的“Raw”按钮。 在浏览器中，复制该文件的内容。 将内容保存到计算机上的某个文件中。 可以修改模板中的参数值，或使用单独的参数文件部署模板。  \r \r     若要详细了解如何使用这些方法部署模板，请键入 `az group deployment create --help`。\r \r ### <a name=\"template-powershell\"></a>PowerShell\r \r 1. 安装最新版本的 PowerShell [AzureRm](https://www.powershellgallery.com/packages/AzureRM/) 模块。 如果不熟悉 Azure PowerShell，请参阅 [Azure PowerShell 概述](https://docs.microsoft.com/powershell/azure/overview?toc=%2fazure%2fvirtual-network%2ftoc.json)。\r 2. 在 PowerShell 会话中，若要使用 [Azure 帐户](../azure-glossary-cloud-terminology.md?toc=%2fvirtual-network%2ftoc.json#account)登录，请输入 `login-azurermaccount`。\r 3. 若要为虚拟网络创建资源组，请输入以下命令：\r \r     ```powershell\r     New-AzureRmResourceGroup -Name myResourceGroup -Location chinaeast\r     ```\r \r 4. 可以使用下列参数选项之一来部署模板：\r     - 默认参数值。 输入以下命令：\r \r         ```powershell\r         New-AzureRmResourceGroupDeployment -Name VnetTutorial -ResourceGroupName myResourceGroup -TemplateUri https://raw.githubusercontent.com/azure/azure-quickstart-templates/master/101-vnet-two-subnets/azuredeploy.json\r         ```\r \r     - 自定义参数值。 部署模板之前下载并修改模板。 还可以在命令行中使用参数来部署模板，或使用单独的参数文件来部署模板。 若要下载模板和参数文件，请在[创建包含两个子网的虚拟网络](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vnet-two-subnets/)模板页上单击“在 GitHub 上浏览”按钮。 在 GitHub 中单击 **azuredeploy.parameters.json** 或 **azuredeploy.json** 文件。 然后单击该文件对应的“Raw”按钮。 在浏览器中，复制该文件的内容。 将内容保存到计算机上的某个文件中。 可以修改模板中的参数值，或使用单独的参数文件部署模板。  \r \r     若要详细了解如何使用这些方法部署模板，请键入 `Get-Help New-AzureRmResourceGroupDeployment`。 \r \r ## <a name=\"delete\"></a>删除资源\r \r 完成本教程后，可以删除创建的资源，以免产生使用费。 删除资源组会删除其中包含的所有资源。\r \r ### <a name=\"delete-portal\"></a>Azure 门户\r \r 1. 在门户的搜索框中，输入 myResourceGroup。 在搜索结果中，单击“myResourceGroup”。\r 2. 在“myResourceGroup”边栏选项卡中，单击“删除”图标。\r 3. 若要确认删除，请在“键入资源组名称”框中输入 myResourceGroup，然后单击“删除”。\r \r ### <a name=\"delete-cli\"></a>Azure CLI\r \r 在 CLI 会话中输入以下命令：\r \r ```azurecli\r az group delete --name myResourceGroup --yes\r ```\r \r ### <a name=\"delete-powershell\"></a>PowerShell\r \r 在 PowerShell 会话中输入以下命令：\r \r ```powershell\r Remove-AzureRmResourceGroup -Name myResourceGroup -Force\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - 若要了解有关所有虚拟网络和子网设置的信息，请参阅[管理虚拟网络](virtual-network-manage-network.md#view-vnet)和[管理虚拟网络子网](virtual-network-manage-subnet.md#create-subnet)。 可以根据不同的要求，通过多种选项在生产环境中使用虚拟网络和子网。\r - 创建[网络安全组](virtual-networks-nsg.md)并将其应用到子网，然后筛选入站和出站子网流量。\r - 创建[用户定义的路由](virtual-network-create-udr-arm-ps.md)并将路由应用到每个子网，然后通过网络虚拟设备路由子网之间的流量。\r - 在现有虚拟网络中创建 [Windows](../virtual-machines/virtual-machines-windows-hero-tutorial.md?toc=%2fvirtual-network%2ftoc.json) 或 [Linux](../virtual-machines/linux/quick-create-portal.md?toc=%2fvirtual-network%2ftoc.json) 虚拟机。\r - 在虚拟网路之间创建[虚拟网络对等](virtual-network-peering-overview.md)，然后连接两个虚拟网络。\r - 使用 [VPN 网关](../vpn-gateway/vpn-gateway-howto-multi-site-to-site-resource-manager-portal.md?toc=%2fvirtual-network%2ftoc.json)或 [Azure ExpressRoute](../expressroute/expressroute-howto-linkvnet-portal-resource-manager.md?toc=%2fvirtual-network%2ftoc.json) 线路将虚拟网络连接到本地网络。\r \r <!--Update_Description: wording update, update reference link-->"}