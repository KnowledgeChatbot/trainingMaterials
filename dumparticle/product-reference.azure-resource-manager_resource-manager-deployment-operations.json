{"Title":"使用 Azure Resource Manager 执行部署操作","Description":"介绍如何通过门户、PowerShell、Azure CLI 和 REST API 查看 Azure Resource Manager 部署操作。","Content":"\r # 使用 Azure Resource Manager 查看部署操作\r \r 可以通过 Azure 门户查看部署操作。当你在部署过程中收到错误时，可能最想要查看操作，因此本文将重点介绍如何查看已失败的操作。该门户提供了一个界面让你轻松找到错误并确定可能的解决方法。\r \r [!INCLUDE [resource-manager-troubleshoot-introduction](../../includes/resource-manager-troubleshoot-introduction.md)]\r \r ## 门户\r 若要查看部署操作，请使用以下步骤 ：\r \r 1. 对于部署中涉及的资源组，请注意最后一个部署的状态。你可以选择此状态以获取更多详细信息。\r \r     ![部署状态](./media/resource-manager-deployment-operations/deployment-status.png)  \r \r 2. 你看到最近的部署历史记录。选择失败的部署。\r \r     ![部署状态](./media/resource-manager-deployment-operations/select-deployment.png)  \r \r 3. 选择链接，查看部署失败的原因说明。在下图中，DNS 记录不是唯一的。\r \r     ![查看失败的部署](./media/resource-manager-deployment-operations/view-error.png)  \r \r     此错误消息应足够让你可以开始进行故障排除。但是，如果你需要有关完成了哪些任务的更多详细信息，可以查看操作，如下面的步骤所示。\r 4. 可以在“部署”边栏选项卡中查看所有部署操作。选择任何操作，以查看更多详细信息。\r \r     ![查看操作](./media/resource-manager-deployment-operations/view-operations.png)  \r \r     在此示例中，你会看到已成功创建存储帐户、虚拟网络和可用性集。公共 IP 地址失败，未尝试其他资源。\r 5. 可以通过选择“事件”查看部署的事件。\r \r     ![查看事件](./media/resource-manager-deployment-operations/view-events.png)  \r \r 6. 查看部署的所有事件，并选择任何事件以了解更多详细信息。另请注意相关性 ID。与技术支持人员合作排查部署问题时，此值非常有用。\r \r     ![查看事件](./media/resource-manager-deployment-operations/see-all-events.png)\r \r ## PowerShell\r 1. 若要获取部署的总体状态，请使用 **Get-AzureRmResourceGroupDeployment** 命令。\r \r     ```powershell\r     Get-AzureRmResourceGroupDeployment -ResourceGroupName ExampleGroup\r     ```\r \r     也可以筛选结果，以便只获取失败的部署。\r \r     ```powershell\r     Get-AzureRmResourceGroupDeployment -ResourceGroupName ExampleGroup | Where-Object ProvisioningState -eq Failed\r     ```\r \r 2. 每个部署包括多个操作。每个操作代表部署过程中的一个步骤。为了查明部署何处出现问题，通常需要查看部署操作的详细信息。可以用 **Get-AzureRmResourceGroupDeploymentOperation** 查看操作的状态。\r \r     ```powershell\r     Get-AzureRmResourceGroupDeploymentOperation -ResourceGroupName ExampleGroup -DeploymentName vmDeployment\r     ```\r \r     它将返回多个操作，其中每个操作采用以下格式：\r \r     ```powershell\r     Id             : /subscriptions/{guid}/resourceGroups/ExampleGroup/providers/Microsoft.Resources/deployments/Microsoft.Template/operations/A3EB2DA598E0A780\r     OperationId    : A3EB2DA598E0A780\r     Properties     : @{provisioningOperation=Create; provisioningState=Succeeded; timestamp=2016-06-14T21:55:15.0156208Z;\r                    duration=PT23.0227078S; trackingId=11d376e8-5d6d-4da8-847e-6f23c6443fbf;\r                    serviceRequestId=0196828d-8559-4bf6-b6b8-8b9057cb0e23; statusCode=OK; targetResource=}\r     PropertiesText : {duration:PT23.0227078S, provisioningOperation:Create, provisioningState:Succeeded,\r                    serviceRequestId:0196828d-8559-4bf6-b6b8-8b9057cb0e23...}\r     ```\r \r 3. 若要获取有关失败操作的更多详细信息，请检索状态为“失败”的操作的属性。\r \r     ```powershell\r     (Get-AzureRmResourceGroupDeploymentOperation -DeploymentName Microsoft.Template -ResourceGroupName ExampleGroup).Properties | Where-Object ProvisioningState -eq Failed\r     ```\r \r     它将返回所有失败的操作，其中每个操作采用以下格式：\r \r     ```powershell\r     provisioningOperation : Create\r     provisioningState     : Failed\r     timestamp             : 2016-06-14T21:54:55.1468068Z\r     duration              : PT3.1449887S\r     trackingId            : f4ed72f8-4203-43dc-958a-15d041e8c233\r     serviceRequestId      : a426f689-5d5a-448d-a2f0-9784d14c900a\r     statusCode            : BadRequest\r     statusMessage         : @{error=}\r     targetResource        : @{id=/subscriptions/{guid}/resourceGroups/ExampleGroup/providers/\r                           Microsoft.Network/publicIPAddresses/myPublicIP;\r                           resourceType=Microsoft.Network/publicIPAddresses; resourceName=myPublicIP}\r     ```\r \r     注意操作的 serviceRequestId 和 trackingId。与技术支持人员合作排查部署问题时，serviceRequestId 非常有用。将在下一步使用 trackingId 重点关注特定操作。\r 4. 若要获取特定失败操作的状态消息，请使用以下命令：\r \r     ```powershell\r     ((Get-AzureRmResourceGroupDeploymentOperation -DeploymentName Microsoft.Template -ResourceGroupName ExampleGroup).Properties | Where-Object trackingId -eq f4ed72f8-4203-43dc-958a-15d041e8c233).StatusMessage.error\r     ```\r \r     将返回：\r \r     ```powershell\r     code           message                                                                        details\r     ----           -------                                                                        -------\r     DnsRecordInUse DNS record dns.chinanorth.chinacloudapp.cn is already used by another public IP. {}\r     ```\r \r 5. Azure 中的每个部署操作均包括请求和响应内容。请求内容是部署期间发送到 Azure 的内容（例如，创建 VM、OS 磁盘和其他资源）。响应内容是 Azure 从部署请求发送回的内容。在部署期间，可以使用 **DeploymentDebugLogLevel** 参数指定将请求和/或响应保留在日志中。\r \r     使用以下 PowerShell 命令从日志中获取该信息，并将其保存在本地：\r \r     ```powershell\r     (Get-AzureRmResourceGroupDeploymentOperation -DeploymentName \"TestDeployment\" -ResourceGroupName \"Test-RG\").Properties.request | ConvertTo-Json |  Out-File -FilePath <PathToFile>\r \r     (Get-AzureRmResourceGroupDeploymentOperation -DeploymentName \"TestDeployment\" -ResourceGroupName \"Test-RG\").Properties.response | ConvertTo-Json |  Out-File -FilePath <PathToFile>\r     ```\r \r ## Azure CLI\r \r 1. 使用 **azure group deployment show** 命令获取部署的总体状态。\r \r     ```azurecli\r     azure group deployment show --resource-group ExampleGroup --name ExampleDeployment --json\r     ```\r \r     返回的值之一是 **correlationId**。此值可用于跟踪相关事件，在与技术支持人员合作排查部署问题时非常有用。\r \r     ```azurecli\r     \"properties\": {\r     \"provisioningState\": \"Failed\",\r     \"correlationId\": \"4002062a-a506-4b5e-aaba-4147036b771a\",\r     ```\r \r 2. 若要查看部署操作，请使用：\r \r     ```azurecli\r     azure group deployment operation list --resource-group ExampleGroup --name ExampleDeployment --json\r     ```\r \r ## REST\r \r 1. 使用[获取有关模板部署的信息](https://docs.microsoft.com/rest/api/resources/deployments#Deployments_Get)操作来获取有关部署的信息。\r \r     ```http\r     GET https://management.chinacloudapi.cn/subscriptions/{subscription-id}/resourcegroups/{resource-group-name}/providers/microsoft.resources/deployments/{deployment-name}?api-version={api-version}\r     ```\r \r     在响应中，请特别注意 **provisioningState**、**correlationId** 和 **error** 元素。**correlationId** 可用于跟踪相关事件，在与技术支持人员合作排查部署问题时非常有用。\r \r     ```json\r     { \r       ...\r       \"properties\": {\r         \"provisioningState\":\"Failed\",\r         \"correlationId\":\"d5062e45-6e9f-4fd3-a0a0-6b2c56b15757\",\r         ...\r         \"error\":{\r           \"code\":\"DeploymentFailed\",\"message\":\"At least one resource deployment operation failed. Please list deployment operations for details. Please see http://aka.ms/arm-debug for usage details.\",\r           \"details\":[{\"code\":\"Conflict\",\"message\":\"{\\r\\n  \"error\": {\\r\\n    \"message\": \"Conflict\",\\r\\n    \"code\": \"Conflict\"\\r\\n  }\\r\\n}\"}]\r         }  \r       }\r     }\r     ```\r \r 2. 使用[列出所有模板部署操作](https://docs.microsoft.com/rest/api/resources/deployments#Deployments_List)操作来获取有关部署操作的信息。\r \r     ```http\r     GET https://management.chinacloudapi.cn/subscriptions/{subscription-id}/resourcegroups/{resource-group-name}/providers/microsoft.resources/deployments/{deployment-name}/operations?$skiptoken={skiptoken}&api-version={api-version}\r     ```\r \r     响应包含请求和/或响应信息，具体取决于部署期间在 **debugSetting** 属性中指定的内容。\r \r     ```json\r     {\r       ...\r       \"properties\": \r       {\r         ...\r         \"request\":{\r           \"content\":{\r             \"location\":\"China North\",\r             \"properties\":{\r               \"accountType\": \"Standard_LRS\"\r             }\r           }\r         },\r         \"response\":{\r           \"content\":{\r             \"error\":{\r               \"message\":\"Conflict\",\"code\":\"Conflict\"\r             }\r           }\r         }\r       }\r     }\r     ```\r \r ## 后续步骤\r * 有关解决特定部署错误的帮助，请参阅 [Resolve common errors when deploying resources to Azure with Azure Resource Manager](./resource-manager-common-deployment-errors.md)（解决使用 Azure Resource Manager 将资源部署到 Azure 时的常见错误）。\r * 若要了解如何使用活动日志监视其他类型的操作，请参阅[通过查看活动日志管理 Azure 资源](./resource-group-audit.md)。\r * 若要在执行部署之前验证部署，请参阅[使用 Azure Resource Manager 模板部署资源组](./resource-group-template-deploy.md)。\r \r <!---HONumber=Mooncake_0327_2017-->\r <!-- Update_Description:update meta properties; wording update; add new feature about how to save log file with powershell -->"}