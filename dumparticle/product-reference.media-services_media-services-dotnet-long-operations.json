{"Title":"轮询长时间运行的操作","Description":"本主题展示了如何轮询长时间运行的操作。","Content":"# <a name=\"delivering-live-streaming-with-azure-media-services\"></a>使用 Azure 媒体服务传送实时流\r \r ## <a name=\"overview\"></a>概述\r \r Microsoft Azure 媒体服务提供了相应的 API 来向媒体服务发送启动操作请求（例如创建、启动、停止或删除频道）。 这些操作是长时间运行的。\r \r 媒体服务 .NET SDK 提供了用来发送请求并等待操作完成的 API（在内部，这些 API 以特定的时间间隔轮询操作进度）。 例如，当调用 channel.Start() 时，该方法将在频道启动后返回。 还可以使用异步版本：await channel.StartAsync()（有关基于任务的异步模式的信息，请参阅 [TAP](https://msdn.microsoft.com/library/hh873175\\(v=vs.110\\).aspx)。 发送操作请求并且在操作完成之前一直轮询操作状态的 API 称作“轮询方法”。 建议为富客户端应用程序和/或有状态服务使用这些方法（特别是异步版本）。\r \r 某些情况下，应用程序不能等待长时运行的 http 请求并且希望手动轮询操作进度。 一个典型的示例是与无状态 Web 服务进行交互的浏览器：当浏览器请求创建频道时，Web 服务会启动一个长时间运行的操作并将操作 ID 返回到浏览器。 然后，浏览器可以根据该 ID 询问 Web 服务来获取操作状态。 媒体服务 .NET SDK 提供了非常适用于此情况的 API。 这些 API 称为“非轮询方法”。\r “非轮询方法”具有以下命名模式：Send“OperationName”Operation（例如，SendCreateOperation）。 Send“OperationName”Operation 方法返回 **IOperation** 对象；返回的对象包含可以用来跟踪操作的信息。 Send“OperationName”OperationAsync 方法将返回“Task”**<IOperation>**。\r \r 当前，以下类支持非轮询方法：Channel、StreamingEndpoint 和 Program。\r \r 若要轮询操作状态，请对“OperationBaseCollection”类使用“GetOperation”方法。 使用以下时间间隔来检查操作状态：对于 Channel 和 StreamingEndpoint 操作，使用 30 秒；对于 Program 操作，使用 10 秒。\r \r ## <a name=\"create-and-configure-a-visual-studio-project\"></a>创建和配置 Visual Studio 项目\r \r 设置开发环境，并在 app.config 文件中填充连接信息，如[使用 .NET 进行媒体服务开发](media-services-dotnet-how-to-use.md)中所述。\r \r ## <a name=\"example\"></a>示例\r \r 以下示例定义了一个名为 **ChannelOperations**的类。 可以将该类定义用作 Web 服务类定义的起点。 为简单起见，以下示例使用了方法的非异步版本。\r \r 示例还展示了客户端可以如何使用该类。\r \r ### <a name=\"channeloperations-class-definition\"></a>ChannelOperations 类定义\r \r     using Microsoft.WindowsAzure.MediaServices.Client;\r     using System;\r     using System.Collections.Generic;\r     using System.Configuration;\r     using System.Net;\r \r     /// <summary> \r     /// The ChannelOperations class only implements \r     /// the Channel’s creation operation. \r     /// </summary> \r     public class ChannelOperations\r     {\r         // Read values from the App.config file.\r         private static readonly string _AADTenantDomain =\r             ConfigurationManager.AppSettings[\"AADTenantDomain\"];\r         private static readonly string _RESTAPIEndpoint =\r             ConfigurationManager.AppSettings[\"MediaServiceRESTAPIEndpoint\"];\r \r         // Field for service context.\r         private static CloudMediaContext _context = null;\r \r         public ChannelOperations()\r         {\r             var tokenCredentials = new AzureAdTokenCredentials(_AADTenantDomain, AzureEnvironments.AzureChinaCloudEnvironment);\r             var tokenProvider = new AzureAdTokenProvider(tokenCredentials);\r \r             _context = new CloudMediaContext(new Uri(_RESTAPIEndpoint), tokenProvider);\r         }\r \r         /// <summary>  \r         /// Initiates the creation of a new channel.  \r         /// </summary>  \r         /// <param name=\"channelName\">Name to be given to the new channel</param>  \r         /// <returns>  \r         /// Operation Id for the long running operation being executed by Media Services. \r         /// Use this operation Id to poll for the channel creation status. \r         /// </returns> \r         public string StartChannelCreation(string channelName)\r         {\r             var operation = _context.Channels.SendCreateOperation(\r                 new ChannelCreationOptions\r                 {\r                     Name = channelName,\r                     Input = CreateChannelInput(),\r                     Preview = CreateChannelPreview(),\r                     Output = CreateChannelOutput()\r                 });\r \r             return operation.Id;\r         }\r \r         /// <summary> \r         /// Checks if the operation has been completed. \r         /// If the operation succeeded, the created channel Id is returned in the out parameter.\r         /// </summary> \r         /// <param name=\"operationId\">The operation Id.</param> \r         /// <param name=\"channel\">\r         /// If the operation succeeded, \r         /// the created channel Id is returned in the out parameter.</param>\r         /// <returns>Returns false if the operation is still in progress; otherwise, true.</returns> \r         public bool IsCompleted(string operationId, out string channelId)\r         {\r             IOperation operation = _context.Operations.GetOperation(operationId);\r             bool completed = false;\r \r             channelId = null;\r \r             switch (operation.State)\r             {\r                 case OperationState.Failed:\r                     // Handle the failure. \r                     // For example, throw an exception. \r                     // Use the following information in the exception: operationId, operation.ErrorMessage.\r                     break;\r                 case OperationState.Succeeded:\r                     completed = true;\r                     channelId = operation.TargetEntityId;\r                     break;\r                 case OperationState.InProgress:\r                     completed = false;\r                     break;\r             }\r             return completed;\r         }\r \r         private static ChannelInput CreateChannelInput()\r         {\r             return new ChannelInput\r             {\r                 StreamingProtocol = StreamingProtocol.RTMP,\r                 AccessControl = new ChannelAccessControl\r                 {\r                     IPAllowList = new List<IPRange>\r                         {\r                             new IPRange\r                             {\r                                 Name = \"TestChannelInput001\",\r                                 Address = IPAddress.Parse(\"0.0.0.0\"),\r                                 SubnetPrefixLength = 0\r                             }\r                         }\r                 }\r             };\r         }\r \r         private static ChannelPreview CreateChannelPreview()\r         {\r             return new ChannelPreview\r             {\r                 AccessControl = new ChannelAccessControl\r                 {\r                     IPAllowList = new List<IPRange>\r                         {\r                             new IPRange\r                             {\r                                 Name = \"TestChannelPreview001\",\r                                 Address = IPAddress.Parse(\"0.0.0.0\"),\r                                 SubnetPrefixLength = 0\r                             }\r                         }\r                 }\r             };\r         }\r \r         private static ChannelOutput CreateChannelOutput()\r         {\r             return new ChannelOutput\r             {\r                 Hls = new ChannelOutputHls { FragmentsPerSegment = 1 }\r             };\r         }\r     }\r \r ### <a name=\"the-client-code\"></a>客户端代码\r     ChannelOperations channelOperations = new ChannelOperations();\r     string opId = channelOperations.StartChannelCreation(\"MyChannel001\");\r \r     string channelId = null;\r     bool isCompleted = false;\r \r     while (isCompleted == false)\r     {\r         System.Threading.Thread.Sleep(TimeSpan.FromSeconds(30));\r         isCompleted = channelOperations.IsCompleted(opId, out channelId);\r     }\r \r     // If we got here, we should have the newly created channel id.\r     Console.WriteLine(channelId);\r \r \r \r <!--Update_Description: update code to use AAD token instead of ACS-->"}