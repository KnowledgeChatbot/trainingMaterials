{"Title":"使用 REST 配置内容密钥授权策略 - Azure","Description":"了解如何使用媒体服务 REST API 配置内容密钥的授权策略。","Content":"# <a name=\"dynamic-encryption-configure-content-key-authorization-policy\"></a>动态加密：配置内容密钥授权策略\r [!INCLUDE [media-services-selector-content-key-auth-policy](../../includes/media-services-selector-content-key-auth-policy.md)]\r \r ##<a name=\"overview\"></a>概述\r \r 借助 Azure 媒体服务，可传送使用高级加密标准（AES，使用 128 位加密密钥）以及 PlayReady DRM 动态加密的内容。 媒体服务还提供了用于向已授权客户端传送密钥和 PlayReady 许可证的服务。 \r \r 如果希望媒体服务加密资产，需要将加密密钥（CommonEncryption 或 EnvelopeEncryption）与资产相关联（如[此处](media-services-rest-create-contentkey.md)所述），并配置密钥授权策略（如本文所述）。\r \r 当播放器请求流时，媒体服务使用指定的密钥通过 AES 或 PlayReady 加密动态加密你的内容。 为了解密流，播放器会从密钥传送服务请求密钥。 为了确定用户是否有权获取密钥，服务会评估为密钥指定的授权策略。\r \r 媒体服务支持通过多种方式对发出密钥请求的用户进行身份验证。 内容密钥授权策略可能受到一种或多种授权限制：开放或令牌限制。 令牌限制策略必须附带由安全令牌服务 (STS) 颁发的令牌。 媒体服务支持采用简单 Web 令牌 ([SWT](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_2)) 格式和 JSON Web 令牌 (JWT) 格式的令牌。\r \r 媒体服务不提供安全令牌服务。 可以创建自定义 STS 或利用 Microsoft Azure ACS 颁发令牌。 必须将 STS 配置为创建令牌，该令牌使用指定密钥以及你在令牌限制配置中指定的颁发声明进行签名（如本文所述）。 如果令牌有效，而且令牌中的声明与为内容密钥配置的声明相匹配，则媒体服务密钥传送服务会将加密密钥返回到客户端。\r \r 有关详细信息，请参阅\r \r [JWT 令牌身份验证](http://www.gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/)\r \r [将基于 Azure 媒体服务 OWIN MVC 的应用与 Azure Active Directory 相集成，并基于 JWT 声明限制内容密钥传送](http://www.gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/)。\r \r [使用 Azure ACS 颁发令牌](http://mingfeiy.com/acs-with-key-services)。\r \r ### <a name=\"some-considerations-apply\"></a>请注意以下事项：\r * 若要使用动态打包和动态加密，需确保要从中流式传输内容的流式处理终结点处于“正在运行”状态。\r * 资产必须包含一组自适应比特率 MP4 或自适应比特率平滑流式处理文件。 有关详细信息，请参阅[对资产进行编码](media-services-encode-asset.md)。\r * 使用 **AssetCreationOptions.StorageEncrypted** 选项上传资产并对其进行编码。\r * 如果打算创建需要相同策略配置的多个内容密钥，我们强烈建议创建单个授权策略，并将其重复用于多个内容密钥。\r * 密钥传送服务将 ContentKeyAuthorizationPolicy 及其相关对象（策略选项和限制）缓存 15 分钟。  如果创建 ContentKeyAuthorizationPolicy 并指定使用“令牌”限制，并对其进行测试，再将策略更新为“开放”限制，则现有策略切换到“开放”版本的策略需要大约 15 分钟。\r * 如果添加或更新资产的传送策略，则必须删除现有定位符（如果有）并创建新定位符。\r * 目前，无法加密渐进式下载。\r \r ## <a name=\"aes-128-dynamic-encryption\"></a>AES-128 动态加密\r > [!NOTE]\r > 使用媒体服务 REST API 时，需注意以下事项：\r > \r > 访问媒体服务中的实体时，必须在 HTTP 请求中设置特定标头字段和值。 有关详细信息，请参阅[媒体服务 REST API 开发的设置](media-services-rest-how-to-use.md)。\r > \r > 若要了解如何连接到 AMS API，请参阅[通过 Azure AD 身份验证访问 Azure 媒体服务 API](media-services-use-aad-auth-to-access-ams-api.md)。\r > \r > \r \r ### <a name=\"open-restriction\"></a>开放限制\r 开放限制意味着系统会将密钥传送到发出密钥请求的任何用户。 此限制可能适用于测试用途。\r \r 以下示例创建开放授权策略，并将其添加到内容密钥。\r \r #### <a id=\"ContentKeyAuthorizationPolicies\"></a>创建 ContentKeyAuthorizationPolicies\r \r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicies HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=bbbef702-e769-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423578086&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=lZlyQ2%2bvH73qtJsb42%2fH3xF7r7EvQFR3UXyezuDENFU%3d\r x-ms-version: 2.11\r x-ms-client-request-id: d732dbfa-54fc-474c-99d6-9b46a006f389\r Host: wamsshaclus001rest-hs.chinacloudapp.cn \r Content-Length: 36\r \r {\"Name\":\"Open Authorization Policy\"}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 211\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicies('nb%3Ackpid%3AUUID%3Adb4593da-f4d1-4cc5-a92a-d20eacbabee4')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: d732dbfa-54fc-474c-99d6-9b46a006f389\r request-id: aabfa731-e884-4bf3-8314-492b04747ac4\r x-ms-request-id: aabfa731-e884-4bf3-8314-492b04747ac4\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 08:25:56 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicies/@Element\",\"Id\":\"nb:ckpid:UUID:db4593da-f4d1-4cc5-a92a-d20eacbabee4\",\"Name\":\"Open Authorization Policy\"}\r ```\r \r #### <a id=\"ContentKeyAuthorizationPolicyOptions\"></a>创建 ContentKeyAuthorizationPolicyOptions\r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 3.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=bbbef702-e769-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423580006&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=Ref3EsonGF7fUKCwGwGgiMnZitzIzsDOvvMTeVrVVPg%3d\r x-ms-version: 2.11\r x-ms-client-request-id: d225e357-e60e-4f42-add8-9d93aba1409a\r Host: wamsshaclus001rest-hs.chinacloudapp.cn \r Content-Length: 168\r \r {\"Name\":\"policy\",\"KeyDeliveryType\":2,\"KeyDeliveryConfiguration\":\"\",\"Restrictions\":[{\"Name\":\"HLS Open Authorization Policy\",\"KeyRestrictionType\":0,\"Requirements\":null}]}\r ```\r \r 响应：   \r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 349\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions('nb%3Ackpoid%3AUUID%3A57829b17-1101-4797-919b-f816f4a007b7')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: d225e357-e60e-4f42-add8-9d93aba1409a\r request-id: 81bcad37-295b-431f-972f-b23f2e4172c9\r x-ms-request-id: 81bcad37-295b-431f-972f-b23f2e4172c9\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 08:56:40 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicyOptions/@Element\",\"Id\":\"nb:ckpoid:UUID:57829b17-1101-4797-919b-f816f4a007b7\",\"Name\":\"policy\",\"KeyDeliveryType\":2,\"KeyDeliveryConfiguration\":\"\",\"Restrictions\":[{\"Name\":\"HLS Open Authorization Policy\",\"KeyRestrictionType\":0,\"Requirements\":null}]}\r ```\r \r #### <a id=\"LinkContentKeyAuthorizationPoliciesWithOptions\"></a>将 ContentKeyAuthorizationPolicies 与 Options 相链接\r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicies('nb%3Ackpid%3AUUID%3A0baa438b-8ac2-4c40-a53c-4d4722b78715')/$links/Options HTTP/1.1\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Content-Type: application/json\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=zbbef702-2233-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423580006&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=Ref3EsonGF7fUKCwGwGgiMnZitzIzsDOvvMTeVrVVPg%3d\r x-ms-version: 2.11\r x-ms-client-request-id: 9847f705-f2ca-4e95-a478-8f823dbbaa29\r Host: wamsshaclus001rest-hs.chinacloudapp.cn \r Content-Length: 154\r \r {\"uri\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions('nb%3Ackpoid%3AUUID%3A57829b17-1101-4797-919b-f816f4a007b7')\"}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 204 No Content\r ```\r \r #### <a id=\"AddAuthorizationPolicyToKey\"></a>将授权策略添加到内容密钥\r 请求：\r \r ```\r PUT https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeys('nb%3Akid%3AUUID%3A2e6d36a7-a17c-4e9a-830d-eca23ad1a6f9') HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=zbbef702-2233-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423581565&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=JiNSG3w6r2C0nIyfKvTZj1uPJGjuitD%2b0sbfZ%2b2JDZI%3d\r x-ms-version: 2.11\r x-ms-client-request-id: e613efff-cb6a-41b4-984a-f4f8fb6e76a4\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 78\r \r {\"AuthorizationPolicyId\":\"nb:ckpid:UUID:c06cebb8-c4f0-4d1a-ba00-3273fb2bc3ad\"}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 204 No Content\r ```\r \r ### <a name=\"token-restriction\"></a>令牌限制\r 本部分介绍如何创建内容密钥授权策略，以及如何将其与内容密钥相关联。 授权策略描述了必须达到什么授权要求才能确定用户是否有权接收密钥（例如，“验证密钥”列表是否包含令牌签名时使用的密钥）。\r \r 要配置令牌限制选项，需要使用 XML 描述令牌的授权要求。 令牌限制配置 XML 必须符合以下 XML 架构。\r \r ####<a id=\"schema\"></a>令牌限制架构\r \r ```\r <?xml version=\"1.0\" encoding=\"utf-8\"?>\r <xs:schema xmlns:tns=\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\" elementFormDefault=\"qualified\" targetNamespace=\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\r   <xs:complexType name=\"TokenClaim\">\r     <xs:sequence>\r       <xs:element name=\"ClaimType\" nillable=\"true\" type=\"xs:string\" />\r       <xs:element minOccurs=\"0\" name=\"ClaimValue\" nillable=\"true\" type=\"xs:string\" />\r     </xs:sequence>\r   </xs:complexType>\r   <xs:element name=\"TokenClaim\" nillable=\"true\" type=\"tns:TokenClaim\" />\r   <xs:complexType name=\"TokenRestrictionTemplate\">\r     <xs:sequence>\r       <xs:element minOccurs=\"0\" name=\"AlternateVerificationKeys\" nillable=\"true\" type=\"tns:ArrayOfTokenVerificationKey\" />\r       <xs:element name=\"Audience\" nillable=\"true\" type=\"xs:anyURI\" />\r       <xs:element name=\"Issuer\" nillable=\"true\" type=\"xs:anyURI\" />\r       <xs:element name=\"PrimaryVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r       <xs:element minOccurs=\"0\" name=\"RequiredClaims\" nillable=\"true\" type=\"tns:ArrayOfTokenClaim\" />\r     </xs:sequence>\r   </xs:complexType>\r   <xs:element name=\"TokenRestrictionTemplate\" nillable=\"true\" type=\"tns:TokenRestrictionTemplate\" />\r   <xs:complexType name=\"ArrayOfTokenVerificationKey\">\r     <xs:sequence>\r       <xs:element minOccurs=\"0\" maxOccurs=\"unbounded\" name=\"TokenVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r     </xs:sequence>\r   </xs:complexType>\r   <xs:element name=\"ArrayOfTokenVerificationKey\" nillable=\"true\" type=\"tns:ArrayOfTokenVerificationKey\" />\r   <xs:complexType name=\"TokenVerificationKey\">\r     <xs:sequence />\r   </xs:complexType>\r   <xs:element name=\"TokenVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r   <xs:complexType name=\"ArrayOfTokenClaim\">\r     <xs:sequence>\r       <xs:element minOccurs=\"0\" maxOccurs=\"unbounded\" name=\"TokenClaim\" nillable=\"true\" type=\"tns:TokenClaim\" />\r     </xs:sequence>\r   </xs:complexType>\r   <xs:element name=\"ArrayOfTokenClaim\" nillable=\"true\" type=\"tns:ArrayOfTokenClaim\" />\r   <xs:complexType name=\"SymmetricVerificationKey\">\r     <xs:complexContent mixed=\"false\">\r       <xs:extension base=\"tns:TokenVerificationKey\">\r         <xs:sequence>\r           <xs:element name=\"KeyValue\" nillable=\"true\" type=\"xs:base64Binary\" />\r         </xs:sequence>\r       </xs:extension>\r     </xs:complexContent>\r   </xs:complexType>\r   <xs:element name=\"SymmetricVerificationKey\" nillable=\"true\" type=\"tns:SymmetricVerificationKey\" />\r </xs:schema>\r ```\r \r 配置令牌限制策略时，必须指定主验证密钥、颁发者和受众参数。 主验证密钥包含用于为令牌签名的密钥，颁发者是颁发令牌的安全令牌服务。 受众（有时称为范围）描述该令牌的意图，或者令牌授权访问的资源。 媒体服务密钥传送服务验证令牌中的这些值是否与模板中的值匹配。 \r \r 以下示例创建包含令牌限制的授权策略。 在此示例中，客户端必须出示令牌，其中包含：签名密钥 (VerificationKey)、令牌颁发者和必需的声明。\r \r ### <a name=\"create-contentkeyauthorizationpolicies\"></a>创建 ContentKeyAuthorizationPolicies\r 根据 [此处](#ContentKeyAuthorizationPolicies)所示创建“令牌限制策略”。\r \r ### <a name=\"create-contentkeyauthorizationpolicyoptions\"></a>创建 ContentKeyAuthorizationPolicyOptions\r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 3.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=bbbef702-e769-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423580720&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=5LsNu%2b0D4eD3UOP3BviTLDkUjaErdUx0ekJ8402xidQ%3d\r x-ms-version: 2.11\r x-ms-client-request-id: 2643d836-bfe7-438e-9ba2-bc6ff28e4a53\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 1079\r \r {\"Name\":\"Token option for HLS\",\"KeyDeliveryType\":2,\"KeyDeliveryConfiguration\":null,\"Restrictions\":[{\"Name\":\"Token Authorization Policy\",\"KeyRestrictionType\":1,\"Requirements\":\"<TokenRestrictionTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\\\"><AlternateVerificationKeys><TokenVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>BklyAFiPTQsuJNKriQJBZHYaKM2CkCTDQX2bw9sMYuvEC9sjW0W7GUIBygQL/+POEeUqCYPnmEU2g0o1GW2Oqg==</KeyValue></TokenVerificationKey></AlternateVerificationKeys><Audience>urn:test</Audience><Issuer>http://testacs.com/</Issuer><PrimaryVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>E5BUHiN4vBdzUzdP0IWaHFMMU3D1uRZgF16TOhSfwwHGSw+Kbf0XqsHzEIYk11M372viB9vbiacsdcQksA0ftw==</KeyValue></PrimaryVerificationKey><RequiredClaims><TokenClaim><ClaimType>urn:microsoft:azure:mediaservices:contentkeyidentifier</ClaimType><ClaimValue i:nil=\\\"true\\\" /></TokenClaim></RequiredClaims><TokenType>SWT</TokenType></TokenRestrictionTemplate>\"}]}\r ```\r \r 响应：   \r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 1260\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions('nb%3Ackpoid%3AUUID%3Ae1ef6145-46e8-4ee6-9756-b1cf96328c23')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: 2643d836-bfe7-438e-9ba2-bc6ff28e4a53\r request-id: 2310b716-aeaa-421e-913e-3ce2f6f685ca\r x-ms-request-id: 2310b716-aeaa-421e-913e-3ce2f6f685ca\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 09:10:37 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicyOptions/@Element\",\"Id\":\"nb:ckpoid:UUID:e1ef6145-46e8-4ee6-9756-b1cf96328c23\",\"Name\":\"Token option for HLS\",\"KeyDeliveryType\":2,\"KeyDeliveryConfiguration\":null,\"Restrictions\":[{\"Name\":\"Token Authorization Policy\",\"KeyRestrictionType\":1,\"Requirements\":\"<TokenRestrictionTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\\\"><AlternateVerificationKeys><TokenVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>BklyAFiPTQsuJNKriQJBZHYaKM2CkCTDQX2bw9sMYuvEC9sjW0W7GUIBygQL/+POEeUqCYPnmEU2g0o1GW2Oqg==</KeyValue></TokenVerificationKey></AlternateVerificationKeys><Audience>urn:test</Audience><Issuer>http://testacs.com/</Issuer><PrimaryVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>E5BUHiN4vBdzUzdP0IWaHFMMU3D1uRZgF16TOhSfwwHGSw+Kbf0XqsHzEIYk11M372viB9vbiacsdcQksA0ftw==</KeyValue></PrimaryVerificationKey><RequiredClaims><TokenClaim><ClaimType>urn:microsoft:azure:mediaservices:contentkeyidentifier</ClaimType><ClaimValue i:nil=\\\"true\\\" /></TokenClaim></RequiredClaims><TokenType>SWT</TokenType></TokenRestrictionTemplate>\"}]}\r ```\r \r #### <a name=\"link-contentkeyauthorizationpolicies-with-options\"></a>将 ContentKeyAuthorizationPolicies 与 Options 相链接\r 根据[此处](#ContentKeyAuthorizationPolicies)所示将 ContentKeyAuthorizationPolicies 与 Options 相链接。\r \r #### <a name=\"add-authorization-policy-to-the-content-key\"></a>将授权策略添加到内容密钥\r 根据[此处](#AddAuthorizationPolicyToKey)所示将 AuthorizationPolicy 添加到 ContentKey。\r \r ## <a name=\"playready-dynamic-encryption\"></a>PlayReady 动态加密\r 媒体服务允许配置相应的权限和限制，以便在用户尝试播放受保护的内容时，PlayReady DRM 运行时会强制实施这些权限和限制。 \r \r 使用 PlayReady 保护内容时，需要在授权策略中指定的项目之一是用于定义 [PlayReady 许可证模板](media-services-playready-license-template-overview.md)的 XML 字符串。 \r \r ### <a name=\"open-restriction\"></a>开放限制\r 开放限制意味着系统会将密钥传送到发出密钥请求的任何用户。 此限制可能适用于测试用途。\r \r 以下示例创建开放授权策略，并将其添加到内容密钥。\r \r #### <a id=\"ContentKeyAuthorizationPolicies2\"></a>创建 ContentKeyAuthorizationPolicies\r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicies HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=bbef702-2233-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423581565&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=JiNSG3w6r2C0nIyfKvTZj1uPJGjuitD%2b0sbfZ%2b2JDZI%3d\r x-ms-version: 2.11\r x-ms-client-request-id: 9e7fa407-f84e-43aa-8f05-9790b46e279b\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 58\r \r {\"Name\":\"Deliver Common Content Key\"}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 233\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicies('nb%3Ackpid%3AUUID%3Acc3c64a8-e2fc-4e09-bf60-ac954251a387')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: 9e7fa407-f84e-43aa-8f05-9790b46e279b\r request-id: b3d33c1b-a9cb-4120-ac0c-18f64846c147\r x-ms-request-id: b3d33c1b-a9cb-4120-ac0c-18f64846c147\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 09:26:00 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicies/@Element\",\"Id\":\"nb:ckpid:UUID:cc3c64a8-e2fc-4e09-bf60-ac954251a387\",\"Name\":\"Deliver Common Content Key\"}\r ```\r \r #### <a name=\"create-contentkeyauthorizationpolicyoptions\"></a>创建 ContentKeyAuthorizationPolicyOptions\r \r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 3.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=zbbef702-2233-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423581565&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=JiNSG3w6r2C0nIyfKvTZj1uPJGjuitD%2b0sbfZ%2b2JDZI%3d\r x-ms-version: 2.11\r x-ms-client-request-id: f160ad25-b457-4bc6-8197-315604c5e585\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 593\r \r {\"Name\":\"\",\"KeyDeliveryType\":1,\"KeyDeliveryConfiguration\":\"<PlayReadyLicenseResponseTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/PlayReadyTemplate/v1\\\"><LicenseTemplates><PlayReadyLicenseTemplate><AllowTestDevices>false</AllowTestDevices><ContentKey i:type=\\\"ContentEncryptionKeyFromHeader\\\" /><LicenseType>Nonpersistent</LicenseType><PlayRight /></PlayReadyLicenseTemplate></LicenseTemplates></PlayReadyLicenseResponseTemplate>\",\"Restrictions\":[{\"Name\":\"Open\",\"KeyRestrictionType\":0,\"Requirements\":null}]}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 774\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions('nb%3Ackpoid%3AUUID%3A1052308c-4df7-4fdb-8d21-4d2141fc2be0')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: f160ad25-b457-4bc6-8197-315604c5e585\r request-id: 563f5a42-50a4-4c4a-add8-a833f8364231\r x-ms-request-id: 563f5a42-50a4-4c4a-add8-a833f8364231\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 09:23:24 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicyOptions/@Element\",\"Id\":\"nb:ckpoid:UUID:1052308c-4df7-4fdb-8d21-4d2141fc2be0\",\"Name\":\"\",\"KeyDeliveryType\":1,\"KeyDeliveryConfiguration\":\"<PlayReadyLicenseResponseTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/PlayReadyTemplate/v1\\\"><LicenseTemplates><PlayReadyLicenseTemplate><AllowTestDevices>false</AllowTestDevices><ContentKey i:type=\\\"ContentEncryptionKeyFromHeader\\\" /><LicenseType>Nonpersistent</LicenseType><PlayRight /></PlayReadyLicenseTemplate></LicenseTemplates></PlayReadyLicenseResponseTemplate>\",\"Restrictions\":[{\"Name\":\"Open\",\"KeyRestrictionType\":0,\"Requirements\":null}]}\r ```\r \r #### <a name=\"link-contentkeyauthorizationpolicies-with-options\"></a>将 ContentKeyAuthorizationPolicies 与 Options 相链接\r 根据[此处](#ContentKeyAuthorizationPolicies)所示将 ContentKeyAuthorizationPolicies 与 Options 相链接。\r \r #### <a name=\"add-authorization-policy-to-the-content-key\"></a>将授权策略添加到内容密钥\r 根据[此处](#AddAuthorizationPolicyToKey)所示将 AuthorizationPolicy 添加到 ContentKey。\r \r ### <a name=\"token-restriction\"></a>令牌限制\r 要配置令牌限制选项，需要使用 XML 描述令牌的授权要求。 令牌限制配置 XML 必须符合 [此](#schema) 部分中所示的 XML 架构。\r \r #### <a name=\"create-contentkeyauthorizationpolicies\"></a>创建 ContentKeyAuthorizationPolicies\r 根据 [此处](#ContentKeyAuthorizationPolicies2)所示创建 ContentKeyAuthorizationPolicies。\r \r #### <a name=\"create-contentkeyauthorizationpolicyoptions\"></a>创建 ContentKeyAuthorizationPolicyOptions\r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 3.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=juliakoams1&urn%3aSubscriptionId=zbbef702-2233-477b-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1423583561&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=5eZnkOsSv%2fLLEKmS%2bWObBlsNYyee8BQlp%2bUYbjugcJg%3d\r x-ms-version: 2.11\r x-ms-client-request-id: ab079b0e-2ba9-4cf1-b549-a97bfa6cd2d3\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 1525\r \r {\"Name\":\"Token option\",\"KeyDeliveryType\":1,\"KeyDeliveryConfiguration\":\"<PlayReadyLicenseResponseTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/PlayReadyTemplate/v1\\\"><LicenseTemplates><PlayReadyLicenseTemplate><AllowTestDevices>false</AllowTestDevices><ContentKey i:type=\\\"ContentEncryptionKeyFromHeader\\\" /><LicenseType>Nonpersistent</LicenseType><PlayRight /></PlayReadyLicenseTemplate></LicenseTemplates></PlayReadyLicenseResponseTemplate>\",\"Restrictions\":[{\"Name\":\"Token Authorization Policy\",\"KeyRestrictionType\":1,\"Requirements\":\"<TokenRestrictionTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\\\"><AlternateVerificationKeys><TokenVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>w52OyHVqXT8aaupGxuJ3NGt8M6opHDOtx132p4r6q4hLI6ffnLusgEGie1kedUewVoIe1tqDkVE6xsIV7O91KA==</KeyValue></TokenVerificationKey></AlternateVerificationKeys><Audience>urn:test</Audience><Issuer>http://testacs.com/</Issuer><PrimaryVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>dYwLKIEMBljLeY9VM7vWdlhps31Fbt0XXhqP5VyjQa33bJXleBtkzQ6dF5AtwI9gDcdM2dV2TvYNhCilBKjMCg==</KeyValue></PrimaryVerificationKey><RequiredClaims><TokenClaim><ClaimType>urn:microsoft:azure:mediaservices:contentkeyidentifier</ClaimType><ClaimValue i:nil=\\\"true\\\" /></TokenClaim></RequiredClaims><TokenType>SWT</TokenType></TokenRestrictionTemplate>\"}]}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 1706\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/ContentKeyAuthorizationPolicyOptions('nb%3Ackpoid%3AUUID%3Ae42bbeae-de42-4077-90e9-a844f297ef70')\r Server: Microsoft-IIS/8.5\r x-ms-client-request-id: ab079b0e-2ba9-4cf1-b549-a97bfa6cd2d3\r request-id: ccf8a4ba-731e-4124-8192-079592c251cc\r x-ms-request-id: ccf8a4ba-731e-4124-8192-079592c251cc\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Tue, 10 Feb 2015 09:58:47 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#ContentKeyAuthorizationPolicyOptions/@Element\",\"Id\":\"nb:ckpoid:UUID:e42bbeae-de42-4077-90e9-a844f297ef70\",\"Name\":\"Token option\",\"KeyDeliveryType\":1,\"KeyDeliveryConfiguration\":\"<PlayReadyLicenseResponseTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/PlayReadyTemplate/v1\\\"><LicenseTemplates><PlayReadyLicenseTemplate><AllowTestDevices>false</AllowTestDevices><ContentKey i:type=\\\"ContentEncryptionKeyFromHeader\\\" /><LicenseType>Nonpersistent</LicenseType><PlayRight /></PlayReadyLicenseTemplate></LicenseTemplates></PlayReadyLicenseResponseTemplate>\",\"Restrictions\":[{\"Name\":\"Token Authorization Policy\",\"KeyRestrictionType\":1,\"Requirements\":\"<TokenRestrictionTemplate xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\\\"><AlternateVerificationKeys><TokenVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>w52OyHVqXT8aaupGxuJ3NGt8M6opHDOtx132p4r6q4hLI6ffnLusgEGie1kedUewVoIe1tqDkVE6xsIV7O91KA==</KeyValue></TokenVerificationKey></AlternateVerificationKeys><Audience>urn:test</Audience><Issuer>http://testacs.com/</Issuer><PrimaryVerificationKey i:type=\\\"SymmetricVerificationKey\\\"><KeyValue>dYwLKIEMBljLeY9VM7vWdlhps31Fbt0XXhqP5VyjQa33bJXleBtkzQ6dF5AtwI9gDcdM2dV2TvYNhCilBKjMCg==</KeyValue></PrimaryVerificationKey><RequiredClaims><TokenClaim><ClaimType>urn:microsoft:azure:mediaservices:contentkeyidentifier</ClaimType><ClaimValue i:nil=\\\"true\\\" /></TokenClaim></RequiredClaims><TokenType>SWT</TokenType></TokenRestrictionTemplate>\"}]}\r ```\r \r #### <a name=\"link-contentkeyauthorizationpolicies-with-options\"></a>将 ContentKeyAuthorizationPolicies 与 Options 相链接\r 根据[此处](#ContentKeyAuthorizationPolicies)所示将 ContentKeyAuthorizationPolicies 与 Options 相链接。\r \r #### <a name=\"add-authorization-policy-to-the-content-key\"></a>将授权策略添加到内容密钥\r 根据[此处](#AddAuthorizationPolicyToKey)所示将 AuthorizationPolicy 添加到 ContentKey。\r \r ## <a id=\"types\"></a>定义 ContentKeyAuthorizationPolicy 时使用的类型\r ### <a id=\"ContentKeyRestrictionType\"></a>ContentKeyRestrictionType\r \r ```\r public enum ContentKeyRestrictionType\r {\r     Open = 0,\r     TokenRestricted = 1,\r     IPRestricted = 2, // IP restriction on content key is not currently supported, reserved for future.\r }\r ```\r \r > [!NOTE]\r > 内容密钥授权策略上的 IP 限制在服务中尚不可用。\r \r \r ### <a id=\"ContentKeyDeliveryType\"></a>ContentKeyDeliveryType\r     public enum ContentKeyDeliveryType\r     {\r         None = 0,\r         PlayReadyLicense = 1,\r         BaselineHttp = 2,\r         Widevine = 3\r     }\r \r \r ## <a name=\"next-steps\"></a>后续步骤\r 现在已配置内容密钥的授权策略，请转到[如何配置资产传送策略](media-services-rest-configure-asset-delivery-policy.md)主题。\r \r "}