{"Title":"删除服务器并禁用保护","Description":"本文介绍如何从 Site Recovery 保管库中注销服务器，以及如何禁用虚拟机和物理服务器的保护。","Content":"# <a name=\"remove-servers-and-disable-protection\"></a>删除服务器并禁用保护\r 本文介绍了如何从恢复服务保管库中取消注册服务器，以及如何禁用对计算机的 Site Recovery 保护。\r \r ## <a name=\"unregister-a--configuration-server\"></a>取消注册配置服务器\r \r 如果将 VMware VM 或 Windows/Linux 物理服务器复制到 Azure，可按如下所述从保管库中取消注册未连接的配置服务器：\r \r 1. [禁用对虚拟机的保护](#disable-protection-for-a-vmware-vm-or-physical-server-vmware-to-azure)。\r 2. [取消关联](site-recovery-setup-replication-settings-vmware.md#dissociate-a-configuration-server-from-a-replication-policy)并[删除](site-recovery-setup-replication-settings-vmware.md#delete-a-replication-policy)所有复制策略\r 3. [删除配置服务器](site-recovery-vmware-to-azure-manage-configuration-server.md#delete-or-unregister-a-configuration-server)\r \r ## <a name=\"unregister-a-vmm-server\"></a>取消注册 VMM 服务器\r \r 1. 停止在要删除的 VMM 服务器上复制云中的虚拟机。\r 2. 删除由需要删除的 VMM 服务器上的云使用的任何网络映射。 在“Site Recovery 基础结构” > “对于 System Center VMM” > “网络映射”中，右键单击网络映射 >“删除”。\r 3. 记下 VMM 服务器的 ID。\r 4. 取消复制策略与要删除的 VMM 服务器上的云的关联。  在“Site Recovery 基础结构” > “对于 System Center VMM” >  “复制策略”中，右键单击关联的策略。 右键单击云 >“取消关联”。\r 5. 删除 VMM 服务器或主动节点。 在“Site Recovery 基础结构” > “对于 System Center VMM” > “VMM 服务器”中，右键单击服务器 >“删除”。\r 6. 如果 VMM 服务器处于“已断开连接”状态，请对 VMM 服务器下载并运行[清理脚本](http://aka.ms/asr-cleanup-script-vmm)。 使用“以管理员身份运行”选项打开 PowerShell，以更改默认 (LocalMachine) 范围的执行策略。 在脚本中，指定要删除的 VMM 服务器的 ID。 脚本会从服务器中删除注册和云配对信息。\r 7. 在所有辅助 VMM 服务器上，运行清理脚本。\r 8. 在任何其他被动 VMM 群集节点（已安装提供程序）上运行清理脚本。\r 9. 手动卸载 VMM 服务器上的提供程序。 如果有一个群集，请从所有节点删除。\r 10. 若要将虚拟机复制到 Azure，需要在已删除的云中从 Hyper-V 主机中卸载 Microsoft 恢复服务代理。\r \r ## <a name=\"unregister-a-hyper-v-host-in-a-hyper-v-site\"></a>取消注册 Hyper-V 站点中的 Hyper-V 主机\r \r 未由 VMM 托管的 Hyper-V 主机将收集到 Hyper-V 站点中。 在 Hyper-V 站点中删除主机，如下所示：\r \r 1. 禁用位于主机上的 Hyper-V VM 的复制。\r 2. 取消关联 Hyper-V 站点的策略。 在“Site Recovery 基础结构” > “对于 Hyper-V 站点” >  “复制策略”中，右键单击关联的策略。 右键单击站点 >“取消关联”。\r 3. 删除 Hyper-V 主机。 依次转到“Site Recovery 基础结构” > “对于 Hyper-V 站点” > “Hyper-V 主机”，右键单击服务器，再单击“删除”。\r 4. 从 Hyper-V 站点中删除所有主机后，将该站点删除。 依次转到“Site Recovery 基础结构” > “对于 Hyper-V 站点” > “Hyper-V 站点”，右键单击站点，再单击“删除”。\r 5. 如果 Hyper-V 主机处于“已断开连接”状态，请对已删除的每个 Hyper-V 主机运行以下脚本。 该脚本清理服务器上的设置，并从保管库中取消注册该服务器。\r \r         pushd .\r         try\r         {\r              $windowsIdentity=[System.Security.Principal.WindowsIdentity]::GetCurrent()\r              $principal=new-object System.Security.Principal.WindowsPrincipal($windowsIdentity)\r              $administrators=[System.Security.Principal.WindowsBuiltInRole]::Administrator\r              $isAdmin=$principal.IsInRole($administrators)\r              if (!$isAdmin)\r              {\r                 \"Please run the script as an administrator in elevated mode.\"\r                 $choice = Read-Host\r                 return;       \r              }\r \r             $error.Clear()    \r             \"This script will remove the old Azure Site Recovery Provider related properties. Do you want to continue (Y/N) ?\"\r             $choice =  Read-Host\r \r             if (!($choice -eq 'Y' -or $choice -eq 'y'))\r             {\r             \"Stopping cleanup.\"\r             return;\r             }\r \r             $serviceName = \"dra\"\r             $service = Get-Service -Name $serviceName\r             if ($service.Status -eq \"Running\")\r             {\r                 \"Stopping the Azure Site Recovery service...\"\r                 net stop $serviceName\r             }\r \r             $asrHivePath = \"HKLM:\\SOFTWARE\\Microsoft\\Azure Site Recovery\"\r             $registrationPath = $asrHivePath + '\\Registration'\r             $proxySettingsPath = $asrHivePath + '\\ProxySettings'\r             $draIdvalue = 'DraID'\r \r             if (Test-Path $asrHivePath)\r             {\r                 if (Test-Path $registrationPath)\r                 {\r                     \"Removing registration related registry keys.\"    \r                     Remove-Item -Recurse -Path $registrationPath\r                 }\r \r                 if (Test-Path $proxySettingsPath)\r             {\r                     \"Removing proxy settings\"\r                     Remove-Item -Recurse -Path $proxySettingsPath\r                 }\r \r                 $regNode = Get-ItemProperty -Path $asrHivePath\r                 if($regNode.DraID -ne $null)\r                 {            \r                     \"Removing DraId\"\r                     Remove-ItemProperty -Path $asrHivePath -Name $draIdValue\r                 }\r                 \"Registry keys removed.\"\r             }\r \r             # First retrive all the certificates to be deleted\r             $ASRcerts = Get-ChildItem -Path cert:\\localmachine\\my | where-object {$_.friendlyname.startswith('ASR_SRSAUTH_CERT_KEY_CONTAINER') -or $_.friendlyname.startswith('ASR_HYPER_V_HOST_CERT_KEY_CONTAINER')}\r             # Open a cert store object\r             $store = New-Object System.Security.Cryptography.X509Certificates.X509Store(\"My\",\"LocalMachine\")\r             $store.Open('ReadWrite')\r             # Delete the certs\r             \"Removing all related certificates\"\r             foreach ($cert in $ASRcerts)\r             {\r                 $store.Remove($cert)\r             }\r         }catch\r         {    \r             [system.exception]\r             Write-Host \"Error occured\" -ForegroundColor \"Red\"\r             $error[0]\r             Write-Host \"FAILED\" -ForegroundColor \"Red\"\r         }\r         popd\r \r ## <a name=\"disable-protection-for-a-vmware-vm-or-physical-server-vmware-to-azure\"></a>禁用对 VMware VM 或物理服务器（VMware 到 Azure）的保护\r \r 1. 依次转到“受保护的项” > “复制的项”，右键单击计算机，再单击“禁用复制”。\r 2. 在“禁用复制”页中，选择下列选项之一：\r     - **禁用复制并删除(推荐)** - 此选项从 Azure Site Recovery 中删除复制的项，并停止复制计算机。 此外，还将清理配置服务器上的复制配置，并停止对这个受保护的服务器收取 Site Recovery 费用。\r     - **删除** - 只有在源环境已删除或无法访问（未连接）时，才应使用此选项。 此选项会从 Azure Site Recovery 中删除复制的项（停止计费）。 不过，并不会清理配置服务器上的复制配置。 \r \r > [!NOTE]\r > 这两个选项都不会从受保护的服务器中卸载移动服务，需要手动卸载。 如果打算使用相同的配置服务器重新保护服务器，可以跳过卸载移动服务这一步。\r \r ## <a name=\"disable-protection-for-a-hyper-v-virtual-machine-hyper-v-to-azure\"></a>禁用对 Hyper-V 虚拟机（Hyper-V 到 Azure）的保护\r \r > [!NOTE]\r > 要在没有 VMM 服务器的情况下将 Hyper-V VM 复制到 Azure，请执行此过程。 若要使用 System Center VMM 到 Azure 方案复制虚拟机，请按照[禁用对使用 System Center VMM 到 Azure 方案复制的 Hyper-V 虚拟机的保护](#disable-protection-for-a-hyper-v-virtual-machine-replicating-using-the-system-centet-vmm-to-azure-scenario)中的说明操作\r \r 1. 依次转到“受保护的项” > “复制的项”，右键单击计算机，再单击“禁用复制”。\r 2. 在“禁用复制”中，可以选择下列选项：\r     - **禁用复制并删除(推荐)** - 此选项从 Azure Site Recovery 中删除复制的项，并停止复制计算机。 此外，还将清理本地虚拟机上的复制配置，并停止对这个受保护的服务器收取 Site Recovery 费用。\r     - **删除** - 只有在源环境已删除或无法访问（未连接）时，才应使用此选项。 此选项会从 Azure Site Recovery 中删除复制的项（停止计费）。 不过，并不会清理本地虚拟机上的复制配置。 \r \r     > [!NOTE]\r     > 如果选择“删除”选项，请运行下面的一组脚本，清理本地 Hyper-V 服务器上的复制设置。\r 3. 在源 Hyper-V 主机服务器上，取消复制虚拟机。 将 SQLVM1 替换为虚拟机名称，并通过管理 PowerShell 运行以下脚本\r \r         $vmName = \"SQLVM1\"\r         $vm = Get-WmiObject -Namespace \"root\\virtualization\\v2\" -Query \"Select * From Msvm_ComputerSystem Where ElementName = '$vmName'\"\r         $replicationService = Get-WmiObject -Namespace \"root\\virtualization\\v2\"  -Query \"Select * From Msvm_ReplicationService\"\r         $replicationService.RemoveReplicationRelationship($vm.__PATH)\r \r ## <a name=\"disable-protection-for-a-hyper-v-virtual-machine-replicating-to-azure-using-the-system-center-vmm-to-azure-scenario\"></a>禁用对使用 System Center VMM 到 Azure 方案复制到 Azure 的 Hyper-V 虚拟机的保护\r \r 1. 依次转到“受保护的项” > “复制的项”，右键单击计算机，再单击“禁用复制”。\r 2. 在“禁用复制”中，选择下列选项之一：\r \r     - **禁用复制并删除(推荐)** - 此选项从 Azure Site Recovery 中删除复制的项，并停止复制计算机。 此外，还将清理本地虚拟机上的复制配置，并停止对这个受保护的服务器收取 Site Recovery 费用。\r     - **删除** - 只有在源环境已删除或无法访问（未连接）时，才应使用此选项。 此选项会从 Azure Site Recovery 中删除复制的项（停止计费）。 不过，并不会清理本地虚拟机上的复制配置。 \r \r     > [!NOTE]\r     > 如果选择“删除”选项，请运行下面的脚本，清理本地 VMM 服务器上的复制设置。\r 3. 在 VMM 控制台中使用 PowerShell（需要 管理员权限），在源 VMM 服务器上运行此脚本。 将占位符 SQLVM1 替换为虚拟机名称。\r \r         $vm = get-scvirtualmachine -Name \"SQLVM1\"\r         Set-SCVirtualMachine -VM $vm -ClearDRProtection\r 4. 上述步骤清理 VMM 服务器上的复制设置。 若要停止运行在 Hyper-V 主机服务器上的虚拟机的复制，请运行以下脚本。 将 SQLVM1 替换为你的虚拟机的名称，将 host01.contoso.com 替换为 Hyper-V 主机服务器的名称。\r \r         $vmName = \"SQLVM1\"\r         $hostName  = \"host01.contoso.com\"\r         $vm = Get-WmiObject -Namespace \"root\\virtualization\\v2\" -Query \"Select * From Msvm_ComputerSystem Where ElementName = '$vmName'\" -computername $hostName\r         $replicationService = Get-WmiObject -Namespace \"root\\virtualization\\v2\"  -Query \"Select * From Msvm_ReplicationService\"  -computername $hostName\r         $replicationService.RemoveReplicationRelationship($vm.__PATH)\r \r ## <a name=\"disable-protection-for-a-hyper-v-virtual-machine-replicating-to-secondary-vmm-server-using-the-system-center-vmm-to-vmm-scenario\"></a>禁用对使用 System Center VMM 到 VMM 方案复制到辅助 VMM 服务器的 Hyper-V 虚拟机的保护\r \r 1. 依次转到“受保护的项” > “复制的项”，右键单击计算机，再单击“禁用复制”。\r 2. 在“禁用复制”中，选择下列选项之一：\r \r     - **禁用复制并删除(推荐)** - 此选项从 Azure Site Recovery 中删除复制的项，并停止复制计算机。 此外，还将清理本地虚拟机上的复制配置，并停止对这个受保护的服务器收取 Site Recovery 费用。\r     - **删除** - 只有在源环境已删除或无法访问（未连接）时，才应使用此选项。 此选项会从 Azure Site Recovery 中删除复制的项（停止计费）。 不过，并不会清理本地虚拟机上的复制配置。 运行下面的一组脚本，清理本地虚拟机上的复制设置。\r > [!NOTE]\r > 如果选择“删除”选项，请运行下面的脚本，清理本地 VMM 服务器上的复制设置。\r \r 3. 在 VMM 控制台中使用 PowerShell（需要 管理员权限），在源 VMM 服务器上运行此脚本。 将占位符 SQLVM1 替换为虚拟机名称。\r \r         $vm = get-scvirtualmachine -Name \"SQLVM1\"\r         Set-SCVirtualMachine -VM $vm -ClearDRProtection\r 4. 在辅助 VMM 服务器上，运行下面的脚本，清理辅助虚拟机的设置：\r \r         $vm = get-scvirtualmachine -Name \"SQLVM1\"\r         Remove-SCVirtualMachine -VM $vm -Force\r 5. 在辅助 VMM 服务器上刷新 Hyper-V 主机服务器上的虚拟机，以便在 VMM 控制台中重新检测辅助 VM。\r 6. 上述步骤清理 VMM 服务器上的复制设置。 若要停止虚拟机的复制，请在主 VM 和辅助 VM 上运行以下脚本。 将 SQLVM1 替换为相应虚拟机名称。\r \r         Remove-VMReplication -VMName \"SQLVM1\"\r \r <!-- Update_Description: update meta properties, wording update -->"}