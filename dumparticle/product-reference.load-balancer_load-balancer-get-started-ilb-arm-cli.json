{"Title":"创建内部负载均衡器 - Azure CLI","Description":"了解如何在 Resource Manager 中使用 Azure CLI 创建内部负载均衡器","Content":"# <a name=\"create-an-internal-load-balancer-by-using-the-azure-cli\"></a>使用 Azure CLI 创建内部负载均衡器\r \r > [!div class=\"op_single_selector\"]\r > * [Azure 门户](../load-balancer/load-balancer-get-started-ilb-arm-portal.md)\r > * [PowerShell](../load-balancer/load-balancer-get-started-ilb-arm-ps.md)\r > * [Azure CLI](../load-balancer/load-balancer-get-started-ilb-arm-cli.md)\r > * [模板](../load-balancer/load-balancer-get-started-ilb-arm-template.md)\r \r [!INCLUDE [load-balancer-basic-sku-include.md](../../includes/load-balancer-basic-sku-include.md)]\r \r [!INCLUDE [load-balancer-get-started-ilb-intro-include.md](../../includes/load-balancer-get-started-ilb-intro-include.md)]\r \r > [!NOTE]\r > Azure 具有用于创建和处理资源的两个不同的部署模型：[Resource Manager 和经典](../azure-resource-manager/resource-manager-deployment-model.md)。  本文介绍如何使用 Resource Manager 部署模型。Azure 建议对大多数新的部署使用该模型，而不是使用[经典部署模型](load-balancer-get-started-ilb-classic-cli.md)。\r \r [!INCLUDE [load-balancer-get-started-ilb-scenario-include.md](../../includes/load-balancer-get-started-ilb-scenario-include.md)]\r \r ## <a name=\"deploy-the-solution-by-using-the-azure-cli\"></a>使用 Azure CLI 部署解决方案\r \r 以下步骤说明如何使用 Azure Resource Manager 和 CLI 创建面向 Internet 的负载均衡器。 借助 Azure Resource Manager，可单独创建和配置每个资源，再将其合成一个新资源。\r \r 需要创建和配置以下对象以部署负载均衡器：\r \r * **前端 IP 配置**：包含传入网络流量的公共 IP 地址\r * **后端地址池**：包含使虚拟机可以从负载均衡器接收网络流量的网络接口 (NIC)\r * **负载均衡规则**：所含规则可将负载均衡器上的公共端口映射到后端地址池的端口上\r * **入站 NAT 规则**：所含规则可将负载均衡器上的公共端口映射到后端地址池中特定虚拟机的端口\r * **探测器**：包含用于检查后端地址池中虚拟机实例的可用性的运行状况探测器\r \r 有关详细信息，请参阅 [Azure Resource Manager 对负载均衡器的支持](load-balancer-arm.md)。\r \r ## <a name=\"set-up-cli-to-use-resource-manager\"></a>将 CLI 设置为使用 Resource Manager\r \r 1. 如果从未使用过 Azure CLI，请参阅[安装和配置 Azure CLI](../cli-install-nodejs.md)。 按照说明执行，直到选择 Azure 帐户和订阅。\r 2. 运行 **azure config mode** 命令以切换到 Resource Manager 模式，如下所示：\r \r     ```azurecli\r     azure config mode arm\r     ```\r \r     预期输出：\r     \r     ```\r     info:    New mode is arm\r     ```\r \r ## <a name=\"create-an-internal-load-balancer-step-by-step\"></a>逐步创建内部负载均衡器集\r \r 1. 登录 Azure。\r \r     ```azurecli\r     azure login -e AzureChinaCloud\r     ```\r \r     在系统提示时输入 Azure 凭据。\r \r 2. 将命令工具更改为 Azure Resource Manager 模式。\r \r     ```azurecli\r     azure config mode arm\r     ```\r \r ## <a name=\"create-a-resource-group\"></a>创建资源组\r \r Azure Resource Manager 中的所有资源将与资源组关联。 创建资源组（如果尚未这样做）。\r \r ```azurecli\r azure group create <resource group name> <location>\r ```\r \r ## <a name=\"create-an-internal-load-balancer-set\"></a>创建内部负载均衡器集\r \r 1. 创建内部负载均衡器\r \r     以下方案在中国东部区域创建了一个名为 nrprg 的资源组。\r \r     ```azurecli\r     azure network lb create --name nrprg --location chinaeast\r     ```\r \r    > [!NOTE]\r    > 内部负载均衡器的所有资源（如虚拟网络和虚拟网络子网）必须都在同一资源组中并在同一区域中。\r \r 2. 为内部负载均衡器创建前端 IP 地址。\r \r     所用的 IP 地址必须在虚拟网络的子网范围内。\r \r     ```azurecli\r     azure network lb frontend-ip create --resource-group nrprg --lb-name ilbset --name feilb --private-ip-address 10.0.0.7 --subnet-name nrpvnetsubnet --subnet-vnet-name nrpvnet\r     ```\r \r 3. 创建后端地址池。\r \r     ```azurecli\r     azure network lb address-pool create --resource-group nrprg --lb-name ilbset --name beilb\r     ```\r \r     定义前端 IP 地址和后端地址池后，可以创建负载均衡器规则、入站 NAT 规则和自定义运行状况探测器。\r \r 4. 为内部负载均衡器创建负载均衡器规则。\r \r     按照前面的步骤执行时，该命令会创建负载均衡器规则，以侦听前端池中的端口 1433，还使用端口 1433 将经过负载均衡的网络流量发送到后端地址池。\r \r     ```azurecli\r     azure network lb rule create --resource-group nrprg --lb-name ilbset --name ilbrule --protocol tcp --frontend-port 1433 --backend-port 1433 --frontend-ip-name feilb --backend-address-pool-name beilb\r     ```\r \r 5. 创建入站 NAT 规则。\r \r     入站 NAT 规则用于在负载均衡器中创建要转到特定虚拟机实例的终结点。 前面的步骤为远程桌面创建了两个 NAT 规则。\r \r     ```azurecli\r     azure network lb inbound-nat-rule create --resource-group nrprg --lb-name ilbset --name NATrule1 --protocol TCP --frontend-port 5432 --backend-port 3389\r \r     azure network lb inbound-nat-rule create --resource-group nrprg --lb-name ilbset --name NATrule2 --protocol TCP --frontend-port 5433 --backend-port 3389\r     ```\r \r 6. 为负载均衡器创建运行状况探测器。\r \r     运行状况探测器将检查所有虚拟机实例，以确保它们可以发送网络流量。 探测器检查失败的虚拟机实例将从负载均衡器中删除，直到它恢复联机状态并且探测器检查确定它运行正常。\r \r     ```azurecli\r     azure network lb probe create --resource-group nrprg --lb-name ilbset --name ilbprobe --protocol tcp --interval 300 --count 4\r     ```\r \r     > [!NOTE]\r     > Azure Platform 对各种管理方案使用一个公开可路由的静态 IPv4 地址。 该 IP 地址为 168.63.129.16。 此 IP 地址不应被任何防火墙阻止，因为这可能会导致意外行为。\r     > 对于 Azure 内部负载均衡，此 IP 地址用于监视负载均衡器中的探测器，以确定负载均衡集中虚拟机的运行状况状态。 如果网络安全组用于将流量限制到内部负载均衡集中的 Azure 虚拟机或应用于虚拟网络子网，请确保添加网络安全规则以允许来自 168.63.129.16 的流量。\r \r ## <a name=\"create-nics\"></a>创建 NIC\r \r 需要创建 NIC（或修改现有 NIC），并将其关联到 NAT 规则、负载均衡器规则和探测器。\r \r 1. 创建名为 *lb-nic1-be* 的 NIC，并将其与 *rdp1* NAT 规则和 *beilb* 后端地址池相关联。\r \r     ```azurecli\r     azure network nic create --resource-group nrprg --name lb-nic1-be --subnet-name nrpvnetsubnet --subnet-vnet-name nrpvnet --lb-address-pool-ids \"/subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/backendAddressPools/beilb\" --lb-inbound-nat-rule-ids \"/subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/inboundNatRules/rdp1\" --location chinaeast\r     ```\r \r     预期输出：\r \r     ```\r     info:    Executing command network nic create\r     + Looking up the network interface \"lb-nic1-be\"\r     + Looking up the subnet \"nrpvnetsubnet\"\r     + Creating network interface \"lb-nic1-be\"\r     + Looking up the network interface \"lb-nic1-be\"\r     data:    Id                              : /subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/networkInterfaces/lb-nic1-be\r     data:    Name                            : lb-nic1-be\r     data:    Type                            : Microsoft.Network/networkInterfaces\r     data:    Location                        : chinaeast\r     data:    Provisioning state              : Succeeded\r     data:    Enable IP forwarding            : false\r     data:    IP configurations:\r     data:      Name                          : NIC-config\r     data:      Provisioning state            : Succeeded\r     data:      Private IP address            : 10.0.0.4\r     data:      Private IP Allocation Method  : Dynamic\r     data:      Subnet                        : /subscriptions/####################################/resourceGroups/NRPRG/providers/Microsoft.Network/virtualNetworks/NRPVnet/subnets/NRPVnetSubnet\r     data:      Load balancer backend address pools\r     data:        Id                          : /subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/backendAddressPools/NRPbackendpool\r     data:      Load balancer inbound NAT rules:\r     data:        Id                          : /subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/inboundNatRules/rdp1\r     data:\r     info:    network nic create command OK\r     ```\r \r 2. 创建名为 *lb-nic2-be* 的 NIC，并将其与 *rdp2* NAT 规则和 *beilb* 后端地址池相关联。\r \r     ```azurecli\r     azure network nic create --resource-group nrprg --name lb-nic2-be --subnet-name nrpvnetsubnet --subnet-vnet-name nrpvnet --lb-address-pool-ids \"/subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/backendAddressPools/beilb\" --lb-inbound-nat-rule-ids \"/subscriptions/####################################/resourceGroups/nrprg/providers/Microsoft.Network/loadBalancers/nrplb/inboundNatRules/rdp2\" --location chinaeast\r     ```\r \r 3. 创建名为 *DB1* 的虚拟机，并将其与名为 *lb-nic1-be* 的 NIC 相关联。 会在以下命令运行之前创建名为 *web1nrp* 的存储帐户：\r \r     ```azurecli\r     azure vm create --resource--resource-grouproup nrprg --name DB1 --location chinaeast --vnet-name nrpvnet --vnet-subnet-name nrpvnetsubnet --nic-name lb-nic1-be --availset-name nrp-avset --storage-account-name web1nrp --os-type Windows --image-urn MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:4.0.20150825\r     ```\r \r     > [!IMPORTANT]\r     > 负载均衡器中的 VM 需要在同一可用性集中。 使用 `azure availset create` 创建可用性集。\r \r 4. 创建名为 *DB2* 的虚拟机 (VM)，并将其与名为 *lb-nic2-be* 的 NIC 相关联。 名为 *web1nrp* 的存储帐户在运行以下命令之前已创建。\r \r     ```azurecli\r     azure vm create --resource--resource-grouproup nrprg --name DB2 --location chinaeast --vnet-name nrpvnet --vnet-subnet-name nrpvnetsubnet --nic-name lb-nic2-be --availset-name nrp-avset --storage-account-name web2nrp --os-type Windows --image-urn MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:4.0.20150825\r     ```\r \r ## <a name=\"delete-a-load-balancer\"></a>删除负载均衡器\r \r 若要删除负载均衡器，请使用以下命令：\r \r ```azurecli\r azure network lb delete --resource-group nrprg --name ilbset\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r [使用源 IP 关联配置负载均衡器分发模式](load-balancer-distribution-mode.md)\r \r [配置负载均衡器的空闲 TCP 超时设置](load-balancer-tcp-idle-timeout.md)\r \r <!-- Update_Description: update meta properties, wording update -->"}