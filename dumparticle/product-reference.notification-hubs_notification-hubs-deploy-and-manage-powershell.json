{"Title":"使用 PowerShell 部署和管理通知中心","Description":"如何使用自动化 PowerShell 创建和管理通知中心","Content":"\r # 使用 PowerShell 部署和管理通知中心\r \r ##概述\r \r 本文说明如何使用 PowerShell 来创建和管理 Azure 通知中心。本主题将演示以下常见自动化任务。\r \r + 创建通知中心\r + 设置凭据\r \r 如果你还需要为通知中心创建新的服务总线命名空间，请参阅[使用 PowerShell 管理服务总线](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.servicebus/v0.0.2/azurerm.servicebus)。\r \r 不支持直接使用 Azure PowerShell 随附的 cmdlet 来管理通知中心。在 PowerShell 中，最佳方法是引用 Microsoft.Azure.NotificationHubs.dll 程序集。该程序集是随 [Azure 通知中心 NuGet 包](https://www.nuget.org/packages/Microsoft.Azure.NotificationHubs/)一起分发的。\r \r ## 先决条件\r \r 在开始阅读本文前，你必须具有：\r \r - Azure 订阅。Azure 是基于订阅的平台。有关获取订阅的详细信息，请参阅[试用]。\r \r - 配备 Azure PowerShell 的计算机。有关说明，请参阅[安装和配置 Azure PowerShell]。\r \r - 大致了解 PowerShell 脚本、NuGet 包和 .NET Framework。\r \r ## 包含对适用于服务总线的 .NET 程序集的引用\r \r Azure PowerShell 中的 PowerShell cmdlet 尚不支持管理 Azure 通知中心。若要预配通知中心，可以使用 [Azure 通知中心 NuGet 包](https://www.nuget.org/packages/Microsoft.Azure.NotificationHubs/)中提供的 .NET 客户端。\r \r 首先，请确保脚本可以找到 **Microsoft.Azure.NotificationHubs.dll** 程序集，该程序集在 Visual Studio 项目中以 NuGet 包的形式安装。为了灵活起见，该脚本执行以下步骤：\r \r 1. 确定调用它的路径。\r 2. 遍历路径直到找到名为 `packages` 的文件夹为止。此文件夹是在为 Visual Studio 项目安装 NuGet 包时创建的。\r 3. 以递归方式在 `packages` 文件夹中搜索名为 **Microsoft.Azure.NotificationHubs.dll** 的程序集。\r 4. 引用该程序集，以便类型可供以后使用。\r \r 下面说明如何在 PowerShell 脚本中实现这些步骤：\r \r ```powershell\r     try\r     {\r         # WARNING: Make sure to reference the latest version of Microsoft.Azure.NotificationHubs.dll\r         Write-Output \"Adding the [Microsoft.Azure.NotificationHubs.dll] assembly to the script...\"\r         $scriptPath = Split-Path (Get-Variable MyInvocation -Scope 0).Value.MyCommand.Path\r         $packagesFolder = (Split-Path $scriptPath -Parent) + \"\\packages\"\r         $assembly = Get-ChildItem $packagesFolder -Include \"Microsoft.Azure.NotificationHubs.dll\" -Recurse\r         Add-Type -Path $assembly.FullName\r \r         Write-Output \"The [Microsoft.Azure.NotificationHubs.dll] assembly has been successfully added to the script.\"\r     }\r \r     catch [System.Exception]\r     {\r         Write-Error(\"Could not add the Microsoft.Azure.NotificationHubs.dll assembly to the script. Make sure you build the solution before running the provisioning script.\")\r     }\r ```\r \r ## 创建 NamespaceManager 类\r \r 若要预配通知中心，请从 SDK 创建 [NamespaceManager](https://msdn.microsoft.com/zh-cn/library/azure/microsoft.azure.notificationhubs.namespacemanager.aspx) 类的实例。\r \r 可以使用 Azure PowerShell 随附的 [Get-AzureSBAuthorizationRule] cmdlet 来检索用于提供连接字符串的授权规则。我们将在 `$NamespaceManager` 变量中存储对 `NamespaceManager` 实例的引用。我们将使用 `$NamespaceManager` 设置通知中心。\r \r ```powershell\r $sbr = Get-AzureSBAuthorizationRule -Namespace $Namespace\r # Create the NamespaceManager object to create the hub\r Write-Output \"Creating a NamespaceManager object for the [$Namespace] namespace...\"\r $NamespaceManager=[Microsoft.Azure.NotificationHubs.NamespaceManager]::CreateFromConnectionString($sbr.ConnectionString);\r Write-Output \"NamespaceManager object for the [$Namespace] namespace has been successfully created.\"\r ```\r \r ## 设置新通知中心 \r \r 若要预配新的通知中心，请使用[通知中心的 .NET API]。\r \r 你将在脚本的这个部分设置四个本地变量。\r \r 1. `$Namespace`：将此变量设置为要创建通知中心的命名空间的名称。\r 2. `$Path`：将此路径设置为新通知中心的名称。例如“MyHub”。\r 3. `$WnsPackageSid`：从 [Windows 开发人员中心](http://go.microsoft.com/fwlink/p/?linkid=266582&clcid=0x409)将此变量设置为 Windows 应用的包 SID。\r 4. `$WnsSecretkey`：从 [Windows 开发人员中心](http://go.microsoft.com/fwlink/p/?linkid=266582&clcid=0x409)将此变量设置为 Windows 应用的机密密钥。\r \r 这些变量可用于连接命名空间，以及创建配置为使用 Windows 应用 Windows 通知中心 (WNS) 凭据处理 WNS 通知的新通知中心。有关获取包 SID 和机密密钥的信息，请参阅[通知中心入门](./notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md)教程。\r \r + 脚本代码段使用 `NamespaceManager` 对象来检查 `$Path` 标识的通知中心是否存在。\r \r + 如果不存在，脚本将使用 WNS 凭据创建 `NotificationHubDescription`，并将其传递给 `NamespaceManager` 类 `CreateNotificationHub` 方法。\r \r ```powershell\r $Namespace = \"<Enter your namespace>\"\r $Path  = \"<Enter a name for your notification hub>\"\r $WnsPackageSid = \"<your package sid>\"\r $WnsSecretkey = \"<enter your secret key>\"\r \r $WnsCredential = New-Object -TypeName Microsoft.Azure.NotificationHubs.WnsCredential -ArgumentList $WnsPackageSid,$WnsSecretkey\r \r # Query the namespace\r $CurrentNamespace = Get-AzureSBNamespace -Name $Namespace\r \r # Check if the namespace already exists\r if ($CurrentNamespace)\r {\r     Write-Output \"The namespace [$Namespace] in the [$($CurrentNamespace.Region)] region was found.\"\r \r     # Create the NamespaceManager object used to create a new notification hub\r     $sbr = Get-AzureSBAuthorizationRule -Namespace $Namespace\r     Write-Output \"Creating a NamespaceManager object for the [$Namespace] namespace...\"\r     $NamespaceManager = [Microsoft.Azure.NotificationHubs.NamespaceManager]::CreateFromConnectionString($sbr.ConnectionString);\r     Write-Output \"NamespaceManager object for the [$Namespace] namespace has been successfully created.\"\r \r     # Check to see if the Notification Hub already exists\r     if ($NamespaceManager.NotificationHubExists($Path))\r     {\r         Write-Output \"The [$Path] notification hub already exists in the [$Namespace] namespace.\"  \r     }\r     else\r     {\r         Write-Output \"Creating the [$Path] notification hub in the [$Namespace] namespace.\"\r         $NHDescription = New-Object -TypeName Microsoft.Azure.NotificationHubs.NotificationHubDescription -ArgumentList $Path;\r         $NHDescription.WnsCredential = $WnsCredential;\r         $NamespaceManager.CreateNotificationHub($NHDescription);\r         Write-Output \"The [$Path] notification hub was created in the [$Namespace] namespace.\"\r     }\r }\r else\r {\r     Write-Host \"The [$Namespace] namespace does not exist.\"\r }\r ```\r \r ## 其他资源\r \r - [使用 PowerShell 管理服务总线](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.servicebus/v0.0.2/azurerm.servicebus)\r - [如何使用 PowerShell 脚本创建 Service Bus 队列、主题和订阅](http://blogs.msdn.com/b/paolos/archive/2014/12/02/how-to-create-a-service-bus-queues-topics-and-subscriptions-using-a-powershell-script.aspx)\r - [如何使用 PowerShell 脚本创建 Service Bus 命名空间和事件中心](http://blogs.msdn.com/b/paolos/archive/2014/12/01/how-to-create-a-service-bus-namespace-and-an-event-hub-using-a-powershell-script.aspx)\r \r 一些现成的脚本也可供下载：\r - [服务总线 PowerShell 脚本](https://code.msdn.microsoft.com/windowsazure/Service-Bus-PowerShell-a46b7059)\r \r [试用]: https://www.azure.cn/pricing/1rmb-trial/\r [安装和配置 Azure PowerShell]: ../powershell-install-configure.md\r [通知中心的 .NET API]: https://msdn.microsoft.com/zh-cn/library/azure/mt414893.aspx\r [Get-AzureSBNamespace]: https://msdn.microsoft.com/zh-cn/library/azure/dn495122.aspx\r [New-AzureSBNamespace]: https://msdn.microsoft.com/zh-cn/library/azure/dn495165.aspx\r [Get-AzureSBAuthorizationRule]: https://msdn.microsoft.com/zh-cn/library/azure/dn495113.aspx\r \r <!---HONumber=Mooncake_0801_2016-->"}