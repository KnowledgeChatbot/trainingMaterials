{"Title":"示例入门","Description":"本文介绍 Power BI 工作区集合入门示例。","Content":"# <a name=\"get-started-with-power-bi-workspace-collections-sample\"></a>Power BI 工作区集合入门示例\r \r 通过 **Power BI 工作区集合**，可以将 Power BI 报表集成到 Web 或移动应用程序。 本文介绍 **Power BI 工作区集合**入门示例。\r \r > [!IMPORTANT]\r > Power BI 工作区集合已弃用，到 2018 年 6 月或合同指示时可用。 建议你规划到 Power BI Embedded 的迁移以避免应用程序中断。 有关如何将数据迁移到 Power BI Embedded 的信息，请参阅[如何将 Power BI 工作区集合内容迁移到 Power BI Embedded](https://powerbi.microsoft.com/documentation/powerbi-developer-migrate-from-powerbi-embedded/)。\r \r 往下继续之前，要保存以下资源：在将 Power BI 报表集成到示例应用以及自己的应用时，它们会有所帮助。\r \r - [示例工作区 Web 应用](https://github.com/kustbilla/Mooncake_PowerBI_Embedded)\r - [Power BI 工作区集合 API 参考](https://msdn.microsoft.com/library/azure/mt711507.aspx)\r - [Power BI .NET SDK](http://go.microsoft.com/fwlink/?LinkId=746472)（通过 NuGet 提供）\r - [JavaScript 报表嵌入示例](https://microsoft.github.io/PowerBI-JavaScript/demo)\r \r > [!NOTE]\r > 需要先在 Azure 订阅中创建至少一个**工作区集合**才能配置和运行 Power BI 工作区集合入门示例。 若要了解如何在 Azure 门户中创建**工作区集合**，请参阅 [Power BI 工作区集合入门](get-started.md)。\r \r ## <a name=\"configure-the-sample-app\"></a>配置示例应用\r \r 下面引导完成 Visual Studio 开发环境的设置，以便访问运行示例应用时所需的组件。\r \r 1. 下载并解压缩 GitHub 上的 [Power BI 工作区集合 - 将报表集成到 Web 应用中](http://go.microsoft.com/fwlink/?LinkId=761493)示例。\r \r     >[!IMPORTANT]\r     > 本示例中的某些 URL 只能在全球环境中使用。 若要在 Azure 中国区环境中使用它，必须执行一些替换。\r     > 例如：在文件 \\ProvisionSample\\App.config 中将 https://api.powerbi.com 替换为 https://api.powerbi.cn，将 https://management.azure.com 替换为 https://management.chinacloudapi.cn，在文件 \\ProvisionSample\\Program.cs 中将 https://management.core.windows.net 替换为 https://management.core.chinacloudapi.cn，在文件 \\ProvisionSample\\ProgramExtensions.cs 中将 https://login.windows.net 替换为 https://login.chinacloudapi.cn。 有关全球环境与中国区环境中 URL 的差别的详细信息，请参阅 [此文](https://docs.azure.cn/zh-cn/articles/guidance/developerdifferences?toc=%2fguides%2fdeveloper%2ftoc.json)。\r \r 2. 在 Visual Studio 中打开“PowerBI embedded.sln”  。 可能需要在 NuGet 程序包管理器控制台中执行 **Update-Package** 命令来更新此解决方案中使用的程序包。\r 3. 生成解决方案。\r 4. 运行“ProvisionSample”  控制台应用。 在示例控制台应用中，预配一个工作区并导入 PBIX 文件。\r 5. 要预配新的工作区，请选择选项 1“收集管理”，并选择选项 6“预配新的工作区”\r 6. 要导入新的“报表”，请选择选项 2“报表管理”，然后选择选项 3“将 PBIX 桌面文件导入到工作区”。\r \r 7. 输入**工作区集合**名称和**访问密钥**。 可以通过 **Azure 门户**获取这些信息。 若要详细了解如何获取**访问密钥**，请参阅“Power BI Embedded 入门”中的[查看 Power BI API 访问密钥](get-started.md#view-power-bi-api-access-keys)。\r \r     ![Azure 门户中的访问密钥](./media/get-started-sample/azure-portal.png)\r 8. 复制并保存新创建的 **工作区 ID** 以便在本文后面部分使用。 创建**工作区 ID** 之后，可以在 **Azure 门户**中找到该数据。\r \r     ![Azure 门户中的工作区 ID](./media/get-started-sample/workspace-id.png)\r 9. 要将 PBIX 文件导入到**工作区**，请选择选项 6**。**“将 PBIX 文件导入到现有工作区”。 如果没有现有的 PBIX 文件，则可以下载 [Retail Analysis Sample PBIX](http://go.microsoft.com/fwlink/?LinkID=780547)（零售分析示例 PBIX）。\r 10. 如果出现提示，请为**数据集**输入一个易记的名称。\r \r 应该会看到如下所示的响应：\r \r ```\r Checking import state... Publishing\r Checking import state... Succeeded\r ```\r \r > [!NOTE]\r > 如果 PBIX 文件包含任何直接查询连接，请选择选项 7 以更新连接字符串。\r \r 此时， **工作区**中已导入了一个 Power BI PBIX 报表。 接下来将演示如何运行 **Power BI 工作区集合**入门示例 Web 应用。\r \r ## <a name=\"run-the-sample-web-app\"></a>运行示例 Web 应用\r \r Web 应用示例是一个示例应用程序，用于呈现**工作区**中导入的报表。 下面介绍了如何配置 Web 应用示例。\r \r 1. 在 **PowerBI Embedded** Visual Studio 解决方案中，右键单击“EmbedSample”Web 应用程序，并选择“设为启动项目”。\r 2. 在 **web.config** 的 **EmbedSample** Web 应用程序中，编辑 **appSettings** 中的 **AccessKey** 和 **WorkspaceCollection** 名称，以及 **WorkspaceId**。\r \r     ```\r     <appSettings>\r         <add key=\"powerbi:AccessKey\" value=\"\" />\r         <add key=\"powerbi:ApiUrl\" value=\"https://api.powerbi.cn\" />\r         <add key=\"powerbi:WorkspaceCollection\" value=\"\" />\r         <add key=\"powerbi:WorkspaceId\" value=\"\" />\r     </appSettings>\r     ```\r 3. 运行 **EmbedSample** Web 应用程序。\r \r 运行 **EmbedSample** Web 应用程序后，左侧的导航面板应包含“报表”菜单。 要查看导入的报表，请展开“报表”，并单击任一报表。 如果已导入了[零售分析示例 PBIX](http://go.microsoft.com/fwlink/?LinkID=780547)，则示例 Web 应用将如下所示：\r \r ![示例应用程序中的示例左导航栏](./media/get-started-sample/sample-left-nav.png)\r \r 单击某个报表后， **EmbedSample** Web 应用程序应类似于以下内容：\r \r ![应用程序中的示例报表显示](./media/get-started-sample/sample-web-app.png)\r \r ## <a name=\"explore-the-sample-code\"></a>探索示例代码\r \r **Power BI 工作区集合**示例是一个 Web 应用示例，演示了如何将 **Power BI** 报表集成到应用中。 它采用模型-视图-控制器 (MVC) 设计模式来演示最佳做法。 本部分重点介绍可以在 **PowerBI Embedded** Web 应用解决方案中浏览的示例代码。 模型-视图-控制器 (MVC) 模式根据用户输入的三个单独的类（模型、视图和控件）对域、演示文稿和操作分开进行建模。 若要了解关于 MVC 的详细信息，请参阅 [Learn About ASP.NET](http://www.asp.net/mvc)（了解 ASP.NET）。\r \r **Power BI 工作区集合**示例代码分隔方式如下所示。 每个部分在 PowerBI embedded.sln 解决方案中都包括了文件名称，以便轻松查找示例中的代码。\r \r > [!NOTE]\r > 本节总结了演示如何编写代码的示例代码。 若要查看完整的示例，请加载 Visual Studio 中的 PowerBI embedded.sln 解决方案。\r \r ### <a name=\"model\"></a>模型\r \r 该示例包含 **ReportsViewModel** 和 **ReportViewModel**。\r \r **ReportsViewModel.cs**：表示多个 Power BI 报表。\r \r ```\r public class ReportsViewModel\r {\r     public List<Report> Reports { get; set; }\r }\r ```\r \r **ReportViewModel.cs**：表示一个 Power BI 报表。\r \r ```\r public classReportViewModel\r {\r     public IReport Report { get; set; }\r \r     public string AccessToken { get; set; }\r }\r ```\r \r ### <a name=\"connection-string\"></a>连接字符串\r \r 连接字符串必须采用以下格式：\r \r ```\r Data Source=tcp:MyServer.database.chinacloudapi.cn,1433;Initial Catalog=MyDatabase\r ```\r \r 使用一般的服务器和数据库属性会失败。 例如：Server=tcp:MyServer.database.chinacloudapi.cn,1433;Database=MyDatabase。\r \r ### <a name=\"view\"></a>查看\r \r **视图**用于管理多个 Power BI **报表**或一个 Power BI **报表**的显示情况。\r \r **Reports.cshtml**：循环访问 **Model.Reports** 以创建 **ActionLink**。 **ActionLink** 包含以下内容：\r \r | 部分 | 说明 |\r | --- | --- |\r | 标题 |报表的名称。 |\r | QueryString |指向报表 ID 的链接。 |\r \r ```\r <div id=\"reports-nav\" class=\"panel-collapse collapse\">\r     <div class=\"panel-body\">\r         <ul class=\"nav navbar-nav\">\r             @foreach (var report in Model.Reports)\r             {\r                 var reportClass = Request.QueryString[\"reportId\"] == report.Id ? \"active\" : \"\";\r                 <li class=\"@reportClass\">\r                     @Html.ActionLink(report.Name, \"Report\", new { reportId = report.Id })\r                 </li>\r             }\r         </ul>\r     </div>\r </div>\r ```\r \r Report.cshtml：为 **PowerBIReportFor** 设置 **Model.AccessToken** 和 Lambda 表达式。\r \r ```\r @model ReportViewModel\r \r ...\r \r <div class=\"side-body padding-top\">\r     @Html.PowerBIAccessToken(Model.AccessToken)\r     @Html.PowerBIReportFor(m => m.Report, new { style = \"height:85vh\" })\r </div>\r ```\r \r ### <a name=\"controller\"></a>控制器\r \r **DashboardController.cs**：创建用于传递**应用令牌** 的 PowerBIClient。 JSON Web 令牌 (JWT) 是基于**签名密钥**生成的，用于获取**凭据**。 **凭据**用于创建 **PowerBIClient** 实例。 创建 **PowerBIClient** 实例后，可以调用 GetReports() 和 GetReportsAsync()。\r \r ```\r CreatePowerBIClient()\r \r     private IPowerBIClient CreatePowerBIClient()\r     {\r         var credentials = new TokenCredentials(accessKey, \"AppKey\");\r         var client = new PowerBIClient(credentials)\r         {\r             BaseUri = new Uri(apiUrl)\r         };\r \r         return client;\r     }\r \r ActionResult Reports()\r \r     public ActionResult Reports()\r     {\r         using (var client = this.CreatePowerBIClient())\r         {\r             var reportsResponse = client.Reports.GetReports(this.workspaceCollection, this.workspaceId);\r \r             var viewModel = new ReportsViewModel\r             {\r                 Reports = reportsResponse.Value.ToList()\r             };\r \r             return PartialView(viewModel);\r         }\r     }\r \r Task<ActionResult> Report(string reportId)\r \r     public async Task<ActionResult> Report(string reportId)\r     {\r         using (var client = this.CreatePowerBIClient())\r         {\r             var reportsResponse = await client.Reports.GetReportsAsync(this.workspaceCollection, this.workspaceId);\r             var report = reportsResponse.Value.FirstOrDefault(r => r.Id == reportId);\r             var embedToken = PowerBIToken.CreateReportEmbedToken(this.workspaceCollection, this.workspaceId, report.Id);\r \r             var viewModel = new ReportViewModel\r             {\r                 Report = report,\r                 AccessToken = embedToken.Generate(this.accessKey)\r             };\r \r             return View(viewModel);\r         }\r     }\r ```\r \r ### <a name=\"integrate-a-report-into-your-app\"></a>将报表集成到应用中\r \r 创建**报表**后，可以使用 **IFrame** 嵌入 Power BI **报表**。 以下是来自 **Power BI 工作区集合**示例中的 powerbi.js 代码片段。\r \r ```\r init: function() {\r     var embedUrl = this.getEmbedUrl();\r     var iframeHtml = '<igrame style=\"width:100%;height:100%;\" src=\"' + embedUrl + \r         '\" scrolling=\"no\" allowfullscreen=\"true\"></iframe>';\r     this.element.innerHTML = iframeHtml;\r     this.iframe = this.element.childNodes[0];\r     this.iframe.addEventListener('load', this.load.bind(this), false);\r }\r ```\r \r ## <a name=\"filter-reports-embedded-in-your-application\"></a>筛选应用程序中嵌入的报表\r \r 可以使用 URL 语法筛选嵌入的报表。 要进行筛选，可以使用指定的筛选器将带运算符 **eq** 的 **$filter** 查询字符串参数添加到 iFrame src url。 以下为筛选查询语法：\r \r ```\r https://app.powerbi.com/reportEmbed\r ?reportId=d2a0ea38-...-9673-ee9655d54a4a&\r $filter={tableName/fieldName}%20eq%20'{fieldValue}'\r ```\r \r > [!NOTE]\r > {tableName/fieldName} 不能包含空格或特殊字符。 {fieldValue} 接受单个分类值。  \r \r ## <a name=\"see-also\"></a>另请参阅\r \r [常见 Power BI 工作区集合方案](scenarios.md)  \r [在 Power BI 工作区集合中进行身份验证和授权](app-token-flow.md)  \r [嵌入报表](embed-report.md)  \r [从数据集创建新报表](create-report-from-dataset.md)  \r [Power BI Desktop](https://powerbi.microsoft.com/documentation/powerbi-desktop-get-the-desktop/)  \r [JavaScript 嵌入示例](https://microsoft.github.io/PowerBI-JavaScript/demo/)  \r \r 有更多问题？ [试用 Power BI 社区](http://community.powerbi.com/)\r \r "}