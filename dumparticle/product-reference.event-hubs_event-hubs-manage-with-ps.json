{"Title":"使用 PowerShell 管理 Azure 事件中心资源","Description":"使用 PowerShell 模块创建和管理事件中心","Content":"# <a name=\"use-powershell-to-manage-event-hubs-resources\"></a>使用 PowerShell 管理事件中心资源\r \r Azure PowerShell 是一个脚本编写环境，可用于控制和自动执行 Azure 服务的部署和管理。 本文介绍如何使用本地 Azure PowerShell 控制台或脚本通过[事件中心资源管理器 PowerShell 模块](https://docs.microsoft.com/powershell/module/azurerm.eventhub)预配和管理事件中心实体（命名空间、各个事件中心和使用者组）。\r \r 还可以使用 Azure Resource Manager 模板管理事件中心资源。 有关详细信息，请参阅文章[使用 Azure 资源管理器模板创建包含事件中心和使用者组的事件中心命名空间](event-hubs-resource-manager-namespace-event-hub.md)。\r \r ## <a name=\"prerequisites\"></a>先决条件\r \r 在开始之前，需要具备以下项：\r \r * Azure 订阅。 有关获取订阅的详细信息，请参阅[购买选项][purchase options]、[成员优惠][member offers]或[免费帐户][free account]。\r * 配备 Azure PowerShell 的计算机。 有关说明，请参阅 [Azure PowerShell cmdlet 入门](https://docs.microsoft.com/powershell/azure/get-started-azureps)。\r * 大致了解 PowerShell 脚本、NuGet 包和 .NET Framework。\r \r ## <a name=\"get-started\"></a>入门\r \r 第一步是使用 PowerShell 登录 Azure 帐户和 Azure 订阅。 按照 [Azure PowerShell cmdlet 入门](https://docs.microsoft.com/powershell/azure/get-started-azureps)中的说明登录 Azure 帐户，然后检索并访问 Azure 订阅中的资源。\r \r ## <a name=\"provision-an-event-hubs-namespace\"></a>预配事件中心命名空间\r \r 使用事件中心命名空间时，可以使用 [Get-AzureRmEventHubNamespace](https://docs.microsoft.com/powershell/module/azurerm.eventhub/get-azurermeventhubnamespace)、[New-AzureRmEventHubNamespace](https://docs.microsoft.com/powershell/module/azurerm.eventhub/new-azurermeventhubnamespace)、[Remove-AzureRmEventHubNamespace](https://docs.microsoft.com/powershell/module/azurerm.eventhub/remove-azurermeventhubnamespace) 和 [Set-AzureRmEventHubNamespace](https://docs.microsoft.com/powershell/module/azurerm.eventhub/set-azurermeventhubnamespace) cmdlet。\r \r 本示例在脚本中创建几个本地变量：`$Namespace` 和 `$Location`。\r \r * `$Namespace` 是我们要使用的事件中心命名空间的名称。\r * `$Location` 标识我们要在其中设置命名空间的数据中心。\r * `$CurrentNamespace` 存储我们检索（或创建）的引用命名空间。\r \r 在实际脚本中，`$Namespace` 和 `$Location` 可作为参数传递。\r \r 此部分脚本执行以下任务：\r \r 1. 尝试使用指定的名称检索事件中心命名空间。\r 2. 如果找到该命名空间，则报告它找到的内容。\r 3. 如果找不到该命名空间，则会创建该命名空间，并检索新创建的命名空间。\r \r     ```powershell\r     # Query to see if the namespace currently exists\r     $CurrentNamespace = Get-AzureRMEventHubNamespace -ResourceGroupName $ResGrpName -NamespaceName $Namespace\r \r     # Check if the namespace already exists or needs to be created\r     if ($CurrentNamespace)\r     {\r         Write-Host \"The namespace $Namespace already exists in the $Location region:\"\r         # Report what was found\r         Get-AzureRMEventHubNamespace -ResourceGroupName $ResGrpName -NamespaceName $Namespace\r     }\r     else\r     {\r         Write-Host \"The $Namespace namespace does not exist.\"\r         Write-Host \"Creating the $Namespace namespace in the $Location region...\"\r         New-AzureRmEventHubNamespace -ResourceGroupName $ResGrpName -NamespaceName $Namespace -Location $Location\r         $CurrentNamespace = Get-AzureRMEventHubNamespace -ResourceGroupName $ResGrpName -NamespaceName $Namespace\r         Write-Host \"The $Namespace namespace in Resource Group $ResGrpName in the $Location region has been successfully created.\"\r     }\r     ```\r \r ## <a name=\"create-an-event-hub\"></a>创建事件中心\r \r 若要创建事件中心，请使用上一部分中的脚本执行命名空间检查。 然后，使用 [New-AzureRmEventHub](https://docs.microsoft.com/powershell/module/azurerm.eventhub/new-azurermeventhub) cmdlet 创建事件中心：\r \r ```powershell\r # Check if event hub already exists\r $CurrentEH = Get-AzureRMEventHub -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r \r if($CurrentEH)\r {\r     Write-Host \"The event hub $EventHubName already exists in the $Location region:\"\r     # Report what was found\r     Get-AzureRmEventHub -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r }\r else\r {\r     Write-Host \"The $EventHubName event hub does not exist.\"\r     Write-Host \"Creating the $EventHubName event hub in the $Location region...\"\r     New-AzureRmEventHub -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -Location $Location -MessageRetentionInDays 3\r     $CurrentEH = Get-AzureRmEventHub -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r     Write-Host \"The $EventHubName event hub in Resource Group $ResGrpName in the $Location region has been successfully created.\"\r }\r ```\r \r ### <a name=\"create-a-consumer-group\"></a>创建使用者组\r \r 若要在事件中心中创建使用者组，请使用上一部分中的脚本执行命名空间和事件中心检查。 然后，使用 [New-AzureRmEventHubConsumerGroup](https://docs.microsoft.com/powershell/module/azurerm.eventhub/new-azurermeventhubconsumergroup) cmdlet 在事件中心中创建使用者组。 例如：\r \r ```powershell\r # Check if consumer group already exists\r $CurrentCG = Get-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -ConsumerGroupName $ConsumerGroupName -ErrorAction Ignore\r \r if($CurrentCG)\r {\r     Write-Host \"The consumer group $ConsumerGroupName in event hub $EventHubName already exists in the $Location region:\"\r     # Report what was found\r     Get-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r }\r else\r {\r     Write-Host \"The $ConsumerGroupName consumer group does not exist.\"\r     Write-Host \"Creating the $ConsumerGroupName consumer group in the $Location region...\"\r     New-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -ConsumerGroupName $ConsumerGroupName\r     $CurrentCG = Get-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r     Write-Host \"The $ConsumerGroupName consumer group in event hub $EventHubName in Resource Group $ResGrpName in the $Location region has been successfully created.\"\r }\r ```\r \r #### <a name=\"set-user-metadata\"></a>设置用户元数据\r \r 执行上述部分中的脚本后，可以使用 [Set-AzureRmEventHubConsumerGroup](https://docs.microsoft.com/powershell/module/azurerm.eventhub/set-azurermeventhubconsumergroup) cmdlet 更新使用者组的属性，如以下示例所示：\r \r ```powershell\r # Set some user metadata on the CG\r Write-Host \"Setting the UserMetadata field to 'Testing'\"\r Set-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -ConsumerGroupName $ConsumerGroupName -UserMetadata \"Testing\"\r # Show result\r Get-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -ConsumerGroupName $ConsumerGroupName\r ```\r \r ## <a name=\"remove-event-hub\"></a>删除事件中心\r \r 要删除所创建的事件中心，可以使用 `Remove-*` cmdlet，如以下示例所示：\r \r ```powershell\r # Clean up\r Remove-AzureRmEventHubConsumerGroup -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName -ConsumerGroupName $ConsumerGroupName\r Remove-AzureRmEventHub -ResourceGroupName $ResGrpName -NamespaceName $Namespace -EventHubName $EventHubName\r Remove-AzureRmEventHubNamespace -ResourceGroupName $ResGrpName -NamespaceName $Namespace\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - 请参阅[此处](https://docs.microsoft.com/powershell/module/azurerm.eventhub)完整的事件中心 Resource Manager PowerShell 模块文档。 此页列出所有可用的 cmdlet。\r - 有关使用 Azure 资源管理器模板的信息，请参阅文章[使用 Azure 资源管理器模板创建包含事件中心和使用者组的事件中心命名空间](event-hubs-resource-manager-namespace-event-hub.md)。\r - 有关[事件中心 .NET 管理库](event-hubs-management-libraries.md)的信息。\r \r [purchase options]: https://www.azure.cn/pricing/overview/\r [member offers]: https://www.azure.cn/pricing/member-offers/\r [free account]: https://www.azure.cn/pricing/1rmb-trial/\r \r <!--Update_Description: update meta properties, wording update-->"}