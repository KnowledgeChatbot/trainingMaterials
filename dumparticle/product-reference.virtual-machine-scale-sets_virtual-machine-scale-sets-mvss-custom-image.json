{"Title":"引用 Azure 规模集模板中的自定义映像","Description":"如何将自定义映像添加到现有 Azure 虚拟机规模集模板","Content":"# <a name=\"add-a-custom-image-to-an-azure-scale-set-template\"></a>将自定义映像添加到 Azure 规模集模板\r \r 本文介绍了如何修改[最小可行规模集模板](./virtual-machine-scale-sets-mvss-start.md)，以便通过自定义映像进行部署。\r \r ## <a name=\"change-the-template-definition\"></a>更改模板定义\r \r 可以在[此处](https://raw.githubusercontent.com/gatneil/mvss/minimum-viable-scale-set/azuredeploy.json)查看最小可行规模集模板，在[此处](https://raw.githubusercontent.com/gatneil/mvss/custom-image/azuredeploy.json)查看用于通过自定义映像部署规模集的模板。 让我们逐一查看创建此模板 (`git diff minimum-viable-scale-set custom-image`) 时使用的差异内容：\r \r ### <a name=\"creating-a-managed-disk-image\"></a>创建托管磁盘映像\r \r 如果已有自定义的托管磁盘映像（`Microsoft.Compute/images` 类型的资源），则可以跳过此部分。\r \r 首先，添加 `sourceImageVhdUri` 参数，即 Azure 存储中通用 blob 的 URI，Azure 存储包含用于部署的自定义映像。\r \r ```diff\r      },\r      \"adminPassword\": {\r        \"type\": \"securestring\"\r +    },\r +    \"sourceImageVhdUri\": {\r +      \"type\": \"string\",\r +      \"metadata\": {\r +        \"description\": \"The source of the generalized blob containing the custom image\"\r +      }\r      }\r    },\r    \"variables\": {},\r ```\r \r 接下来，添加 `Microsoft.Compute/images` 类型的资源，即托管磁盘映像，该映像基于位于 URI `sourceImageVhdUri` 中的通用 blob。 该映像必须与使用它的规模集位于同一区域。 在映像的属性中，指定 OS 类型，blob 的位置（通过 `sourceImageVhdUri` 参数）以及存储帐户类型：\r \r ```diff\r    \"resources\": [\r      {\r +      \"type\": \"Microsoft.Compute/images\",\r +      \"apiVersion\": \"2016-04-30-preview\",\r +      \"name\": \"myCustomImage\",\r +      \"location\": \"[resourceGroup().location]\",\r +      \"properties\": {\r +        \"storageProfile\": {\r +          \"osDisk\": {\r +            \"osType\": \"Linux\",\r +            \"osState\": \"Generalized\",\r +            \"blobUri\": \"[parameters('sourceImageVhdUri')]\",\r +            \"storageAccountType\": \"Standard_LRS\"\r +          }\r +        }\r +      }\r +    },\r +    {\r        \"type\": \"Microsoft.Network/virtualNetworks\",\r        \"name\": \"myVnet\",\r        \"location\": \"[resourceGroup().location]\",\r \r ```\r \r 在规模集资源中，添加涉及自定义映像的 `dependsOn` 子句，确保先创建该映像，以便规模集尝试通过该映像进行部署：\r \r ```diff\r        \"location\": \"[resourceGroup().location]\",\r        \"apiVersion\": \"2016-04-30-preview\",\r        \"dependsOn\": [\r -        \"Microsoft.Network/virtualNetworks/myVnet\"\r +        \"Microsoft.Network/virtualNetworks/myVnet\",\r +        \"Microsoft.Compute/images/myCustomImage\"\r        ],\r        \"sku\": {\r          \"name\": \"Standard_A1\",\r \r ```\r \r ### <a name=\"changing-scale-set-properties-to-use-the-managed-disk-image\"></a>更改规模集属性，使用托管磁盘映像\r \r 在规模集 `storageProfile` 的 `imageReference` 中，指定 `Microsoft.Compute/images` 资源的 `id`，而不是指定平台映像的发布者、优惠、SKU 以及版本：\r \r ```diff\r          \"virtualMachineProfile\": {\r            \"storageProfile\": {\r              \"imageReference\": {\r -              \"publisher\": \"Canonical\",\r -              \"offer\": \"UbuntuServer\",\r -              \"sku\": \"16.04-LTS\",\r -              \"version\": \"latest\"\r +              \"id\": \"[resourceId('Microsoft.Compute/images', 'myCustomImage')]\"\r              }\r            },\r            \"osProfile\": {\r ```\r \r 此示例使用 `resourceId` 函数获取用同一模板创建的映像的资源 ID。 如果已事先创建托管磁盘映像，应改为提供该映像的 ID。 此 ID 必须采用以下格式：`/subscriptions/<subscription-id>resourceGroups/<resource-group-name>/providers/Microsoft.Compute/images/<image-name>`。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r [!INCLUDE [mvss-next-steps-include](../../includes/mvss-next-steps.md)]"}