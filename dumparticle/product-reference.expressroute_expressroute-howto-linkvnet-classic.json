{"Title":"将虚拟网络链接到 ExpressRoute 线路：PowerShell：经典：Azure","Description":"本文档概述如何使用经典部署模型和 PowerShell 将虚拟网络 (VNet) 链接到 ExpressRoute 线路。","Content":"# <a name=\"connect-a-virtual-network-to-an-expressroute-circuit-using-powershell-classic\"></a>使用 PowerShell 将虚拟网络连接到 ExpressRoute 线路（经典）\r > [!div class=\"op_single_selector\"]\r > * [Resource Manager - Azure 门户](./expressroute-howto-linkvnet-portal-resource-manager.md)\r > * [Resource Manager - PowerShell](./expressroute-howto-linkvnet-arm.md)\r > * [经典 - PowerShell](./expressroute-howto-linkvnet-classic.md)\r >\r >\r \r 本文将帮助使用经典部署模型和 PowerShell 将虚拟网络 (VNet) 链接到 Azure ExpressRoute 线路。 虚拟网络可以在同一个订阅中，也可以属于另一个订阅。\r \r [!INCLUDE [expressroute-classic-end-include](../../includes/expressroute-classic-end-include.md)]\r \r **关于 Azure 部署模型**\r \r [!INCLUDE [vpn-gateway-clasic-rm](../../includes/vpn-gateway-classic-rm-include.md)] \r \r ## <a name=\"configuration-prerequisites\"></a>配置先决条件\r \r 1. 需要 Azure PowerShell 模块的最新版本。 可以从 [Azure 下载页](https://www.azure.cn/downloads/)的 PowerShell 部分下载最新 PowerShell 模块。 有关如何配置计算机以使用 Azure PowerShell 模块的分步指导，请遵循[如何安装和配置 Azure PowerShell](../powershell-install-configure.md) 中的说明。 \r 2. 在开始配置之前，需要查看[先决条件](./expressroute-prerequisites.md)、[路由要求](./expressroute-routing.md)和[工作流](./expressroute-workflows.md)。\r 3. 必须有一个活动的 ExpressRoute 线路。 \r     - 请按说明[创建 ExpressRoute 线路](./expressroute-howto-circuit-classic.md)，并让连接提供商启用该线路。\r     - 确保为线路配置 Azure 专用对等互连。 有关路由说明，请参阅[配置路由](./expressroute-howto-routing-classic.md)一文。 \r     - 确保配置 Azure 专用对等互连，并运行用户网络和 Microsoft 之间的 BGP 对等互连，以便启用端到端连接。\r     - 必须已创建并完全预配虚拟网络和虚拟网络网关。 请按说明[为 ExpressRoute 配置虚拟网络](./expressroute-howto-vnet-portal-classic.md)。\r \r 最多可以将 10 个虚拟网络链接到 ExpressRoute 线路。 所有虚拟网络都必须位于同一地缘政治区域。 如果已启用 ExpressRoute 高级外接程序，则可以将更多虚拟网络链接到 ExpressRoute 线路，或者链接其他地缘政治区域中的虚拟网络。 有关高级外接程序的更多详细信息，请参阅[常见问题解答](./expressroute-faqs.md)。\r \r ## <a name=\"connect-a-virtual-network-in-the-same-subscription-to-a-circuit\"></a>将同一订阅中的虚拟网络连接到线路\r 可以使用以下 cmdlet 将虚拟网络链接到 ExpressRoute 线路。 在运行 cmdlet 之前，请确保已创建虚拟网络网关并可将其用于进行链接。\r \r     New-AzureDedicatedCircuitLink -ServiceKey \"*****************************\" -VNetName \"MyVNet\"\r     Provisioned\r \r ## <a name=\"connect-a-virtual-network-in-a-different-subscription-to-a-circuit\"></a>将不同订阅中的虚拟网络连接到线路\r 用户可以在多个订阅之间共享 ExpressRoute 线路。 下图是在多个订阅之间共享 ExpressRoute 线路的简单示意图。\r \r 大型云中的每个较小云用于表示属于组织中不同部门的订阅。 组织内的每个部门可以使用自己的订阅部署其服务，但这些部门可以共享单个 ExpressRoute 线路以连接回本地网络。 单个部门（在此示例中为 IT 部门）可以拥有 ExpressRoute 线路。 组织内的其他订阅可以使用 ExpressRoute 线路。\r \r > [!NOTE]\r > 将对 ExpressRoute 线路所有者收取专用线路的连接和带宽费用。 所有虚拟网络共享相同的带宽。\r > \r > \r \r ![跨订阅连接](./media/expressroute-howto-linkvnet-classic/cross-subscription.png)\r \r ### <a name=\"administration\"></a>管理\r *线路所有者* 是在其中创建 ExpressRoute 线路的订阅的管理员/共同管理员。 线路所有者可以授权其他订阅的管理员/共同管理员（称为 *线路用户*）使用他们拥有的专用线路。 有权使用组织的 ExpressRoute 线路的线路用户，在获得授权后可以将其订阅中的虚拟网络链接到 ExpressRoute 线路。\r \r 线路所有者有权随时修改和撤消授权。 撤消授权会导致从已撤消其访问权限的订阅中删除所有链接。\r \r ### <a name=\"circuit-owner-operations\"></a>线路所有者操作\r \r **创建授权**\r \r 线路所有者可授权其他订阅的管理员使用指定的线路。 在下面的示例中，线路 (Contoso IT) 管理员允许另一个订阅（开发-测试）的管理员最多将两个虚拟网络链接到线路。 Contoso IT 管理员可以通过指定开发-测试 Microsoft ID 启用此功能。 该 cmdlet 不会将电子邮件发送到指定的 Microsoft ID。 线路所有者需要显式通知其他订阅所有者：授权已完成。\r \r     New-AzureDedicatedCircuitLinkAuthorization -ServiceKey \"**************************\" -Description \"Dev-Test Links\" -Limit 2 -MicrosoftIds 'devtest@contoso.com'\r \r     Description         : Dev-Test Links\r     Limit               : 2\r     LinkAuthorizationId : **********************************\r     MicrosoftIds        : devtest@contoso.com\r     Used                : 0\r \r **查看授权**\r \r 线路所有者可以通过运行以下 cmdlet 查看针对特定线路发出的所有授权：\r \r     Get-AzureDedicatedCircuitLinkAuthorization -ServiceKey: \"**************************\"\r \r     Description         : EngineeringTeam\r     Limit               : 3\r     LinkAuthorizationId : ####################################\r     MicrosoftIds        : engadmin@contoso.com\r     Used                : 1\r \r     Description         : MarketingTeam\r     Limit               : 1\r     LinkAuthorizationId : @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r     MicrosoftIds        : marketingadmin@contoso.com\r     Used                : 0\r \r     Description         : Dev-Test Links\r     Limit               : 2\r     LinkAuthorizationId : &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\r     MicrosoftIds        : salesadmin@contoso.com\r     Used                : 2\r \r \r **更新授权**\r \r 线路所有者可以使用以下 cmdlet 修改授权：\r \r     Set-AzureDedicatedCircuitLinkAuthorization -ServiceKey \"**************************\" -AuthorizationId \"&&&&&&&&&&&&&&&&&&&&&&&&&&&&\"-Limit 5\r \r     Description         : Dev-Test Links\r     Limit               : 5\r     LinkAuthorizationId : &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\r     MicrosoftIds        : devtest@contoso.com\r     Used                : 0\r \r \r **删除授权**\r \r 线路所有者可以通过运行以下 cmdlet 撤消/删除对用户的授权：\r \r     Remove-AzureDedicatedCircuitLinkAuthorization -ServiceKey \"*****************************\" -AuthorizationId \"###############################\"\r \r \r ### <a name=\"circuit-user-operations\"></a>线路用户操作\r \r **查看授权**\r \r 线路用户可以使用以下 cmdlet 查看授权：\r \r     Get-AzureAuthorizedDedicatedCircuit\r \r     Bandwidth                        : 200\r     CircuitName                      : ContosoIT\r     Location                         : Beijing\r     MaximumAllowedLinks              : 2\r     ServiceKey                       : &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\r     ServiceProviderName              : Beijing Telecom Ethernet\r     ServiceProviderProvisioningState : Provisioned\r     Status                           : Enabled\r     UsedLinks                        : 0\r \r **兑现链接授权**\r \r 线路用户可以通过运行以下 cmdlet 兑现链接授权：\r \r     New-AzureDedicatedCircuitLink –servicekey \"&&&&&&&&&&&&&&&&&&&&&&&&&&\" –VnetName 'SalesVNET1'\r \r     State VnetName\r     ----- --------\r     Provisioned SalesVNET1\r \r 在虚拟网络新链接的订阅中运行此命令：\r \r     New-AzureDedicatedCircuitLink -ServiceKey \"*****************************\" -VNetName \"MyVNet\"\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 ExpressRoute 的详细信息，请参阅 [ExpressRoute 常见问题](./expressroute-faqs.md)。\r \r <!--Update_Description: update wording and code-->"}