{"Title":"Azure SQL 数据库资源限制","Description":"本页介绍 Azure SQL 数据库的一些常见资源限制。","Content":"# <a name=\"azure-sql-database-resource-limits\"></a>Azure SQL 数据库资源限制\r \r ## <a name=\"single-database-storage-sizes-and-performance-levels\"></a>单一数据库：存储大小和性能级别\r \r 对于单一数据库，下表显示了可用于每个服务层和性能级别的单一数据库的资源。 可通过 [Azure 门户](sql-database-single-database-resources.md#manage-single-database-resources-using-the-azure-portal)、[Transact-SQL](sql-database-single-database-resources.md#manage-single-database-resources-using-transact-sql)、[PowerShell](sql-database-single-database-resources.md#manage-single-database-resources-using-powershell)、[Azure CLI](sql-database-single-database-resources.md#manage-single-database-resources-using-the-azure-cli) 或 [REST API](sql-database-single-database-resources.md#manage-single-database-resources-using-the-rest-api) 为单一数据库设置服务层、性能级别和存储量。\r \r [!INCLUDE [SQL DB service tiers table](../../includes/sql-database-service-tiers-table.md)]\r \r ## <a name=\"single-database-change-storage-size\"></a>单一数据库：更改存储大小\r \r - 单一数据库的 DTU 价格附送了一定容量的存储，无需额外费用。 超出附送的量后，可花费额外的费用预配额外的存储，但不能超过存储上限，不超过 1 TB 时，以 250 GB 为增量进行预配，超出 1 TB 时，以 256 GB 为增量进行预配。 有关附送存储量和大小上限，请参阅[单一数据库：存储大小和性能级别](#single-database-storage-sizes-and-performance-levels)。\r - 可通过 [Azure portal](sql-database-single-database-resources.md#manage-single-database-resources-using-the-azure-portal)、[Transact-SQL](https://docs.microsoft.com/sql/t-sql/statements/alter-database-azure-sql-database#examples)、[PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabase)、[Azure CLI](/cli/sql/db#az_sql_db_update) 或 [REST API](https://docs.microsoft.com/rest/api/sql/databases/update) 为单一数据库增加大小上限，以预配额外存储。\r - 单一数据库的额外存储价格等于额外存储量乘以服务层的额外存储单价。 有关额外存储价格的详细信息，请参阅 [SQL 数据库定价](https://www.azure.cn/pricing/details/sql-database/)。\r \r ## <a name=\"single-database-change-dtus\"></a>单一数据库：更改 DTU\r \r 首先选择服务层、性能级别和存储量，然后使用 [Azure portal](sql-database-single-database-resources.md#manage-single-database-resources-using-the-azure-portal)、[Transact-SQL](https://docs.microsoft.com/sql/t-sql/statements/alter-database-azure-sql-database#examples)、 [PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabase)、[Azure CLI](/cli/sql/db#az_sql_db_update) 或 [REST API](https://docs.microsoft.com/rest/api/sql/databases/update)，根据实际体验动态扩展或缩减单一数据库。 \r \r 更改数据库的服务层和/或性能级别将在新的性能级别创建原始数据库的副本，并将连接切换到副本。 当我们切换到副本时，在此过程中不会丢失任何数据，但在短暂的瞬间，将禁用与数据库的连接，因此可能回滚某些处于进行状态的事务。 用于切换的时间长度因情况而异，但通常为 4 秒以下，并且 99% 的情况下少于 30 秒。 如果在禁用连接的那一刻有大量的事务正在进行，则用于切换的时间长度可能会更长。 \r \r 整个扩展过程的持续时间同时取决于更改前后数据库的大小和服务层。 例如，一个正在更改到标准服务层、从标准服务层更改或在标准服务层内更改的 250 GB 的数据库应在六小时内完成。 如果数据库与正在高级服务层内更改性能级别的大小相同，应在三小时内完成扩展。\r \r > [!TIP]\r > 若要检查正在进行的 SQL 数据库缩放操作的状态，可以使用以下查询：```select * from sys.dm_operation_status```。\r >\r \r * 如果要升级到更高的服务层或性能级别，除非显式指定了更大的大小（最大），否则，最大数据库大小不会增大。\r * 若要对数据库进行降级，数据库所用空间必须小于目标服务层和性能级别允许的最大大小。 \r * 从高级或高级 RS 降级至标准层时，如果同时满足 (1) 目标性能级别支持该数据库的最大大小，(2) 最大大小超出目标性能级别附送的存储量，那么将产生额外存储费用。 例如，如果将最大大小为 500 GB 的 P1 数据库缩小至 S3，那么将产生额外的存储费用，因为 S3 支持的最大大小为 500 GB，而它的附送存储量仅为 250 GB。 因此，额外存储量为 500 GB – 250 GB = 250 GB。 有关额外存储定价的信息，请参阅 [SQL 数据库定价](https://www.azure.cn/pricing/details/sql-database/)。 如果实际使用的空间量小于附送的存储量，只要将数据库最大大小减少到附送的量，就能避免此项额外费用。 \r * 在启用了[异地复制](sql-database-geo-replication-portal.md)的情况下升级数据库时，请先将辅助数据库升级到所需的性能层，然后再升级主数据库（一般原则）。 在升级到另一版本时，必须首先升级辅助数据库。\r * 在启用了[异地复制](sql-database-geo-replication-portal.md)的情况下降级数据库时，请先将主数据库降级到所需的性能层，然后再降级辅助数据库（一般原则）。 在降级到另一版本时，必须首先降级主数据库。\r * 各服务层提供的还原服务各不相同。 如果要降级到基本层，则备份保留期也将减少 - 请参阅 [Azure SQL 数据库备份](sql-database-automated-backups.md)。\r * 更改完成前不会应用数据库的新属性。\r \r \r ## <a name=\"elastic-pool-storage-sizes-and-performance-levels\"></a>弹性池：存储大小和性能级别\r \r 对于 SQL 数据库弹性池，下表显示了在每个服务层和性能级别可用的资源。 可通过 [Azure 门户](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-the-azure-portal)、[PowerShell](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-powershell)、[Azure CLI](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-the-azure-cli) 或 [REST API](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-the-rest-api) 设置服务层、性能级别和存储量。\r \r > [!NOTE]\r > 弹性池中各个数据库的资源限制通常与池外部基于 DTU 和服务层的各个数据库相同。 例如，S2 数据库的最大并发辅助进程数为 120 个。 因此，如果池中每个数据库的最大 DTU 是 50 个 DTU（这等效于 S2），则标准池中数据库的最大并发辅助进程数也是 120 个辅助进程。\r >\r \r [!INCLUDE [SQL DB service tiers table for elastic pools](../../includes/sql-database-service-tiers-table-elastic-pools.md)]\r \r 如果使用了弹性池的所有 DTU，那么池中的每个数据库将接收相同数量的资源来处理查询。 SQL 数据库服务通过确保相等的计算时间片段，在数据库之间提供资源共享的公平性。 弹性池资源共享公平性是在将每个数据库的 DTU 最小值设为非零值时，对另外为每个数据库保证的任意资源量的补充。\r \r ### <a name=\"database-properties-for-pooled-databases\"></a>入池数据库的数据库属性\r \r 下表介绍了入池数据库的属性。\r \r | 属性 | 说明 |\r |:--- |:--- |\r | 每个数据库的最大 eDTU 数 |根据池中其他数据库的 eDTU 使用率，池中任何数据库可以使用的 eDTU 的最大数目。 每个数据库的 eDTU 上限并不是数据库的资源保障。 这是应用于池中所有数据库的全局设置。 将每个数据库的最大 eDTU 数设置得足够高，以处理数据库使用高峰情况。 因为池通常会假定数据库存在热使用模式和冷使用模式，在这些模式中并非所有数据库同时处于高峰使用状态，所以预期会存在某种程度的过量使用情况。 例如，假设每个数据库的高峰使用量为 20 个 eDTU，并且池中 100 个数据库仅有 20% 同时处于高峰使用中。 如果将每个数据库的 eDTU 最大值设为 20 个 eDTU，则可以认为超量 5 倍使用该池是合理的，并且将每个池的 eDTU 数设为 400。 |\r | 每个数据库的最小 eDTU 数 |池中任何数据库可以保证的 eDTU 最小数目。 这是应用于池中所有数据库的全局设置。 每个数据库的最小 eDTU 可能设为 0，这也是默认值。 此属性值可以设置为介于 0 和每个数据库的平均 eDTU 使用量之间的任意值。 池中数据库的数目和每个数据库的 eDTU 下限的积不能超过每个池的 eDTU 数。 例如，如果一个池有 20 个数据库，每个数据库的 eDTU 最小值设为 10 个 eDTU，则池的 eDTU 数目必须大于或等于 200 个 eDTU。 |\r | 每个数据库的最大存储 |池中一个数据库的最大存储空间。 入池数据库共享池的存储空间，因此数据库存储空间限制为小于池的剩余存储空间和每个数据库的最大存储空间。 每个数据库的最大存储是指数据文件的最大大小，不包括日志文件使用的空间。 |\r |||\r  \r ## <a name=\"elastic-pool-change-storage-size\"></a>弹性池：更改存储大小\r \r - 弹性池的 eDTU 价格附送了一定容量的存储，无需额外费用。 超出附送的量后，可花费额外的费用预配额外的存储，但不能超过存储上限，不超过 1 TB 时，以 250 GB 为增量进行预配，超出 1 TB 时，以 256 GB 为增量进行预配。 有关附送存储量和大小上限，请参阅[弹性池：存储大小和性能级别](#elastic-pool-storage-sizes-and-performance-levels)。\r - 可通过 [Azure 门户](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-the-azure-portal)、[PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqlelasticpool)、[Azure CLI](/cli/sql/elastic-pool#az_sql_elastic_pool_update) 或 [REST API](https://docs.microsoft.com/rest/api/sql/elasticpools/update) 为弹性池增加大小上限，以预配额外存储。\r - 弹性池的额外存储价格等于额外存储量乘以服务层的额外存储单价。 有关额外存储价格的详细信息，请参阅 [SQL 数据库定价](https://www.azure.cn/pricing/details/sql-database/)。\r \r ## <a name=\"elastic-pool-change-edtus\"></a>弹性池：更改 eDTU\r \r 可按资源需求，通过 [Azure portal](sql-database-elastic-pool.md#manage-elastic-pools-and-databases-using-the-azure-portal)、[PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqlelasticpool)、[Azure CLI](/cli/sql/elastic-pool#az_sql_elastic_pool_update) 或 [REST API](https://docs.microsoft.com/rest/api/sql/elasticpools/update) 增加或减少弹性池可用的资源。\r \r - 重新缩放池 eDTU 时，将暂时停止数据库连接。 此行为与重新缩放单一数据库（而非在池中）的 DTU 时的行为相同。 有关在重新缩放操作执行期间，停止数据库连接的持续时间和影响的详细信息，请参阅[重新缩放单一数据库的 DTU](#single-database-change-storage-size)。 \r - 重新缩放池 eDTU 的持续时间取决于池中所有数据库使用的总存储空间量。 一般而言，每 100 GB 重新缩放的平均延迟时间不超过 90 分钟。 例如，如果池中所有数据库使用的总空间为 200 GB，则重新缩放池的预计延迟时间将不超过 3 小时。 对标准层或基本层中的某些事例而言，重新缩放延迟时间可能不超过五分钟，不考虑所用空间量的影响。\r - 一般而言，更改每个数据库的最小 eDTU 或最大 eDTU 的持续时间将不超过五分钟。\r - 当缩小池 eDTU 时，池所用空间必须小于目标服务层和池 eDTU 所允许的最大大小。\r - 当重新缩放池 eDTU 时，如果 (1) 目标池支持池的存储上限，(2) 存储上限超过了目标池附送的存储量，将产生额外存储费用。 例如，如果最大大小为 100 GB 的 100 eDTU 标准池缩小为 50 eDTU 标准池，那么将产生额外存储费用，因为目标池支持的最大大小为 100 GB，其附送的存储量仅为 50 GB。 因此，额外存储量为 100 GB – 50 GB = 50 GB。 有关额外存储定价的信息，请参阅 [SQL 数据库定价](https://www.azure.cn/pricing/details/sql-database/)。 如果实际使用的空间量小于附送的存储量，只要将数据库最大大小减少到附送的量，就能避免此项额外费用。 \r \r ## <a name=\"what-happens-when-database-and-elastic-pool-resource-limits-are-reached\"></a>当数据库和弹性池资源到达限制时会如何？\r \r ### <a name=\"compute-dtus-and-edtus\"></a>计算（DTU 和 eDTU）\r \r 当数据库计算使用率（由 DTU 和 eDTU 计量）变高时，查询的延长时间也会增加，甚至可能出现超时。在上述情况下，服务可能对查询排队，并在资源可用时向查询提供资源以用于执行。\r 计算使用率变高时，风险缓解选项包括：\r \r - 提升数据库或弹性池的性能级别，向数据库提供更多 DTU 或 eDTU。 请参阅[单一数据库：更改 DUT](#single-database-change-dtus) 和[弹性池：更改 eDTU](#elastic-pool-change-edtus)。\r - 优化查询，减少每个查询的资源使用率。 有关详细信息，请参阅[查询优化/提示](sql-database-performance-guidance.md#query-tuning-and-hinting)。\r \r ### <a name=\"storage\"></a>存储\r \r 当使用的数据库空间到达上限时，将无法进行增加数据大小的数据库插入和更新操作，客户端会收到[错误消息](sql-database-develop-error-messages.md)。 数据库的选择和删除操作不受影响。\r \r 空间使用率变高时，风险缓解选项包括：\r \r - 增加数据库或弹性池的大小上限或更改性能级别，以包含更多已添加的存储。 请参阅 [SQL 数据库资源限制](sql-database-resource-limits.md)。\r - 如果数据库在弹性池内，那么可选择将数据库移出弹性池，从而避免与其他数据库共享存储空间。\r \r ### <a name=\"sessions-and-workers-requests\"></a>会话和辅助角色（请求） \r \r 并发会话和辅助角色的数目上限由服务层和性能级别（DTU 和 eDTU）决定。  当到达会话或辅助角色上限时，新的请求将被拒绝，客户端将收到错误消息。 虽然应用程序可以轻松地控制可用的连接数，但并行辅助角色数通常更难以估计和控制。 在负荷高峰期，当数据库资源达到上限，辅助角色由于较长时间运行查询而堆积时，这种情况尤其突出。 \r \r 会话或辅助角色使用率变高时，风险缓解选项包括：\r - 增加数据库或弹性池的服务层或性能级别。 请参阅[单一数据库：更改存储大小](#single-database-change-storage-size)、[单一数据库：更改 DUT](#single-database-change-dtus)、[弹性池：更改存储大小](#elastic-pool-change-storage-size)和[弹性池：更改 eDTU](#elastic-pool-change-edtus)。\r - 如果争用计算资源造成了辅助角色使用率上升，请优化查询，以降低每项查询的资源使用率。 有关详细信息，请参阅[查询优化/提示](sql-database-performance-guidance.md#query-tuning-and-hinting)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - 有关服务层的信息，请参阅[服务层](sql-database-service-tiers.md)。\r - 有关单一数据库的信息，请参阅[单一数据库资源](sql-database-resource-limits.md)。\r - 有关弹性池的信息，请参阅[弹性池](sql-database-elastic-pool.md)。\r - 有关 DTU 和 eDTU 的信息，请参阅 [DTU 和 eDTU](sql-database-what-is-a-dtu.md)。\r <!--Update_Description: update Global CLI 2.0 links to Mooncake CLI 2.0 links-->"}