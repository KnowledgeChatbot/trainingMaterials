{"Title":"使用 CLI 创建 Azure VM 的自定义映像","Description":"教程 - 使用 Azure CLI 创建自定义 VM 映像。","Content":"# <a name=\"create-a-custom-image-of-an-azure-vm-using-the-cli\"></a>使用 CLI 创建 Azure VM 的自定义映像\r \r 自定义映像类似于应用商店映像，不同的是自定义映像的创建者是你自己。 自定义映像可用于启动配置，例如预加载应用程序、应用程序配置和其他 OS 配置。 在本教程中，你将创建自己的 Azure 虚拟机自定义映像。 你将学习如何执行以下操作：\r \r > [!div class=\"checklist\"]\r > * 取消预配和通用化 VM\r > * 创建自定义映像\r > * 从自定义映像创建 VM\r > * 列出订阅中的所有映像\r > * 删除映像\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 如果选择在本地安装并使用 CLI，本教程要求运行 Azure CLI 2.0.4 或更高版本。 运行 `az --version` 即可查找版本。 如果需要进行安装或升级，请参阅[安装 Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-azure-cli?view=azure-cli-latest)。 \r \r ## <a name=\"before-you-begin\"></a>开始之前\r \r 下列步骤详细说明了如何将现有 VM 转换为可重用自定义映像，用于创建新的 VM 实例。\r \r 若要完成本教程中的示例，必须现有一个虚拟机。 如果需要，此[脚本示例](../scripts/virtual-machines-linux-cli-sample-create-vm-nginx.md)可为你创建一个虚拟机。 按照教程进行操作时，请根据需要替换资源组和 VM 名称。\r \r ## <a name=\"create-a-custom-image\"></a>创建自定义映像\r \r 若要创建虚拟机的映像，需通过以下方式准备 VM：取消源 VM 的预配，解除其分配，然后将其标记为通用化。 准备好 VM 后，可以创建映像。\r \r ### <a name=\"deprovision-the-vm\"></a>取消预配 VM \r \r 取消预配可通过删除特定于计算机的信息来通用化 VM。 实现此通用化后，即可从单个映像部署多个 VM。 在取消预配期间，主机名将重置为“localhost.localdomain”。 还会删除 SSH 主机密钥、名称服务器配置、根密码和缓存的 DHCP 租约。\r \r 若要取消预配 VM，请使用 Azure VM 代理 (waagent)。 Azure VM 代理安装在 VM 上，用于管理预配及其与 Azure 结构控制器的交互。 有关详细信息，请参阅 [Azure Linux 代理用户指南](agent-user-guide.md)。\r \r 使用 SSH 连接到 VM 并运行命令以取消预配 VM。 使用 `+user` 参数还会删除上次预配的用户帐户以及任何关联的数据。 将示例 IP 地址替换为 VM 的公共 IP 地址。\r \r 通过 SSH 连接到 VM。\r ```bash\r ssh azureuser@52.174.34.95\r ```\r 取消预配 VM。\r \r ```bash\r sudo waagent -deprovision+user -force\r ```\r 关闭 SSH 会话。\r \r ```bash\r exit\r ```\r \r ### <a name=\"deallocate-and-mark-the-vm-as-generalized\"></a>解除分配 VM 并将其标记为通用化\r \r 若要创建映像，需要解除分配 VM。 使用 [az vm deallocate](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#deallocate) 解除分配 VM。 \r \r ```azurecli \r az vm deallocate --resource-group myResourceGroup --name myVM\r ```\r \r 最后，使用 [az vm generalize](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#generalize) 将 VM 的状态设置为“通用化”，以便 Azure 平台知道 VM 已通用化。 只能从通用化 VM 创建映像。\r \r ```azurecli \r az vm generalize --resource-group myResourceGroup --name myVM\r ```\r \r ### <a name=\"create-the-image\"></a>创建映像\r \r 现在，可使用 [az image create](https://docs.azure.cn/zh-cn/cli/image?view=azure-cli-latest#create) 创建 VM 的映像。 以下示例从名为 myVM 的 VM 创建名为 myImage 的映像。\r \r ```azurecli \r az image create \\\r     --resource-group myResourceGroup \\\r     --name myImage \\\r     --source myVM\r ```\r \r ## <a name=\"create-vms-from-the-image\"></a>从映像创建 VM\r \r 现在，你已有了一个映像，可以使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 从该映像创建一个或多个新 VM。 以下示例从名为 myImage 的映像创建名为 myVMfromImage 的 VM。\r \r ```azurecli \r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVMfromImage \\\r     --image myImage \\\r     --admin-username azureuser \\\r     --generate-ssh-keys\r ```\r \r ## <a name=\"image-management\"></a>映像管理 \r \r 下面是一些常见映像管理任务的示例，说明了如何使用 Azure CLI 完成这些任务。\r \r 以表格格式按名称列出所有映像。\r \r ```azurecli \r az image list \\\r   --resource-group myResourceGroup\r ```\r \r 删除映像。 此示例将从 myResourceGroup 中删除名为 myOldImage 的映像。\r \r ```azurecli \r az image delete \\\r     --name myOldImage \\\r     --resource-group myResourceGroup\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 在本教程中，你已创建了一个自定义 VM 映像。 你已了解如何：\r \r > [!div class=\"checklist\"]\r > * 取消预配和通用化 VM\r > * 创建自定义映像\r > * 从自定义映像创建 VM\r > * 列出订阅中的所有映像\r > * 删除映像\r \r 请转到下一教程，了解高度可用的虚拟机。\r \r > [!div class=\"nextstepaction\"]\r > [创建高度可用的 VM](tutorial-availability-sets.md)。\r \r <!--Update_Description: update meta properties-->"}