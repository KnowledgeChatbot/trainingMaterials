{"Title":"以编程方式监视流分析中的作业","Description":"了解如何以编程方式监视通过 REST API、Azure SDK 或 PowerShell 创建的流分析作业。","Content":"# <a name=\"programmatically-create-a-stream-analytics-job-monitor\"></a>以编程方式创建流分析作业监视器\r \r 本文说明如何对流分析作业启用监视功能。 通过 REST API、Azure SDK 或 PowerShell 创建的流分析作业默认不启用监视功能。 可以在 Azure 门户中手动启用此功能，只需转到作业的“监视”页并单击“启用”按钮即可；也可以按本文中所述步骤自动执行此过程。 流分析作业的监视数据会显示在 Azure 门户的“指标”区域。\r \r ## <a name=\"prerequisites\"></a>先决条件\r \r 在开始此过程之前，必须具备以下条件：\r \r * Visual Studio 2017 或 2015\r * 已下载并安装了 [Azure.NET SDK](https://www.azure.cn/downloads/)\r * 需要已启用监视功能的现有流分析作业\r \r ## <a name=\"create-a-project\"></a>创建一个项目\r \r 1. 创建 Visual Studio C# .NET 控制台应用程序。\r 2. 在程序包管理器控制台中运行以下命令来安装 NuGet 包。 第一个是 Azure 流分析管理 .NET SDK。 第二个是 Azure Monitor SDK，将用于启用监视功能。 最后一个是用于进行身份验证的 Azure Active Directory 客户端。\r \r     ```\r     Install-Package Microsoft.Azure.Management.StreamAnalytics\r     Install-Package Microsoft.Azure.Insights -Pre\r     Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory\r     ```\r 3. 将下面的 appSettings 部分添加到 App.config 文件。\r \r     ```\r     <appSettings>\r        <!--CSM Prod related values-->\r        <add key=\"ResourceGroupName\" value=\"RESOURCE GROUP NAME\" />\r        <add key=\"JobName\" value=\"YOUR JOB NAME\" />\r        <add key=\"StorageAccountName\" value=\"YOUR STORAGE ACCOUNT\"/>\r        <add key=\"ActiveDirectoryEndpoint\" value=\"https://login.chinacloudapi.cn/\" />\r        <add key=\"ResourceManagerEndpoint\" value=\"https://management.chinacloudapi.cn/\" />\r        <add key=\"WindowsManagementUri\" value=\"https://management.core.chinacloudapi.cn/\" />\r        <add key=\"AsaClientId\" value=\"1950a258-227b-4e31-a9cf-717495945fc2\" />\r        <add key=\"RedirectUri\" value=\"urn:ietf:wg:oauth:2.0:oob\" />\r        <add key=\"SubscriptionId\" value=\"YOUR AZURE SUBSCRIPTION ID\" />\r        <add key=\"ActiveDirectoryTenantId\" value=\"YOUR TENANT ID\" />\r     </appSettings>\r     ```\r     将 *SubscriptionId* 和 *ActiveDirectoryTenantId* 的值替换为 Azure 订阅 ID 和租户 ID。 可以通过运行以下 PowerShell cmdlet 来获取这些值：\r \r     ```\r     Get-AzureAccount\r     ```\r 4. 将以下 using 语句添加到项目中的源文件 (Program.cs)。\r \r     ```\r     using System;\r     using System.Configuration;\r     using System.Threading;\r     using Microsoft.Azure;\r     using Microsoft.Azure.Management.Insights;\r     using Microsoft.Azure.Management.Insights.Models;\r     using Microsoft.Azure.Management.StreamAnalytics;\r     using Microsoft.Azure.Management.StreamAnalytics.Models;\r     using Microsoft.IdentityModel.Clients.ActiveDirectory;\r     ```\r \r 5. 添加一个身份验证帮助器方法。\r \r     ```\r     public static string GetAuthorizationHeader()\r \r     {\r          AuthenticationResult result = null;\r          var thread = new Thread(() =>\r          {\r              try\r              {\r                  var context = new AuthenticationContext(\r                      ConfigurationManager.AppSettings[\"ActiveDirectoryEndpoint\"] +\r                      ConfigurationManager.AppSettings[\"ActiveDirectoryTenantId\"]);\r \r                  result = context.AcquireToken(\r                      resource: ConfigurationManager.AppSettings[\"WindowsManagementUri\"],\r                      clientId: ConfigurationManager.AppSettings[\"AsaClientId\"],\r                      redirectUri: new Uri(ConfigurationManager.AppSettings[\"RedirectUri\"]),\r                      promptBehavior: PromptBehavior.Always);\r              }\r              catch (Exception threadEx)\r              {\r                  Console.WriteLine(threadEx.Message);\r              }\r          });\r \r          thread.SetApartmentState(ApartmentState.STA);\r          thread.Name = \"AcquireTokenThread\";\r          thread.Start();\r          thread.Join();\r \r          if (result != null)\r          {\r              return result.AccessToken;\r          }\r \r          throw new InvalidOperationException(\"Failed to acquire token\");\r     }\r     ```\r \r ## <a name=\"create-management-clients\"></a>创建管理客户端\r \r 以下代码可设置必需变量和管理客户端。\r \r     string resourceGroupName = \"<YOUR AZURE RESOURCE GROUP NAME>\";\r     string streamAnalyticsJobName = \"<YOUR STREAM ANALYTICS JOB NAME>\";\r \r     // Get authentication token\r     TokenCloudCredentials aadTokenCredentials =\r         new TokenCloudCredentials(\r             ConfigurationManager.AppSettings[\"SubscriptionId\"],\r             GetAuthorizationHeader());\r \r     Uri resourceManagerUri = new\r     Uri(ConfigurationManager.AppSettings[\"ResourceManagerEndpoint\"]);\r \r     // Create Stream Analytics and Insights management client\r     StreamAnalyticsManagementClient streamAnalyticsClient = new\r     StreamAnalyticsManagementClient(aadTokenCredentials, resourceManagerUri);\r     InsightsManagementClient insightsClient = new\r     InsightsManagementClient(aadTokenCredentials, resourceManagerUri);\r \r ## <a name=\"enable-monitoring-for-an-existing-stream-analytics-job\"></a>为现有流分析作业启用监视功能\r \r 以下代码为**现有**流分析作业启用监视功能。 代码的第一部分针对流分析服务执行 GET 请求，目的是检索特定流分析作业的信息。 它使用“Id”属性（从 GET 请求检索而得）作为代码第二部分中 Put 方法的参数，目的是将 PUT 请求发送到 Insights 服务以为流分析作业启用监视功能。\r \r > [!WARNING]\r > 如果此前为其他流分析作业启用了监视功能，那么不管是通过 Azure 门户进行还是通过以下代码以编程方式完成，**我们都建议提供在之前启用监视功能时所使用的同一个存储帐户名称。**\r > \r > 存储帐户将链接到创建流分析作业时所在的区域，并不特定于作业本身。\r > \r > 该同一区域中的所有流分析作业（以及所有其他 Azure 资源）在存储监视数据时将共享此存储帐户。 如果提供其他存储帐户，则可能会产生意想不到的副作用，这将影响对其他流分析作业或其他 Azure 资源的监视。\r > \r > 用于替换以下代码中的 `<YOUR STORAGE ACCOUNT NAME>` 的存储帐户名称应该是为其启用监视功能的流分析作业所在的同一订阅中的存储帐户。\r > \r > \r \r     // Get an existing Stream Analytics job\r     JobGetParameters jobGetParameters = new JobGetParameters()\r     {\r         PropertiesToExpand = \"inputs,transformation,outputs\"\r     };\r     JobGetResponse jobGetResponse = streamAnalyticsClient.StreamingJobs.Get(resourceGroupName, streamAnalyticsJobName, jobGetParameters);\r \r     // Enable monitoring\r     ServiceDiagnosticSettingsPutParameters insightPutParameters = new ServiceDiagnosticSettingsPutParameters()\r     {\r             Properties = new ServiceDiagnosticSettings()\r             {\r                 StorageAccountName = \"<YOUR STORAGE ACCOUNT NAME>\"\r             }\r     };\r     insightsClient.ServiceDiagnosticSettingsOperations.Put(jobGetResponse.Job.Id, insightPutParameters);\r \r ## <a name=\"get-support\"></a>获取支持\r \r 如需更多帮助，请尝试访问我们的 [Azure 流分析论坛](https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureStreamAnalytics)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r * [Azure 流分析简介](stream-analytics-introduction.md)\r * [Azure 流分析入门](stream-analytics-real-time-fraud-detection.md)\r * [缩放 Azure 流分析作业](stream-analytics-scale-jobs.md)\r * [Azure 流分析查询语言参考](https://msdn.microsoft.com/library/azure/dn834998.aspx)\r * [Azure 流分析管理 REST API 参考](https://msdn.microsoft.com/library/azure/dn835031.aspx)\r \r <!--Update_Description: wording update -->"}