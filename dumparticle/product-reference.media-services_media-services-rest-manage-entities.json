{"Title":"使用 REST 管理媒体服务实体","Description":"了解如何使用 REST API 管理媒体服务实体。","Content":"# <a name=\"managing-media-services-entities-with-rest\"></a>使用 REST 管理媒体服务实体 \r > [!div class=\"op_single_selector\"]\r > * [REST](media-services-rest-manage-entities.md)\r > * [.NET](media-services-dotnet-manage-entities.md)\r > \r > \r \r Azure 媒体服务是一项以 OData v3 为基础的基于 REST 的服务。 可以像在任何其他 OData 服务上一样添加、查询、更新和删除实体。 适用时，标注例外情况。 有关 OData 的详细信息，请参阅 [开放数据协议文档](http://www.odata.org/documentation/)。\r \r 本主题介绍如何使用 REST 管理 Azure 媒体服务实体。\r \r >[!NOTE]\r > 从 2017 年 4 月 1 日开始，用户帐户中任何超过 90 天的作业记录及其关联的任务记录都会被系统自动删除，即使记录总数低于最大配额。 例如，在 2017 年 4 月 1 日，用户帐户中 2016 年 12 月 31 日以前的任何作业记录都会被系统自动删除。 若需存档作业/任务信息，可使用本主题所述代码。\r \r ## <a name=\"considerations\"></a>注意事项  \r \r 访问媒体服务中的实体时，必须在 HTTP 请求中设置特定标头字段和值。 有关详细信息，请参阅[媒体服务 REST API 开发的设置](media-services-rest-how-to-use.md)。\r \r ## <a name=\"connect-to-media-services\"></a>连接到媒体服务\r \r 若要了解如何连接到 AMS API，请参阅[通过 Azure AD 身份验证访问 Azure 媒体服务 API](media-services-use-aad-auth-to-access-ams-api.md)。 \r \r \r \r ## <a name=\"adding-entities\"></a>添加实体\r 媒体服务中的每个实体都通过 POST HTTP 请求添加到实体集（如资产）中。\r \r 以下示例说明了如何创建 AccessPolicy。\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/API/AccessPolicies HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337067658&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=dithjGvlXR9HlyAf5DE99N5OCYkPAxsHIcsTSjm9%2fVE%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 74\r Expect: 100-continue\r \r {\"Name\": \"DownloadPolicy\", \"DurationInMinutes\" : \"300\", \"Permissions\" : 1}\r ```\r \r ##<a name=\"querying-entities\"></a>查询实体\r \r 查询和列出实体非常简单，仅涉及 GET HTTP 请求和可选的 OData 操作。\r 以下示例会检索包含所有 MediaProcessor 实体的列表。\r \r ```\r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/MediaProcessors HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337078831&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=suFkxhvPWxQVMjOYelOJfYEWkyTWJCBc02pF0N7NghI%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r ```\r \r 也可检索特定实体或与特定实体关联的所有实体集，如以下示例所示：\r \r ```\r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/JobTemplates('nb:jtid:UUID:e81192f5-576f-b247-b781-70a790c20e7c') HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1336907474&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=OpuY0CeTylqFFcFaP4pKUVGesT4PGx4CP55zDf2zXnc%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r \r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/JobTemplates('nb:jtid:UUID:e81192f5-576f-b247-b781-70a790c20e7c')/TaskTemplates HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1336907474&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=OpuY0CeTylqFFcFaP4pKUVGesT4PGx4CP55zDf2zXnc%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r ```\r \r 以下示例仅返回所有作业的 State 属性。\r \r ```\r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/Jobs?$select=State HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337078831&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=suFkxhvPWxQVMjOYelOJfYEWkyTWJCBc02pF0N7NghI%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r ```\r \r 以下示例返回名为“SampleTemplate”的所有 JobTemplate。\r \r ```\r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/API/JobTemplates?$filter=startswith(Name,%20'SampleTemplate') HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337078831&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=suFkxhvPWxQVMjOYelOJfYEWkyTWJCBc02pF0N7NghI%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r ```\r \r > [!NOTE]\r > 媒体服务不支持 $expand 操作以及“LINQ 注意事项（WCF Data Services）”中所述的不受支持的 LINQ 方法。\r > \r > \r \r ## <a name=\"enumerating-through-large-collections-of-entities\"></a>枚举实体的大型集合\r 查询实体时，一次返回的实体数限制为 1000 个，因为公共 REST v2 将查询结果数限制为 1000 个。 使用 skip 和 top 枚举大型实体集合。 \r \r 以下示例说明如何使用 skip 和 top 来跳过前 2000 个作业并获取后 1000 个作业。  \r \r ```\r GET https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Jobs()?$skip=2000&$top=1000 HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337078831&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=suFkxhvPWxQVMjOYelOJfYEWkyTWJCBc02pF0N7NghI%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r ```\r \r ## <a name=\"updating-entities\"></a>更新实体\r 根据实体类型及其所处的状态，可以通过 PATCH、PUT 或 MERGE HTTP 请求更新该实体上的属性。 有关这些操作的详细信息，请参阅 [PATCH/PUT/MERGE](https://msdn.microsoft.com/library/dd541276.aspx)。\r \r 以下代码示例演示如何更新资产实体上的名称属性。\r \r ```\r MERGE https://wamsshaclus001rest-hs.chinacloudapp.cn/API/Assets('nb:cid:UUID:80782407-3f87-4e60-a43e-5e4454232f60') HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337083279&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=DMLQXWah4jO0icpfwyws5k%2b1aCDfz9KDGIGao20xk6g%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 21\r Expect: 100-continue\r \r {\"Name\" : \"NewName\" }\r ```\r \r ## <a name=\"deleting-entities\"></a>删除实体\r 可以使用 DELETE HTTP 请求在媒体服务中删除实体。 删除实体的顺序可能很重要，具体视实体而定。 例如，资产等实体要求先撤消（或删除）引用该特定资产的所有定位符，然后再删除资产。\r \r 以下示例演示如何删除用于将文件上传到 blob 存储的定位符。\r \r ```\r DELETE https://wamsshaclus001rest-hs.chinacloudapp.cn/API/Locators('nb:lid:UUID:76dcc8e8-4230-463d-97b0-ce25c41b5c8d') HTTP/1.1\r Content-Type: application/json;odata=verbose\r Accept: application/json;odata=verbose\r DataServiceVersion: 3.0\r MaxDataServiceVersion: 3.0\r x-ms-version: 2.11\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=youraccountname&urn%3aSubscriptionId=2f84471d-b1ae-4e75-aa09-010f0fc0cf5b&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1337067658&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=dithjGvlXR9HlyAf5DE99N5OCYkPAxsHIcsTSjm9%2fVE%3d\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 0\r ```\r <!--Update_Description: add \"Connect to Media Services\" section-->"}