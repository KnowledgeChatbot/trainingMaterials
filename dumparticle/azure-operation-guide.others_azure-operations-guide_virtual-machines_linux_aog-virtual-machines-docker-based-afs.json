{"Title":"创建基于 AFS 的 Docker 容器卷","Description":"创建基于 AFS 的 Docker 容器卷","Content":"\r # 创建基于 AFS 的 Docker 容器卷\r \r 标准的 Docker 容器卷一般是位于 Docker 主机上的一个本地目录。在这样的配置下，容器必须依赖于一台特定的主机，因此使得容器的迁移和扩展变得困难。通过使用容器卷插件，能让容器访问独立于主机的存储，使得迁移或者共享变得简单。\r \r Docker Volume Plugin for Azure File Storage 是 Microsoft 提供的容器共享存储解决方案。使用该插件，通过 SMB3.0 协议将 AFS 挂载到本地，Docker 就能够使用通过该插件驱动创建 Docker 容器卷。\r \r 目前 Docker Volume Plugin for Azure File Storage 仅支持 Ubuntu。更多信息和更新，请参见 [https://github.com/Azure/azurefile-dockervolumedriver](https://github.com/Azure/azurefile-dockervolumedriver) 。\r \r 在开始前，请确认您已经拥有一个共享出来的 AFS 和一个已经搭建好的 docker 虚拟机。登录到该虚拟机，切换到 root 账号。确认 cifs-utils 已经安装。\r \r ```\r # apt-get install cifs-utils\r ```\r \r 根据 Ubuntu 系统版本不同，配置方式稍有区别。Ubuntu14 及以下版本使用 upstart 模式；Ubuntu15 及以上版本使用 systemd 模式。\r \r ## Upstart 模式下的配置\r \r ```\r #wget -O azurefile-dockervolumedriver.conf https://raw.githubusercontent.com/Azure/azurefile-dockervolumedriver/master/contrib/init/upstart/azurefile-dockervolumedriver.conf\r #wget -O azurefile-dockervolumedriver.default https://raw.githubusercontent.com/Azure/azurefile-dockervolumedriver/master/contrib/init/upstart/azurefile-dockervolumedriver.default\r ```\r \r 其中 azurefile-dockervolumedriver.default 是 AFS 账号配置文件，您需要按照下面步骤修改存储链接后缀，并添加存储账号和密钥；azurefile-dockervolumedriver.conf 是服务启动配置文件。\r \r ###编辑 AFS 配置文件\r \r 取消 AZURE_STORAGE_BASE 的注释，并将 core.windows.net 替换成中国区的环境 core.chinacloudapi.cn；将 youraccount 和 yourkey 替换成对应的存储账号和密钥。\r \r ```\r # Configuration file for Azure File Service Docker Volume Driver.  \r #  \r # Required keys:  \r # - AF_ACCOUNT_NAME: Azure storage account name  \r # - AF_ACCOUNT_KEY:  Azure storage account key  \r #  \r # Customize location of executable (dev/test purposes):  \r # AF_CMD=/usr/local/bin/azurefile-dockervolumedriver  \r #  \r # Additional arguments to executable:  \r # AF_OPTS=--debug  \r AZURE_STORAGE_BASE= **core.chinacloudapi.cn**  \r \r AF_ACCOUNT_NAME= **youraccount**   \r AF_ACCOUNT_KEY= **yourkey**  \r #mv azurefile-dockervolumedriver.conf /etc/init/\t  \r #mv azurefile-dockervolumedriver.default /etc/default/azurefile-dockervolumedriver  \r ```\r \r ###安装插件\r \r 访问 [https://github.com/Azure/azurefile-dockervolumedriver/releases](https://github.com/Azure/azurefile-dockervolumedriver/releases)，选择您要使用的版本并下载到本地。建议使用最新版的插件。\r \r ```\r # wget -O /usr/bin/azurefile-dockervolumedriver https://github.com/Azure/azurefile-dockervolumedriver/releases/download/<font color=red>v0.5.1</font>/azurefile-dockervolumedriver  \r # chmod +x /usr/bin/azurefile-dockervolumedriver  \r # 使用 ls -al 或者 file 命令查看文件是否下载成功，且处于可执行状态。  \r # file /usr/bin/azurefile-dockervolumedriver  \r # 启动服务并检查服务状态  \r # initctl reload-configuration  \r # initctl start azurefile-dockervolumedriver  \r # initctl status azurefile-dockervolumedriver  \r ```\r \r ##<font color=darkblue>Systemd 模式下的配置</font>\r \r ###下载配置文件\r ```\r #wget -O azurefile-dockervolumedriver.default https://raw.githubusercontent.com/Azure/azurefile-dockervolumedriver/master/contrib/init/systemd/azurefile-dockervolumedriver.default\r \r #wget -O azurefile-dockervolumedriver.service https://raw.githubusercontent.com/Azure/azurefile-dockervolumedriver/master/contrib/init/systemd/azurefile-dockervolumedriver.service\r ```\r \r 其中 azurefile-dockervolumedriver.default 是 AFS 账号配置文件，您需要按照下面步骤修改存储链接后缀，并添加存储账号和密钥；azurefile-dockervolumedriver.service 是服务启动配置文件。\r \r ###编辑 AFS 配置文件\r 取消 AZURE_STORAGE_BASE 的注释，并将 core.windows.net 替换成中国区的环境 core.chinacloudapi.cn；将 youraccount 和 yourkey 替换成对应的存储账号和密钥。\r \r ```\r #vi azurefile-dockervolumedriver.default  \r # Environment file for azurefile-dockervolumedriver.service  \r #  \r # AF_OPTS=--debug  \r AZURE_STORAGE_BASE=**core.chinacloudapi.cn**\r \r AZURE_STORAGE_ACCOUNT=**youraccount**  \r AZURE_STORAGE_ACCOUNT_KEY=**yourkey**  \r \r # 将文件移动到正确的目录下面。\r \r # mv azurefile-dockervolumedriver.default /etc/default/azurefile-dockervolumedriver  \r # mv azurefile-dockervolumedriver.conf /etc/systemd/system/  \r ```\r \r ###安装插件\r 访问 [https://github.com/Azure/azurefile-dockervolumedriver/releases](https://github.com/Azure/azurefile-dockervolumedriver/releases)，选择您要使用的版本并下载到本地。建议使用最新版的插件。\r \r ```\r # wget -O /usr/bin/azurefile-dockervolumedriver https://github.com/Azure/azurefile-dockervolumedriver/releases/download/v0.5.1/azurefile-dockervolumedriver\r # chmod +x /usr/bin/azurefile-dockervolumedriver  \r # 使用 ls -al 或者 file 命令查看文件是否下载成功，且处于可执行状态。  \r # file /usr/bin/azurefile-dockervolumedriver\r ```\r \r ###加载服务\r 重新加载守护进程，使其识别到新添加的 azurefile-dockervolumedriver 服务。设置服务开机自启动，并启动服务。\r \r ```\r # systemctl daemon-reload  \r # systemctl enable azurefile-dockervolumedriver  \r # systemctl start azurefile-dockervolumedriver\r ```\r \r 使用 status 检查服务状态。Active(running) 表示服务启动成功；如果是其他状态，请根据错误信息进行错误排查，如确认配置文件的正确性；尝试其他版本的插件等。\r \r ```\r # systemctl status azurefile-dockervolumedriver  \r ● azurefile-dockervolumedriver.service - Azure File Service Docker Volume Driver  \r Loaded: loaded (/etc/systemd/system/azurefile-dockervolumedriver.service; disabled; vendor preset: enabled)  \r Active: active (running) since Sun 2016-09-18 05:50:08 UTC; 3s ago  \r  Docs: https://github.com/Azure/azurefile-dockervolumedriver/  \r Main PID: 38866 (azurefile-docke)  \r Tasks: 4  \r Memory: 860.0K  \r   CPU: 8ms  \r CGroup: /system.slice/azurefile-dockervolumedriver.service  \r        └─38866 /usr/bin/azurefile-dockervolumedriver  \r ```\r \r ##<font color=darkblue>创建和使用 Docker volume</font>\r 下面命令会在 docker 虚拟机上创建一个名为 myvol 的卷；同时，在您的 AFS 中，会创建一个名为 myvol 的文件服务。\r \r ```\r # docker volume create -d azurefile --name myvol -o share=myvol  \r myvol  \r # docker volume ls  \r DRIVER              VOLUME NAME  \r azurefile           myvol  \r ```\r \r 使用 volume 存放数据，实际上是通过 SMB 协议挂载共享文件夹，并将数据写入到共享文件夹中；因为 Linux 目前还不支持 SMB3.0，因此在使用 AFS 时，可能会有性能上的影响。\r \r 在创建 volume 的过程中，azurefile 驱动支持的可选参数如下，这其实与通过 mount.cifs 挂载 AFS 的选项相关。\r \r ```\r -o share=sharename #在 portal 中看到的 AFS share 的名字  \r -o uid=<uid>  \r -o gid=<gid>   \r -o filemode=0600   \r -o dirmode=0755   \r -o nolock=true   \r -o remotepath=directory #  \r ```\r \r 通过该驱动创建的共享文件夹，默认 quota 是 5TB。您可能需要在 Azure portal 上去修改该 quota 值以适应您的需求。\r \r ![modify-Quota](./media/aog-virtual-machines-docker-based-afs/modify-Quota.png \"修改 AzurePortal 中的 Quota 值.png\")"}