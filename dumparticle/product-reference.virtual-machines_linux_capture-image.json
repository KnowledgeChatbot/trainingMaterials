{"Title":"如何创建虚拟机或 VHD 的映像","Description":"使用 Azure CLI 2.0 捕获 Azure VM 的映像以用于批量部署。","Content":"# <a name=\"how-to-create-an-image-of-a-virtual-machine-or-vhd\"></a>如何创建虚拟机或 VHD 的映像\r \r <!-- generalize, image - extended version of the tutorial-->\r \r 若要创建虚拟机 (VM) 的多个副本以用于 Azure 中，需要捕获 VM 或 OS VHD 的映像。 若要创建映像，需要删除个人帐户信息，这使得多次部署更加安全。 执行下列步骤可取消预配现有 VM，解除分配并创建映像。 可以使用此映像，在订阅内的任何资源组中创建 VM。\r \r 如果想要创建一份现有 Linux VM 的副本以用于备份或调试，或从本地 VM 上传专用 Linux VHD，请参阅[上传自定义磁盘映像并根据该映像创建 Linux VM](upload-vhd.md)。  \r \r 还可使用 **Packer** 创建自定义配置。 有关使用 Packer 的详细信息，请参阅[如何使用 Packer 在 Azure 中创建 Linux 虚拟机映像](build-image-with-packer.md)。\r \r ## <a name=\"before-you-begin\"></a>开始之前\r 确保符合以下先决条件：\r \r * 需要使用托管磁盘在资源管理器部署模型中创建 Azure VM。 如果尚未创建 Linux VM，则可以使用[门户](quick-create-portal.md)、[Azure CLI](quick-create-cli.md) 或[资源管理器模板](create-ssh-secured-vm-from-template.md)。 根据需要配置 VM。 例如， [添加数据磁盘](add-disk.md)、应用更新和安装应用程序。 \r \r * 还需要安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r ## <a name=\"quick-commands\"></a>快速命令\r \r 有关本主题的用于测试、评估或了解 Azure 中的 VM 的简化版本，请参阅[使用 CLI 创建 Azure VM 的自定义映像](tutorial-custom-images.md)。\r \r ## <a name=\"step-1-deprovision-the-vm\"></a>步骤 1：取消预配 VM\r 使用 Azure VM 代理取消预配 VM 以删除计算机特定文件和数据。 在源 Linux VM 上，使用带 *-deprovision+user* 参数的 `waagent` 命令。 有关详细信息，请参阅 [Azure Linux 代理用户指南](../windows/agent-user-guide.md)。\r \r 1. 使用 SSH 客户端连接到 Linux VM。\r 2. 在 SSH 窗口中，键入以下命令：\r \r     ```bash\r     sudo waagent -deprovision+user\r     ```\r <br>\r    > [!NOTE]\r    > 仅在要捕获为映像的 VM 上运行此命令。 不保证映像中的所有敏感信息被清除，或者映像适合用于分发。 *+user* 参数还会删除上次预配的用户帐户。 如果想要在 VM 中保留帐户凭据，只需使用 *-deprovision* 就地保留用户帐户。\r \r 3. 键入 **y** 继续。 添加 **-force** 参数即可免除此确认步骤。\r 4. 完成该命令后，键入 **exit**。 此步骤将关闭 SSH 客户端。\r \r ## <a name=\"step-2-create-vm-image\"></a>步骤 2：创建 VM 映像\r 使用 Azure CLI 2.0 将 VM 标记为通用化并捕获映像。 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 *myResourceGroup*、*myVnet* 和 *myVM*。\r \r 1. 对使用 [az vm deallocate](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#deallocate) 取消设置的 VM 解除分配。 以下示例在名为 myResourceGroup 的资源组中解除分配名为 myVM 的 VM：\r \r     ```azurecli\r     az vm deallocate \\\r       --resource-group myResourceGroup \\\r       --name myVM\r     ```\r \r 2. 使用 [az vm generalize](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#generalize) 将 VM 标记为通用化。 以下示例将名为 *myResourceGroup* 的资源组中名为 *myVM* 的 VM 标记为通用化：\r \r     ```azurecli\r     az vm generalize \\\r       --resource-group myResourceGroup \\\r       --name myVM\r     ```\r \r 3. 现在，使用 [az image create](https://docs.azure.cn/zh-cn/cli/image?view=azure-cli-latest#create) 创建 VM 资源的映像。 以下示例使用名为 myVM 的 VM 资源在名为 myResourceGroup 的资源组中创建名为 myImage 的映像：\r \r     ```azurecli\r     az image create \\\r       --resource-group myResourceGroup \\\r       --name myImage --source myVM\r     ```\r \r    > [!NOTE]\r    > 该映像在与源 VM 相同的资源组中创建。 可以在订阅内的任何资源组中从此映像创建 VM。 从管理角度来看，你可能希望为 VM 资源和映像创建特定的资源组。\r \r ## <a name=\"step-3-create-a-vm-from-the-captured-image\"></a>步骤 3：从捕获的映像创建 VM\r 使用通过 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建的映像来创建 VM。 以下示例从名为 myImage 的映像创建名为 myVMDeployed 的 VM：\r \r ```azurecli\r az vm create \\\r    --resource-group myResourceGroup \\\r    --name myVMDeployed \\\r    --image myImage\\\r    --admin-username azureuser \\\r    --ssh-key-value ~/.ssh/id_rsa.pub\r ```\r \r ### <a name=\"creating-the-vm-in-another-resource-group\"></a>在另一个资源组中创建 VM \r \r 可在订阅内的任何资源组中根据映像创建 VM。 若要在与映像不同的资源组中创建 VM，请指定映像的完整资源 ID。 使用 [az image list](https://docs.azure.cn/zh-cn/cli/image?view=azure-cli-latest#list) 查看映像列表。 输出类似于以下示例：\r \r ```json\r \"id\": \"/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage\",\r    \"location\": \"chinanorth\",\r    \"name\": \"myImage\",\r ```\r \r 以下示例使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) ，通过指定映像资源 ID，在与源映像不同的资源组中创建 VM：\r \r ```azurecli\r az vm create \\\r    --resource-group myOtherResourceGroup \\\r    --name myOtherVMDeployed \\\r    --image \"/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage\" \\\r    --admin-username azureuser \\\r    --ssh-key-value ~/.ssh/id_rsa.pub\r ```\r \r ## <a name=\"step-4-verify-the-deployment\"></a>步骤 4：验证部署\r \r 现在将 SSH 连接到创建的虚拟机以验证部署并开始使用新的 VM。 若要通过 SSH 连接，请使用 [az vm show](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#show)查找 VM 的 IP 地址或 FQDN：\r \r ```azurecli\r az vm show \\\r    --resource-group myResourceGroup \\\r    --name myVMDeployed \\\r    --show-details\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r 可以从源 VM 映像创建多个 VM。 如果需要对映像进行更改，请执行以下操作： \r \r - 从映像创建 VM。\r - 进行任何更新或配置更改。\r - 再次执行相关步骤，对 VM 执行取消预配、解除分配、通用化和创建操作。\r - 将此新映像用于将来的部署。 如果需要，请删除原始映像。\r \r 有关使用 CLI 管理 VM 的详细信息，请参阅 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/overview?view=azure-cli-latest)。\r \r <!--Update_Description: wording update-->"}