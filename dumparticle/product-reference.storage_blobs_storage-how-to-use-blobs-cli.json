{"Title":"通过 Azure CLI 对 Azure Blob 存储（对象存储）执行操作","Description":"了解如何在 Azure Blob 存储中上传和下载 blob，以及如何构造共享访问签名 (SAS) 来管理对存储帐户中的 blob 的访问。","Content":"# <a name=\"perform-blob-storage-operations-with-azure-cli\"></a>通过 Azure CLI 对 Blob 存储执行操作\r \r Azure Blob 存储是用于存储大量非结构化对象数据（例如文本或二进制数据）的服务，这些数据可通过 HTTP 或 HTTPS 从世界各地进行访问。 本教程介绍 Azure Blob 存储中的基本操作，如上传、下载和删除 Blob。 你将学习如何执行以下操作：\r \r > [!div class=\"checklist\"]\r > * 创建容器\r > * 将文件 (blob) 上传到容器中\r > * 列出容器中的 Blob\r > * 从容器下载 Blob\r > * 在存储帐户之间复制 blob\r > * 删除 Blob\r > * 显示和修改 blob 属性和元数据\r > * 使用共享访问签名 (SAS) 管理安全性\r \r 本教程需要 Azure CLI 2.0.4 或更高版本。 运行 `az --version` 即可查找版本。 如果需要进行安装或升级，请参阅[安装 Azure CLI 2.0](https://docs.azure.cn/cli/install-azure-cli?view=azure-cli-latest)。 \r \r \r \r [!INCLUDE [storage-quickstart-tutorial-intro-include-cli](../../../includes/storage-quickstart-tutorial-intro-include-cli.md)]\r \r ## <a name=\"create-a-container\"></a>创建容器\r \r 容器类似于计算机上的目录，允许在容器中组织成组的 Blob，就好比在目录中组织文件。 一个存储帐户可以包含任意数目的容器。 一个容器中最多可以存储 500 TB 的 blob 数据，这是一个存储帐户可以存储的最大数据量。\r \r 可以使用 [az storage container create](https://docs.azure.cn/cli/storage/container#create?view=azure-cli-latest) 命令创建用于存储 blob 的容器。\r \r ```cli\r az storage container create --name mystoragecontainer\r ```\r \r 容器名称必须以字母或数字开头，并且只能包含字母、数字和连字符 (-)。 有关命名 Blob 和容器的更多规则，请参阅[命名和引用容器、Blob 和元数据](https://docs.microsoft.com/rest/api/storageservices/naming-and-referencing-containers--blobs--and-metadata)。\r \r ## <a name=\"enable-public-read-access-for-a-container\"></a>启用容器的公共读取权限\r \r 默认情况下，新创建的容器是专用容器。 也就是说，如果没有[共享访问签名](#create-a-shared-access-signature-sas)或存储帐户的访问密钥，就无法访问此容器。 使用 Azure CLI，可以通过将容器权限设置为以下三个级别之一来修改此行为：\r \r | | |\r |---|---|\r | `--public-access off` | （默认值）无公共读取访问权限 |\r | `--public-access blob` | 只有 Blob 的公共读取访问权限 |\r | `--public-access container` | Blob 的公共读取访问权限，可以列出容器中的 Blob |\r \r 设置 `blob` 或 `container` 的公共访问权限后，就为 Internet 上的所有人启用了只读访问权限。 例如，如果想要在网站上显示已存储为 blob 的图像，则需要启用公共读取访问权限。 如果想要启用读取/写入访问权限，必须改为使用[共享访问签名 (SAS)](#create-a-shared-access-signature-sas)。\r \r 可使用 [az storage container set-permission](https://docs.azure.cn/cli/storage/container#create?view=azure-cli-latest) 命令启用容器的公共读取访问权限。\r \r ```cli\r az storage container set-permission \\\r     --name mystoragecontainer \\\r     --public-access container\r ```\r \r ## <a name=\"upload-a-blob-to-a-container\"></a>将 Blob 上传到容器中\r \r Blob 存储支持块 blob、追加 blob 和页 blob。 块 blob 是 Azure 存储中存储的最常见 blob 类型。 在必须将数据添加到现有的 blob 中且不能修改该 blob 的现有内容时（例如进行日志记录时），使用追加 blob。 页 blob 支持 IaaS 虚拟机的 VHD 文件。\r \r 本示例使用 [az storage blob upload](https://docs.azure.cn/cli/storage/blob#upload?view=azure-cli-latest) 命令将 blob 上传到在上一个步骤中创建的容器中。\r \r ```cli\r az storage blob upload \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --file ~/path/to/local/file\r ```\r \r 此操作将创建 Blob（如果该 Blob 尚不存在），或者覆盖 Blob（如果该 Blob 已存在）。 上传几个文件，以便在后续步骤中列出 Blob 时可以看到多个条目。\r \r ## <a name=\"list-the-blobs-in-a-container\"></a>列出容器中的 Blob\r \r 使用 [az storage blob list](https://docs.azure.cn/cli/storage/blob#list?view=azure-cli-latest) 命令列出容器中的 blob。\r \r ```cli\r az storage blob list \\\r     --container-name mystoragecontainer \\\r     --output table\r ```\r \r 示例输出：\r \r ```\r Name            Blob Type      Length  Content Type              Last Modified\r --------------  -----------  --------  ------------------------  -------------------------\r ISSUE_TEMPLATE  BlockBlob         761  application/octet-stream  2017-04-21T18:29:50+00:00\r LICENSE         BlockBlob       18653  application/octet-stream  2017-04-21T18:28:50+00:00\r LICENSE-CODE    BlockBlob        1090  application/octet-stream  2017-04-21T18:29:02+00:00\r README.md       BlockBlob        6700  application/octet-stream  2017-04-21T18:27:33+00:00\r dir1/file1.txt  BlockBlob        6700  application/octet-stream  2017-04-21T18:32:51+00:00\r ```\r \r ## <a name=\"download-a-blob\"></a>下载 Blob\r \r 使用 [az storage blob download](https://docs.azure.cn/cli/storage/blob#download?view=azure-cli-latest) 命令下载在上一步中上传的 blob。\r \r ```cli\r az storage blob download \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --file ~/destination/path/for/file\r ```\r \r ## <a name=\"copy-a-blob-between-storage-accounts\"></a>在存储帐户之间复制 blob\r \r 可以在存储帐户和区域内或跨存储帐户和区域异步复制 Blob。\r \r 以下示例演示如何将一个存储帐户中的 Blob 复制到另一个存储帐户。 我们首先在源存储帐户中创建容器，并指定对其 blob 的公共读取访问权限。 接下来，将文件上传到该容器，最后，将 Blob 从该容器复制到目标存储帐户中的容器。\r \r 在本示例中，目标容器必须已存在于目标存储帐户中，复制操作才会成功。 此外，`--source-uri` 参数中指定的源 blob 必须包含共享访问签名 (SAS) 令牌，或可公开访问，如此示例所示。\r \r ```azurecli\r # Create container in source account\r az storage container create \\\r     --account-name sourceaccountname \\\r     --account-key sourceaccountkey \\\r     --name sourcecontainer \\\r     --public-access blob\r \r # Upload blob to container in source account\r az storage blob upload \\\r     --account-name sourceaccountname \\\r     --account-key sourceaccountkey \\\r     --container-name sourcecontainer \\\r     --file ~/path/to/sourcefile \\\r     --name sourcefile\r \r # Copy blob from source account to destination account (destcontainer must exist)\r az storage blob copy start \\\r     --account-name destaccountname \\\r     --account-key destaccountkey \\\r     --destination-blob destfile.png \\\r     --destination-container destcontainer \\\r     --source-uri https://sourceaccountname.blob.core.chinacloudapi.cn/sourcecontainer/sourcefile.png\r ```\r \r ## <a name=\"delete-a-blob\"></a>删除 Blob\r \r 可使用 [az storage blob delete](https://docs.azure.cn/cli/storage/blob#delete?view=azure-cli-latest) 命令从容器中删除 blob。\r \r ```cli\r az storage blob delete \\\r     --container-name mystoragecontainer \\\r     --name blobName\r ```\r \r ## <a name=\"display-and-modify-blob-properties-and-metadata\"></a>显示和修改 blob 属性和元数据\r \r 每个 blob 都有多个由服务定义的属性，可以使用 [az storage blob show](https://docs.azure.cn/cli//storage/blob#show?view=azure-cli-latest) 命令显示这些属性，其中包括名称、类型、长度等。 还可以使用 [az storage blob metadata update](https://docs.azure.cn/cli/storage/blob/metadata#update?view=azure-cli-latest) 命令为 blob 配置自己的属性及属性值。\r \r 本示例首先显示 blob 的由服务定义的属性，然后会使用两个属于我们自己的元数据属性更新该 blob。 最后使用 [az storage blob metadata show](https://docs.azure.cn/cli/storage/blob/metadata#show?view=azure-cli-latest) 命令显示 blob 的元数据属性及其值。\r \r ```cli\r # Show properties of a blob\r az storage blob show \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --output table\r \r # Set metadata properties of a blob (replaces all existing metadata)\r az storage blob metadata update \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --metadata \"key1=value1\" \"key2=value2\"\r \r # Show metadata properties of a blob\r az storage blob metadata show \\\r     --container-name mystoragecontainer \\\r     --name blobName\r ```\r \r ## <a name=\"create-a-shared-access-signature-sas\"></a>创建共享访问签名 (SAS)\r \r 共享访问签名 (SAS) 提供一种授予对存储帐户中对象的受限访问权限而不必公开你的存储帐户访问密钥的方法。 若要生成可实现访问专用资源的 URI，需要创建具有所需的权限及有效时间范围（有效期）的 SAS 令牌，然后将其作为查询字符串追加到资源的 URL，以此方式生成它的完整 SAS URI。 然后，拥有此 SAS URI（资源的 URL 与 SAS 令牌的组合）的所有人均可在该 SAS 令牌的有效期内访问它。 例如，你可能希望提供专用 Blob 2 分钟的读取权限，以便用户可以查看。\r \r 在后续步骤中，将禁用容器的公共访问权限、测试仅专用访问权限并生成和测试 SAS URI。\r \r ### <a name=\"disable-container-public-access\"></a>禁用容器公共访问权限\r \r 首先，将容器的访问级别设置为 `off`。 此设置将指定没有共享访问签名或存储帐户访问密钥就不能访问容器或其 blob。\r \r ```cli\r az storage container set-permission \\\r     --name mystoragecontainer \\\r     --public-access off\r ```\r \r ### <a name=\"verify-private-access\"></a>验证专用访问\r \r 若要验证是否没有对该容器中的 blob 的公共读取访问权限，请使用 [az storage blob url](https://docs.azure.cn/cli/storage/blob#url?view=azure-cli-latest) 命令获取其中一个 blob 的 URL。\r \r ```cli\r az storage blob url \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --output tsv\r ```\r \r 在私密浏览器窗口中导航到该 blob 的 URL。 你将看到 `ResourceNotFound` 错误，因为该 blob 是专用的，而你尚未加入共享访问签名。\r \r ### <a name=\"create-a-sas-uri\"></a>创建 SAS URI\r \r 现在我们创建允许访问该 blob 的 SAS URI。 在接下来的示例中，首先使用通过 [az storage blob url](https://docs.azure.cn/cli/storage/blob#url?view=azure-cli-latest) 获取的 blob URL 填充一个变量，然后使用通过 [az storage blob generate-sas](https://docs.azure.cn/cli/storage/blob#generate-sas?view=azure-cli-latest) 命令生成的 SAS 令牌填充另一个变量。 最后，通过串联这两个变量（由 `?` 查询字符串分隔符 分隔）输出该 blob 的完整 SAS URI。\r \r ```cli\r # Get UTC datetimes for SAS start and expiry (Example: 1994-11-05T13:15:30Z)\r sas_start=`date -u +'%Y-%m-%dT%H:%M:%SZ'`\r sas_expiry=`date -u +'%Y-%m-%dT%H:%M:%SZ' -d '+2 minute'`\r \r # Get the URL for the blob\r blob_url=`az storage blob url \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --output tsv`\r \r # Obtain a SAS token granting read (r) access between the\r # SAS start and expiry times\r sas_token=`az storage blob generate-sas \\\r     --container-name mystoragecontainer \\\r     --name blobName \\\r     --start $sas_start \\\r     --expiry $sas_expiry \\\r     --permissions r \\\r     --output tsv`\r \r # Display the full SAS URI for the blob\r echo $blob_url?$sas_token\r ```\r \r ### <a name=\"test-the-sas-uri\"></a>测试 SAS URI\r \r 在私密浏览器窗口中，导航到上一个代码段中使用 `echo` 命令显示的完整 SAS URI。 这次，你不会看到错误，而是可以查看或下载该 blob。\r \r 等待足够长的时间让 URL 过期（在本例中为 2 分钟），然后在另一个私密浏览器窗口中导航到该 URI。 现在你会看到 `AuthenticationFailed` 错误，因为 SAS 令牌已过期。\r \r ## <a name=\"clean-up-resources\"></a>清理资源\r \r 如果不再需要你的资源组中的任何一个资源（包括使用本教程创建的存储帐户及上传的任何一个 blob），可使用 [az group delete](https://docs.azure.cn/cli/group#delete?view=azure-cli-latest) 命令删除该资源组。\r \r ```cli\r az group delete --name myResourceGroup\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 此教程介绍了有关使用 Azure 存储中的 blob 的基础知识：\r \r > [!div class=\"checklist\"]\r > * 创建容器\r > * 将文件 (blob) 上传到容器中\r > * 列出容器中的 Blob\r > * 从容器下载 Blob\r > * 在存储帐户之间复制 blob\r > * 删除 Blob\r > * 显示和修改 blob 属性和元数据\r > * 使用共享访问签名 (SAS) 管理安全性\r \r 以下资源介绍了有关使用 Azure CLI 及使用存储帐户中的资源的其他信息。\r \r * Azure CLI\r   * [使用 Azure CLI 2.0 进行登录](https://docs.azure.cn/cli/authenticate-azure-cli?view=azure-cli-latest) - 了解使用 CLI 进行身份验证的不同方法，其中包括通过用于运行无人参与的 Azure CLI 脚本的[服务主体](https://docs.azure.cn/cli/authenticate-azure-cli#logging-in-with-a-service-principal?view=azure-cli-latest)进行的非交互式登录。\r   * [Azure CLI 2.0 命令参考](https://docs.azure.cn/cli/?view=azure-cli-latest)\r * Azure 存储资源管理器\r   * [Azure 存储资源管理器](../../vs-azure-tools-storage-manage-with-storage-explorer.md?toc=%2fstorage%2fblobs%2ftoc.json)是 Microsoft 免费提供的独立应用，适用于在 Windows、macOS 和 Linux 上以可视方式处理 Azure 存储数据。\r "}