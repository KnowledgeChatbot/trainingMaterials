{"Title":"使用 Azure PowerShell 配置文件上传","Description":"如何使用 Azure PowerShell cmdlet 配置 IoT 中心，以便从连接的设备上传文件。 包括有关配置目标 Azure 存储帐户的信息。","Content":"# <a name=\"configure-iot-hub-file-uploads-using-powershell\"></a>使用 PowerShell 配置 IoT 中心文件上传\r \r [!INCLUDE [iot-hub-file-upload-selector](../../includes/iot-hub-file-upload-selector.md)]\r \r 要使用 [IoT 中心的文件上传功能][lnk-upload]，必须先将 Azure 存储帐户与 IoT 中心关联。 可以使用现有存储帐户，也可以创建新的存储帐户。\r \r 若要完成本教程，需要以下各项：\r \r * 有效的 Azure 帐户。 如果没有帐户，可以创建一个[试用帐户][lnk-free-trial]，只需几分钟即可完成。\r * [Azure PowerShell cmdlet][lnk-powershell-install]。\r * Azure IoT 中心。 如果没有 IoT 中心，可以使用 [New-AzureRmIoTHub cmdlet][lnk-powershell-iothub] 创建一个，或使用门户[创建 IoT 中心][lnk-portal-hub]。\r * 一个 Azure 存储帐户。 如果没有 Azure 存储帐户，可以使用 [Azure 存储 PowerShell cmdlet][lnk-powershell-storage] 创建一个，或使用门户[创建存储帐户][lnk-portal-storage]。\r \r ## <a name=\"sign-in-and-set-your-azure-account\"></a>登录并设置 Azure 帐户\r \r 登录到 Azure 帐户，并选择订阅。\r \r 1. 在 PowerShell 提示符下，运行 **Login-AzureRmAccount** cmdlet：\r \r     ```powershell\r     Login-AzureRmAccount -Environment $(Get-AzureRmEnvironment -Name AzureChinaCloud)\r     ```\r \r 1. 如果有多个 Azure 订阅，则访问 Azure 即有权访问与凭据关联的所有 Azure 订阅。 使用以下命令，列出可供使用的 Azure 订阅：\r \r     ```powershell\r     Get-AzureRMSubscription\r     ```\r \r     使用以下命令，选择想要用于运行命令以管理 IoT 中心的订阅。 可使用上一命令输出中的订阅名称或 ID：\r \r     ```powershell\r     Select-AzureRMSubscription `\r         -SubscriptionName \"{your subscription name}\"\r     ```\r \r ## <a name=\"retrieve-your-storage-account-details\"></a>检索存储帐户详细信息\r \r 以下步骤假设已使用 **Resource Manager** 部署模型而不**经典**部署模型创建了存储帐户。\r \r 若要从设备配置文件上传，需要 Azure 存储帐户的连接字符串。 存储帐户必须与 IoT 中心位于同一订阅中。 还需要存储帐户中 Blob 容器的名称。 使用以下命令检索存储帐户密钥：\r \r ```powershell\r Get-AzureRmStorageAccountKey `\r   -Name {your storage account name} `\r   -ResourceGroupName {your storage account resource group}\r ```\r \r 记下 **key1** 存储帐户密钥值。 在后续步骤中需要用到它。\r \r 可将现有的 Blob 容器用于文件上传，或新建一个容器：\r \r * 若要列出存储帐户中的现有 Blob 容器，请使用以下命令：\r \r     ```powershell\r     $ctx = New-AzureStorageContext `\r         -StorageAccountName {your storage account name} `\r         -StorageAccountKey {your storage account key}\r     Get-AzureStorageContainer -Context $ctx\r     ```\r \r * 若要在存储帐户中创建 Blob 容器，请使用以下命令：\r \r     ```powershell\r     $ctx = New-AzureStorageContext `\r         -StorageAccountName {your storage account name} `\r         -StorageAccountKey {your storage account key}\r     New-AzureStorageContainer `\r         -Name {your new container name} `\r         -Permission Off `\r         -Context $ctx\r     ```\r \r ## <a name=\"configure-your-iot-hub\"></a>配置 IoT 中心\r \r 现在可以配置 IoT 中心启用[文件上传功能][lnk-upload]使用存储帐户详细信息。\r \r 配置需要以下值：\r \r **存储容器**：当前 Azure 订阅中要与 IoT 中心关联的 Azure 存储帐户中的 Blob 容器。 检索在上一部分中必要的存储帐户信息。 IoT 中心会自动生成对此 Blob 容器具有写入权限的 SAS URI，以供设备上传文件时使用。\r \r **接收已上传文件的通知**：启用或禁用文件上传通知。\r \r **SAS TTL**：此设置是 IoT 中心返回给设备的 SAS URI 生存时间。 默认设置为一小时。\r \r **文件通知设置默认 TTL**：文件上传通知到期前的生存时间。 默认设置为一天。\r \r **文件通知最大传送数**：IoT 中心将尝试传送文件上传通知的次数。 默认设置为 10。\r \r 使用以下 PowerShell cmdlet 在 IoT 中心内配置上传文件设置：\r \r ```powershell\r Set-AzureRmIotHub `\r     -ResourceGroupName \"{your iot hub resource group}\" `\r     -Name \"{your iot hub name}\" `\r     -FileUploadNotificationTtl \"01:00:00\" `\r     -FileUploadSasUriTtl \"01:00:00\" `\r     -EnableFileUploadNotifications $true `\r     -FileUploadStorageConnectionString \"DefaultEndpointsProtocol=https;AccountName={your storage account name};AccountKey={your storage account key};EndpointSuffix=core.chinacloudapi.cn\" `\r     -FileUploadContainerName \"{your blob container name}\" `\r     -FileUploadNotificationMaxDeliveryCount 10\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 IoT 中心文件上传功能的详细信息，请参阅[从设备上传文件][lnk-upload]。\r \r 若要了解有关如何管理 Azure IoT 中心的详细信息，请参阅以下链接：\r \r * [批量管理 IoT 设备][lnk-bulk]\r * [IoT 中心指标][lnk-metrics]\r * [操作监视][lnk-monitor]\r \r 若要进一步探索 IoT 中心的功能，请参阅：\r \r * [IoT 中心开发人员指南][lnk-devguide]\r * [使用 Azure IoT Edge 将 AI 部署到边缘设备][lnk-iotedge]\r * [从根本上保护 IoT 解决方案][lnk-securing]\r \r [lnk-upload]: ./iot-hub-devguide-file-upload.md\r \r [lnk-bulk]: ./iot-hub-bulk-identity-mgmt.md\r [lnk-metrics]: ./iot-hub-metrics.md\r [lnk-monitor]: ./iot-hub-operations-monitoring.md\r \r [lnk-devguide]: ./iot-hub-devguide.md\r [lnk-iotedge]: ./iot-hub-linux-iot-edge-simulated-device.md\r [lnk-securing]: ./iot-hub-security-ground-up.md\r [lnk-powershell-install]: ../powershell-install-configure.md\r [lnk-powershell-storage]: https://docs.microsoft.com/powershell/module/azurerm.storage/\r [lnk-powershell-iothub]: https://docs.microsoft.com/powershell/module/azurerm.iothub/new-azurermiothub\r [lnk-portal-hub]: ./iot-hub-create-through-portal.md\r [lnk-free-trial]: https://www.azure.cn/pricing/1rmb-trial/\r [lnk-portal-storage]: ../storage/common/storage-create-storage-account.md\r \r <!--Update_Description: update meta data and wording-->"}