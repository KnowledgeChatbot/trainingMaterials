{"Title":"使用适用于 Linux 的 Azure CustomScript 扩展部署 LAMP 应用","Description":"了解如何在 Azure 中使用经典部署模型创建的 Linux 虚拟机使用 CustomScript 扩展部署应用程序。","Content":"# <a name=\"deploy-a-lamp-app-using-the-azure-customscript-extension-for-linux\"></a>使用适用于 Linux 的 Azure CustomScript 扩展部署 LAMP 应用\r > [!IMPORTANT] \r > Azure 提供两个不同的部署模型用于创建和处理资源：[Resource Manager 和经典模型](../../../resource-manager-deployment-model.md)。 本文介绍如何使用经典部署模型。 Azure 建议大多数新部署使用 Resource Manager 模型。 有关使用 Resource Manager 模型部署 LAMP 堆栈的信息，请参阅[此文](../tutorial-lamp-stack.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。\r \r 适用于 Linux 的 Azure CustomScript 扩展提供了一种方式来通过运行以 VM 支持的任何脚本语言（例如 Python 和 Bash）编写的任意代码来自定义虚拟机 (VM)。 这提供了一种非常灵活的方式将应用程序自动部署到多台计算机。\r \r 可以使用 Azure 门户、Windows PowerShell 或 Azure 命令行接口 (Azure CLI) 部署 CustomScript 扩展。\r \r 本文使用 Azure CLI 将一个简单的 LAMP 应用程序部署到使用经典部署模型创建的 Ubuntu VM。\r \r ## <a name=\"prerequisites\"></a>先决条件\r 在本示例中，请先创建两个运行 Ubuntu 14.04 或更高版本的 Azure VM。 VM 名为 *script-vm* 和 *lamp-vm*。 创建 VM 时请使用唯一名称。 其中一个 VM 用于运行 CLI 命令，另一个用于部署 LAMP 应用。\r \r 还可能需要 Azure 存储帐户和密钥（可以从 Azure 门户获取此信息）来访问该应用。\r \r 如果在 Azure 上创建 Linux VM 时需要帮助，请参阅[创建运行 Linux 的虚拟机](createportal.md)。\r \r 安装命令假设使用的是 Ubuntu，不过，可以针对任何受支持的 Linux 分发版改动安装。\r \r script-vm VM 需要使用与 Azure 之间的有效连接安装 Azure CLI。 有关这方面的帮助，请参阅 [Install and Configure the Azure Command-Line Interface](../../../cli-install-nodejs.md)（安装和配置 Azure 命令行接口）。\r \r ## <a name=\"upload-a-script\"></a>上传脚本\r 我们将使用 CustomScript 扩展在远程 VM 上运行脚本，以便安装 LAMP 堆栈并创建 PHP 页。 为了能够从任何位置访问脚本，我们将其上传作为 Azure blob。\r \r ### <a name=\"script-overview\"></a>脚本概述\r 脚本示例将 LAMP 堆栈安装到 Ubuntu（包括设置 MySQL 的无提示安装类）、编写简单的 PHP 文件并启动 Apache。\r \r     #!/bin/bash\r     # set up a silent install of MySQL\r     dbpass=\"mySQLPassw0rd\"\r \r     export DEBIAN_FRONTEND=noninteractive\r     echo mysql-server-5.6 mysql-server/root_password password $dbpass | debconf-set-selections\r     echo mysql-server-5.6 mysql-server/root_password_again password $dbpass | debconf-set-selections\r \r     # install the LAMP stack\r     apt-get -y install apache2 mysql-server php5 php5-mysql  \r \r     # write some PHP\r     echo \\<center\\>\\<h1\\>My Demo App\\</h1\\>\\<br/\\>\\</center\\> > /var/www/html/phpinfo.php\r     echo \\<\\?php phpinfo\\(\\)\\; \\?\\> >> /var/www/html/phpinfo.php\r \r     # restart Apache\r     apachectl restart\r \r ### <a name=\"upload-script\"></a>上传脚本\r 将脚本另存为文本文件，例如 *install_lamp.sh*，然后将其上传到 Azure 存储。 可以使用 Azure CLI 轻松执行此操作。 下例将文件上传到名为“scripts”的存储容器。 如果该容器不存在，则需要先创建它。\r \r     azure storage blob upload -a <yourStorageAccountName> -k <yourStorageKey> --container scripts ./install_lamp.sh\r \r 还要创建一个描述如何从 Azure 存储下载脚本的 JSON 文件。 将该文件另存为 *public_config.json*（使用存储帐户的名称替换“mystorage”）：\r \r     {\"fileUris\":[\"https://mystorage.blob.core.chinacloudapi.cn/scripts/install_lamp.sh\"], \"commandToExecute\":\"sh install_lamp.sh\" }\r \r ## <a name=\"deploy-the-extension\"></a>部署扩展\r 现在，可以在 Azure CLI 中使用下一条命令将 Linux CustomScript 扩展部署到远程 VM。\r \r     azure vm extension set -c \"./public_config.json\" lamp-vm CustomScript Microsoft.Azure.Extensions 2.0\r \r 上述命令在名为 *lamp-vm* 的 VM 上下载并运行 *install_lamp.sh* 脚本。\r \r 由于该应用包含 Web 服务器，因此请记得使用以下命令在远程 VM 上打开 HTTP 侦听端口。\r \r     azure vm endpoint create -n Apache -o tcp lamp-vm 80 80\r \r ## <a name=\"monitoring-and-troubleshooting\"></a>监视和故障排除\r 可以通过查看远程 VM 上的日志文件来检查自定义脚本的运行情况。 通过 SSH 连接到 *lamp-vm*，使用下一条命令显示日志的尾部。\r \r     cd /var/log/azure/customscript\r     tail -f handler.log\r \r 运行 CustomScript 扩展后，可以浏览到创建的 PHP 页获取信息。 本文中的示例 PHP 页是 *http://lamp-vm.chinacloudapp.cn/phpinfo.php*。\r \r ## <a name=\"additional-resources\"></a>其他资源\r 可以使用相同的基本步骤部署更复杂的应用。 在此示例中，安装脚本作为公共 blob 保存在 Azure 存储中。 比较安全的选择是使用[安全访问签名](https://msdn.microsoft.com/library/azure/ee395415.aspx) (SAS) 将安装脚本存储为安全 Blob。\r \r 下面列出了 Azure CLI、Linux 和 CustomScript 扩展的其他资源。\r \r [使用 CustomScript 扩展自动执行 Linux VM 自定义任务](https://azure.microsoft.com/blog/2014/08/20/automate-linux-vm-customization-tasks-using-customscript-extension/)\r \r [Azure Linux 扩展 (GitHub)](https://github.com/Azure/azure-linux-extensions)\r <!--Update_Description: update links-->\r "}