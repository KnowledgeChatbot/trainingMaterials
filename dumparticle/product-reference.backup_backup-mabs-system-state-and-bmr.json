{"Title":"Azure 备份服务器保护系统状态并将计算机还原成裸机","Description":"使用 Azure 备份服务器备份系统状态，并提供裸机恢复 (BMR) 保护。","Content":"# <a name=\"back-up-system-state-and-restore-to-bare-metal-with-azure-backup-server\"></a>使用 Azure 备份服务器备份系统状态，并将计算机还原成裸机\r \r Azure 备份服务器备份系统状态，并提供裸机恢复 (BMR) 保护。\r \r -   系统状态备份：备份操作系统文件，以便在计算机启动时恢复，但系统文件和注册表会丢失。 系统状态备份包括：\r     - 域成员：启动文件、COM+ 类注册数据库、注册表\r     - 域控制器：Windows Server Active Directory (NTDS)、启动文件、COM+ 类注册数据库、注册表、系统卷 (SYSVOL)\r     - 运行群集服务的计算机：群集服务器元数据\r     - 运行证书服务的计算机：证书数据\r - 裸机备份：备份操作系统文件和关键卷上的所有数据（用户数据除外）。 根据定义，BMR 备份包括系统状态备份。 在计算机不会启动的情况下，如果必须彻底恢复，则可通过此备份获得保护。\r \r 下表总结了可以备份和恢复的内容。 若要详细了解可以通过系统状态和 BMR 进行保护的应用版本，请参阅 [Azure 备份服务器备份什么？](backup-mabs-protection-matrix.md)。\r \r |备份|问题|从 Azure 备份服务器备份恢复|从系统状态备份恢复|BMR|\r |----------|---------|---------------------------|------------------------------------|-------|\r |文件数据<br /><br />常规数据备份<br /><br />BMR/系统状态备份|丢失文件数据|Y|N|N|\r |文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|\r |文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失服务器（数据卷完整）|N|N|Y|\r |文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失服务器（数据卷丢失）|Y|否|是（BMR，随后对已备份文件数据进行常规恢复）|\r |SharePoint 数据：<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失站点、列表、列表项、文档|Y|N|N|\r |SharePoint 数据：<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|\r |SharePoint 数据：<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|灾难恢复|N|N|N|\r |Windows Server 2012 R2 Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 VM|Y|N|N|\r |Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|\r |Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 Hyper-V 主机（VM 完整）|N|N|Y|\r |Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 Hyper-V 主机（VM 丢失）|N|N|Y<br /><br />BMR，随后进行常规 Azure 备份服务器恢复|\r |SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失应用数据|Y|N|N|\r |SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|y|Y|\r |SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失服务器（数据库/事务日志完整）|N|N|Y|\r |SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失服务器（数据库/事务日志丢失）|N|N|Y<br /><br />BMR 恢复，随后进行常规 Azure 备份服务器恢复|\r \r ## <a name=\"how-system-state-backup-works\"></a>系统状态备份工作原理\r \r 当系统状态备份运行时，备份服务器会与 Windows Server 备份通信，请求对服务器的系统状态进行备份。 默认情况下，备份服务器和 Windows Server 备份会使用可用空间可用程度最高的驱动器。 有关该驱动器的信息保存在 PSDataSourceConfig.xml 文件中。 这是供 Windows Server 备份用来进行备份的驱动器。\r \r 可以自定义驱动器，供备份服务器用于系统状态备份。 在受保护的服务器上，转到 C:\\Program Files\\Microsoft Data Protection Manager\\MABS\\Datasources。 打开 PSDataSourceConfig.xml 文件进行编辑。 更改驱动器号的 \\<FilesToProtect\\> 值。 保存并关闭该文件。 如果存在设置为保护计算机系统状态的保护组，请运行一致性检查。 如果生成了警报，请在警报中选择“修改保护组”，然后完成向导的操作。 然后，再次运行一致性检查。\r \r 请注意，如果保护服务器位于群集中，则可能会选择群集驱动器作为可用空间最多的驱动器。 如果该驱动器的所有权已切换到另一节点，系统状态备份已运行，则该驱动器不可用，备份失败。 在这种情况下，请将 PSDataSourceConfig.xml 修改为指向本地驱动器。\r \r 接下来，Windows Server 备份在还原文件夹的根目录中创建名为 WindowsImageBackup 的文件夹。 Windows Server 备份创建备份以后，所有数据就会置于该文件夹中。 备份完成后，文件将传输到备份服务器计算机。 请注意以下信息：\r \r - 不会在完成备份或传输后清理该文件夹及其内容。 更准确地说，系统会保留该空间来完成下一次备份。\r - 每次进行备份都会创建该文件夹。 时间和日期戳反映了上次系统状态备份的时间。\r \r ## <a name=\"bmr-backup\"></a>BMR 备份\r \r 进行 BMR（包括系统状态备份）时，备份作业直接保存到备份服务器计算机上的共享中， 而不是保存到受保护服务器上的文件夹中。\r \r 备份服务器调用 Windows Server 备份，并共享该 BMR 备份的副本卷。 在这种情况下，它不会要求 Windows Server 备份使用可用空间最多的驱动器， 而是使用为作业创建的共享。\r \r 备份完成后，文件将传输到备份服务器计算机。 日志存储在 C:\\Windows\\Logs\\WindowsServerBackup 中。\r \r ## <a name=\"prerequisites-and-limitations\"></a>先决条件和限制\r \r -   运行 Windows Server 2003 或客户端操作系统的计算机不支持 BMR。\r \r -   不能在不同保护组中对同一计算机实施 BMR 和系统状态保护。\r \r -   备份服务器计算机不能在 BMR 时进行自我保护。\r \r -   BMR 时，不支持通过备份到磁带（磁盘到磁带，简称 D2T）进行短期保护。 支持长期存储到磁带（磁盘到磁盘再到磁带，简称 D2D2T）。\r \r -   若要进行 BMR 保护，必须将 Windows Server 备份安装在受保护计算机上。\r \r -   进行 BMR 保护时，备份服务器对受保护计算机没有任何空间要求，这一点与进行系统状态保护不同。 Windows Server 备份直接将备份传输到备份服务器计算机。 备份传输作业不显示在备份服务器的“作业”视图中。\r \r -   备份服务器在 BMR 的副本卷上保留 30 GB 的空间。 可以在“修改保护组”向导的“磁盘分配”页中更改此设置，也可以通过 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet 来进行。 在恢复点卷上，BMR 保护需要大约 6 GB 的空间对内容保留五天的时间。\r     - 请注意，不能将副本卷大小降到 15 GB 以下。\r     - 备份服务器不计算 BMR 数据源的大小， 而是对所有服务器都假定一个 30 GB 的大小。 请根据环境中预期会进行的 BMR 备份的大小更改此值。 粗略进行计算的话，BMR 备份的大小就是所有关键卷上已使用空间之和。 关键卷 = 启动卷 + 系统卷 + 托管系统状态数据的卷，例如 Active Directory。\r \r -   如果从系统状态保护更改为 BMR 保护，则 BMR 保护在恢复点卷上需要较少的空间， 但系统不会回收该卷上的多余空间。 可以在“修改保护组”向导的“修改磁盘分配”页中手动缩减卷大小，也可以通过 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet 来进行。\r \r     如果从系统状态保护更改为 BMR 保护，则 BMR 保护在副本卷上需要较多的空间， 系统会自动扩展该卷。 若要更改默认的空间分配，请使用 Modify-DiskAllocation PowerShell cmdlet。\r \r -   如果从 BMR 保护更改为系统状态保护，则需要恢复点卷上有较多的空间。 备份服务器可能会尝试自动增大卷。 如果存储池中没有足够的空间，就会出错。\r \r     如果从 BMR 保护更改为系统状态保护，则需要受保护计算机上有空间。 这是因为，系统状态保护首先将副本写入本地计算机，然后再将它传输到备份服务器计算机。\r \r ## <a name=\"before-you-begin\"></a>开始之前\r \r 1.  部署 Azure 备份服务器。 验证备份服务器是否已正确部署。 有关详细信息，请参阅：\r     - [Azure 备份服务器的系统要求](http://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)\r     - [备份服务器保护矩阵](backup-mabs-protection-matrix.md)\r \r 2.  设置存储。 可以将备份数据存储在磁盘、磁带以及 Azure 云中。 有关详细信息，请参阅 [Prepare data storage](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)（准备数据存储）。\r \r 3.  设置保护代理。 在要备份的计算机上安装保护代理。 有关详细信息，请参阅 [Deploy the DPM protection agent](http://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)（部署 DPM 保护代理）。\r \r ## <a name=\"back-up-system-state-and-bare-metal\"></a>备份系统状态和裸机\r 按 [Deploy protection groups](http://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)（部署保护组）中的说明设置保护组。 请注意，不能在不同组中对同一计算机实施 BMR 和系统状态保护。 此外，在选择 BMR 时，会自动启用系统状态。\r \r \r 1.  若要在备份服务器管理员控制台中打开“创建新保护组”向导，请选择“保护” > “操作” > “创建保护组”。\r \r 2.  在“选择保护组类型”页上选择“服务器”，然后选择“下一步”。\r \r 3.  在“选择组成员”页上展开计算机，然后选择“BMR”或“系统状态”。\r \r     请记住，不能在不同组中对同一计算机实施 BMR 和系统状态保护。 此外，在选择 BMR 时，会自动启用系统状态。 有关详细信息，请参阅 [Deploy protection groups](http://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)（部署保护组）。\r \r 4.  在“选择数据保护方法”页上，选择要如何处理短期和长期备份。 短期备份始终先备份到磁盘，然后可以选择通过 Azure 备份从磁盘备份到 Azure 云（短期或长期）。 可以设置一种长期备份，备份到单独的磁带设备或连接到备份服务器的磁带库，替代长期备份到云。\r \r 5.  在“选择短期目标”页上，选择要如何备份到磁盘上的短期存储：\r     1. 对于“保留期”，请选择要将数据保留在磁盘上多长时间。 \r     2. 对于“同步频率”，请选择要在磁盘上运行增量备份的频率。 如果不想设置备份间隔，可选中“就在恢复点之前”选项。 备份服务器会刚好在计划每个恢复点之前运行快速的完整备份。\r \r 6.  若需将数据存储在磁带上进行长期存储，请在“指定长期目标”页上选择要保留磁带数据多长时间（1-99 年）。 \r     1. 对于“备份频率”，请选择运行到磁带的备份的频率。 频率取决于所选保留期：\r         - 如果保留期为 1-99 年，则可选择“每日”、“每周”、“每两周”、“每月”、“每季”、“每半年”或“每年”作为备份频率。\r         - 如果保留期为 1-11 月，则可选择“每日”、“每周”、“每两周”或“每月”作为备份频率。\r         - 如果保留期为 1-4 周，则可选择“每日”或“每周”作为备份频率。\r \r     2. 在“选择磁带和库详细信息”页上，选择要使用的磁带和库，以及是否应压缩和加密数据。\r \r 7.  在“查看磁盘分配”页上，查看为保护组分配的存储池磁盘空间。\r \r     1. “数据总大小”是要备份的数据的大小。\r     2. “要在 Azure 备份服务器上预配的磁盘空间”是备份服务器为保护组建议的空间。 备份服务器根据设置选择理想的备份卷。 但是，你可以在“磁盘分配详细信息”中编辑备份卷选项。 \r     3. 对于工作负荷，请在下拉菜单中选择首选存储。 编辑时，更改的是“可用磁盘存储”窗格中的“总存储”和“可用存储”值。 “预配不足的空间”是指备份服务器建议你添加到卷的存储量，目的是确保顺利备份。\r \r 8.  在“选择副本创建方法”页上，选择要如何处理初始的完整数据复制。 如果选择通过网络复制，则建议选择非高峰时间。 如果数据量很大或者网络状况欠佳，请考虑使用可移动介质脱机复制数据。\r \r 9. 在“选择一致性检查选项”页上，选择要如何自动执行一致性检查。 可以选择仅在副本数据变得不一致时运行检查，或者按计划运行检查。 如果不想配置自动一致性检查，可以随时运行手动检查。 若要运行手动检查，请在备份服务器管理员控制台的“保护”区域中，右键单击保护组，然后选择“执行一致性检查”。\r \r 10. 如果选择使用 Azure 备份来备份到云，则请在“指定联机保护数据”页上，确保选择要备份到 Azure 的工作负荷。\r \r 11. 在“指定联机备份计划”页上，选择增量备份到 Azure 的频率。 可以将备份计划为每日、每周、每月和每年运行，并选择相应的运行时间和日期。 备份一天最多可以进行两次。 每次备份运行时，会通过备份服务器磁盘上存储的备份数据的副本在 Azure 中创建数据恢复点。\r \r 12. 在“指定联机保留策略”页上，选择如何在 Azure 中保留通过每日、每周、每月和每年备份创建的恢复点。\r \r 13. 在“选择联机复制”页上，选择如何进行数据的初始完整复制。 可以通过网络复制，也可以执行脱机备份（脱机设定种子）。 脱机备份使用 Azure 导入功能。 有关详细信息，请参阅 [Azure 备份中的脱机备份工作流](backup-azure-backup-import-export.md)。\r \r 14. 在“摘要”页上，查看设置。 选择“创建组”之后，就会进行数据的初始复制。 数据复制完成后，在“状态”页上，保护组状态为“正常”。 备份随后按保护组设置进行。\r \r ## <a name=\"recover-system-state-or-bmr\"></a>恢复系统状态或 BMR\r 可以将 BMR 或系统状态恢复到网络位置。 如果备份了 BMR，则使用 Windows 恢复环境 (WinRE) 启动系统并将其连接到网络。 然后使用 Windows Server 备份从网络位置进行恢复。 如果备份了系统状态，则只需使用 Windows Server 备份从网络位置进行恢复。\r \r ### <a name=\"restore-bmr\"></a>还原 BMR\r 在备份服务器计算机上运行恢复：\r \r 1.  在“恢复”窗格中，找到要恢复的计算机，然后选择“裸机恢复”。\r \r 2.  可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。\r \r 3.  在“选择恢复类型”页上，选择“复制到网络文件夹”。\r \r 4.  在“指定目标”页上，选择要向其中复制数据的位置。 请记住，所选目标需要有足够的空间。 建议创建新文件夹。\r \r 5.  在“指定恢复选项”页上，选择要应用的安全设置。 然后，选择是否要使用基于存储区域网络 (SAN) 的硬件快照来加快恢复速度。 （仅当 SAN 提供此功能，并且能够通过创建和拆分克隆使其可写时，才使用此选项。 此外，受保护计算机和备份服务器计算机必须连接到同一网络。）\r \r 6.  设置通知选项。 在“确认”页上，选择“恢复”。\r \r 设置共享位置：\r \r 1.  在还原位置中，转到包含备份的文件夹。\r \r 2.  共享比 WindowsImageBackup 高一个级别的文件夹，使共享文件夹的根为 WindowsImageBackup 文件夹。 如果不这样做，还原会找不到备份。 若要使用 Windows 恢复环境 (WinRE) 进行连接，需要可以使用正确的 IP 地址和凭据在 WinRE 中访问的共享。\r \r 还原系统：\r \r 1.  通过对要还原的系统使用 Windows DVD，启动需在其上还原映像的计算机。\r \r 2.  在第一页上，验证语言和区域设置。 在“安装”页上，选择“修复计算机”。\r \r 3.  在“系统恢复选项”页上，选择“使用以前创建的系统映像还原计算机”。\r \r 4.  在“选择系统镜像备份”页上，选择“选择系统映像” > “高级” > “在网络上搜索系统映像”。 如果出现警告，请选择“是”。 转到共享路径，输入凭据，然后选择恢复点。 这会扫描在该恢复点中可用的特定备份。 选择要使用的恢复点。\r \r 5.  在“选择还原备份的方式”页上，选择“格式化并重新分区磁盘”。 在下一页上，验证设置。 \r \r 6.  若要开始还原，请选择“完成”。 需要重启。\r \r ### <a name=\"restore-system-state\"></a>还原系统状态\r \r 在备份服务器中运行恢复：\r \r 1.  在“恢复”窗格中，找到要恢复的计算机，然后选择“裸机恢复”。\r \r 2.  可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。\r \r 3.  在“选择恢复类型”页上，选择“复制到网络文件夹”。\r \r 4.  在“指定目标”页上，选择要向其中复制数据的位置。 请记住，所选目标需要足够空间。 建议创建新文件夹。\r \r 5.  在“指定恢复选项”页上，选择要应用的安全设置。 然后，选择是否要使用基于 SAN 的硬件快照来加快恢复速度。 （仅当 SAN 具有此功能，并且能够通过创建和拆分克隆使其可写时，才使用此选项。 此外，受保护计算机和备份服务器必须连接到同一网络。）\r \r 6.  设置通知选项。 在“确认”页上，选择“恢复”。\r \r 运行 Windows Server 备份：\r \r 1.  选择“操作” > “恢复” > “此服务器” > “下一步”。\r \r 2.  依次选择“另一台服务器”、“指定位置类型”页、“远程共享文件夹”。 输入包含恢复点的文件夹的路径。\r \r 3.  在“选择恢复类型”页上，选择“系统状态”。 \r \r 4. 在“选择系统状态恢复的位置”页上，选择“原始位置”。\r \r 5.  在“确认”页上，选择“恢复”。 还原之后，重启服务器。\r \r 6.  还可以在命令提示符处运行系统状态还原。 若要执行此操作，请在要恢复的计算机上启动 Windows Server 备份。 若要获取版本标识符，请在命令提示符处输入：```wbadmin get versions -backuptarget \\<servername\\sharename\\>```\r \r     使用版本标识符启动系统状态还原。 在命令提示符处，输入：```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\\sharename>```\r \r     确认要开始恢复。 可以在命令提示符窗口中查看过程。 将会创建还原日志。 还原之后，重启服务器。\r \r \r "}