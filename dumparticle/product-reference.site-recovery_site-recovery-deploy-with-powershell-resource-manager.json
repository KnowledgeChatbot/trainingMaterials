{"Title":"使用 PowerShell 和 Azure Resource Manager 复制 Hyper-V VM","Description":"在 PowerShell 和 Azure Resource Manager 中使用 Azure Site Recovery 将 Hyper-V VM 自动复制到 Azure。","Content":"# <a name=\"set-up-disaster-recovery-to-azure-for-hyper-v-vms-using-powershell-and-azure-resource-manager\"></a>使用 PowerShell 和 Azure 资源管理器对 Hyper-V VM 设置到 Azure 的灾难恢复\r \r [Azure Site Recovery](site-recovery-overview.md) 有助于业务连续性和灾难恢复 (BCDR) 策略，因为它可以协调 Azure 虚拟机 (VM)、本地 VM 和物理服务器的复制、故障转移和恢复。\r \r 本文介绍如何结合使用 Windows PowerShell 和 Azure 资源管理器将 Hyper-V VM 复制到 Azure。 本文中使用的示例演示如何将在 Hyper-V 主机上运行的单个 VM 复制到 Azure。\r \r ## <a name=\"overview\"></a>概述\r \r Azure PowerShell 提供用于通过 Windows PowerShell 管理 Azure 的 cmdlet。 Site Recovery PowerShell cmdlet 在 Azure PowerShell for Azure Resource Manager 中提供，可帮助你保护和恢复你在 Azure 中的服务器。\r \r 尽管无需成为一名 PowerShell 专家就可以使用本文章，但你还是需要理解诸如模块、cmdlet 和会话等基本概念。 请参阅 [Windows PowerShell 入门](http://technet.microsoft.com/library/hh857337.aspx)和[将 Azure PowerShell 与 Azure 资源管理器配合使用](../powershell-azure-resource-manager.md)。\r \r > [!NOTE]\r > 参与云解决方案提供商 (CSP) 计划的 Microsoft 合作伙伴可以根据各自的 CSP 订阅（租户订阅）对客户服务器的保护措施进行配置和管理。\r >\r >\r \r ## <a name=\"before-you-start\"></a>开始之前\r 确保已满足以下先决条件：\r \r * 一个 [Azure](https://www.azure.cn/) 帐户。 可以从[试用版](https://www.azure.cn/pricing/1rmb-trial/)开始。 此外，还可以参阅 [Azure Site Recovery Manager 定价](https://www.azure.cn/pricing/details/site-recovery/)。\r * Azure PowerShell 1.0。 若要深入了解此版本及其安装方法，请参阅 [Azure PowerShell 1.0。](../powershell-install-configure.md)\r * [AzureRM.SiteRecovery](https://www.powershellgallery.com/packages/AzureRM.SiteRecovery/) 和 [AzureRM.RecoveryServices](https://www.powershellgallery.com/packages/AzureRM.RecoveryServices/) 模块。 可以从 [PowerShell 库](https://www.powershellgallery.com/)\r \r 此外，本文中提及的特定示例要求满足以下先决条件：\r \r * 一台运行 Windows Server 2012 R2 或 Microsoft Hyper-V Server 2012 R2 的 Hyper-V 主机，其中包含一个或多个 VM。 Hyper-V 服务器应直接或通过代理连接到 Internet。\r * 要复制的 VM 应符合[这些先决条件](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)。\r \r ## <a name=\"step-1-sign-in-to-your-azure-account\"></a>步骤 1：登录到 Azure 帐户\r \r 1. 打开 PowerShell 控制台，并运行以下命令以登录到 Azure 帐户。 该 cmdlet 会打开一个网页，提示输入帐户凭据：**Login-AzureRmAccount -EnvironmentName AzureChinaCloud**。\r     - 或者，还可使用 -Credential 参数将帐户凭据作为参数包含在 **Login-AzureRmAccount -EnvironmentName AzureChinaCloud** cmdlet 中。\r     - 如果是代表租户的 CSP 合作伙伴，则需使用 tenantID 或租户主域名将客户指定为一名租户。 例如：**Login-AzureRmAccount -EnvironmentName AzureChinaCloud -Tenant \"fabrikam.com\"**\r 2. 一个帐户可以有多个订阅，因此请将需要使用的订阅与帐户关联在一起：\r \r     ```\r     Select-AzureRmSubscription -SubscriptionName $SubscriptionName\r     ```\r \r 3. 使用以下命令验证订阅是否已注册，以便将 Azure 提供程序用于恢复服务和 Site Recovery：\r \r     `Get-AzureRmResourceProvider -ProviderNamespace  Microsoft.RecoveryServices` `Get-AzureRmResourceProvider -ProviderNamespace  Microsoft.SiteRecovery`\r \r 4. 验证命令输出中是否将“RegistrationState”设置为“已注册”，如果是，则可继续执行步骤 2。 否则，需要通过运行以下命令注册订阅中缺失的提供程序：\r \r     `Register-AzureRmResourceProvider -ProviderNamespace Microsoft.SiteRecovery` `Register-AzureRmResourceProvider -ProviderNamespace Microsoft.RecoveryServices`\r \r 5. 使用以下命令验证提供程序是否已成功注册：\r \r     `Get-AzureRmResourceProvider -ProviderNamespace  Microsoft.RecoveryServices` `Get-AzureRmResourceProvider -ProviderNamespace  Microsoft.SiteRecovery`。\r \r ## <a name=\"step-2-set-up-the-vault\"></a>步骤 2：设置保管库\r \r 1. 创建一个可在其中创建保管库的 Azure 资源管理器资源组，或者使用现有资源组。 创建新资源组，如下所示。 $ResourceGroupName 变量包含需要创建的资源组的名称，$Geo 变量包含要在其中创建资源组的 Azure 区域（例如“中国北部”）。\r \r     `New-AzureRmResourceGroup -Name $ResourceGroupName -Location $Geo` \r \r 2. 若要获取订阅中的资源组列表，请运行 Get-AzureRmResourceGroup cmdlet。\r 3. 创建如下所示的新的 Azure 恢复服务保管库：\r \r     ```\r     $vault = New-AzureRmRecoveryServicesVault -Name <string> -ResourceGroupName <string> -Location <string>\r     ```\r \r     可使用 Get-AzureRmRecoveryServicesVault cmdlet 检索现有保管库的列表。\r \r ## <a name=\"step-3-set-the-recovery-services-vault-context\"></a>步骤 3：设置恢复服务保管库上下文\r \r 设置保管库上下文，如下所示：\r \r `Set-AzureRmSiteRecoveryVaultSettings -ARSVault $vault`\r \r ## <a name=\"step-4-create-a-hyper-v-site\"></a>步骤 4：创建 Hyper-V 站点\r \r 1. 创建新的 Hyper-V 站点，如下所示：\r \r     ```\r     $sitename = \"MySite\"                #Specify site friendly name\r     New-AzureRmSiteRecoverySite -Name $sitename\r     ```\r \r 2. 此 cmdlet 会启动一个创建该站点所需的站点恢复作业，并返回一个站点恢复作业对象。 等待作业完成，并验证作业已成功完成。\r 3. 使用 Get-AzureRmSiteRecoveryJob cmdlet 检索作业对象，并查看作业的当前状态。\r 4. 生成和下载站点的注册密钥，如下所示：\r \r     ```\r     $SiteIdentifier = Get-AzureRmSiteRecoverySite -Name $sitename | Select -ExpandProperty SiteIdentifier\r     Get-AzureRmRecoveryServicesVaultSettingsFile -Vault $vault -SiteIdentifier $SiteIdentifier -SiteFriendlyName $sitename -Path $Path\r     ```\r \r 5. 将已下载的密钥复制到 Hyper-V 主机。 需要通过该密钥将 Hyper-V 主机注册到站点。\r \r ## <a name=\"step-5-install-the-provider-and-agent\"></a>步骤 5：安装提供程序和代理\r \r 1. 从 [Microsoft](https://aka.ms/downloaddra) 下载最新版提供程序的安装程序。\r 2. 在 Hyper-V 主机上运行安装程序。\r 3. 在安装结束时继续执行注册步骤。\r 4. 在系统提示时提供下载的密钥，然后完成 Hyper-V 主机的注册过程。\r 5. 验证 Hyper-V 主机是否已注册到站点，如下所示：\r \r     ```\r     $server =  Get-AzureRmSiteRecoveryServer -FriendlyName $server-friendlyname\r     ```\r ## <a name=\"step-6-create-a-replication-policy\"></a>步骤 6：创建复制策略\r \r 在开始前，请注意指定的存储帐户应与保管库处于同一 Azure 区域，并且应已启用异地复制。\r \r 1. 创建复制策略，如下所示：\r \r     ```\r     $ReplicationFrequencyInSeconds = \"300\";     #options are 30,300,900\r     $PolicyName = \"replicapolicy\"\r     $Recoverypoints = 6                 #specify the number of recovery points\r     $storageaccountID = Get-AzureRmStorageAccount -Name \"mystorea\" -ResourceGroupName \"MyRG\" | Select -ExpandProperty Id\r \r     $PolicyResult = New-AzureRmSiteRecoveryPolicy -Name $PolicyName -ReplicationProvider \"HyperVReplicaAzure\" -ReplicationFrequencyInSeconds $ReplicationFrequencyInSeconds  -RecoveryPoints $Recoverypoints -ApplicationConsistentSnapshotFrequencyInHours 1 -RecoveryAzureStorageAccountId $storageaccountID\r     ```\r \r 2. 检查返回的作业，确保复制策略创建成功。\r \r 3. 检索对应于该站点的保护容器，如下所示：\r \r     ```\r     $protectionContainer = Get-AzureRmSiteRecoveryProtectionContainer\r     ```\r 4. 将保护容器与复制策略相关联，如下所示：\r \r     ```\r     $Policy = Get-AzureRmSiteRecoveryPolicy -FriendlyName $PolicyName\r     $associationJob  = Start-AzureRmSiteRecoveryPolicyAssociationJob -Policy $Policy -PrimaryProtectionContainer $protectionContainer\r     ```\r \r 5. 等待关联作业成功完成。\r \r ## <a name=\"step-7-enable-vm-protection\"></a>步骤 7：启用 VM 保护\r \r 1. 检索与要保护的 VM 相对应的保护实体，如下所示：\r \r     ```\r     $VMFriendlyName = \"Fabrikam-app\"                    #Name of the VM\r     $protectionEntity = Get-AzureRmSiteRecoveryProtectionEntity -ProtectionContainer $protectionContainer -FriendlyName $VMFriendlyName\r     ```\r 2. 保护 VM。 如果要保护的 VM 有多个附加磁盘，则需使用 *OSDiskName* 参数指定操作系统磁盘。\r \r     ```\r     $Ostype = \"Windows\"                                 # \"Windows\" or \"Linux\"\r     $DRjob = Set-AzureRmSiteRecoveryProtectionEntity -ProtectionEntity $protectionEntity -Policy $Policy -Protection Enable -RecoveryAzureStorageAccountId $storageaccountID  -OS $OStype -OSDiskName $protectionEntity.Disks[0].Name\r     ```\r \r 3. 等待 VM 在完成初始复制后进入受保护状态。 这可能需要一段时间，具体取决于诸如要复制的数据量和 Azure 的可用上游带宽等因素。 进入受保护状态后，更新作业状态和 StateDescription，如下所示： \r \r     ```\r     PS C:\\> $DRjob = Get-AzureRmSiteRecoveryJob -Job $DRjob\r \r     PS C:\\> $DRjob | Select-Object -ExpandProperty State\r     Succeeded\r \r     PS C:\\> $DRjob | Select-Object -ExpandProperty StateDescription\r     Completed\r     ```\r \r 4. 更新各种恢复属性，例如 VM 角色大小和进行故障转移时需要将虚拟机的网络接口卡连接到的 Azure 网络。\r \r     ```\r     PS C:\\> $nw1 = Get-AzureRmVirtualNetwork -Name \"FailoverNw\" -ResourceGroupName \"MyRG\"\r \r     PS C:\\> $VMFriendlyName = \"Fabrikam-App\"\r \r     PS C:\\> $VM = Get-AzureRmSiteRecoveryVM -ProtectionContainer $protectionContainer -FriendlyName $VMFriendlyName\r \r     PS C:\\> $UpdateJob = Set-AzureRmSiteRecoveryVM -VirtualMachine $VM -PrimaryNic $VM.NicDetailsList[0].NicId -RecoveryNetworkId $nw1.Id -RecoveryNicSubnetName $nw1.Subnets[0].Name\r \r     PS C:\\> $UpdateJob = Get-AzureRmSiteRecoveryJob -Job $UpdateJob\r \r     PS C:\\> $UpdateJob\r \r     Name             : b8a647e0-2cb9-40d1-84c4-d0169919e2c5\r     ID               : /Subscriptions/a731825f-4bf2-4f81-a611-c331b272206e/resourceGroups/MyRG/providers/Microsoft.RecoveryServices/vaults/MyVault/replicationJobs/b8a647e0-2cb9-40d1-84c4-d0169919e2c5\r     Type             : Microsoft.RecoveryServices/vaults/replicationJobs\r     JobType          : UpdateVmProperties\r     DisplayName      : Update the virtual machine\r     ClientRequestId  : 805a22a3-be86-441c-9da8-f32685673112-2015-12-10 17:55:51Z-P\r     State            : Succeeded\r     StateDescription : Completed\r     StartTime        : 10-12-2015 17:55:53 +00:00\r     EndTime          : 10-12-2015 17:55:54 +00:00\r     TargetObjectId   : 289682c6-c5e6-42dc-a1d2-5f9621f78ae6\r     TargetObjectType : ProtectionEntity\r     TargetObjectName : Fabrikam-App\r     AllowedActions   : {Restart}\r     Tasks            : {UpdateVmPropertiesTask}\r     Errors           : {}\r     ```\r \r ## <a name=\"step-8-run-a-test-failover\" ></a> 步骤 8：运行测试故障转移\r \r 1. 运行一个测试故障转移作业，如下所示：\r \r     ```\r     $nw = Get-AzureRmVirtualNetwork -Name \"TestFailoverNw\" -ResourceGroupName \"MyRG\" #Specify Azure vnet name and resource group\r \r     $protectionEntity = Get-AzureRmSiteRecoveryProtectionEntity -FriendlyName $VMFriendlyName -ProtectionContainer $protectionContainer\r \r     $TFjob = Start-AzureRmSiteRecoveryTestFailoverJob -ProtectionEntity $protectionEntity -Direction PrimaryToRecovery -AzureVMNetworkId $nw.Id\r     ```\r \r 2. 验证是否在 Azure 中创建了测试 VM。 在 Azure 中创建测试 VM 之后，暂停测试故障转移作业。\r \r 3. 若要清理并完成测试故障转移，请运行：\r \r     ```\r     $TFjob = Resume-AzureRmSiteRecoveryJob -Job $TFjob\r     ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r [详细了解](https://msdn.microsoft.com/library/azure/mt637930.aspx) Azure Site Recovery 和 Azure 资源管理器 PowerShell cmdlet。\r \r <!-- Update_Description: update meta properties, wording update -->"}