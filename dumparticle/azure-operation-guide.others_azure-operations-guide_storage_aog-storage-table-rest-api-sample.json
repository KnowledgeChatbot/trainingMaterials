{"Title":"Storage Table Rest API 调用示例","Description":"Storage Table Rest API 调用示例","Content":"# Storage Table Rest API 调用示例\r \r 在参考基于 Rest API 操作 Azure Storage Table 的过程中，官方提供了两种方式进行认证，分别为：SharedKey 和 ShareKeyLite。这种认证过程需要通过在请求 Header 过程中加入 Date（或 x-ms-date）和 Authorization 参数来完成。\r \r ## 调用示例\r \r - 添加认证信息格式：\r \r     ```\r     x-ms-date: date_and_time\r     Authorization: scheme_name account_name:signature\r     ```\r \r     从 Authorization 信息来看，`scheme_name` 参数对应 SharedKey 或 ShareKeyLite，`account_name` 对应存储的账户名称，都很容易获取，难点主要在 signature 参数的获取。下面分别基于 C# 给出构建两种认证方式的字符串：\r \r - Sharedkey 签名字符串：\r \r     ```C#\r     string stringToSign = string.Format(\"{0}\\n{1}\\n{2}\\n{3}\\n/{4}/{5}\",\r         request.Method,\r         request.Headers[\"Content-MD5\"],\r         request.Headers[\"Content-Type\"],\r         request.Headers[\"x-ms-date\"],\r         account,\r         resource);\r     ```\r \r - SharedkeyList 签名字符串：\r \r     ```C#\r     string stringToSign = string.Format(\"{0}\\n/{1}/{2}\",\r         request.Headers[\"x-ms-date\"],\r         account,\r         resource);\r     ```\r \r - 认证 Authorization 获取：\r \r     ```C#\r     var sharedKey = Convert.FromBase64(\"the_sharedkey_from_the_azure_web\");\r     \r     var hasher = new HMACSHA256(sharedKey);\r     \r     string signature = hasher.ComputeHash(Encoding.UTF8.GetBytes(strignToSign));\r     string authorizationHeader = string.Format(\"SharedKey {0}:{1}\",\r         _account,\r         Convert.ToBase64String(signature));\r     ```\r \r ## 完整测试代码\r \r ```C#\r using System;\r using System.Globalization;\r using System.IO;\r using System.Net;\r using System.Security.Cryptography;\r using System.Text;\r using System.Xml;\r \r namespace test1\r {\r     class Program\r     {\r         static void Main(string[] args)\r         {\r             string Resource = \"Tables\";\r             string _Account = \"yunewstoragetest\";//storage account\r             string _Secret = \"xzWNEIf4NhrDh1jie9CEdCkGNXfKVqdnGlJ3BlB7jcoj1w829L4F/t3+oh/qPLq1jvygUdR/HTIvqjRiz9GNkA==\";//key\r \r             //Create the web request\r             string url = \"https://yunewstoragetest.table.core.chinacloudapi.cn/\" + Resource;\r             HttpWebRequest request = (HttpWebRequest)HttpWebRequest.Create(url);\r             request.ContentLength = 0;\r             request.Method = \"GET\";\r \r             //Add a date header to the request\r             request.Headers.Add(\"x-ms-date\", DateTime.UtcNow.ToString(\"R\", CultureInfo.InvariantCulture));\r \r             // Sign the request\r             string signature = \"GET\\n\";\r             signature += \"\\n\";\r             signature += \"\\n\";\r             signature += request.Headers[\"x-ms-date\"] + \"\\n\";\r             int q = Resource.IndexOf(\"?\");\r             if (q > 0) Resource = Resource.Substring(0, q);\r             signature += \"/\" + _Account + \"/\" + Resource;\r \r             // Hash-based Message Authentication Code (HMAC) using SHA256 hash\r             HMACSHA256 hasher = new HMACSHA256(Convert.FromBase64String(_Secret));\r             string authH = \"SharedKey \" + _Account + \":\" + Convert.ToBase64String(hasher.ComputeHash(Encoding.UTF8.GetBytes(signature)));\r             //// Authorization header\r             request.Headers.Add(\"Authorization\", authH);\r \r             // Processing the results\r             using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())\r             {\r                 using (StreamReader r = new StreamReader(response.GetResponseStream()))\r                 {\r                     string xml = r.ReadToEnd();\r \r                     int ret = (int)response.StatusCode;\r                     if (ret == 200)\r                     {\r                         XmlDocument doc = new XmlDocument();\r                         doc.LoadXml(xml);\r                         XmlNodeList nodes = doc.GetElementsByTagName(\"d:TableName\");\r                         Console.WriteLine(\"Tables in Account: \" + _Account);\r                         foreach (XmlNode n in nodes)\r                         {\r                             Console.WriteLine(n.InnerText);\r                         }\r                     }\r                     else\r                     {\r                         Console.WriteLine(xml);\r                     }\r \r                     Console.WriteLine();\r                 }\r             }\r             Console.WriteLine(\"-----------------------------------------\");\r             Console.ReadKey(true);\r         }\r     }\r }\r ```\r \r ## 测试结果\r \r ![result](media/aog-storage-table-rest-api-sample/result.png)\r \r ## 参考链接\r \r - [通过 REST 访问 Azure Tables](https://blogs.msdn.microsoft.com/rxg/2009/04/02/accessing-azure-tables-via-rest/)\r - [Azure Storage Table 认证](http://blog.einbu.no/2009/08/authenticating-against-azure-table-storage/)\r - [Azure Storage 服务的认证](https://docs.microsoft.com/zh-cn/rest/api/storageservices/authentication-for-the-azure-storage-services)\r - [Azure Tables 操作](https://docs.microsoft.com/zh-cn/rest/api/storageservices/operations-on-tables)\r "}