{"Title":"Azure CDN HTTPS加速服务-客供证书","Description":"开通客户自有证书的HTTPS加速的说明和步骤","Content":"# Azure CDN HTTPS加速服务-用户自有证书\r \r Azure CDN提供HTTPS安全加速服务，支持用户上传自有证书，也支持Azure CDN代为申请证书的自动化配置，均只开放给付费用户。本文档针对用户自己上传证书自助化配置的情况以及证书说明，Azure CDN代为申请证书的配置操作请参考[Azure CDN HTTPS加速服务-Azure CDN代申请证书](https://www.azure.cn/documentation/articles/cdn-https-how-to/)。二者的区别请参考[常见问题-服务咨询](https://www.azure.cn/documentation/articles/cdn-faq-service-inquiry/)。\r \r \r ## 配置说明\r \r - HTTPS加速只开放给付费用户。\r - 支持泛域名的HTTPS加速。\r - 支持的加速类型为标准版CDN加速类型，如网页加速，下载加速，点播加速和直播加速。\r \r     >**注意** 图片处理加速类型暂不支持线上配置HTTPS加速，如需开通，请联系[Azure 技术支持团队](https://www.azure.cn/support/contact/)开工单进行线下配置。\r     >\r - 需要在**新版Azure CDN管理界面**启用HTTPS服务，并上传PEM格式的证书和秘钥。详见后文的“自助式启用HTTPS加速步骤”。\r - 开启HTTPS加速后，默认同时支持HTTP和HTTPS方式的请求。如需强制将HTTP请求跳转成HTTPS请求，请联系世纪互联进行配置。我们后续会在管理界面实现自动化选择。\r - 回源协议默认跟随用户发起的请求协议，即HTTP请求通过HTTP协议回源，HTTPS请求通过HTTPS协议回源。如需指定只有HTTP回源或者只有HTTPS回源，请联系世纪互联进行配置。我们后续会在管理界面实现自动化选择。\r \r \r ## 证书说明\r \r - 用户自有证书的HTTPS加速是基于SNI技术实现的，SNI证书可以多个HTTPS 客户共享同一个IP 地址。\r - \r     >**注意** SNI证书不支持Windwos XP系统下所有的IE版本，浏览器会提示不受信任。\r     \r - 开启HTTPS加速后，需要上传加速域名的证书和私钥，证书和域名、证书和私钥需要匹配，否则会校验出错。\r     \r     >**注意** 证书有效期少于45天，不支持证书和域名绑定；证书有效期少于60天，不支持上传。\r     \r - 支持看证书信息，但不支持证书下载，也不支持秘钥查看，请保管好证书相关信息。\r - 支持证书链。证书链的单个PEM文件需按以下顺序包含多个证书： 公共证书， 中间证书， 根证书。各证书分别以`-----BEGIN CERTIFICATE-----`，`-----END CERTIFICATE-----` 开头结尾。\r \r ### **证书格式说明**\r \r - 证书格式为PEM格式，不支持其他格式的证书，需将其他格式的证书转换成PEM格式，可以通过openssl工具进行转换。请参考下文“常见证书格式转换”。\r - 证书以 `-----BEGIN CERTIFICATE-----`，`-----END CERTIFICATE-----` 开头结尾。\r - 秘钥目前支持PKCS1和PKCS8编码格式，PKCS1编码的私钥格式为 `-----BEGIN RSA PRIVATE KEY-----`开始，并以 `-----END RSA PRIVATE KEY-----`结束；PKCS8编码的私钥是以 `-----BEGIN PRIVATE KEY-----`，`-----END PRIVATE KEY-----` 开头结尾。\r \r     >**注意**\r     >可以使用openssl工具对秘钥编码格式进行转换，例如：\r     \r     >openssl.exe pkcs8 -topk8 -inform PEM -outform PEM -in yourkeyfile.key -out yourconverted.key -nocrypt \r     \r \r ### **常见证书格式转换**\r \r #### DER格式转换为PEM\r \r - 证书转换\r \r     ```\r     openssl x509 -in cert.der -inform DER -out cert.pem -outform PEM\r     ```\r - 私钥转换\r \r     ```\r     openssl rsa -in privagekey.der -inform DER -out privatekey.pem -outform PEM\r     ```\r \r #### PFX格式转换为PEM\r \r - 证书转换\r \r     ```\r     openssl pkcs12 -in cert.pfx -nokeys -out cert.pem\r     ```\r \r - 私钥转换\r \r     ```\r     openssl pkcs12 -in cert.pfx -nocerts -out key.pem -nodes\r     ```\r \r ## 价格说明\r \r 自有证书的HTTPS加速，于2017年7月1日起，使用标准版服务价格，2017年7月1日前，该服务属于高级服务，使用高级服务价格。具体计费方式请参见[Azure官方网站](https://www.azure.cn/pricing/details/cdn/)。\r \r \r ## 自助式启用HTTPS加速步骤\r \r 可以为所有符合条件的CDN域名开启自有证书的HTTPS加速（付费账号下所有的标准版加速类型的CDN域名，图片加速节点除外）。\r \r     >**注意**如果需要在“Azure门户预览”中新建CDN Profile和节点，并且启用自有证书的HTTPS加速，Pricing Tier请选择“S1 Standard”。\"P1 Premium\"中的HTTPS是指Azure CDN代为申请证书。\r   \r   ![][15]\r \r 1. 点击“Manage”进入新版Azure CDN管理门户。\r      >**注意** 老版Azure CDN管理门户不支持上传HTTPS自有证书。\r     \r     **新版Azure门户预览中的CDN profile界面：**\r \r     ![][1]\r \r \r     **新版Azure CDN管理门户界面：**\r     ![][3]\r \r 2. **上传证书**：点击“证书管理”，点击“添加一张SSL证书”，输入证书名称，便于分辨证书。上传需要启用HTTPS服务的域名证书，注意证书必须是PEM格式，秘钥目前只支持RSA PKCS8编码格式。具体证书格式转换请参考上文的“证书说明”。\r      >**注意**证书上传后，需要到“域名管理”界面，将证书和域名进行绑定,证书才会进行部署。证书有效期少于60天，不支持上传。\r      \r     ![][4]\r \r 3. **域名绑定证书**：可以在“证书管理”中绑定，也可以在“域名管理”中绑定。\r       >**注意**证书有效期少于45天，不支持证书和域名绑定；\r     \r     - 可以直接在“证书管理”处上传证书时选择要绑定的域名；\r      ![][9]\r     - 也可以上传证书后，在证书管理页面，选择证书，点击“编辑绑定”-> “添加绑定域名”；\r      ![][5]\r      ![][6]\r     - 也可以点击“域名管理”，选择需要启用HTTPS服务的域名，在右侧界面选择“HTTPS（客户提供证书）”，点击“启用”绑定一张证书，从上传证书下拉列表框中选择已上传的证书，点击确定。如果没有符合的证书，点击“证书管理”，参考步骤3上传证书。\r      ![][8]\r 4. **证书部署**：绑定域名后，系统会提示“证书正在部署中，生效时间一般为2-4小时，如果超过24小时部署仍未完成，请联系工作人员。 ”\r \r     ![][13]\r 5. **域名绑定成功**后，系统会提示“证书绑定成功，可以通过HTTPS访问该加速域名”，并看到证书详情。同时该域名的“HTTPS状态（客户提供证书）”变为“活跃”。\r \r     - 点击该域名，可以查看证书信息。\r     \r         ![][10]\r \r     - 域名“HTTPS状态（客户提供证书）”变为“活动”。\r     \r         ![][11]\r \r     - “证书管理”处，改证书绑定域名数也会变化。\r     \r         ![][12]\r \r 6. **查看证书详情**：点击证书管理处任一证书，查看证书详情，和所绑定域名信息。\r \r     ![][7]\r 7. **查看是否生效**：通过HTTPS访问域名，可以看到带小锁的标志，表示HTTPS加速启用成功。\r     ![][14]   \r \r ## 更换证书和删除证书\r \r ### **删除证书**\r \r 删除证书需在证书管理处进行删除。选中需要删除的证书，在右边的窗口中点击删除。\r \r ![][19] \r \r >**注意**已有域名绑定的证书，需要将证书和域名解绑，然后才能删除证书，否则会提示需要先将。解绑的方式，可以通过为域名更换证书，或者直接将域名删除的方式。更换证书请参考更换证书部分。\r \r ![][16] \r \r ### **更换证书**\r \r 如果证书即将过期或者证书已经过期，可以上传新的有效证书，并到域名管理处对相应域名进行更换证书操作。\r \r - 选中需更换证书的域名，HTTPS（客户提供证书），更换证书：\r \r   ![][17]\r \r - 选择需要更换的证书，点击保存。\r \r   ![][18]\r \r - 重复自助式启用HTTPS加速步骤中的4,5,6,7步骤。\r \r <!--Image references-->\r [1]: ./media/cdn-httpsimage/manage.png\r [2]: ./media/cdn-httpsimage/oldportal.png\r [3]: ./media/cdn-httpsimage/newportaloverview.png\r [4]: ./media/cdn-httpsimage/uploadcert.png\r [5]: ./media/cdn-httpsimage/bindcert1.png\r [6]: ./media/cdn-httpsimage/bindcert1.1.png\r [7]: ./media/cdn-httpsimage/certdetail.png\r [8]: ./media/cdn-httpsimage/bindcert2.png\r [9]: ./media/cdn-httpsimage/bindcert3.png\r [10]: ./media/cdn-httpsimage/success.png\r [11]: ./media/cdn-httpsimage/successdomainstatuspng.png\r [12]: ./media/cdn-httpsimage/cert4.png\r [13]: ./media/cdn-httpsimage/deploying.png\r [14]: ./media/cdn-httpsimage/finalaccess.png\r [15]: ./media/cdn-httpsimage/ibizapricingtier.png\r [16]: ./media/cdn-httpsimage/deletecerterror.png\r [17]: ./media/cdn-httpsimage/changecert1.png\r [18]: ./media/cdn-httpsimage/changecert2.png\r [19]: ./media/cdn-httpsimage/deletecert.png\r "}