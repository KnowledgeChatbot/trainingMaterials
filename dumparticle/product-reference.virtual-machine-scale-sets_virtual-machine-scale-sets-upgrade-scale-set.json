{"Title":"升级 Azure 虚拟机规模集","Description":"升级 Azure 虚拟机规模集","Content":"# <a name=\"upgrade-a-virtual-machine-scale-set\"></a>升级虚拟机规模集\r 本文介绍了如何在不停机的情况下为 Azure 虚拟机规模集推出 OS 更新。 在此上下文中，OS 更新涉及到更改 OS 的版本或 SKU，或者更改自定义映像的 URI。 在不停机的情况下更新意味着一次只更新一台虚拟机或分组更新（如一次更新一个容错域），而不是一次更新所有虚拟机。 这样做能使没有进行升级的虚拟机继续运行。\r \r 为了避免混淆，我们来区分一下可能要执行的 OS 更新的四种类型：\r \r * 更改平台映像的版本或 SKU。 例如，将 Ubuntu 14.04.2-LTS 版本从 14.04.201506100 更改为 14.04.201507060，或者将 Ubuntu 15.10/最新 SKU 更改为 16.04.0-LTS/最新。 本文中介绍了此方案。\r * 更改指向生成的自定义映像的新版本的 URI（“属性” > “virtualMachineProfile” > “storageProfile” > “osDisk” > “映像” > “URI”）。 本文中介绍了此方案。\r * 更改使用 Azure 托管磁盘创建的规模集的映像引用。\r * 从虚拟机内部修补 OS（这样的示例包括安装安全修补程序以及运行 Windows 更新）。 尽管此方案是受支持的，但在本文中不予讨论。\r \r 此处不讨论部署为 [Azure Service Fabric](https://www.azure.cn/home/features/service-fabric/) 群集的一部分的虚拟机规模集。\r \r 更改平台映像的 OS 版本/SKU 或自定义映像的 URI 的基本顺序，如下所示：\r \r 1. 获取虚拟机规模集模型。\r 2. 更改模型中的版本、SKU、映像引用或 URI 值。\r 3. 更新模型。\r 4. 对规模集中的虚拟机执行 *manualUpgrade* 调用。 只有将规模集中的 *upgradePolicy* 设置为“手动”时，此步骤才适用。 如果设置为“自动” ，所有的虚拟机则会同时升级，从而导致停机。\r \r 在记住了这些信息后，来看一下如何在 PowerShell 中以及使用 REST API 更新规模集的版本。 尽管这些示例涵盖了关于平台映像的示例，但是本文提供了足量的信息使用户能够适应此过程以自定义映像。\r \r ## <a name=\"powershell\"></a>PowerShell\r 此示例会更新 Windows 虚拟机规模集（创建到新版本 4.0.20160229。 更新模型后，它将一次更新一个虚拟机实例。\r \r ```powershell\r $rgname = \"myrg\"\r $vmssname = \"myvmss\"\r $newversion = \"4.0.20160229\"\r $instanceid = \"1\"\r \r # get the VMSS model\r $vmss = Get-AzureRmVmss -ResourceGroupName $rgname -VMScaleSetName $vmssname\r \r # set the new version in the model data\r $vmss.virtualMachineProfile.storageProfile.imageReference.version = $newversion\r \r # update the virtual machine scale set model\r Update-AzureRmVmss -ResourceGroupName $rgname -Name $vmssname -VirtualMachineScaleSet $vmss\r \r # now start updating instances\r Update-AzureRmVmssInstance -ResourceGroupName $rgname -VMScaleSetName $vmssname -InstanceId $instanceId\r ```\r \r 如果要更新自定义映像的 URI，而不是更改平台映像版本，请将 \"set the new version\" 一行替换为将要更新源映像 URI 的命令。 例如，如果创建规模集时没有使用 Azure 托管磁盘，更新将如下所示：\r \r ```powershell\r # set the new version in the model data\r $vmss.virtualMachineProfile.storageProfile.osDisk.image.uri= $newURI\r ```\r \r 如果基于自定义映像的规模集是使用 Azure 托管磁盘创建的，则映像引用将会更新。 例如：\r \r ```powershell\r # set the new version in the model data\r $vmss.virtualMachineProfile.storageProfile.imageReference.id = $newImageReference\r ```\r \r ## <a name=\"the-rest-api\"></a>REST API\r 这里有一些使用 Azure REST API 推出 OS 版本更新的 Python 示例。 两种都使用了 Azure REST API 包装函数的轻型 [azurerm](https://pypi.python.org/pypi/azurerm) 库，可先对规模集模型执行 GET，然后使用更新的模型执行 PUT。 它们也会查看虚拟机实例视图来根据更新域识别虚拟机。\r \r ### <a name=\"vmssupgrade\"></a>Vmssupgrade\r  [Vmssupgrade](https://github.com/gbowerman/vmsstools) 是用于为正在运行的虚拟机规模集推出 OS 升级的 Python 脚本，一次一个更新域。\r \r ![用于选择虚拟机或更新域的 Vmssupgrade 脚本](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssupgrade-screenshot.png)\r \r 使用此脚本，可选择要更新的具体虚拟机或者指定更新域。 它支持更改平台映像版本或更改自定义映像的 URI。\r \r ### <a name=\"vmsseditor\"></a>Vmsseditor\r [Vmsseditor](https://github.com/gbowerman/vmssdashboard) 是一个适用于虚拟机规模集的通用编辑器，用于显示状态为 heatmap 的虚拟机规模集，其中一行表示一个更新域。 除此之外，还可以使用新版本、SKU 或自定义映像 URI 来更新规模集的模型，然后选择要升级的容错域。 执行此操作时，该更新域中的所有虚拟机都将升级到新模型。 或者，可以根据所选的批大小执行滚动升级。  \r \r 以下屏幕截图显示了 Ubuntu 14.04-2LTS 版本 14.04.201507060 的规模集的模型。 自此屏幕截图截取之后，又为此工具添加了更多的选项。\r \r ![适用于 Ubuntu 14.04-2LTS 的规模集的 Vmsseditor 模型](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor1.png)\r \r 单击“升级”和“获取详细信息”之后，UD 0 中的虚拟机将开始进行更新。\r \r ![显示正在进行更新的 Vmsseditor](./media/virtual-machine-scale-sets-upgrade-scale-set/vmssEditor2.png)\r "}