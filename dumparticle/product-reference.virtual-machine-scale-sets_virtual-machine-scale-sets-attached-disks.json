{"Title":"Azure 虚拟机规模集附加数据磁盘","Description":"了解如何将附加数据磁盘与虚拟机规模集配合使用","Content":"# <a name=\"azure-vm-scale-sets-and-attached-data-disks\"></a>Azure VM 规模集及附加数据磁盘\r Azure [虚拟机规模集](/virtual-machine-scale-sets/)现在支持对虚拟机附加数据磁盘。 对于使用 Azure 托管磁盘创建的规模集，可以在存储配置文件中定义数据磁盘。 以前，OS 驱动器和临时驱动器是规模集中 VM 的唯一直接连接的存储选项。\r \r > [!NOTE]\r >  创建具有已定义附加数据磁盘的规模集时，仍然需要从 VM 中装载和格式化这些磁盘才能使用它们（就像独立 Azure VM 一样）。 若要执行此操作，一种简便的方法是使用自定义脚本扩展，其调用标准脚本，在 VM 上对所有数据磁盘进行分区和格式化。\r \r ## <a name=\"create-a-scale-set-with-attached-data-disks\"></a>创建具有附加数据磁盘的规模集\r 若要创建具有附加数据磁盘的规模集，一种简单的方法是使用 [Azure CLI](https://github.com/Azure/azure-cli) _vmss create_ 命令。 以下示例创建一个 Azure 资源组，以及一个包含 10 个 Ubuntu VM 的虚拟机规模集，它们都具有 2 个大小分别为 50 GB 和 100 GB 的附加数据磁盘。\r ```bash\r az group create -l chinaeast -n dsktest\r az vmss create -g dsktest -n dskvmss --image ubuntults --instance-count 10 --data-disk-sizes-gb 50 100\r ```\r 请注意，如果不指定某些配置值， _vmss create_ 命令使用默认值。 若要查看可以重写的可用选项，请尝试：\r ```bash\r az vmss create --help\r ```\r 如果要创建包含附加数据磁盘的规模集，另一种方法是在 Azure Resource Manager 模板中定义一个规模集，在 storageProfile 中包括 dataDisks 节，并部署模板。 上述 50 GB 和 100 GB 磁盘示例在模板中定义为：\r ```json\r \"dataDisks\": [\r     {\r     \"lun\": 1,\r     \"createOption\": \"Empty\",\r     \"caching\": \"ReadOnly\",\r     \"diskSizeGB\": 50\r     },\r     {\r     \"lun\": 2,\r     \"createOption\": \"Empty\",\r     \"caching\": \"ReadOnly\",\r     \"diskSizeGB\": 100\r     }\r ]\r ```\r 可以在此处看到完整的具有已定义附加磁盘的规模集模板，该模板已准备就绪可进行部署： [https://github.com/chagarw/MDPP/tree/master/101-vmss-os-data](https://github.com/chagarw/MDPP/tree/master/101-vmss-os-data)。\r \r ## <a name=\"adding-a-data-disk-to-an-existing-scale-set\"></a>将数据磁盘添加到现有规模集\r > [!NOTE]\r >  只能将数据磁盘附加到使用 [Azure 托管磁盘](./virtual-machine-scale-sets-managed-disks.md)创建的规模集。\r \r 可使用 Azure CLI _az vmss disk attach_ 命令将数据磁盘添加到 VM 规模集。 请确保指定的 lun 未被使用。 下面的 CLI 示例将一个 50 GB 的驱动器添加到 lun 3：\r ```bash\r az vmss disk attach -g dsktest -n dskvmss --size-gb 50 --lun 3\r ```\r \r 以下 PowerShell 示例将 50 GB 的驱动器添加到 lun 3：\r ```powershell\r $vmss = Get-AzureRmVmss -ResourceGroupName myvmssrg -VMScaleSetName myvmss\r $vmss = Add-AzureRmVmssDataDisk -VirtualMachineScaleSet $vmss -Lun 3 -Caching 'ReadWrite' -CreateOption Empty -DiskSizeGB 50 -StorageAccountType StandardLRS\r Update-AzureRmVmss -ResourceGroupName myvmssrg -Name myvmss -VirtualMachineScaleSet $vmss\r ```\r \r > [!NOTE]\r > 不同的 VM 大小所支持的附加驱动器数量有不同的限制。 在添加新磁盘之前，请检查[虚拟机大小特征](../virtual-machines/windows/sizes.md)。\r \r 也可通过以下方式添加磁盘：先向规模集定义的 storageProfile 中的 dataDisks 属性添加新条目，并应用所做的更改。 选择“编辑”并将新磁盘添加到数据磁盘列表。 例如 使用以上示例：\r ```json\r \"dataDisks\": [\r     {\r     \"lun\": 1,\r     \"createOption\": \"Empty\",\r     \"caching\": \"ReadOnly\",\r     \"diskSizeGB\": 50\r     },\r     {\r     \"lun\": 2,\r     \"createOption\": \"Empty\",\r     \"caching\": \"ReadOnly\",\r     \"diskSizeGB\": 100\r     },\r     {\r     \"lun\": 3,\r     \"createOption\": \"Empty\",\r     \"caching\": \"ReadOnly\",\r     \"diskSizeGB\": 20\r     }          \r ]\r ```\r 然后选择“PUT”将更改应用于规模集。 如果使用的 VM 大小支持两个以上附加数据磁盘，则此示例适用。\r \r > [!NOTE]\r > 对规模集定义进行更改时（如添加或删除数据磁盘），更改适用于所有新建 VM，但仅在 _upgradePolicy_ 属性设置为“自动”的情况下，才适用于现有 VM。 如果此属性设置为“手动”，则需手动将新模型应用于现有 VM。 可以在门户中执行此操作，使用 Update-AzureRmVmssInstance PowerShell 命令或 az vmss update-instances CLI 命令。\r \r ## <a name=\"adding-pre-populated-data-disks-to-an-existent-scale-set\"></a>将预先填充的数据磁盘添加到现有规模集 \r 根据设计，在向现有的规模集模型添加磁盘时，创建的磁盘始终为空。 此方案还包括规模集创建的新实例。 之所以出现这样的行为，是因为规模集定义有一个空的数据磁盘。 若要为现有的规模集模型创建预先填充的数据驱动器，可以从后续的两个选项中随意选择一个：\r \r * 通过运行自定义脚本，将数据从实例 0 VM 复制到其他 VM 中的数据磁盘。\r * 使用 OS 磁盘和数据磁盘（以及必需的数据）创建一个托管映像，并使用该映像创建新的规模集。 这样一来，每个新创建的 VM 都会有一个数据磁盘，该磁盘是在规模集的定义中规定的。 由于该定义会引用带数据磁盘的映像，且该磁盘包含自定义数据，因此规模集中每个虚拟机都会自动带有这些更改。\r \r 若要创建自定义映像，可参阅以下方法：[在 Azure 中创建通用 VM 的托管映像](/virtual-machines/windows/capture-image-resource/) \r \r 用户需捕获包含必需数据的实例 0 VM，并将该 vhd 用于映像定义。\r \r ## <a name=\"removing-a-data-disk-from-a-scale-set\"></a>从规模集中删除数据磁盘\r 可使用 Azure CLI _az vmss disk detach_ 命令从 VM 规模集中删除数据磁盘。 例如，以下命令删除 lun 2 处定义的磁盘：\r ```bash\r az vmss disk detach -g dsktest -n dskvmss --lun 2\r ```  \r 类似地，也可通过以下方式从规模集中移除磁盘：删除 storageProfile 的 dataDisks 属性中的条目，并应用所做的更改。 \r \r ## <a name=\"additional-notes\"></a>附加说明\r Microsoft.Compute API 的 API 版本 [_2016-04-30-preview_](https://github.com/Azure/azure-rest-api-specs/blob/master/arm-compute/2016-04-30-preview/swagger/compute.json) 或更高版本中提供了对 Azure 托管磁盘和规模集附加数据磁盘的支持。\r \r 在对规模集的附加磁盘支持初始实现中，不能在规模集中将数据磁盘附加到单个 VM，也不能从中分离。\r \r Azure 门户对规模集中附加数据磁盘的支持一开始是受限的。 根据需求，可使用 Azure 模板、CLI、PowerShell、SDK 和 REST API 来管理附加磁盘。\r \r <!--Update_Description: wording update add Adding pre-populated data disks to an existent scale set-->"}