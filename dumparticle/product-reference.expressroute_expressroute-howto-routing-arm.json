{"Title":"如何为 ExpressRoute 线路配置路由（对等互连）：Resource Manager：PowerShell：Azure","Description":"本文介绍创建和预配 ExpressRoute 线路的专用、公共对等互连的步骤。 本文还介绍了如何检查状态，以及如何更新或删除线路的对等互连。","Content":"# <a name=\"create-and-modify-peering-for-an-expressroute-circuit-using-powershell\"></a>使用 PowerShell 创建和修改 ExpressRoute 线路的对等互连\r \r 本文帮助你使用 PowerShell 在资源管理器部署模型中创建和管理 ExpressRoute 线路的路由配置。 还可以检查 ExpressRoute 线路的状态，更新、删除和取消预配其对等互连。 如果想使用不同的方法处理线路，请从以下列表中选择一篇文章进行参阅：\r \r > [!div class=\"op_single_selector\"]\r \r > * [Azure 门户](expressroute-howto-routing-portal-resource-manager.md)\r > * [PowerShell](expressroute-howto-routing-arm.md)\r > * [Azure CLI](howto-routing-cli.md)\r > * [PowerShell（经典）](expressroute-howto-routing-classic.md)\r > \r \r ## <a name=\"configuration-prerequisites\"></a>配置先决条件\r - 需要最新版本的 Azure Resource Manager PowerShell cmdlet。 有关详细信息，请参阅[如何安装和配置 Azure PowerShell](../powershell-install-configure.md)。 \r - 在开始配置之前，请务必查看[先决条件](./expressroute-prerequisites.md)页、[路由要求](./expressroute-routing.md)页和[工作流](./expressroute-workflows.md)页。\r - 必须有一个活动的 ExpressRoute 线路。 在继续下一步之前，请按说明 [创建 ExpressRoute 线路](expressroute-howto-circuit-arm.md) ，并通过连接提供商启用该线路。 ExpressRoute 线路必须处于已预配和已启用状态，才能运行本文中的 cmdlet。\r \r 这些说明只适用于由提供第 2 层连接服务的服务提供商创建的线路。 如果服务提供商提供第 3 层托管服务（通常是 IPVPN，如 MPLS），则连接服务提供商会配置和管理路由。\r \r > [!IMPORTANT]\r > 我们目前无法通过服务管理门户播发服务提供商配置的对等互连。 我们正在努力不久就实现这一功能。 请在配置 BGP 对等互连之前与服务提供商协商。\r > \r > \r \r 可以为 ExpressRoute 线路配置一个或两个对等互连（Azure 专用和 Azure 公共）。 可以按照所选的任意顺序配置对等互连。 但是，必须确保一次只完成一个对等互连的配置。 有关路由域和对等互连的详细信息，请参阅 [ExpressRoute 路由域](expressroute-circuit-peerings.md)。\r \r ## <a name=\"private\"></a>Azure 专用对等互连\r \r 本文介绍了如何为 ExpressRoute 线路创建、获取、更新和删除 Azure 专用对等互连配置。\r \r ### <a name=\"to-create-azure-private-peering\"></a>创建 Azure 专用对等互连\r \r 1. 为 ExpressRoute 导入 PowerShell 模块。\r \r   必须从 [PowerShell 库](http://www.powershellgallery.com/)安装最新的 PowerShell 安装程序，并将 Azure Resource Manager 模块导入 PowerShell 会话，以便开始使用 ExpressRoute cmdlet。 需要以管理员身份运行 PowerShell。\r \r   ```powershell\r   Install-Module AzureRM\r   Install-AzureRM\r   ```\r \r   导入已知语义版本范围内的所有 AzureRM.* 模块。\r \r   ```powershell\r   Import-AzureRM\r   ```\r \r   也可以只导入已知语义版本范围内的 select 模块。\r \r   ```powershell\r   Import-Module AzureRM.Network \r   ```\r \r     登录到帐户。\r \r   ```powershell\r   Login-AzureRmAccount -EnvironmentName $(Get-AzureRmEnvironment -Name AzureChinaCloud)\r   ```\r \r   选择要创建 ExpressRoute 线路的订阅。\r \r   ```powershell\r   Select-AzureRmSubscription -SubscriptionId \"<subscription ID>\"\r   ```\r \r 2. 创建 ExpressRoute 线路。\r \r     请按说明创建 [ExpressRoute 线路](./expressroute-howto-circuit-arm.md) ，并由连接服务提供商进行预配。 \r \r   如果连接服务提供商提供第 3 层托管服务，可以请求连接服务提供商启用 Azure 专用对等互连。 在此情况下，不需要遵循后续部分中所列的说明。 但是，如果连接服务提供商不为你管理路由，请在创建线路后按照后续步骤继续配置。\r 3. 检查 ExpressRoute 线路以确保它已预配并已启用。 使用以下示例：\r \r   ```powershell\r   Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r   ```\r \r   响应类似于以下示例：\r \r     ```\r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                        }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : Provisioned\r     ServiceProviderNotes             : \r     ServiceProviderProperties        : {\r                                          \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                          \"PeeringLocation\": \"Beijing\",\r                                          \"BandwidthInMbps\": 200\r                                        }\r     ServiceKey                       : **************************************\r     Peerings                         : []\r     ```\r \r 4. 配置线路的 Azure 专用对等互连。\r \r     在继续执行后续步骤之前，请确保已准备好以下各项：\r \r   * 主链路的 /30 子网。 此子网不能是保留给虚拟网络使用的任何地址空间的一部分。\r   * 辅助链路的 /30 子网。 此子网不能是保留给虚拟网络使用的任何地址空间的一部分。\r   * 用于建立此对等互连的有效 VLAN ID。 请确保线路中没有其他对等互连使用同一个 VLAN ID。\r   * 对等互连的 AS 编号。 可以使用 2 字节和 4 字节 AS 编号。 可以将专用 AS 编号用于此对等互连。 请务必不要使用 65515。\r   * **可选** - MD5 哈希（如果选择使用）。\r \r   使用以下示例为线路配置 Azure 专用对等互连：\r \r   ```powershell\r   Add-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePrivatePeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePrivatePeering -PeerASN 100 -PrimaryPeerAddressPrefix \"10.0.0.0/30\" -SecondaryPeerAddressPrefix \"10.0.0.4/30\" -VlanId 200\r \r   Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r   ```\r \r   如果选择使用 MD5 哈希，请使用以下示例：\r \r   ```powershell\r   Add-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePrivatePeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePrivatePeering -PeerASN 100 -PrimaryPeerAddressPrefix \"10.0.0.0/30\" -SecondaryPeerAddressPrefix \"10.0.0.4/30\" -VlanId 200  -SharedKey \"A1B2C3D4\"\r   ```\r \r   > [!IMPORTANT]\r   > 请确保将 AS 编号指定为对等互连 ASN，而不是客户 ASN。\r   > \r   >\r \r ### <a name=\"getprivate\"></a>获取 Azure 专用对等互连详细信息\r \r 可以使用以下示例来获取配置详细信息：\r \r ```powershell\r $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r Get-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePrivatePeering\" -Circuit $ckt\r ```\r \r ### <a name=\"updateprivate\"></a>更新 Azure 专用对等互连配置\r \r 可以使用以下示例来更新配置的任何部分。 在此示例中，线路的 VLAN ID 将从 100 更新为 500。\r \r ```powershell\r Set-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePrivatePeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePrivatePeering -PeerASN 100 -PrimaryPeerAddressPrefix \"10.0.0.0/30\" -SecondaryPeerAddressPrefix \"10.0.0.4/30\" -VlanId 200\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r ### <a name=\"deleteprivate\"></a>删除 Azure 专用对等互连\r \r 可以运行以下示例来删除对等互连配置：\r \r > [!WARNING]\r > 运行此示例前，必须确保已从 ExpressRoute 线路取消链接所有虚拟网络。 \r > \r > \r \r ```powershell\r Remove-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePrivatePeering\" -ExpressRouteCircuit $ckt\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r ## <a name=\"public\"></a>Azure 公共对等互连\r \r 本文介绍了如何为 ExpressRoute 线路创建、获取、更新和删除 Azure 公共对等互连配置。\r \r ### <a name=\"to-create-azure-public-peering\"></a>创建 Azure 公共对等互连\r \r 1. 为 ExpressRoute 导入 PowerShell 模块。\r \r   必须从 [PowerShell 库](http://www.powershellgallery.com/)安装最新的 PowerShell 安装程序，并将 Azure Resource Manager 模块导入 PowerShell 会话，以便开始使用 ExpressRoute cmdlet。 需要以管理员身份运行 PowerShell。\r \r   ```powershell\r   Install-Module AzureRM\r \r   Install-AzureRM\r ```\r \r   导入已知语义版本范围内的所有 AzureRM.* 模块。\r \r   ```powershell\r   Import-AzureRM\r   ```\r \r   也可以只导入已知语义版本范围内的 select 模块。\r \r   ```powershell\r   Import-Module AzureRM.Network\r ```\r \r   登录到帐户。\r \r   ```powershell\r     Login-AzureRmAccount -Environment $(Get-AzureRmEnvironment -Name AzureChinaCloud)\r     ```\r \r   选择要创建 ExpressRoute 线路的订阅。\r \r   ```powershell\r   Select-AzureRmSubscription -SubscriptionId \"<subscription ID>\"\r   ```\r 2. 创建 ExpressRoute 线路。\r \r   请按说明创建 [ExpressRoute 线路](expressroute-howto-circuit-arm.md) ，并由连接服务提供商进行预配。\r \r   如果连接服务提供商提供第 3 层托管服务，可以请求连接服务提供商启用 Azure 专用对等互连。 在此情况下，不需要遵循后续部分中所列的说明。 但是，如果连接服务提供商不为你管理路由，请在创建线路后按照后续步骤继续配置。\r 3. 检查 ExpressRoute 线路以确保它已预配并已启用。 使用以下示例：\r \r   ```powershell\r   Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r   ```\r \r   响应类似于以下示例：\r \r     ```\r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                        }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : Provisioned\r     ServiceProviderNotes             : \r     ServiceProviderProperties        : {\r                                          \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                          \"PeeringLocation\": \"Beijing\",\r                                          \"BandwidthInMbps\": 200\r                                        }\r     ServiceKey                       : **************************************\r     Peerings                         : []    \r     ```\r \r 4. 配置线路的 Azure 公共对等互连。\r    \r    在继续下一步之前，请确保已准备以下信息。\r \r   * 主链路的 /30 子网。 这必须是有效的公共 IPv4 前缀。\r   * 辅助链路的 /30 子网。 这必须是有效的公共 IPv4 前缀。\r   * 用于建立此对等互连的有效 VLAN ID。 请确保线路中没有其他对等互连使用同一个 VLAN ID。\r   * 对等互连的 AS 编号。 可以使用 2 字节和 4 字节 AS 编号。\r   * **可选** - MD5 哈希（如果选择使用）。\r \r   运行以下示例为线路配置 Azure 公共对等互连\r \r   ```powershell\r   Add-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePublicPeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePublicPeering -PeerASN 100 -PrimaryPeerAddressPrefix \"12.0.0.0/30\" -SecondaryPeerAddressPrefix \"12.0.0.4/30\" -VlanId 100\r \r     Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r     ```\r \r   如果选择使用 MD5 哈希，请使用以下示例：\r \r   ```powershell\r   Add-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePublicPeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePublicPeering -PeerASN 100 -PrimaryPeerAddressPrefix \"12.0.0.0/30\" -SecondaryPeerAddressPrefix \"12.0.0.4/30\" -VlanId 100  -SharedKey \"A1B2C3D4\"\r \r     Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r     ```\r \r     >[!IMPORTANT]\r     > 请确保将 AS 编号指定为对等互连 ASN，而不是客户 ASN。\r     > \r     >\r \r ### <a name=\"getpublic\"></a>获取 Azure 公共对等互连详细信息\r \r 可以使用以下 cmdlet 来获取配置详细信息：\r \r ```powershell\r   $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r   Get-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePublicPeering\" -Circuit $ckt\r   ```\r \r ### <a name=\"updatepublic\"></a>更新 Azure 公共对等互连配置\r \r 可以使用以下示例来更新配置的任何部分。 在此示例中，线路的 VLAN ID 将从 200 更新为 600。\r \r ```powershell\r Set-AzureRmExpressRouteCircuitPeeringConfig  -Name \"AzurePublicPeering\" -ExpressRouteCircuit $ckt -PeeringType AzurePublicPeering -PeerASN 100 -PrimaryPeerAddressPrefix \"123.0.0.0/30\" -SecondaryPeerAddressPrefix \"123.0.0.4/30\" -VlanId 600\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r ### <a name=\"deletepublic\"></a>删除 Azure 公共对等互连\r \r 可以运行以下示例来删除对等互连配置：\r \r ```powershell\r Remove-AzureRmExpressRouteCircuitPeeringConfig -Name \"AzurePublicPeering\" -ExpressRouteCircuit $ckt\r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 下一步， [将 VNet 链接到 ExpressRoute 线路](./expressroute-howto-linkvnet-arm.md)。\r \r -  有关 ExpressRoute 工作流的详细信息，请参阅 [ExpressRoute 工作流](./expressroute-workflows.md)。\r \r -  有关线路对等互连的详细信息，请参阅 [ExpressRoute 线路和路由域](./expressroute-circuit-peerings.md)。\r \r -  有关使用虚拟网络的详细信息，请参阅 [虚拟网络概述](../virtual-network/virtual-networks-overview.md)。\r \r <!--Update_Description:update meta properties and wording-->"}