{"Title":"在 Linux 上创建虚拟机规模集和部署高度可用的应用","Description":"使用虚拟机规模集在 Linux VM 上创建和部署高度可用的应用程序","Content":"# <a name=\"create-a-virtual-machine-scale-set-and-deploy-a-highly-available-app-on-linux\"></a>在 Linux 上创建虚拟机规模集和部署高度可用的应用\r 利用虚拟机规模集，可以部署和管理一组相同的、自动缩放的虚拟机。 可以手动缩放规模集中的 VM 数，也可以定义规则，以便根据资源使用情况（如 CPU 使用率、内存需求或网络流量）进行自动缩放。 在本教程中，将在 Azure 中部署虚拟机规模集。 你将学习如何执行以下操作：\r \r > [!div class=\"checklist\"]\r > * 使用 cloud-init 创建可缩放的应用\r > * 创建虚拟机规模集\r > * 增加或减少规模集中的实例数\r > * 查看规模集实例的连接信息\r > * 在规模集中使用数据磁盘\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 如果选择在本地安装并使用 CLI，本教程要求运行 Azure CLI 2.0.4 或更高版本。 运行 `az --version` 即可查找版本。 如果需要进行安装或升级，请参阅[安装 Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-azure-cli?view=azure-cli-latest)。 \r \r ## <a name=\"scale-set-overview\"></a>规模集概述\r 利用虚拟机规模集，可以部署和管理一组相同的、自动缩放的虚拟机。 规模集中的 VM 将分布在逻辑容错域和更新域的一个或多个*放置组*中。 这些放置组由配置类似的 VM 组成，与[可用性集](tutorial-availability-sets.md)相似。\r \r 可以根据需要在规模集中创建 VM。 可以定义自动缩放规则来控制如何以及何时在规模集中添加或删除 VM。 这些规则可以根据 CPU 负载、内存用量或网络流量等指标触发。\r \r 使用 Azure 平台映像时，规模集最多支持 1,000 个 VM。 对于有重要安装或 VM 自定义要求的工作负荷，可能需要[创建自定义 VM 映像](tutorial-custom-images.md)。 使用自定义映像时，在规模集中最多可以创建 300 个 VM。\r \r ## <a name=\"create-an-app-to-scale\"></a>创建用于缩放的应用\r 对于生产用途，可能需要[创建自定义 VM 映像](tutorial-custom-images.md)，其中包含已安装和配置的应用程序。 在本教程中，我们将在首次启动时自定义 VM，以便快速了解规模集的运作方式。\r \r 上一篇教程已介绍[如何使用 cloud-init 在首次启动时自定义 Linux 虚拟机](tutorial-automate-vm-deployment.md)。 可使用同一个 cloud-init 配置文件安装 NGINX 并运行简单的“Hello World”Node.js 应用。 创建名为“cloud-init.txt”的文件并粘贴以下配置。 请确保已正确复制整个 cloud-init 文件，尤其是第一行：\r \r ```yaml\r #cloud-config\r package_upgrade: true\r packages:\r   - nginx\r   - nodejs\r   - npm\r write_files:\r   - owner: www-data:www-data\r   - path: /etc/nginx/sites-available/default\r     content: |\r       server {\r         listen 80;\r         location / {\r           proxy_pass http://localhost:3000;\r           proxy_http_version 1.1;\r           proxy_set_header Upgrade $http_upgrade;\r           proxy_set_header Connection keep-alive;\r           proxy_set_header Host $host;\r           proxy_cache_bypass $http_upgrade;\r         }\r       }\r   - owner: azureuser:azureuser\r   - path: /home/azureuser/myapp/index.js\r     content: |\r       var express = require('express')\r       var app = express()\r       var os = require('os');\r       app.get('/', function (req, res) {\r         res.send('Hello World from host ' + os.hostname() + '!')\r       })\r       app.listen(3000, function () {\r         console.log('Hello world app listening on port 3000!')\r       })\r runcmd:\r   - service nginx restart\r   - cd \"/home/azureuser/myapp\"\r   - npm init\r   - npm install express -y\r   - nodejs index.js\r ```\r \r ## <a name=\"create-a-scale-set\"></a>创建规模集\r 使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组，然后才能创建规模集。 以下示例在“chinaeast”位置创建名为“myResourceGroupScaleSet”的资源组：\r \r ```azurecli \r az group create --name myResourceGroupScaleSet --location chinaeast\r ```\r \r 现在，使用 [az vmss create](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#create) 创建虚拟机规模集。 以下示例创建名为“myScaleSet”的规模集，使用 cloud-int 文件自定义 VM，然后生成 SSH 密钥（如果不存在）：\r \r ```azurecli \r az vmss create \\\r   --resource-group myResourceGroupScaleSet \\\r   --name myScaleSet \\\r   --image UbuntuLTS \\\r   --upgrade-policy-mode automatic \\\r   --custom-data cloud-init.txt \\\r   --admin-username azureuser \\\r   --generate-ssh-keys\r ```\r \r 创建和配置所有的规模集资源和 VM 需要几分钟时间。 在 Azure CLI 返回提示之后，仍然存在继续运行的后台任务。 可能还需等待几分钟才能访问应用。\r \r ## <a name=\"allow-web-traffic\"></a>允许 Web 流量\r 已自动创建一个负载均衡器，作为虚拟机规模集的一部分。 负载均衡器使用负载均衡器规则将流量分配到一组定义的 VM。 可以在下一篇教程[如何在 Azure 中实现虚拟机的负载均衡](tutorial-load-balancer.md)中详细了解负载均衡器的概念和配置。\r \r 若要允许通信流到达 Web 应用，请使用 [az network lb rule create](https://docs.azure.cn/zh-cn/cli/network/lb/rule?view=azure-cli-latest#create) 创建一个规则。 以下示例创建名为“myLoadBalancerRuleWeb”的规则：\r \r ```azurecli \r az network lb rule create \\\r   --resource-group myResourceGroupScaleSet \\\r   --name myLoadBalancerRuleWeb \\\r   --lb-name myScaleSetLB \\\r   --backend-pool-name myScaleSetLBBEPool \\\r   --backend-port 80 \\\r   --frontend-ip-name loadBalancerFrontEnd \\\r   --frontend-port 80 \\\r   --protocol tcp\r ```\r \r ## <a name=\"test-your-app\"></a>测试应用\r 若要在 Web 上查看 Node.js 应用，请使用 [az network public-ip show](https://docs.azure.cn/zh-cn/cli/network/public-ip?view=azure-cli-latest#show) 获取负载均衡器的公共 IP 地址。 以下示例获取创建为规模集一部分的“myScaleSetLBPublicIP”的 IP 地址：\r \r ```azurecli \r az network public-ip show \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSetLBPublicIP \\\r     --query [ipAddress] \\\r     --output tsv\r ```\r \r 将公共 IP 地址输入到 Web 浏览器中。 将显示应用，包括负载均衡器将流量分发到的 VM 的主机名：\r \r ![运行 Node.js 应用](./media/tutorial-create-vmss/running-nodejs-app.png)\r \r 若要查看规模集的实际运行情况，可以强制刷新 Web 浏览器，以查看负载均衡器如何在运行应用的所有 VM 之间分发流量。\r \r ## <a name=\"management-tasks\"></a>管理任务\r 在规模集的整个生命周期内，可能需要运行一个或多个管理任务。 此外，可能还需要创建自动执行各种生命周期任务的脚本。 Azure CLI 2.0 提供一种用于执行这些任务的快速方法。 以下是一些常见任务。\r \r ### <a name=\"view-vms-in-a-scale-set\"></a>查看规模集中的 VM\r 若要查看规模集中运行的 VM 列表，请使用 [az vmss list-instances](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#list-instances)，如下所示：\r \r ```azurecli \r az vmss list-instances \\\r   --resource-group myResourceGroupScaleSet \\\r   --name myScaleSet \\\r   --output table\r ```\r \r 输出类似于以下示例：\r \r ```azurecli \r   InstanceId  LatestModelApplied    Location    Name          ProvisioningState    ResourceGroup            VmId\r ------------  --------------------  ----------  ------------  -------------------  -----------------------  ------------------------------------\r            1  True                  chinaeast   myScaleSet_1  Succeeded            MYRESOURCEGROUPSCALESET  c72ddc34-6c41-4a53-b89e-dd24f27b30ab\r            3  True                  chinaeast   myScaleSet_3  Succeeded            MYRESOURCEGROUPSCALESET  44266022-65c3-49c5-92dd-88ffa64f95da\r ```\r \r ### <a name=\"increase-or-decrease-vm-instances\"></a>增加或减少 VM 实例\r 若要查看规模集中当前包含的实例数，请使用 [az vmss show](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#show) 并查询 “sku.capacity”：\r \r ```azurecli \r az vmss show \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSet \\\r     --query [sku.capacity] \\\r     --output table\r ```\r \r 然后，可以使用 [az vmss scale](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#scale) 手动增加或减少规模集中虚拟机的数目。 以下示例将规模集中 VM 的数目设置为 5：\r \r ```azurecli \r az vmss scale \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSet \\\r     --new-capacity 5\r ```\r \r 利用自动缩放规则，可以定义如何根据网络流量或 CPU 使用率等需求，增加或减少规模集中 VM 的数目。 目前，不能在 Azure CLI 2.0 中设置这些规则。 使用 [Azure 门户](https://portal.azure.cn)配置自动缩放。\r \r ### <a name=\"get-connection-info\"></a>获取连接信息\r 若要获取有关规模集中 VM 的连接信息，请使用 [az vmss list-instance-connection-info](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#list-instance-connection-info)。 此命令为每个允许采用 SSH 进行连接的 VM 输出公共 IP 地址和端口：\r \r ```azurecli \r az vmss list-instance-connection-info \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSet\r ```\r \r ## <a name=\"use-data-disks-with-scale-sets\"></a>将数据磁盘与规模集配合使用\r 可以创建数据磁盘并与规模集配合使用。 前面的教程介绍了如何[管理 Azure 磁盘](tutorial-manage-disks.md)，其中概述了在数据磁盘而非 OS 磁盘上生成应用的最佳做法和用于实现此目的的性能改进。\r \r ### <a name=\"create-scale-set-with-data-disks\"></a>创建具有数据磁盘的规模集\r 若要创建规模集并附加数据磁盘，请将 `--data-disk-sizes-gb` 参数添加到 [az vmss create](https://docs.azure.cn/zh-cn/cli/vmss?view=azure-cli-latest#create) 命令中。 以下示例创建一个规模集，它具有附加到每个实例的 50 GB 数据磁盘：\r \r ```azurecli \r az vmss create \\\r   --resource-group myResourceGroupScaleSet \\\r   --name myScaleSetDisks \\\r   --image UbuntuLTS \\\r   --upgrade-policy-mode automatic \\\r   --custom-data cloud-init.txt \\\r   --admin-username azureuser \\\r   --generate-ssh-keys \\\r   --data-disk-sizes-gb 50\r ```\r \r 删除规模集中的实例时，也会删除所有附加的数据磁盘。\r \r ### <a name=\"add-data-disks\"></a>添加数据磁盘\r 若要向规模集中的实例添加数据磁盘，请使用 [az vmss disk attach](https://docs.azure.cn/zh-cn/cli/vmss/disk?view=azure-cli-latest#attach)。 以下示例向每个实例添加一个 50 GB 的磁盘：\r \r ```azurecli \r az vmss disk attach \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSet \\\r     --size-gb 50 \\\r     --lun 2\r ```\r \r ### <a name=\"detach-data-disks\"></a>分离数据磁盘\r 若要删除附加到规模集中实例的数据磁盘，请使用 [az vmss disk detach](https://docs.azure.cn/zh-cn/cli/vmss/disk?view=azure-cli-latest#detach)。 以下示例在 LUN 2 删除每个实例中的数据磁盘：\r \r ```azurecli \r az vmss disk detach \\\r     --resource-group myResourceGroupScaleSet \\\r     --name myScaleSet \\\r     --lun 2\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r 在本教程中，你已创建了一个虚拟机规模集。 你已了解如何：\r \r > [!div class=\"checklist\"]\r > * 使用 cloud-init 创建可缩放的应用\r > * 创建虚拟机规模集\r > * 增加或减少规模集中的实例数\r > * 查看规模集实例的连接信息\r > * 在规模集中使用数据磁盘\r \r 请继续学习下一教程，详细了解虚拟机的负载均衡概念。\r \r > [!div class=\"nextstepaction\"]\r > [对虚拟机进行负载均衡](tutorial-load-balancer.md)\r \r <!--Update_Description: update meta properties， wording update-->"}