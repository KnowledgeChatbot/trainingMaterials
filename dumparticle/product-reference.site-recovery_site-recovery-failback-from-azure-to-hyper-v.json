{"Title":"在 Azure Site Recovery 中进行针对 Hyper-v 虚拟机的故障回复","Description":"Azure Site Recovery 可以协调虚拟机和物理服务器的复制、故障转移与恢复。 了解如何从 Azure 故障回复到本地数据中心。","Content":"# <a name=\"failback-in-site-recovery-for-hyper-v-virtual-machines\"></a>在 Site Recovery 中进行针对 Hyper-v 虚拟机的故障回复  本文介绍如何故障回复受 Site Recovery 保护的虚拟机。  ## <a name=\"prerequisites\"></a>先决条件 1. 确保主站点 VMM 服务器/Hyper-V 服务器已连接。 2. 应已在虚拟机上执行“提交”操作。  ## <a name=\"why-is-there-no-button-called-failback\"></a>为何没有名为“故障回复”的按钮？ 在门户中，没有名为“故障回复”的显式手势。 故障回复是一个步骤，通过该步骤返回到主站点。 根据定义，故障转移是指将虚拟机从主（本地）站点故障转移到恢复 (Azure) 站点，而故障回复是指将虚拟机从恢复站点故障转移回主站点。  启动故障转移时，边栏选项卡会显示关于作业方向的信息。 如果方向为从 Azure 到本地，则为故障回复。  ## <a name=\"why-is-there-only-a-planned-failover-gesture-to-failback\"></a>为何对于故障回复，只有一个计划的故障转移手势？ Azure 是高度可用的环境，虚拟机将始终可用。 故障回复是一个计划的活动，可以决定进行短暂的停机，以便工作负荷在本地再次运行。 这不会丢失数据。 因此，我们只提供计划的故障转移手势，方便你关闭 Azure 中的 VM、下载最新更改，确保没有数据丢失。  ## <a name=\"do-i-need-a-process-server-in-azure-to-failback-to-hyper-v\"></a>Hyper-v 的故障回复是否需要在 Azure 中使用进程服务器？ 不。仅当保护 VMware 虚拟机时才需要进程服务器。 Hyper-v 虚拟机的保护/故障回复均不需要部署任何其他组件。  ## <a name=\"initiate-failback\"></a>启动故障回复 从主要位置故障转移到辅助位置后，复制的虚拟机不受 Site Recovery 的保护，辅助位置现在充当活动位置。 请遵循以下过程故障回复到原始主站点。 本过程描述如何对恢复计划运行计划的故障转移。 或者，也可以在“**虚拟机**”选项卡上对单个虚拟机运行故障转移。  1. 选择“**恢复计划**” > “*recoveryplan_name*”。 单击“**故障转移**” > “**计划的故障转移**”。 2. 在**确认计划的故障转移**页上，选择源和目标位置。 请注意故障转移方向。 如果从主要位置故障转移已按预期完成，并且所有虚拟机都位于辅助位置，则本部分仅供参考。 3. 如果要从 Azure 故障回复，请在“**数据同步**”中选择设置：     * **在故障转移之前同步数据（仅同步增量更改）** - 此选项可最大程度地减少虚拟机的停机时间，因为它可在不关闭虚拟机的情况下执行同步。 此选项执行以下操作：      * 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。      * 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的增量更改集将传输到本地服务器，本地虚拟机会启动。      - **仅在故障转移期间同步数据（完整下载）** - 如果已在 Azure 上长时间运行，则使用此选项。 此选项速度更快，因为我们预计磁盘的大部分已经更改，而且不想花时间进行校验和计算。 此选项会执行磁盘的下载。 如果已删除本地虚拟机，此选项也很有帮助。      > [!NOTE]     > 如果已在 Azure 上运行了一段时间（一个月或以上）或已删除本地虚拟机，我们建议使用此选项。此选项不会执行任何校验和计算。  4. 如果为云启用了数据加密，请在“加密密钥”  中，选择在 VMM 服务器上安装提供者期间启用数据加密时颁发的证书。 5. 启动故障转移。 可以在“**作业**”选项卡上跟踪故障转移进度。 6. 如果选择了在故障转移之前同步数据的选项，请在完成初始数据同步且已准备好在 Azure 中关闭虚拟机后，单击“作业”（计划故障转移工作名称）、“完成故障转移”。 这将关闭 Azure 计算机，将最新更改传输到本地虚拟机，并启动本地 VM。 7. 现在，可以登录到虚拟机，以验证是否可以按预期使用它。 8. 虚拟机处于待提交状态。 单击“**提交**”以提交故障转移。 9. 现在，为了完成故障回复，请单击“**反向复制**”以开始保护主站点中的虚拟机。  ## <a name=\"failback-to-an-alternate-location\"></a>故障回复到备用位置 如果在 [Hyper-V 站点与 Azure](site-recovery-hyper-v-site-to-azure.md) 之间部署了保护，则可以从 Azure 故障回复到备用本地位置。 如果需要设置新的本地硬件，此功能将十分有用。 下面介绍了操作方法。  1. 如果需要设置新的硬件，请在服务器上安装 Windows Server 2012 R2 和 Hyper-V 角色。 2. 创建与原始服务器上的名称相同的虚拟网络交换机。 3. 选择“**受保护的项**” -> 要故障回复的“**保护组**” -> <ProtectionGroupName> -> <VirtualMachineName>，并选择“**计划的故障转移**”。 4. 在“**确认计划的故障转移**”中，选择“**如果本地虚拟机不存在，则创建它**”。 5. 在“主机名”中，选择要在其上放置虚拟机的新 Hyper-V 主机服务器。 6. 在“数据同步”中，我们建议选择选项“**在故障转移之前同步数据**”。 此选项可以最大程度地减少虚拟机的停机时间，因为它可以在不关闭虚拟机的情况下执行同步。 此选项执行以下操作：     * 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。    * 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的更改集将传输到本地服务器，本地虚拟机会启动。 7. 单击复选标记开始故障转移（故障回复）。 8. 在完成初始数据同步并且已准备好在 Azure 中关闭虚拟机后，单击“**作业**” > <planned failover job> > “**完成故障转移**”。 这将关闭 Azure 计算机，将最新更改传输到本地虚拟机，并启动虚拟机。 9. 可以登录到本地虚拟机，以验证一切是否如预期一样。 然后单击“提交”完成故障转移。 10. 单击“**反向复制**”开始保护本地虚拟机。      > [!NOTE]     > 如果在“数据同步”步骤中取消故障回复作业，则本地 VM 会处于损坏状态。 这是因为数据同步将 Azure VM 磁盘中的最新数据复制到本地数据磁盘上，在同步完成之前，磁盘数据并不处于一致状态。 如果在取消数据同步后启动本地 VM，则可能无法启动。 重新触发故障转移以完成数据同步。  ## <a name=\"time-taken-to-failback\"></a>故障回复所需时间 完成数据同步及启动虚拟机所需的时间取决于各种因素。 为了深入了解所需时间，我们需要解释数据同步期间发生的情况。  数据同步会为虚拟机磁盘拍摄快照，然后开始逐块检查并计算其校验和。 计算出的检验和将发送到本地，然后与相同块的本地校验和进行比较。 如果校验和匹配，则不会传输数据块。 如果不匹配，则会将数据块传输到本地。 此传输时间取决于可用带宽。 校验和的速度为每分钟几 GB。   要加快数据下载速度，可将 MARS 代理配置为使用多个线程并行下载。 要了解如何更改代理中的下载线程，请参阅[此文档](https://support.microsoft.com/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)。  ## <a name=\"next-steps\"></a>后续步骤  完成故障回复作业后， **提交** 虚拟机。 提交会删除 Azure 虚拟机及其磁盘，并准备要再次保护的 VM。  在**提交**后，可以启动*反向复制*。 这将启动对虚拟机的保护，将其从本地故障回复到 Azure。 请注意，这样只会复制更改，因为 VM 已在 Azure 中关闭，因此只发送差异性更改。  <!--Update_Description: add Time taken to failback content -->"}