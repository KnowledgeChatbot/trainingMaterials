{"Title":"如何在 Linux 虚拟机上扩展根文件系统","Description":"如何在 Linux 虚拟机上扩展根文件系统","Content":"\r # 如何在 Linux 虚拟机上扩展根文件系统\r \r ## **问题描述**\r \r 通过 Azure 平台部署的 Linux 虚拟机默认的根文件系统容量有限，需要进行扩展。\r \r ## **问题分析**\r \r 由于 Azure 平台部署的 Linux 虚拟机默认根文件系统容量比较小，客户在使用过程中，经常会出现根文件系统用满，导致虚拟机不可用的情况，需要进行手动对根文件系统进行扩容。\r \r ## **解决方案**\r \r > [!IMPORTANT]\r > 在执行如下操作前，一定要针对虚拟机的系统盘进行备份。以下步骤基于 CentOS 6.8，其他 Linux 版本，可能会略有区别。\r \r > [!IMPORTANT]\r > 在 CentOS 7.x 中，默认根分区是 /dev/sda2，仅需要扩展  /dev/sda2 分区，且无需激活。\r \r 1. 通过 Azure portal 关闭虚拟机。\r 2. 执行以下 Powershell 命令，对系统盘进行扩展：\r \r     ```\r     Get-AzureVM -ServiceName \"vfldev\" -Name \"vfldev\" | get-AzureOSDisk \r \r     ## 使用正确的 ServiceName 和 VM Name 取代上述参数。\r \r     Update-AzureDisk –DiskName \"vfldev-vfldev-0-201503091934500547\" -Label \"ResiZedOS\" -ResizedSizeInGB 100\r \r     ## 用步骤一获取的 OSdisk 的名字取代上述的 DiskName，并输入想要扩容的磁盘大小。\r     ```\r \r 3. 通过 Azure portal 启动虚拟机。\r 4. 登陆虚拟机，切换成 root 用户，查看当前的虚拟机的根文件系统容量。\r \r     ```\r     [root@resizeSDA chpaadmin]# df -h\r     Filesystem      Size  Used Avail Use% Mounted on\r     /dev/sda1        30G  1.1G   27G   4% /\r     devtmpfs        832M     0  832M   0% /dev\r     tmpfs           840M     0  840M   0% /dev/shm\r     tmpfs           840M  8.3M  832M   1% /run\r     tmpfs           840M     0  840M   0% /sys/fs/cgroup\r     /dev/sdb1        69G   53M   66G   1% /mnt/resource\r     ```\r \r 5. 打开分区表\r \r     ```\r     [root@resizeSDA chpaadmin]# fdisk /dev/sda\r     Welcome to fdisk (util-linux 2.23.2).\r \r     Changes will remain in memory only, until you decide to write them.\r     Be careful before using the write command.\r \r     Command (m for help): p\r \r     Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors\r     Units = sectors of 1 * 512 = 512 bytes\r     Sector size (logical/physical): 512 bytes / 512 bytes\r     I/O size (minimum/optimal): 512 bytes / 512 bytes\r     Disk label type: dos\r     Disk identifier: 0x00093e4e\r \r     ## 请记录分区信息\r        Device Boot      Start         End      Blocks   Id  System\r     /dev/sda1   *        2048    62914559    31456256   83  Linux\r \r     ## 切换为以 sector 作为计算单元 \r     Command (m for help): u\r     Changing display/entry units to sectors. \r \r     ## 如果显示为上述内容，则继续下一步，如果显示为：\r     Command (m for help): u\r     Changing display/entry units to cylinders (DEPRECATED!).\r \r     ## 则继续执行 u，切换为sector。\r \r     ## 删除分区\r     Command (m for help): d\r     Selected partition 1\r     Partition 1 is deleted\r \r     ## 新建分区\r     Command (m for help): n\r     Partition type:\r        p   primary (0 primary, 0 extended, 4 free)\r        e   extended\r     Select (default p): p\r     Partition number (1-4, default 1):\r     First sector (2048-209715199, default 2048):\r     Using default value 2048\r     Last sector, +sectors or +size{K,M,G} (2048-209715199, default 209715199):\r     Using default value 209715199\r     Partition 1 of type Linux and of size 100 GiB is set\r \r     ## 此时修改分区结束，打印分区信息，确认信息无误\r     Command (m for help): p\r \r     Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors\r     Units = sectors of 1 * 512 = 512 bytes\r     Sector size (logical/physical): 512 bytes / 512 bytes\r     I/O size (minimum/optimal): 512 bytes / 512 bytes\r     Disk label type: dos\r     Disk identifier: 0x00093e4e\r \r     ## 注意，这里的 start 的值，必须和此前的分区表里的信息一致\r        Device Boot      Start         End      Blocks   Id  System\r     /dev/sda1            2048   209715199   104856576   83  Linux\r \r     ## 激活分区\r     Command (m for help): a\r     Selected partition 1\r \r     ## 再次打印分区，确认已激活\r     Command (m for help): p\r \r     Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors\r     Units = sectors of 1 * 512 = 512 bytes\r     Sector size (logical/physical): 512 bytes / 512 bytes\r     I/O size (minimum/optimal): 512 bytes / 512 bytes\r     Disk label type: dos\r     Disk identifier: 0x00093e4e\r \r        Device Boot      Start         End      Blocks   Id  System\r     /dev/sda1   *        2048   209715199   104856576   83  Linux\r \r     ## 如果信息有误，或者不确定，请及时联系我们，如果信息确认无误，写入分区表\r     Command (m for help): wr\r     The partition table has been altered!\r \r     Calling ioctl() to re-read partition table.\r \r     WARNING: Re-reading the partition table failed with error 16: Device or resource busy.\r     The kernel still uses the old table. The new table will be used at\r     the next reboot or after you run partprobe(8) or kpartx(8)\r     Syncing disks.\r     ```\r \r 6. 分区表修改完毕，重启虚拟机。\r \r     ```\r     [root@resizeSDA chpaadmin]# init 6\r     ```\r \r 7. 登陆虚拟机，切换到 root 用户，检查当前根文件系统的容量。\r \r     ```\r     [root@resizeSDA chpaadmin]# df -h\r     Filesystem      Size  Used Avail Use% Mounted on\r     /dev/sda1        30G  1.1G   27G   4% /\r     devtmpfs        832M     0  832M   0% /dev\r     tmpfs           840M     0  840M   0% /dev/shm\r     tmpfs           840M  8.3M  832M   1% /run\r     tmpfs           840M     0  840M   0% /sys/fs/cgroup\r     /dev/sdb1        69G   53M   66G   1% /mnt/resource\r     ```\r \r 8. 修改根文件系统的大小。\r \r     ```\r     [root@resizeSDA chpaadmin]# resize2fs /dev/sda1\r     resize2fs 1.42.9 (28-Dec-2013)\r     Filesystem at /dev/sda1 is mounted on /; on-line resizing required\r     old_desc_blocks = 4, new_desc_blocks = 13\r     The filesystem on /dev/sda1 is now 26214144 blocks long.\r     ```\r \r 9. 检查根文件系统大小。\r \r     ```\r     [root@resizeSDA chpaadmin]# df -h\r     Filesystem      Size  Used Avail Use% Mounted on\r     /dev/sda1        99G  1.1G   93G   2% /\r     devtmpfs        832M     0  832M   0% /dev\r     tmpfs           840M     0  840M   0% /dev/shm\r     tmpfs           840M  8.3M  832M   1% /run\r     tmpfs           840M     0  840M   0% /sys/fs/cgroup\r     /dev/sdb1        69G   53M   66G   1% /mnt/resource\r     ```\r \r 10. 至此，根文件系统扩容完毕。"}