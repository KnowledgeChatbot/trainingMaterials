{"Title":"创建和修改 ExpressRoute 线路：PowerShell：Azure Resource Manager","Description":"本文介绍如何创建、预配、验证、更新、删除和取消预配 ExpressRoute 线路。","Content":"# <a name=\"create-and-modify-an-expressroute-circuit-using-powershell\"></a>使用 PowerShell 创建和修改 ExpressRoute 线路\r > [!div class=\"op_single_selector\"]\r > * [Azure 门户](expressroute-howto-circuit-portal-resource-manager.md)\r > * [PowerShell](expressroute-howto-circuit-arm.md)\r > * [Azure CLI](howto-circuit-cli.md)\r > * [PowerShell（经典）](expressroute-howto-circuit-classic.md)\r >\r >\r 本文介绍如何使用 PowerShell cmdlet 和 Azure 资源管理器部署模型创建 Azure ExpressRoute 线路。 本文还介绍如何查看线路状态，以及如何更新、删除和取消预配线路。\r \r \r ## <a name=\"before-you-begin\"></a>开始之前\r * 安装最新版本的 Azure Resource Manager PowerShell cmdlet。 有关详细信息，请参阅 [Azure PowerShell 概述](../powershell-install-configure.md)。\r * 在开始配置之前，请查看[先决条件](./expressroute-prerequisites.md)和[工作流](./expressroute-workflows.md)。\r \r \r ## <a name=\"create\"></a>创建和预配 ExpressRoute 线路\r ### <a name=\"1-sign-in-to-your-azure-account-and-select-your-subscription\"></a>1.登录到 Azure 帐户，然后选择订阅\r 要开始配置，请登录到 Azure 帐户。 使用下面的示例来帮助连接：\r \r ```powershell\r Login-AzureRmAccount -Environment $(Get-AzureRmEnvironment -Name AzureChinaCloud)\r ```\r \r 检查该帐户的订阅：\r \r ```powershell\r Get-AzureRmSubscription\r ```\r \r 选择要为其创建 ExpressRoute 线路的订阅：\r \r ```powershell\r Select-AzureRmSubscription -SubscriptionId \"<subscription ID>\"\r ```\r \r ### <a name=\"2-get-the-list-of-supported-providers-locations-and-bandwidths\"></a>2.获取支持的提供商、位置和带宽的列表\r 在创建 ExpressRoute 线路之前，需要支持的连接服务提供商、位置和带宽选项的列表。\r \r PowerShell cmdlet **Get-AzureRmExpressRouteServiceProvider** 将返回此信息，在后面的步骤中会用到该信息：\r \r ```powershell\r Get-AzureRmExpressRouteServiceProvider\r ```\r \r 检查连接服务提供商是否已在该处列出。 请记下以下信息，稍后在创建线路时需要用到：\r \r * 名称\r * PeeringLocations\r * BandwidthsOffered\r \r 现在，已经准备创建 ExpressRoute 线路。   \r \r ### <a name=\"3-create-an-expressroute-circuit\"></a>3.创建 ExpressRoute 线路\r 如果还没有资源组，则在创建 ExpressRoute 线路前必须创建一个资源组。 为此，可以运行以下命令：\r \r ```powershell\r New-AzureRmResourceGroup -Name \"ExpressRouteResourceGroup\" -Location \"China North\"\r ```\r \r \r 以下示例演示如何通过位于北京的 Beijing Telecom Ethernet 创建 200-Mbps 的 ExpressRoute 线路。 如果使用其他提供商和其他设置，请在发出请求时替换该信息。 使用以下示例请求新的服务密钥：\r \r ```powershell\r New-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\" -Location \"China North\" -SkuTier Standard -SkuFamily MeteredData -ServiceProviderName \"Beijing Telecom Ethernet\" -PeeringLocation \"Beijing\" -BandwidthInMbps 200\r ```\r \r 请确保指定合适的 SKU 层和 SKU 系列：\r \r - SKU 层决定是否启用 ExpressRoute 标准版或 ExpressRoute 高级版外接程序。 可以指定“Standard”以获取标准 SKU，或指定“Premium”以获取高级版外接程序。\r \r - SKU 系列确定计费类型。 可以指定“Metereddata”以获取数据流量套餐，指定“Unlimiteddata”以获取无限制流量套餐。 可以将计费类型从“Metereddata”更改为“Unlimiteddata”，但不能将类型从“Unlimiteddata”更改为“Metereddata”。\r \r >[!IMPORTANT]\r > 从发布服务密钥的那一刻起，会对 ExpressRoute 线路进行计费。 确保连接服务提供商准备好预配线路后就执行此操作。\r > \r > \r \r 响应将包含服务密钥。 可以通过运行以下命令获取所有这些参数的详细说明：\r \r ```powershell\r get-help New-AzureRmExpressRouteCircuit -detailed\r ```\r \r \r ### <a name=\"4-list-all-expressroute-circuits\"></a>4.列出所有 ExpressRoute 线路\r 若要获取已创建的所有 ExpressRoute 线路的列表，请运行 **Get-AzureRmExpressRouteCircuit** 命令：\r \r ```powershell\r Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r ```\r \r 响应类似于以下示例：\r \r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                           }\r     CircuitProvisioningState          : Enabled\r     ServiceProviderProvisioningState  : NotProvisioned\r     ServiceProviderNotes              :\r     ServiceProviderProperties         : {\r                                           \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                           \"PeeringLocation\": \"Beijing\",\r                                           \"BandwidthInMbps\": 200\r                                         }\r     ServiceKey                        : **************************************\r     Peerings                          : []\r \r 可以随时使用 `Get-AzureRmExpressRouteCircuit` cmdlet 检索此信息。 如果调用不带任何参数，则列出所有线路。 服务密钥会在 ServiceKey 字段中列出：\r \r ```powershell\r Get-AzureRmExpressRouteCircuit\r ```\r \r \r 响应类似于以下示例：\r \r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                           }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : NotProvisioned\r     ServiceProviderNotes             :\r     ServiceProviderProperties        : {\r                                          \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                          \"PeeringLocation\": \"Beijing\",\r                                          \"BandwidthInMbps\": 200\r                                           }\r     ServiceKey                       : **************************************\r     Peerings                         : []\r \r \r 可以通过运行以下命令获取所有这些参数的详细说明：\r \r ```powershell\r get-help Get-AzureRmExpressRouteCircuit -detailed\r ```\r \r ### <a name=\"5-send-the-service-key-to-your-connectivity-provider-for-provisioning\"></a>5.将服务密钥发送给连接服务提供商进行预配\r *ServiceProviderProvisioningState* 提供有关服务提供商端当前预配状态的信息。 “状态”提供 Microsoft 端的状态。 有关线路预配状态的详细信息，请参阅[工作流](expressroute-workflows.md#expressroute-circuit-provisioning-states)。\r \r 创建新的 ExpressRoute 线路时，线路处于以下状态：\r \r     ServiceProviderProvisioningState : NotProvisioned\r     CircuitProvisioningState         : Enabled\r \r \r \r 当连接服务提供商正在为你启用线路时，线路将更改为以下状态：\r \r     ServiceProviderProvisioningState : Provisioning\r     Status                           : Enabled\r \r 只有 ExpressRoute 线路处于以下状态时，才能使用它。\r \r     ServiceProviderProvisioningState : Provisioned\r     CircuitProvisioningState         : Enabled\r \r ### <a name=\"6-periodically-check-the-status-and-the-state-of-the-circuit-key\"></a>6.定期检查线路密钥的状态\r 检查线路密钥的状态，可以通过此状态了解提供商何时启用了线路。 配置线路后，*ServiceProviderProvisioningState* 将显示为“已预配”，如以下示例所示：\r \r ```powershell\r Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r ```\r \r \r 响应类似于以下示例：\r \r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                        }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : Provisioned\r     ServiceProviderNotes             :\r     ServiceProviderProperties        : {\r                                          \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                          \"PeeringLocation\": \"Beijing\",\r                                          \"BandwidthInMbps\": 200\r                                        }\r     ServiceKey                       : **************************************\r     Peerings                         : []\r \r ### <a name=\"7-create-your-routing-configuration\"></a>7.创建路由配置\r \r 有关分步说明，请参阅 [ExpressRoute 线路路由配置](./expressroute-howto-routing-arm.md)一文，了解如何创建和修改线路对等互连。\r \r >[!IMPORTANT]\r > 这些说明只适用于由提供第 2 层连接服务的服务提供商创建的线路。 如果服务提供商提供第 3 层托管服务（通常是 IP VPN，如 MPLS），则连接服务提供商将配置和管理路由。\r > \r > \r \r ### <a name=\"8-link-a-virtual-network-to-an-expressroute-circuit\"></a>8.将虚拟网络链接到 ExpressRoute 线路\r \r 接下来，将虚拟网络链接到 ExpressRoute 线路。 使用资源管理器部署模式时，请参阅[将虚拟网络链接到 ExpressRoute 线路](./expressroute-howto-linkvnet-arm.md)一文。\r \r ## <a name=\"getting-the-status-of-an-expressroute-circuit\"></a>获取 ExpressRoute 线路的状态\r 可以随时使用 **Get-AzureRmExpressRouteCircuit** cmdlet 检索此信息。 如果调用不带任何参数，则列出所有线路。\r \r ```powershell\r Get-AzureRmExpressRouteCircuit\r ```\r \r \r 其响应类似于如下示例：\r \r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                          \"Tier\": \"Standard\",\r                                          \"Family\": \"MeteredData\"\r                                        }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : Provisioned\r     ServiceProviderNotes             :\r     ServiceProviderProperties        : {\r                                             \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                             \"PeeringLocation\": \"Beijing\",\r                                             \"BandwidthInMbps\": 200\r                                           }\r     ServiceKey                       : **************************************\r     Peerings                         : []\r \r \r 可以通过将资源组名称和线路名称作为参数传递给调用来获取有关特定 ExpressRoute 线路的信息：\r \r ```powershell\r Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r ```\r \r \r 响应类似于以下示例：\r \r     Name                             : ExpressRouteARMCircuit\r     ResourceGroupName                : ExpressRouteResourceGroup\r     Location                         : chinanorth\r     Id                               : /subscriptions/***************************/resourceGroups/ExpressRouteResourceGroup/providers/Microsoft.Network/expressRouteCircuits/ExpressRouteARMCircuit\r     Etag                             : W/\"################################\"\r     ProvisioningState                : Succeeded\r     Sku                              : {\r                                          \"Name\": \"Standard_MeteredData\",\r                                             \"Tier\": \"Standard\",\r                                             \"Family\": \"MeteredData\"\r                                           }\r     CircuitProvisioningState         : Enabled\r     ServiceProviderProvisioningState : Provisioned\r     ServiceProviderNotes             :\r     ServiceProviderProperties        : {\r                                          \"ServiceProviderName\": \"Beijing Telecom Ethernet\",\r                                          \"PeeringLocation\": \"Beijing\",\r                                          \"BandwidthInMbps\": 200\r                                           }\r     ServiceKey                       : **************************************\r     Peerings                         : []\r \r \r 可以通过运行以下命令获取所有这些参数的详细说明：\r \r ```powershell\r get-help get-azurededicatedcircuit -detailed\r ```\r \r ## <a name=\"modify\"></a>修改 ExpressRoute 线路\r \r 可以在不影响连接的情况下修改 ExpressRoute 线路的某些属性。\r \r 可以在不停机的情况下执行以下任务：\r \r * 为 ExpressRoute 线路启用或禁用 ExpressRoute 高级版外接程序。\r * 增加 ExpressRoute 线路的带宽，前提是端口上有可用容量。 不支持对线路的带宽进行降级。 \r * 将计量套餐从数据流量套餐更改为无限制流量套餐。 不支持将计量套餐从无限制流量套餐更改为数据流量套餐。\r * 可以启用和禁用允许经典操作。\r \r 有关限制和局限性的详细信息，请参阅 [ExpressRoute 常见问题解答](./expressroute-faqs.md)。\r \r ### <a name=\"to-enable-the-expressroute-premium-add-on\"></a>启用 ExpressRoute 高级版外接程序\r 可以使用以下 PowerShell 代码段为现有线路启用 ExpressRoute 高级版外接程序：\r \r ```powershell\r $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r $ckt.Sku.Tier = \"Premium\"\r $ckt.sku.Name = \"Premium_MeteredData\"\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r 线路现已启用 ExpressRoute 高级版外接程序功能。 该命令成功运行后，我们就会开始对高级版外接程序功能进行计费。\r \r ### <a name=\"to-disable-the-expressroute-premium-add-on\"></a>禁用 ExpressRoute 高级版外接程序\r > [!IMPORTANT]\r > 如果使用的资源超出了标准线路允许的范围，此操作可能会失败。\r > \r > \r \r 请注意以下信息：\r \r - 从高级版降级到标准版之前，必须确保链接到线路的虚拟网络数少于 10 个。 否则，更新请求会失败，并且我们将按高级版费率向你收费。\r \r - 必须取消其他地理政治区域的所有虚拟网络的链接。 否则，更新请求会失败，并且我们将按高级版费率向你收费。\r \r - 路由表中专用对等互连的路由必须少于 4,000。 如果路由表大小超出 4,000 个路由，则会删除 BGP 会话且不会重新启用它，除非已播发前缀的数目低于 4,000。\r \r 可以使用以下 PowerShell cmdlet 为现有线路禁用 ExpressRoute 高级版外接程序：\r \r ```powershell\r $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r $ckt.Sku.Tier = \"Standard\"\r $ckt.sku.Name = \"Standard_MeteredData\"\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r ### <a name=\"to-update-the-expressroute-circuit-bandwidth\"></a>更新 ExpressRoute 线路带宽\r 有关提供商支持的带宽选项，请查看 [ExpressRoute 常见问题解答](./expressroute-faqs.md)。 可以选取大于现有线路大小的任何大小。\r \r > [!IMPORTANT]\r > 如果现有端口上的容量不足，可能需要重新创建 ExpressRoute 线路。 如果该位置没有额外的可用容量，则不能升级线路。\r >\r > 但是，无法在不中断的情况下降低 ExpressRoute 线路的带宽。 带宽降级需要取消对 ExpressRoute 线路的预配，并重新预配新的 ExpressRoute 线路。\r > \r \r 确定所需的大小后，可以使用以下命令调整线路的大小：\r \r ```powershell\r $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r $ckt.ServiceProviderProperties.BandwidthInMbps = 1000\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r \r 将在 Microsoft 端调整线路的大小。 然后，必须联系连接提供商，让他们在那一边根据此更改更新配置。 在发出此通知后，我们将开始向你计收更新后的带宽选项费用。\r \r ### <a name=\"to-move-the-sku-from-metered-to-unlimited\"></a>将 SKU 从按流量计费转为不受限制\r 通过使用下面的 PowerShell 代码片段，可以更改 ExpressRoute 线路的 SKU：\r \r ```powershell\r $ckt = Get-AzureRmExpressRouteCircuit -Name \"ExpressRouteARMCircuit\" -ResourceGroupName \"ExpressRouteResourceGroup\"\r \r $ckt.Sku.Family = \"UnlimitedData\"\r $ckt.sku.Name = \"Premium_UnlimitedData\"\r \r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $ckt\r ```\r \r ### <a name=\"to-control-access-to-the-classic-and-resource-manager-environments\"></a>控制对经典环境和 Resource Manager 环境的访问\r 查看[将 ExpressRoute 线路从经典部署模型转移到资源管理器部署模型](expressroute-howto-move-arm.md)中的说明。  \r \r ## <a name=\"delete\"></a>取消设置和删除 ExpressRoute 线路\r 请注意以下信息：\r \r * 必须取消所有虚拟网络与 ExpressRoute 线路的链接。 如果此操作失败，请查看是否有虚拟网络链接到了该线路。\r * 如果 ExpressRoute 线路服务提供商预配状态为“正在预配”或“已预配”，则必须与服务提供商合作，在他们一端取消预配线路。 在服务提供商取消对线路的预配并通知我们之前，我们会继续保留资源并收费。\r * 如果服务提供商已取消设置线路（服务提供商预配状态设置为“未预配”），可以删除线路。 这样就会停止对线路的计费。\r \r 可以通过运行以下命令来删除 ExpressRoute 线路：\r \r ```powershell\r Remove-AzureRmExpressRouteCircuit -ResourceGroupName \"ExpressRouteResourceGroup\" -Name \"ExpressRouteARMCircuit\"\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 创建线路后，请务必执行以下后续步骤：\r \r - [创建和修改 ExpressRoute 线路的路由](./expressroute-howto-routing-arm.md)\r - [将虚拟网络链接到 ExpressRoute 线路](./expressroute-howto-linkvnet-arm.md)\r \r \r <!--Update_Description:update meta properties and wording-->"}