{"Title":"使用 cloud-init 在 Azure 中自定义 Linux VM","Description":"如何通过 Azure CLI 2.0 使用 cloud-init 在创建期间自定义 Linux VM","Content":"# <a name=\"use-cloud-init-to-customize-a-linux-vm-in-azure\"></a>使用 cloud-init 在 Azure 中自定义 Linux VM\r 本文说明如何在 Azure 中的虚拟机 (VM) 上使用 [cloud-init](https://cloudinit.readthedocs.io) 设置主机名称、更新包以及管理用户帐户。 使用 Azure CLI 2.0 创建 VM 时，这些 cloud-init 脚本将在启动时运行。 有关如何安装应用程序、写入配置文件和插入密钥保管库中密钥的更详细概述，请参阅[本教程](tutorial-automate-vm-deployment.md)。 也可以使用 [Azure CLI 1.0](using-cloud-init-nodejs.md) 执行这些步骤。\r \r ## <a name=\"cloud-init-overview\"></a>Cloud-init 概述\r [Cloud-init](https://cloudinit.readthedocs.io) 是一种广泛使用的方法，用于在首次启动 Linux VM 时对其进行自定义。 可使用 cloud-init 来安装程序包和写入文件，或者配置用户和安全性。 在初始启动期间运行 cloud-init 时，无需额外的步骤和代理即可应用配置。\r \r Cloud-init 还支持不同的发行版。 例如，不需使用 apt-get install 或 yum install 来安装包， 而是可定义要安装的程序包的列表。 Cloud-init 将对所选发行版自动使用本机包管理工具。\r \r 我们正在与合作伙伴协作，将 cloud-init 纳入用户向 Azure 提供的映像中并使其在映像中正常运行。 下表概述了 cloud-init 当前在 Azure 平台映像上的可用性：\r \r | 别名 | 发布者 | 产品 | SKU | Version |\r |:--- |:--- |:--- |:--- |:--- |:--- |\r | UbuntuLTS |Canonical |UbuntuServer |16.04-LTS |最新 |\r | UbuntuLTS |Canonical |UbuntuServer |14.04.5-LTS |最新 |\r | CoreOS |CoreOS |CoreOS |Stable |最新 |\r \r ## <a name=\"set-the-hostname-with-cloud-init\"></a>使用 cloud-init 设置主机名称\r 以 [YAML](http://www.yaml.org) 格式写入 cloud-init 文件。 若要使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 在 Azure 中创建 VM 时运行 cloud-init 脚本，则通过 `--custom-data` 开关指定 cloud-init 文件。 让我们看一些可以使用 cloud-init 文件配置的示例。 一种常见方案是设置 VM 的主机名称。 默认情况下，主机名称与 VM 名称相同。 \r \r 首先，使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组。 以下示例在“chinaeast”位置创建名为“myResourceGroup”的资源组：\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r ```azurecli\r az group create --name myResourceGroup --location chinaeast\r ```\r \r 在当前 shell 中，创建一个名为“cloud_init_hostname.txt”的文件并粘贴下面的配置。 例如，在不处于本地计算机上的 Cloud Shell 中创建文件。 可使用任何想要使用的编辑器。 在 Cloud Shell 中，输入 `sensible-editor cloud_init_hostname.txt` 以创建文件并查看可用编辑器的列表。 请确保已正确复制整个 cloud-init 文件，尤其是第一行：\r \r ```yaml\r #cloud-config\r hostname: myhostname\r ```\r \r 现在，使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM，并通过 `--custom-data cloud_init_hostname.txt` 指定 cloud-init 文件，如下所示：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVMHostname \\\r     --image UbuntuLTS \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --custom-data cloud_init_hostname.txt\r ```\r \r 创建后，Azure CLI 将显示有关 VM 的信息。 使用 `publicIpAddress` 通过 SSH 连接到 VM。 按如下所示输入自己的地址：\r \r ```bash\r ssh azureuser@publicIpAddress\r ```\r \r 若要查看 VM 名称，请使用 `hostname` 命令，如下所示：\r \r ```bash\r hostname\r ```\r \r VM 应将主机名称报告为在 cloud-init 文件中设置的值，如以下示例输出中所示：\r \r ```bash\r myhostname\r ```\r \r ## <a name=\"update-a-vm-with-cloud-init\"></a>使用 cloud-init 更新 VM\r 出于安全目的，你需要配置 VM，以便在首次启动时应用最新的更新。 由于 cloud-init 支持不同 Linux 发行版，因此无需为包管理器指定 `apt` 或 `yum`。 相反，你需要定义 `package_upgrade`，并让 cloud-init 进程确定正在使用的发行版的适当机制。 此工作流允许跨发行版使用相同的 cloud-init 脚本。\r \r 若要查看在操作中的升级过程，请创建一个名为 *cloud_init_upgrade.txt* 的 cloud-init 文件并粘贴下列配置：\r \r ```yaml\r #cloud-config\r package_upgrade: true\r ```\r \r 现在，使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM，并通过 `--custom-data cloud_init_upgrade.txt` 指定 cloud-init 文件，如下所示：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVMUpgrade \\\r     --image UbuntuLTS \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --custom-data cloud_init_upgrade.txt\r ```\r \r 通过 SSH 连接到 VM 的公共 IP 地址显示在先前命令的输出中。 按如下所示输入自己的公共 IP 地址：\r \r ```bash\r ssh azureuser@publicIpAddress\r ```\r \r 运行包管理工具并检查更新。 以下示例在 Ubuntu VM 上使用 `apt-get`。\r \r ```bash\r sudo apt-get upgrade\r ```\r \r Cloud-init 在启动时检查和安装更新后，没有要应用的更新，如下例输出所示：\r \r ```bash\r Reading package lists... Done\r Building dependency tree\r Reading state information... Done\r Calculating upgrade... Done\r 0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\r ```\r \r ## <a name=\"add-a-user-to-a-vm-with-cloud-init\"></a>使用 cloud-init 向 VM 添加用户\r 任何新 Linux VM 的首要任务之一就是，为自己添加用户以避免使用“root”。 SSH 密钥是安全性和可用性的最佳做法。 使用此 cloud-init 脚本将密钥添加到“~/.ssh/authorized_keys”文件。\r \r 若要将用户添加到 Linux VM，请创建一个名为“cloud_init_add_user.txt”的文件并粘贴以下配置。 为“ssh-authorized-keys”提供你自己的公钥（例如“~/.ssh/id_rsa.pub”的内容）。\r \r ```yaml\r #cloud-config\r users:\r   - name: myadminuser\r     groups: sudo\r     shell: /bin/bash\r     sudo: ['ALL=(ALL) NOPASSWD:ALL']\r     ssh-authorized-keys:\r       - ssh-rsa AAAAB3<snip>\r ```\r \r 现在，使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM，并通过 `--custom-data cloud_init_add_user.txt` 指定 cloud-init 文件，如下所示：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVMUser \\\r     --image UbuntuLTS \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --custom-data cloud_init_add_user.txt\r ```\r \r 通过 SSH 连接到 VM 的公共 IP 地址显示在先前命令的输出中。 按如下所示输入自己的公共 IP 地址：\r \r ```bash\r ssh myadminuser@publicIpAddress\r ```\r \r 若要确认已将用户添加到 VM 和指定的组，请查看“/etc/group”文件的内容，如下所示：\r \r ```bash\r cat /etc/group\r ```\r \r 以下示例输出显示“cloud_init_add_user.txt”文件中的用户已被添加至 VM 和相应群组：\r \r ```bash\r root:x:0:\r <snip />\r sudo:x:27:myadminuser\r <snip />\r myadminuser:x:1000:\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r Cloud-init 是一种在 Linux VM 启动时对其进行修改的标准方法。 在 Azure 中，你还可以使用 VM 扩展在 Linux VM 启动时或开始运行后对其进行修改。 例如，你可以使用 Azure VM 扩展在运行中的 VM 上执行脚本，而不只是在首次启动时执行。 有关 VM 扩展的详细信息，请参阅 [VM 扩展和功能](extensions-features.md)，或者，例如有关如何使用扩展，请参阅[使用 VMAccess 扩展管理用户、SSH 并查看或修复 Azure Linux VM 上的磁盘](using-vmaccess-extension.md)。\r <!--Update_Description: update meta properties, wording update-->\r "}