{"Title":"使用 REST 发布 Azure 媒体服务内容","Description":"了解如何创建用于生成流式处理 URL 的定位符。 代码使用 REST API。","Content":"# <a name=\"publish-azure-media-services-content-using-rest\"></a>使用 REST 发布 Azure 媒体服务内容\r > [!div class=\"op_single_selector\"]\r > * [.NET](media-services-deliver-streaming-content.md)\r > * [REST](media-services-rest-deliver-streaming-content.md)\r > * [门户](media-services-portal-publish.md)\r > \r > \r \r ## <a name=\"overview\"></a>概述\r 可通过创建 OnDemand 流式处理定位符并生成流式处理 URL，来流式处理自适应比特率 MP4 集。 [对资产进行编码](media-services-rest-encode-asset.md)主题说明了如何编码成自适应比特率 MP4 集。 如果内容已加密，则在创建定位符之前配置资产传送策略（如[本主题](media-services-rest-configure-asset-delivery-policy.md)中所述）。 \r \r 也可以使用 OnDemand 流式处理定位符生成指向可渐进式下载的 MP4 文件的 URL。  \r \r 本主题说明如何创建 OnDemand 流式处理定位符，以发布资产及生成平滑流式处理、MPEG DASH 和 HLS 流式处理 URL。 此外，还会示范如何生成渐进式下载 URL。\r \r \r             [以下](#types) 部分显示了其值会在 REST 调用中使用的枚举类型。   \r \r > [!NOTE]\r > 访问媒体服务中的实体时，必须在 HTTP 请求中设置特定标头字段和值。 有关详细信息，请参阅[媒体服务 REST API 开发的设置](media-services-rest-how-to-use.md)。\r > \r \r ## <a name=\"connect-to-media-services\"></a>连接到媒体服务\r \r 若要了解如何连接到 AMS API，请参阅[通过 Azure AD 身份验证访问 Azure 媒体服务 API](media-services-use-aad-auth-to-access-ams-api.md)。 \r \r \r ## <a name=\"create-an-ondemand-streaming-locator\"></a>创建 OnDemand 流式处理定位符\r 若要创建 OnDemand 流式处理定位符并获取 URL，需执行以下操作：\r \r 1. 如果内容已加密，请定义访问策略。\r 2. 创建 OnDemand 流式处理定位符。\r 3. 如果计划进行流式处理，请获取资产中的流式处理清单文件 (.ism)。 \r    \r    若计划进行渐进式下载，请获取资产中的 MP4 文件名。 \r 4. 生成清单文件或 MP4 文件的 URL。 \r 5. 请注意，不能使用包含写入或删除权限的 AccessPolicy 创建流式处理定位符。\r \r ### <a name=\"create-an-access-policy\"></a>创建访问策略\r \r >[!NOTE]\r >不同 AMS 策略的策略限制为 1,000,000 个（例如，对于定位器策略或 ContentKeyAuthorizationPolicy）。 如果始终使用相同的日期/访问权限，则应使用相同的策略 ID，例如，用于要长期就地保留的定位符的策略（非上传策略）。 有关详细信息，请参阅[此](media-services-dotnet-manage-entities.md#limit-access-policies)主题。\r \r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstest1&urn%3aSubscriptionId=zbbef702-e769-2233-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1424263184&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=NWE%2f986Hr5lZTzVGKtC%2ftzHm9n6U%2fxpTFULItxKUGC4%3d\r x-ms-version: 2.11\r x-ms-client-request-id: 6bcfd511-a561-448d-a022-a319a89ecffa\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 68\r \r {\"Name\":\"access policy\",\"DurationInMinutes\":43200.0,\"Permissions\":1}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 311\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/AccessPolicies('nb%3Apid%3AUUID%3A69c80d98-7830-407f-a9af-e25f4b0d3e5f')\r Server: Microsoft-IIS/8.5\r request-id: a877528a-bdb4-4414-9862-273f8e64f882\r x-ms-request-id: a877528a-bdb4-4414-9862-273f8e64f882\r x-ms-client-request-id: 6bcfd511-a561-448d-a022-a319a89ecffa\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Wed, 18 Feb 2015 06:52:09 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#AccessPolicies/@Element\",\"Id\":\"nb:pid:UUID:69c80d98-7830-407f-a9af-e25f4b0d3e5f\",\"Created\":\"2015-02-18T06:52:09.8862191Z\",\"LastModified\":\"2015-02-18T06:52:09.8862191Z\",\"Name\":\"access policy\",\"DurationInMinutes\":43200.0,\"Permissions\":1}\r ```\r \r ###<a name=\"create-an-ondemand-streaming-locator\"></a>创建 OnDemand 流式处理定位符\r \r 创建指定资产和资产策略的定位符。\r \r 请求：\r \r ```\r POST https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators HTTP/1.1\r Content-Type: application/json\r DataServiceVersion: 1.0;NetFx\r MaxDataServiceVersion: 3.0;NetFx\r Accept: application/json\r Accept-Charset: UTF-8\r Authorization: Bearer http%3a%2f%2fschemas.xmlsoap.org%2fws%2f2005%2f05%2fidentity%2fclaims%2fnameidentifier=amstest1&urn%3aSubscriptionId=zbbef702-e769-2233-9f16-bc4d3aa97387&http%3a%2f%2fschemas.microsoft.com%2faccesscontrolservice%2f2010%2f07%2fclaims%2fidentityprovider=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&Audience=urn%3aWindowsAzureMediaServices&ExpiresOn=1424263184&Issuer=https%3a%2f%2fwamsprodglobal001acs.accesscontrol.chinacloudapi.cn%2f&HMACSHA256=NWE%2f986Hr5lZTzVGKtC%2ftzHm9n6U%2fxpTFULItxKUGC4%3d\r x-ms-version: 2.11\r x-ms-client-request-id: ac159492-9a0c-40c3-aacc-551b1b4c5f62\r Host: wamsshaclus001rest-hs.chinacloudapp.cn\r Content-Length: 181\r \r {\"AccessPolicyId\":\"nb:pid:UUID:1480030d-c481-430a-9687-535c6a5cb272\",\"AssetId\":\"nb:cid:UUID:cc1e445d-1500-80bd-538e-f1e4b71b465e\",\"StartTime\":\"2015-02-18T06:34:47.267872Z\",\"Type\":2}\r ```\r \r 响应：\r \r ```\r HTTP/1.1 201 Created\r Cache-Control: no-cache\r Content-Length: 637\r Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\r Location: https://wamsshaclus001rest-hs.chinacloudapp.cn/api/Locators('nb%3Alid%3AUUID%3Abe245661-2bbd-4fc6-b14f-9cf9a1492e5e')\r Server: Microsoft-IIS/8.5\r request-id: 5bd5864a-0afd-44c0-a67a-4044a2c9043b\r x-ms-request-id: 5bd5864a-0afd-44c0-a67a-4044a2c9043b\r x-ms-client-request-id: ac159492-9a0c-40c3-aacc-551b1b4c5f62\r X-Content-Type-Options: nosniff\r DataServiceVersion: 3.0;\r X-Powered-By: ASP.NET\r Strict-Transport-Security: max-age=31536000; includeSubDomains\r Date: Wed, 18 Feb 2015 06:58:37 GMT\r \r {\"odata.metadata\":\"https://wamsshaclus001rest-hs.chinacloudapp.cn/api/$metadata#Locators/@Element\",\"Id\":\"nb:lid:UUID:be245661-2bbd-4fc6-b14f-9cf9a1492e5e\",\"ExpirationDateTime\":\"2015-03-20T06:34:47.267872+00:00\",\"Type\":2,\"Path\":\"http://amstest1.streaming.mediaservices.chinacloudapi.cn/be245661-2bbd-4fc6-b14f-9cf9a1492e5e/\",\"BaseUri\":\"http://amstest1.streaming.mediaservices.chinacloudapi.cn\",\"ContentAccessComponent\":\"be245661-2bbd-4fc6-b14f-9cf9a1492e5e\",\"AccessPolicyId\":\"nb:pid:UUID:1480030d-c481-430a-9687-535c6a5cb272\",\"AssetId\":\"nb:cid:UUID:cc1e445d-1500-80bd-538e-f1e4b71b465e\",\"StartTime\":\"2015-02-18T06:34:47.267872+00:00\",\"Name\":null}\r ```\r \r ###<a name=\"build-streaming-urls\"></a>生成流式处理 URL\r \r 使用创建定位符后返回的 **路径** 值生成平滑流式处理、HLS 和 MPEG DASH URL。 \r \r 平滑流式处理： **路径** + 清单文件名 +“/manifest”\r \r 示例：\r \r ```\r http://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest\r ```\r \r HLS：路径 + 清单文件名 + \"/manifest(format=m3u8-aapl)\"\r \r 示例：\r \r ```\r http://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest(format=m3u8-aapl)\r ```\r \r DASH：路径 + 清单文件名 + \"/manifest(format=mpd-time-csf)\"\r \r 示例：\r \r ```\r http://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny.ism/manifest(format=mpd-time-csf)\r ```\r \r ###<a name=\"build-progressive-download-urls\"></a>生成渐进式下载 URL\r \r 使用创建定位符后返回的 **路径** 值生成渐进式下载 URL。   \r \r URL： **路径** + 资产文件 mp4 名称\r \r 示例：\r \r ```\r http://amstest1.streaming.mediaservices.chinacloudapi.cn/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny_H264_650kbps_AAC_und_ch2_96kbps.mp4\r ```\r \r ##<a id=\"types\"></a>枚举类型\r \r ```\r [Flags]\r public enum AccessPermissions\r {\r     None = 0,\r     Read = 1,\r     Write = 2,\r     Delete = 4,\r     List = 8,\r }\r \r public enum LocatorType\r {\r     None = 0,\r     Sas = 1,\r     OnDemandOrigin = 2,\r }\r ```\r \r ## <a name=\"see-also\"></a>另请参阅\r [媒体服务操作 REST API 概述](media-services-rest-how-to-use.md)\r \r [配置资产传送策略](media-services-rest-configure-asset-delivery-policy.md)\r \r "}