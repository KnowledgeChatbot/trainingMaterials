{"Title":"如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别","Description":"如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别","Content":"\r # 如何设置 IoT 中心云到设备消息的默认 TTL 为分钟级别\r \r ## 问题描述\r \r 在文档[使用 IoT 中心发送和接收消息](/iot-hub/iot-hub-devguide-messaging)中，描述云到设备（CloudToDevice, 以下简称 C2D）消息的默认 TTL 最小可以设置为 1 分钟：\r \r ![portal](media/aog-iot-hub-qa-c2d-message-ttl-set-minute-level/portal.png)\r \r 然而 Azure 门户预览上，默认值为 1 小时，无法设置为分钟级别：\r \r ![portal-2](media/aog-iot-hub-qa-c2d-message-ttl-set-minute-level/portal-2.png)\r \r ## 实现方案\r \r C2D 消息的默认 TTL 确实可以设置为最小 1 mins，但是目前只能通过代码实现，而无法通过 Azure 门户预览来操作。目前，使用代码可以通过两种方式操作:\r \r - 发送 C2D 消息的时候，可以指定某条 / 某几条消息里的 `ExpiryTimeUtc` 属性为您需要过期的时间，例如：\r \r     ```\r     var commandMessage = new Message(\r         Encoding.ASCII.GetBytes(\"Cloud to device message.\"));\r     commandMessage.ExpiryTimeUtc = System.DateTime.UtcNow.AddMinutes(1);\r     messageToSend.setExpiryTimeUtc(expireDate);\r     ```\r \r - 可以通过设置 CloudToDevice 里的 `DefaultTtlAsIso8601` 属性来设置默认 TTL，这种方法是为整个 IoT 中心下所有设备的 C2D 的消息设置为同一默认 TTL。\r \r     ```\r     var iothubClient = new IotHubClient(\r     new Uri(\"https://management.chinacloudapi.cn/\"), \r     tokenCredential, \r     new RetryDelegatingHandler());\r     iothubClient.SubscriptionId = subscriptionId;\r \r     var iothubResource = iothubClient.IotHubResource;\r \r     // get iothub description\r     var resourceDescription = iothubResource.Get(rgName, resourceName);\r     Console.WriteLine(resourceDescription.Name);\r \r     // set C2D message default ttl to 1 minute\r     resourceDescription.Properties.CloudToDevice.DefaultTtlAsIso8601 = TimeSpan.FromMinutes(1);\r \r     try\r     { \r         // commit the change                 \r         iothubResource.CreateOrUpdate(rgName, resourceName, resourceDescription);\r         Console.WriteLine(\"Update successfully!\");\r     }\r     catch (Exception ex)\r     {\r         Console.WriteLine(ex.Message);\r     }\r     Console.WriteLine(\"Press ENTER to exit!\");\r     Console.ReadLine();            \r \r     ```\r "}