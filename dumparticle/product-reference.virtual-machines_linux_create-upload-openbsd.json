{"Title":"创建 OpenBSD 磁盘映像并将其上传到 Azure","Description":"了解如何创建和上传包含 OpenBSD 操作系统的虚拟硬盘 (VHD)，以便通过 Azure CLI 创建 Azure 虚拟机","Content":"# <a name=\"create-and-upload-an-openbsd-disk-image-to-azure\"></a>创建 OpenBSD 磁盘映像并将其上传到 Azure\r 本文介绍如何创建和上传包含 OpenBSD 操作系统的虚拟硬盘 (VHD)。 上传后，可将其用作自己的映像，通过 Azure CLI 在 Azure 中创建虚拟机 (VM)。\r \r ## <a name=\"prerequisites\"></a>先决条件\r 本文假设拥有以下项目：\r \r * Azure 订阅 - 如果没有帐户，只需几分钟即可创建一个。 了解如何[创建试用帐户](https://www.azure.cn/pricing/1rmb-trial/)。  \r * Azure CLI 2.0 - 确保已安装了最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-azure-cli?view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r * 安装在 .vhd 文件中的 OpenBSD 操作系统 - 必须将受支持的 OpenBSD 操作系统（6.1 版）安装到虚拟硬盘中。 可使用多种工具创建 .vhd 文件。 例如，可使用 Hyper-V 等虚拟化解决方案创建 .vhd 文件并安装操作系统。 有关如何安装和使用 Hyper-V 的说明，请参阅[安装 Hyper-V 并创建虚拟机](http://technet.microsoft.com/library/hh846766.aspx)。\r \r ## <a name=\"prepare-openbsd-image-for-azure\"></a>为 Azure 准备 OpenBSD 映像\r 在安装了 OpenBSD 操作系统 6.1（已添加 Hyper-V 支持）的 VM上，完成以下步骤：\r \r 1. 如果安装期间未启用 DHCP，请启用该服务，如下所示：\r \r     ```sh    \r     echo dhcp > /etc/hostname.hvn0\r     ```\r \r 2. 设置串行控制台，如下所示：\r \r     ```sh\r     echo \"stty com0 115200\" >> /etc/boot.conf\r     echo \"set tty com0\" >> /etc/boot.conf\r     ```\r \r 3. 配置包安装，如下所示：\r \r     ```sh\r     echo \"https://ftp.openbsd.org/pub/OpenBSD\" > /etc/installurl\r     ```\r \r 4. 默认情况下，禁止在 Azure 中的虚拟机上使用 `root` 用户。 用户可以对 OpenBSD VM 使用 `doas` 命令，通过提升的权限运行命令。 默认启用 Doas。 有关详细信息，请参阅 [doas.conf](http://man.openbsd.org/doas.conf.5)。 \r \r 5. 安装并配置 Azure 代理的先决条件，如下所示：\r \r     ```sh\r     pkg_add py-setuptools openssl git\r     ln -sf /usr/local/bin/python2.7 /usr/local/bin/python\r     ln -sf /usr/local/bin/python2.7-2to3 /usr/local/bin/2to3\r     ln -sf /usr/local/bin/python2.7-config /usr/local/bin/python-config\r     ln -sf /usr/local/bin/pydoc2.7  /usr/local/bin/pydoc\r     ```\r \r 6. 始终可以在 [Github](https://github.com/Azure/WALinuxAgent/releases) 上找到 Azure 代理的最新版本。 安装代理，如下所示：\r \r     ```sh\r     git clone https://github.com/Azure/WALinuxAgent \r     cd WALinuxAgent\r     python setup.py install\r     waagent -register-service\r     ```\r \r     > [!IMPORTANT]\r     > 安装 Azure 代理后，最好验证它是否正在运行，如下所示：\r     >\r     > ```bash\r     > ps auxw | grep waagent\r     > root     79309  0.0  1.5  9184 15356 p1  S      4:11PM    0:00.46 python /usr/local/sbin/waagent -daemon (python2.7)\r     > cat /var/log/waagent.log\r     > ```\r \r 7. 取消设置系统可清除系统并使其适用于重新设置。 以下命令还会删除上次预配的用户帐户和关联数据：\r \r     ```sh\r     waagent -deprovision+user -force\r     ```\r \r 现在可以关闭 VM。\r \r ## <a name=\"prepare-the-vhd\"></a>准备 VHD\r Azure 不支持 VHDX 格式，仅支持**固定大小的 VHD**。 可使用 Hyper-V 管理器或 Powershell [convert-vhd](https://technet.microsoft.com/itpro/powershell/windows/hyper-v/convert-vhd) cmdlet 将磁盘转换为固定 VHD 格式。 示例如下。\r \r ```powershell\r Convert-VHD OpenBSD61.vhdx OpenBSD61.vhd -VHDType Fixed\r ```\r \r ## <a name=\"create-storage-resources-and-upload\"></a>创建存储资源并上传\r 首先，使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组。 以下示例在“chinaeast”位置创建名为“myResourceGroup”的资源组：\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r ```azurecli\r az group create --name myResourceGroup --location chinaeast\r ```\r \r 若要上传 VHD，请使用 [az storage account create](https://docs.azure.cn/zh-cn/cli/storage/account?view=azure-cli-latest#create) 创建存储帐户。 存储帐户名称必须唯一，因此，请提供自己的名称。 以下示例创建一个名为 mystorageaccount 的存储帐户：\r \r ```azurecli\r az storage account create --resource-group myResourceGroup \\\r     --name mystorageaccount \\\r     --location chinaeast \\\r     --sku Premium_LRS\r ```\r \r 若要控制对存储帐户的访问，请按如下所示，使用 [az storage account key list](https://docs.azure.cn/zh-cn/cli/storage/account/keys?view=azure-cli-latest#list) 获取存储密钥：\r \r ```azurecli\r STORAGE_KEY=$(az storage account keys list \\\r     --resource-group myResourceGroup \\\r     --account-name mystorageaccount \\\r     --query \"[?keyName=='key1']  | [0].value\" -o tsv)\r ```\r \r 若要在逻辑上分隔上传的 VHD，请使用 [az storage container create](https://docs.azure.cn/zh-cn/cli/storage/container?view=azure-cli-latest#create) 在存储帐户中创建容器：\r \r ```azurecli\r az storage container create \\\r     --name vhds \\\r     --account-name mystorageaccount \\\r     --account-key ${STORAGE_KEY}\r ```\r \r 最后，请使用 [az storage blob upload](https://docs.azure.cn/zh-cn/cli/storage/blob?view=azure-cli-latest#upload) 上传 VHD，如下所示：\r \r ```azurecli\r az storage blob upload \\\r     --container-name vhds \\\r     --file ./OpenBSD61.vhd \\\r     --name OpenBSD61.vhd \\\r     --account-name mystorageaccount \\\r     --account-key ${STORAGE_KEY}\r ```\r \r ## <a name=\"create-vm-from-your-vhd\"></a>从 VHD 创建 VM\r 可使用[示例脚本](../scripts/virtual-machines-linux-cli-sample-create-vm-vhd.md)或直接使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM。 若要指定上传的 OpenBSD VHD，请使用 `--image` 参数，如下所示：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myOpenBSD61 \\\r     --image \"https://mystorageaccount.blob.core.chinacloudapi.cn/vhds/OpenBSD61.vhd\" \\\r     --os-type linux \\\r     --admin-username azureuser \\\r     --ssh-key-value ~/.ssh/id_rsa.pub\r ```\r \r 请使用 [az vm list-ip-addresses](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#list-ip-addresses) 获取 OpenBSD VM 的 IP 地址，如下所示：\r \r ```azurecli\r az vm list-ip-addresses --resource-group myResourceGroup --name myOpenBSD61\r ```\r \r 现在，可如常使用 SSH 连接到 OpenBSD VM：\r \r ```bash\r ssh azureuser@<ip address>\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r 若要深入了解 OpenBSD6.1 上的 Hyper-V 支持，请阅读 [OpenBSD 6.1](https://www.openbsd.org/61.html) 和 [hyperv.4](http://man.openbsd.org/hyperv.4)。\r \r 若要从托管磁盘创建 VM，请阅读 [az disk](https://docs.azure.cn/zh-cn/cli/disk?view=azure-cli-latest)。\r \r <!--Update_Description: update meta properties， update link-->\r "}