{"Title":"使用虚拟网络连接到 Kafka - Azure HDInsight","Description":"了解如何通过 Azure 虚拟网络直接连接到 Kafka on HDInsight。 了解如何使用 VPN 网关从开发客户端连接到 Kafka，或使用 VPN 网关设备从本地网络中的客户端连接到 Kafka。","Content":"# <a name=\"connect-to-kafka-on-hdinsight-through-an-azure-virtual-network\"></a>通过 Azure 虚拟网络连接到 Kafka on HDInsight\r \r 了解如何通过 Azure 虚拟网络直接连接到 Kafka on HDInsight。 本文档提供有关使用以下配置连接到 Kafka 的信息：\r \r * 从本地网络中的资源。 使用本地网络上的 VPN 设备（软件或硬件）建立此连接。\r * 使用 VPN 软件客户端从开发环境。\r \r ## <a name=\"architecture-and-planning\"></a>架构与规划\r \r HDInsight 不允许通过公共 Internet 直接连接到 Kafka。 Kafka 客户端（生成者和使用者）必须使用以下连接方法之一：\r \r * 在 Kafka on HDInsight 所在的同一个虚拟网络中运行客户端。 [Apache Kafka on HDInsight 快速入门](apache-kafka-get-started.md)中使用了此配置。 客户端直接在 HDInsight 群集节点上运行，或者在同一网络中的另一个虚拟机上运行。\r \r * 将专用网络（例如本地网络）连接到虚拟网络。 此配置允许本地网络中的客户端直接使用 Kafka。 若要启用此配置，请执行以下任务：\r \r     1. 创建虚拟网络。\r     2. 创建使用站点到站点配置的 VPN 网关。 本文档中使用的配置连接到本地网络中的 VPN 网关设备。\r     3. 在虚拟网络中创建 DNS 服务器。\r     4. 在每个网络中的 DNS 服务器之间配置转发。\r     5. 在虚拟网络中安装 Kafka on HDInsight。\r \r     有关详细信息，请参阅[从本地网络连接到 Kafka](#on-premises) 部分。 \r \r * 使用 VPN 网关和 VPN 客户端将单个计算机连接到虚拟网络。 若要启用此配置，请执行以下任务：\r \r     1. 创建虚拟网络。\r     2. 创建使用点到站点配置的 VPN 网关。 此配置提供可以安装在 Windows 客户端上的 VPN 客户端。\r     3. 在虚拟网络中安装 Kafka on HDInsight。\r     4. 为 IP 播发配置 Kafka。 此配置允许客户端使用 IP 地址而不是域名建立连接。\r     5. 在开发系统上下载并使用 VPN 客户端。\r \r     有关详细信息，请参阅[使用 VPN 客户端连接到 Kafka](#vpnclient) 部分。\r \r     > [!WARNING]\r     > 由于存在以下限制，只建议将此配置用于开发目的：\r     >\r     > * 每个客户端必须使用 VPN 软件客户端建立连接。 Azure 仅提供基于 Windows 的客户端。\r     > * VPN 客户端不会向虚拟网络传递名称解析请求，因此，必须使用 IP 寻址来与 Kafka 通信。 IP 通信需要在 Kafka 群集上完成其他配置。\r \r 有关在 Azure 虚拟网络中使用 HDInsight 的详细信息，请参阅[使用 Azure 虚拟网络扩展 HDInsight](../hdinsight-extend-hadoop-virtual-network.md)。\r \r ## <a id=\"on-premises\"></a> 连接到本地网络中的 Kafka\r \r 若要创建可与本地网络通信的 Kafka 群集，请遵循[将 HDInsight 连接到本地网络](../connect-on-premises-network.md)文档中所述的步骤。\r \r > [!IMPORTANT]\r > 创建 HDInsight 群集时，请选择“Kafka”群集类型。\r \r 这些步骤创建以下配置：\r \r * Azure 虚拟网络\r * 站点到站点 VPN 网关\r * Azure 存储帐户（由 HDInsight 使用）\r * Kafka on HDInsight\r \r 若要验证 Kafka 客户端是否可从本地连接到群集，请使用[示例：Python 客户端](#python-client)部分中的步骤。\r \r ## <a id=\"vpnclient\"></a>使用 VPN 客户端连接到 Kafka\r \r 使用本部分中的步骤创建以下配置：\r \r * Azure 虚拟网络\r * 点到站点 VPN 网关\r * Azure 存储帐户（由 HDInsight 使用）\r * Kafka on HDInsight\r \r 1. 遵循[为点到站点连接使用自签名证书](../../vpn-gateway/vpn-gateway-certificates-point-to-site.md)文档中所述的步骤。 本文档创建网关所需的证书。\r \r 2. 打开 PowerShell 提示符，并使用下列代码登录 Azure 订阅：\r \r     ```powershell\r     Add-AzureRmAccount -EnvironmentName AzureChinaCloud\r     # If you have multiple subscriptions, uncomment to set the subscription\r     #Select-AzureRmSubscription -SubscriptionName \"name of your subscription\"\r     ```\r \r 3. 使用下列代码创建包含配置信息的变量：\r \r     ```powershell\r     # Prompt for generic information\r     $resourceGroupName = Read-Host \"What is the resource group name?\"\r     $baseName = Read-Host \"What is the base name? It is used to create names for resources, such as 'net-basename' and 'kafka-basename':\"\r     $location = Read-Host \"What Azure Region do you want to create the resources in?\"\r     $rootCert = Read-Host \"What is the file path to the root certificate? It is used to secure the VPN gateway.\"\r \r     # Prompt for HDInsight credentials\r     $adminCreds = Get-Credential -Message \"Enter the HTTPS user name and password for the HDInsight cluster\" -UserName \"admin\"\r     $sshCreds = Get-Credential -Message \"Enter the SSH user name and password for the HDInsight cluster\" -UserName \"sshuser\"\r \r     # Names for Azure resources\r     $networkName = \"net-$baseName\"\r     $clusterName = \"kafka-$baseName\"\r     $storageName = \"store$baseName\" # Can't use dashes in storage names\r     $defaultContainerName = $clusterName\r     $defaultSubnetName = \"default\"\r     $gatewaySubnetName = \"GatewaySubnet\"\r     $gatewayPublicIpName = \"GatewayIp\"\r     $gatewayIpConfigName = \"GatewayConfig\"\r     $vpnRootCertName = \"rootcert\"\r     $vpnName = \"VPNGateway\"\r \r     # Network settings\r     $networkAddressPrefix = \"10.0.0.0/16\"\r     $defaultSubnetPrefix = \"10.0.0.0/24\"\r     $gatewaySubnetPrefix = \"10.0.1.0/24\"\r     $vpnClientAddressPool = \"172.16.201.0/24\"\r \r     # HDInsight settings\r     $HdiWorkerNodes = 4\r     $hdiVersion = \"3.6\"\r     $hdiType = \"Kafka\"\r     ```\r \r 4. 使用下列代码创建 Azure 资源组和虚拟网络：\r \r     ```powershell\r     # Create the resource group that contains everything\r     New-AzureRmResourceGroup -Name $resourceGroupName -Location $location\r \r     # Create the subnet configuration\r     $defaultSubnetConfig = New-AzureRmVirtualNetworkSubnetConfig -Name $defaultSubnetName `\r         -AddressPrefix $defaultSubnetPrefix\r     $gatewaySubnetConfig = New-AzureRmVirtualNetworkSubnetConfig -Name $gatewaySubnetName `\r         -AddressPrefix $gatewaySubnetPrefix\r \r     # Create the subnet\r     New-AzureRmVirtualNetwork -Name $networkName `\r         -ResourceGroupName $resourceGroupName `\r         -Location $location `\r         -AddressPrefix $networkAddressPrefix `\r         -Subnet $defaultSubnetConfig, $gatewaySubnetConfig\r \r     # Get the network & subnet that were created\r     $network = Get-AzureRmVirtualNetwork -Name $networkName `\r         -ResourceGroupName $resourceGroupName\r     $gatewaySubnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $gatewaySubnetName `\r         -VirtualNetwork $network\r     $defaultSubnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $defaultSubnetName `\r         -VirtualNetwork $network\r \r     # Set a dynamic public IP address for the gateway subnet\r     $gatewayPublicIp = New-AzureRmPublicIpAddress -Name $gatewayPublicIpName `\r         -ResourceGroupName $resourceGroupName `\r         -Location $location `\r         -AllocationMethod Dynamic\r     $gatewayIpConfig = New-AzureRmVirtualNetworkGatewayIpConfig -Name $gatewayIpConfigName `\r         -Subnet $gatewaySubnet `\r         -PublicIpAddress $gatewayPublicIp\r \r     # Get the certificate info\r     # Get the full path in case a relative path was passed\r     $rootCertFile = Get-ChildItem $rootCert\r     $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($rootCertFile)\r     $certBase64 = [System.Convert]::ToBase64String($cert.RawData)\r     $p2sRootCert = New-AzureRmVpnClientRootCertificate -Name $vpnRootCertName `\r         -PublicCertData $certBase64\r \r     # Create the VPN gateway\r     New-AzureRmVirtualNetworkGateway -Name $vpnName `\r         -ResourceGroupName $resourceGroupName `\r         -Location $location `\r         -IpConfigurations $gatewayIpConfig `\r         -GatewayType Vpn `\r         -VpnType RouteBased `\r         -EnableBgp $false `\r         -GatewaySku Standard `\r         -VpnClientAddressPool $vpnClientAddressPool `\r         -VpnClientRootCertificates $p2sRootCert\r     ```\r \r     > [!WARNING]\r     > 这个过程可能需要几分钟才能完成。\r \r 5. 使用下列代码创建 Azure 存储帐户和 BLob 容器：\r \r     ```powershell\r     # Create the storage account\r     New-AzureRmStorageAccount `\r         -ResourceGroupName $resourceGroupName `\r         -Name $storageName `\r         -Type Standard_GRS `\r         -Location $location\r \r     # Get the storage account keys and create a context\r     $defaultStorageKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourceGroupName `\r         -Name $storageName)[0].Value\r     $storageContext = New-AzureStorageContext -StorageAccountName $storageName `\r         -StorageAccountKey $defaultStorageKey\r \r     # Create the default storage container\r     New-AzureStorageContainer -Name $defaultContainerName `\r         -Context $storageContext\r     ```\r \r 6. 使用下列代码创建 HDInsight 群集：\r \r     ```powershell\r     # Create the HDInsight cluster\r     New-AzureRmHDInsightCluster `\r         -ResourceGroupName $resourceGroupName `\r         -ClusterName $clusterName `\r         -Location $location `\r         -ClusterSizeInNodes $hdiWorkerNodes `\r         -ClusterType $hdiType `\r         -OSType Linux `\r         -Version $hdiVersion `\r         -HttpCredential $adminCreds `\r         -SshCredential $sshCreds `\r         -DefaultStorageAccountName \"$storageName.blob.core.chinacloudapi.cn\" `\r         -DefaultStorageAccountKey $defaultStorageKey `\r         -DefaultStorageContainer $defaultContainerName `\r         -VirtualNetworkId $network.Id `\r         -SubnetName $defaultSubnet.Id\r     ```\r \r   > [!WARNING]\r   > 此过程完成时间大约为 15 分钟。\r \r 8. 使用下列 cmdlet 为虚拟网络的 Windows VPN 客户端检索 URL：\r \r     ```powershell\r     Get-AzureRmVpnClientPackage -ResourceGroupName $resourceGroupName `\r         -VirtualNetworkGatewayName $vpnName `\r         -ProcessorArchitecture Amd64\r     ```\r \r     要下载 Windows VPN 客户端，请在 Web 浏览器中使用返回的 URI。\r \r ### <a name=\"configure-kafka-for-ip-advertising\"></a>为 IP 播发配置 Kafka\r \r 默认情况下，Zookeeper 向客户端返回 Kafka 中转站的域名。 此配置不使用 VPN 软件客户端，因为它无法对虚拟网络中的实体使用名称解析。 对于此配置，请使用以下步骤来配置 Kafka，以播发 IP 地址而不是域名：\r \r 1. 使用 Web 浏览器，并转到 https://CLUSTERNAME.azurehdinsight.cn。 将 __CLUSTERNAME__ 替换为 Kafka on HDInsight 群集的名称。\r \r     出现提示时，使用群集的 HTTPS 用户名称密码。 将显示群集的 Ambari Web UI。\r \r 2. 要查看 Kafka 的相关信息，请从左侧列表中选择“Kafka”。\r \r     ![服务列表，其中突出显示了 Kafka](./media/apache-kafka-connect-vpn-gateway/select-kafka-service.png)\r \r 3. 要查看 Kafka 配置，请在顶端的中间位置选择“配置”。\r \r     ![Kafka 的配置链接](./media/apache-kafka-connect-vpn-gateway/select-kafka-config.png)\r \r 4. 要查找“kafka-env” 配置，请在右上方的“筛选器”字段中输入 `kafka-env`。\r \r     ![针对 kafka-env 的 Kafka 配置](./media/apache-kafka-connect-vpn-gateway/search-for-kafka-env.png)\r \r 5. 要配置 Kafka 来播发 IP 地址，请将下列文本添加到“kafka-env-template”字段的底部：\r \r     ```\r     # Configure Kafka to advertise IP addresses instead of FQDN\r     IP_ADDRESS=$(hostname -i)\r     echo advertised.listeners=$IP_ADDRESS\r     sed -i.bak -e '/advertised/{/advertised@/!d;}' /usr/hdp/current/kafka-broker/conf/server.properties\r     echo \"advertised.listeners=PLAINTEXT://$IP_ADDRESS:9092\" >> /usr/hdp/current/kafka-broker/conf/server.properties\r     ```\r \r 6. 要配置 Kafka 侦听的接口，请在右上方的“筛选器”字段中输入 `listeners`。\r \r 7. 要将 Kafka 配置为侦听所有网络接口，请将“侦听器”字段的值更改为 `PLAINTEXT://0.0.0.0:9092`。\r \r 8. 单击“保存”按钮以保存配置。 输入描述更改的文本消息。 保存更改后，选择“确定”。\r \r     ![保存配置按钮](./media/apache-kafka-connect-vpn-gateway/save-button.png)\r \r 9. 要防止在重启 Kafka 时出错，请使用“服务操作”按钮，并选择“打开维护模式”。 选择“确定”完成操作。\r \r     ![服务操作，其中已突出显示了“打开维护”](./media/apache-kafka-connect-vpn-gateway/turn-on-maintenance-mode.png)\r \r 10. 要重启 Kafka，请使用“重启”按钮，然后选择“重启所有受影响的项”。 确认重启，在操作完成后再使用“确定”按钮。\r \r     ![重启按钮，其中突出显示了所有受影响的重启项](./media/apache-kafka-connect-vpn-gateway/restart-button.png)\r \r 11. 要禁用维护模式，请使用“服务操作”按钮，然后选择“关闭维护模式”。 选择“确定”完成操作。\r \r ### <a name=\"connect-to-the-vpn-gateway\"></a>连接到 VPN 网关\r \r 要从 Windows 客户端连接到 VPN 网关，请按[配置点到站点连接](../../vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps.md#clientcertificate)文档中“连接到 Azure”部分进行操作。\r \r ## <a id=\"python-client\"></a> 示例：Python 客户端\r \r 若要验证与 Kafka 的连接，请使用以下步骤来创建并运行 Python 生成者和使用者：\r \r 1. 使用以下方法之一检索 Kafka 群集中节点的完全限定域名 (FQDN) 和 IP 地址：\r \r     ```powershell\r     $resourceGroupName = \"The resource group that contains the virtual network used with HDInsight\"\r \r     $clusterNICs = Get-AzureRmNetworkInterface -ResourceGroupName $resourceGroupName | where-object {$_.Name -like \"*node*\"}\r \r     $nodes = @()\r     foreach($nic in $clusterNICs) {\r         $node = new-object System.Object\r         $node | add-member -MemberType NoteProperty -name \"Type\" -value $nic.Name.Split('-')[1]\r         $node | add-member -MemberType NoteProperty -name \"InternalIP\" -value $nic.IpConfigurations.PrivateIpAddress\r         $node | add-member -MemberType NoteProperty -name \"InternalFQDN\" -value $nic.DnsSettings.InternalFqdn\r         $nodes += $node\r     }\r     $nodes | sort-object Type\r     ```\r \r     ```azurecli\r     az network nic list --resource-group <resourcegroupname> --output table --query \"[?contains(name,'node')].{NICname:name,InternalIP:ipConfigurations[0].privateIpAddress,InternalFQDN:dnsSettings.internalFqdn}\"\r     ```\r \r     此脚本假设 `$resourceGroupName` 是包含虚拟网络的 Azure 资源组的名称。\r \r     保存返回的信息供后续步骤使用。\r \r 2. 使用下列命令安装 [kafka-python](http://kafka-python.readthedocs.io/) 客户端：\r     ```\r     pip install kafka-python\r     ```\r 3. 要将数据发送到 Kafka，请使用下列 Python 代码：\r \r   ```python\r   from kafka import KafkaProducer\r   # Replace the `ip_address` entries with the IP address of your worker nodes\r   # NOTE: you don't need the full list of worker nodes, just one or two.\r   producer = KafkaProducer(bootstrap_servers=['kafka_broker_1','kafka_broker_2'])\r   for _ in range(50):\r       producer.send('testtopic', b'test message')\r   ```\r \r     将 `'kafka_broker'` 条目替换为本部分中步骤 1 返回的地址：\r \r     * 如果使用__软件 VPN 客户端__，请将 `kafka_broker` 条目替换为工作节点的 IP 地址。\r \r     * 如果__已启用通过自定义 DNS 服务器进行名称解析__，请将 `kafka_broker` 条目替换为工作节点的 FQDN。\r \r     > [!NOTE]\r     > 此代码将字符串 `test message` 发送给主题 `testtopic`。 Kafka on HDInsight 的默认配置是创建主题（如果它尚不存在）。\r \r 4. 要从 Kafka 检索消息，请使用下列 Python 代码：\r \r    ```python\r    from kafka import KafkaConsumer\r    # Replace the `ip_address` entries with the IP address of your worker nodes\r    # Again, you only need one or two, not the full list.\r    # Note: auto_offset_reset='earliest' resets the starting offset to the beginning\r    #       of the topic\r    consumer = KafkaConsumer(bootstrap_servers=['kafka_broker_1','kafka_broker_2'],auto_offset_reset='earliest')\r    consumer.subscribe(['testtopic'])\r    for msg in consumer:\r      print (msg)\r    ```\r \r     将 `'kafka_broker'` 条目替换为本部分中步骤 1 返回的地址：\r \r     * 如果使用__软件 VPN 客户端__，请将 `kafka_broker` 条目替换为工作节点的 IP 地址。\r \r     * 如果__已启用通过自定义 DNS 服务器进行名称解析__，请将 `kafka_broker` 条目替换为工作节点的 FQDN。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关通过虚拟网络使用 HDInsight 的详细信息，请参阅[使用 Azure 虚拟网络扩展 Azure HDInsight](../hdinsight-extend-hadoop-virtual-network.md) 文档。\r \r 有关使用点到站点 VPN 网关创建 Azure 虚拟网络的详细信息，请参阅下列文档：\r \r * [使用 Azure 门户配置点到站点连接](../../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md)\r \r * [使用 Azure PowerShell 配置点到站点连接](../../vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps.md)\r \r 有关使用 Kafka on HDInsight 的详细信息，请参阅以下文档：\r \r * [Kafka on HDInsight 入门](apache-kafka-get-started.md)\r * [通过 Kafka on HDInsight 使用镜像](apache-kafka-mirroring.md)\r \r <!--Update_Description: update wording and link references-->"}