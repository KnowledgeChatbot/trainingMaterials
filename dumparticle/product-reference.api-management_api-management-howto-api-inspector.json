{"Title":"使用 API 检查器跟踪调用 - Azure API 管理","Description":"了解如何使用 API 检查器跟踪 Azure API 管理中的调用。","Content":"# <a name=\"how-to-use-the-api-inspector-to-trace-calls-in-azure-api-management\"></a>如何使用 API 检查器跟踪 Azure API 管理中的调用\r API 管理提供了一个 API 检查器工具，帮助对 API 进行调试和故障诊断。 API 检查器可以编程方式使用，还可以直接从开发人员门户中使用。 \r \r 除了跟踪操作，API 检查器还跟踪[策略表达式](https://msdn.microsoft.com/library/azure/dn910913.aspx)评估。 \r \r 本指南提供使用 API 检查器的演练。\r \r > [!NOTE]\r > 仅为包含属于[管理员](./api-management-howto-create-groups.md)帐户的订阅密钥的请求生成并提供 API 检查器跟踪。\r > \r > \r \r ## <a name=\"trace-call\"> </a> 使用 API 检查器跟踪调用\r 要使用 API 检查器，请将 **ocp-apim-trace: true** 请求标头添加到操作调用，然后使用 **ocp-apim-trace-location** 响应标头指定的 URL 下载并检查跟踪。 这可以编程方式完成，也可以直接从开发人员门户完成。\r \r 本文介绍如何使用 API 检查器借助在[管理第一个 API](./api-management-get-started.md) 入门教程中配置的 Basic Calculator API 跟踪操作。 如果尚未完成该教程，只需几分钟即可导入 Basic Calculator API，也可以使用所选的其他 API，例如 Echo API。 每个预先配置 Echo API 的 API 管理服务实例，都可用于试验和了解 API 管理。 Echo API 返回任何发送给它的输入。 要使用它，可以调用任何 HTTP 谓词，并且返回的值将只是所发送的内容。 \r \r 若要开始，请在 API 管理服务的 Azure 门户中单击“开发人员门户”。 可以直接从开发人员门户调用操作，这样可以方便地查看和测试 API 的操作。\r \r > 如果尚未创建 API 管理服务实例，请参阅 [Azure API 管理入门][Get started with Azure API Management]教程中的[创建 API 管理服务实例][Create an API Management service instance]。\r > \r > \r \r ![API 管理开发人员门户][api-management-developer-portal-menu]\r \r 从顶部菜单中单击“API”，并单击“Basic Calculator”。\r \r ![Echo API][api-management-api]\r \r 单击“试用”尝试“添加两个整数”操作。\r \r ![试用][api-management-open-console]\r \r 保留默认参数值，并从“订阅密钥”下拉列表中选择要使用的产品的订阅密钥。\r \r 默认情况下，在开发人员门户中，“Ocp-Apim-Trace”标头已设置为“true”。 此标头配置是否生成跟踪。\r \r ![发送][api-management-http-get]\r \r 单击“发送”调用该操作。\r \r ![发送][api-management-send-results]\r \r 响应标头将是 **ocp-apim-trace-location**，值类似于下面的示例。\r \r ```\r ocp-apim-trace-location : https://contosoltdxw7zagdfsprykd.blob.core.chinacloudapi.cn/apiinspectorcontainer/ZW3e23NsW4wQyS-SHjS0Og2-2?sv=2013-08-15&sr=b&sig=Mgx7cMHsLmVDv%2B%2BSzvg3JR8qGTHoOyIAV7xDsZbF7%2Bk%3D&se=2014-05-04T21%3A00%3A13Z&sp=r&verify_guid=a56a17d83de04fcb8b9766df38514742\r ```\r \r 可以从指定的位置下载和查看跟踪，如下一步中所示。 请注意：仅存储最近 100 个日志条目，并会在循环中重用日志位置。 因此，如果启用跟踪进行 100 个以上的调用，最终将就地开始覆盖最初的跟踪。\r \r ## <a name=\"inspect-trace\"> </a>检查跟踪\r 若要查看跟踪中的值，请从 **ocp-apim-trace-location** URL 下载跟踪文件。 它是采用 JSON 格式的文本文件，并包含类似下面示例的条目。\r \r ```json\r {\r     \"traceId\": \"abcd8ea63d134c1fabe6371566c7cbea\",\r     \"traceEntries\": {\r         \"inbound\": [\r             {\r                 \"source\": \"handler\",\r                 \"timestamp\": \"2015-06-23T19:51:35.2998610Z\",\r                 \"elapsed\": \"00:00:00.0725926\",\r                 \"data\": {\r                     \"request\": {\r                         \"method\": \"GET\",\r                         \"url\": \"https://contoso5.azure-api.cn/calc/add?a=51&b=49\",\r                         \"headers\": [\r                             {\r                                 \"name\": \"Ocp-Apim-Subscription-Key\",\r                                 \"value\": \"5d7c41af64a44a68a2ea46580d271a59\"\r                             },\r                             {\r                                 \"name\": \"Connection\",\r                                 \"value\": \"Keep-Alive\"\r                             },\r                             {\r                                 \"name\": \"Host\",\r                                 \"value\": \"contoso5.azure-api.cn\"\r                             }\r                         ]\r                     }\r                 }\r             },\r             {\r                 \"source\": \"mapper\",\r                 \"timestamp\": \"2015-06-23T19:51:35.2998610Z\",\r                 \"elapsed\": \"00:00:00.0726213\",\r                 \"data\": {\r                     \"configuration\": {\r                         \"api\": {\r                             \"from\": \"/calc\",\r                             \"to\": {\r                                 \"scheme\": \"http\",\r                                 \"host\": \"calcapi.cloudapp.net\",\r                                 \"port\": 80,\r                                 \"path\": \"/api\",\r                                 \"queryString\": \"\",\r                                 \"query\": {},\r                                 \"isDefaultPort\": true\r                             }\r                         },\r                         \"operation\": {\r                             \"method\": \"GET\",\r                             \"uriTemplate\": \"/add?a={a}&b={b}\"\r                         },\r                         \"user\": {\r                             \"id\": 1,\r                             \"groups\": [\r                                 \"Administrators\",\r                                 \"Developers\"\r                             ]\r                         },\r                         \"product\": {\r                             \"id\": 1\r                         }\r                     }\r                 }\r             },\r             {\r                 \"source\": \"handler\",\r                 \"timestamp\": \"2015-06-23T19:51:35.2998610Z\",\r                 \"elapsed\": \"00:00:00.0727522\",\r                 \"data\": {\r                     \"message\": \"Request is being forwarded to the backend service.\",\r                     \"request\": {\r                         \"method\": \"GET\",\r                         \"url\": \"http://calcapi.cloudapp.net/api/add?a=51&b=49\",\r                         \"headers\": [\r                             {\r                                 \"name\": \"Ocp-Apim-Subscription-Key\",\r                                 \"value\": \"5d7c41af64a44a68a2ea46580d271a59\"\r                             },\r                             {\r                                 \"name\": \"X-Forwarded-For\",\r                                 \"value\": \"33.52.215.35\"\r                             }\r                         ]\r                     }\r                 }\r             }\r         ],\r         \"outbound\": [\r             {\r                 \"source\": \"handler\",\r                 \"timestamp\": \"2015-06-23T19:51:35.4256650Z\",\r                 \"elapsed\": \"00:00:00.1960601\",\r                 \"data\": {\r                     \"response\": {\r                         \"status\": {\r                             \"code\": 200,\r                             \"reason\": \"OK\"\r                         },\r                         \"headers\": [\r                             {\r                                 \"name\": \"Pragma\",\r                                 \"value\": \"no-cache\"\r                             },\r                             {\r                                 \"name\": \"Content-Length\",\r                                 \"value\": \"124\"\r                             },\r                             {\r                                 \"name\": \"Cache-Control\",\r                                 \"value\": \"no-cache\"\r                             },\r                             {\r                                 \"name\": \"Content-Type\",\r                                 \"value\": \"application/xml; charset=utf-8\"\r                             },\r                             {\r                                 \"name\": \"Date\",\r                                 \"value\": \"Tue, 23 Jun 2015 19:51:35 GMT\"\r                             },\r                             {\r                                 \"name\": \"Expires\",\r                                 \"value\": \"-1\"\r                             },\r                             {\r                                 \"name\": \"Server\",\r                                 \"value\": \"Microsoft-IIS/8.5\"\r                             },\r                             {\r                                 \"name\": \"X-AspNet-Version\",\r                                 \"value\": \"4.0.30319\"\r                             },\r                             {\r                                 \"name\": \"X-Powered-By\",\r                                 \"value\": \"ASP.NET\"\r                             }\r                         ]\r                     }\r                 }\r             },\r             {\r                 \"source\": \"handler\",\r                 \"timestamp\": \"2015-06-23T19:51:35.4256650Z\",\r                 \"elapsed\": \"00:00:00.1961112\",\r                 \"data\": {\r                     \"message\": \"Response headers have been sent to the caller. Starting to stream the response body.\"\r                 }\r             },\r             {\r                 \"source\": \"handler\",\r                 \"timestamp\": \"2015-06-23T19:51:35.4256650Z\",\r                 \"elapsed\": \"00:00:00.1963155\",\r                 \"data\": {\r                     \"message\": \"Response body streaming to the caller is complete.\"\r                 }\r             }\r         ]\r     }\r }\r ```\r \r \r [Use API Inspector to trace a call]: #trace-call\r [Inspect the trace]: #inspect-trace\r [Next steps]: #next-steps\r \r [Configure API settings]: ./api-management-howto-create-apis.md#configure-api-settings\r [Responses]: ./api-management-howto-add-operations.md#responses\r [How create and publish a product]: ./api-management-howto-add-products.md\r \r [Get started with Azure API Management]: ./api-management-get-started.md\r [Create an API Management service instance]: ./api-management-get-started.md#create-service-instance\r [Azure Classic Portal]: https://manage.windowsazure.cn/\r \r \r [api-management-developer-portal-menu]: ./media/api-management-howto-api-inspector/api-management-developer-portal-menu.png\r [api-management-api]: ./media/api-management-howto-api-inspector/api-management-api.png\r [api-management-echo-api-get]: ./media/api-management-howto-api-inspector/api-management-echo-api-get.png\r [api-management-developer-key]: ./media/api-management-howto-api-inspector/api-management-developer-key.png\r [api-management-open-console]: ./media/api-management-howto-api-inspector/api-management-open-console.png\r [api-management-http-get]: ./media/api-management-howto-api-inspector/api-management-http-get.png\r [api-management-send-results]: ./media/api-management-howto-api-inspector/api-management-send-results.png\r \r \r \r \r "}