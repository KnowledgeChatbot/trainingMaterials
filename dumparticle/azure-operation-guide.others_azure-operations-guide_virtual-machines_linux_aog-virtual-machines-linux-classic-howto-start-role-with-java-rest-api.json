{"Title":"Java 调用 Rest api 设置经典 Linux 虚拟机的实例启停","Description":"如何使用 Java 调用 Rest api 设置经典 Linux 虚拟机的实例启停","Content":"\r # Java 调用 Rest api 设置经典 Linux 虚拟机的实例启停\r \r ## 现象描述\r \r 用户可以通过 Rest API 设置经典 Linux 虚拟机实例的启停。在调用该 API 时需要通过 Azure Active Directory(下文简称 AAD) 获取 Token，但是因为中国 Azure 中通过 AAD 的 Application 获取到的 Token 无法操作经典 API，所以需要通过 Client ID 和管理员的用户名密码来获取 Token。\r \r ## 前提条件\r \r 创建一台 Linux 经典虚拟机。\r \r ## 示例代码\r \r ``` Java\r import java.io.DataOutputStream;\r import java.io.File;\r import java.io.FileInputStream;\r import java.io.IOException;\r import java.io.InputStream;\r import java.net.URI;\r import java.net.URISyntaxException;\r import java.net.URL;\r import java.security.KeyManagementException;\r import java.security.*;\r import java.security.KeyStoreException;\r import java.security.NoSuchAlgorithmException;\r import java.security.UnrecoverableKeyException;\r import java.security.cert.X509Certificate;\r import java.util.HashMap;\r import java.util.Map;\r import java.util.Scanner;\r import java.util.concurrent.ExecutionException;\r import java.util.concurrent.ExecutorService;\r import java.util.concurrent.Executors;\r import java.util.concurrent.Future;\r import javax.net.ssl.*;\r import javax.net.ssl.KeyManagerFactory;\r import javax.net.ssl.SSLSocketFactory;\r import javax.net.ssl.TrustManager;\r import org.codehaus.jackson.map.ObjectMapper;\r \r //get Access token for Rest API\r public void GetToken() { \r     ExecutorService service = Executors.newFixedThreadPool(1);\r     AuthenticationContext ac = new AuthenticationContext(\"https://login.chinacloudapi.cn/tenantID\", true, service);\t\r     Future<AuthenticationResult> future = ac.acquireToken(\"https://management.core.chinacloudapi.cn/\", \t\"1950a258-227b-4e31-a9cf-717495945fc2\", \"username\", \"password\", null);\r \tAuthenticationResult result = future.get();\r \tString token = result.getAccessToken();\r \trest(token);\r }\r \r public static void rest(String accessToken) throws IOException{\r     URL url = new URL(String.format(\"https://management.core.chinacloudapi.cn/subID/services/hostedservices/{hostedservices}/deployments/{deployments}/roleinstances/{roleinstancesName}/Operations\"));\r     HttpsURLConnection conn = (HttpsURLConnection)url.openConnection();\r     conn.setRequestProperty(\"x-ms-version\", \"2013-06-01\");\r     conn.setRequestProperty(\"Authorization\", \"Bearer \" + accessToken);\r     conn.setRequestProperty(\"Content-Type\", \"application/xml\");\r \r     //StartRole\r     String roleInstance = new String(\"<StartRoleOperation xmlns=\\\"http://schemas.microsoft.com/windowsazure\\\" xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\">\\n\" + \"<OperationType>StartRoleOperation</OperationType>\\n\" +\t\t                        \"</StartRoleOperation>\");\r     //ShutdownRole             \r     String roleins = new String( \"<ShutdownRoleOperation xmlns=\\\"http://schemas.microsoft.com/windowsazure\\\" xmlns:i=\\\"http://www.w3.org/2001/XMLSchema-instance\\\">\" +\"<OperationType>ShutdownRoleOperation</OperationType>\" +\t                                         \"<PostShutdownAction>StoppedDeallocated</PostShutdownAction>\" +\t\t                                       \"</ShutdownRoleOperation>\");\r     byte[] data = roleInstance.getBytes();\r     conn.setDoOutput(true);\r     conn.setRequestMethod(\"POST\");\r     if (data != null)\r     {\r         DataOutputStream requestStream = new DataOutputStream(conn.getOutputStream());\r         requestStream.write(data);\r         requestStream.flush();\r         requestStream.close();\r     }\r     String mess =  conn.getResponseMessage();\r     int code = conn.getResponseCode(); \r     InputStream input = conn.getErrorStream();\r     if (input == null)\r     input = conn.getInputStream();\r     String response = null;\r     try (Scanner scanner = new Scanner(input)) {\r         scanner.useDelimiter(\"\\\\Z\");\r         response = scanner.next();\r         scanner.close();\r         input.close();\r     }\r }\r ```\r \r ## 参考链接\r \r [Virtual Machines (classic) REST API - Start Role](https://msdn.microsoft.com/en-us/library/jj157189.aspx)\r "}