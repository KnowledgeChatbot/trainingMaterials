{"Title":"在 Azure 虚拟网络中设置 HBase 群集复制","Description":"了解如何设置从一个 HDInsight 版本到另一个版本的 HBase 复制，以实现负载均衡、高可用性、在不造成停机的情况下进行迁移和更新，以及灾难恢复。","Content":"# <a name=\"set-up-hbase-cluster-replication-in-azure-virtual-networks\"></a>在 Azure 虚拟网络中设置 HBase 群集复制\r \r 了解如何在 Azure 中的一个虚拟网络内部或者在两个虚拟网络之间设置 HBase 复制。\r \r 群集复制使用源推送方法。 HBase 群集可以是一个源或目标，也可以同时充当这两个角色。 复制是异步的。 复制的目标是保持最终一致性。 在启用复制的情况下，当源接收到对列系列的编辑时，该编辑将传播到所有目标群集。 当数据从一个群集复制到另一个群集，会跟踪源群集和所有已使用数据的群集，防止复制循环。\r \r 本教程介绍如何设置源-目标复制。 对于其他群集拓扑，请参阅 [Apache HBase 参考指南](http://hbase.apache.org/book.html#_cluster_replication)。\r \r 下面是单个虚拟网络的 HBase 复制用例：\r \r * 负载均衡。 例如，可以在目标群集上运行扫描或 MapReduce 作业，在源群集上引入数据。\r * 添加高可用性。\r * 在不同的 HBase 群集之间迁移数据。\r * 将 Azure HDInsight 群集从一个版本升级到另一个版本。\r \r 下面是两个虚拟网络的 HBase 复制用例：\r \r * 设置灾难恢复。\r * 对应用程序进行负载均衡和分区。\r * 添加高可用性。\r \r 可以使用 [GitHub](https://github.com/Azure/hbase-utils/tree/master/replication) 中的[脚本操作](../hdinsight-hadoop-customize-cluster-linux.md)脚本复制群集。\r \r ## <a name=\"prerequisites\"></a>先决条件\r 在开始学习本教程之前，必须有一个 Azure 订阅。 请参阅[获取 Azure 试用版](https://www.azure.cn/pricing/1rmb-trial/)。\r \r ## <a name=\"set-up-the-environments\"></a>设置环境\r \r 有三个配置选项：\r \r - 两个 HBase 群集位于一个 Azure 虚拟网络中。\r - 两个 HBase 群集位于同一区域的两个不同虚拟网络中。\r - 两个 HBase 群集位于两个不同区域的两个不同虚拟网络中（异地复制）。\r \r 为了帮助设置环境，我们创建了一些 [Azure 资源管理器模板](../../azure-resource-manager/resource-group-overview.md)。 如果想要使用其他方法设置环境，请参阅：\r \r - [在 HDInsight 中创建 Hadoop 群集](../hdinsight-hadoop-provision-linux-clusters.md)\r - [在 Azure 虚拟网络中创建 HBase 群集](apache-hbase-provision-vnet.md)\r \r ### <a name=\"set-up-one-virtual-network\"></a>设置一个虚拟网络\r \r 若要在同一虚拟网络中创建两个 HBase 群集，请选择下图。 模板存储在 [Azure 快速入门模板](https://azure.microsoft.com/resources/templates/101-hdinsight-hbase-replication-one-vnet/)中。\r \r <a href=\"https://portal.azure.cn/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-hdinsight-hbase-replication-one-vnet%2Fazuredeploy.json\" target=\"_blank\"><img src=\"./media/apache-hbase-replication/deploy-to-azure.png\" alt=\"Deploy to Azure\"></a>\r \r ### <a name=\"set-up-two-virtual-networks-in-the-same-region\"></a>在同一区域中设置两个虚拟网络\r \r 若要在同一区域中创建两个使用虚拟网络对等互连的虚拟网络和两个 HBase 群集，请选择下图。 模板存储在 [Azure 快速入门模板](https://azure.microsoft.com/resources/templates/101-hdinsight-hbase-replication-two-vnets-same-region/)中。\r \r <a href=\"https://portal.azure.cn/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-hdinsight-hbase-replication-two-vnets-same-region%2Fazuredeploy.json\" target=\"_blank\"><img src=\"./media/apache-hbase-replication/deploy-to-azure.png\" alt=\"Deploy to Azure\"></a>\r \r >[!NOTE]\r > 必须修改从 GitHub 存储库“azure-quickstart-templates”下载的模板，以适应 Azure 中国云环境。 例如，将一些终结点 -“blob.core.chinacloudapi.cn”替换为“blob.core.chinacloudapi.cn”，将“cloudapp.azure.com”替换为“chinacloudapp.cn”；将允许的位置更改为“中国北部”和“中国东部”；将 HDInsight Linux 版本更改为 Azure 中国区支持的版本 3.5。\r \r 此方案需要[虚拟网络对等互连](../../virtual-network/virtual-network-peering-overview.md)。 模板启用虚拟网络对等互连。   \r \r HBase 复制使用 ZooKeeper VM 的 IP 地址。 必须为目标 HBase ZooKeeper 节点设置静态 IP 地址。\r \r **配置静态 IP 地址**\r \r 1. 登录到 [Azure 门户](https://portal.azure.cn)。\r 2. 在左侧菜单上，选择“资源组”。\r 3. 选择包含目标 HBase 群集的资源组。 这是使用 Resource Manager 模板创建环境时指定的资源组。 可以使用筛选器减少列表中的结果。 可以看到包含两个虚拟网络的资源的列表。\r 4. 选择包含目标 HBase 群集的虚拟网络。 例如，选择 **xxxx-vnet2**。 会列出名称以 **nic-zookeepermode-** 开头的三个设备。 这三个设备是 ZooKeeper VM。\r 5. 选择其中一个 ZooKeeper VM。\r 6. 选择“IP 配置”。\r 7. 在列表中，选择 **ipConfig1**。\r 8. 选择“静态”，复制或记下实际 IP 地址。 运行脚本操作启用复制时，需要用到该 IP 地址。\r \r   ![HDInsight HBase 复制 ZooKeeper 静态 IP 地址](./media/apache-hbase-replication/hdinsight-hbase-replication-zookeeper-static-ip.png)\r \r 9. 重复步骤 6，为另外两个 ZooKeeper 节点设置静态 IP 地址。\r \r 对于跨虚拟网络方案，调用 `hdi_enable_replication.sh` 脚本操作时必须使用 **-ip** 开关。\r \r ### <a name=\"set-up-two-virtual-networks-in-two-different-regions\"></a>在两个不同的区域中设置两个虚拟网络\r \r 若要在两个不同区域创建两个虚拟网络和在 VNet 之间创建 VPN 连接，请单击下图。 模板存储在 [Azure 快速入门模板](https://azure.microsoft.com/resources/templates/101-hdinsight-hbase-replication-geo/)中。\r \r <a href=\"https://portal.azure.cn/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-hdinsight-hbase-replication-geo%2Fazuredeploy.json\" target=\"_blank\"><img src=\"./media/apache-hbase-replication/deploy-to-azure.png\" alt=\"Deploy to Azure\"></a>\r \r >[!NOTE]\r > 必须修改从 GitHub 存储库“azure-quickstart-templates”下载的模板，以适应 Azure 中国云环境。 例如，将一些终结点 -“blob.core.chinacloudapi.cn”替换为“blob.core.chinacloudapi.cn”，将“cloudapp.azure.com”替换为“chinacloudapp.cn”；将允许的位置更改为“中国北部”和“中国东部”；将 HDInsight Linux 版本更改为 Azure 中国区支持的版本 3.5。\r \r 在两个虚拟网络之间创建 VPN 网关。 有关说明，请参阅[创建使用站点到站点连接的虚拟网络](../../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md)。\r \r HBase 复制使用 ZooKeeper VM 的 IP 地址。 必须为目标 HBase ZooKeeper 节点设置静态 IP 地址。 若要设置静态 IP，请参阅本文的[在同一区域中设置两个虚拟网络](#set-up-two-virtual-networks-in-the-same-region)。\r \r 对于跨虚拟网络方案，调用 `hdi_enable_replication.sh` 脚本操作时必须使用 **-ip** 开关。\r \r ## <a name=\"load-test-data\"></a>加载测试数据\r \r 复制群集时，必须指定要复制的表。 在本节中，要将一些数据载入源群集。 下一部分会在两个群集之间启用复制。\r \r 若要创建一个“联系人”表并在其中插入一些数据，请遵照 [HBase 教程：开始在 HDInsight 中使用 Apache HBase](apache-hbase-tutorial-get-started-linux.md) 中的说明。\r \r ## <a name=\"enable-replication\"></a>启用复制\r \r 以下步骤说明如何从 Azure 门户调用脚本操作脚本。 有关使用 Azure PowerShell 和 Azure 命令行工具 (Azure CLI) 运行脚本操作的信息，请参阅[使用脚本操作自定义 HDInsight 群集](../hdinsight-hadoop-customize-cluster-linux.md)。\r \r **从 Azure 门户启用 HBase 复制**\r \r 1. 登录到 [Azure 门户](https://portal.azure.cn)。\r 2. 打开源 HBase 群集。\r 3. 在群集菜单中，选择“脚本操作”。\r 4. 在页面顶部，选择“提交新项”。\r 5. 选择或输入以下信息：\r \r   1. 名称：输入“启用复制”。\r   2. Bash 脚本 URL：输入 https://raw.githubusercontent.com/Azure/hbase-utils/master/replication/hdi_enable_replication.sh。\r   3.  **头**：确保已选定。 清除其他节点类型。\r   4. **参数**：以下示例参数将对所有现有表启用复制，并将源群集中的所有数据复制到目标群集：\r \r           -m hn1 -s <source cluster DNS name> -d <destination cluster DNS name> -sp <source cluster Ambari password> -dp <destination cluster Ambari password> -copydata\r     \r     > [!NOTE]\r     >\r     > 对源和目标群集 DNS 名称使用主机名而不是 FQDN。\r \r 6. 选择“创建” 。 该脚本可能会运行一段时间，尤其是在使用 **-copydata** 参数的情况下。\r \r 必需参数：\r \r |名称|说明|\r |----|-----------|\r |-s、--src-cluster | 指定源 HBase 群集的 DNS 名称。 例如：-s hbsrccluster、--src-cluster=hbsrccluster |\r |-d、--dst-cluster | 指定目标（副本）HBase 群集的 DNS 名称。 例如：-s dsthbcluster、--src-cluster=dsthbcluster |\r |-sp、--src-ambari-password | 指定源 HBase 群集的 Ambari 管理员密码。 |\r |-dp、--dst-ambari-password | 指定目标 HBase 群集的 Ambari 管理员密码。|\r \r 可选参数：\r \r |名称|说明|\r |----|-----------|\r |-su、--src-ambari-user | 指定源 HBase 群集的 Ambari 管理员用户名。 默认值为 **admin**。 |\r |-du、--dst-ambari-user | 指定目标 HBase 群集的 Ambari 管理员用户名。 默认值为 **admin**。 |\r |-t、--table-list | 指定要复制的表。 例如：--table-list=\"table1;table2;table3\"。 如果不指定表，将复制所有现有的 HBase 表。|\r |-m、--machine | 指定要在其中运行脚本操作的头节点。 值为 **hn1** 或 **hn0**。 由于 **hn0** 头节点通常较为繁忙，因此我们建议使用 **hn1**。 在 HDInsight 门户或 Azure PowerShell 中以脚本操作的形式运行 $0 脚本时，可使用此选项。|\r |-ip | 在两个虚拟网络之间启用复制时，需使用此参数。 此参数充当一个开关，它使用副本群集中 ZooKeeper 节点的静态 IP 地址而不是 FQDN 名称。 在启用复制之前，需要预先配置静态 IP 地址。 |\r |-cp、-copydata | 在启用复制的情况下，允许迁移表中的现有数据。 |\r |-rpm、-replicate-phoenix-meta | 针对 Phoenix 系统表启用复制。 <br><br>*请慎用此选项。* 我们建议在使用此脚本之前，在副本群集上重新创建 Phoenix 表。 |\r |-h、--help | 显示用法信息。 |\r \r 该[脚本](https://github.com/Azure/hbase-utils/blob/master/replication/hdi_enable_replication.sh)的 `print_usage()` 节中提供了详细的参数说明。\r \r 成功部署脚本操作后，可以使用 SSH 连接到目标 HBase 群集，并验证是否已复制数据。\r \r ### <a name=\"replication-scenarios\"></a>复制方案\r \r 以下列表显示了一些普通用例及其参数设置：\r \r - **针对两个群集之间的所有表启用复制**。 此方案不需要复制或迁移表中的现有数据，也不使用 Phoenix 表。 使用以下参数：\r \r         -m hn1 -s <source cluster DNS name> -d <destination cluster DNS name> -sp <source cluster Ambari password> -dp <destination cluster Ambari password>  \r \r - **针对特定的表启用复制**。 若要针对 table1、table2 和 table3 启用复制，请使用以下参数：\r \r         -m hn1 -s <source cluster DNS name> -d <destination cluster DNS name> -sp <source cluster Ambari password> -dp <destination cluster Ambari password> -t \"table1;table2;table3\"\r \r - **针对特定的表启用复制并复制现有数据**。 若要针对 table1、table2 和 table3 启用复制，请使用以下参数：\r \r         -m hn1 -s <source cluster DNS name> -d <destination cluster DNS name> -sp <source cluster Ambari password> -dp <destination cluster Ambari password> -t \"table1;table2;table3\" -copydata\r \r - **针对所有表启用复制，并将 Phoenix 元数据从源复制到目标**。 Phoenix 元数据复制并不完善， 请谨慎使用。 使用以下参数：\r \r         -m hn1 -s <source cluster DNS name> -d <destination cluster DNS name> -sp <source cluster Ambari password> -dp <destination cluster Ambari password> -t \"table1;table2;table3\" -replicate-phoenix-meta\r \r ## <a name=\"copy-and-migrate-data\"></a>复制并迁移数据\r \r 启用复制后，可以使用两个单独的脚本操作脚本来复制或迁移数据：\r \r - [针对小型表的脚本](https://raw.githubusercontent.com/Azure/hbase-utils/master/replication/hdi_copy_table.sh)（大小只有几个 GB，有望在不到 1 小时内完成整个复制的表）\r \r - [针对大型表的脚本](https://raw.githubusercontent.com/Azure/hbase-utils/master/replication/nohup_hdi_copy_table.sh)（预计需要一小时以上才能完成复制的表）\r \r 可以遵循[启用复制](#enable-replication)中所述的相同过程来调用脚本操作。 使用以下参数：\r \r     -m hn1 -t <table1:start_timestamp:end_timestamp;table2:start_timestamp:end_timestamp;...> -p <replication_peer> [-everythingTillNow]\r \r 该[脚本](https://github.com/Azure/hbase-utils/blob/master/replication/hdi_copy_table.sh)的 `print_usage()` 节中提供了详细的参数说明。\r \r ### <a name=\"scenarios\"></a>方案\r \r - **复制特定表（test1、test2 和 test3）中到目前（当前时间戳）为止编辑的所有行**：\r \r         -m hn1 -t \"test1::;test2::;test3::\" -p \"zk5-hbrpl2;zk1-hbrpl2;zk5-hbrpl2:2181:/hbase-unsecure\" -everythingTillNow\r   或者：\r \r         -m hn1 -t \"test1::;test2::;test3::\" --replication-peer=\"zk5-hbrpl2;zk1-hbrpl2;zk5-hbrpl2:2181:/hbase-unsecure\" -everythingTillNow\r \r \r - **复制指定时间范围内的特定表**：\r \r         -m hn1 -t \"table1:0:452256397;table2:14141444:452256397\" -p \"zk5-hbrpl2;zk1-hbrpl2;zk5-hbrpl2:2181:/hbase-unsecure\"\r \r ## <a name=\"disable-replication\"></a>禁用复制\r \r 若要禁用复制，可以使用 [GitHub](https://raw.githubusercontent.com/Azure/hbase-utils/master/replication/hdi_disable_replication.sh) 中的另一个脚本操作脚本。 可以遵循[启用复制](#enable-replication)中所述的相同过程来调用脚本操作。 使用以下参数：\r \r     -m hn1 -s <source cluster DNS name> -sp <source cluster Ambari Password> <-all|-t \"table1;table2;...\">  \r \r 该[脚本](https://raw.githubusercontent.com/Azure/hbase-utils/master/replication/hdi_disable_replication.sh)的 `print_usage()` 节中提供了详细的参数说明。\r \r ### <a name=\"scenarios\"></a>方案\r \r - **对所有表禁用复制**：\r \r         -m hn1 -s <source cluster DNS name> -sp Mypassword\\!789 -all\r   或\r \r         --src-cluster=<source cluster DNS name> --dst-cluster=<destination cluster DNS name> --src-ambari-user=<source cluster Ambari username> --src-ambari-password=<source cluster Ambari password>\r \r - 对指定的表（table1、table2 和 table3）禁用复制：\r \r         -m hn1 -s <source cluster DNS name> -sp <source cluster Ambari password> -t \"table1;table2;table3\"\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 本教程已介绍如何在一个虚拟网络内部或者在两个虚拟网络之间设置 HBase 复制。 若要了解有关 HDInsight 和 HBase 的详细信息，请参阅以下文章：\r \r * [HDInsight 中的 Apache HBase 入门](./apache-hbase-tutorial-get-started-linux.md)\r * [HDInsight HBase 概述](./apache-hbase-overview.md)\r * [在 Azure 虚拟网络中创建 HBase 群集](./apache-hbase-provision-vnet.md)\r * [使用 HDInsight (Hadoop) 中的 Storm 和 HBase 分析传感器数据](../storm/apache-storm-sensor-data-analysis.md)\r \r \r <!--Update_Description: update wording and link references-->"}