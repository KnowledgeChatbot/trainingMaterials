{"Title":"使用 Intel NUC 将网关连接到 Azure IoT 套件","Description":"使用 Microsoft IoT 商业网关工具包和远程监控预配置解决方案。 使用 Azure IoT Edge 网关将 SensorTag 设备连接到远程监控解决方案，将遥测数据发送到云，并响应从解决方案仪表板调用的方法。","Content":"# <a name=\"connect-your-azure-iot-edge-gateway-to-the-remote-monitoring-preconfigured-solution-and-send-telemetry-from-a-sensortag\"></a>将 Azure IoT Edge 网关连接到远程监控预配置解决方案，并从 SensorTag 发送遥测数据\r \r [!INCLUDE [iot-suite-gateway-kit-selector](../../includes/iot-suite-gateway-kit-selector.md)]\r \r 本教程介绍如何使用 Azure IoT Edge 将 SensorTag 设备中的温度和湿度数据发送到远程监控预配置解决方案。 SensorTag 使用蓝牙连接到 Intel NUC 网关。 本教程使用：\r \r - Azure IoT Edge 实现示例网关。\r - IoT 套件远程监控预配置解决方案作为基于云的后端。\r \r ## <a name=\"overview\"></a>概述\r \r 本教程会完成以下步骤：\r \r - 将远程监控预配置解决方案的实例部署到 Azure 订阅。 此步骤会自动部署并配置多个 Azure 服务。\r - 将 Intel NUC 网关设备设置为与计算机和远程监控解决方案通信。\r - 将 Intel NUC 网关设置为从 SensorTag 设备接收遥测数据，并将其发送到远程监控仪表板。\r \r [!INCLUDE [iot-suite-gateway-kit-prerequisites](../../includes/iot-suite-gateway-kit-prerequisites.md)]\r \r [Texas Instruments BLE SensorTag][lnk-sensortag]. 本教程通过蓝牙从 SensorTag 设备检索遥测数据。\r \r [!INCLUDE [iot-suite-provision-remote-monitoring](../../includes/iot-suite-provision-remote-monitoring.md)]\r \r > [!WARNING]\r > 远程监控解决方案在 Azure 订阅中预配了一组 Azure 服务。 部署反映实际企业体系结构。 要避免产生不必要的 Azure 使用费用，请在使用完预配置解决方案的实例后，在 azureiotsuite.cn 上将其删除。 如果再次需要预配置解决方案，可以轻松地重新创建它。 若要详细了解如何在远程监控解决方案运行时减少消耗，请参阅[出于演示目的配置 Azure IoT 套件预配置解决方案][lnk-demo-config]。\r \r [!INCLUDE [iot-suite-gateway-kit-view-solution](../../includes/iot-suite-gateway-kit-view-solution.md)]\r \r [!INCLUDE [iot-suite-gateway-kit-prepare-nuc-connectivity](../../includes/iot-suite-gateway-kit-prepare-nuc-connectivity.md)]\r \r ## <a name=\"configure-bluetooth-connectivity\"></a>配置蓝牙连接\r \r 在 Intel NUC 上配置蓝牙，使 SensorTag 设备能够建立连接和发送遥测数据。\r \r ### <a name=\"find-the-mac-address-of-the-sensortag\"></a>查找 SensorTag 的 MAC 地址\r \r 1. 在 Intel NUC 上的 shell 中运行以下命令以取消阻止蓝牙服务：\r \r     ```bash\r     sudo rfkill unblock bluetooth\r     ```\r \r 1. 运行以下命令在 Intel NUC 上启动蓝牙服务，并进入蓝牙 shell：\r \r     ```bash\r     sudo systemctl start bluetooth\r     bluetoothctl\r     ```\r \r 1. 运行以下命令打开蓝牙控制器：\r \r     ```bash\r     power on\r     ```\r \r     打开控制器后，会看到一条消息“已成功更改电源设置”。\r \r 1. 运行以下命令扫描附近的蓝牙设备：\r \r     ```bash\r     scan on\r     ```\r \r 1. 按 SensorTag 上的电源按钮，以便能够发现它。 绿色 LED 会闪烁。\r \r 1. 在 shell 中看到一条指出控制器已发现 SensorTag 的消息时，请记下设备的 MAC 地址。 该 MAC 地址类似于 **A0:E6:F8:B5:F6:00**。 稍后在本教程中配置网关时需要用到该 MAC 地址。\r \r 1. 运行以下命令关闭蓝牙扫描：\r \r     ```bash\r     scan off\r     ```\r \r 1. 运行以下命令，验证是否可以连接到 SensorTag 设备：\r \r     ```bash\r     connect <SensorTag MAC address>\r     ```\r \r     如果连接成功，shell 会显示消息“连接成功”，并列显有关 SensorTag 设备的信息。 如果无法连接，请检查 SensorTag 的电源是否仍已打开。\r \r 1. 现在，可通过运行以下命令，从 SensorTag 断开连接并退出蓝牙 shell：\r \r     ```bash\r     disconnect\r     exit\r     ```\r \r [!INCLUDE [iot-suite-gateway-kit-prepare-nuc-software](../../includes/iot-suite-gateway-kit-prepare-nuc-software.md)]\r \r ## <a name=\"build-the-custom-iot-edge-module\"></a>生成自定义 IoT Edge 模块\r \r 现在可以生成自定义 IoT Edge 模块，以便网关将消息发送到远程监控解决方案。 若要详细了解如何配置网关和 IoT Edge 模块，请参阅 [Azure IoT Edge 概念][lnk-gateway-concepts]。\r \r 使用以下命令，从 GitHub 下载自定义 IoT Edge 模块的源代码：\r \r ```bash\r cd ~\r git clone https://github.com/Azure-Samples/iot-remote-monitoring-c-intel-nuc-gateway-getting-started.git\r ```\r \r 使用以下命令，生成自定义 IoT Edge 模块：\r \r ```bash\r cd ~/iot-remote-monitoring-c-intel-nuc-gateway-getting-started/basic\r chmod u+x build.sh\r sed -i -e 's/\\r$//' build.sh\r ./build.sh\r ```\r \r 生成脚本将 libsensor2remotemonitoring.so 自定义 IoT Edge 模块置于生成文件夹中。\r \r ## <a name=\"configure-and-run-the-iot-edge-gateway\"></a>配置和运行 IoT Edge 网关\r \r 现在可以配置 IoT Edge 网关，将遥测数据从 SensorTag 设备发送到远程监控仪表板。 若要详细了解如何配置网关和 IoT Edge 模块，请参阅 [Azure IoT Edge 概念][lnk-gateway-concepts]。\r \r > [!TIP]\r > 本教程使用 Intel NUC 上的标准 `vi` 文本编辑器。 如果以前未使用过 `vi`，应完成简介教程（例如 [Unix - vi 编辑器教程][lnk-vi-tutorial]）来熟悉此编辑器。 或者，可以使用命令 `smart install nano -y` 安装更友好的 [nano](https://www.nano-editor.org/) 编辑器。\r \r 使用以下命令在 **vi** 编辑器中打开示例配置文件：\r \r ```bash\r vi ~/iot-remote-monitoring-c-intel-nuc-gateway-getting-started/basic/remote_monitoring.json\r ```\r \r 在 IoTHub 模块的配置中找到以下行：\r \r ```json\r \"args\": {\r   \"IoTHubName\": \"<<Azure IoT Hub Name>>\",\r   \"IoTHubSuffix\": \"<<Azure IoT Hub Suffix>>\",\r   \"Transport\": \"http\"\r }\r ```\r \r 将占位符值替换为在本教程开始时创建并保存的 IoT 中心信息。 IoTHubName 的值类似于 **yourrmsolution37e08**，而 IoTSuffix 的值通常为 **azure-devices.cn**。\r \r 在映射模块的配置中找到以下行：\r \r ```json\r args\": [\r   {\r     \"macAddress\": \"<<AA:BB:CC:DD:EE:FF>>\",\r     \"deviceId\": \"<<Azure IoT Hub Device ID>>\",\r     \"deviceKey\": \"<<Azure IoT Hub Device Key>>>\"\r   }\r ]\r ```\r \r 将 **macAddress** 占位符替换为此前记下的 SensorTag 的 MAC 地址。 将 **deviceID** 和 **deviceKey** 占位符替换为此前在远程监控解决方案中创建的两个设备的 ID 和密钥。\r \r 在 SensorTag 模块的配置中找到以下行：\r \r ```json\r \"args\": {\r   \"controller_index\": 0,\r   \"device_mac_address\": \"<<AA:BB:CC:DD:EE:FF>>\",\r   ...\r }\r ```\r \r 将 **device\\_mac\\_address** 占位符替换为此前记下的 SensorTag 的 MAC 地址。\r \r 保存所做更改。\r \r 现在可以使用以下命令运行网关：\r \r ```bash\r cd ~/iot-remote-monitoring-c-intel-nuc-gateway-getting-started/basic\r /usr/share/azureiotgatewaysdk/samples/ble_gateway/ble_gateway remote_monitoring.json\r ```\r \r IoT Edge 网关在 Intel NUC 上启动，并将遥测数据从 SensorTag 发送到远程监控解决方案：\r \r ![IoT Edge 网关从 SensorTag 发送遥测数据][img-telemetry]\r \r 随时都可按 **Ctrl-C** 退出程序。\r \r ## <a name=\"view-the-telemetry\"></a>查看遥测数据\r \r 网关现在正将 SensorTag 设备中的遥测数据发送到远程监控解决方案。 可以在解决方案仪表板上查看遥测数据。 此外，可以在解决方案仪表板中通过通过网关向 SensorTag 设备发送命令。\r \r - 导航到解决方案仪表板。\r - 在“要查看的设备”下拉列表中，选择在网关中配置的、代表 SensorTag 的设备。\r - SensorTag 设备中的遥测数据会显示在仪表板上。\r \r ![显示 SensorTag 设备中的遥测数据][img-telemetry-display]\r \r > [!WARNING]\r > 如果让远程监控解决方案在 Azure 帐户中保持运行状态，系统会按其运行时间计费。 若要详细了解如何在远程监控解决方案运行时减少消耗，请参阅[出于演示目的配置 Azure IoT 套件预配置解决方案][lnk-demo-config]。 请在用完后从 Azure 帐户中删除预配置的解决方案。\r \r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 Azure IoT 的更多示例和文档，请访问 [Azure IoT 开发人员中心](https://www.azure.cn/develop/iot/)。\r \r [img-telemetry]: ./media/iot-suite-gateway-kit-get-started-sensortag/appoutput.png\r \r \r [img-telemetry-display]: ./media/iot-suite-gateway-kit-get-started-sensortag/telemetry.png\r \r [lnk-demo-config]: https://github.com/Azure/azure-iot-remote-monitoring/blob/master/Docs/configure-preconfigured-demo.md\r [lnk-vi-tutorial]: http://www.tutorialspoint.com/unix/unix-vi-editor.htm\r [lnk-sensortag]: http://www.ti.com/ww/en/wireless_connectivity/sensortag/\r [lnk-gateway-concepts]: ../iot-hub/iot-hub-linux-iot-edge-get-started.md\r <!--Update_Description: update wording-->"}