{"Title":"Azure 云服务的常见连接和网络问题解答","Description":"本文列出有关 Microsoft Azure 云服务的常见连接和网络问题。","Content":"# <a name=\"connectivity-and-networking-issues-for-azure-cloud-services-frequently-asked-questions-faqs\"></a>Azure 云服务的连接和网络问题：常见问题解答 (FAQ)\r \r 本文包含 [Azure 云服务](/cloud-services/)的常见连接和网络问题。 还可以参阅[云服务 VM 大小页面](./cloud-services-sizes-specs.md)，了解大小信息。\r \r [!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]\r \r ## <a name=\"i-cant-reserve-an-ip-in-a-multi-vip-cloud-service\"></a>无法在多 VIP 云服务中保留 IP\r 首先，请确保已打开想要为其保留 IP 的虚拟机实例。 其次，请确保为过渡和生产部署使用保留 IP。 **请勿**在部署升级过程中更改设置。\r \r ## <a name=\"how-do-i-remote-desktop-when-i-have-an-nsg\"></a>设置了 NSG 时，如何使用远程桌面？\r 将规则添加到 NSG，允许端口 **3389** 和 **20000** 上的流量。  远程桌面使用端口 **3389**。  云服务实例经过负载均衡，因此无法直接控制要连接到哪个实例。  RemoteForwarder 和 RemoteAccess 代理管理 RDP 流量，允许客户端发送 RDP cookie 和指定要连接到的单个实例。  *RemoteForwarder* 和 *RemoteAccess* 代理要求打开端口 **20000**（如果创建了 NSG，此端口可能已被阻止）。\r \r ## <a name=\"can-i-ping-a-cloud-service\"></a>是否可以 ping 云服务？\r \r 否，使用普通的 \"ping\"/ ICMP 协议是行不通的。 不允许通过 Azure 负载均衡器使用 ICMP 协议。\r \r 若要测试连接，我们建议执行端口 ping。 Ping.exe 使用 ICMP，而 PSPing、Nmap 和 telnet 等其他工具可以测试特定 TCP 端口的连接。\r \r 有关详细信息，请参阅[使用端口 ping 而不是 ICMP 来测试 Azure VM 连接](https://blogs.msdn.microsoft.com/mast/2014/06/22/use-port-pings-instead-of-icmp-to-test-azure-vm-connectivity/)。\r \r ## <a name=\"how-do-i-prevent-receiving-thousands-of-hits-from-unknown-ip-addresses-that-indicate-some-sort-of-malicious-attack-to-the-cloud-service\"></a>如何阻止未知 IP 地址向云服务发起的、可能表示某种恶意攻击的数千次访问？\r Azure 实施多层网络安全性来防范其平台服务遭到分布式拒绝服务 (DDoS) 攻击。 Azure DDoS 防御系统是 Azure 持续监视过程的一部分，已通过渗透测试持续得到改善。 此 DDoS 防御系统不仅能够承受外部的攻击，而且也能承受其他 Azure 租户的攻击。 有关更多详细信息，请参阅 [Microsoft Azure 网络安全](http://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf)。\r \r 还可以创建一个启动任务，以便有选择性地阻止某些特定的 IP 地址。 有关详细信息，请参阅[阻止特定 IP 地址](./cloud-services-startup-tasks-common.md#block-a-specific-ip-address)。\r \r ## <a name=\"when-i-try-to-rdp-to-my-cloud-service-instance-i-get-the-message-the-user-account-has-expired\"></a>尝试通过 RDP 连接到云服务实例时收到消息“用户帐户已过期”。\r 如果绕过 RDP 设置中配置的过期日期，则可能会收到错误消息“此用户帐户已过期”。 可以在门户中执行以下步骤来更改过期日期：\r 1. 登录到 Azure 管理控制台 (https://manage.windowsazure.cn)，导航到你的云服务，然后选择“配置”选项卡。\r 2. 选择“远程”。\r 3. 更改“过期”日期，然后保存配置。\r \r 现在，应该能够通过 RDP 连接到计算机。\r \r ## <a name=\"why-is-loadbalancer-not-balancing-traffic-equally\"></a>负载均衡器为何不能以均等的方式均衡流量？\r 有关内部负载均衡器工作原理的信息，请参阅 [Azure 负载均衡器的新分配模式](https://azure.microsoft.com/blog/azure-load-balancer-new-distribution-mode/)。\r \r 使用的分配算法是将流量映射到可用服务器的 5 元组（源 IP、源端口、目标 IP、目标端口和协议类型）哈希。 它仅在传输会话内部提供粘性。 同一 TCP 或 UDP 会话中的数据包会定向到负载均衡终结点后面的同一数据中心 IP (DIP) 实例。 客户端从同一源 IP 关闭再重新打开连接或启动新会话时，源端口会更改，并导致流量定向到其他 DIP 终结点。\r ## <a name=\"how-can-i-redirect-the-incoming-traffic-to-my-default-url-of-cloud-service-to-a-custom-url\"></a>如何将发往云服务的默认 URL 的传入流量重定向到自定义 URL？ \r \r 可以使用 IIS 的 URL 重写模块将传入到云服务的默认 URL（例如 \\*.chinacloudapp.cn）的流量重定向到某个自定义 DNS 名称/URL。 由于 URL 重写模块默认在 Web 角色上启用并且其规则是在应用程序的 web.config 中配置的，因此，无论是否重新启动/重置映像，它都始终可用。 有关详细信息，请参阅：\r \r - [为 URL 重写模块创建重写规则](https://docs.microsoft.com/iis/extensions/url-rewrite-module/creating-rewrite-rules-for-the-url-rewrite-module)\r - [如何删除默认链接](https://stackoverflow.com/questions/32286487/azure-website-how-to-remove-default-link?answertab=votes#tab-top)\r \r ## <a name=\"how-can-i-blockdisable-the-incoming-traffic-to-the-default-url-of-my-cloud-service\"></a>如何阻止/禁用发往云服务的默认 URL 的传入流量？ \r \r 可以通过在云服务定义 (*.csdef) 文件中的站点绑定配置下将主机标头设置为自定义 DNS 名称（例如 www.MyCloudService.com），阻止发往云服务的默认 URL/名称（例如 \\*.chinacloudapp.cn）的传入流量，如下所示： \r  \r \r     <?xml version=\"1.0\" encoding=\"utf-8\"?> \r     <ServiceDefinition name=\"AzureCloudServicesDemo\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition\" schemaVersion=\"2015-04.2.6\"> \r       <WebRole name=\"MyWebRole\" vmsize=\"Small\"> \r         <Sites> \r           <Site name=\"Web\"> \r             <Bindings> \r               <Binding name=\"Endpoint1\" endpointName=\"Endpoint1\" hostHeader=\"www.MyCloudService.com\" /> \r             </Bindings> \r           </Site> \r         </Sites> \r         <Endpoints> \r           <InputEndpoint name=\"Endpoint1\" protocol=\"http\" port=\"80\" /> \r         </Endpoints> \r         <ConfigurationSettings> \r           <Setting name=\"Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString\" /> \r         </ConfigurationSettings> \r       </WebRole> \r     </ServiceDefinition> \r  \r 因为通过 csdef 文件强制实施了此主机标头绑定，所以，只能通过自定义名称“www.MyCloudService.com”访问该服务，而发往“*.chinacloudapp.cn”域的所有传入请求都将失败。 话虽如此，但是，如果在服务中使用了自定义 SLB 探测或内部负载均衡器，则阻止服务的默认 URL/名称可能会干扰探测行为。 \r \r ## <a name=\"how-to-make-sure-the-public-facing-ip-address-of-a-cloud-service-aka-vip-never-changes-so-that-it-could-be-customarily-whitelisted-by-few-specific-clients\"></a>如何确保云服务面向公众的 IP 地址（aka、VIP）永不改变，以便少数特定的客户端通常可以将其列入白名单？\r \r 为了将云服务的 IP 地址列入白名单，建议将一个保留 IP 与服务进行关联，否则，如果删除了部署，则会从订阅解除分配由 Azure 提供的虚拟 IP。 请注意，为使 VIP 交换操作成功，需要为生产槽和暂存槽设置单独的保留 IP，如果缺少这些 IP，交换操作会失败。 请根据以下文章来保留 IP 地址并将其与云服务进行关联：  \r  \r - [保留现有云服务的 IP 地址](../virtual-network/virtual-networks-reserved-public-ip.md#reserve-the-ip-address-of-an-existing-cloud-service)\r - [使用服务配置文件将保留 IP 关联到云服务](../virtual-network/virtual-networks-reserved-public-ip.md#associate-a-reserved-ip-to-a-cloud-service-by-using-a-service-configuration-file) \r \r 只要有多个实例用于你的角色，将 RIP 与云服务进行关联就应该不会导致任何停机时间。 另外，还可以将你的 Azure 数据中心的 IP 范围列入白名单。 可以在[此处](https://www.microsoft.com/en-us/download/details.aspx?id=41653)找到所有 Azure IP 范围。 \r \r 此文件包含 Microsoft Azure 数据中心使用的 IP 地址范围（包括计算、SQL 和存储范围）。 每周都将发布更新的文件，反映当前已部署的范围和任何即将对 IP 范围进行的更改。 数据中心至少在一周后才会使用文件中显示的新范围。 请每周下载新的 xml 文件，并在网站上执行必要的更改以正确地标识 Azure 中运行的服务。 快速路由用户可能会注意到，此文件用于在每个月第一周更新 Azure 空间的 BGP 播发。 \r \r ## <a name=\"how-can-i-use-azure-resource-manager-vnets-with-cloud-services\"></a>如何将 Azure 资源管理器 VNet 与云服务一起使用？ \r \r 不能将云服务置于 Azure 资源管理器 VNet 中，但可以通过对等互连将 Azure 资源管理器 VNet 与经典 VNet 连接起来。 有关详细信息，请参阅[虚拟网络对等互连](../virtual-network/virtual-network-peering-overview.md)。\r \r <!--Update_Description:update wording-->"}