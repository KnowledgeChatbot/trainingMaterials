{"Title":"通过 PowerShell 统计存储服务每日文件新增数量","Description":"通过 PowerShell 统计存储服务每日文件新增数量","Content":"# 通过 PowerShell 统计存储服务每日文件新增数量\r \r ## 问题描述\r \r 如何查看 blob 服务中某个 container 每日的数据增加量。\r \r ## 实现思路\r \r 目前并没有直接的工具能完成此项业务需求。建议考虑程序代码或 PowerShell 脚本实现，实现逻辑为按照时间（当天）统计文件总数，即是当天的增长量，该值为运行脚本时刻的实时增加值。\r \r PowerShell 脚本：\r \r ```PowerShell\r # 登录账户\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r Set-AzureRmContext -SubscriptionId \"e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb\"\r \r $StorageName1=\"存储账户\"\r $StorageKey1=\"存储账户秘钥\"\r $ContainerName1=\"容器名称\" \r \r $StorageCtx1 = New-AzureStorageContext -StorageAccountName $StorageName1 -StorageAccountKey $StorageKey1 -Environment AzureChinaCloud \r $blobs = Get-AzureStorageBlob -Container $ContainerName1 -Context $StorageCtx1\r \r # 增长数\r $increCount = 0\r # 获取当前日期，PowerShell日期函数参考：http://www.oschina.net/code/snippet_222150_18220 \r $currentTime=Get-Date -Format 'yyyy-MM-dd'\r \r foreach ($blob in $blobs)\r {\r    # 计算时间差：将文件日期与当前时间做减法，从而判断是当天新增的文件\r    $blobTime = $blob.LastModified.LocalDateTime.ToString(\"yyyy-MM-dd\") \r    $ts = New-Timespan $blobTime $currentTime\r \r    # PowerShell 中的比较运算符\r    # -eq ：等于\r    # -ne ：不等于\r    # -gt ：大于\r    # -ge ：大于等于\r    # -lt ：小于\r    # -le ：小于等于\r    # -contains ：包含\r    # -notcontains :不包含 \r    if($ts.TotalMilliseconds -eq 0)\r    {\r         # 文件增加量累计计算\r         $increCount += 1\r    }\r } \r \r Write-Host $currentTime  '新增文件数：'  $increCount\r ```\r \r ## 使用测试\r \r 1. 将附件脚本，拷贝到 PowerShell 命令行或 ISE，先使用订阅账户登录订阅。\r \r 2. 修改存储账户、秘钥及容器名称。\r \r 3. 运行即可，当前脚本只用来统计今天新增文件数量，测试如下：\r \r     - 门户容器：\r     \r         ![portal](media/aog-storage-blob-howto-statistic-daily-files-via-powershell/portal.png)\r \r     - 运行测试：\r  \r         ![powershell](media/aog-storage-blob-howto-statistic-daily-files-via-powershell/powershell.png)\r "}