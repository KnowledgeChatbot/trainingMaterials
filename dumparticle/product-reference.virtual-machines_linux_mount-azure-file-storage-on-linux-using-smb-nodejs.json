{"Title":"通过 Azure CLI 1.0 使用 SMB 在 Linux VM 上装载 Azure 文件存储","Description":"如何使用 SMB 在 Linux VM 上装载 Azure 文件存储","Content":"# <a name=\"mount-azure-file-storage-on-linux-vms-by-using-smb-with-azure-cli-10\"></a>通过 Azure CLI 1.0 使用 SMB 在 Linux VM 上装载 Azure 文件存储\r \r 本文介绍如何使用服务器消息块 (SMB) 协议将 Azure 文件存储装载在 Linux VM 上。 文件存储通过标准 SMB 协议在云中提供文件共享。 要求如下：\r \r * 一个 [Azure 帐户](https://www.azure.cn/pricing/1rmb-trial/)\r * [安全外壳 (SSH) 公钥和私钥文件](mac-create-ssh-keys.md)\r \r ## <a name=\"cli-versions-to-use\"></a>要使用的 CLI 版本\r 可以使用以下命令行界面 (CLI) 版本之一来完成任务：\r \r - [Azure CLI 1.0](#quick-commands) - 适用于经典部署模型和资源管理部署模型（本文）的 CLI\r - [Azure CLI 2.0](mount-azure-file-storage-on-linux-using-smb-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) - 适用于资源管理部署模型的下一代 CLI\r \r ## <a name=\"quick-commands\"></a>快速命令\r 若要快速完成任务，请按照本部分的步骤执行操作。 如下更多详细信息和上下文，请从[“详细演练”](#detailed-walkthrough)部分开始。\r \r ### <a name=\"prerequisites\"></a>先决条件\r * 资源组\r * Azure 虚拟网络\r * 使用 SSH 入站类型的网络安全组\r * 一个子网\r * 一个 Azure 存储帐户\r * Azure 存储帐户密钥\r * 一个 Azure 文件存储共享\r * 一个 Linux VM\r \r 将任何示例替换为你自己的设置。\r \r ### <a name=\"create-a-directory-for-the-local-mount\"></a>为本地装载创建目录\r \r ```bash\r mkdir -p /mnt/mymountpoint\r ```\r \r ### <a name=\"mount-the-file-storage-smb-share-to-the-mount-point\"></a>将文件存储 SMB 共享装载到装入点\r \r ```bash\r sudo mount -t cifs //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint -o vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r ```\r \r ### <a name=\"persist-the-mount-after-a-reboot\"></a>在重新启动后保留装载\r 将以下行添加到 `/etc/fstab`：\r \r ```bash\r //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint cifs vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r ```\r \r ## <a name=\"detailed-walkthrough\"></a>详细演练\r \r 文件存储使用标准 SMB 协议在云中提供文件共享。 使用最新版本的文件存储，还可以从支持 SMB 3.0 的任何 OS 装载文件共享。 在 Linux 上使用 SMB 装载时，可轻松备份到 SLA 支持的可靠、永久的存档存储位置。\r \r 将文件从 VM 移至托管在文件存储上的 SMB 装载，可以很轻松地调试日志。 这是因为同一 SMB 共享可以通过本地方式装载到 Mac、Linux 或 Windows 工作站。 SMB 不会是实时流式处理 Linux 或应用程序日志的最佳解决方案，因为 SMB 协议并非为处理那样重的日志记录任务而构建。 专用统一的日志记录层工具（如 Fluentd）会是 SMB 之上的更好选择，可收集 Linux 和应用程序日志记录输出。\r \r 在此详细的演练中，我们创建所需的先决条件，即先创建文件存储共享，然后通过 SMB 将其装载到 Linux VM 上。\r \r 1. 使用以下代码创建 Azure 存储帐户：\r \r     ```azurecli\r     azure storage account create myStorageAccount \\\r     --sku-name lrs \\\r     --kind storage \\\r     -l chinanorth \\\r     -g myResourceGroup\r     ```\r \r 2. 显示存储帐户密钥。\r \r     创建存储帐户时，帐户密钥是成对创建的，这样是为了不中断任何服务就可轮换密钥。 轮换到密钥对中的第二个密钥后，将创建新的密钥对。 新的存储帐户密钥始终成对创建，可确保始终至少有一个未使用的存储密钥可以轮换到。 若要显示存储帐户密钥，请使用以下代码：\r \r     ```azurecli\r     azure storage account keys list myStorageAccount \\\r     --resource-group myResourceGroup\r     ```\r 3. 创建文件存储共享。\r \r     文件存储共享包含 SMB 共享。 配额始终以千兆字节 (GB) 表示。 若要创建文件存储共享，请使用以下代码：\r \r     ```azurecli\r     azure storage share create mystorageshare \\\r     --quota 10 \\\r     --account-name myStorageAccount \\\r     --account-key nPOgPR<--snip-->4Q==\r     ```\r \r 4. 创建装载点目录。\r \r     必须在 Linux 文件系统中创建将 SMB 共享装载到其中的本地目录。 写入到本地装载目录或从本地装载目录读取的任何内容都将转发到文件存储上托管的 SMB 共享。 若要创建该目录，请使用以下代码：\r \r     ```bash\r     sudo mkdir -p /mnt/mymountdirectory\r     ```\r \r 5. 使用以下代码装载 SMB 共享：\r \r     ```azurecli\r     sudo mount -t cifs //myStorageAccount.file.core.chinacloudapi.cn/mystorageshare /mnt/mymountdirectory -o vers=3.0,username=myStorageAccount,password=myStorageAccountkey,dir_mode=0777,file_mode=0777\r     ```\r \r 6. 重新启动后保留 SMB 装载。\r \r     重新启动 Linux VM 后，已装载的 SMB 共享会在关闭过程中卸载。 若要在启动时重新装载 SMB 共享，必须向 Linux /etc/fstab 添加一行。 Linux 使用 fstab 文件列出在启动过程中需要装载的文件系统。 添加 SMB 共享可确保文件存储共享是 Linux VM 的永久装载文件系统。 使用 cloud-init 可以将文件存储 SMB 共享添加到新的 VM。\r \r     ```bash\r     //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint cifs vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r     ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - [在创建期间使用 cloud-init 自定义 Linux VM](using-cloud-init.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r - [将磁盘添加到 Linux VM](add-disk.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r - [使用 Azure CLI 加密 Linux VM 上的磁盘](encrypt-disks.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r "}