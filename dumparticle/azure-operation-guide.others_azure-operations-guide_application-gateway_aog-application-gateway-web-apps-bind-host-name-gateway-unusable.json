{"Title":"如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题","Description":"如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题。","Content":"\r # 如何解决当 Web 应用绑定了主机名而无法使用应用程序网关的问题 #\r \r ### 问题描述 ###\r \r 当 Web 应用绑定了主机名并使用 Azure 应用程序网关作为负载均衡器的情形下，该网页可能无法正常访问。\r \r ### 问题分析 ###\r \r 访问网页时，浏览器会直接弹出下面的报错：\r \r ```\r 502 - Web server received an invalid response while acting as a gateway or proxy server.\r There is a problem with the page you are looking for, and it cannot be displayed. When the Web server (while acting as a gateway or proxy) contacted the upstream content server, it received an invalid response from the content server.\r ```\r \r ### 解决方法 ###\r \r Azure 应用程序网关会通过探测机制去了解后端服务器的健康状态，其默认会使用 HTTP 协议作为探测机制。如果我们没有配置自定义探针，应用程序网关会发送主机名为 127.0.0.1 路径为 “/ ” 的 HTTP GET 请求。当后端 Web 服务器绑定了主机名，这会导致 Web 服务器不会对应用程序网关的 HTTP 请求返回正确的 HTTP 响应，进而会导致应用程序网关向客户端抛出 502 的报错。\r \r 下面的网络数据报文显示了程序网关发送的默认探测包，可以看到请求路径为 “/ ”，请求主机名为 127.0.0.1。\r \r ```\r Frame: Number = 895, Captured Frame Length = 131, MediaType = ETHERNET\r + Ethernet: Etype = Internet IP (IPv4),DestinationAddress:[00-17-FA-00-64-54],SourceAddress:[F8-72-EA-E0-26-81]\r + Ipv4: Src = 10.30.0.56, Dest = 10.30.0.52, Next Protocol = TCP, Packet ID = 13920, Total IP Length = 117\r + Tcp: Flags=...AP..., SrcPort=64902, DstPort=HTTP(80), PayloadLen=77, Seq=2534951712 - 2534951789, Ack=3462157853, Win=4121 (scale factor 0x8) = 1054976\r - Http: Request, GET / \r   Command: GET\r - URI: /\r   Location: / \r   ProtocolVersion: HTTP/1.1\r   Connection:  Keep-Alive\r   Host:  127.0.0.1\r   Max-Forwards:  10\r   HeaderEnd: CRLF\r ```\r \r 要解决该问题，我们需要对应用程序网关配置自定义探针。应用程序网关可以配置的自定义探针配置如下：\r \r - Name - 自定义探测的引用名称。\r - Protocol - 使用的协议（可能的值为 HTTP 或 HTTPS）。\r - Host 和 Path - 应用程序网关为了确定实例运行状况而调用的完整 URL 路径。例如，如果网站为 [http://www.contoso.com/](http://www.contoso.com/)，则可以为 “[http://www.contoso.com/path/custompath.htm](http://www.contoso.com/path/custompath.htm)” 配置自定义探测，使探测检查能够获得成功的 HTTP 响应。\r - Interval - 配置探测检查间隔，以秒为单位。\r - Timeout - 定义 HTTP 响应检查的探测超时。\r - UnhealthyThreshold - 将后端实例标记为不正常所需的失败 HTTP 响应数目。\r \r 对于使用经典模式创建的应用程序网关只能使用 PowerShell 来进行操作。具体操作步骤如下：\r \r 1. 运行下面的 PowerShell 命令导出应用程序网关的配置信息。\r \r     ```\r     Get-AzureApplicationGatewayConfig -Name <application gateway name> -Exporttofile \"<path to file>\"\r     ```\r \r 2. 打开导出的文件并找到 FrontendPorts 部分，并在其之后添加 Probes 字段。Host 部分就填写 Web 服务器中所绑定的主机名，其他部分可以根据实际需求进行配置。\r \r     ```\r     <FrontendPorts>\r        <FrontendPort>\r            <Name>FrontendPort1</Name>\r            <Port>80</Port>\r        </FrontendPort>\r     </FrontendPorts>\r        <Probes>\r            <Probe>\r            <Name>Probe01</Name>\r            <Protocol>Http</Protocol>\r            <Host>www.contoso.com</Host>\r            <Path>/</Path>\r            <Interval>15</Interval>\r            <Timeout>15</Timeout>\r            <UnhealthyThreshold>5</UnhealthyThreshold>\r        </Probe>\r     </Probes>\r     ```\r \r 3. 在 XML 的 backendHttpSettings 节中，添加字段 “<Probe>Probe01</Probe>” 启用在步骤 2 中创建的探针，示例如下：\r \r     ```\r     <BackendHttpSettings>\r        <Name>setting1</Name>\r        <Port>80</Port>\r        <Protocol>Http</Protocol>\r        <CookieBasedAffinity>Enabled</CookieBasedAffinity>\r        <RequestTimeout>30</RequestTimeout>\r        <Probe>Probe01</Probe>\r     </BackendHttpSettings>\r     ```\r \r 4. 运行下面的命令对应用程序网关进行配置。\r \r     ```\r     Set-AzureApplicationGatewayConfig -Name <application gateway name> -Configfile \"<path to file>\"\r     ```\r \r >注意：请使用最新版本的 Azure PowerShell 来进行配置，如果使用的 PowerShell 版本较老可能会导致该操作不成功。\r \r 对于使用 ARM 模式创建的应用程序网关，我们可以直接在 Portal 直接进行配置。\r \r 1. 如下图所示，点击“运行状况探测”，添加自定义探测并指定自定义探测的名称和主机名。\r \r     ![Portal-ARMAppGw](./media/aog-application-gateway-web-apps-bind-host-name-gateway-unusable/status-detection.png)\r \r 2. 点击 “HTTP 设置”，找到对应的 HTTP 设置然后勾选 “使用自定义探测” 并选择刚才定义的探测规则，保存设置即可。\r \r     ![Portal-ARMAppGw](./media/aog-application-gateway-web-apps-bind-host-name-gateway-unusable/HTTP-setting.png)"}