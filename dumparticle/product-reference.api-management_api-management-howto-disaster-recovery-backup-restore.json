{"Title":"使用 Azure API 管理中的备份和还原实现灾难恢复","Description":"了解如何在 Azure API 管理中使用备份和还原执行灾难恢复。","Content":"# <a name=\"how-to-implement-disaster-recovery-using-service-backup-and-restore-in-azure-api-management\"></a>如何使用 Azure API 管理中的服务备份和还原实现灾难恢复\r 通过 Azure API 管理选择发布和管理 API，即可充分利用了许多容错和基础结构功能，否则必须设计、实现和管理这些功能。 Azure 平台通过花费少量成本消除大量潜在故障。\r \r 若要从影响托管 API 管理服务的区域的可用性问题中恢复，应随时准备好在不同的区域中重建服务。 根据可用性目标和恢复时间目标，可能要在一个或多个区域中保留备份服务，并尝试使其配置和内容与活动服务保持同步。 服务备份和还原功能为实现灾难恢复策略提供必要的构建基块。\r \r 本指南介绍了如何对 Azure Resource Manager 请求进行身份验证以及如何备份和还原 API 管理服务实例。\r \r > [!NOTE]\r > 为灾难恢复备份和还原 API 管理服务实例的过程还可用于为暂存之类的方案复制 API 管理服务实例。\r >\r > 请注意，每个备份都会在 30 天后过期。 如果在 30 天有效期到期后尝试还原备份，还原会失败并显示 `Cannot restore: backup expired` 消息。\r >\r >\r \r ## <a name=\"authenticating-azure-resource-manager-requests\"></a>对 Azure 资源管理器请求进行身份验证\r > [!IMPORTANT]\r > 用于还原和备份的 REST API 使用 Azure 资源管理器，并且具有与用于管理 API 管理实体的 REST API 不同的身份验证机制。 本部分中的步骤介绍如何对 Azure 资源管理器请求进行身份验证。 有关详细信息，请参阅[对 Azure 资源管理器请求进行身份验证](http://msdn.microsoft.com/library/azure/dn790557.aspx)。\r >\r >\r \r 使用 Azure 资源管理器对资源所进行的所有任务都必须使用以下步骤通过 Azure Active Directory 进行身份验证。\r \r * 向 Azure Active Directory 租户添加应用程序。\r * 为添加的应用程序设置权限。\r * 获取用于对 Azure 资源管理器的请求进行身份验证的令牌。\r \r 第一步是创建 Azure Active Directory 应用程序。 使用包含 API 管理服务实例的订阅登录 [Azure 经典管理门户](http://manage.windowsazure.cn/)并导航到默认 Azure Active Directory 的“应用程序”选项卡。\r \r > [!NOTE]\r > 如果 Azure Active Directory 默认目录对帐户不可见，请联系 Azure 订阅的管理员以向帐户授予所需权限。 若要了解如何查找默认目录，请参阅[在 Azure Active Directory 中创建用于 Windows VM 的工作或学校标识](../virtual-machines/windows/create-aad-work-id.md)中的“在 Azure 经典门户中查找默认目录”。\r >\r >\r \r ![创建 Azure Active Directory 应用程序][api-management-add-aad-application]\r \r 依次单击“添加”、“添加我的组织正在开发的应用程序”，并选择“本机客户端应用程序”。 输入描述性名称，并单击“下一步”箭头。 输入占位符 URL，例如，为“重定向 URI”输入 `http://resources`，因为它是必填字段，但以后不使用该值。 单击此复选框以保存应用程序。\r \r 保存应用程序后，单击“配置”、向下滚动到“针对其他应用程序层VDE权限”部分，并单击“添加应用程序”。\r \r ![添加权限][api-management-aad-permissions-add]\r \r 依次选择“Windows”、“Azure Service Management API”，并单击该复选框添加应用程序。\r \r ![添加权限][api-management-aad-permissions]\r \r 单击新添加的“Windows”“Azure Service Management API”应用程序旁边的“委派的权限”、选中“访问 Azure 服务管理(预览版)”的复选框，并单击“保存”。\r \r ![添加权限][api-management-aad-delegated-permissions]\r \r 在调用生成备份并还原它的 API 之前，必须获取令牌。 以下示例使用 [Microsoft.IdentityModel.Clients.ActiveDirectory](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory) NuGet 包来检索令牌。\r \r ```c#\r using Microsoft.IdentityModel.Clients.ActiveDirectory;\r using System;\r \r namespace GetTokenResourceManagerRequests\r {\r     class Program\r     {\r         static void Main(string[] args)\r         {\r             var authenticationContext = new AuthenticationContext(\"https://login.chinacloudapi.cn/{tenant id}\");\r             var result = authenticationContext.AcquireToken(\"https://management.azure.cn/\", {application id}, new Uri({redirect uri});\r \r             if (result == null) {\r                 throw new InvalidOperationException(\"Failed to obtain the JWT token\");\r             }\r \r             Console.WriteLine(result.AccessToken);\r \r             Console.ReadLine();\r         }\r     }\r }\r ```\r \r 使用以下说明替换 `{tentand id}`、`{application id}` 和 `{redirect uri}`。\r \r 将 `{tenant id}` 替换为刚刚创建的 Azure Active Directory 应用程序的租户 ID。 可通过单击“查看终结点”访问此 ID。\r \r ![终结点][api-management-aad-default-directory]\r \r ![终结点][api-management-endpoint]\r \r 从 Azure Active Directory 应用程序的“配置”选项卡中，使用“客户端 ID”和“重定向 URI”中的 URL 替换 `{application id}` 和 `{redirect uri}`。\r \r ![资源][api-management-aad-resources]\r \r 指定这些值后，代码示例应返回类似于以下示例的令牌。\r \r ![令牌][api-management-arm-token]\r \r 调用以下部分中所述的备份和还原操作之前，为 REST 调用设置授权请求标头。\r \r ```c#\r request.Headers.Add(HttpRequestHeader.Authorization, \"Bearer \" + token);\r ```\r \r ## <a name=\"step1\"> </a>备份 API 管理服务\r 若要备份 API 管理服务问题，请发送以下 HTTP 请求：\r \r `POST https://management.azure.cn/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/backup?api-version={api-version}`\r \r 其中：\r \r * `subscriptionId` - 包含正在尝试备份的 API 管理服务的订阅 ID\r * `resourceGroupName` - 采用“Api-Default-{service-region}”形式的字符串，其中 `service-region` 标识托管正在尝试备份的 API 管理服务的 Azure 区域，例如 `North-Central-US`\r * `serviceName` - 正在创建其备份的 API 管理服务的名称，在创建时指定\r * `api-version` - 替换为 `2014-02-14`\r \r 在请求正文中，指定目标 Azure 存储帐户名称、访问密钥、blob 容器名称和备份名称：\r \r ```\r '{  \r     storageAccount : {storage account name for the backup},  \r     accessKey : {access key for the account},  \r     containerName : {backup container name},  \r     backupName : {backup blob name}  \r }'\r ```\r \r 将 `Content-Type` 请求标头的值设置为 `application/json`。\r \r 备份是长时间运行的操作，可能需要数分钟才能完成。  如果请求已成功并且已启动备份过程，将收到带有 `Location` 标头的 `202 Accepted` 响应状态代码。  向 `Location` 标头中的 URL 发出“GET”请求以查明操作状态。 当备份正在进行时，将继续收到“202 已接受”状态代码。 `200 OK` 的响应代码将指示备份操作成功完成。\r \r 发送备份请求时请注意以下限制。\r \r * 请求正文中指定的**容器****必须存在**。\r * 当备份正在进行时，**不应尝试任何服务管理操作**，如 SKU 升级或降级、域名更改等。\r * 从创建时开始，**备份还原仅保证 30 天**。\r * 用于创建分析报表的**用法数据****不包括**在备份中。 使用 [Azure API 管理 REST API][Azure API Management REST API] 定期检索分析报表以保证安全。\r * 执行服务备份的频率将影响恢复点目标。 为了最大程度减少它，建议实现定期备份，以及在对 API 管理服务进行重大更改后执行按需备份。\r * 备份操作正在进行时对服务配置（例如 API、策略、开发人员门户外观）所作的**更改****可能不包含在备份中，因此将丢失**。\r \r ## <a name=\"step2\"> </a>还原 API 管理服务\r 若要从之前创建的备份还原 API 管理服务，请发出以下 HTTP 请求：\r \r `POST https://management.azure.cn/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.ApiManagement/service/{serviceName}/restore?api-version={api-version}`\r \r 其中：\r \r * `subscriptionId` - 包含正在将备份还原到的 API 管理服务的订阅 ID\r * `resourceGroupName` - 采用“Api-Default-{service-region}”形式的字符串，其中 `service-region` 标识托管正在将备份还原到的 API 管理服务的 Azure 区域，例如 `North-Central-US`\r * `serviceName` - 正在还原到的 API 管理服务的名称，在创建时指定\r * `api-version` - 替换为 `2014-02-14`\r \r 在请求正文中，指定备份文件位置，即 Azure 存储帐户名称、访问密钥、blob 容器名称和备份名称：\r \r ```\r '{  \r     storageAccount : {storage account name for the backup},  \r     accessKey : {access key for the account},  \r     containerName : {backup container name},  \r     backupName : {backup blob name}  \r }'\r ```\r \r 将 `Content-Type` 请求标头的值设置为 `application/json`。\r \r 还原是长时间运行的操作，可能需要长达 30 分钟或更长时间才能完成。  如果请求已成功并且已启动还原过程，将收到带有 `Location` 标头的 `202 Accepted` 响应状态代码。  向 `Location` 标头中的 URL 发出“GET”请求以查明操作状态。 当还原正在进行时，将继续收到“202 已接受”状态代码。 `200 OK` 的响应代码将指示还原操作成功完成。\r \r > [!IMPORTANT]\r > 要还原到的服务的 **SKU** 必须与正在还原的已备份服务的 SKU **匹配**。\r >\r > 还原操作正在进行时对服务配置（例如 API、策略、开发人员门户外观）所作的**更改****可以被覆盖**。\r >\r >\r \r ## <a name=\"next-steps\"></a>后续步骤\r 查看以下 Microsoft 博客了解备份/还原过程的两种不同的演练。\r \r * [复制 Azure API 管理帐户](https://www.returngis.net/en/2015/06/replicate-azure-api-management-accounts/)\r   * 感谢 Gisela 对本文的贡献。\r * [Azure API 管理：备份和还原配置](http://blogs.msdn.com/b/stuartleeks/archive/2015/04/29/azure-api-management-backing-up-and-restoring-configuration.aspx)\r   * Stuart 详述的方法与官方指南不匹配，但非常有趣。\r \r [Backup an API Management service]: #step1\r [Restore an API Management service]: #step2\r \r \r [Azure API Management REST API]: http://msdn.microsoft.com/library/azure/dn781421.aspx\r \r [api-management-add-aad-application]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-add-aad-application.png\r \r [api-management-aad-permissions]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-aad-permissions.png\r [api-management-aad-permissions-add]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-aad-permissions-add.png\r [api-management-aad-delegated-permissions]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-aad-delegated-permissions.png\r [api-management-aad-default-directory]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-aad-default-directory.png\r [api-management-aad-resources]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-aad-resources.png\r [api-management-arm-token]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-arm-token.png\r [api-management-endpoint]: ./media/api-management-howto-disaster-recovery-backup-restore/api-management-endpoint.png\r "}