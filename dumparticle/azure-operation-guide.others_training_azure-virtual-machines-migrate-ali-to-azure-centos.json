{"Title":"'CentOS","Description":"本文以阿里云为例，阐述的是如何将 CentOS 6.8 的虚拟机迁移到 Azure 环境，同时能保存虚拟机内的数据，不需重新部署应用的方法。","Content":"\r # CentOS: 将虚拟机迁移到 Azure (以阿里云为例)\r \r Azure 虚拟机能很容易地导出 vhd 并迁移到各种环境中，包含本地及云端环境，或者迁移至其他区域。这为开发、测试、扩展带来了极大的便利。因此本文以阿里云为例，阐述的是如何将 CentOS 6.8 的虚拟机迁移到 Azure 环境，同时能保存虚拟机内的数据，不需重新部署应用的方法。\r \r ## 主要步骤\r \r 迁移的主要步骤分为：**准备环境**，**调整服务器配置**，**导出磁盘**，**上传磁盘**，**建立新的虚拟机**。\r \r 在这几个步骤中，**调整服务器配置**将对阿里云中的配置进行调整以符合 Azure 的需求，因此将会涉及一些影响在阿里云运行的调整。有几个推荐的做法：\r \r - 在调整前进行[快照](https://help.aliyun.com/document_detail/25455.html?spm=5176.doc25429.6.644.VHJtFD)，操作错误时可进行[回滚](https://help.aliyun.com/document_detail/25450.html?spm=5176.doc25455.6.641.S3Z8he)。\r - 如本地有 Hyper-V 机器，可先进行**导出磁盘**再进行**调整服务器配置**。\r \r 因此，根据你的策略，流程可分为\r \r 1. **准备环境**=>**调整服务器配置**=>**导出磁盘**=>**上传磁盘**=>**建立新的虚拟机**\r 2. **准备环境**=>**导出磁盘**=>**调整服务器配置**=>**上传磁盘**=>**建立新的虚拟机**\r \r 由于修改服务配置可能造成云端服务中断，而在本地则需要额外的资源及较长的操作时间，你可根据需要决定选择何种流程，以下我们将针对各步骤进行详细说明。\r \r ## 准备环境\r \r 首先，推荐先对现有磁盘进行[快照](https://help.aliyun.com/document_detail/25455.html?spm=5176.doc25429.6.644.VHJtFD)。\r \r 接着，为了导出虚拟机的磁盘，我们需要挂载数据盘以存放导出的虚拟磁盘文件(.vhd)，大小建议为需要备份的磁盘大小的两倍，详细方法请参考[挂载数据盘](https://help.aliyun.com/document_detail/25446.html?spm=5176.doc25450.6.624.AYaS4Z)，值得提醒的是，除了在阿里云控制台进行挂载，也需要在操作系统内[进行配置](https://help.aliyun.com/document_detail/25426.html?spm=5176.doc25446.2.3.pia69h)。\r \r 最后，为了准备上传磁盘的空间，需要在 Azure 上创建一个存储账户，值得注意的是这个存储账户必须与虚拟机是同一种类型，这边采用的是资源管理模式(Azure Resource Manager)，进行[存储账户创建](/storage/storage-create-storage-account/)，同时请创建一个容器(container)，名为vhds。\r     \r ## 调整服务器配置\r \r 在此步骤中，我们将进行服务器的调整以兼容于 Azure 的环境。\r \r 1. 用具有管理员权限的账户登入阿里云的 Linux 虚拟机。\r 2. 修改 `/etc/sysconfig/network`：\r \r     ```\r     vi /etc/sysconfig/network\r     ```\r \r     修改为\r \r     ```\r     NETWORKING=yes\r     HOSTNAME=localhost.localdomain\r     ```\r 3. 修改 `/etc/sysconfig/network-scripts/ifcfg-eth0`：\r \r     ```\r     vi /etc/sysconfig/network-scripts/ifcfg-eth0\r     ```\r \r     修改为\r \r     ```\r     DEVICE=eth0\r     ONBOOT=yes\r     BOOTPROTO=dhcp\r     TYPE=Ethernet\r     USERCTL=no\r     PEERDNS=yes\r     IPV6INIT=no\r     ```\r \r 4. 修改 `/etc/sysconfig/network-scripts/ifcfg-eth1`，将其禁用：\r \r     ```\r     vi /etc/sysconfig/network-scripts/ifcfg-eth0\r     ```\r \r     修改为\r \r     ```\r     DEVICE=eth1\r     #ONBOOT=yes\r     #BOOTPROTO=static\r     #IPADDR=1.1.1.1\r     #NETMASK=255.255.255.0\r     ```\r 5. 修改 udev 规则，以避免产生以太网接口的静态规则。在 Azure 或 Hyper-V 中克隆虚拟机时，这些规则会引发问题。\r \r     ```\r     sudo ln -s /dev/null /etc/udev/rules.d/75-persistent-net-generator.rules\r     sudo rm -f /etc/udev/rules.d/70-persistent-net.rules\r     ```\r 6. 修改服务启动的配置，禁用阿里云的服务。\r \r     ```\r     sudo chkconfig network on\r     sudo chkconfig aegis off\r     sudo chkconfig aliyun-util off\r     ```\r 7. 更新镜像库\r \r     ```\r     wget -q https://aliyunmigration.blob.core.chinacloudapi.cn/packages/CentOS-Base.repo -O /etc/yum.repos.d/CentOS-Base.repo\r     ```\r 8. 修改 `/etc/yum.conf`：\r \r     ```\r     vi /etc/yum.conf\r     ```\r \r     添加一行\r \r     ```\r     http_caching=packages\r     ```\r 9. 清除 yum 元数据并进行更新：\r \r     ```\r     yum clean all\r     sudo yum -y update\r     ```\r 10. 安装 Azure Linux 代理和依赖项：\r \r     ```\r     sudo yum install python-pyasn1 WALinuxAgent\r     ```\r 11. 在 grub 配置中修改内核引导行，以使其包含 Azure 的其他内核参数。 为此，请在文本编辑器 (vi) 中打开 `/boot/grub/menu.lst`，并确保默认内核包含以下参数。\r \r     ```\r     console=ttyS0 earlyprintk=ttyS0 rootdelay=300\r     ```\r \r 12. 编辑磁盘文件，将不需用到的磁盘禁用：\r \r     ```\r     vi /etc/fstab\r     ```\r \r     在本例中，将数据盘标注掉：\r \r     ```\r     #/dev/vdb1 /mnt ext3 defaults 0 0\r     ```\r     \r 至此，你已完成 CentOS 6.8 上传至 Azure 磁盘前的准备。\r \r ## 导出磁盘\r \r 在 Linux 中，我们所使用的工具是 [dd](https://www.linux.com/learn/full-metal-backup-using-dd-command)，进行整个磁盘的备份，再备份完成后再用 [qemu](http://wiki.qemu-project.org/Main_Page) 工具，转成 vhd 的文件格式。\r \r 首先，执行 dd 指令，这里我导出的磁盘为 /dev/vda，额外挂载作为备份的磁盘为 /mnt，导出的文件为 aliyuncentos68.raw。\r \r ```\r dd if=/dev/vda of=/mnt/aliyuncentos68.raw bs=100M\r ```\r \r 等待 dd 完成后，安装 qemu 工具。\r \r ```\r sudo yum install qemu-kvm\r ```\r \r 安装完成后，进行格式转换，其中 /mnt 为刚才的备份目录，aliyuncentos68.raw 为刚才的备份文件，aliyuncentos68.vhd 则为转换后的文件。\r \r ```\r cd /mnt\r qemu-img convert -f raw -o subformat=fixed -O vpc aliyuncentos68.raw aliyuncentos68.vhd\r ```\r \r 等待直至转换磁盘完成。\r \r ## 上传磁盘\r \r 在此我们将运用 Azure CLI 将刚才导出的磁盘上传至先前创建的存储账户中。\r \r 首先需要安装 NodeJS：\r \r ```\r curl --silent --location https://rpm.nodesource.com/setup_6.x | bash -\r sudo yum -y install nodejs\r ```\r \r 接着安装 Azure CLI：\r \r ```\r npm install -g azure-cli\r ```\r \r 然后需要刚才在 Azure 创建的存储账户信息及密钥组成连结字符串，如：\r \r ```\r DefaultEndpointsProtocol=https;BlobEndpoint=storagename.blob.core.chinacloudapi.cn;AccountName=storagename;AccountKey=storagekey\r ```\r \r 接着执行指令进行上传：\r \r ```\r cd /mnt\r azure storage blob upload -c 'DefaultEndpointsProtocol=https;BlobEndpoint=storagename.blob.core.chinacloudapi.cn;AccountName=storagename;AccountKey=storagekey' -t page --container vhds -f aliyuncentos68.vhd\r ```\r \r ##建立新的虚拟机\r \r 当上述步骤都已经完成，可以点选下面图标根据你上传的磁盘url创建机器。\r \r [![deploy](media/azure-virtual-machines-migrate-ali-to-azure-centos/deploy.png)](https://portal.azure.cn/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAliyunMigration%2Fmaster%2FARMTemplateRepos%2FcreateVmFromCustomVhd.json)\r  \r 在栏位中依序填入 VM 创建的地点，刚才上传的系统磁盘 url，OS 类型(这边应该选 Linux)，VM 的大小及 VM 的名称。\r \r 接着点选创建，虚拟机将开始进行部署。过一段时间之后，便可以连结上你所迁移的机器了。\r \r \r \r "}