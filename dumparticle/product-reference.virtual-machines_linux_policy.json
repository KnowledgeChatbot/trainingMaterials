{"Title":"使用 Azure 资源管理器向 Linux VM 应用策略","Description":"如何向 Azure Resource Manager Linux 虚拟机应用策略","Content":"# <a name=\"apply-policies-to-linux-vms-with-azure-resource-manager\"></a>使用 Azure 资源管理器向 Linux VM 应用策略\r 通过使用策略，组织可以在整个企业中强制实施各种约定和规则。 强制实施所需行为有助于消除风险，同时为组织的成功做出贡献。 本文介绍如何使用 Azure 资源管理器策略，为组织中的虚拟机定义所需的行为。\r \r ## <a name=\"permitted-virtual-machines\"></a>允许的虚拟机\r 若要确保组织的虚拟机与应用程序兼容，可以限制获准操作系统。 在以下策略示例中，只允许创建 Ubuntu 14.04.2-LTS 虚拟机。\r \r ```json\r {\r   \"if\": {\r     \"allOf\": [\r       {\r         \"field\": \"type\",\r         \"in\": [\r           \"Microsoft.Compute/disks\",\r           \"Microsoft.Compute/virtualMachines\",\r           \"Microsoft.Compute/VirtualMachineScaleSets\"\r         ]\r       },\r       {\r         \"not\": {\r           \"allOf\": [\r             {\r               \"field\": \"Microsoft.Compute/imagePublisher\",\r               \"in\": [\r                 \"Canonical\"\r               ]\r             },\r             {\r               \"field\": \"Microsoft.Compute/imageOffer\",\r               \"in\": [\r                 \"UbuntuServer\"\r               ]\r             },\r             {\r               \"field\": \"Microsoft.Compute/imageSku\",\r               \"in\": [\r                 \"14.04.2-LTS\"\r               ]\r             },\r             {\r               \"field\": \"Microsoft.Compute/imageVersion\",\r               \"in\": [\r                 \"latest\"\r               ]\r             }\r           ]\r         }\r       }\r     ]\r   },\r   \"then\": {\r     \"effect\": \"deny\"\r   }\r }\r ```\r \r 使用通配符将上述策略修改为允许任何 Ubuntu LTS 映像： \r \r ```json\r {\r   \"field\": \"Microsoft.Compute/virtualMachines/imageSku\",\r   \"like\": \"*LTS\"\r }\r ```\r \r ## <a name=\"managed-disks\"></a>托管磁盘\r \r 如果需要使用托管磁盘，请使用以下策略：\r \r ```json\r {\r   \"if\": {\r     \"anyOf\": [\r       {\r         \"allOf\": [\r           {\r             \"field\": \"type\",\r             \"equals\": \"Microsoft.Compute/virtualMachines\"\r           },\r           {\r             \"field\": \"Microsoft.Compute/virtualMachines/osDisk.uri\",\r             \"exists\": true\r           }\r         ]\r       },\r       {\r         \"allOf\": [\r           {\r             \"field\": \"type\",\r             \"equals\": \"Microsoft.Compute/VirtualMachineScaleSets\"\r           },\r           {\r             \"anyOf\": [\r               {\r                 \"field\": \"Microsoft.Compute/VirtualMachineScaleSets/osDisk.vhdContainers\",\r                 \"exists\": true\r               },\r               {\r                 \"field\": \"Microsoft.Compute/VirtualMachineScaleSets/osdisk.imageUrl\",\r                 \"exists\": true\r               }\r             ]\r           }\r         ]\r       }\r     ]\r   },\r   \"then\": {\r     \"effect\": \"deny\"\r   }\r }\r ```\r \r ## <a name=\"images-for-virtual-machines\"></a>虚拟机映像\r \r 出于安全考虑，可要求仅在环境中部署已批准的自定义映像。 可以指定包含已批准映像的资源组，或特定已批准映像。\r \r 下例需要来自已批准资源组的映像：\r \r ```json\r {\r     \"if\": {\r         \"allOf\": [\r             {\r                 \"field\": \"type\",\r                 \"in\": [\r                     \"Microsoft.Compute/virtualMachines\",\r                     \"Microsoft.Compute/VirtualMachineScaleSets\"\r                 ]\r             },\r             {\r                 \"not\": {\r                     \"field\": \"Microsoft.Compute/imageId\",\r                     \"contains\": \"resourceGroups/CustomImage\"\r                 }\r             }\r         ]\r     },\r     \"then\": {\r         \"effect\": \"deny\"\r     }\r } \r ```\r \r 下例指定已批准的映像 ID：\r \r ```json\r {\r     \"field\": \"Microsoft.Compute/imageId\",\r     \"in\": [\"{imageId1}\",\"{imageId2}\"]\r }\r ```\r \r ## <a name=\"virtual-machine-extensions\"></a>虚拟机扩展\r \r 可能想要禁止使用某些类型的扩展。 例如，扩展名可能与某些自定义虚拟机映像不兼容。 下例演示如何阻止特定扩展。 该示例使用发布者和类型来确定要阻止的扩展。\r \r ```json\r {\r     \"if\": {\r         \"allOf\": [\r             {\r                 \"field\": \"type\",\r                 \"equals\": \"Microsoft.Compute/virtualMachines/extensions\"\r             },\r             {\r                 \"field\": \"Microsoft.Compute/virtualMachines/extensions/publisher\",\r                 \"equals\": \"Microsoft.Compute\"\r             },\r             {\r                 \"field\": \"Microsoft.Compute/virtualMachines/extensions/type\",\r                 \"equals\": \"{extension-type}\"\r \r       }\r         ]\r     },\r     \"then\": {\r         \"effect\": \"deny\"\r     }\r }\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r * 定义策略规则后（如上述示例所示），需要创建策略定义并将其分配给作用域。 作用域可以是订阅、资源组或资源。\r * 有关企业可如何使用 Resource Manager 有效管理订阅的指南，请参阅 [Azure 企业基架 - 出于合规目的监管订阅](../../azure-resource-manager/resource-manager-subscription-governance.md)。\r \r <!--Update_Description: wording update -->"}