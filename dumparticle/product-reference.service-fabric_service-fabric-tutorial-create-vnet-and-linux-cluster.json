{"Title":"在 Azure 中创建 Linux Service Fabric 群集","Description":"了解如何使用 Azure CLI 将 Linux Service Fabric 群集部署到现有 Azure 虚拟网络。","Content":"# <a name=\"deploy-a-service-fabric-linux-cluster-into-an-azure-virtual-network\"></a>将 Service Fabric Linux 群集部署到 Azure 虚拟网络\r 本教程是一个系列中的第一部分。 可以了解到如何使用 Azure CLI 将 Linux Service Fabric 群集部署到现有 Azure 虚拟网络 (VNET) 及子网。 完成本教程后，云中会运行一个可在其中部署应用程序的群集。 若要使用 PowerShell 创建 Windows 群集，请参阅[在 Azure 上创建安全的 Windows 群集](service-fabric-tutorial-create-vnet-and-windows-cluster.md)。\r \r 本教程介绍如何执行下列操作：\r \r > [!div class=\"checklist\"]\r > * 使用 Azure CLI 在 Azure 中创建 VNET\r > * 使用 Azure CLI 在 Azure 中创建安全的 Service Fabric 群集\r > * 使用 X.509 证书保护群集\r > * 使用 Service Fabric CLI 连接到群集\r > * 删除群集\r \r 在此系列教程中，你将学习如何：\r > [!div class=\"checklist\"]\r > * 在 Azure 上创建安全群集\r > * [缩小或扩大群集](/service-fabric-tutorial-scale-cluster.md)\r > * [部署 API 管理与 Service Fabric](service-fabric-tutorial-deploy-api-management.md)\r \r ## <a name=\"prerequisites\"></a>先决条件\r 在开始学习本教程之前：\r - 如果还没有 Azure 订阅，请创建一个[试用帐户](https://www.azure.cn/pricing/1rmb-trial/?WT.mc_id=A261C142F)\r - 安装 [Service Fabric CLI](service-fabric-cli.md)\r - 安装 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-azure-cli?view=azure-cli-latest)\r \r 以下步骤将创建一个五节点 Service Fabric 群集。 若要计算在 Azure 中运行 Service Fabric 群集的成本，请使用 [Azure 定价计算器](https://www.azure.cn/pricing/calculator/)。\r \r ## <a name=\"introduction\"></a>介绍\r 本教程将单个节点类型的五个节点群集部署到 Azure 的虚拟网络中。\r \r [Service Fabric 群集](service-fabric-deploy-anywhere.md)是一组通过网络连接在一起的虚拟机或物理计算机，你的微服务将在其中部署和管理。 群集可以扩展到成千上万台计算机。 构成群集的计算机或 VM 称为节点。 需为每个节点分配节点名称（字符串）。 节点具有各种特征，如放置属性。\r \r 节点类型定义群集中一组虚拟机的大小、数量和属性。 每个已定义的节点类型均设置为[虚拟机规模集](/virtual-machine-scale-sets/)，是一种 Azure 计算资源，可用于将一组虚拟机作为一个集进行部署和管理。 然后，每个节点类型可以独立扩展或缩减、打开不同的端口集，并可以有不同的容量指标。 节点类型用于定义一组群集节点（如“前端”或“后端”）的角色。  群集可以有多个节点类型，但主节点类型必须至少有 5 个 VM 供群集用于生产（或至少有 3 个 VM 用于测试群集）。  [Service Fabric 系统服务](service-fabric-technical-overview.md#system-services)位于主节点类型的节点上。\r \r ## <a name=\"cluster-capacity-planning\"></a>群集容量规划\r 本教程部署单个节点类型中的五个节点群集。  对于任何生产群集部署，容量规划都是一个重要的步骤。 下面是在规划过程中必须注意的一些事项。\r \r - 群集需要的节点类型数目 \r - 每个节点类型的属性（例如，大小、主节点、面向 Internet 以及 VM 数量等）\r - 群集的可靠性和持久性特征\r \r 有关详细信息，请参阅[群集容量规划注意事项](service-fabric-cluster-capacity.md)。\r \r ## <a name=\"sign-in-to-azure-and-select-your-subscription\"></a>登录到 Azure，然后选择订阅\r 本指南使用 Azure CLI。 开始新的会话时，请登录到 Azure 帐户并选择订阅，然后执行 Azure 命令。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 运行以下脚本以登录到 Azure 帐户并选择订阅：\r \r ```azurecli\r az login\r az account set --subscription <guid>\r ```\r \r ## <a name=\"create-a-resource-group\"></a>创建资源组\r 针对部署创建新的资源组，并为其提供名称和位置。\r \r ```azurecli\r ResourceGroupName=\"sflinuxclustergroup\"\r Location=\"chinaeast\"\r az group create --name $ResourceGroupName --location $Location\r ```\r \r ## <a name=\"deploy-the-network-topology\"></a>部署网络拓扑\r 接下来，设置将向其部署 API 管理和 Service Fabric 群集的网络拓扑。 [network.json][network-arm] 资源管理器模板会配置为针对 Service Fabric 创建虚拟网络 (VNET) 以及一个子网和网络安全组 (NSG)，并配置为针对 API 管理创建一个子网和 NSG。 在[此处](../virtual-network/virtual-networks-overview.md)了解有关 VNET、子网和 NSG 的详细信息。\r \r [network.parameters.json][network-parameters-arm] 参数文件包含子网名称以及向其部署 Service Fabric 和 API 管理的 NSG。  API 管理将在[以下教程](service-fabric-tutorial-deploy-api-management.md)中进行部署。 本指南中，不需要更改参数值。 Service Fabric 资源管理器模板使用这些值。  如果在此处修改这些值，则必须在本教程和[部署 API 管理教程](service-fabric-tutorial-deploy-api-management.md)中所使用的其他资源管理器模板中对其进行修改。 \r \r 下载以下资源管理器模板和参数文件：\r - [network.json][network-arm]\r - [network.parameters.json][network-parameters-arm]\r \r 使用以下脚本为网络设置部署资源管理器模板和参数文件：\r \r ```azurecli\r az group deployment create \\\r     --name VnetDeployment \\\r     --resource-group $ResourceGroupName \\\r     --template-file network.json \\\r     --parameters @network.parameters.json\r ```\r <a id=\"createvaultandcert\" name=\"createvaultandcert_anchor\"></a>\r ## <a name=\"deploy-the-service-fabric-cluster\"></a>部署 Service Fabric 群集\r 网络资源部署完成后，下一步是将 Service Fabric 群集部署到子网中的 VNET 以及为 Service Fabric 群集指定的 NSG。 将群集部署到现有 VNET 和子网（在本文前面已部署）需要资源管理器模板。  有关详细信息，请参阅[使用 Azure 资源管理器创建群集](service-fabric-cluster-creation-via-arm.md)。 在本教程系列中，模板预配置为使用上一步中设置的 VNET、子网和 NSG 的名称。  \r \r 下载以下资源管理器模板和参数文件：\r - [linuxcluster.json][cluster-arm]\r - [linuxcluster.parameters.json][cluster-parameters-arm]\r \r 使用此模板创建安全群集。  群集证书是一种 X.509 证书，用于保护节点到节点的通信，并对指向管理客户端的群集管理终结点进行验证。  群集证书还通过 HTTPS 为 HTTPS 管理 API 和 Service Fabric Explorer 提供 SSL。 Azure 密钥保管库用于管理 Azure 中 Service Fabric 群集的证书。  在 Azure 中部署群集时，负责创建 Service Fabric 群集的 Azure 资源提供程序将从密钥保管库提取证书，并将其安装在群集 VM 上。 \r \r 可将来自证书颁发机构 (CA) 的证书用作群集证书，或创建自签名证书用于测试。 群集证书必须具备以下条件：\r \r - 包含私钥。\r - 专为密钥交换而创建，且证书可导出到个人信息交换 (.pfx) 文件。\r - 证书的使用者名称必须与用于访问 Service Fabric 群集的域匹配。 只有符合此要求，才能为群集的 HTTPS 管理终结点和 Service Fabric Explorer 提供 SSL。 无法从证书颁发机构 (CA) 处获取针对 .cloudapp.chinacloudapi.cn 域的 SSL 证书。 必须获取群集的自定义域名。 从 CA 请求证书时，该证书的使用者名称必须与用于群集的自定义域名匹配。\r \r 填写 linuxcluster.parameters.json 文件中用于部署的空参数：\r \r |参数|值|\r |---|---|\r |adminPassword|Password#1234|\r |adminUserName|vmadmin|\r |clusterName|mysfcluster|\r \r 若要创建自签名证书，请将 certificateThumbprint、certificateUrlValue 和 sourceVaultValue 参数留空。  如果要使用之前上传到密钥保管库的现有证书，请填写这些参数值。\r \r 以下脚本使用 [az sf cluster create](https://docs.azure.cn/zh-cn/cli/sf/cluster?view=azure-cli-latest#az_sf_cluster_create) 命令和模板在 Azure 中部署新群集。 该 cmdlet 还会在 Azure 中创建新的密钥保管库、向密钥保管库添加新的自签名证书，并将证书文件下载到本地。 可使用 [az sf cluster create](https://docs.azure.cn/zh-cn/cli/sf/cluster?view=azure-cli-latest#az_sf_cluster_create) 命令的其他参数指定现有的证书和/或密钥保管库。\r \r ```azurecli\r Password=\"q6D7nN%6ck@6\"\r Subject=\"mysfcluster.chinaeast.cloudapp.chinacloudapi.cn\"\r VaultName=\"linuxclusterkeyvault\"\r az group create --name $ResourceGroupName --location $Location\r \r az sf cluster create --resource-group $ResourceGroupName --location $Location \\\r    --certificate-output-folder . --certificate-password $Password --certificate-subject-name $Subject \\\r    --vault-name $VaultName --vault-resource-group $ResourceGroupName  \\\r    --template-file linuxcluster.json --parameter-file linuxcluster.parameters.json\r \r ```\r \r ## <a name=\"connect-to-the-secure-cluster\"></a>连接到安全群集\r 使用密钥通过 Service Fabric CLI `sfctl cluster select` 命令连接到群集。  请注意仅针对自签名证书使用 **--no-verify** 选项。\r \r ```azurecli\r sfctl cluster select --endpoint https://aztestcluster.chinaeast.cloudapp.chinacloudapi.cn:19080 \\\r --pem ./aztestcluster201709151446.pem --no-verify\r ```\r \r 检查是否已连接并使用 `sfctl cluster health` 命令检查群集是否处于正常状态。\r \r ```azurecli\r sfctl cluster health\r ```\r \r ## <a name=\"clean-up-resources\"></a>清理资源\r 本教程系列中的其他文章将使用刚才创建的群集。 如果没有立即转到下一篇文章，可能需要删除该群集，避免产生费用。 若要删除群集及其占用的所有资源，最简单的方式是删除资源组。\r \r 登录到 Azure，选择要删除的群集的订阅 ID。  可通过登录到 [Azure 门户](http://portal.azure.cn)查找订阅 ID。 使用 [az group delete](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#az_group_delete) 命令删除资源组和所有群集资源。\r \r ```azurecli\r az group delete --name $ResourceGroupName\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r 在本教程中，你已学习了如何执行以下操作：\r \r > [!div class=\"checklist\"]\r > * 使用 Azure CLI 在 Azure 中创建 VNET\r > * 使用 Azure CLI 在 Azure 中创建安全的 Service Fabric 群集\r > * 使用 X.509 证书保护群集\r > * 使用 Service Fabric CLI 连接到群集\r > * 删除群集\r \r 接下来，请转到以下教程了解如何缩放群集。\r > [!div class=\"nextstepaction\"]\r > [缩放群集](service-fabric-tutorial-scale-cluster.md)\r \r [network-arm]:https://github.com/Azure-Samples/service-fabric-api-management/blob/master/network.json\r [network-parameters-arm]:https://github.com/Azure-Samples/service-fabric-api-management/blob/master/network.parameters.json\r \r [cluster-arm]:https://github.com/Azure-Samples/service-fabric-api-management/blob/master/linuxcluster.json\r [cluster-parameters-arm]:https://github.com/Azure-Samples/service-fabric-api-management/blob/master/linuxcluster.parameters.json\r \r <!--Update_Description: update link, wording update -->"}