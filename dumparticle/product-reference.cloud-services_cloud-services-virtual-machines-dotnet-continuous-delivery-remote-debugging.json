{"Title":"使用持续交付启用远程调试","Description":"了解在使用持续交付部署到 Azure 时如何启用远程调试","Content":"# <a name=\"enable-remote-debugging-when-using-continuous-delivery-to-publish-to-azure\"></a>使用持续交付功能发布到 Azure 时如何启用远程调试\r \r 使用[持续交付](./cloud-services-dotnet-continuous-delivery.md)发布到 Azure 时，可通过执行以下步骤，在 Azure 中针对云服务或虚拟机启用远程调试。\r \r ## <a name=\"enabling-remote-debugging-for-cloud-services\"></a>为云服务启用远程调试\r 1. 在生成代理上，根据 [Azure 的命令行生成](http://msdn.microsoft.com/library/hh535755.aspx)中所述设置 Azure 的初始环境。\r 2. 由于远程调试运行时 (msvsmon.exe) 是该包所必需的，请安装**用于 Visual Studio 的远程工具**。\r \r     * [用于 Visual Studio 2017 的远程工具](https://go.microsoft.com/fwlink/?LinkId=746570)\r     * [用于 Visual Studio 2015 的远程工具](https://go.microsoft.com/fwlink/?LinkId=615470)\r     \r     或者，也可以从装有 Visual Studio 的系统复制远程调试二进制文件。\r \r 3. 根据 [Azure 云服务的证书概述](cloud-services-certs-create.md)中所述创建证书。 保留 .pfx 和 RDP 证书指纹，并将证书上传到目标云服务。\r 4. 在 MSBuild 命令行中使用以下选项生成一个已启用远程调试的包。 （将尖括号中的项替换为系统和项目文件的实际路径）。\r \r     ```\r     msbuild /TARGET:PUBLISH /PROPERTY:Configuration=Debug;EnableRemoteDebugger=true;VSX64RemoteDebuggerPath=\"<remote tools path>\";RemoteDebuggerConnectorCertificateThumbprint=\"<thumbprint of the certificate added to the cloud service>\";RemoteDebuggerConnectorVersion=\"2.7\" \"<path to your VS solution file>\"\r     ```\r \r     `VSX64RemoteDebuggerPath` 是 Visual Studio 远程工具中 msvsmon.exe 所在的文件夹的路径。\r     \r             `RemoteDebuggerConnectorVersion` 是云服务中的 Azure SDK 版本。 它也应与随 Visual Studio 一起安装的版本匹配。\r \r 5. 使用上一步中生成的包和 .cscfg 文件发布到目标云服务。\r 6. 将证书（.pfx 文件）导入到装有 Visual Studio 和 Azure SDK for .NET 的计算机。 请确保导入到 `CurrentUser\\My` 证书存储，否则附加到 Visual Studio 中的调试器会失败。\r \r ## <a name=\"enabling-remote-debugging-for-virtual-machines\"></a>为虚拟机启用远程调试\r \r 1. 创建一个 Azure 虚拟机。 请参阅[创建运行 Windows Server 的虚拟机](../virtual-machines/virtual-machines-windows-hero-tutorial.md?toc=%2fvirtual-machines%2fwindows%2ftoc.json)或[在 Visual Studio 中创建和管理 Azure 虚拟机](../virtual-machines/windows/classic/manage-visual-studio.md?toc=%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json)。\r 2. 在 [Azure 经典门户页](http://go.microsoft.com/fwlink/p/?LinkID=269851)上的虚拟机仪表板中，查看虚拟机的“**RDP 证书指纹**”。 扩展配置中的 `ServerThumbprint` 值使用此值。\r 3. 根据 [Azure 云服务的证书概述](./cloud-services-certs-create.md)中所述创建客户端证书（保留 .pfx 和 RDP 证书指纹）。\r 4. 根据[如何安装和配置 Azure PowerShell](../powershell-install-configure.md) 中所述安装 Azure Powershell（0.7.4 或更高版本）。\r 5. 运行以下脚本以启用 RemoteDebug 扩展。 将路径和个人数据替换为自己的数据，例如，订阅名称、服务名称和指纹。\r \r    > [!NOTE]\r    > 此脚本是针对 Visual Studio 2015 配置的。 如果使用的是 Visual Studio 2013 或 Visual Studio 2017，请将下面的 `$referenceName` 和 `$extensionName` 赋值修改为 `RemoteDebugVS2013` 或 `RemoteDebugVS2017`。\r \r     ```powershell   \r     Add-AzureAccount -Environment AzureChinaCloud\r \r     Select-AzureSubscription \"My Microsoft Subscription\"\r \r     $vm = Get-AzureVM -ServiceName \"mytestvm1\" -Name \"mytestvm1\"\r \r     $endpoints = @(\r     ,@{Name=\"RDConnVS2013\"; PublicPort=30400; PrivatePort=30398}\r     ,@{Name=\"RDFwdrVS2013\"; PublicPort=31400; PrivatePort=31398}\r     )\r \r     foreach($endpoint in $endpoints)\r     {\r     Add-AzureEndpoint -VM $vm -Name $endpoint.Name -Protocol tcp -PublicPort $endpoint.PublicPort -LocalPort $endpoint.PrivatePort\r     }\r \r     $referenceName = \"Microsoft.VisualStudio.WindowsAzure.RemoteDebug.RemoteDebugVS2015\"\r     $publisher = \"Microsoft.VisualStudio.WindowsAzure.RemoteDebug\"\r     $extensionName = \"RemoteDebugVS2015\"\r     $version = \"1.*\"\r     $publicConfiguration = \"<PublicConfig><Connector.Enabled>true</Connector.Enabled><ClientThumbprint>56D7D1B25B472268E332F7FC0C87286458BFB6B2</ClientThumbprint><ServerThumbprint>E7DCB00CB916C468CC3228261D6E4EE45C8ED3C6</ServerThumbprint><ConnectorPort>30398</ConnectorPort><ForwarderPort>31398</ForwarderPort></PublicConfig>\"\r \r     $vm | Set-AzureVMExtension -ReferenceName $referenceName -Publisher $publisher -ExtensionName $extensionName -Version $version -PublicConfiguration $publicConfiguration\r \r     foreach($extension in $vm.VM.ResourceExtensionReferences)\r     {\r     if(($extension.ReferenceName -eq $referenceName) `\r     -and ($extension.Publisher -eq $publisher) `\r     -and ($extension.Name -eq $extensionName) `\r     -and ($extension.Version -eq $version))\r     {\r     $extension.ResourceExtensionParameterValues[0].Key = 'config.txt'\r     break\r     }\r     }\r \r     $vm | Update-AzureVM\r     ```\r \r 6. 将证书导入到装有 Visual Studio 和用于 .NET 的 Azure SDK 的计算机。\r \r <!--Update_Description:update wording and link references-->"}