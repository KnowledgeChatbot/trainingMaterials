{"Title":"结合 Linux 规模集模板中的来宾指标使用 Azure 自动缩放","Description":"了解如何使用 Linux 虚拟机规模集模板中的来宾指标执行自动缩放","Content":"# <a name=\"autoscale-using-guest-metrics-in-a-linux-scale-set-template\"></a>使用 Linux 规模集模板中的来宾指标执行自动缩放\r \r 在 Azure 中，会从 VM 和规模集收集两种类型的指标：有些指标来自主机 VM，还有一些指标来自来宾 VM。 粗略地讲，如果使用的是标准 CPU、磁盘和网络指标，主机指标可能就非常适合。 不过，如果需要更多指标，来宾指标可能更为适合。 这两者的区别如下：\r \r 主机指标更简单、更可靠。 它们不需要进行额外设置，因为它们是由主机 VM 收集；而来宾指标则需要在来宾 VM 中安装 [Azure 诊断扩展](../virtual-machines/windows/extensions-diagnostics-template.md)或 [Linux Azure 诊断扩展](../virtual-machines/linux/diagnostic-extension.md)。 使用来宾指标而不是主机指标的一个常见原因是，与主机指标相比，来宾指标提供更大的指标选择范围。 内存消耗指标就是这样一个例子，它们只会通过来宾指标提供。 [此处](../monitoring-and-diagnostics/monitoring-supported-metrics.md)列出了支持的主机指标，[此处](../monitoring-and-diagnostics/insights-autoscale-common-metrics.md)列出了常用的来宾指标。 本文介绍如何修改[最小可行规模集模板](./virtual-machine-scale-sets-mvss-start.md)，以根据 Linux 规模集的来宾指标使用自动缩放规则。\r \r ## <a name=\"change-the-template-definition\"></a>更改模板定义\r \r 可在[此处](https://raw.githubusercontent.com/gatneil/mvss/minimum-viable-scale-set/azuredeploy.json)查看最小可行规模集模板，在[此处](https://raw.githubusercontent.com/gatneil/mvss/guest-based-autoscale-linux/azuredeploy.json)查看用于通过基于来宾的自动缩放部署 Linux 规模集的模板。 让我们逐一查看创建此模板 (`git diff minimum-viable-scale-set existing-vnet`) 时使用的差异内容：\r \r 首先，添加 `storageAccountName` 和 `storageAccountSasToken` 的参数。 诊断代理将指标数据存储在此存储帐户中的某个[表](../cosmos-db/table-storage-how-to-use-dotnet.md)内。 从 Linux 诊断代理版本 3.0 开始，不再支持使用存储访问密钥。 必须使用 [SAS 令牌](../storage/common/storage-dotnet-shared-access-signature-part-1.md)。\r \r ```diff\r      },\r      \"adminPassword\": {\r        \"type\": \"securestring\"\r +    },\r +    \"storageAccountName\": {\r +      \"type\": \"string\"\r +    },\r +    \"storageAccountSasToken\": {\r +      \"type\": \"securestring\"\r      }\r    },\r ```\r \r 接下来，修改规模集 `extensionProfile` 以包含诊断扩展。 在此配置中，指定要从中收集指标的规模集的资源 ID，以及用来存储指标的存储帐户和 SAS 令牌。 此外，指定指标的聚合频率（在本例中为每隔一分钟）以及要跟踪的指标（在本例中为已用内存百分比）。 有关此配置以及除已用内存百分比之外的其他指标的详细信息，请参阅[此文档](../virtual-machines/linux/diagnostic-extension.md)。\r \r ```diff\r                  }\r                }\r              ]\r +          },\r +          \"extensionProfile\": {\r +            \"extensions\": [\r +              {\r +                \"name\": \"LinuxDiagnosticExtension\",\r +                \"properties\": {\r +                  \"publisher\": \"Microsoft.Azure.Diagnostics\",\r +                  \"type\": \"LinuxDiagnostic\",\r +                  \"typeHandlerVersion\": \"3.0\",\r +                  \"settings\": {\r +                    \"StorageAccount\": \"[parameters('storageAccountName')]\",\r +                    \"ladCfg\": {\r +                      \"diagnosticMonitorConfiguration\": {\r +                        \"performanceCounters\": {\r +                          \"sinks\": \"WADMetricJsonBlob\",\r +                          \"performanceCounterConfiguration\": [\r +                            {\r +                              \"unit\": \"percent\",\r +                              \"type\": \"builtin\",\r +                              \"class\": \"memory\",\r +                              \"counter\": \"percentUsedMemory\",\r +                              \"counterSpecifier\": \"/builtin/memory/percentUsedMemory\",\r +                              \"condition\": \"IsAggregate=TRUE\"\r +                            }\r +                          ]\r +                        },\r +                        \"metrics\": {\r +                          \"metricAggregation\": [\r +                            {\r +                              \"scheduledTransferPeriod\": \"PT1M\"\r +                            }\r +                          ],\r +                          \"resourceId\": \"[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]\"\r +                        }\r +                      }\r +                    }\r +                  },\r +                  \"protectedSettings\": {\r +                    \"storageAccountName\": \"[parameters('storageAccountName')]\",\r +                    \"storageAccountSasToken\": \"[parameters('storageAccountSasToken')]\",\r +                    \"sinksConfig\": {\r +                      \"sink\": [\r +                        {\r +                          \"name\": \"WADMetricJsonBlob\",\r +                          \"type\": \"JsonBlob\"\r +                        }\r +                      ]\r +                    }\r +                  }\r +                }\r +              }\r +            ]\r            }\r          }\r        }\r ```\r \r 最后，添加 `autoscaleSettings` 资源以基于这些指标配置自动缩放。 此资源包含一个引用规模集的 `dependsOn` 子句，确保在尝试自动缩放该规模集之前它已存在。 如果选择不同的指标作为自动缩放的依据，可使用诊断扩展配置中的 `counterSpecifier` 作为自动缩放配置中的 `metricName`。 有关自动缩放配置的详细信息，请参阅[自动缩放最佳做法](..//monitoring-and-diagnostics/insights-autoscale-best-practices.md)和 [Azure Monitor REST API 参考文档](https://msdn.microsoft.com/library/azure/dn931928.aspx)。\r \r ```diff\r +    },\r +    {\r +      \"type\": \"Microsoft.Insights/autoscaleSettings\",\r +      \"apiVersion\": \"2015-04-01\",\r +      \"name\": \"guestMetricsAutoscale\",\r +      \"location\": \"[resourceGroup().location]\",\r +      \"dependsOn\": [\r +        \"Microsoft.Compute/virtualMachineScaleSets/myScaleSet\"\r +      ],\r +      \"properties\": {\r +        \"name\": \"guestMetricsAutoscale\",\r +        \"targetResourceUri\": \"[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]\",\r +        \"enabled\": true,\r +        \"profiles\": [\r +          {\r +            \"name\": \"Profile1\",\r +            \"capacity\": {\r +              \"minimum\": \"1\",\r +              \"maximum\": \"10\",\r +              \"default\": \"3\"\r +            },\r +            \"rules\": [\r +              {\r +                \"metricTrigger\": {\r +                  \"metricName\": \"/builtin/memory/percentUsedMemory\",\r +                  \"metricNamespace\": \"\",\r +                  \"metricResourceUri\": \"[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]\",\r +                  \"timeGrain\": \"PT1M\",\r +                  \"statistic\": \"Average\",\r +                  \"timeWindow\": \"PT5M\",\r +                  \"timeAggregation\": \"Average\",\r +                  \"operator\": \"GreaterThan\",\r +                  \"threshold\": 60\r +                },\r +                \"scaleAction\": {\r +                  \"direction\": \"Increase\",\r +                  \"type\": \"ChangeCount\",\r +                  \"value\": \"1\",\r +                  \"cooldown\": \"PT1M\"\r +                }\r +              },\r +              {\r +                \"metricTrigger\": {\r +                  \"metricName\": \"/builtin/memory/percentUsedMemory\",\r +                  \"metricNamespace\": \"\",\r +                  \"metricResourceUri\": \"[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'myScaleSet')]\",\r +                  \"timeGrain\": \"PT1M\",\r +                  \"statistic\": \"Average\",\r +                  \"timeWindow\": \"PT5M\",\r +                  \"timeAggregation\": \"Average\",\r +                  \"operator\": \"LessThan\",\r +                  \"threshold\": 30\r +                },\r +                \"scaleAction\": {\r +                  \"direction\": \"Decrease\",\r +                  \"type\": \"ChangeCount\",\r +                  \"value\": \"1\",\r +                  \"cooldown\": \"PT1M\"\r +                }\r +              }\r +            ]\r +          }\r +        ]\r +      }\r      }\r    ]\r  }\r ```\r \r \r \r \r \r ## <a name=\"next-steps\"></a>后续步骤\r \r [!INCLUDE [mvss-next-steps-include](../../includes/mvss-next-steps.md)]\r \r "}