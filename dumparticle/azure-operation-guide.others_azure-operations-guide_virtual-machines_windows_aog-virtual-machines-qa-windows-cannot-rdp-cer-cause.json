{"Title":"Windows RDP 证书问题导致无法远程了连接解决方案","Description":"Windows RDP 证书问题导致无法远程了连接解决方案","Content":"\r # Windows RDP 证书问题导致无法远程了连接解决方案\r \r ## **问题描述**\r \r 虚拟机无法 RDP 连接。<br>\r 客户截图现象如下：\r \r ![remote-failure](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/remote-failure.png)\r \r ## **问题分析**\r \r 1. Azure 平台查看状态健康，并已经启动。\r \r     ![portal](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/portal.png)\r \r 2. 测试网络虚拟机网卡 3389 端口可以通讯，所有端口正常。\r \r     ![psping](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/psping.png)\r \r 3. 后台抓取虚拟机截图，发现虚拟机已经启动。\r \r     ![vm-boot](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/vm-boot.png)\r \r 以上初步排查看上去毫无问题。<br>\r 但依然无法 RDP 连接。\r \r ![remote-failure](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/remote-failure.png)\r \r 后续步骤：检查系统配置，软件等，重启 RDP 服务，网卡，重启虚拟机，依然无法解决。\r \r `Netstat -ano` 发现很多 `CLOSE-WAIT`:\r \r ![system-init](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/system-init.png)\r \r 系统日志很多报错 :\r \r ![system-logs](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/system-logs.png)\r \r ## **解决方法**\r \r 微软官网问题原因 参考链接：[https://technet.microsoft.com/zh-cn/library/dn786445(v=ws.11](https://technet.microsoft.com/zh-cn/library/dn786445(v=ws.11).aspx#BKMK_36870)\r \r ![event-36870](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/event-36870.png)\r \r 经排查系统日志发现:<br>\r RDP 证书异常,每次使用 RDP 连接后,系统日志中就会自动生产如下 Error 日志:\r \r ![event-viewer](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/event-viewer.png)\r \r 可以通过将 VHD 下载到本地挂载 Hpyer-V 自行解决，也可以联系微软 Azure 技术支持团队 console 后台进入虚拟机。\r \r **操作步骤如下：** \r \r 在问题虚拟机中打开 MMC 控制台，\r \r ```\r Go to file/ add remove snap-in\r Select certificates \r Select computer account\r Select local computer\r Click on finish\r Click on OK\r ```\r \r ![console](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/console.png)\r \r 复制 RDP 证书，如图：<br>\r 展开 / Personal / Certificates 复制 RDP 证书 :\r \r ![console-2](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/console-2.png)\r \r 粘贴到 Remote Desktop 下 :\r \r ![console-3](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/console-3.png)\r \r 双击打开证书，选择 Details 下 Thumbprint 复制其中数值 :\r \r ![console-4](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/console-4.png)\r \r 以管理员身份运行 PowerShell :\r \r ```\r $hash = read-host \"Enter Certificate thumbprint: \"\r wmic /namespace:\\\\root\\cimv2\\TerminalServices PATH Win32_TSGeneralSetting Set SSLCertificateSHA1Hash=\"$hash\"\r ```\r \r ![certificate](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/certificate.png)\r \r 更新 RDP 证书后，可以成功连接虚拟机 RDP 服务。\r \r ![remote-success](./media/aog-virtual-machines-qa-windows-cannot-rdp-cer-cause/remote-success.png)"}