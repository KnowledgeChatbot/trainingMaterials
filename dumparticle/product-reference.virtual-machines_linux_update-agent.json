{"Title":"如何更新 VM 上的 Azure Linux 代理","Description":"了解如何从 GitHub 将 Azure 中 Linux VM 的 Azure Linux 代理更新到最新版本","Content":"# <a name=\"how-to-update-the-azure-linux-agent-on-a-vm\"></a>如何更新 VM 上的 Azure Linux 代理\r \r 若要更新 Azure 中 Linux VM 上的 [Azure Linux 代理](https://github.com/Azure/WALinuxAgent) ，则必须已具备以下条件：\r \r - 在 Azure 中具有运行的 Linux VM。\r - 使用 SHH 连接到该 Linux VM。\r \r 应始终先对 Linux 发行版存储库中的程序包进行检查。 虽然可用的程序包很有可能不是最新版本，但启用自动更新可确保 Linux 代理始终获得最新的更新。 如果从程序包管理器进行安装遇到问题，应向发行版供应商寻求支持。\r \r ## <a name=\"updating-the-azure-linux-agent\"></a>更新 Azure Linux 代理\r \r ## <a name=\"ubuntu\"></a>Ubuntu\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r apt list --installed | grep walinuxagent\r ```\r \r #### <a name=\"update-package-cache\"></a>更新程序包缓存\r \r ```bash\r sudo apt-get -qq update\r ```\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo apt-get install walinuxagent\r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新\r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r #### <a name=\"restart-agent-for-1404\"></a>重新启动 14.04 的代理\r \r ```bash\r initctl restart walinuxagent\r ```\r \r #### <a name=\"restart-agent-for-1604--1704\"></a>重新启动 16.04/17.04 的代理\r \r ```bash\r systemctl restart walinuxagent.service\r ```\r \r ## <a name=\"debian\"></a>Debian\r \r ### <a name=\"debian-7-wheezy\"></a>Debian 7“Wheezy”\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r dpkg -l | grep waagent\r ```\r \r #### <a name=\"update-package-cache\"></a>更新程序包缓存\r \r ```bash\r sudo apt-get -qq update\r ```\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo apt-get install waagent\r ```\r \r #### <a name=\"enable-agent-auto-update\"></a>启用代理自动更新\r 由于此版本的 Debian 没有 >= 2.0.16 的版本，因此 AutoUpdate 对该版本不适用。 上述命令的输出将显示程序包是否为最新版。\r \r ### <a name=\"debian-8-jessie--debian-9-stretch\"></a>Debian 8 “Jessie”/Debian 9 “Stretch”\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r apt list --installed | grep walinuxagent\r ```\r \r #### <a name=\"update-package-cache\"></a>更新程序包缓存\r \r ```bash\r sudo apt-get -qq update\r ```\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo apt-get install waagent\r ```\r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新 \r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r ```\r sudo systemctl restart walinuxagent.service\r ```\r \r ## <a name=\"redhat--centos\"></a>Redhat/CentOS\r \r ### <a name=\"rhelcentos-6\"></a>RHEL/CentOS 6\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r sudo yum list WALinuxAgent\r ```\r \r #### <a name=\"check-available-updates\"></a>检查可用的更新\r \r ```bash\r sudo yum check-update WALinuxAgent\r ```\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo yum install WALinuxAgent\r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新 \r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r ```\r sudo service waagent restart\r ```\r \r ### <a name=\"rhelcentos-7\"></a>RHEL/CentOS 7\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r sudo yum list WALinuxAgent\r ```\r \r #### <a name=\"check-available-updates\"></a>检查可用的更新\r \r ```bash\r sudo yum check-update WALinuxAgent\r ```\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo yum install WALinuxAgent  \r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新 \r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r ```bash\r sudo systemctl restart waagent.service\r ```\r \r ## <a name=\"suse-sles\"></a>SUSE SLES\r \r ### <a name=\"suse-sles-11-sp4\"></a>SUSE SLES 11 SP4\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r zypper info python-azure-agent\r ```\r \r #### <a name=\"check-available-updates\"></a>检查可用的更新\r \r 上面的输出将显示程序包是否为最新版。\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo zypper install python-azure-agent\r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新 \r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r ```bash\r sudo /etc/init.d/waagent restart\r ```\r \r ### <a name=\"suse-sles-12-sp2\"></a>SUSE SLES 12 SP2\r \r #### <a name=\"check-your-current-package-version\"></a>检查当前程序包的版本\r \r ```bash\r zypper info python-azure-agent\r ```\r \r #### <a name=\"check-available-updates\"></a>检查可用的更新\r \r 在上面的输出中，这将显示程序包是否为最新版。\r \r #### <a name=\"install-the-latest-package-version\"></a>安装最新版本的程序包\r \r ```bash\r sudo zypper install python-azure-agent\r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新 \r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"restart-the-waagent-service\"></a>重新启动 waagent 服务\r \r ```bash\r sudo systemctl restart waagent.service\r ```\r \r ## <a name=\"oracle-6-and-7\"></a>Oracle 6 和 Oracle 7\r \r 对于 Oracle Linux，请确保已启用 `Addons` 存储库。 选择以编辑文件 `/etc/yum.repos.d/public-yum-ol6.repo`(Oracle Linux 6) 或 `/etc/yum.repos.d/public-yum-ol7.repo`(Oracle Linux)，并在此文件中 [ol6_addons] 或 [ol7_addons] 下将行 `enabled=0` 更改为 `enabled=1`。\r \r 然后，要安装最新版本的 Azure Linux 代理，请键入：\r \r ```bash\r sudo yum install WALinuxAgent\r ```\r \r 如果找不到外接程序存储库，只需根据 Oracle Linux 版本，将这些行添加到 .repo 文件末尾处：\r \r 对于 Oracle Linux 6 虚拟机：\r \r ```sh\r [ol6_addons]\r name=Add-Ons for Oracle Linux $releasever ($basearch)\r baseurl=http://public-yum.oracle.com/repo/OracleLinux/OL6/addons/x86_64\r gpgkey=http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol6\r gpgcheck=1\r enabled=1\r ```\r \r 对于 Oracle Linux 7 虚拟机：\r \r ```sh\r [ol7_addons]\r name=Oracle Linux $releasever Add ons ($basearch)\r baseurl=http://public-yum.oracle.com/repo/OracleLinux/OL7/addons/$basearch/\r gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle\r gpgcheck=1\r enabled=0\r ```\r \r 然后键入：\r \r ```bash\r sudo yum update WALinuxAgent\r ```\r \r 通常只需要这样做，但如果因某种原因而需要直接从 https://github.com 安装它，请使用以下步骤。\r \r \r ## <a name=\"update-the-linux-agent-when-no-agent-package-exists-for-distribution\"></a>分发不存在代理程序包时，请更新 Linux 代理\r \r 通过在命令行上键入 `sudo yum install wget` 来安装 wget（某些发行版在默认情况下未安装它，如 Redhat、CentOS 和 Oracle Linux 6.4 和 6.5 版）。\r \r ### <a name=\"1-download-the-latest-version\"></a>1.下载最新版本\r 在网页中打开 [GitHub 中的 Azure Linux 代理版本](https://github.com/Azure/WALinuxAgent/releases)，并找到最新的版本号。 （可以通过键入 `waagent --version` 查明当前版本。）\r \r #### <a name=\"for-version-22x-or-later-type\"></a>对于 2.2.x 或更高版本，请键入：\r ```bash\r wget https://github.com/Azure/WALinuxAgent/archive/v2.2.x.zip\r unzip v2.2.x.zip.zip\r cd WALinuxAgent-2.2.x\r ```\r \r 以下行使用版本 2.2.0 作为示例：\r \r ```bash\r wget https://github.com/Azure/WALinuxAgent/archive/v2.2.14.zip\r unzip v2.2.14.zip  \r cd WALinuxAgent-2.2.14\r ```\r \r ### <a name=\"2-install-the-azure-linux-agent\"></a>2.安装 Azure Linux 代理\r \r #### <a name=\"for-version-22x-use\"></a>对于版本 2.2.x，请使用：\r 可能需要先安装程序包 `setuptools` -- 详情请参阅 [此处](https://pypi.python.org/pypi/setuptools)。 运行：\r \r ```bash\r sudo python setup.py install\r ```\r \r #### <a name=\"ensure-auto-update-is-enabled\"></a>确保已启用自动更新\r \r 首先，检查是否已启用自动更新：\r \r ```bash\r cat /etc/waagent.conf\r ```\r \r 查找“AutoUpdate.Enabled”。 如果看到以下输出，则表示已启用：\r \r ```bash\r # AutoUpdate.Enabled=y\r AutoUpdate.Enabled=y\r ```\r \r 若要允许运行：\r \r ```bash\r sudo sed -i 's/AutoUpdate.Enabled=n/AutoUpdate.Enabled=y/g' /etc/waagent.conf\r ```\r \r ### <a name=\"3-restart-the-waagent-service\"></a>3.重新启动 waagent 服务\r 对于大多数 linux 发行版：\r \r ```bash\r sudo service waagent restart\r ```\r \r 对于 Ubuntu，使用：\r \r ```bash\r sudo service walinuxagent restart\r ```\r \r 对于 CoreOS，使用：\r \r ```bash\r sudo systemctl restart waagent\r ```\r \r ### <a name=\"4-confirm-the-azure-linux-agent-version\"></a>4.确认 Azure Linux 代理版本\r     \r ```bash\r waagent -version\r ```\r \r 对于 CoreOS，上面的命令可能无效。\r \r 你会看到 Linux 代理版本已更新为新版本。\r \r 有关 Azure Linux 代理的详细信息，请参阅 [Azure Linux 代理自述文件](https://github.com/Azure/WALinuxAgent)。\r <!--Update_Description: whole content update-->\r "}