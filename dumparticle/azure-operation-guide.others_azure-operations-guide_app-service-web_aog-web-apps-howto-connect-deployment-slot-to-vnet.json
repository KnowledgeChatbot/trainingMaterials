{"Title":"如何将 Web 应用部署槽连接到 Azure 虚拟网络","Description":"如何将 Web 应用部署槽连接到 Azure 虚拟网络","Content":"\r # 如何将 Web 应用部署槽连接到 Azure 虚拟网络\r \r ## 准备工作\r \r - Web 应用处于标准或高级的定价层\r - 具有点到站点连接配置网关的虚拟网络\r \r ## 操作步骤\r \r 通过以下步骤完成 Web 应用部署槽连接到虚拟网络：\r \r 1. 通过 PowerShell 配置相应的参数并生成证书。\r \r     ```\r     $Configuration = @{}\r     $Configuration.WebAppResourceGroup = \"[Your web app resource group]\"\r     $Configuration.WebAppName = \"[websitename/slotname]\"\r     $Configuration.VnetSubscriptionId = \"[Your vnet subscription id]\"\r     $Configuration.VnetResourceGroup = \"[Your vnet resource group]\"\r     $Configuration.VnetName = \"[Your vnet name]\"\r     $Configuration.WebAppLocation = \"[Your web app Location]\"、$Configuration.GeneratedCertificatePath = \"[Your local path\\Certificate.cer]\"\r \r     $vnet = New-AzureRmResource -Name \"$($Configuration.WebAppName)/$($Configuration.VnetName)\" -ResourceGroupName $Configuration.WebAppResourceGroup -ResourceType \"Microsoft.Web/sites/virtualNetworkConnections\" -PropertyObject @{\"VnetResourceId\" = \"/subscriptions/$($Configuration.VnetSubscriptionId)/resourceGroups/$($Configuration.VnetResourceGroup)/providers/Microsoft.ClassicNetwork/virtualNetworks/$($Configuration.VnetName)\"} -Location $Configuration.WebAppLocation -ApiVersion 2015-07-01\r \r     #create certificate , run once befroe\r     $certBytes = [System.Convert]::FromBase64String($vnet.Properties.certBlob)\r     [System.IO.File]::WriteAllBytes(\"$($Configuration.GeneratedCertificatePath)\", $certBytes)\r     ```\r \r 2. 将上一步骤生成的证书上传到已经创建好的 VNET 中。\r \r     ![certificates](./media/aog-web-apps-howto-connect-deployment-slot-to-vnet/certificates.jpg)\r \r 3. 获取点到站点包，并将其供给 Web 应用。将如下内容的 GetNetworkPackageUri.json 文件，保存到本地环境中，例如：D:\\cert\\GetNetworkPackageUri.json。\r \r     ```\r     {\r         \"$schema\": \"http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#\",\r         \"contentVersion\": \"1.0.0.0\",\r         \"parameters\": {\r             \"certData\": {\r                 \"type\": \"string\"\r             },\r             \"certThumbprint\": {\r                 \"type\": \"string\"\r             },\r             \"networkName\": {\r                 \"type\": \"string\"\r             }\r         },\r         \"variables\": {\r             \"legacyVnetName\": \"[concat('Group ', resourceGroup().name, ' ', parameters('networkName'))]\"\r             },\r             \"resources\": [\r             ],\r         \"outputs\" : {\r             \"PackageUri\" :\r             {\r             \"value\" : \"[listPackage(resourceId('Microsoft.ClassicNetwork/virtualNetworks/gateways/clientRootCertificates', parameters('networkName'), 'primary', parameters('certThumbprint')), '2014-06-01').packageUri]\", \"type\" : \"string\"\r             }\r         }\r     }\r     ```\r \r     执行下面部署的脚本：\r \r     ```\r     $parameters = @{\"certData\" = $vnet.Properties.certBlob ;certThumbprint = $vnet.Properties.certThumbprint ;\"networkName\" = $Configuration.VnetName }\r     $output = New-AzureRmResourceGroupDeployment -Name unused -ResourceGroupName $Configuration.VnetResourceGroup -TemplateParameterObject $parameters -TemplateFile  D:\\cert\\GetNetworkPackageUri.json\r     ```\r \r     将点到站点包上载到应用：\r \r     ```\r     $vnet = New-AzureRmResource -Name \"$($Configuration.WebAppName)/$($Configuration.VnetName)/primary\" -ResourceGroupName $Configuration.WebAppResourceGroup -ResourceType \"Microsoft.Web/sites /virtualNetworkConnections/gateways\" -ApiVersion 2015-07-01 -PropertyObject @{\"VnetName\" = $Configuration.VnetName ; \"VpnPackageUri\" = $($output.Outputs.packageUri).Value } -Location $Configuration.WebAppLocation\r     ```\r \r 4. 执行成功后，等待几分钟，就可以通过 Portal 看到 VNET 中已经连接了一个客户端。\r \r     ![vnet](./media/aog-web-apps-howto-connect-deployment-slot-to-vnet/vnet.jpg)"}