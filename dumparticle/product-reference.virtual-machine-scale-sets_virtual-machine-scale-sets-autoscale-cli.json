{"Title":"使用 Azure CLI 自动缩放虚拟机规模集","Description":"如何使用 Azure CLI 2.0 为虚拟机规模集创建自动缩放规则","Content":"# <a name=\"automatically-scale-a-virtual-machine-scale-set-with-the-azure-cli-20\"></a>使用 Azure CLI 2.0 自动缩放虚拟机规模集\r 创建规模集时，可定义想运行的 VM 实例数。 若应用程序需要更改，可自动增加或减少 VM 实例数。 通过自动缩放功能，可随客户需求的改变而进行调整，或在应用的整个生命周期内响应应用程序性能更改。\r \r 这篇文章演示了如何使用 Azure CLI 2.0 （其在规模集中监视 VM 实例性能）创建自动缩放规则。 这些缩放规则根据性能指标增加或减少 VM 实例数。 也可使用 [Azure PowerShell](virtual-machine-scale-sets-autoscale-powershell.md) 完成这些步骤。\r \r \r ## <a name=\"prerequisites\"></a>先决条件\r 需要现有虚拟机规模集，才能创建自动缩放规则。 可以使用 [Azure 门户](virtual-machine-scale-sets-portal-create.md)、[Azure CLI 2.0](virtual-machine-scale-sets-create.md#create-from-azure-cli) 或 [Azure PowerShell](virtual-machine-scale-sets-create.md#create-from-powershell) 创建规模集。\r \r 若要更轻松地创建自动缩放规则，请为规模集定义几个变量。 以下示例为 myResourceGroup 资源组和“中国北部”区域内名为 myScaleSet 的规模集定义变量。 使用 [az account show](/cli/account#az_account_show) 获取订阅 ID。 如果帐户关联了多个订阅，则仅返回第一个订阅。 按照如下所示，调整名称和订阅 ID：\r \r ```azurecli\r sub=$(az account show --query id -o tsv)\r resourcegroup_name=\"myResourceGroup\"\r scaleset_name=\"myScaleSet\"\r location_name=\"chinanorth\"\r ```\r \r ## <a name=\"define-an-autoscale-profile\"></a>定义自动缩放配置文件\r 使用 Azure CLI 2.0 将自动缩放规则部署为 JSON（JavaScript 对象表示法）。 本文章稍后会介绍定义和部署自动缩放规则的完整的 JSON。 \r \r 自动缩放配置文件开头定义了默认值、最小规模集容量和最大规模集容量。 以下示例设置了默认值，以及最小容量 2 个 VM 实例、最大容量 10 个 VM：\r \r ```json\r {\r   \"name\": \"autoscale rules\",\r   \"capacity\": {\r     \"minimum\": \"2\",\r     \"maximum\": \"10\",\r     \"default\": \"2\"\r   }\r }\r ```\r \r \r ## <a name=\"create-a-rule-to-automatically-scale-out\"></a>创建规则，以便自动横向扩展\r 如果应用程序需求提高，规模集中 VM 实例上的负载将会增大。 如果这种负载增大持续稳定，而不只是短暂的需求，那么可以配置自动缩放规则来增加规模集中的 VM 实例数。 创建这些 VM 实例及部署应用程序后，规模集会开始通过负载均衡器将流量分配到这些实例和应用程序。 可以控制要监视的指标（例如 CPU 或磁盘）、应用程序负载必须处于给定阈值内的时间，以及要添加到规模集的 VM 实例数。\r \r 当平均 CPU 负载在十分钟内均超过 70% 时，请创建规则以增加规模集中的 VM 实例数。 触发规则时，VM 实例数增加 20%。 在 VM 实例数少的规模集中，可以将 `type` 设置为 ChangeCount，并为 `value` 增加一个或两个实例。 在有大量 VM 实例的规模集中，增加 10% 或 20% 的 VM 实例可能更合适。\r \r 此规则使用以下参数：\r \r | 参数         | 说明                                                                                                         | 值           |\r |-------------------|---------------------------------------------------------------------------------------------------------------------|-----------------|\r | *metricName*      | 监视和应用规模集操作的性能指标。                                                   | CPU 百分比  |\r | *timeGrain*       | 为进行而收集指标分析的频率。                                                                   | 1 分钟        |\r | *timeAggregation* | 定义如何聚合已收集的指标以便分析。                                                | 平均值         |\r | *timeWindow*      | 比较指标与阈值之前监视的时长。                                   | 10 分钟      |\r | *operator*        | 用于比较指标数据和阈值的运算符。                                                     | 大于    |\r | *threshold*       | 使自动缩放规则触发操作的值。                                                      | 70%             |\r | direction       | 定义应用规则时，规模集应扩展还是缩减。                                             | 增加        |\r | *类型*            | 表明 VM 实例数应该增加一定的百分比。                                 | 百分比更改  |\r | value           | 应用规则时应增加或减少多少 VM 实例。                                            | 20              |\r | *cooldown*        | 为使自动缩放操作有时间生效，再次应用规则前需要等待的时间。 | 5 分钟       |\r \r 以下示例定义增加 VM 实例数的规则。 metricResourceUri 使用以前为订阅 ID、资源组名称和规模集名称定义的变量：\r \r ```json\r {\r   \"metricTrigger\": {\r     \"metricName\": \"Percentage CPU\",\r     \"metricNamespace\": \"\",\r     \"metricResourceUri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\",\r     \"metricResourceLocation\": \"'$location_name'\",\r     \"timeGrain\": \"PT1M\",\r     \"statistic\": \"Average\",\r     \"timeWindow\": \"PT10M\",\r     \"timeAggregation\": \"Average\",\r     \"operator\": \"GreaterThan\",\r     \"threshold\": 70\r   },\r   \"scaleAction\": {\r     \"direction\": \"Increase\",\r     \"type\": \"PercentChangeCount\",\r     \"value\": \"20\",\r     \"cooldown\": \"PT5M\"\r   }\r }\r ```\r \r \r ## <a name=\"create-a-rule-to-automatically-scale-in\"></a>创建规则，以便自动横向缩减\r 在夜间或周末，应用程序需求可能会降低。 如果这种负载降低在一段时间内持续稳定，可以配置自动缩放规则来减少规模集中的 VM 实例数。 这种横向缩减操作可以减少运行规模集所需的成本，因为只运行满足当前需求所需的实例数。\r \r 平均 CPU 负载小于 30% 持续了 10 多分钟时，请创建另一个规则减少规模集中的 VM 实例数。 以下示例定义增加 VM 实例数的规则。 metricResourceUri 使用以前为订阅 ID、资源组名称和规模集名称定义的变量：\r \r ```json\r {\r   \"metricTrigger\": {\r     \"metricName\": \"Percentage CPU\",\r     \"metricNamespace\": \"\",\r     \"metricResourceUri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\",\r     \"metricResourceLocation\": \"'$location_name'\",\r     \"timeGrain\": \"PT1M\",\r     \"statistic\": \"Average\",\r     \"timeWindow\": \"PT10M\",\r     \"timeAggregation\": \"Average\",\r     \"operator\": \"LessThan\",\r     \"threshold\": 30\r   },\r   \"scaleAction\": {\r     \"direction\": \"Decrease\",\r     \"type\": \"PercentChangeCount\",\r     \"value\": \"20\",\r     \"cooldown\": \"PT5M\"\r   }\r }\r ```\r \r \r ## <a name=\"apply-autoscale-rules-to-a-scale-set\"></a>将自动缩放规则应用于规模集\r 最后一步是将自动缩放配置文件和规则应用于规模集。 随后，规模集便能根据应用程序需求自动进行横向扩展或缩减。 按照如下所示，使用 [az monitor autoscale-settings create](/cli/monitor/autoscale-settings#az_monitor_autoscale_settings_create) 应用自动缩放配置文件。 完整的 JSON 使用的是先前提到的配置文件和规则。\r \r ```azurecli\r az monitor autoscale-settings create \\\r     --resource-group myResourceGroup \\\r     --name autoscale \\\r     --parameters '{\"autoscale_setting_resource_name\": \"autoscale\",\r       \"enabled\": true,\r       \"location\": \"'$location_name'\",\r       \"notifications\": [],\r       \"profiles\": [\r         {\r           \"name\": \"autoscale by percentage based on CPU usage\",\r           \"capacity\": {\r             \"minimum\": \"2\",\r             \"maximum\": \"10\",\r             \"default\": \"2\"\r           },\r           \"rules\": [\r             {\r               \"metricTrigger\": {\r                 \"metricName\": \"Percentage CPU\",\r                 \"metricNamespace\": \"\",\r                 \"metricResourceUri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\",\r                 \"metricResourceLocation\": \"'$location_name'\",\r                 \"timeGrain\": \"PT1M\",\r                 \"statistic\": \"Average\",\r                 \"timeWindow\": \"PT10M\",\r                 \"timeAggregation\": \"Average\",\r                 \"operator\": \"GreaterThan\",\r                 \"threshold\": 70\r               },\r               \"scaleAction\": {\r                 \"direction\": \"Increase\",\r                 \"type\": \"PercentChangeCount\",\r                 \"value\": \"20\",\r                 \"cooldown\": \"PT5M\"\r               }\r             },\r             {\r               \"metricTrigger\": {\r                 \"metricName\": \"Percentage CPU\",\r                 \"metricNamespace\": \"\",\r                 \"metricResourceUri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\",\r                 \"metricResourceLocation\": \"'$location_name'\",\r                 \"timeGrain\": \"PT1M\",\r                 \"statistic\": \"Average\",\r                 \"timeWindow\": \"PT10M\",\r                 \"timeAggregation\": \"Average\",\r                 \"operator\": \"LessThan\",\r                 \"threshold\": 30\r               },\r               \"scaleAction\": {\r                 \"direction\": \"Decrease\",\r                 \"type\": \"PercentChangeCount\",\r                 \"value\": \"20\",\r                 \"cooldown\": \"PT5M\"\r               }\r             }\r           ]\r         }\r       ],\r       \"tags\": {},\r       \"target_resource_uri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\"\r     }'\r ```\r \r \r ## <a name=\"monitor-number-of-instances-in-a-scale-set\"></a>监视规模集中的实例数\r 若要查看 VM 实例的数量与状态，使用 [az vmss list-instances](/cli/vmss#az_vmss_list_instances) 查看规模集中的实例列表。 状态指示是随规模集自动横向扩展而预配 VM 实例，还是随规模集自动横向缩减而取消预配 VM 实例。 以下示例查看 myResourceGroup 资源组中 myScaleSet 规模集的 VM 实例状态：\r \r ```azurecli\r az vmss list-instances \\\r   --resource-group myResourceGroup \\\r   --name myScaleSet \\\r   --output table\r ```\r \r \r ## <a name=\"autoscale-based-on-a-schedule\"></a>按计划自动缩放\r 前述示例通过 CPU 使用情况等基本主机指标自动横向扩展或缩减规模集。 还可以根据计划创建自动缩放规则。 通过这些基于计划的规则，可在应用程序需求按预期增加（如核心工作时间）之前自动增加 VM 实例数，在预期需求减少时（例如周末）自动减少实例数。\r \r 若要使用基于计划的自动缩放规则，请创建 JSON 配置文件，该文件定义 VM 实例数，以运行固定启动和结束时间窗口。 以下示例定义在每个工作日（星期一到星期五）上午 9 点将实例数增加到 10 的规则。\r \r ```json\r {\r   \"name\": \"Scale out during each work day\",\r   \"capacity\": {\r       \"minimum\": \"10\",\r       \"maximum\": \"10\",\r       \"default\": \"10\"\r   },\r   \"rules\": [],\r   \"recurrence\": {\r       \"frequency\": \"Week\",\r       \"schedule\": {\r           \"timeZone\": \"Pacific Standard Time\",\r           \"days\": [\r               \"Monday\",\r               \"Tuesday\",\r               \"Wednesday\",\r               \"Thursday\",\r               \"Friday\"\r           ],\r           \"hours\": [\r               9\r           ],\r           \"minutes\": [\r               0\r           ]\r       }\r   }\r }\r ```\r \r 若要在晚上缩小实例数，请另创建规则，指定较低的实例数和适当的启动时间。\r \r 以下完整示例定义一些规则，它们先横向扩展再横向缩减，然后通过 [az monitor autoscale-settings create](/cli/monitor/autoscale-settings#az_monitor_autoscale_settings_create) 应用自动缩放配置文件。 此示例将重写前述示例中创建的基于指标的自动缩放规则。 metricResourceUri 使用以前为订阅 ID、资源组名称和规模集名称定义的变量：\r \r ```azurecli\r az monitor autoscale-settings create \\\r     --resource-group myResourceGroup \\\r     --name autoscale \\\r     --parameters '{\"autoscale_setting_resource_name\": \"autoscale\",\r       \"enabled\": true,\r       \"location\": \"'$location_name'\",\r       \"notifications\": [],\r       \"profiles\": [\r         {\r           \"name\": \"Scale out during each work day\",\r           \"capacity\": {\r             \"minimum\": \"10\",\r             \"maximum\": \"10\",\r             \"default\": \"10\"\r           },\r           \"rules\": [],\r           \"recurrence\": {\r             \"frequency\": \"Week\",\r             \"schedule\": {\r               \"timeZone\": \"Pacific Standard Time\",\r               \"days\": [\r                 \"Monday\",\r                 \"Tuesday\",\r                 \"Wednesday\",\r                 \"Thursday\",\r                 \"Friday\"\r               ],\r               \"hours\": [\r                 9\r               ],\r               \"minutes\": [\r                 0\r               ]\r             }\r           }\r         },\r         {\r           \"name\": \"Scale in during the evening\",\r           \"capacity\": {\r             \"minimum\": \"3\",\r             \"maximum\": \"3\",\r             \"default\": \"3\"\r           },\r           \"rules\": [],\r           \"recurrence\": {\r             \"frequency\": \"Week\",\r             \"schedule\": {\r               \"timeZone\": \"Pacific Standard Time\",\r               \"days\": [\r                 \"Monday\",\r                 \"Tuesday\",\r                 \"Wednesday\",\r                 \"Thursday\",\r                 \"Friday\"\r               ],\r               \"hours\": [\r                 18\r               ],\r               \"minutes\": [\r                 0\r               ]\r             }\r           }\r         }\r       ],\r       \"tags\": {},\r       \"target_resource_uri\": \"/subscriptions/'$sub'/resourceGroups/'$resourcegroup_name'/providers/Microsoft.Compute/virtualMachineScaleSets/'$scaleset_name'\"\r     }'\r ```\r \r \r ## <a name=\"next-steps\"></a>后续步骤\r 本文详细介绍了如何使用自动缩放规则来进行横向缩放，即增加或减少规模集中的 VM 实例数。 还可进行纵向缩放，即增大或减小 VM 实例的大小。\r \r 有关如何管理 VM 实例的信息，请参阅[使用 Azure PowerShell 管理虚拟机规模集](virtual-machine-scale-sets-windows-manage.md)。\r \r "}