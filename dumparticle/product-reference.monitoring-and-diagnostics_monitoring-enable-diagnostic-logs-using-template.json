{"Title":"使用 Resource Manager 模板自动启用诊断设置","Description":"了解如何使用 Resource Manager 模板创建诊断设置，以便将诊断日志流式传输到事件中心，或者将其存储在存储帐户中。","Content":"# <a name=\"automatically-enable-diagnostic-settings-at-resource-creation-using-a-resource-manager-template\"></a>在创建资源时使用 Resource Manager 模板自动启用诊断设置\r 本文介绍如何使用 [Azure 资源管理器模板](../azure-resource-manager/resource-group-authoring-templates.md)在创建资源时配置资源的诊断设置。 这样可以让用户在创建资源时自动将诊断日志和指标流式传输到事件中心、将其存档在存储帐户中。\r \r 通过 Resource Manager 模板启用诊断日志时，所用方法取决于资源类型。\r \r * **非计算**资源（例如，网络安全组、自动化）使用[此文中描述的诊断设置](monitoring-overview-of-diagnostic-logs.md#resource-diagnostic-settings)。\r * **计算**（基于 WAD/LAD）资源使用[此文中描述的 WAD/LAD 配置文件](../vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines.md)。\r \r 本文介绍如何使用其中一种方法配置诊断。\r \r 基本步骤如下所示：\r \r 1. 以 JSON 文件格式创建一个模板，说明如何创建资源和启用诊断。\r 2. [使用任意部署方法部署模板](../azure-resource-manager/resource-group-template-deploy.md)。\r \r 下面是一个需为非计算资源和计算资源生成的模板 JSON 文件的示例。\r \r ## <a name=\"non-compute-resource-template\"></a>非计算资源模板\r 对于非计算资源，需要做两件事：\r \r 1. 根据存储帐户名称和服务总线规则 ID 向参数 blob 添加参数（允许在存储帐户中存档诊断日志、将日志流式传输到事件中心）。\r    \r     ```json\r     \"storageAccountName\": {\r       \"type\": \"string\",\r       \"metadata\": {\r         \"description\": \"Name of the Storage Account in which Diagnostic Logs should be saved.\"\r       }\r     },\r     \"serviceBusRuleId\": {\r       \"type\": \"string\",\r       \"metadata\": {\r         \"description\": \"Resource ID of the Service Bus Rule for the Service Bus Namespace in which the Event Hub should be created or streamed to.\"\r       }\r     },\r     \"workspaceId\":{\r       \"type\": \"string\",\r       \"metadata\": {\r         \"description\": \"Azure Resource ID  to which logs will be sent.\"\r       }\r     }\r     ```\r 2. 在资源数组（包含需启用诊断日志的资源）中，添加类型为 `[resource namespace]/providers/diagnosticSettings` 的资源。\r    \r     ```json\r     \"resources\": [\r       {\r         \"type\": \"providers/diagnosticSettings\",\r         \"name\": \"Microsoft.Insights/service\",\r         \"dependsOn\": [\r           \"[/*resource Id for which Diagnostic Logs will be enabled>*/]\"\r         ],\r         \"apiVersion\": \"2015-07-01\",\r         \"properties\": {\r           \"storageAccountId\": \"[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]\",\r           \"serviceBusRuleId\": \"[parameters('serviceBusRuleId')]\",\r           \"workspaceId\": \"[parameters('workspaceId')]\",\r           \"logs\": [ \r             {\r               \"category\": \"/* log category name */\",\r               \"enabled\": true,\r               \"retentionPolicy\": {\r                 \"days\": 0,\r                 \"enabled\": false\r               }\r             }\r           ],\r           \"metrics\": [\r             {\r               \"timeGrain\": \"PT1M\",\r               \"enabled\": true,\r               \"retentionPolicy\": {\r                 \"enabled\": false,\r                 \"days\": 0\r               }\r             }\r           ]\r         }\r       }\r     ]\r     ```\r \r 诊断设置的属性 blob 遵循[此文所述的格式](https://msdn.microsoft.com/library/azure/dn931931.aspx)。 添加 `metrics` 属性还可将资源指标发送到这些相同输出，前提是[该资源支持 Azure Monitor 指标](monitoring-supported-metrics.md)。\r \r \r ## <a name=\"compute-resource-template\"></a>计算资源模板\r 若要允许对计算资源（例如虚拟机或 Service Fabric 群集）进行诊断，需执行以下操作：\r \r 1. 将 Azure 诊断扩展添加到 VM 资源定义中。\r 2. 以参数形式指定存储帐户和/或事件中心。\r 3. 将 WADCfg XML 文件的内容添加到 XMLCfg 属性中，对所有 XML 字符进行适当的转义。\r \r > [!WARNING]\r > 这最后一步操作起来比较复杂。 请[参阅此文](../virtual-machines/windows/extensions-diagnostics-template.md#diagnostics-configuration-variables)获取相关示例，了解如何将诊断配置架构拆分成进行了正确转义和格式化操作的变量。\r > \r > \r \r 整个过程（包括示例）详见[此文档](../virtual-machines/windows/extensions-diagnostics-template.md?toc=%2fvirtual-machines%2fwindows%2ftoc.json)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r * [详细了解 Azure 诊断日志](monitoring-overview-of-diagnostic-logs.md)\r * [将 Azure 诊断日志流式传输到事件中心](monitoring-stream-diagnostic-logs-to-event-hubs.md)\r \r "}