{"Title":"使用虚拟硬盘创建 VM","Description":"Azure CLI 脚本示例 - 使用虚拟硬盘创建 VM。","Content":"# <a name=\"create-a-vm-with-a-virtual-hard-disk\"></a>使用虚拟硬盘创建 VM\r \r 本示例使用 VHD 创建虚拟机。\r 本示例创建资源组、存储帐户、容器，并通过将 VHD 上传到容器来创建 VM。\r 本示例将 ssh 公钥替换为用户的公钥，因此用户可以访问 VM。\r \r 用户需要可引导 VHD。\r 可以从 https://azclisamples.blob.core.chinacloudapi.cn/vhds/sample.vhd 下载我们所使用的 VHD，也可以使用自己的 VHD。 脚本会查找 `~/sample.vhd`。\r \r [!INCLUDE [sample-cli-install](../../../includes/sample-cli-install.md)]\r \r [!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]\r \r ## <a name=\"sample-script\"></a>示例脚本\r \r ```azurecli\r #!/bin/bash\r \r # Create a resource group\r az group create -n myResourceGroup -l chinanorth\r \r # Create the storage account to upload the vhd\r az storage account create -g myResourceGroup -n mystorageaccount -l chinanorth --sku PREMIUM_LRS\r \r # Get a storage key for the storage account\r STORAGE_KEY=$(az storage account keys list -g myResourceGroup -n mystorageaccount --query \"[?keyName=='key1'] | [0].value\" -o tsv)\r \r # Create the container for the vhd\r az storage container create -n vhds --account-name mystorageaccount --account-key ${STORAGE_KEY}\r \r # Upload the vhd to a blob\r az storage blob upload -c vhds -f ~/sample.vhd -n sample.vhd --account-name mystorageaccount --account-key ${STORAGE_KEY}\r \r # Create the vm from the vhd\r az vm create -g myResourceGroup -n myVM --image \"https://myStorageAccount.blob.core.chinacloudapi.cn/vhds/sample.vhd\" \\\r         --os-type linux --admin-username deploy --generate-ssh-keys\r \r # Update the deploy user with your ssh key\r az vm user update --resource-group myResourceGroup -n custom-vm -u deploy --ssh-key-value \"$(< ~/.ssh/id_rsa.pub)\"\r \r # Get public IP address for the VM\r IP_ADDRESS=$(az vm list-ip-addresses -g az-cli-vhd -n custom-vm \\\r     --query \"[0].virtualMachine.network.publicIpAddresses[0].ipAddress\" -o tsv)\r \r echo \"You can now connect using 'ssh deploy@${IP_ADDRESS}'\"\r ```\r \r ## <a name=\"clean-up-deployment\"></a>清理部署 \r \r 运行以下命令来删除资源组、VM 和所有相关资源。\r \r ```azurecli \r az group delete -n az-cli-vhd\r ```\r \r ## <a name=\"script-explanation\"></a>脚本说明\r \r 此脚本使用以下命令创建资源组、虚拟机、可用性集、负载均衡器和所有相关资源。 表中的每条命令均链接到特定于命令的文档。\r \r | 命令 | 说明 |\r |---|---|\r | [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#az_group_create) | 创建用于存储所有资源的资源组。 |\r | [az storage account list](https://docs.azure.cn/zh-cn/cli/storage/account?view=azure-cli-latest#az_storage_account_list) | 列出存储帐户 |\r | [az storage account check-name](https://docs.azure.cn/zh-cn/cli/storage/account?view=azure-cli-latest#az_storage_account_check_name) | 检查存储帐户名称是否有效且目前还不存在 |\r | [az storage account keys list](https://docs.azure.cn/zh-cn/cli/storage/account/keys?view=azure-cli-latest#az_storage_account_keys_list) | 列出存储帐户的密钥 |\r | [az storage blob exists](https://docs.azure.cn/zh-cn/cli/storage/blob?view=azure-cli-latest#az_storage_blob_exists) | 检查 Blob 是否存在 |\r | [az storage container create](https://docs.azure.cn/zh-cn/cli/storage/container?view=azure-cli-latest#az_storage_container_create) | 在存储帐户中创建一个容器。 |\r | [az storage blob upload](https://docs.azure.cn/zh-cn/cli/storage/blob?view=azure-cli-latest#az_storage_blob_upload) | 通过上传 VHD，在容器中创建一个 Blob。 |\r | [az vm list](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#az_vm_list) | 与 `--query` 一起使用，用于检查 VM 名称是否已使用。 | \r | [az vm create](https://docs.azure.cn/zh-cn/cli/vm/availability-set?view=azure-cli-latest#az_vm_availability_set_create) | 创建虚拟机。 |\r | [az vm access set-linux-user](https://docs.azure.cn/zh-cn/cli/vm/access?view=azure-cli-latest#az_vm_access_set_linux_user) | 重置 SSH 密钥，以便当前用户能够访问 VM。 |\r | [az vm list-ip-addresses](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#az_vm_list-ip-addresses) | 获取已创建虚拟机的 IP 地址。 |\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 Azure CLI 的详细信息，请参阅 [Azure CLI 文档](https://docs.azure.cn/zh-cn/cli/overview?view=azure-cli-latest)。\r \r 可以在 [Azure Linux VM 文档](../linux/cli-samples.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)中找到其他虚拟机 CLI 脚本示例。\r \r <!--Update_Description: update link-->"}