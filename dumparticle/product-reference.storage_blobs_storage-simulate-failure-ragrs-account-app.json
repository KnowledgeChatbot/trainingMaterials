{"Title":"模拟在 Azure 中访问读取访问冗余存储时出现的故障","Description":"模拟在访问读取访问异地冗余存储时出现的错误","Content":"# <a name=\"simulate-a-failure-in-accessing-read-access-redundant-storage\"></a>模拟在访问读取访问冗余存储时出现的故障\r \r 本教程是一个系列中的第二部分。 在本教程中，你需要将 Fiddler 对请求的故障响应注入[读取访问异地冗余](../common/storage-redundancy.md#read-access-geo-redundant-storage) (RA-GRS) 存储帐户，以便模拟一个故障，让应用程序从辅助终结点读取数据。\r \r ![方案应用](media/storage-simulate-failure-ragrs-account-app/scenario.png)\r \r 此系列的第二部分介绍如何：\r \r > [!div class=\"checklist\"]\r > * 运行和暂停应用程序\r > * 模拟故障\r > * 模拟主终结点还原\r \r ## <a name=\"prerequisites\"></a>先决条件\r \r 若要完成本教程，需执行以下操作：\r \r * 下载并安装 [Fiddler](https://www.telerik.com/download/fiddler)\r \r [!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]\r \r 完成本教程的前提是完成前面的存储教程：[使应用程序数据在 Azure 存储中高度可用][previous-tutorial]。\r \r ## <a name=\"launch-fiddler\"></a>启动 Fiddler\r \r 打开 Fiddler，选择“规则”和“自定义规则”。\r \r ![自定义 Fiddler 规则](media/storage-simulate-failure-ragrs-account-app/figure1.png)\r \r 此时会启动 Fiddler ScriptEditor，显示 SampleRules.js 文件。 此文件用于自定义 Fiddler。 将以下代码示例粘贴到 `OnBeforeResponse` 函数中。 注释掉新代码是为了确保其创建的逻辑不会立即实现。 完成后，选择“文件”和“保存”以保存所做的更改。\r \r ```javascript\r     /*\r         // Simulate data center failure\r         // After it is successfully downloading the blob, pause the code in the sample,\r         // uncomment these lines of script, and save the script.\r         // It will intercept the (probably successful) responses and send back a 503 error. \r         // When you're ready to stop sending back errors, comment these lines of script out again \r         //     and save the changes.\r \r         if ((oSession.hostname == \"contosoragrs.blob.core.chinacloudapi.cn\") \r             && (oSession.PathAndQuery.Contains(\"HelloWorld\"))) {\r             oSession.responseCode = 503;  \r         }\r     */\r ```\r \r ![粘贴自定义的规则](media/storage-simulate-failure-ragrs-account-app/figure2.png)\r \r ## <a name=\"start-and-pause-the-application\"></a>启动和暂停应用程序\r \r 在 Visual Studio 中，按 F5 或选择“开始”即可开始调试应用程序。 应用程序开始从主终结点读取数据以后，按控制台窗口中的任意键即可暂停应用程序。\r \r ## <a name=\"simulate-failure\"></a>模拟故障\r \r 暂停应用程序以后，即可取消注释在前面的步骤中在 Fiddler 中保存的自定义规则。 此代码示例查找对 RA-GRS 存储帐户的请求。如果路径包含图像的名称 `HelloWorld`，则会返回响应代码 `503 - Service Unavailable`。\r \r 导航到 Fiddler，然后选择“规则” -> “自定义规则...”。取消注释以下行，将 `STORAGEACCOUNTNAME` 替换为你的存储帐户的名称。 选择“文件” -> “保存”，保存所做的更改。\r \r ```javascript\r          if ((oSession.hostname == \"STORAGEACCOUNTNAME.blob.core.chinacloudapi.cn\")\r          && (oSession.PathAndQuery.Contains(\"HelloWorld\"))) {\r          oSession.responseCode = 503;\r          }\r ```\r \r 若要恢复应用程序，请按任意键。\r \r 应用程序重新开始运行以后，对主终结点的请求就会失败。 应用程序尝试重新连接到主终结点 5 次。 达到故障阈值（五次尝试）以后，就会从处于只读状态的辅助终结点请求图像。 成功地从辅助终结点检索图像 20 次以后，应用程序就会尝试连接到主终结点。 如果仍无法访问主终结点，应用程序会继续从辅助终结点读取数据。 此模式为[断路器](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker)模式，在前一教程中已介绍过。\r \r ![粘贴自定义的规则](media/storage-simulate-failure-ragrs-account-app/figure3.png)\r \r ## <a name=\"simulate-primary-endpoint-restoration\"></a>模拟主终结点还原\r \r 由于在前面的步骤中已设置 Fiddler 自定义规则，因此对主终结点的请求失败。 若要模拟主终结点再次运行的情况，请删除用于注入 `503` 错误的逻辑。\r \r 若要暂停应用程序，请按任意键。\r \r ### <a name=\"remove-the-custom-rule\"></a>删除自定义规则\r \r 导航到 Fiddler，然后选择“规则”和“自定义规则...”。注释或删除 `OnBeforeResponse` 函数中的自定义逻辑，保留默认函数。 选择“文件”和“保存”，保存所做的更改。\r \r ![删除自定义的规则](media/storage-simulate-failure-ragrs-account-app/figure5.png)\r \r 完成后，按任意键即可恢复应用程序。 应用程序继续从主终结点读取数据，直到达到 999 次读取的限制。\r \r ![恢复应用程序](media/storage-simulate-failure-ragrs-account-app/figure4.png)\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 此系列的第二部分介绍了如何模拟一个故障，以便测试读取访问异地冗余存储，例如，如何：\r \r > [!div class=\"checklist\"]\r > * 运行和暂停应用程序\r > * 模拟故障\r > * 模拟主终结点还原\r \r 请访问以下链接，查看预先生成的存储示例。\r \r > [!div class=\"nextstepaction\"]\r > [Azure 存储脚本示例](storage-samples-blobs-cli.md)\r \r [previous-tutorial]: storage-create-geo-redundant-storage.md"}