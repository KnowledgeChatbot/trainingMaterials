{"Title":"Azure Active Directory 基于证书的身份验证 - 入门","Description":"了解如何在环境中配置基于证书的身份验证","Content":"# <a name=\"get-started-with-certificate-based-authentication-in-azure-active-directory\"></a>Azure Active Directory 中基于证书的身份验证入门\r \r 如果使用基于证书的身份验证，则在 Windows、Android 或 iOS 设备上将 Exchange Online 帐户连接到以下对象时，可通过 Azure Active Directory 使用客户端证书进行身份验证：\r \r - Microsoft 移动应用程序，例如 Microsoft Outlook 和 Microsoft Word   \r \r - Exchange ActiveSync (EAS) 客户端\r \r 如果配置了此功能，就无需在移动设备上的某些邮件和 Microsoft Office 应用程序中输入用户名和密码组合。\r \r 本主题：\r \r - 提供的步骤介绍如何为 Office 365 企业版、商业版、教育版和美国政府版计划中租户的用户配置并使用基于证书的身份验证。 此功能在 Office 365 中国版、美国国防部版、美国联邦政府版计划中以预览版形式提供。\r \r - 假设已配置[公钥基础结构 (PKI)](https://go.microsoft.com/fwlink/?linkid=841737) 和 [AD FS](connect/active-directory-aadconnectfed-whatis.md)。    \r \r \r ## <a name=\"requirements\"></a>要求\r \r 若要配置基于证书的身份验证，必须满足以下条件：  \r \r - 仅使用新式身份验证 (ADAL) 的浏览器应用程序或本机客户端的联合环境支持基于证书的身份验证 (CBA)。 Exchange Active Sync (EAS) for EXO 除外，它可用于联合帐户和托管帐户这两者。\r \r - 必须在 Azure Active Directory 中配置根证书颁发机构和任何中间证书颁发机构。  \r \r - 每个证书颁发机构必须有一个可通过面向 Internet 的 URL 引用的证书吊销列表 (CRL)。  \r \r - 必须已在 Azure Active Directory 中至少配置一个证书颁发机构。 可以在 [配置证书颁发机构](#step-2-configure-the-certificate-authorities) 部分查找相关步骤。  \r \r - 对于 Exchange ActiveSync 客户端，客户端证书的“使用者可选名称”字段的主体名称或 RFC822 名称值必须为 Exchange Online 中用户的可路由电子邮件地址。 Azure Active Directory 会将 RFC822 值映射到目录中的“代理地址”属性。  \r \r - 客户端设备必须能够访问至少一个颁发客户端证书的证书颁发机构。  \r \r - 必须已向客户端颁发用于客户端身份验证的客户端证书。  \r \r \r \r \r ## <a name=\"step-1-select-your-device-platform\"></a>步骤 1：选择设备平台\r \r 第一步，用户需针对所关注的设备平台查看以下内容：\r \r - Office 移动应用程序支持\r - 特定的实现要求  \r \r 存在以下设备平台的相关信息：\r \r - [Android](active-directory-certificate-based-authentication-android.md)\r - [iOS](active-directory-certificate-based-authentication-ios.md)\r \r \r ## <a name=\"step-2-configure-the-certificate-authorities\"></a>步骤 2：配置证书颁发机构\r \r 若要在 Azure Active Directory 中配置证书颁发机构，请为每个证书颁发机构上传以下内容：\r \r - 证书的公共部分，格式为 *.cer*\r - 证书吊销列表 (CRL) 所在的面向 Internet 的 URL\r \r 证书颁发机构的架构如下所示：\r \r     class TrustedCAsForPasswordlessAuth\r     {\r        CertificateAuthorityInformation[] certificateAuthorities;    \r     }\r \r     class CertificateAuthorityInformation\r \r     {\r         CertAuthorityType authorityType;\r         X509Certificate trustedCertificate;\r         string crlDistributionPoint;\r         string deltaCrlDistributionPoint;\r         string trustedIssuer;\r         string trustedIssuerSKI;\r     }                \r \r     enum CertAuthorityType\r     {\r         RootAuthority = 0,\r         IntermediateAuthority = 1\r     }\r \r 对于此配置，可以使用 [Azure Active Directory PowerShell 版本 2](https://docs.microsoft.com/powershell/azure/install-adv2?view=azureadps-2.0/)：  \r \r 1. 使用管理员特权启动 Windows PowerShell。\r 2. 安装 Azure AD 模块。 需要安装版本 [2.0.0.33](https://www.powershellgallery.com/packages/AzureAD/2.0.0.33) 或更高版本。  \r \r         Install-Module -Name AzureAD -RequiredVersion 2.0.0.33\r \r 作为第一个配置步骤，需建立与租户的连接。 建立到租户的连接以后，即可查看、添加、删除和修改在目录中定义的可信证书颁发机构。\r \r ### <a name=\"connect\"></a>连接\r \r 若要建立与租户的连接，请使用 [Connect-AzureAD](https://docs.microsoft.com/powershell/module/azuread/connect-azuread?view=azureadps-2.0) cmdlet：\r \r     Connect-AzureAD\r \r \r ### <a name=\"retrieve\"></a>检索\r \r 若要检索目录中定义的受信任的证书颁发机构，请使用 [Get-AzureADTrustedCertificateAuthority](https://docs.microsoft.com/powershell/module/azuread/get-azureadtrustedcertificateauthority?view=azureadps-2.0) cmdlet。\r \r     Get-AzureADTrustedCertificateAuthority\r \r \r ### <a name=\"add\"></a>添加\r \r 若要创建受信任的证书颁发机构，请使用 [New-AzureADTrustedCertificateAuthority](https://docs.microsoft.com/powershell/module/azuread/new-azureadtrustedcertificateauthority?view=azureadps-2.0) cmdlet，并将 **crlDistributionPoint** 属性设为正确的值：\r \r     $cert=Get-Content -Encoding byte \"[LOCATION OF THE CER FILE]\"\r     $new_ca=New-Object -TypeName Microsoft.Open.AzureAD.Model.CertificateAuthorityInformation\r     $new_ca.AuthorityType=0\r     $new_ca.TrustedCertificate=$cert\r     $new_ca.crlDistributionPoint=”<CRL Distribution URL>”\r     New-AzureADTrustedCertificateAuthority -CertificateAuthorityInformation $new_ca\r \r \r ### <a name=\"remove\"></a>删除\r \r 若要删除受信任的证书颁发机构，请使用 [Remove-AzureADTrustedCertificateAuthority](https://docs.microsoft.com/powershell/module/azuread/remove-azureadtrustedcertificateauthority?view=azureadps-2.0) cmdlet：\r \r     $c=Get-AzureADTrustedCertificateAuthority\r     Remove-AzureADTrustedCertificateAuthority -CertificateAuthorityInformation $c[2]\r \r \r ### <a name=\"modfiy\"></a>修改\r \r 若要修改受信任的证书颁发机构，请使用 [Set-AzureADTrustedCertificateAuthority](https://docs.microsoft.com/powershell/module/azuread/set-azureadtrustedcertificateauthority?view=azureadps-2.0) cmdlet：\r \r     $c=Get-AzureADTrustedCertificateAuthority\r     $c[0].AuthorityType=1\r     Set-AzureADTrustedCertificateAuthority -CertificateAuthorityInformation $c[0]\r \r \r ## <a name=\"step-3-configure-revocation\"></a>步骤 3：配置吊销\r \r 若要吊销客户端证书，Azure Active Directory 会从作为证书颁发机构信息的一部分上传的 URL 中提取证书吊销列表 (CRL)，并将其缓存。 CRL 中的上次发布时间戳（“生效日期”属性）用于确保 CRL 仍然有效。 将定期引用 CRL，以撤销对该列表中证书的访问权限。\r \r 如果需要更即时的吊销（例如，如果用户丢失了设备），可以使用户的授权令牌失效。 若要使授权令牌失效，请使用 Windows PowerShell 为此特定用户设置 **StsRefreshTokenValidFrom** 字段。 必须为要撤销其访问权限的每个用户更新 **StsRefreshTokenValidFrom** 字段。\r \r 若要确保撤销仍然有效，必须将 CRL 的**生效日期**设置为晚于 **StsRefreshTokenValidFrom** 所设置的值，并确保相关的证书在 CRL 中。\r \r 以下步骤概述了通过设置 **StsRefreshTokenValidFrom** 字段更新授权令牌并使其失效的过程。\r \r **若要配置吊销，请执行以下操作：**\r \r 1. 使用管理员凭据连接到 MSOL 服务：\r \r         $msolcred = get-credential\r         connect-msolservice -credential $msolcred\r \r 2. 检索用户的当前 StsRefreshTokensValidFrom 值：\r \r         $user = Get-MsolUser -UserPrincipalName test@yourdomain.com`\r         $user.StsRefreshTokensValidFrom\r \r 3. 将用户的新 StsRefreshTokensValidFrom 值配置为等于当前时间戳：\r \r         Set-MsolUser -UserPrincipalName test@yourdomain.com -StsRefreshTokensValidFrom (\"03/05/2016\")\r \r 所设日期必须属于将来。 如果日期不属于将来，则不会设置 **StsRefreshTokensValidFrom** 属性。 如果日期属于将来，则将 **StsRefreshTokensValidFrom** 设置为当前时间（而不是由 Set-MsolUser 命令指示的日期）。\r \r \r ## <a name=\"step-4-test-your-configuration\"></a>步骤 4：测试配置\r \r ### <a name=\"testing-your-certificate\"></a>测试证书\r \r 作为第一个配置测试，应尝试使用**设备上的浏览器**登录 [Outlook Web Access](https://outlook.office365.com) 或 [SharePoint Online](https://microsoft.sharepoint.com)。\r \r 如果登录成功，则可确定：\r \r - 已为测试设备预配用户证书\r - 已正确配置 AD FS  \r \r \r ### <a name=\"testing-office-mobile-applications\"></a>测试 Office 移动应用程序\r \r **若要在 Office 移动应用程序上测试基于证书的身份验证，请执行以下操作：**\r \r 1. 在测试设备上，安装 Office 移动应用程序（例如 OneDrive）。\r 3. 启动应用程序。\r 4. 输入用户名，并选择要使用的用户证书。\r \r 应可以成功登录。\r \r ### <a name=\"testing-exchange-activesync-client-applications\"></a>测试 Exchange ActiveSync 客户端应用程序\r \r 若要通过基于证书的身份验证访问 Exchange ActiveSync (EAS)，必须为应用程序提供包含客户端证书的 EAS 配置文件。\r \r EAS 配置文件必须包含以下信息：\r \r - 用于身份验证的用户证书\r \r - EAS 终结点（例如 outlook.office365.com）\r \r 若要配置 EAS 配置文件并将其放置在设备上，可以使用移动设备管理 (MDM)，例如 Intune，也可以手动将 EAS 配置文件中的证书放置在设备上。  \r \r ### <a name=\"testing-eas-client-applications-on-android\"></a>在 Android 上测试 EAS 客户端应用程序\r \r **若要测试证书身份验证，请执行以下操作：**  \r \r 1. 在应用程序中配置满足上述要求的 EAS 配置文件。  \r 2. 打开应用程序，验证邮件是否正在同步。\r \r <!--Update_Description: wording update -->\r "}