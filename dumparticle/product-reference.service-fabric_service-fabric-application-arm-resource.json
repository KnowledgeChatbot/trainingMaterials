{"Title":"使用 Azure 资源管理器部署和升级应用程序及服务","Description":"了解如何使用 Azure 资源管理器模板，将应用程序和服务部署到 Service Fabric 群集。","Content":"# <a name=\"manage-applications-and-services-as-azure-resource-manager-resources\"></a>将应用程序和服务作为 Azure 资源管理器资源进行管理\r \r 可以通过 Azure 资源管理器，将应用程序和服务部署到 Service Fabric 群集。 也就是说，现在可以使用 JSON 表示应用程序和服务，并在群集使用的同一个资源管理器模板中部署它们，而不用被迫等待群集就绪，然后再通过 PowerShell 或 CLI 部署和管理应用程序。 只需执行一步操作，即可完成注册、预配和部署应用程序的整个过程。\r \r 这是部署群集所需的任意安装应用程序、治理应用程序或群集管理应用程序的推荐方法。 其中包括[修补业务流程应用程序](service-fabric-patch-orchestration-application.md)、监视程序，或部署其他应用程序/服务前群集需要运行的任何应用程序。 \r \r 在适当情况下，将应用程序作为资源管理器资源进行管理可改进：\r * 审核线索：资源管理器审核所有操作，并记录详细的活动日志，有助于跟踪对这些应用程序和群集做出的任何更改。\r * 基于角色的访问控制 (RBAC)：可通过同一个资源管理器模板，管理对群集及其上部署的应用程序的访问。\r * Azure 资源管理器（通过 Azure 门户）成为管理群集和关键应用程序部署的一站式平台。\r \r 下面的代码片段展示了可以通过模板管理的各种资源：\r \r ```json\r {\r     \"apiVersion\": \"2017-07-01-preview\",\r     \"type\": \"Microsoft.ServiceFabric/clusters/applicationTypes\",\r     \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationTypeName'))]\",\r     \"location\": \"[variables('clusterLocation')]\",\r },\r {\r     \"apiVersion\": \"2017-07-01-preview\",\r     \"type\": \"Microsoft.ServiceFabric/clusters/applicationTypes/versions\",\r     \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationTypeName'), '/', parameters('applicationTypeVersion'))]\",\r     \"location\": \"[variables('clusterLocation')]\",\r },\r {\r     \"apiVersion\": \"2017-07-01-preview\",\r     \"type\": \"Microsoft.ServiceFabric/clusters/applications\",\r     \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationName'))]\",\r     \"location\": \"[variables('clusterLocation')]\",\r },\r {\r     \"apiVersion\": \"2017-07-01-preview\",\r     \"type\": \"Microsoft.ServiceFabric/clusters/applications/services\",\r     \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationName'), '/', parameters('serviceName'))]\",\r     \"location\": \"[variables('clusterLocation')]\"\r }\r ```\r \r ## <a name=\"add-a-new-application-to-your-resource-manager-template\"></a>将新应用程序添加到资源管理器模板\r \r 1. 准备群集的资源管理器模板，以供部署时使用。 若要详细了解如何执行此操作，请参阅[使用 Azure 资源管理器创建 Service Fabric 群集](service-fabric-cluster-creation-via-arm.md)。\r 2. 考虑一下，打算在群集中部署的一些应用程序。 是否有始终要运行的被其他应用程序依赖的应用程序？ 是否计划部署任何群集治理应用程序或安装应用程序？ 如上所述，此类应用程序最好是通过资源管理器模板进行管理。 \r 3. 确定要使用此方法部署的应用程序后，需要立即打包、压缩这些应用程序，并将它们上传到文件共享。 此共享必须可通过 REST 终结点进行访问，这样 Azure 资源管理器才能在部署期间使用它。\r 4. 在资源管理器模板中的群集声明下，描述每个应用程序的属性。 这些属性包括副本或实例计数，以及资源（其他应用程序或服务）之间的任何依赖链。 有关完整属性列表，请参阅 [REST API Swagger 规范](https://github.com/Azure/azure-rest-api-specs/blob/current/specification/servicefabric/resource-manager/Microsoft.ServiceFabric/2017-07-01-preview/servicefabric.json)。请注意，这不会取代应用程序或服务清单，只是在群集的资源管理器模板中描述了清单的部分内容。 下面展示了示例模板，包括在 Application1 中部署无状态服务 Service1 和有状态服务 Service2：\r \r   ```json\r   {\r     \"$schema\": \"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json\",\r     \"contentVersion\": \"1.0.0.0\",\r     \"parameters\": {\r       \"clusterName\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Cluster\",\r         \"metadata\": {\r           \"description\": \"Name of your cluster - Between 3 and 23 characters. Letters and numbers only\"\r         }\r       },\r       \"applicationTypeName\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"ApplicationType\",\r         \"metadata\": {\r           \"description\": \"The application type name\"\r         }\r       },\r       \"applicationTypeVersion\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"1\",\r         \"metadata\": {\r           \"description\": \"The application type version\"\r         }\r       },\r       \"appPackageUrl\": {\r         \"type\": \"string\",\r         \"metadata\": {\r           \"description\": \"The URL to the application package sfpkg file\"\r         }\r       },\r       \"applicationName\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Application1\",\r         \"metadata\": {\r           \"description\": \"The application name\"\r         }\r       },\r       \"serviceName\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Service1\",\r         \"metadata\": {\r           \"description\": \"The service name\"\r         }\r       },\r       \"serviceTypeName\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Service1Type\",\r         \"metadata\": {\r           \"description\": \"The service type name\"\r         }\r       },\r       \"serviceName2\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Service2\",\r         \"metadata\": {\r           \"description\": \"The service name\"\r         }\r       },\r       \"serviceTypeName2\": {\r         \"type\": \"string\",\r         \"defaultValue\": \"Service2Type\",\r         \"metadata\": {\r           \"description\": \"The service type name\"\r         }\r       }\r     },\r     \"variables\": {\r       \"clusterLocation\": \"[resourcegroup().location]\"\r     },\r     \"resources\": [\r       {\r         \"apiVersion\": \"2017-07-01-preview\",\r         \"type\": \"Microsoft.ServiceFabric/clusters/applicationTypes\",\r         \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationTypeName'))]\",\r         \"location\": \"[variables('clusterLocation')]\",\r         \"dependsOn\": [],\r         \"properties\": {\r           \"provisioningState\": \"Default\"\r         }\r       },\r       {\r         \"apiVersion\": \"2017-07-01-preview\",\r         \"type\": \"Microsoft.ServiceFabric/clusters/applicationTypes/versions\",\r         \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationTypeName'), '/', parameters('applicationTypeVersion'))]\",\r         \"location\": \"[variables('clusterLocation')]\",\r         \"dependsOn\": [\r           \"[concat('Microsoft.ServiceFabric/clusters/', parameters('clusterName'), '/applicationTypes/', parameters('applicationTypeName'))]\"\r         ],\r         \"properties\": {\r           \"provisioningState\": \"Default\",\r           \"appPackageUrl\": \"[parameters('appPackageUrl')]\"\r         }\r       },\r       {\r         \"apiVersion\": \"2017-07-01-preview\",\r         \"type\": \"Microsoft.ServiceFabric/clusters/applications\",\r         \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationName'))]\",\r         \"location\": \"[variables('clusterLocation')]\",\r         \"dependsOn\": [\r           \"[concat('Microsoft.ServiceFabric/clusters/', parameters('clusterName'), '/applicationTypes/', parameters('applicationTypeName'), '/versions/', parameters('applicationTypeVersion'))]\"\r         ],\r         \"properties\": {\r           \"provisioningState\": \"Default\",\r           \"typeName\": \"[parameters('applicationTypeName')]\",\r           \"typeVersion\": \"[parameters('applicationTypeVersion')]\",\r           \"parameters\": {},\r           \"upgradePolicy\": {\r             \"upgradeReplicaSetCheckTimeout\": \"01:00:00.0\",\r             \"forceRestart\": \"false\",\r             \"rollingUpgradeMonitoringPolicy\": {\r               \"healthCheckWaitDuration\": \"00:02:00.0\",\r               \"healthCheckStableDuration\": \"00:05:00.0\",\r               \"healthCheckRetryTimeout\": \"00:10:00.0\",\r               \"upgradeTimeout\": \"01:00:00.0\",\r               \"upgradeDomainTimeout\": \"00:20:00.0\"\r             },\r             \"applicationHealthPolicy\": {\r               \"considerWarningAsError\": \"false\",\r               \"maxPercentUnhealthyDeployedApplications\": \"50\",\r               \"defaultServiceTypeHealthPolicy\": {\r                 \"maxPercentUnhealthyServices\": \"50\",\r                 \"maxPercentUnhealthyPartitionsPerService\": \"50\",\r                 \"maxPercentUnhealthyReplicasPerPartition\": \"50\"\r               }\r             }\r           }\r         }\r       },\r       {\r         \"apiVersion\": \"2017-07-01-preview\",\r         \"type\": \"Microsoft.ServiceFabric/clusters/applications/services\",\r         \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationName'), '/', parameters('serviceName'))]\",\r         \"location\": \"[variables('clusterLocation')]\",\r         \"dependsOn\": [\r           \"[concat('Microsoft.ServiceFabric/clusters/', parameters('clusterName'), '/applications/', parameters('applicationName'))]\"\r         ],\r         \"properties\": {\r           \"provisioningState\": \"Default\",\r           \"serviceKind\": \"Stateless\",\r           \"serviceTypeName\": \"[parameters('serviceTypeName')]\",\r           \"instanceCount\": \"-1\",\r           \"partitionDescription\": {\r             \"partitionScheme\": \"Singleton\"\r           },\r           \"correlationScheme\": [],\r           \"serviceLoadMetrics\": [],\r           \"servicePlacementPolicies\": []\r         }\r       },\r       {\r         \"apiVersion\": \"2017-07-01-preview\",\r         \"type\": \"Microsoft.ServiceFabric/clusters/applications/services\",\r         \"name\": \"[concat(parameters('clusterName'), '/', parameters('applicationName'), '/', parameters('serviceName2'))]\",\r         \"location\": \"[variables('clusterLocation')]\",\r         \"dependsOn\": [\r           \"[concat('Microsoft.ServiceFabric/clusters/', parameters('clusterName'), '/applications/', parameters('applicationName'))]\"\r         ],\r         \"properties\": {\r           \"provisioningState\": \"Default\",\r           \"serviceKind\": \"Stateful\",\r           \"serviceTypeName\": \"[parameters('serviceTypeName2')]\",\r           \"targetReplicaSetSize\": \"3\",\r           \"minReplicaSetSize\": \"2\",\r           \"replicaRestartWaitDuration\": \"00:01:00.0\",\r           \"quorumLossWaitDuration\": \"00:02:00.0\",\r           \"standByReplicaKeepDuration\": \"00:00:30.0\",\r           \"partitionDescription\": {\r             \"partitionScheme\": \"UniformInt64Range\",\r             \"count\": \"5\",\r             \"lowKey\": \"1\",\r             \"highKey\": \"5\"\r           },\r           \"hasPersistedState\": \"true\",\r           \"correlationScheme\": [],\r           \"serviceLoadMetrics\": [],\r           \"servicePlacementPolicies\": [],\r           \"defaultMoveCost\": \"Low\"\r         }\r       }\r     ]\r   }\r   ```\r \r   > [!NOTE] \r   > 必须将 apiVersion 设置为 `\"2017-07-01-preview\"`。 部署的此模板也可以与群集互不影响，只要群集已部署即可。\r \r 5. 部署！ \r \r ## <a name=\"manage-an-existing-application-via-resource-manager\"></a>通过资源管理器管理现有应用程序\r \r 如果群集已部署，且其上已部署一些要作为资源管理器资源进行管理的应用程序，可以使用相同的 API，将这些应用程序确定为资源管理器资源，从而执行 PUT 调用，而不用删除并重新部署应用程序。 \r \r ## <a name=\"next-steps\"></a>后续步骤\r \r * 使用 [Service Fabric CLI](service-fabric-cli.md) 或 [PowerShell](service-fabric-deploy-remove-applications.md)，将其他应用程序部署到群集。 \r * [升级 Service Fabric 群集](service-fabric-cluster-upgrade.md)\r \r <!--Update_Description: add resource and depend on object of Microsoft.ServiceFabric/clusters in json template -->"}