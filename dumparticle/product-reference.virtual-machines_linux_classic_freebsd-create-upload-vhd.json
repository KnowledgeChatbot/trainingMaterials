{"Title":"创建 FreeBSD VHD 并将其上传到 Azure","Description":"了解如何创建和上传包含 FreeBSD 操作系统的虚拟硬盘 (VHD) 以创建 Azure 虚拟机。","Content":"# <a name=\"create-and-upload-a-freebsd-vhd-to-azure\"></a>创建 FreeBSD VHD 并将其上传到 Azure\r 本文说明如何创建和上传包含 FreeBSD 操作系统的虚拟硬盘 (VHD)。 将其上传后，可以使用它作为自己的映像在 Azure 中创建虚拟机 (VM)。\r \r > [!IMPORTANT] \r > Azure 提供两个不同的部署模型用于创建和处理资源：[Resource Manager 和经典模型](../../../resource-manager-deployment-model.md)。 本文介绍如何使用经典部署模型。 Azure 建议大多数新部署使用 Resource Manager 模型。 有关使用 Resource Manager 模型上传 VHD 的信息，请参阅[此文](../upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。\r \r ## <a name=\"prerequisites\"></a>先决条件\r 本文假设拥有以下项目：\r \r * **Azure 订阅** - 如果没有帐户，只需几分钟即可创建一个。 请参阅 [Visual Studio 订户的 Azure 信用额度](https://www.azure.cn/support/legal/offer-rate-plans/)。 了解如何[创建试用帐户](https://www.azure.cn/pricing/1rmb-trial/)。  \r * **Azure PowerShell 工具** - 必须安装 Azure PowerShell 模块并将其配置为使用你的 Azure 订阅。 若要下载该模块，请参阅 [Azure 下载](https://www.azure.cn/downloads/)。 可在此处获取介绍如何安装和配置该模块的教程。 使用 [Azure 下载](https://www.azure.cn/downloads/) cmdlet 上传 VHD。\r * **安装在 .vhd 文件中的 FreeBSD 操作系统** - 必须将受支持的 FreeBSD 操作系统安装到虚拟硬盘中。 可使用多个工具创建 .vhd 文件。 例如，可使用 Hyper-V 等虚拟化解决方案创建 .vhd 文件并安装操作系统。 有关如何安装和使用 Hyper-V 的说明，请参阅[安装 Hyper-V 和创建虚拟机](http://technet.microsoft.com/library/hh846766.aspx)。\r \r > [!NOTE]\r > Azure 不支持更新的 VHDX 格式。 可使用 Hyper-V 管理器或 [convert-vhd](https://technet.microsoft.com/library/hh848454.aspx) cmdlet 将磁盘转换为 VHD 格式。 此外，MSDN 上还有[有关如何将 FreeBSD 与 Hyper-V 配合使用的教程](http://blogs.msdn.com/b/kylie/archive/2014/12/25/running-freebsd-on-hyper-v.aspx)。\r >\r >\r \r 此任务包括以下四个步骤：\r \r ## <a name=\"step-1-prepare-the-image-for-upload\"></a>步骤 1：准备要上传的映像\r 在安装了 FreeBSD 操作系统的虚拟机中，完成以下过程：\r \r 1. 启用 DHCP。\r \r         # echo 'ifconfig_hn0=\"SYNCDHCP\"' >> /etc/rc.conf\r         # service netif restart\r 2. 启用 SSH。\r \r     请确保已安装 SSH 服务器且已将其配置为在引导时启动。 从 FreeBSD 光盘安装后，将默认启用它。 \r 3. 设置串行控制台。\r \r         # echo 'console=\"comconsole vidconsole\"' >> /boot/loader.conf\r         # echo 'comconsole_speed=\"115200\"' >> /boot/loader.conf\r 4. 安装 sudo。\r \r     在 Azure 中禁用根帐户。 这意味着你需要通过无特权用户利用 sudo 使用提升的权限运行命令。\r \r         # pkg install sudo\r \r 5. Azure 代理的先决条件。\r \r         # pkg install python27  \r         # pkg install Py27-setuptools  \r         # ln -s /usr/local/bin/python2.7 /usr/bin/python   \r         # pkg install git\r 6. 安装 Azure 代理。\r \r     始终可以在 [github](https://github.com/Azure/WALinuxAgent/releases) 上找到 Azure 代理的最新版本。 2.0.10 + 版正式支持 FreeBSD 10 和 10.1，2.1.4 + 版（包括 2.2.x）正式支持 FreeBSD 10.2 和更高版本。\r \r         # git clone https://github.com/Azure/WALinuxAgent.git  \r         # cd WALinuxAgent  \r         # git tag  \r         …\r         WALinuxAgent-2.0.16\r         …\r         v2.1.4\r         v2.1.4.rc0\r         v2.1.4.rc1\r \r     对于 2.0，让我们使用 2.0.16 作为示例：\r \r         # git checkout WALinuxAgent-2.0.16\r         # python setup.py install  \r         # ln -sf /usr/local/sbin/waagent /usr/sbin/waagent  \r \r     对于 2.1，让我们使用 2.1.4 作为示例：\r \r         # git checkout v2.1.4\r         # python setup.py install  \r         # ln -sf /usr/local/sbin/waagent /usr/sbin/waagent  \r         # ln -sf /usr/local/sbin/waagent2.0 /usr/sbin/waagent2.0\r \r    > [!IMPORTANT]\r    > 安装 Azure 代理之后，验证它是否正在运行是一个好主意：\r    >\r    >\r \r         # waagent -version\r         WALinuxAgent-2.1.4 running on freebsd 10.3\r         Python: 2.7.11\r         # ps auxw | grep waagent\r         root   639   0.0  0.5 104620 17520 u0- I    05:17    0:00.20 python /usr/local/sbin/waagent -daemon (python2.7)\r         # cat /var/log/waagent.log\r 7. 取消预配系统。\r \r     取消预配系统以清除系统并使其适用于重新预配。 以下命令还会删除上次预配的用户帐户和关联数据：\r \r         # echo \"y\" |  /usr/local/sbin/waagent -deprovision+user  \r         # echo  'waagent_enable=\"YES\"' >> /etc/rc.conf\r \r     现在可以关闭 VM。\r \r ## <a name=\"step-2-prepare-the-connection-to-azure\"></a>步骤 2：准备连接到 Azure\r 请确保在经典部署模型中使用 Azure CLI (`azure config mode asm`)，然后登录帐户：\r \r ```azurecli\r azure login -e AzureChinaCloud\r ```\r \r <a id=\"upload\"> </a>\r \r ## <a name=\"step-3-upload-the-vhd-file\"></a>步骤 3：上传 .vhd 文件\r \r 需要一个存储帐户，以便向其上传 VHD 文件。 可以选取现有存储帐户，也可以[创建新的存储帐户](../../../storage/common/storage-create-storage-account.md)。\r \r 在上传 .vhd 文件时，可以将该文件放置在 Blob 存储中的任何位置。 以下是上传该文件时将使用的一些术语：\r \r * **BlobStorageURL** 是在步骤 2 中创建的存储帐户的 URL。\r * **YourImagesFolder** 是 Blob 存储中用于存储映像的容器\r * **VHDName** 是显示在 Azure 经典管理门户中用于标识虚拟硬盘的标签。\r * **PathToVHDFile** 是 .vhd 文件的完整路径和名称。\r \r 从你在上一步中使用的 Azure PowerShell 窗口中，键入：\r \r         Add-AzureVhd -Destination \"<BlobStorageURL>/<YourImagesFolder>/<VHDName>.vhd\" -LocalFilePath <PathToVHDFile>\r \r ## <a name=\"step-4-create-a-vm-with-the-uploaded-vhd-file\"></a>步骤 4：使用上传的 .vhd 文件创建 VM\r 上传 .vhd 文件后，可以将其作为映像添加到与订阅关联的自定义映像列表中，并使用此自定义映像创建虚拟机。\r \r 1. 从你在上一步中使用的 Azure PowerShell 窗口中，键入：\r \r         Add-AzureVMImage -ImageName <Your Image's Name> -MediaLocation <location of the VHD> -OS <Type of the OS on the VHD>\r \r    > [!NOTE]\r    > 使用 Linux 作为 OS 类型。 当前的 Azure PowerShell 版本只接受“Linux”或“Windows”作为参数。\r    >\r    >\r 2. 完成前面的步骤后，在 Azure 经典管理门户上选择“映像”选项卡时，将列出新映像。  \r \r     ![选择映像](./media/freebsd-create-upload-vhd/addfreebsdimage.png)\r 3. 从库创建虚拟机。 此新映像现在将显示在“我的映像”下。\r 4. 选择此新映像。 接下来，按照提示完成设置主机名、密码、SSH 密钥等操作。\r \r     ![自定义映像](./media/freebsd-create-upload-vhd/createfreebsdimageinazure.png)\r 5. 完成预配后，你将看到 FreeBSD VM 在 Azure 中运行。\r \r     ![azure 中的 FreeBSD 映像](./media/freebsd-create-upload-vhd/freebsdimageinazure.png)\r <!--Update_Description: update link, wording update-->\r "}