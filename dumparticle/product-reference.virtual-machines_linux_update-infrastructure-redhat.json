{"Title":"用于 Azure 中按需 Red Hat Enterprise Linux VM 的 Red Hat 更新基础结构","Description":"了解用于 Azure 中按需提供的 Red Hat Enterprise Linux 实例的 Red Hat 更新基础结构","Content":"# <a name=\"red-hat-update-infrastructure-for-on-demand-red-hat-enterprise-linux-vms-in-azure\"></a>用于 Azure 中按需 Red Hat Enterprise Linux VM 的 Red Hat 更新基础结构\r \r  [Red Hat 更新基础结构](https://access.redhat.com/products/red-hat-update-infrastructure) (RHUI) 允许云提供程序（如 Azure）镜像 Red Hat 托管的存储库内容，创建包含 Azure 特定内容的自定义存储库，并将其提供给最终用户 VM 使用。\r \r 已预先配置 Red Hat Enterprise Linux (RHEL) 即用即付 (PAYG) 映像来访问 Azure RHUI。 不需要任何其他配置。 要获取最新更新，请在 RHEL 实例准备好后运行 `sudo yum update`。 RHEL PAYG 软件费涵盖了此服务。\r \r ## <a name=\"important-information-about-azure-rhui\"></a>有关 Azure RHUI 的重要信息\r * Azure RHUI 目前仅支持每个 RHEL 系列（RHEL6 或 RHEL7）中的最新次要版本。 要将连接到 RHUI 的 RHEL VM 实例升级到最新次要版本，请运行 `sudo yum update`。\r \r     例如，如果从 RHEL 7.2 PAYG 映像预配 VM 并运行 `sudo yum update`，最终会获得 RHEL 7.4 VM（RHEL7 系列中的最新次要版本）。\r \r     要避免此行为，请按照[为 Azure 创建和上传基于 Red Hat 的虚拟机](redhat-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)一文的描述，构建自己的映像。 然后将其连接到不同的更新基础结构（直接连接到 [Red Hat 内容传送服务器](https://access.redhat.com/solutions/253273)或 [Red Hat 卫星服务器](https://access.redhat.com/products/red-hat-satellite)）。\r \r * RHEL PAYG 映像价格涵盖了 Azure 托管 RHUI 的访问权限。 从 Azure 托管的 RHUI 注销 PAYG RHEL VM 不会将虚拟机转换为自带许可 (BYOL) 类型的 VM。 如果向另一更新源注册同一 VM，可能会产生间接双倍费用。 第一次你需要支付 Azure RHEL 软件费。 第二次你需要支付之前已购买的 Red Hat 订阅费。 如果始终需要使用 Azure 托管的 RHUI 以外的更新基础结构，请考虑创建并部署自己的（BYOL 类型）映像。 [为 Azure 创建和上传基于 Red Hat 的虚拟机](redhat-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)介绍了此过程。\r \r * Azure 中的两类 RHEL PAYG 映像（RHEL for SAP HANA 和 RHEL for SAP Business Applications）已根据 SAP 认证需要，连接到保留在特定 RHEL 次要版本上的专用 RHUI 通道。 \r \r * 对 Azure 托管的 RHUI 的访问限制为 [Azure 数据中心 IP 范围](https://www.microsoft.com/download/details.aspx?id=42064)内的 VM。 若要通过本地网络基础结构代理所有 VM 流量，可能需要为 RHEL PAYG VM 设置用户定义的路由才能访问 Azure RHUI。\r \r ### <a name=\"the-ips-for-the-rhui-content-delivery-servers\"></a>RHUI 内容传送服务器的 IP\r \r 在 RHEL 按需映像可用的所有区域中都提供了 RHUI。 目前包括 [Azure 状态仪表板](https://www.azure.cn/support/service-dashboard/)页上列出的所有公共区域、Azure 美国政府区域和 Azure 德国区域。 \r \r 如果使用网络配置进一步限制来自 RHEL PAYG VM 的访问，根据所处环境，请确保允许使用以下 IP 以便 `yum update` 能够正常工作： \r \r ```\r # Azure Global\r 13.91.47.76\r 40.85.190.91\r 52.187.75.218\r 52.174.163.213\r \r # Azure US Government\r 13.72.186.193\r \r # Azure Germany\r 51.5.243.77\r 51.4.228.145\r ```\r \r ## <a name=\"rhui-azure-infrastructure-update\"></a>RHUI Azure 基础结构更新\r \r 2016 年 9 月，我们部署了更新的 Azure RHUI。 2017 年 4 月，我们关闭了旧版 Azure RHUI。 如果一直在使用 2016 年 9 月或之后的 RHEL PAYG 映像（或其快照），则会自动连接到新的 Azure RHUI。 但是，如果在 VM 上使用旧版本的快照，则需手动更新其配置以访问 Azure RHUI，如以下部分所述。\r \r 新的 Azure RHUI 服务器通过 [Azure 流量管理器](https://www.azure.cn/home/features/traffic-manager/)进行配置。 在流量管理器中，任何 VM 都可使用单一终结点 (rhui-1.microsoft.com)，而无需考虑区域。 \r \r ### <a name=\"troubleshoot-connection-problems-to-azure-rhui\"></a>排查 Azure RHUI 连接问题\r \r 如果从 Azure RHEL PAYG VM 连接到 Azure RHUI 时遇到问题，请按照下列步骤操作：\r \r 1. 检查 Azure RHUI 终结点的 VM 配置：\r \r     a. 检查 `/etc/yum.repos.d/rh-cloud.repo` 文件 `[rhui-microsoft-azure-rhel*]` 部分的 `baseurl` 是否包含对 `rhui-[1-3].microsoft.com` 的引用。 如果是，则使用的是新 Azure RHUI。\r \r     b. 如果它指向 `mirrorlist.*cds[1-4].chinacloudapp.cn` 模式的位置，则需要更新配置。 你使用的是旧 VM 快照，需要将其更新为指向新的 Azure RHUI。\r \r 2. 对 Azure 托管 RHUI 的访问限制为 [Azure 数据中心 IP 范围] (https://www.microsoft.com/download/details.aspx?id=42064) 内的 VM。\r \r 3. 如果使用新配置并已确认 VM 从 Azure IP 范围建立了连接，但仍无法连接到 Azure RHUI，请向 Microsoft 或 Red Hat 提出支持案例。\r \r ### <a name=\"manual-update-procedure-to-use-the-azure-rhui-servers\"></a>执行手动更新过程以使用 Azure RHUI 服务器\r 此过程仅供参考。 RHEL PAYG 映像已包含用于连接 Azure RHUI 的正确配置。 要手动更新配置以使用 Azure RHUI 服务器，请完成以下步骤：\r \r 1. 通过 curl 下载公钥签名。\r \r     ```bash\r     curl -o RPM-GPG-KEY-microsoft-azure-release https://download.microsoft.com/download/9/D/9/9d945f05-541d-494f-9977-289b3ce8e774/microsoft-sign-public.asc \r     ```\r \r 2. 验证下载密钥的有效性。\r \r     ```bash\r     gpg --list-packets --verbose < RPM-GPG-KEY-microsoft-azure-release\r     ```\r \r 3. 检查输出，然后验证 `keyid` 和 `user ID packet`。\r \r     ```bash\r     Version: GnuPG v1.4.7 (GNU/Linux)\r     :public key packet:\r            version 4, algo 1, created 1446074508, expires 0\r            pkey[0]: [2048 bits]\r            pkey[1]: [17 bits]\r            keyid: EB3E94ADBE1229CF\r     :user ID packet: \"Microsoft (Release signing) <gpgsecurity@microsoft.com>\"\r     :signature packet: algo 1, keyid EB3E94ADBE1229CF\r            version 4, created 1446074508, md5len 0, sigclass 0x13\r            digest algo 2, begin of digest 1a 9b\r            hashed subpkt 2 len 4 (sig created 2015-10-28)\r            hashed subpkt 27 len 1 (key flags: 03)\r            hashed subpkt 11 len 5 (pref-sym-algos: 9 8 7 3 2)\r            hashed subpkt 21 len 3 (pref-hash-algos: 2 8 3)\r            hashed subpkt 22 len 2 (pref-zip-algos: 2 1)\r            hashed subpkt 30 len 1 (features: 01)\r            hashed subpkt 23 len 1 (key server preferences: 80)\r            subpkt 16 len 8 (issuer key ID EB3E94ADBE1229CF)\r            data: [2047 bits]\r     ```\r \r 4. 安装公钥。\r \r     ```bash\r     sudo install -o root -g root -m 644 RPM-GPG-KEY-microsoft-azure-release /etc/pki/rpm-gpg\r     sudo rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-microsoft-azure-release\r     ```\r \r 5. 下载、验证和安装客户端 RPM 包管理器 (RPM)。\r \r     >[!NOTE]\r     >包版本已发生更改。 如果手动连接到 Azure RHUI，可通过从库预配最新的映像，找到每个 RHEL 系列的最新版客户端包。\r \r    a. 下载。 \r \r     - 适用于 RHEL 6：\r         ```bash\r         curl -o azureclient.rpm https://rhui-1.microsoft.com/pulp/repos/microsoft-azure-rhel6/rhui-azure-rhel6-2.1-32.noarch.rpm \r         ```\r \r     - 适用于 RHEL 7：\r         ```bash\r         curl -o azureclient.rpm https://rhui-1.microsoft.com/pulp/repos/microsoft-azure-rhel7/rhui-azure-rhel7-2.1-19.noarch.rpm  \r         ```\r \r    b. 验证。\r \r    ```bash\r    rpm -Kv azureclient.rpm\r    ```\r \r    c. 检查输出，确保包签名正确。\r \r    ```bash\r    azureclient.rpm:\r        Header V3 RSA/SHA256 Signature, key ID be1229cf: OK\r        Header SHA1 digest: OK (927a3b548146c95a3f6c1a5d5ae52258a8859ab3)\r        V3 RSA/SHA256 Signature, key ID be1229cf: OK\r        MD5 digest: OK (c04ff605f82f4be8c96020bf5c23b86c)\r    ```\r \r    d.单击“下一步”。 安装 RPM。\r \r     ```bash\r     sudo rpm -U azureclient.rpm\r     ```\r \r 6. 完成后，验证是否可以从 VM 访问 Azure RHUI。\r \r \r <!--Update_Description: update meta properties， wording update-->"}