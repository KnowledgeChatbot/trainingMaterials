{"Title":"了解和使用 Azure Linux 代理","Description":"了解如何安装和配置 Linux 代理 (waagent) 以管理虚拟机与 Azure 结构控制器的交互。","Content":"<a name=\"understanding-and-using-the-azure-linux-agent\"></a>\r \r # 了解和使用 Azure Linux 代理\r [!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]\r \r <a name=\"introduction\"></a>\r \r ## 介绍\r Azure Linux 代理 (waagent) 可以管理 Linux 与 FreeBSD 预配，以及 VM 与 Azure 结构控制器之间的交互。 它针对 Linux 和 FreeBSD IaaS 部署提供以下功能：\r \r > [!NOTE]\r > 有关其他详细信息，请参阅 Azure Linux 代理的 [自述文件](https://github.com/Azure/WALinuxAgent/blob/master/README.md) 。\r > \r > \r \r * **映像设置**\r \r   * 创建用户帐户\r   * 配置 SSH 身份验证类型\r   * 部署 SSH 公钥和密钥对\r   * 设置主机名\r   * 将主机名发布到平台 DNS\r   * 将 SSH 主机密钥指纹报告给平台\r   * 资源磁盘管理\r   * 格式化并安装资源磁盘\r   * 配置交换空间\r * **网络**\r \r   * 管理路由以提高与平台 DHCP 服务器的兼容性\r   * 确保网络接口名称的稳定性\r * **内核**\r \r   * 配置虚拟 NUMA（版本低于 2.6.37 的内核已禁用）\r   * 将 Hyper-V 熵用于 /dev/random\r   * 为根设备配置 SCSI 超时（可能通过远程方式）\r * **诊断**\r \r   * 控制台重定向到串行端口\r * **SCVMM 部署**\r \r   * 当用于 Linux 的 VMM 代理在 System Center Virtual Machine Manager 2012 R2 环境中运行时对其进行检测并启动\r * **VM 扩展**\r \r   * 将 Microsoft 和合作伙伴授权的组件注入 Linux VM (IaaS)，以便实现软件和配置的自动化\r   * [https://github.com/Azure/azure-linux-extensions](https://github.com/Azure/azure-linux-extensions)\r \r <a name=\"communication\"></a>\r \r ## 通信\r 从平台到代理的信息流通过两个通道进行：\r \r * 用于 IaaS 部署的附加了启动时间的 DVD。 此 DVD 包含一个与 OVF 兼容的配置文件，该文件包括除实际的 SSH 密钥对之外的所有预配信息。\r * 用于获取部署和拓扑配置的一个公开 REST API 的 TCP 终结点。\r \r <a name=\"requirements\"></a>\r \r ## 要求\r 以下系统已经过测试并确认兼容 Azure Linux 代理：\r \r > [!NOTE]\r > 此列表可能不同于 Azure Platform 所支持系统的官方列表，详见以下网页：[https://docs.azure.cn/virtual-machines/linux/endorsed-distros](https://docs.azure.cn/virtual-machines/linux/endorsed-distros)\r > \r > \r \r * CoreOS\r * CentOS 6.3+\r * Red Hat Enterprise Linux 6.7+\r * Debian 7.0+\r * Ubuntu 12.04+\r * openSUSE 12.3+\r * SLES 11 SP3+\r * Oracle Linux 6.4+\r \r 其他受支持的系统：\r \r * FreeBSD 10+（Azure Linux 代理 v2.0.10+）\r \r 正常运行 Linux 代理所依赖的一些系统包：\r \r * Python 2.6+\r * OpenSSL 1.0+\r * OpenSSH 5.3+\r * 文件系统实用程序：sfdisk、fdisk、mkfs、parted\r * 密码工具：chpasswd、sudo\r * 文本处理工具：sed、grep\r * 网络工具：ip-route\r * 装载 UDF 文件系统的内核支持。\r \r <a name=\"installation\"></a>\r \r ## 安装\r 使用分发的包存储库中的 RPM 或 DEB 包进行安装是安装和升级 Azure Linux 代理的首选方法。 所有[认可的分发版提供商](endorsed-distros.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)会将 Azure Linux 代理包集成到其映像和存储库。\r \r 请参阅 [GitHub 上的 Azure Linux 代理存储库](https://github.com/Azure/WALinuxAgent)中的文档了解高级安装选项，例如从源安装，或者安装到自定义位置或前缀。\r \r <a name=\"command-line-options\"></a>\r \r ## 命令行选项\r <a name=\"flags\"></a>\r \r ### 标志\r * verbose：增加指定命令的详细程度\r * force：跳过某些命令的交互式确认\r \r <a name=\"commands\"></a>\r \r ### 命令\r * help：列出支持的命令和标志。\r * deprovision：尝试清除系统并使其能够进行重新预配。 此操作已删除以下各项：\r \r   * 所有 SSH 主机密钥（如果在配置文件中 Provisioning.RegenerateSshHostKeyPair 为“y”）\r   * /etc/resolv.conf 中的 Nameserver 配置\r   * /etc/shadow 中的根密码（如果在配置文件中 Provisioning.DeleteRootPassword 为“y”）\r   * 缓存的 DHCP 客户端租用\r   * 将主机名重置为 localhost.localdomain\r \r > [!WARNING]\r > 取消预配无法保证清除映像中的所有敏感信息且适用于分发版。\r > \r > \r \r * deprovision+user：执行 -deprovision（上述）下面的所有操作，还将删除最后预配的用户帐户（从 /var/lib/waagent 中获得）和关联数据。 此参数是取消对以前在 Azure 中预配的映像预配，以捕获并重新使用该映像时的参数。\r * version：显示 waagent 的版本\r * serialconsole：配置 GRUB 以将 ttyS0（第一个串行端口）标记为启动控制台。 这可确保将内核启动日志发送到串行端口并可用于调试。\r * daemon：将 waagent 作为 daemon 运行以管理与平台的交互。 在 waagent init 脚本中为 waagent 指定此参数。\r * start：将 waagent 作为后台进程运行\r \r <a name=\"configuration\"></a>\r \r ## 配置\r 配置文件 (/etc/waagent.conf) 可控制 waagent 的操作。 下面显示了示例配置文件：\r \r     Provisioning.Enabled=y\r     Provisioning.DeleteRootPassword=n\r     Provisioning.RegenerateSshHostKeyPair=y\r     Provisioning.SshHostKeyPairType=rsa\r     Provisioning.MonitorHostName=y\r     Provisioning.DecodeCustomData=n\r     Provisioning.ExecuteCustomData=n\r     Provisioning.PasswordCryptId=6\r     Provisioning.PasswordCryptSaltLength=10\r     ResourceDisk.Format=y\r     ResourceDisk.Filesystem=ext4\r     ResourceDisk.MountPoint=/mnt/resource\r     ResourceDisk.MountOptions=None\r     ResourceDisk.EnableSwap=n\r     ResourceDisk.SwapSizeMB=0\r     LBProbeResponder=y\r     Logs.Verbose=n\r     OS.RootDeviceScsiTimeout=300\r     OS.OpensslPath=None\r     HttpProxy.Host=None\r     HttpProxy.Port=None\r \r 下面详细描述了各种配置选项。 配置选项分为三种类型：布尔值、字符串或整数。 布尔值配置选项可指定为“y”或“n”。 特殊关键字“无”可用于某些字符串类型配置条目，详细信息如下所示。\r \r **Provisioning.Enabled：**  \r 类型：布尔值  \r 默认值：y\r \r 这允许用户在代理中启用或禁用预配功能。 有效值为“y”或“n”。 如果禁用预配，则会保留映像中的 SSH 主机和用户密钥，并忽略 Azure 预配 API 中指定的所有配置。\r \r > [!NOTE]\r > `Provisioning.Enabled` 参数在使用 cloud-init 进行预配的 Ubuntu 云映像上默认为“n”。\r > \r > \r \r **Provisioning.DeleteRootPassword：**  \r 类型：布尔值  \r 默认值：n\r \r 如果设置此参数，则会在预配过程中清除 /etc/shadow 文件中的根密码。\r \r **Provisioning.RegenerateSshHostKeyPair：**  \r 类型：布尔值  \r 默认值：y\r \r 如果设置此参数，则会在设置过程中从 /etc/ssh/ 中删除所有 SSH 主机密钥对（ecdsa、dsa 和 rsa）。 并且会生成一个全新的密钥对。\r \r 此全新密钥对的加密类型可通过 Provisioning.SshHostKeyPairType 项进行配置。 请注意，在重新启动 SSH 监控程序时（例如，在重新引导时），某些分发将为任何缺少的加密类型重新创建 SSH 密钥对。\r \r **Provisioning.SshHostKeyPairType：**  \r 类型：字符串  \r 默认值：rsa\r \r 可将其设置为虚拟机上的 SSH 守护程序支持的加密算法类型。 通常支持的值为“rsa”、“dsa”和“ecdsa”。 请注意，Windows 上的“putty.exe”不支持“ecdsa”。 因此，若要在 Windows 上使用 putty.exe 连接到 Linux 部署，请使用“rsa”或“dsa”。\r \r **Provisioning.MonitorHostName：**  \r 类型：布尔值  \r 默认值：y\r \r 如果设置此参数，则 waagent 将监视 Linux 虚拟机的主机名更改情况（由“hostname”命令返回），并自动更新映像中的网络配置以反映此更改。 若要将名称更改推送到 DNS 服务器，会重新启用虚拟机中的网络。 这将导致 Internet 连接暂时中断。\r \r **Provisioning.DecodeCustomData**  \r 类型：布尔值  \r 默认值：n\r \r 如果已设置，waagent 将从 Base64 解码 CustomData。\r \r **Provisioning.ExecuteCustomData**  \r 类型：布尔值  \r 默认值：n\r \r 如果已设置，waagent 将在预配后执行 CustomData。\r \r **Provisioning.PasswordCryptId**  \r 类型：字符串  \r 默认值：6\r \r 生成密码哈希时加密使用的算法。  \r  1 - MD5  \r  2a - Blowfish  \r  5 - SHA-256  \r  6 - SHA-512  \r \r **Provisioning.PasswordCryptSaltLength**  \r 类型：字符串  \r 默认值：10\r \r 生成密码哈希时使用的随机 salt 长度。\r \r **ResourceDisk.Format：**  \r 类型：布尔值  \r 默认值：y\r \r 如果设置此参数，则当“ResourceDisk.Filesystem”中用户请求的 filesystem 类型是“ntfs”之外的任何值时，平台提供的资源磁盘将通过 waagent 进行格式化和装载。 磁盘上将提供类型为 Linux (83) 的单个分区。 请注意，如果可以成功装载此分区，则不会对其进行格式化。\r \r **ResourceDisk.Filesystem：**  \r 类型：字符串  \r 默认值：ext4\r \r 这将指定资源磁盘的 filesystem 类型。 受支持的值因 Linux 分发而异。 如果字符串为 X，则 mkfs.X 应呈现在 Linux 映像上。 SLES 11 映像通常应使用“ext3”。 FreeBSD 映像在此处应使用“ufs2”。\r \r **ResourceDisk.MountPoint：**  \r 类型：字符串  \r 默认值：/mnt/resource \r \r 这将指定资源磁盘的装载路径。 请注意，资源磁盘是 *临时* 磁盘，可能在取消预配 VM 时被清空。\r \r **ResourceDisk.MountOptions：**  \r 类型：字符串  \r 默认值：无\r \r 指定要传递给 mount -o 命令的磁盘装载选项。 这是一个逗号分隔值列表，例如 “nodev,nosuid”。 有关详细信息，请参阅 mount(8)。\r \r **ResourceDisk.EnableSwap：**  \r 类型：布尔值  \r 默认值：n\r \r 如果设置此参数，则将在资源磁盘上创建交换文件 (/swapfile) 并将该文件添加到系统交换空间。\r \r **ResourceDisk.SwapSizeMB：**  \r 类型：整数  \r 默认值：0\r \r 交换文件的大小（以兆字节为单位）。\r \r **Logs.Verbose：**  \r 类型：布尔值  \r 默认值：n\r \r 如果设置此参数，日志的详细程度则会有所提升。 Waagent 将日志记录到 /var/log/waagent.log 并使用系统 logrotate 功能来循环日志。\r \r **OS.EnableRDMA**  \r 类型：布尔值  \r 默认值：n\r \r 如果已设置，代理将尝试安装然后加载与底层硬件上的固件版本匹配的 RDMA 内核驱动程序。\r \r **OS.RootDeviceScsiTimeout：**  \r 类型：整数  \r 默认值：300\r \r 这将配置 OS 磁盘和数据驱动器上的 SCSI 超时（以秒为单位）。 如果未设置此参数，则使用系统默认值。\r \r **OS.OpensslPath：**  \r 类型：字符串  \r 默认值：无\r \r 这可用于指定要用于加密操作的 openssl 二进制文件的替代路径。\r \r **HttpProxy.Host、HttpProxy.Port**  \r 类型：字符串  \r 默认值：无\r \r 如果已设置，代理将使用此代理服务器访问 Internet。 \r \r <a name=\"ubuntu-cloud-images\"></a>\r \r ## Ubuntu 云映像\r 请注意，Ubuntu 云映像利用 [cloud-init](https://launchpad.net/ubuntu/+source/cloud-init) 执行多种配置任务，这些任务在其他情况下也可以通过 Azure Linux 代理来管理。  请注意以下不同：\r \r * **Provisioning.Enabled** 在使用 cloud-init 执行预配任务的 Ubuntu 云映像上默认为“n”。\r * 以下配置参数对使用 cloud-init 来管理资源磁盘并交换空间的 Ubuntu 云映像没有影响：\r \r   * **ResourceDisk.Format**\r   * **ResourceDisk.Filesystem**\r   * **ResourceDisk.MountPoint**\r   * **ResourceDisk.EnableSwap**\r   * **ResourceDisk.SwapSizeMB**\r * 请参阅以下资源来配置资源磁盘装入点，并在预配期间交换 Ubuntu 云映像上的空间：\r \r   * [Ubuntu Wiki：配置交换分区](https://wiki.ubuntu.com/AzureSwapPartitions)\r   * [将自定义数据注入到 Azure 虚拟机](../windows/classic/inject-custom-data.md?toc=%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json)"}