{"Title":"使用 PowerShell 管理 Azure 服务总线资源","Description":"使用 PowerShell 模块创建和管理服务总线资源","Content":"# <a name=\"use-powershell-to-manage-service-bus-resources\"></a>使用 PowerShell 管理服务总线资源\r \r Microsoft Azure PowerShell 是一个脚本编写环境，可用于控制和自动执行 Azure 服务的部署和管理。 本文介绍如何通过本地 Azure PowerShell 控制台或脚本，使用[服务总线 Resource Manager PowerShell 模块](https://docs.microsoft.com/powershell/module/azurerm.servicebus/?view=azurermps-3.7.0#service_bus)来预配和管理服务总线实体（命名空间、队列、主题和订阅）。\r \r 还可以使用 Azure Resource Manager 模板管理服务总线实体。 有关详细信息，请参阅[使用 Azure Resource Manager 模板创建服务总线资源](./service-bus-resource-manager-overview.md)一文。\r \r ## <a name=\"prerequisites\"></a>先决条件\r \r 在开始之前，你需要具备以下项：\r \r * Azure 订阅。 \r * 配备 Azure PowerShell 的计算机。 有关说明，请参阅 [Azure PowerShell cmdlet 入门](https://docs.microsoft.com/powershell/azure/get-started-azureps)。\r * 大致了解 PowerShell 脚本、NuGet 包和 .NET Framework。\r \r ## <a name=\"get-started\"></a>入门\r \r 第一步是使用 PowerShell 登录 Azure 帐户和 Azure 订阅。 按照 [Azure PowerShell cmdlet 入门](https://docs.microsoft.com/powershell/azure/get-started-azureps)中的说明登录 Azure 帐户，检索并访问 Azure 订阅中的资源。\r \r ## <a name=\"provision-a-service-bus-namespace\"></a>设置 Service Bus 命名空间\r \r 使用服务总线命名空间时，可以使用 [Get-AzureRmServiceBusNamespace](https://docs.microsoft.com/powershell/module/azurerm.servicebus/get-azurermservicebusnamespace)、[New-AzureRmServiceBusNamespace](https://docs.microsoft.com/powershell/module/azurerm.servicebus/new-azurermservicebusnamespace)、[Remove-AzureRmServiceBusNamespace](https://docs.microsoft.com/powershell/module/azurerm.servicebus/remove-azurermservicebusnamespace) 和 [Set-AzureRmServiceBusNamespace](https://docs.microsoft.com/powershell/module/azurerm.servicebus/set-azurermservicebusnamespace) cmdlet。\r \r 本示例在脚本中创建几个本地变量：`$Namespace` 和 `$Location`。\r \r * `$Namespace` 是要使用的服务总线命名空间的名称。\r * `$Location` 标识我们要在其中设置命名空间的数据中心。\r * `$CurrentNamespace` 将存储我们检索（或创建）的引用命名空间。\r \r 在实际脚本中，`$Namespace` 和 `$Location` 可作为参数传递。\r \r 此部分脚本执行以下任务：\r \r 1. 尝试使用指定名称检索服务总线命名空间。\r 2. 如果找到该命名空间，则报告它找到的内容。\r 3. 如果找不到该命名空间，则会创建该命名空间，然后检索新创建的命名空间。\r    \r     ``` powershell\r     # Query to see if the namespace currently exists\r     $CurrentNamespace = Get-AzureRMServiceBusNamespace -ResourceGroup $ResGrpName -NamespaceName $Namespace\r    \r     # Check if the namespace already exists or needs to be created\r     if ($CurrentNamespace)\r     {\r         Write-Host \"The namespace $Namespace already exists in the $Location region:\"\r         # Report what was found\r         Get-AzureRMServiceBusNamespace -ResourceGroup $ResGrpName -NamespaceName $Namespace\r     }\r     else\r     {\r         Write-Host \"The $Namespace namespace does not exist.\"\r         Write-Host \"Creating the $Namespace namespace in the $Location region...\"\r         New-AzureRmServiceBusNamespace -ResourceGroup $ResGrpName -NamespaceName $Namespace -Location $Location\r         $CurrentNamespace = Get-AzureRMServiceBusNamespace -ResourceGroup $ResGrpName -NamespaceName $Namespace\r         Write-Host \"The $Namespace namespace in Resource Group $ResGrpName in the $Location region has been successfully created.\"\r                 \r     }\r     ```\r \r ### <a name=\"create-a-namespace-authorization-rule\"></a>创建命名空间授权规则\r \r 下面的示例演示如何使用 [New-AzureRmServiceBusNamespaceAuthorizationRule](https://docs.microsoft.com/powershell/module/azurerm.servicebus/new-azurermservicebusnamespaceauthorizationrule)、[Get-AzureRmServiceBusNamespaceAuthorizationRule](https://docs.microsoft.com/powershell/module/azurerm.servicebus/get-azurermservicebusnamespaceauthorizationrule)、[Set-AzureRmServiceBusNamespaceAuthorizationRule](https://docs.microsoft.com/powershell/module/azurerm.servicebus/set-azurermservicebusnamespaceauthorizationrule) 和 [Remove-AzureRmServiceBusNamespaceAuthorizationRule](https://docs.microsoft.com/powershell/module/azurerm.servicebus/remove-azurermservicebusnamespaceauthorizationrule) cmdlet 管理命名空间授权规则。\r \r ```powershell\r # Query to see if rule exists\r $CurrentRule = Get-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule\r \r # Check if the rule already exists or needs to be created\r if ($CurrentRule)\r {\r     Write-Host \"The $AuthRule rule already exists for the namespace $Namespace.\"\r }\r else\r {\r     Write-Host \"The $AuthRule rule does not exist.\"\r     Write-Host \"Creating the $AuthRule rule for the $Namespace namespace...\"\r     New-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule -Rights @(\"Listen\",\"Send\")\r     $CurrentRule = Get-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule\r     Write-Host \"The $AuthRule rule for the $Namespace namespace has been successfully created.\"\r \r     Write-Host \"Setting rights on the namespace\"\r     $authRuleObj = Get-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule\r \r     Write-Host \"Remove Send rights\"\r     $authRuleObj.Rights.Remove(\"Send\")\r     Set-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthRuleObj $authRuleObj\r \r     Write-Host \"Add Send and Manage rights to the namespace\"\r     $authRuleObj.Rights.Add(\"Send\")\r     Set-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthRuleObj $authRuleObj\r     $authRuleObj.Rights.Add(\"Manage\")\r     Set-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthRuleObj $authRuleObj\r \r     Write-Host \"Show value of primary key\"\r     $CurrentKey = Get-AzureRmServiceBusNamespaceKey -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule\r         \r     Write-Host \"Remove this authorization rule\"\r     Remove-AzureRmServiceBusNamespaceAuthorizationRule -ResourceGroup $ResGrpName -NamespaceName $Namespace -AuthorizationRuleName $AuthRule\r }\r ```\r \r ## <a name=\"create-a-queue\"></a>创建队列\r \r 若要创建队列或主题，请使用上一部分中的脚本执行命名空间检查。 然后，创建队列：\r \r ```powershell\r # Check if queue already exists\r $CurrentQ = Get-AzureRmServiceBusQueue -ResourceGroup $ResGrpName -NamespaceName $Namespace -QueueName $QueueName\r \r if($CurrentQ)\r {\r     Write-Host \"The queue $QueueName already exists in the $Location region:\"\r }\r else\r {\r     Write-Host \"The $QueueName queue does not exist.\"\r     Write-Host \"Creating the $QueueName queue in the $Location region...\"\r     New-AzureRmServiceBusQueue -ResourceGroup $ResGrpName -NamespaceName $Namespace -QueueName $QueueName -EnablePartitioning $True\r     $CurrentQ = Get-AzureRmServiceBusQueue -ResourceGroup $ResGrpName -NamespaceName $Namespace -QueueName $QueueName\r     Write-Host \"The $QueueName queue in Resource Group $ResGrpName in the $Location region has been successfully created.\"\r }\r ```\r \r ### <a name=\"modify-queue-properties\"></a>修改队列属性\r \r 执行上一部分中的脚本后，可以使用 [Set-AzureRmServiceBusQueue](https://docs.microsoft.com/powershell/module/azurerm.servicebus/set-azurermservicebusqueue) cmdlet 更新队列的属性，如以下示例所示：\r \r ```powershell\r $CurrentQ.DeadLetteringOnMessageExpiration = $True\r $CurrentQ.MaxDeliveryCount = 7\r $CurrentQ.MaxSizeInMegabytes = 2048\r $CurrentQ.EnableExpress = $True\r \r Set-AzureRmServiceBusQueue -ResourceGroup $ResGrpName -NamespaceName $Namespace -QueueName $QueueName -QueueObj $CurrentQ\r ```\r \r ## <a name=\"provisioning-other-service-bus-entities\"></a>设置其他 Service Bus 实体\r \r 可以使用[服务总线 PowerShell 模块](https://docs.microsoft.com/powershell/module/azurerm.servicebus/?view=azurermps-3.7.0#service_bus)预配其他实体，例如主题和订阅。 这些 cmdlet 在语法上与上一部分所示的队列创建 cmdlet 类似。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - 有关服务总线 Resource Manager PowerShell 模块的完整文档，请参阅[此处](https://docs.microsoft.com/powershell/module/azurerm.servicebus/?view=azurermps-3.7.0#service_bus)。 此页列出所有可用的 cmdlet。\r - 有关使用 Azure Resource Manager 模板的信息，请参阅[使用 Azure Resource Manager 模板创建服务总线资源](./service-bus-resource-manager-overview.md)一文。\r - 有关[服务总线 .NET 管理库](./service-bus-management-libraries.md)的信息。\r \r 这些博客文章介绍管理服务总线实体的一些备选方法：\r \r * [How to create Service Bus queues, topics and subscriptions using a PowerShell script（如何使用 PowerShell 脚本创建服务总线队列、主题和订阅）](http://blogs.msdn.com/b/paolos/archive/2014/12/02/how-to-create-a-service-bus-queues-topics-and-subscriptions-using-a-powershell-script.aspx)\r * [如何使用 PowerShell 脚本创建 Service Bus 命名空间和事件中心](http://blogs.msdn.com/b/paolos/archive/2014/12/01/how-to-create-a-service-bus-namespace-and-an-event-hub-using-a-powershell-script.aspx)\r * [服务总线 PowerShell 脚本](https://code.msdn.microsoft.com/Service-Bus-PowerShell-a46b7059)\r \r <!--Anchors-->\r \r \r "}