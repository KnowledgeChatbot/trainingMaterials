{"Title":"在 Azure 中自己搭建 Nginx Web 服务器","Description":"本文介绍如何微软的公有云平台 Azure 中搭建 Nginx Web 服务器。","Content":"\r #在 Azure 中自己搭建 Nginx Web 服务器\r \r Nginx 是一款轻量级的 Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个 BSD-like 协议下发行。这篇文章介绍如何微软的公有云平台 Azure 中搭建 Nginx Web 服务器。   \r \r 大多数 Linux 发行版以及 BSD 版本已经在他们的安装库中包含了 Nginx，因此您可以通过任何该版本常用的安装方法来安装 Nginx (比如在Debian 和 Ubuntu 上运行 apt-get，在 FreeBSD 上运行 Ports 等)。有时候这些软件包已经过时。如果您想要最新的功能以及修正，您可以从nginx.org 下载包或从源码开始编译。  \r \r 下面我们就拿 CentOS 来做些例子。  \r \r ##创建一台虚拟机\r 您可以在 Azure上 选择您喜欢的 Linux 发行版并创建一台虚拟机，当然 Azure 也允许您自带自己的 Linux 虚拟机。  \r ![创建 Linux 虚拟机][1]\r \r ##安装 Nginx\r 1.在 CentOS 上安装自带 NGINX 软件包  \r \r 1.1  首先您需要添加NGINX yum安装源。  \r \r 创建 /etc/yum.repos.d/nginx.repo 并黏贴以下配置信息。  \r \r ```\r [nginx]\r name=nginx repo\r baseurl=http://nginx.org/packages/centos/$releasever/$basearch/\r gpgcheck=0\r enabled=1  \r ```\r \r 或者添加 CentOS 7 EPEL 库  \r \r ```\r sudo yum install epel-release  \r ```\r \r 如果您想了解如何安装其他 Linux 发行版自带的 Nginx 软件包，可参考https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#。 \r \r 1.2 安装  \r \r ```\r yum install nginx  \r ```\r \r 1.3 运行  \r \r ```\r systemctl start nginx  \r ```\r \r 您也可以运行一下命令来查看 nginx 服务的状态  \r \r ```\r systemctl status nginx\r ```\r \r ![nginx 服务的状态][2]  \r \r 2.在 CentOS 上安装来自 nginx.org 的软件包  \r \r 2.1 下载软件包，比如 NGINX 1.9.5。  \r \r 下面这个例子先安装了 wget 工具，这是因为 Azure 发布的 CentOS 7.1 中并没有默认安装 wget。  \r \r ```\r yum install wget\r wget nginx.org/download/nginx-1.9.5.tar.gz\r tar –xvzf nginx-1.9.5.tar.gz\r cd nginx-1.9.5  \r ```\r \r 2.2 编译安装，关于更多的编译选项，可以运行 “./configure –help” 或者参考[官网](http://nginx.org/en/docs/configure.html)。  \r \r 下面这个例子先安装了 gcc 编译器，这是因为 Azure 发布的 CentOS 7.1 中并没有默认安装 gcc。另外您也需要安装 pcre，pcre-devel，zlib，zlib-devel 和 openssl，否则您可能遇到再编译过程中遇到错误。比如，如果您不注明 “—without-http_rewrite_module” 您将会遇到 ”error: the HTTP rewrite module requires the PCRE library”。  \r \r ```\r yum install gcc\r yum install pcre pcre-devel zlib zlib-devel \r ./configure \r make\r make install\r ```\r \r 2.3 运行  \r \r ```\r /usr/sbin/nginx –c /etc/nginx/nginx.conf  \r ```\r \r 2.4 查看状态  \r \r ```\r ps –ef | grep nginx\r ```\r \r ![查看状态][3]  \r \r ##在 Azure 端中配置可以从公网访问虚拟机中部署的网站\r \r Azure 虚拟机默认只开放对应 VIP 地址的有限端口，用于远程连接或管理。新建网站如果需要通过虚拟 IP 地址某端口访问，则需要在该虚拟机上添加此服务终端节点（endpoint）。此操作可以通过 Azure 经典管理门户网站或通过 PowerShell 进行。  \r ![添加服务终端节点][4]\r \r ##验证\r \r 现在您可以在浏览器中访问您刚刚搭建好的服务器的公网 IP 来进行验证。  \r ![验证][5]\r \r ##小建议\r \r 如果您是自己从源码编译安装 Ngnix，建议把它变成一个守护进程，这样更容易来管理该服务。  \r \r 关于如何创建 Nginx init 脚本，可参考 [Nginx init script wiki](https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/)。  \r \r 下面的步骤针对 CentOS。  \r \r ```\r vi /etc/ini.d/nginx  \r ```\r \r 粘贴以下内容，保存。  \r \r ```\r #!/bin/sh\r #\r # nginx - this script starts and stops the nginx daemon\r #\r # chkconfig:   - 85 15\r # description:  NGINX is an HTTP(S) server, HTTP(S) reverse \\\r #               proxy and IMAP/POP3 proxy server\r # processname: nginx\r # config:      /etc/nginx/nginx.conf\r # config:      /etc/sysconfig/nginx\r # pidfile:     /var/run/nginx.pid\r \r # Source function library.\r . /etc/rc.d/init.d/functions\r \r # Source networking configuration.\r . /etc/sysconfig/network\r \r # Check that networking is up.\r [ \"$NETWORKING\" = \"no\" ] && exit 0\r \r nginx=\"/usr/sbin/nginx\"\r prog=$(basename $nginx)\r \r NGINX_CONF_FILE=\"/etc/nginx/nginx.conf\"\r \r [ -f /etc/sysconfig/nginx ] && . /etc/sysconfig/nginx\r \r lockfile=/var/lock/subsys/nginx\r \r make_dirs() {\r    # make required directories\r user=`$nginx -V 2>&1 | grep \"configure arguments:\" | sed 's/[^*]*--user=\\([^ ]*\\).*/\\1/g' -`\r \r    if [ -z \"`grep $user /etc/passwd`\" ]; then\r    useradd -M -s /bin/nologin $user\r    fi\r    options=`$nginx -V 2>&1 | grep 'configure arguments:'`\r    for opt in $options; do\r    if [ `echo $opt | grep '.*-temp-path'` ]; then\r        value=`echo $opt | cut -d \"=\" -f 2`\r        if [ ! -d \"$value\" ]; then\r            # echo \"creating\" $value\r            mkdir -p $value && chown -R $user $value\r        fi\r    fi\r    done\r }\r \r start() {\r     [ -x $nginx ] || exit 5\r     [ -f $NGINX_CONF_FILE ] || exit 6\r     make_dirs\r     echo -n $\"Starting $prog: \"\r     daemon $nginx -c $NGINX_CONF_FILE\r     retval=$?\r     echo\r     [ $retval -eq 0 ] && touch $lockfile\r     return $retval\r }\r \r stop() {\r     echo -n $\"Stopping $prog: \"\r     killproc $prog -QUIT\r     retval=$?\r     echo\r     [ $retval -eq 0 ] && rm -f $lockfile\r     return $retval\r }\r \r restart() {\r     configtest || return $?\r     stop\r     sleep 1\r     start\r }\r \r reload() {\r     configtest || return $?\r     echo -n $\"Reloading $prog: \"\r     killproc $nginx -HUP\r     RETVAL=$?\r     echo\r }\r \r force_reload() {\r     restart\r }\r \r configtest() {\r       $nginx -t -c $NGINX_CONF_FILE\r }\r \r rh_status() {\r     status $prog\r }\r \r rh_status_q() {\r     rh_status >/dev/null 2>&1\r }\r \r case \"$1\" in\r     start)\r         rh_status_q && exit 0\r         $1\r         ;;\r     stop)\r         rh_status_q || exit 0\r         $1\r         ;;\r     restart|configtest)\r         $1\r         ;;\r     reload)\r         rh_status_q || exit 7\r         $1\r         ;;\r     force-reload)\r         force_reload\r         ;;\r     status)\r         rh_status\r         ;;\r     condrestart|try-restart)\r         rh_status_q || exit 0\r         ;;\r     *)\r     echo $\"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}\"\r     exit 2\r esac  \r ```\r \r 赋予守护进程运行权限。  \r \r ```\r Chmod +x /etc/init.d/nginx  \r ```\r \r 接下来您就可以启动/停止/查看 Nginx 服务了  \r \r ```\r /etc/init.d/nginx start\r /etc/init.d/nginx stop\r /etc/init.d/nginx status  \r ```\r \r 如果你使用定制的 CentOS 并开启了防火墙，请运行以下命令来允许 HTTP 和 HTTPS 的流量:  \r \r ```\r sudo firewall-cmd --permanent --zone=public --add-service=http \r sudo firewall-cmd --permanent --zone=public --add-service=https\r sudo firewall-cmd --reload\r ```\r \r <!-- image references -->  \r [1]: ./media/open-source-azure-virtual-machines-linux-set-up-nginx-web-server/open-source-set-up-nginx-web-server-in-azure-1.png \r [2]: ./media/open-source-azure-virtual-machines-linux-set-up-nginx-web-server/open-source-set-up-nginx-web-server-in-azure-2.png \r [3]: ./media/open-source-azure-virtual-machines-linux-set-up-nginx-web-server/open-source-set-up-nginx-web-server-in-azure-3.png \r [4]: ./media/open-source-azure-virtual-machines-linux-set-up-nginx-web-server/open-source-set-up-nginx-web-server-in-azure-4.png \r [5]: ./media/open-source-azure-virtual-machines-linux-set-up-nginx-web-server/open-source-set-up-nginx-web-server-in-azure-5.png"}