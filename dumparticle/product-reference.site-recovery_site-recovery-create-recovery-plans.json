{"Title":"在 Azure Site Recovery 中创建用于故障转移和恢复的恢复计划","Description":"介绍如何在 Azure Site Recovery 中创建和自定义用于故障转移以及恢复 VM 与物理服务器的恢复计划","Content":"# <a name=\"create-recovery-plans\"></a>创建恢复计划\r \r 本文提供有关在 [Azure Site Recovery](site-recovery-overview.md) 中创建和自定义恢复计划的信息。\r \r  创建恢复计划以执行以下操作：\r \r * 定义要一起故障转移再同时启动的计算机组。\r * 将计算机一起分组到恢复计划组中，为计算机之间的依赖关系建模。 例如，要故障转移并启动特定的应用程序，可将该应用程序的所有 VM 分组到同一个恢复计划组中。\r * 运行故障转移。 可以对恢复计划运行测试、计划或非计划的故障转移。\r \r ## <a name=\"create-a-recovery-plan\"></a>创建恢复计划\r \r 1. 单击“恢复计划” > “创建恢复计划”。\r    为恢复计划指定一个名称，并指定源和目标。 源位置必须具有已针对故障转移和恢复启用的虚拟机。\r \r     - 对于 VMM 到 VMM 的复制，请选择“源类型” > “VMM”，然后选择源和目标 VMM 服务器。 单击“HYPER-V”查看受保护的云。\r     - 对于 VMM 到 Azure 的复制，请选择“源类型” > “VMM”。  选择源 VMM 服务器，再选择“Azure”作为目标。\r     - 对于 Hyper-V 到 Azure 的复制（无 VMM），请选择“源类型” > “Hyper-V 站点”。 选择该站点作为源，并选择“Azure”作为目标。\r     - 对于 VMware VM 或物理本地服务器到 Azure 的复制，请选择某个配置服务器作为源，再选择“Azure”作为目标。\r     - 对于 Azure 到 Azure 恢复计划，选择 Azure 区域作为源，并选择辅助 Azure 区域作为目标。 辅助 Azure 区域仅为保护虚拟机的区域。\r 2. 在“选择虚拟机”中，选择要添加到恢复计划中的默认组 (Group 1) 的虚拟机（或复制组）。\r \r ## <a name=\"customize-and-extend-recovery-plans\"></a>自定义和扩展恢复计划\r \r 可以自定义和扩展恢复计划：\r \r - **添加新组** - 向默认组添加其他恢复计划组（最多 7 个），然后向这些组添加更多计算机或复制组。 组将按添加顺序进行编号。 一个虚拟机或复制组只能包含在一个恢复计划组中。\r - **添加手动操作**- 可以添加要在恢复计划组之前或之后运行的手动操作。 恢复计划运行时，会在手动操作的插入点停止。 此时会显示一个对话框，提示指定该手动操作已完成。\r - **添加脚本**- 可添加在恢复计划组前或后运行的脚本。 添加脚本时，为该组添加一组新的操作。 例如，将使用以下名称创建组 1 的一组预先步骤：“组 1: 预先步骤”。 该集中列出所有预先步骤。 仅当已部署 VMM 服务器时，才能在主站点上添加脚本。\r - **添加 Azure Runbook**- 可通过 Azure Runbook 扩展恢复计划。 例如，自动执行任务或创建单步恢复。 [了解详细信息](site-recovery-runbook-automation.md)。\r \r ## <a name=\"add-scripts\"></a>添加脚本\r \r 可在恢复计划中使用 PowerShell 脚本。\r \r  - 确保脚本使用的是 try-catch 块，以便恰当地处理异常。\r     - 如果脚本中出现异常，脚本停止运行且任务显示为失败。\r     - 如果发生错误，脚本的剩余部分不会运行。\r     - 如果在运行计划外故障转移时发生错误，将继续运行恢复计划。\r     - 如果在运行计划内故障转移时发生错误，恢复计划会停止。 需要修复脚本，检查它是否按预期运行，并重新运行恢复计划。\r - Write-Host 命令不适用于恢复计划脚本，脚本将失败。 若要创建输出，请创建转而运行主脚本的代理脚本。 确保所有输出均通过“>>”命令进行传输。\r   * 如果脚本未在 600 秒内返回，则脚本超时。\r   * 如果有任何内容写出到 STDERR，脚本会归类为失败。 此信息会显示在脚本执行详细信息中。\r \r 如果在部署中使用 VMM：\r \r * 恢复计划中的脚本在 VMM 服务帐户的上下文中运行。 确保此帐户对脚本所在的远程共享拥有“读取”权限。 测试脚本是否可在 VMM 服务帐户特权级别运行。\r * Windows PowerShell 模块中随附提供了 VMM cmdlet。 安装 VMM 控制台时已安装该模块。 可在脚本中通过以下命令将其加载到脚本中：\r    - Import-Module -Name virtualmachinemanager。 [了解详细信息](https://technet.microsoft.com/library/hh875013.aspx)。\r * 确保 VMM 部署中至少有一个库服务器。 默认情况下，VMM 服务器的库共享路径位于 VMM 服务器本地，其文件夹名称为 MSCVMMLibrary。\r     * 如果库共享路径在远程位置（或在本地，但不与 MSCVMMLibrary 共享），请按如下所示配置共享（例如使用 \\\\\\libserver2.contoso.com\\share\\）：\r       * 打开注册表编辑器并导航到 **HKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\Azure Site Recovery\\Registration**。\r       * 编辑值 **ScriptLibraryPath**，将其设置为 \\\\libserver2.contoso.com\\share\\. 指定完整的 FQDN。 提供对共享位置的权限。 请注意，这是共享的根节点。 **若要验证这点，可在 VMM 的根节点浏览库。打开的路径即为路径根 - 将在变量中使用。**\r       * 确保测试脚本时所用的用户帐户具有与 VMM 服务帐户相同的权限。 这会检查独立测试的脚本是否按其在恢复计划中的相同方式进行运行。 在 VMM 服务器上，将执行策略设置为绕过，如下所示：\r         * 使用提升的权限打开 64 位 Windows PowerShell 控制台。\r         * 键入： **Set-executionpolicy bypass**。 [了解详细信息](https://technet.microsoft.com/library/ee176961.aspx)。\r \r > [!IMPORTANT]\r > 应仅在 64 位 PowerShell 上将执行策略设置为“免验证”。 如果为 32 位 PowerShell 进行此设置，则不会执行脚本。\r \r ## <a name=\"add-a-script-or-manual-action-to-a-plan\"></a>向计划添加脚本或手动操作\r \r 向默认恢复计划组添加 VM 或复制组并创建该计划后，可向该计划组添加脚本。\r \r 1. 打开恢复计划。\r 2. 在“步骤”列表中单击某项，然后单击“脚本”或“手动操作”。\r 3. 指定是要在选定项的前面还是后面添加该脚本或操作。 使用“上移”和“下移”按钮，上下移动脚本的位置。\r 4. 如果添加 VMM 脚本，请选择“故障转移到 VMM 脚本”。 在“脚本路径”中，键入共享的相对路径。 在以下 VMM 示例中指定路径：**\\RPScripts\\RPScript.PS1**。\r 5. 要添加 Azure 自动化 Runbook，请指定该 Runbook 所在的 Azure 自动化帐户，并选择相应的 Azure Runbook 脚本。\r 6. 执行恢复计划故障转移，确保脚本按预期运行。\r \r ### <a name=\"add-a-vmm-script\"></a>添加 VMM 脚本\r \r 如果有一个 VMM 源站点，则可在 VMM 服务器上创建脚本，并将其纳入恢复计划。\r \r 1. 在库共享中新建文件夹。 例如，\\<VMMServerName>\\MSSCVMMLibrary\\RPScripts。 将其放到源和目标 VMM 服务器上。\r 2. 创建脚本（例如，RPScript），并验证其按预期运行。\r 3. 将该脚本放在源和目标 VMM 服务器上的 \\<VMMServerName> \\MSSCVMMLibrary 位置。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r [详细了解](site-recovery-failover.md)如何运行故障转移。\r \r <!--Update_Description: wording update -->"}