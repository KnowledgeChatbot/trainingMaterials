{"Title":"连接到 Azure AD 时对 MVC 项目所做的更改","Description":"描述一下，当你使用 Visual Studio 连接服务连接到 Azure AD 时，你的 MVC 项目会发生什么情况","Content":"\r # <a name=\"what-happened-to-my-mvc-project-visual-studio-azure-active-directory-connected-service\"></a>我的 MVC 项目（Visual Studio Azure Active Directory 连接服务）发生了什么情况？\r > [!div class=\"op_single_selector\"]\r >- [入门](./vs-active-directory-dotnet-getting-started.md)\r >- [发生了什么情况](./vs-active-directory-dotnet-what-happened.md)\r \r ## <a name=\"references-have-been-added\"></a>已添加引用\r ### <a name=\"nuget-package-references\"></a>NuGet 包引用\r - **Microsoft.IdentityModel.Protocol.Extensions**\r - **Microsoft.Owin**\r - **Microsoft.Owin.Host.SystemWeb**\r - **Microsoft.Owin.Security**\r - **Microsoft.Owin.Security.Cookies**\r - **Microsoft.Owin.Security.OpenIdConnect**\r - **Owin**\r - **System.IdentityModel.Tokens.Jwt**\r \r ### <a name=\"net-references\"></a>.NET 引用\r - **Microsoft.IdentityModel.Protocol.Extensions**\r - **Microsoft.Owin**\r - **Microsoft.Owin.Host.SystemWeb**\r - **Microsoft.Owin.Security**\r - **Microsoft.Owin.Security.Cookies**\r - **Microsoft.Owin.Security.OpenIdConnect**\r - **Owin**\r - **System.IdentityModel**\r - **System.IdentityModel.Tokens.Jwt**\r - **System.Runtime.Serialization**\r \r ## <a name=\"code-has-been-added\"></a>已添加代码\r ### <a name=\"code-files-were-added-to-your-project\"></a>代码文件已添加到您的项目\r 身份验证启动类 **App_Start/Startup.Auth.cs**（包含 Azure AD 身份验证的启动逻辑）已添加到你的项目。 此外，还添加了控制器类 Controllers/AccountController.cs，其中包含 **SignIn()** 和 **SignOut()** 方法。 最后，添加了分部视图 **Views/Shared/_LoginPartial.cshtml**（包含 SignIn/SignOut 的操作链接）。\r \r ### <a name=\"startup-code-was-added-to-your-project\"></a>启动代码已添加到您的项目\r 如果项目中已经有一个 Startup 类，**Configuration** 方法将进行更新，以包括对 **ConfigureAuth(app)** 的调用。 否则，Startup 类已添加到您的项目。\r \r ### <a name=\"your-appconfig-or-webconfig-has-new-configuration-values\"></a>您的 app.config 或 web.config 具有新的配置值\r 已添加以下配置条目。\r \r ```\r <appSettings>\r     <add key=\"ida:ClientId\" value=\"ClientId from the new Azure AD App\" />\r     <add key=\"ida:AADInstance\" value=\"https://login.partner.microsoftonline.cn/\" />\r     <add key=\"ida:Domain\" value=\"The selected Azure AD Domain\" />\r     <add key=\"ida:TenantId\" value=\"The Id of your selected Azure AD Tenant\" />\r     <add key=\"ida:PostLogoutRedirectUri\" value=\"Your project start page\" />\r </appSettings>\r ```\r \r ### <a name=\"an-azure-active-directory-ad-app-was-created\"></a>已创建 Azure Active Directory (AD) 应用\r 已在您在向导中选定的目录内创建一个 Azure AD 应用程序。\r \r ## <a name=\"if-i-checked-disable-individual-user-accounts-authentication-what-additional-changes-were-made-to-my-project\"></a>如果我选中“*禁用单个用户帐户身份验证*”，会对我的项目进行哪些额外的更改？\r NuGet 包引用已删除，文件已删除和备份。 根据你的项目的状态，你可能需要手动删除额外的引用或文件，或者根据需要修改代码。\r \r ### <a name=\"nuget-package-references-removed-for-those-present\"></a>删除的 NuGet 包引用（针对已存在的）\r - **Microsoft.AspNet.Identity.Core**\r - **Microsoft.AspNet.Identity.EntityFramework**\r - **Microsoft.AspNet.Identity.Owin**\r \r ### <a name=\"code-files-backed-up-and-removed-for-those-present\"></a>备份的和删除的代码文件（针对已存在的）\r 以下每个文件都已备份并从项目中删除。 备份文件位于项目根目录的“Backup”文件夹中。\r \r - **App_Start\\IdentityConfig.cs**\r - **Controllers\\ManageController.cs**\r - **Models\\IdentityModels.cs**\r - **Models\\ManageViewModels.cs**\r \r ### <a name=\"code-files-backed-up-for-those-present\"></a>备份的的代码文件（针对已存在的）\r 以下每个文件在替换之前已备份。 备份文件位于项目根目录的“Backup”文件夹中。\r \r - **Startup.cs**\r - **App_Start\\Startup.Auth.cs**\r - **Controllers\\AccountController.cs**\r - **Views\\Shared\\_LoginPartial.cshtml**\r \r ## <a name=\"if-i-checked-read-directory-data-what-additional-changes-were-made-to-my-project\"></a>如果我选中“*读取目录数据*”，会对我的项目进行其他哪些更改？\r 添加了其他引用。\r \r ### <a name=\"additional-nuget-package-references\"></a>其他 NuGet 包引用\r - **EntityFramework**\r - **Microsoft.Azure.ActiveDirectory.GraphClient**\r - **Microsoft.Data.Edm**\r - **Microsoft.Data.OData**\r - **Microsoft.Data.Services.Client**\r - **Microsoft.IdentityModel.Clients.ActiveDirectory**\r - **System.Spatial**\r \r ### <a name=\"additional-net-references\"></a>其他 .NET 引用\r - **EntityFramework**\r - **EntityFramework.SqlServer**\r - **Microsoft.Azure.ActiveDirectory.GraphClient**\r - **Microsoft.Data.Edm**\r - **Microsoft.Data.OData**\r - **Microsoft.Data.Services.Client**\r - **Microsoft.IdentityModel.Clients.ActiveDirectory**\r - **Microsoft.IdentityModel.Clients.ActiveDirectory.WindowsForms**\r - **System.Spatial**\r \r ### <a name=\"additional-code-files-were-added-to-your-project\"></a>其他代码文件已添加到你的项目\r 添加了两个支持令牌缓存的文件：**Models\\ADALTokenCache.cs** 和 **Models\\ApplicationDbContext.cs**。  额外添加了一个控制器和视图，以演示如何使用 Azure 图形 API 访问用户配置文件信息。  这些文件是 **Controllers\\UserProfileController.cs** 和 **Views\\UserProfile\\Index.cshtml**。\r \r ### <a name=\"additional-startup-code-was-added-to-your-project\"></a>其他启动代码已添加到你的项目\r 在 **startup.auth.cs** 文件中，新的 **OpenIdConnectAuthenticationNotifications** 对象已添加到 **OpenIdConnectAuthenticationOptions** 的 **Notifications** 成员中。  这是为了能够接收 OAuth 代码，并用其交换访问令牌。\r \r ### <a name=\"additional-changes-were-made-to-your-appconfig-or-webconfig\"></a>对 app.config 或 web.config 做出的其他更改\r 添加了以下附加配置条目。\r \r ```\r <appSettings>\r     <add key=\"ida:ClientSecret\" value=\"Your Azure AD App's new client secret\" />\r </appSettings>\r ```\r \r 添加了以下配置节和连接字符串。\r \r ```\r <configSections>\r     <!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 -->\r     <section name=\"entityFramework\" type=\"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\" requirePermission=\"false\" />\r </configSections>\r <connectionStrings>\r     <add name=\"DefaultConnection\" connectionString=\"Data Source=(localdb)\\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\\aspnet-[AppName + Generated Id].mdf;Initial Catalog=aspnet-[AppName + Generated Id];Integrated Security=True\" providerName=\"System.Data.SqlClient\" />\r </connectionStrings>\r <entityFramework>\r     <defaultConnectionFactory type=\"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework\">\r       <parameters>\r         <parameter value=\"mssqllocaldb\" />\r       </parameters>\r     </defaultConnectionFactory>\r     <providers>\r       <provider invariantName=\"System.Data.SqlClient\" type=\"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer\" />\r     </providers>\r </entityFramework>\r ```\r \r ### <a name=\"your-azure-active-directory-app-was-updated\"></a>你的 Azure Active Directory 应用已更新\r 你的 Azure Active Directory 应用已更新为包括*读取目录数据*权限，并已创建一个附加密钥，该密钥随后已用作 *ida:ClientSecret* 文件中的 **web.config**。\r \r ## <a name=\"next-steps\"></a>后续步骤\r - [详细了解 Azure Active Directory](https://www.azure.cn/home/features/identity/)\r "}