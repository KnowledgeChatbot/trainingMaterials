{"Title":"Azure API 管理中的策略","Description":"了解如何在 API 管理中创建、编辑和配置策略。","Content":"# <a name=\"policies-in-azure-api-management\"></a>Azure API 管理中的策略\r 在 Azure API 管理中，策略是一项强大的系统功能，允许发布者通过配置更改 API 的行为。 策略是一组语句，在请求或响应 API 时按顺序执行。 常用的语句包括从 XML 到 JSON 的格式转换，并调用速率限制来限制从一名开发人员传入的调用量。 许多策略开箱即用。\r \r 请参阅[策略参考][Policy Reference]，了解策略语句及其设置的完整列表。\r \r 策略在位于 API 使用者和托管 API 之间的网关内部应用。 该网关接收所有请求，并通常将其原封不动地转发到基础 API。 但是策略可以将更改应用于入站请求和出站响应。\r \r 在任何 API 管理策略中，策略表达式可以用作属性值或文本值，除非该策略另外指定。 某些策略（如[控制流][Control flow]和[设置变量][Set variable]策略）基于策略表达式。 有关详细信息，请参阅[高级策略][Advanced policies]和[策略表达式][Policy expressions]。\r \r ## <a name=\"scopes\"> </a>如何配置策略\r 可在全局范围内配置策略，也可在[产品][Product]范围、[API][API] 范围或[操作][Operation]范围内配置。 若要配置策略，请导航到发布者门户中的策略编辑器。\r \r ![策略菜单][policies-menu]\r \r 策略编辑器有三个主要部分：策略范围（上）、在其中编辑策略的策略定义（左）和语句列表（右）：\r \r ![策略编辑器][policies-editor]\r \r 要开始配置策略，必须首先选择该策略将应用的范围。 在下面的屏幕截图中，已选中“初学者”产品。 请注意，策略名称旁的正方形符号指示某一策略已应用于此级别。\r \r ![范围][policies-scope]\r \r 由于已应用策略，配置如定义视图中所示。\r \r ![配置][policies-configure]\r \r 最初以只读方式显示策略。 若要编辑定义，请单击“配置策略”操作。\r \r ![编辑][policies-edit]\r \r 策略定义是一个简单的 XML 文档，用于描述一个入站和出站语句序列。 可以直接在定义窗口中编辑 XML。 右侧提供语句的列表，同时启用适用于当前范围的语句并突出显示；如上面的屏幕截图中的“限制调用速率”语句所示。\r \r 单击启用的语句会在定义视图中的光标位置添加相应的 XML。 \r \r > [!NOTE]\r > 如果无法启用要添加的策略，请确保位于为该策略设置的相应范围内。 每个策略语句都设计为在特定范围和策略部分中使用。 若要查看某个策略的策略部分和范围，请参阅[策略参考][Policy Reference]中该策略的“用法”部分。\r > \r > \r \r [策略参考][Policy Reference]中提供了策略语句及其设置的完整列表。\r \r 例如，要添加新的语句以限制到指定 IP 地址的入站请求，请直接将光标置于 `inbound` XML 元素的内容中，然后单击“限制调用方 IP”语句。\r \r ![限制策略][policies-restrict]\r \r 这会将 XML 代码片段添加到 `inbound` 元素，提供如何配置该语句的指导。\r \r ```xml\r <ip-filter action=\"allow | forbid\">\r     <address>address</address>\r     <address-range from=\"address\" to=\"address\"/>\r </ip-filter>\r ```\r \r 要限制入站请求并仅接受来自 IP 地址 1.2.3.4 的请求，请修改 XML，如下所示：\r \r ```xml\r <ip-filter action=\"allow\">\r     <address>1.2.3.4</address>\r </ip-filter>\r ```\r \r ![保存][policies-save]\r \r 完成策略语句的配置后，单击“保存”，更改将立即传播到 API 管理网关。\r \r ## <a name=\"sections\"> </a>了解策略配置\r 策略是一系列按请求和响应顺序执行的语句。 配置相应地划分为 `inbound`、`backend`、`outbound` 和 `on-error` 部分，如以下配置所示。\r \r ```xml\r <policies>\r   <inbound>\r     <!-- statements to be applied to the request go here -->\r   </inbound>\r   <backend>\r     <!-- statements to be applied before the request is forwarded to \r          the backend service go here -->\r   </backend>\r   <outbound>\r     <!-- statements to be applied to the response go here -->\r   </outbound>\r   <on-error>\r     <!-- statements to be applied if there is an error condition go here -->\r   </on-error>\r </policies> \r ```\r \r 如果在处理请求的过程中出错，则会忽略 `inbound`、`backend` 或 `outbound` 部分中的其余步骤，跳到 `on-error` 部分执行相关语句。 将策略语句置于 `on-error` 部分以后，即可使用 `context.LastError` 属性查看错误、使用 `set-body` 策略检查和自定义错误响应，以及配置发生错误时的应对措施。 错误代码可针对内置步骤，也可针对在处理策略语句的过程中会发生的错误。 有关详细信息，请参阅 [Error handling in API Management policies](https://msdn.microsoft.com/library/azure/mt629506.aspx)（API 管理策略中的错误处理）。\r \r 由于策略可以在不同级别（全局、产品、API 和操作）指定，因此可通过此配置指定一个顺序，根据父策略执行策略定义的语句。 \r \r 策略范围按以下顺序计算。\r \r 1. 全局范围\r 2. 产品范围\r 3. API 范围\r 4. 操作范围\r \r 范围内的语句按 `base` 元素（如果存在）的位置计算。 全局策略没有父策略，因此在其中使用 `<base>` 元素无效。\r \r 例如，如果在全局级别有一个策略并且为 API 配置了一个策略，则只要使用该特定 API，这两种策略都会被应用。 API 管理允许通过基础元素实现组合策略语句的确定性排序。 \r \r ```xml\r <policies>\r     <inbound>\r         <cross-domain />\r         <base />\r         <find-and-replace from=\"xyz\" to=\"abc\" />\r     </inbound>\r </policies>\r ```\r \r 在上述示例策略定义中，`cross-domain` 语句会在执行任何更高级策略前执行，而这些策略之后又是 `find-and-replace` 策略。 \r \r 若要在策略编辑器中查看当前范围的策略，请单击“重新计算所选范围的有效策略”。\r \r \r [Policy Reference]: ./api-management-policy-reference.md\r [Product]: ./api-management-howto-add-products.md\r [API]: ./api-management-howto-add-products.md#add-apis \r [Operation]: ./api-management-howto-add-operations.md\r \r [Advanced policies]: https://msdn.microsoft.com/library/azure/dn894085.aspx\r [Control flow]: https://msdn.microsoft.com/library/azure/dn894085.aspx#choose\r [Set variable]: https://msdn.microsoft.com/library/azure/dn894085.aspx#set_variable\r [Policy expressions]: https://msdn.microsoft.com/library/azure/dn910913.aspx\r \r [policies-menu]: ./media/api-management-howto-policies/api-management-policies-menu.png\r [policies-editor]: ./media/api-management-howto-policies/api-management-policies-editor.png\r [policies-scope]: ./media/api-management-howto-policies/api-management-policies-scope.png\r [policies-configure]: ./media/api-management-howto-policies/api-management-policies-configure.png\r [policies-edit]: ./media/api-management-howto-policies/api-management-policies-edit.png\r [policies-restrict]: ./media/api-management-howto-policies/api-management-policies-restrict.png\r [policies-save]: ./media/api-management-howto-policies/api-management-policies-save.png\r "}