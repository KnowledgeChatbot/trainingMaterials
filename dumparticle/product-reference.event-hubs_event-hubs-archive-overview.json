{"Title":"使用 Azure 事件中心存档来存档遥测数据概述","Description":"Azure 事件中心存档功能概述。","Content":"# Azure 事件中心存档\r <a name=\"azure-event-hubs-archive\" ></a>\r 使用 Azure 事件中心存档，可以更灵活地将事件中心中的流数据自动传送到所选的 Blob 存储帐户，可以指定所选的时间或大小间隔。 设置存档非常快速，无需管理费用即可运行它，并且可以使用事件中心[吞吐量单位](event-hubs-features.md#capacity)自动进行缩放。 事件中心存档是在 Azure 中加载流数据的最简单方法，并可让用户专注于数据处理，而不是数据捕获。\r \r 事件中心存档可让用户处理同一个流中的实时和基于 Batch 的管道。 这使用户能够构建随着时间的推移随用户的需要增长的解决方案。 无论用户现在正在构建基于 Batch 的系统并着眼于将来进行实时处理，还是要将高效的冷路径添加到现有的实时解决方案，事件中心存档都可以使流数据处理更加简单。\r \r ## 事件中心存档的工作原理\r <a name=\"how-event-hubs-archive-works\" ></a>\r 事件中心是遥测数据入口的时间保留持久缓冲区，类似于分布式日志。 缩小事件中心的关键在于[分区使用者模式](event-hubs-features.md#partitions)。 每个分区是独立的数据段，并单独使用。 根据可配置的保留期，随着时间的推移此数据会过时。 因此，给定的事件中心永远不会装得“太满”。\r \r 事件中心存档可让用户指定自己的 Azure Blob 存储帐户和容器（将用于存储已存档数据）。 此帐户可以与事件中心在同一区域中，也可以在另一个区域中，从而增加了事件中心存档功能的灵活性。\r \r 已存档数据以 [Apache Avro][Apache Avro] 格式写入：一种紧凑、便捷的二进制格式，该格式使用内联架构提供丰富的数据结构。 这种格式广泛用于 Hadoop 生态系统，以及由流分析和 Azure 数据工厂使用。 在本文后面提供了有关如何使用 Avro 的详细信息。\r \r ### 存档窗口化\r <a name=\"archive-windowing\" ></a>\r 事件中心存档可让用户设置用于控制存档的“窗口”。 此窗口使用最小大小并具有使用“第一个获胜”策略的时间配置，意味着遇到的第一个触发器将触发存档操作。 如果使用 15 分钟，100 MB 的存档窗口，且发送速度为每秒 1 MB，则大小窗口将在时间窗口之前触发。 每个分区独立存档，并在存档时写入已完成的块 blob，在遇到存档间隔时针对时间进行命名。 命名约定如下所示：\r \r ```\r [Namespace]/[EventHub]/[Partition]/[YYYY]/[MM]/[DD]/[HH]/[mm]/[ss]\r ```\r \r ### 缩放到吞吐量单位\r <a name=\"scaling-to-throughput-units\" ></a>\r 事件中心流量由[吞吐量单位](event-hubs-features.md#capacity)控制。 单个吞吐量单位允许 1 MB/秒或 1000 个事件/秒的入口量以及两倍的出口量。 标准事件中心可以配置 1 到 20 个吞吐量单位，更多吞吐量单位可以通过发出增加配额 [支持请求][support request]来购买。 超出购买的吞吐量单位的使用将受到限制。 事件中心存档直接从内部事件中心存储复制数据，从而绕过吞吐量单位出口配额，为流分析或 Spark 等其他处理读取器节省了出口量。\r \r 事件中心存档配置后，在用户发送第一个事件时，就立即自动运行。 它始终继续运行。 为了让下游处理更便于了解该进程正在运行，事件中心在没有数据时写入空文件。 这提供了可预测的频率以及可以供给 Batch 处理器的标记。\r \r ## 设置事件中心存档\r <a name=\"setting-up-event-hubs-archive\" ></a>\r 可以通过门户或 Azure Resource Manager 在创建事件中心时配置存档。 只需单击“启用”  按钮即可启用存档。 单击边栏选项卡的“容器”  部分可配置存储帐户和容器。 由于事件中心存档对存储使用服务到服务身份验证，因此无需指定存储连接字符串。 资源选取器自动为存储帐户选择资源 URI。 如果使用 Azure Resource Manager，必须以字符串形式显式提供此 URI。\r \r 默认时间窗口为 5 分钟。 最小值为 1，最大值为 15。 **大小** 窗口的范围为 10-500 MB。\r \r ![][1]\r \r ## 将存档添加到现有的事件中心\r <a name=\"adding-archive-to-an-existing-event-hub\" ></a>\r 可以在事件中心命名空间中的现有事件中心上配置存档。 较早的**消息**类型或**混合**类型的命名空间中未提供此功能。 若要对现有的事件中心启用“存档”功能，或者要更改“存档”设置，请单击命名空间以加载“概要”边栏选项卡，然后单击要启用或更改“存档”设置的事件中心。 最后，单击打开的边栏选项卡的“属性”  部分，如下图中所示。\r \r ![][2]\r \r 还可以通过 Azure Resource Manager 模板配置事件中心存档。 有关详细信息，请参阅[此文章](event-hubs-resource-manager-namespace-event-hub-enable-archive.md)。\r \r ## 浏览存档和使用 Avro\r <a name=\"exploring-the-archive-and-working-with-avro\" ></a>\r 配置后，事件中心存档在配置的时间窗口中提供的 Azure 存储帐户和容器中创建文件。 可以在任何工具（例如 [Azure 存储资源管理器][Azure Storage Explorer]）中查看这些文件。 可以本地下载这些文件以进行处理。\r \r 事件中心存档生成的文件具有以下 Avro 架构：\r \r ![][3]\r \r 浏览 Avro 文件的简单方法是使用 Apache 中的 [Avro 工具][Avro Tools] jar。 下载此 jar 后，运行以下命令即可查看特定 Avro 文件的架构：\r \r ```\r java -jar avro-tools-1.8.1.jar getschema \\<name of archive file\\>\r ```\r \r 此命令返回\r \r ```\r {\r \r     \"type\":\"record\",\r     \"name\":\"EventData\",\r     \"namespace\":\"Microsoft.ServiceBus.Messaging\",\r     \"fields\":[\r                  {\"name\":\"SequenceNumber\",\"type\":\"long\"},\r                  {\"name\":\"Offset\",\"type\":\"string\"},\r                  {\"name\":\"EnqueuedTimeUtc\",\"type\":\"string\"},\r                  {\"name\":\"SystemProperties\",\"type\":{\"type\":\"map\",\"values\":[\"long\",\"double\",\"string\",\"bytes\"]}},\r                  {\"name\":\"Properties\",\"type\":{\"type\":\"map\",\"values\":[\"long\",\"double\",\"string\",\"bytes\"]}},\r                  {\"name\":\"Body\",\"type\":[\"null\",\"bytes\"]}\r              ]\r }\r ```\r \r 还可以使用 Avro 工具将文件转换为 JSON 格式以及执行其他处理。\r \r 若要执行更高级的处理，请下载并安装适用于所选平台的 Avro。 在撰写本文时，有可用于 C、C++、C\\#、Java、NodeJS、Perl、PHP、Python 和 Ruby 的实现。\r \r Apache Avro 针对 [Java][Java] 和 [Python][Python] 提供了完整的快速入门指南。 还可以阅读[事件中心存档入门](event-hubs-archive-python.md)一文。\r \r ## 事件中心存档如何收费\r <a name=\"how-event-hubs-archive-is-charged\" ></a>\r 事件中心存档的计量方式与吞吐量单位类似，并按小时付费。 费用直接与为命名空间购买的吞吐量单位数成正比。 随着吞吐量单位增加和减少，事件中心存档也相应地增加和减少以提供匹配的性能。 相继进行计量。 事件中心存档的费用为每小时每个吞吐量单位 0.10 美元，在预览期间以 50%的折扣提供。\r \r 事件中心存档是将数据导入 Azure 的最简单方法。 使用 Azure Data Lake、Azure 数据工厂和 Azure HDInsight，可以执行 Batch 操作和其他所选的分析，请使用熟悉的工具和平台，以所需的任何规模执行。\r \r ## 后续步骤\r <a name=\"next-steps\" ></a>\r 访问以下链接可以了解有关事件中心的详细信息：\r \r * [使用事件中心的完整示例应用程序][sample application that uses Event Hubs]。\r * [使用事件中心扩大事件处理][Scale out Event Processing with Event Hubs] 示例。\r * [事件中心概述][Event Hubs overview]\r \r [Apache Avro]: http://avro.apache.org/\r [support request]: https://www.azure.cn/support/contact/\r [1]: ./media/event-hubs-archive-overview/event-hubs-archive1.png\r [2]: media/event-hubs-archive-overview/event-hubs-archive2.png\r [Azure Storage Explorer]: http://azurestorageexplorer.codeplex.com/\r [3]: ./media/event-hubs-archive-overview/event-hubs-archive3.png\r [Avro Tools]: http://www-us.apache.org/dist/avro/avro-1.8.1/java/avro-tools-1.8.1.jar\r [Java]: http://avro.apache.org/docs/current/gettingstartedjava.html\r [Python]: http://avro.apache.org/docs/current/gettingstartedpython.html\r [Event Hubs overview]: event-hubs-what-is-event-hubs.md\r [sample application that uses Event Hubs]: https://code.msdn.microsoft.com/Service-Bus-Event-Hub-286fd097\r [Scale out Event Processing with Event Hubs]: https://code.msdn.microsoft.com/Service-Bus-Event-Hub-45f43fc3\r "}