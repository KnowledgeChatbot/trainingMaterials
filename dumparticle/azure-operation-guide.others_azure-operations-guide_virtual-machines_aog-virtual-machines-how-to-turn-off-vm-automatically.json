{"Title":"自动化实现定时关闭虚拟机","Description":"在虚拟机中配置如何定时关闭虚拟机","Content":"\r #使用本地计划任务定时关闭azure虚拟机\r \r ###本文包含以下内容\r \r * [前提条件](#prerequisite)\r * [如何实现定时关闭虚拟机](#operation)\r \r ## <a id=\"prerequisite\"></a>前提条件\r Controller 机器上必须安装 Azure PowerShell，并且要在 PowerShell 里登录一次 Azure, 请参见： [如何安装和配置 Azure PowserShell](/powershell-install-configure)\r \r ## <a id=\"operation\"></a>如何实现定时关闭虚拟机\r 配好 Azure PowerShell 以后，就可以用下面这个脚本创建定时关机任务。把下面的代码另存为一个 PowerShell 脚本保存到本地磁盘，比如叫`Stop-AzureVMsOnSchedule.ps1`\r \r <pre><code>\r <#\r .Synopsis\r   Creates scheduled tasks to stop Virtual Machines.\r .DESCRIPTION\r   Creates scheduled tasks to stop a single Virtual Machine or a set of Virtual Machines (using\r   wildcard pattern syntax for the Virtual Machine name).\r .EXAMPLE\r   Stop-AzureVMsOnSchedule.ps1 -ServiceName \"MyServiceName\" -VMName \"testmachine1\" -TaskName \"Stopt Test Machine 1\" -At 5:30PM\r   Stop-AzureVMsOnSchedule.ps1 -ServiceName \"MyServiceName\" -VMName \"test*\" -TaskName \"Stop All Test Machines\" -At 5:30PM\r #>\r \r param(\r   # The name of the VM(s) to start on schedule.  Can be wildcard pattern.\r   [Parameter(Mandatory = $true)] \r   [string]$VMName,\r \r   # The service name that $VMName belongs to.\r   [Parameter(Mandatory = $true)] \r   [string]$ServiceName,\r \r   # The name of the scheduled task.\r   [Parameter(Mandatory = $true)] \r   [string]$TaskName,\r \r   # The name of the \"Stop\" scheduled tasks.\r   [Parameter(Mandatory = $true)] \r   [DateTime]$At\r )\r \r # The script has been tested on Powershell 3.0\r Set-StrictMode -Version 3\r \r # Following modifies the Write-Verbose behavior to turn the messages on globally for this session\r $VerbosePreference = \"Continue\"\r \r # Check if Azure Powershell is avaiable\r if ((Get-Module -ListAvailable Azure) -eq $null)\r {\r   throw \"Azure Powershell not found! Please install from http://www.windowsazure.com/en-us/downloads/#cmd-line-tools\"\r }\r \r # Define a scheduled task to stop the VM(s) on a schedule.\r $stopAzureVM = \"Stop-AzureVM -Name \" + $VMName + \" -ServiceName \" + $ServiceName + \" -Force -Verbose\"\r $stopTaskTrigger = New-ScheduledTaskTrigger -Daily -At $At\r $stopTaskAction = New-ScheduledTaskAction -Execute \"PowerShell.exe\" -Argument $stopAzureVM\r $startTaskSettingsSet = New-ScheduledTaskSettingsSet  -AllowStartIfOnBatteries \r \r $stopScheduledTask = New-ScheduledTask -Action $stopTaskAction -Trigger $stopTaskTrigger -Settings $startTaskSettingsSet\r \r # Register the scheduled tasks to start and stop the VM(s).\r Register-ScheduledTask -TaskName $TaskName -InputObject $stopScheduledTask \r \r </code></pre>\r \r 还是刚才那个文件，右键用 PowerShell 运行，按 PowerShell 提示输入四个必要的参数：\r \r * VMName, 要关闭的 Virtual Machine 名称\r * ServiceName, 关联的服务名称\r * TaskName, 任务名称\r * At，具体操作时间\r \r ![](./media/aog-virtual-machines-how-to-turn-off-vm-automatically/powershell-add-parameter.png)\r \r 然后到计划任务列表里就能刷出这个定时关机的任务了，可以测一下：\r \r ![](./media/aog-virtual-machines-how-to-turn-off-vm-automatically/powershell-add-task-to-system.png)\r \r 到指定时间 powershell 开始执行关闭虚拟机的操作。\r \r ![](./media/aog-virtual-machines-how-to-turn-off-vm-automatically/powershell-turn-down-vm.png)\r \r 到 Portal 里验证一下，已经成功关机了.\r \r ![](./media/aog-virtual-machines-how-to-turn-off-vm-automatically/powershell-turn-down-result.png)"}