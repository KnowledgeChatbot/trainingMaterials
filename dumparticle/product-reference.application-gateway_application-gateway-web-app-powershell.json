{"Title":"通过 Azure 应用程序网关保护 Web 应用 - PowerShell","Description":"本文提供的指南介绍如何在现有的或新的应用程序网关上将 Web应用配置为后端主机。","Content":"# <a name=\"configure-app-service-web-apps-with-application-gateway\"></a>使用应用程序网关配置应用服务 Web 应用 \r \r 可以通过应用程序网关将 Azure Web 应用或其他多租户服务配置为后端池成员。 本文介绍如何通过应用程序网关配置 Azure Web 应用。 第一个示例介绍如何将现有的应用程序网关配置为使用 Web 应用作为后端池成员。 第二个示例介绍如何新建一个将 Web 应用用作后端池成员的应用程序网关。\r \r ## <a name=\"configure-a-web-app-behind-an-existing-application-gateway\"></a>在现有的应用程序网关后面配置 Web 应用\r \r 以下示例将 Web 应用作为后端池成员添加到现有的应用程序网关。 必须在探测配置上提供开关 `-PickHostNamefromBackendHttpSettings` 以及在后端 Http 设置上提供 `-PickHostNameFromBackendAddress`，才能正常运行 Web 应用。\r \r ```powershell\r # FQDN of the web app\r $webappFQDN = \"<enter your webapp FQDN i.e mywebsite.chinacloudsites.cn>\"\r \r # Retrieve an existing application gateway\r $gw = Get-AzureRmApplicationGateway -Name ContosoAppGateway -ResourceGroupName $rg.ResourceGroupName\r \r # Define the status codes to match for the probe\r $match=New-AzureRmApplicationGatewayProbeHealthResponseMatch -StatusCode 200-399\r \r # Add a new probe to the application gateway\r Add-AzureRmApplicationGatewayProbeConfig -name webappprobe2 -ApplicationGateway $gw -Protocol Http -Path / -Interval 30 -Timeout 120 -UnhealthyThreshold 3 -PickHostNameFromBackendHttpSettings -Match $match\r \r # Retrieve the newly added probe\r $probe = Get-AzureRmApplicationGatewayProbeConfig -name webappprobe2 -ApplicationGateway $gw\r \r # Configure an existing backend http settings \r Set-AzureRmApplicationGatewayBackendHttpSettings -Name appGatewayBackendHttpSettings -ApplicationGateway $gw -PickHostNameFromBackendAddress -Port 80 -Protocol http -CookieBasedAffinity Disabled -RequestTimeout 30 -Probe $probe\r \r # Add the web app to the backend pool\r Set-AzureRmApplicationGatewayBackendAddressPool -Name appGatewayBackendPool -ApplicationGateway $gw -BackendFqdns $webappFQDN\r \r # Update the application gateway\r Set-AzureRmApplicationGateway -ApplicationGateway $gw\r ```\r \r ## <a name=\"configure-a-web-application-behind-a-new-application-gateway\"></a>在新的应用程序网关后面配置 Web 应用程序\r \r 此方案部署带 asp.net 入门网站和应用程序网关的 Web 应用。\r \r ```powershell\r # Defines a variable for a dotnet get started web app repository location\r $gitrepo=\"https://github.com/Azure-Samples/app-service-web-dotnet-get-started.git\"\r \r # Unique web app name\r $webappname=\"mywebapp$(Get-Random)\"\r \r # Creates a resource group\r $rg = New-AzureRmResourceGroup -Name ContosoRG -Location \"China North\"\r \r # Create an App Service plan in Free tier.\r New-AzureRmAppServicePlan -Name $webappname -Location \"China North\" -ResourceGroupName $rg.ResourceGroupName -Tier Free\r \r # Creates a web app\r $webapp = New-AzureRmWebApp -ResourceGroupName $rg.ResourceGroupName -Name $webappname -Location \"China North\" -AppServicePlan $webappname\r \r # Configure GitHub deployment from your GitHub repo and deploy once to web app.\r $PropertiesObject = @{\r     repoUrl = \"$gitrepo\";\r     branch = \"master\";\r     isManualIntegration = \"true\";\r }\r Set-AzureRmResource -PropertyObject $PropertiesObject -ResourceGroupName $rg.ResourceGroupName -ResourceType Microsoft.Web/sites/sourcecontrols -ResourceName $webappname/web -ApiVersion 2015-08-01 -Force\r \r # Creates a subnet for the application gateway\r $subnet = New-AzureRmVirtualNetworkSubnetConfig -Name subnet01 -AddressPrefix 10.0.0.0/24\r \r # Creates a vnet for the application gateway\r $vnet = New-AzureRmVirtualNetwork -Name appgwvnet -ResourceGroupName $rg.ResourceGroupName -Location \"China North\" -AddressPrefix 10.0.0.0/16 -Subnet $subnet\r \r # Retrieve the subnet object for use later\r $subnet=$vnet.Subnets[0]\r \r # Create a public IP address\r $publicip = New-AzureRmPublicIpAddress -ResourceGroupName $rg.ResourceGroupName -name publicIP01 -location \"China North\" -AllocationMethod Dynamic\r \r # Create a new IP configuration\r $gipconfig = New-AzureRmApplicationGatewayIPConfiguration -Name gatewayIP01 -Subnet $subnet\r \r # Create a backend pool with the hostname of the web app\r $pool = New-AzureRmApplicationGatewayBackendAddressPool -Name appGatewayBackendPool -BackendFqdns $webapp.HostNames\r \r # Define the status codes to match for the probe\r $match = New-AzureRmApplicationGatewayProbeHealthResponseMatch -StatusCode 200-399\r \r # Create a probe with the PickHostNameFromBackendHttpSettings switch for web apps\r $probeconfig = New-AzureRmApplicationGatewayProbeConfig -name webappprobe -Protocol Http -Path / -Interval 30 -Timeout 120 -UnhealthyThreshold 3 -PickHostNameFromBackendHttpSettings -Match $match\r \r # Define the backend http settings\r $poolSetting = New-AzureRmApplicationGatewayBackendHttpSettings -Name appGatewayBackendHttpSettings -Port 80 -Protocol Http -CookieBasedAffinity Disabled -RequestTimeout 120 -PickHostNameFromBackendAddress -Probe $probeconfig\r \r # Create a new front-end port\r $fp = New-AzureRmApplicationGatewayFrontendPort -Name frontendport01  -Port 80\r \r # Create a new front end IP configuration\r $fipconfig = New-AzureRmApplicationGatewayFrontendIPConfig -Name fipconfig01 -PublicIPAddress $publicip\r \r # Create a new listener using the front-end ip configuration and port created earlier\r $listener = New-AzureRmApplicationGatewayHttpListener -Name listener01 -Protocol Http -FrontendIPConfiguration $fipconfig -FrontendPort $fp\r \r # Create a new rule\r $rule = New-AzureRmApplicationGatewayRequestRoutingRule -Name rule01 -RuleType Basic -BackendHttpSettings $poolSetting -HttpListener $listener -BackendAddressPool $pool \r \r # Define the application gateway SKU to use\r $sku = New-AzureRmApplicationGatewaySku -Name Standard_Small -Tier Standard -Capacity 2\r \r # Create the application gateway\r $appgw = New-AzureRmApplicationGateway -Name ContosoAppGateway -ResourceGroupName $rg.ResourceGroupName -Location \"China North\" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting -Probes $probeconfig -FrontendIpConfigurations $fipconfig  -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener -RequestRoutingRules $rule -Sku $sku\r ```\r \r ## <a name=\"get-application-gateway-dns-name\"></a>获取应用程序网关 DNS 名称\r \r 创建网关后，下一步是配置用于通信的前端。 使用公共 IP 时，应用程序网关需要动态分配的 DNS 名称，这会造成不方便。 若要确保最终用户能够访问应用程序网关，可以使用 CNAME 记录指向应用程序网关的公共终结点。 若要创建别名，可使用附加到应用程序网关的 PublicIPAddress 元素检索应用程序网关及其关联的 IP/DNS 名称的详细信息。 不建议使用 A 记录，因为重新启动应用程序网关后 VIP 可能会变化。\r \r ```powershell\r Get-AzureRmPublicIpAddress -ResourceGroupName ContosoRG -Name publicIP01\r ```\r \r ```\r Name                     : publicIP01\r ResourceGroupName        : ContosoRG\r Location                 : chinanorth\r Id                       : /subscriptions/<subscription_id>/resourceGroups/ContosoRG/providers/Microsoft.Network/publicIPAddresses/publicIP01\r Etag                     : W/\"00000d5b-54ed-4907-bae8-99bd5766d0e5\"\r ResourceGuid             : 00000000-0000-0000-0000-000000000000\r ProvisioningState        : Succeeded\r Tags                     : \r PublicIpAllocationMethod : Dynamic\r IpAddress                : xx.xx.xxx.xx\r PublicIpAddressVersion   : IPv4\r IdleTimeoutInMinutes     : 4\r IpConfiguration          : {\r                                 \"Id\": \"/subscriptions/<subscription_id>/resourceGroups/ContosoRG/providers/Microsoft.Network/applicationGateways/ContosoAppGateway/frontendIP\r                             Configurations/frontend1\"\r                             }\r DnsSettings              : {\r                                 \"Fqdn\": \"00000000-0000-xxxx-xxxx-xxxxxxxxxxxx.chinacloudapp.cn\"\r                             }\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 若要了解如何配置重定向，请访问：[使用 PowerShell 在应用程序网关上配置重定向](application-gateway-configure-redirect-powershell.md)。\r \r <!--Update_Description: wording update-->\r "}