{"Title":"Azure Monitor 自动缩放常见指标","Description":"了解自动缩放云服务、虚拟机和 Web 应用时常用的指标。","Content":"# <a name=\"azure-monitor-autoscaling-common-metrics\"></a>Azure 监视器自动缩放常用指标\r 利用 Azure 监视器自动缩放，可以根据遥测数据（指标）增加或减少正在运行的实例数。 本文档介绍了你可能想要使用的常用指标。 在云服务和服务器场的 Azure 门户中，可以选择要作为缩放依据的资源指标。 不过，也可以选择其他资源的任何指标来作为缩放依据。\r \r Azure 监视器自动缩放仅适用于[虚拟机规模集](/virtual-machine-scale-sets/)、[云服务](/cloud-services/)和[应用服务 - Web 应用](/app-service/web/)。 其他 Azure 服务使用不同的缩放方法。\r \r ## <a name=\"compute-metrics-for-resource-manager-based-vms\"></a>基于 Resource Manager 的 VM 的计算指标\r 默认情况下，基于 Resource Manager 的虚拟机和虚拟机规模集发出基本（主机级）指标。 此外，为 Azure VM 和 VMSS 配置诊断数据集合时，Azure 诊断扩展也会发出来宾 OS性能计数器（通常称为“来宾 OS 指标”）。  可在自动缩放规则中使用所有这些指标。\r \r 可使用 `Get MetricDefinitions` API/PoSH/CLI 查看 VMSS 资源的可用指标。\r \r 如果使用 VM 规模集，而且发现特定指标未列出，则可能是诊断扩展已将其*禁用* 。\r \r 如果特定指标未采样或以所需的频率传输，可以更新诊断配置。\r \r 如果发生上述任一情况，请查看[使用 PowerShell 在运行 Windows 的虚拟机中启用 Azure 诊断](../virtual-machines/windows/ps-extensions-diagnostics.md)，将 Azure VM 诊断扩展配置和更新为启用该指标。 这篇文章还包含一个诊断配置文件示例。\r \r ### <a name=\"host-metrics-for-resource-manager-based-windows-and-linux-vms\"></a>基于 Resource Manager 的 Windows 和 Linux VM 的主机指标\r 默认情况下，将向 Windows 和 Linux 实例中的 Azure VM 和 VMSS 发出以下主机级指标。 这些指标可描述 Azure VM，但这些指标是从 Azure VM 主机而不是通过来宾 VM 上安装的代理收集的。 可在自动缩放规则中使用这些指标。\r \r - [基于 Resource Manager 的 Windows 和 Linux VM 的主机指标](monitoring-supported-metrics.md#microsoftcomputevirtualmachines)\r - [基于 Resource Manager 的 Windows 和 Linux VM 规模集的主机指标](monitoring-supported-metrics.md#microsoftcomputevirtualmachinescalesets)\r \r ### <a name=\"guest-os-metrics-resource-manager-based-windows-vms\"></a>基于 Resource Manager 的 Windows VM 的来宾 OS 指标\r 在 Azure 中创建 VM 时，使用诊断扩展会启用诊断。 诊断扩展会发出一组从 VM 内部获取的指标。 这意味着可以自动缩放不是默认发出的指标。\r \r 可以在 PowerShell 中使用以下命令生成指标列表。\r \r ```\r Get-AzureRmMetricDefinition -ResourceId <resource_id> | Format-Table -Property Name,Unit\r ```\r \r 可以针对下列指标创建警报：\r \r | 指标名称 | 计价单位 |\r | --- | --- |\r | \\Processor(_Total)\\% Processor Time |百分比 |\r | \\Processor(_Total)\\% Privileged Time |百分比 |\r | \\Processor(_Total)\\% User Time |百分比 |\r | \\Processor Information(_Total)\\Processor Frequency |计数 |\r | \\System\\Processes |计数 |\r | \\Process(_Total)\\Thread Count |计数 |\r | \\Process(_Total)\\Handle Count |计数 |\r | \\Memory\\% Committed Bytes In Use |百分比 |\r | \\Memory\\Available Bytes |字节 |\r | \\Memory\\Committed Bytes |字节 |\r | \\Memory\\Commit Limit |字节 |\r | \\Memory\\Pool Paged Bytes |字节 |\r | \\Memory\\Pool Nonpaged Bytes |字节 |\r | \\PhysicalDisk(_Total)\\% Disk Time |百分比 |\r | \\PhysicalDisk(_Total)\\% Disk Read Time |百分比 |\r | \\PhysicalDisk(_Total)\\% Disk Write Time |百分比 |\r | \\PhysicalDisk(_Total)\\Disk Transfers/sec |每秒计数 |\r | \\PhysicalDisk(_Total)\\Disk Reads/sec |每秒计数 |\r | \\PhysicalDisk(_Total)\\Disk Writes/sec |每秒计数 |\r | \\PhysicalDisk(_Total)\\Disk Bytes/sec |每秒字节数 |\r | \\PhysicalDisk(_Total)\\Disk Read Bytes/sec |每秒字节数 |\r | \\PhysicalDisk(_Total)\\Disk Write Bytes/sec |每秒字节数 |\r | \\PhysicalDisk(_Total)\\Avg.磁盘队列长度 |计数 |\r | \\PhysicalDisk(_Total)\\Avg.磁盘读取队列长度 |计数 |\r | \\PhysicalDisk(_Total)\\Avg.磁盘写入队列长度 |计数 |\r | \\LogicalDisk(_Total)\\% Free Space |百分比 |\r | \\LogicalDisk(_Total)\\Free Megabytes |计数 |\r \r ### <a name=\"guest-os-metrics-linux-vms\"></a>Linux VM 的来宾 OS 指标\r 在 Azure 中创建 VM 时，使用诊断扩展会默认启用诊断。\r \r 可以在 PowerShell 中使用以下命令生成指标列表。\r \r ```\r Get-AzureRmMetricDefinition -ResourceId <resource_id> | Format-Table -Property Name,Unit\r ```\r \r  可以针对下列指标创建警报：\r \r | 指标名称 | 计价单位 |\r | --- | --- |\r | \\Memory\\AvailableMemory |字节 |\r | \\Memory\\PercentAvailableMemory |百分比 |\r | \\Memory\\UsedMemory |字节 |\r | \\Memory\\PercentUsedMemory |百分比 |\r | \\Memory\\PercentUsedByCache |百分比 |\r | \\Memory\\PagesPerSec |每秒计数 |\r | \\Memory\\PagesReadPerSec |每秒计数 |\r | \\Memory\\PagesWrittenPerSec |每秒计数 |\r | \\Memory\\AvailableSwap |字节 |\r | \\Memory\\PercentAvailableSwap |百分比 |\r | \\Memory\\UsedSwap |字节 |\r | \\Memory\\PercentUsedSwap |百分比 |\r | \\Processor\\PercentIdleTime |百分比 |\r | \\Processor\\PercentUserTime |百分比 |\r | \\Processor\\PercentNiceTime |百分比 |\r | \\Processor\\PercentPrivilegedTime |百分比 |\r | \\Processor\\PercentInterruptTime |百分比 |\r | \\Processor\\PercentDPCTime |百分比 |\r | \\Processor\\PercentProcessorTime |百分比 |\r | \\Processor\\PercentIOWaitTime |百分比 |\r | \\PhysicalDisk\\BytesPerSecond |每秒字节数 |\r | \\PhysicalDisk\\ReadBytesPerSecond |每秒字节数 |\r | \\PhysicalDisk\\WriteBytesPerSecond |每秒字节数 |\r | \\PhysicalDisk\\TransfersPerSecond |每秒计数 |\r | \\PhysicalDisk\\ReadsPerSecond |每秒计数 |\r | \\PhysicalDisk\\WritesPerSecond |每秒计数 |\r | \\PhysicalDisk\\AverageReadTime |秒 |\r | \\PhysicalDisk\\AverageWriteTime |秒 |\r | \\PhysicalDisk\\AverageTransferTime |秒 |\r | \\PhysicalDisk\\AverageDiskQueueLength |计数 |\r | \\NetworkInterface\\BytesTransmitted |字节 |\r | \\NetworkInterface\\BytesReceived |字节 |\r | \\NetworkInterface\\PacketsTransmitted |计数 |\r | \\NetworkInterface\\PacketsReceived |计数 |\r | \\NetworkInterface\\BytesTotal |字节 |\r | \\NetworkInterface\\TotalRxErrors |计数 |\r | \\NetworkInterface\\TotalTxErrors |计数 |\r | \\NetworkInterface\\TotalCollisions |计数 |\r \r ## <a name=\"commonly-used-web-server-farm-metrics\"></a>常用的 Web（服务器场）指标\r 也可以根据常用的 Web 服务器指标（如 Http 队列长度）执行自动缩放。 其指标名为 **HttpQueueLength**。  以下部分列出了可用的服务器场（Web 应用）指标。\r \r ### <a name=\"web-apps-metrics\"></a>Web 应用指标\r 可以在 PowerShell 中使用以下命令生成 Web 应用指标列表。\r \r ```\r Get-AzureRmMetricDefinition -ResourceId <resource_id> | Format-Table -Property Name,Unit\r ```\r \r 可以针对这些指标发出警报或以其为缩放依据。\r \r | 指标名称 | 计价单位 |\r | --- | --- |\r | CpuPercentage |百分比 |\r | MemoryPercentage |百分比 |\r | DiskQueueLength |计数 |\r | HttpQueueLength |计数 |\r | BytesReceived |字节 |\r | BytesSent |字节 |\r \r ## <a name=\"commonly-used-storage-metrics\"></a>常用的存储指标\r 可以将存储队列长度作为缩放依据，它是存储队列中的消息数目。 存储队列长度是一个特殊指标，阈值是每个实例的消息数。 例如，如果有两个实例并且阈值设置为 100，则当队列中的消息总数为 200 时会进行缩放。 这两个实例的消息数可能各为 100，或分别为 120 和 80，或者为其他相加大于等于 200 的数字组合。\r \r 在 Azure 门户的“设置”边栏选项卡中配置此配置。 若使用 VM 规模集，可以将 Resource Manager 模板中的“自动缩放”设置更新为将 metricName 用作 ApproximateMessageCount，并传递存储队列的 ID 作为 metricResourceUri。\r \r 例如，对于经典存储帐户，自动缩放设置 metricTrigger 将包括：\r \r ```\r \"metricName\": \"ApproximateMessageCount\",\r  \"metricNamespace\": \"\",\r  \"metricResourceUri\": \"/subscriptions/SUBSCRIPTION_ID/resourceGroups/RES_GROUP_NAME/providers/Microsoft.ClassicStorage/storageAccounts/STORAGE_ACCOUNT_NAME/services/queue/queues/QUEUE_NAME\"\r  ```\r \r 对于（非经典）存储帐户，metricTrigger 将包括：\r \r ```\r \"metricName\": \"ApproximateMessageCount\",\r \"metricNamespace\": \"\",\r \"metricResourceUri\": \"/subscriptions/SUBSCRIPTION_ID/resourceGroups/RES_GROUP_NAME/providers/Microsoft.Storage/storageAccounts/STORAGE_ACCOUNT_NAME/services/queue/queues/QUEUE_NAME\"\r ```\r \r ## <a name=\"commonly-used-service-bus-metrics\"></a>常用的服务总线指标\r 可以按服务总线队列的长度进行缩放，该长度是服务总线队列中的消息数量。 服务总线队列长度是一个特殊指标，阈值是每个实例的消息数。 例如，如果有两个实例并且阈值设置为 100，则当队列中的消息总数为 200 时会进行缩放。 这两个实例的消息数可能各为 100，或分别为 120 和 80，或者为其他相加大于等于 200 的数字组合。\r \r 若使用 VM 规模集，可以将 Resource Manager 模板中的“自动缩放”设置更新为将 metricName 用作 ApproximateMessageCount，并传递存储队列的 ID 作为 metricResourceUri。\r \r ```\r \"metricName\": \"MessageCount\",\r  \"metricNamespace\": \"\",\r \"metricResourceUri\": \"/subscriptions/SUBSCRIPTION_ID/resourceGroups/RES_GROUP_NAME/providers/Microsoft.ServiceBus/namespaces/SB_NAMESPACE/queues/QUEUE_NAME\"\r ```\r \r "}