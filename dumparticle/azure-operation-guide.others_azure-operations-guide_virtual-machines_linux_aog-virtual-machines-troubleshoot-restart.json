{"Title":"文件系统损坏导致虚拟机无法正常启动的问题及解决方法","Description":"文件系统损坏导致虚拟机无法正常启动的问题及解决方法","Content":"\r # 文件系统损坏导致虚拟机无法正常启动的问题及解决方法\r \r ## 简介\r \r 计算机的文件系统是一种存储和组织计算机数据的方法，它使得对其访问和查找变得容易，文件系统使用文件和树形目录的抽象逻辑概念代替了硬盘和光盘等物理设备使用数据块的概念，用户使用文件系统来保存数据不必关心数据实际保存在硬盘（或者光盘）的地址为多少的数据块上，只需要记住这个文件的所属目录和文件名。\r \r 在使用中, 会遇到文件系统损坏的故障, 直接导致 Azure 平台的虚拟机无法正常启动和访问, 以下是关于此类问题的描述及解决方法.\r \r 关于文件系统,详情参见如下:\r \r [文件系统](https://zh.wikipedia.org/zh-cn/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F)\r \r >注意:本文档讨论的文件系统以 CentOS 作为范例, 其他版本的 Linux 略有不同, 请注意差别.\r \r ## 文件系统损坏常见问题\r \r **范例1:**\r \r ```\r Checking all file systems.  \r [/sbin/fsck.ext4 (1) -- /] fsck.ext4 -a /dev/sda1  \r /dev/sda1  contains a file system with errors, check forced .   \r /dev/sda1: Inodes that were part of a corrupted orphan linked list found.   \r /dev/sda1: UNEXPECTED INCONSISTENCY; RUN fsck MANUALLY  \r ```\r \r **范例2:**\r \r ```\r EXT4-fs (sda1): INFO: recovery required on readonly filesystem  \r EXT4-fs (sda1): write access will be enabled during recovery  \r EXT4-fs warning (device sda1): ext4_clear_journal_err:4531: Filesystem error recorded from previous mount: IO failure  \r EXT4-fs warning (device sda1): ext4_clear_journal_err:4532: Making fs in need of filesystem check . \r ```\r \r **解决方案之 root 文件系统损坏**  \r **A = 文件系统故障所在的虚拟机**  \r **B = 临时虚拟机**\r \r  1. 在 Azure 经典管理门户上停止运行虚拟机 A.\r  2. 在同一个 cloud service 里创建一台临时 Linux 虚拟机 B.\r  3. 删除虚拟机 A, 但是选择保留磁盘.\r  4. 在 Azure 经典管理门户上,选择虚拟机 B -> 附加磁盘 -> 选择虚拟机 A 的系统磁盘.\r  5. 以管理员身份登陆虚拟机 B.\r  6. 执行: `# fdisk -l`\r  7. 确认虚拟机 A 的系统磁盘作为新的磁盘设备附加在虚拟机 B 上.假定虚拟机A的系统磁盘为 /dev/sdc, root 文件系统为 /dev/sdc1\r  8. 执行以下步骤, 进行备份文件系统信息:  \r \r      ```\r      # fdisk -l /dev/sdc > /var/tmp/fdisk_before.log  \r      # dumpe2fs /dev/sdc1 > /var/tmp/dumpe2fs_before.log  \r      # tune2fs -l /dev/sdc1 > /var/tmp/tune2fs_before.log  \r      # e2fsck -n /dev/sdc1 > /var/tmp/e2fsck._beforelog  \r      ```\r \r  9. 执行以下命令, 进行文件系统修复:  \r \r      ```\r      # fsck -yM /dev/sdc1\r      ```\r \r **解决方案之常规文件系统损坏**  \r **A = 文件系统故障所在的虚拟机**  \r **B = 临时虚拟机**\r \r  1. 在 Azure 经典管理门户上停止运行虚拟机 A.\r  2. 在同一个 cloud service 里创建一台临时 Linux 虚拟机 B.\r  3. 删除虚拟机 A, 但是选择保留磁盘.\r  4. 在 Azure 经典管理门户上,选择虚拟机 B -> 附加磁盘 -> 选择虚拟机 A 的系统磁盘.\r  5. 以管理员身份登陆虚拟机 B.\r  6. 执行: `# fdisk -l`\r  7. 确认虚拟机 A 的系统磁盘作为新的磁盘设备附加在虚拟机 B 上.假定虚拟机 A 的系统磁盘为 /dev/sdc, root 文件系统为 /dev/sdc1\r  8. 执行如下命令,将虚拟机A的系统磁盘挂载到临时虚拟机上: \r \r      ```\r      # mkdir /mnt/temp_fs  \r      # mount /dev/sdc1 /mnt/temp_fs  \r      # cp /mnt/temp_fs/etc/fstab /mnt/temp_fs/etc/fstab.org  \r      # vi /mnt/temp_fs/etc/fstab  \r      将文件系统损坏的条目注释掉,保存修改, 退出 vi.  \r      # umount /dev/sdc1\r      ```\r \r  9. 在 Azure 经典管理门户上分离虚拟机 A 的系统磁盘.\r  10. 在 Azure 经典管理门户上基于虚拟机 A 的系统磁盘, 重建虚拟机 A.\r  11. 以管理员身份登录虚拟机 A.\r  12. 执行以下命令, 进行文件系统修复:  \r \r      ```\r       # fsck -yM <file system>;\r      ```\r \r  13. 文件系统修复完毕以后, 恢复 /etc/fstab 被注释的对应条目, 重启虚拟机."}