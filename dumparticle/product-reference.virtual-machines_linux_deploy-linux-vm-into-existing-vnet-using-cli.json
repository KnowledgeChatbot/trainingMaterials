{"Title":"如何使用 Azure CLI 将 Linux 虚拟机部署到现有 Azure 虚拟网络","Description":"了解如何使用 Azure CLI 2.0 将 Linux 虚拟机部署到现有虚拟网络","Content":"# <a name=\"how-to-deploy-a-linux-virtual-machine-into-an-existing-azure-virtual-network-with-the-azure-cli\"></a>如何使用 Azure CLI 将 Linux 虚拟机部署到现有 Azure 虚拟网络\r \r 本文说明如何使用 Azure CLI 2.0 将虚拟机 (VM) 部署到现有虚拟网络。 要求如下：\r \r - [一个 Azure 帐户](https://www.azure.cn/pricing/1rmb-trial/)\r - [SSH 公钥和私钥文件](mac-create-ssh-keys.md)\r \r 还可以使用 [Azure CLI 1.0](deploy-linux-vm-into-existing-vnet-using-cli-nodejs.md) 执行这些步骤。\r \r ## <a name=\"quick-commands\"></a>快速命令\r 如果需要快速完成任务，以下部分详细介绍所需的命令。 本文档的余下部分（[从此处开始](#detailed-walkthrough)）提供了每个步骤的更详细信息和上下文。\r \r 若要创建此自定义环境，需要安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest)，并使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 在以下示例中，请将示例参数名称替换为你自己的值。 示例参数名称包括 *myResourceGroup*、*myVnet* 和 *myVM*。\r \r **先决条件：**Azure 资源组、虚拟网络和子网、带 SSH 入站的网络安全组以及虚拟网络接口卡。\r \r ### <a name=\"deploy-the-vm-into-the-virtual-network-infrastructure\"></a>将 VM 部署到虚拟网络基础结构中\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --image Debian \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --nics myNic\r ```\r \r ## <a name=\"detailed-walkthrough\"></a>详细演练\r \r 选择静态的、长期存在的且部署频率极低的资源作为 Azure 资产，例如虚拟网络和网络安全组。 部署虚拟网络后，新部署可以重复使用它，而不会对基础结构产生任何负面影响。 可将虚拟网络想像为传统硬件网络交换机 - 不需要为全新的硬件交换机配置每个部署。 正确配置虚拟网络后，在该虚拟网络的整个生命周期中，可继续反复地将新 VM 部署到该虚拟网络，只需做很少的更改（如果有）。\r \r 若要创建此自定义环境，需要安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest#)，并使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r 在以下示例中，请将示例参数名称替换为你自己的值。 示例参数名称包括 *myResourceGroup*、*myVnet* 和 *myVM*。\r \r ## <a name=\"create-the-resource-group\"></a>创建资源组\r \r 首先创建 Azure 资源组，以便整理本演练中创建的所有内容。 有关资源组的详细信息，请参阅 [Azure Resource Manager 概述](../../azure-resource-manager/resource-group-overview.md)。 使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组。 以下示例在“chinaeast”位置创建名为“myResourceGroup”的资源组：\r \r ```azurecli\r az group create \\\r     --name myResourceGroup \\\r     --location chinaeast\r ```\r \r ## <a name=\"create-the-virtual-network\"></a>创建虚拟网络\r \r 现在创建一个 Azure 虚拟网络，以便在其中启动 VM。 有关 Azure 虚拟网络的详细信息，请参阅[使用 Azure CLI 创建虚拟网络](../../virtual-network/virtual-networks-create-vnet-arm-cli.md)。 使用 [az network vnet create](https://docs.azure.cn/zh-cn/cli/network/vnet?view=azure-cli-latest#create) 创建虚拟网络。 以下示例创建名为 *myVnet* 的虚拟网络和名为 *mySubnet* 的子网：\r \r ```azurecli\r az network vnet create \\\r     --resource-group myResourceGroup \\\r     --location chinaeast \\\r     --name myVnet \\\r     --address-prefix 10.10.0.0/16 \\\r     --subnet-name mySubnet \\\r     --subnet-prefix 10.10.1.0/24\r ```\r \r ## <a name=\"create-the-network-security-group\"></a>创建网络安全组\r \r Azure 网络安全组相当于网络层防火墙。 有关网络安全组的详细信息，请参阅[如何在 Azure CLI 中创建网络安全组](../../virtual-network/virtual-networks-create-nsg-arm-cli.md)。 使用 [az network nsg create](https://docs.azure.cn/zh-cn/cli/network/nsg?view=azure-cli-latest#create)创建网络安全组。 以下示例创建名为“myNetworkSecurityGroup”的网络安全组：\r \r ```azurecli\r az network nsg create \\\r     --resource-group myResourceGroup \\\r     --location chinaeast \\\r     --name myNetworkSecurityGroup\r ```\r \r ## <a name=\"add-an-inbound-ssh-allow-rule\"></a>添加入站 SSH 允许规则\r \r VM 需要从 Internet 进行访问，因此需要一个规则，允许端口 22 的入站流量通过网络传递到 VM 上的端口 22。 使用 [az network nsg rule create](https://docs.azure.cn/zh-cn/cli/network/nsg/rule?view=azure-cli-latest#create)为网络安全组添加入站规则。 以下示例创建名为 *myNetworkSecurityGroupRuleSSH* 的规则：\r \r ```azurecli\r az network nsg rule create \\\r     --resource-group myResourceGroup \\\r     --nsg-name myNetworkSecurityGroup \\\r     --name myNetworkSecurityGroupRuleSSH \\\r     --priority 1000 \\\r     --protocol tcp \\\r     --destination-port-range 22 \\\r ```\r \r ## <a name=\"attach-the-subnet-to-the-network-security-group\"></a>将子网附加到网络安全组\r \r 可将网络安全组规则应用到子网或特定的虚拟网络接口。 下面我们将网络安全组附加到子网。 使用 [az network vnet subnet update](https://docs.azure.cn/zh-cn/cli/network/vnet/subnet?view=azure-cli-latest#update)将子网附加到网络安全组：\r \r ```azurecli\r az network vnet subnet update \\\r     --resource-group myResourceGroup \\\r     --vnet-name myVnet \\\r     --name mySubnet \\\r     --network-security-group myNetworkSecurityGroup\r ```\r \r ## <a name=\"add-a-virtual-network-interface-card-to-the-subnet\"></a>将虚拟网络接口卡添加到子网\r \r 虚拟网络接口卡 (VNic) 非常重要，可将它们连接到不同的 VM，因此可以重复使用。 此重复使用特性使用户可以将 VNic 作为静态资源保存，而 VM 可以保存为临时资源。 使用 [az network nic create](https://docs.azure.cn/zh-cn/cli/network/nic?view=azure-cli-latest#create)创建 VNic 并将其与子网关联。 以下示例创建一个名为 *myNic* 的 VNic：\r \r ```azurecli\r az network nic create \\\r     --resource-group myResourceGroup \\\r     --location chinaeast \\\r     --name myNic \\\r     --vnet-name myVnet \\\r     --subnet mySubnet\r ```\r \r ## <a name=\"deploy-the-vm-into-the-virtual-network-infrastructure\"></a>将 VM 部署到虚拟网络基础结构\r \r 现在有一个虚拟网络和一个子网，还有一个网络安全组用于通过阻止所有入站流量（用于 SSH 的端口 22 除外）来保护子网。 现在，可将 VM 部署在这个现有的网络基础结构内。\r \r 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM。 若要详细了解与 Azure CLI 2.0 结合使用以部署完整的 VM 的标志，请参阅[使用 Azure CLI 创建完整的 Linux 环境](create-cli-complete.md)。\r \r 以下示例使用 Azure 托管磁盘创建 VM。 这些磁盘由 Azure 平台处理，无需任何准备或位置来存储它们。 有关托管磁盘的详细信息，请参阅 [Azure 托管磁盘概述](../../storage/storage-managed-disks-overview.md)。 如果想要使用非托管磁盘，请参阅下面的附加说明。\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --image Debian \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --nics myNic\r ```\r \r 如果使用托管磁盘，请跳过此步骤。 如果想要使用非托管磁盘，需将以下附加参数添加到上述命令，在名为 `mystorageaccount`的存储帐户中创建非托管磁盘： \r \r ```azurecli\r     --use-unmanaged-disk \\\r     --storage-account mystorageaccount\r ```\r \r 通过使用 CLI 标志调用现有资源，指示 Azure 将 VM 部署到现有网络中。 部署虚拟网络和子网以后，即可将其作为静态资源或永久资源保留在 Azure 区域内。 此示例中，未为 VNic 创建并分配公共 IP 地址，因此无法通过 Internet 公开访问该 VM。 有关详细信息，请参阅[使用 Azure CLI 创建具有静态公共 IP 的 VM](../../virtual-network/virtual-network-deploy-static-pip-arm-cli.md)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 若要详细了解在 Azure 中创建虚拟机的各种方法，请参阅以下资源：\r \r * [使用 Azure Resource Manager 模板创建特定部署](../windows/cli-deploy-templates.md)\r * [直接使用 Azure CLI 命令创建自定义的 Linux VM 环境](create-cli-complete.md)\r * [使用模板在 Azure 上创建 Linux VM](create-ssh-secured-vm-from-template.md)\r "}