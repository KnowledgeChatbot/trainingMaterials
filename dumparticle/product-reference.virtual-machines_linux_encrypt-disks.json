{"Title":"如何加密 Linux VM 上的虚拟磁盘","Description":"如何使用 Azure CLI 2.0 加密 Linux VM 上的虚拟磁盘以增强安全性","Content":"# <a name=\"how-to-encrypt-virtual-disks-on-a-linux-vm\"></a>如何加密 Linux VM 上的虚拟磁盘\r 为了增强虚拟机 (VM) 的安全性以及符合性，可以加密 Azure 中的虚拟磁盘。 磁盘是使用 Azure 密钥保管库中受保护的加密密钥加密的。 可以控制这些加密密钥，以及审核对它们的使用。 本文介绍如何使用 Azure CLI 2.0 加密 Linux VM 上的虚拟磁盘。 还可以使用 [Azure CLI 1.0](encrypt-disks-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 执行这些步骤。\r \r ## <a name=\"quick-commands\"></a>快速命令\r 如果需要快速完成任务，请参阅以下部分，其中详细说明了用于加密 VM 中虚拟磁盘的基本命令。 本文档的余下部分（[从此处开始](#overview-of-disk-encryption)）提供了每个步骤的更详细信息和上下文。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 需要安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 *myResourceGroup*、*myKey* 和 *myVM*。\r \r 首先，在 Azure 订阅中使用 [az provider register](https://docs.azure.cn/zh-cn/cli/provider?view=azure-cli-latest#register) 启用 Azure Key Vault 提供程序，并使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建一个资源组。 以下示例在 *chinaeast* 位置创建名为 *myResourceGroup* 的资源组。\r \r ```azurecli\r az provider register -n Microsoft.KeyVault\r az group create --name myResourceGroup --location ChinaEast\r ```\r \r 使用 [az keyvault create](https://docs.azure.cn/zh-cn/cli/keyvault?view=azure-cli-latest#create) 创建 Azure Key Vault，并启用 Key Vaul，将其用于磁盘加密。 指定 *keyvault_name* 的唯一 Key Vault 名称，如下所示：\r \r ```azurecli\r keyvault_name=mykeyvaultikf\r az keyvault create \\\r     --name $keyvault_name \\\r     --resource-group myResourceGroup \\\r     --location ChinaEast \\\r     --enabled-for-disk-encryption True\r ```\r \r 使用 [az keyvault key create](https://docs.azure.cn/zh-cn/cli/keyvault/key?view=azure-cli-latest#create) 在 Key Vault 中创建加密密钥。 以下示例创建名为 *myKey* 的密钥：\r \r ```azurecli\r az keyvault key create --vault-name $keyvault_name --name myKey --protection software\r ```\r \r 通过将 Azure Active Directory 与 [az ad sp create-for-rbac](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#create-for-rbac) 配合使用创建服务主体。 服务主体可处理 Key Vault 中的加密密钥的身份验证和交换。 下面的示例读入服务主体 ID 和密码的值，供稍后的命令中使用：\r \r ```azurecli\r read sp_id sp_password <<< $(az ad sp create-for-rbac --query [appId,password] -o tsv)\r ```\r \r 仅在创建服务主体时，输出密码。 如果需要，可查看并记录密码 (`echo $sp_password`)。 可以使用 [az ad sp list](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#list) 列出服务主体并使用 [az ad sp show](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#show) 查看特定服务主体的详细信息。\r \r 使用 [az keyvault set-policy](https://docs.azure.cn/zh-cn/cli/keyvault?view=azure-cli-latest#set-policy) 在 Key Vault 上设置权限。 在以下示例中，服务主体 ID 由上一个命令提供：\r \r ```azurecli\r az keyvault set-policy --name $keyvault_name --spn $sp_id \\\r     --key-permissions wrapKey \\\r     --secret-permissions set\r ```\r \r 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM 并附加一个 5Gb 数据磁盘。 只有特定应用商店映像才支持磁盘加密。 下面的示例使用 **CentOS 7.2n** 映像创建一个名为 `myVM` 的 VM：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --image OpenLogic:CentOS:7.2n:7.2.20160629 \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --data-disk-sizes-gb 5\r ```\r \r 使用上一命令输出中显示的 `publicIpAddress` 通过 SSH 连接到 VM。 创建分区和文件系统，并安装数据磁盘。 有关详细信息，请参阅[连接 Linux VM 以安装新磁盘](add-disk.md?toc=%2fvirtual-machines%2flinux%2ftoc.json#connect-to-the-linux-vm-to-mount-the-new-disk)。 关闭 SSH 会话。\r \r 使用 [az vm encryption enable](https://docs.azure.cn/zh-cn/cli/vm/encryption?view=azure-cli-latest#enable) 加密 VM。 下面的示例使用之前的 `ad sp create-for-rbac` 命令中的 `$sp_id` 和 `$sp_password` 变量：\r \r ```azurecli\r az vm encryption enable \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --aad-client-id $sp_id \\\r     --aad-client-secret $sp_password \\\r     --disk-encryption-keyvault $keyvault_name \\\r     --key-encryption-key myKey \\\r     --volume-type all\r ```\r \r 需要一段时间才能完成磁盘加密过程。 使用 [az vm encryption show](https://docs.azure.cn/zh-cn/cli/vm/encryption?view=azure-cli-latest#show) 监视过程状态：\r \r ```azurecli\r az vm encryption show --resource-group myResourceGroup --name myVM\r ```\r \r 状态显示“EncryptionInProgress”。 请等待，直到 OS 磁盘的状态报告 **VMRestartPending**，并使用 [az vm restart](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#restart) 重启 VM：\r \r ```azurecli\r az vm restart --resource-group myResourceGroup --name myVM\r ```\r \r 磁盘加密过程会在启动过程中完成，因此请等待几分钟后再使用 **az vm encryption show** 查看加密状态：\r \r ```azurecli\r az vm encryption show --resource-group myResourceGroup --name myVM\r ```\r \r 现在，状态应将 OS 磁盘和数据磁盘均报告为 **Encrypted**。\r \r ## <a name=\"overview-of-disk-encryption\"></a>磁盘加密概述\r Linux VM 上的虚拟磁盘是使用 [dm-crypt](https://wikipedia.org/wiki/Dm-crypt) 静态加密的。 加密 Azure 中的虚拟磁盘不会产生费用。 使用软件保护将加密密钥存储在 Azure 密钥保管库中，或者，可在已通过 FIPS 140-2 级别 2 标准认证的硬件安全模块 (HSM) 中导入或生成密钥。 可以控制这些加密密钥，以及审核对它们的使用。 这些加密密钥用于加密和解密附加到 VM 的虚拟磁盘。 打开和关闭 VM 时，Azure Active Directory 服务主体提供一个安全机制用于颁发这些加密密钥。\r \r 加密 VM 的过程如下：\r \r 1. 在 Azure 密钥保管库中创建加密密钥。\r 2. 配置可用于加密磁盘的加密密钥。\r 3. 若要从 Azure Key Vault 中读取加密密钥，可创建具有相应权限的 Azure Active Directory 服务主体。\r 4. 发出加密虚拟磁盘的命令，指定要使用的 Azure Active Directory 服务主体和相应的加密密钥。\r 5. Azure Active Directory 服务主体将从 Azure Key Vault 请求所需的加密密钥。\r 6. 使用提供的加密密钥加密虚拟磁盘。\r \r ## <a name=\"encryption-process\"></a>加密过程\r 磁盘加密依赖于以下附加组件：\r \r * **Azure 密钥保管库** - 用于保护磁盘加密/解密过程中使用的加密密钥和机密。\r   * 可以使用现有的 Azure 密钥保管库（如果有）。 不需要专门使用某个密钥保管库来加密磁盘。\r   * 要将管理边界和密钥可见性隔离开来，可以创建专用的密钥保管库。\r * **Azure Active Directory** - 处理所需加密密钥的安全交换，以及对请求的操作执行的身份验证。\r   * 通常，可以使用现有的 Azure Active Directory 实例来容装应用程序。\r   * 服务主体提供了安全机制，可用于请求和获取相应的加密密钥。 实际并不需要开发与 Azure Active Directory 集成的应用程序。\r \r ## <a name=\"requirements-and-limitations\"></a>要求和限制\r 磁盘加密支持的方案和要求\r \r * 以下 Linux 服务器 SKU - Ubuntu、CentOS、SUSE、SUSE Linux Enterprise Server (SLES) 和 Red Hat Enterprise Linux。\r * 所有资源（例如密钥保管库、存储帐户和 VM）必须在同一个 Azure 区域和订阅中。\r * 标准 A、D 和 DS 系列 VM。\r \r 以下方案目前不支持磁盘加密：\r \r * 基本层 VM。\r * 使用经典部署模型创建的 VM。\r * 在 Linux VM 上禁用 OS 磁盘加密。\r * 在已加密的 Linux VM 上更新加密密钥。\r \r ## <a name=\"create-azure-key-vault-and-keys\"></a>创建 Azure Key Vault 和密钥\r 需要安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 *myResourceGroup*、*myKey* 和 *myVM*。\r \r 第一步是创建用于存储加密密钥的 Azure 密钥保管库。 Azure 密钥保管库可以存储能够在应用程序和服务中安全实现的密钥、机密或密码。 对于虚拟磁盘加密，可以使用密钥保管库来存储用于加密或解密虚拟磁盘的加密密钥。\r \r 在 Azure 订阅中使用 [az provider register](https://docs.azure.cn/zh-cn/cli/provider?view=azure-cli-latest#register) 启用 Azure Key Vault 提供程序，并使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建一个资源组。 以下示例在 `ChinaEast` 位置创建名为 *myResourceGroup* 的资源组：\r \r ```azurecli\r az provider register -n Microsoft.KeyVault\r az group create --name myResourceGroup --location ChinaEast\r ```\r \r 包含加密密钥和关联的计算资源（例如存储和 VM 本身）的 Azure 密钥保管库必须位于同一区域。 使用 [az keyvault create](https://docs.azure.cn/zh-cn/cli/keyvault?view=azure-cli-latest#create) 创建 Azure Key Vault，并启用 Key Vaul，将其用于磁盘加密。 指定 *keyvault_name* 的唯一 Key Vault 名称，如下所示：\r \r ```azurecli\r keyvault_name=myUniqueKeyVaultName\r az keyvault create \\\r     --name $keyvault_name \\\r     --resource-group myResourceGroup \\\r     --location ChinaEast \\\r     --enabled-for-disk-encryption True\r ```\r \r 可以使用软件或硬件安全模型 (HSM) 保护来存储加密密钥。 使用 HSM 时需要高级密钥保管库。 与用于存储受软件保护的密钥的标准密钥保管库不同，创建高级密钥保管库会产生额外的费用。 要创建高级密钥保管库，请在前一步骤中，将 `--sku Premium` 添加到命令。 由于我们创建的是标准密钥保管库，以下示例使用了受软件保护的密钥。\r \r 对于这两种保护模型，在启动 VM 解密虚拟磁盘时，都需要向 Azure 平台授予请求加密密钥的访问权限。 使用 [az keyvault key create](https://docs.azure.cn/zh-cn/cli/keyvault/key?view=azure-cli-latest#create) 在 Key Vault 中创建加密密钥。 以下示例创建名为 *myKey* 的密钥：\r \r ```azurecli\r az keyvault key create --vault-name $keyvault_name --name myKey --protection software\r ```\r \r ## <a name=\"create-the-azure-active-directory-service-principal\"></a>创建 Azure Active Directory 服务主体\r 加密或解密虚拟磁盘时，将指定一个帐户来处理身份验证，以及从 Key Vault 交换加密密钥。 此帐户（Azure Active Directory 服务主体）允许 Azure 平台代表 VM 请求相应的加密密钥。 订阅中提供了一个默认的 Azure Active Directory 实例，不过，许多组织使用专用的 Azure Active Directory 目录。\r \r 通过将 Azure Active Directory 与 [az ad sp create-for-rbac](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#create-for-rbac) 配合使用创建服务主体。 下面的示例读入服务主体 ID 和密码的值，供稍后的命令中使用：\r \r ```azurecli\r read sp_id sp_password <<< $(az ad sp create-for-rbac --query [appId,password] -o tsv)\r ```\r \r 只有创建服务主体时，才会显示密码。 如果需要，可查看并记录密码 (`echo $sp_password`)。 可以使用 [az ad sp list](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#list) 列出服务主体并使用 [az ad sp show](https://docs.azure.cn/zh-cn/cli/ad/sp?view=azure-cli-latest#show) 查看特定服务主体的详细信息。\r \r 要成功加密或解密虚拟磁盘，必须将 Key Vault 中存储的加密密钥的权限设置为允许 Azure Active Directory 服务主体读取密钥。 使用 [az keyvault set-policy](https://docs.azure.cn/zh-cn/cli/keyvault?view=azure-cli-latest#set-policy) 在 Key Vault 上设置权限。 在以下示例中，服务主体 ID 由上一个命令提供：\r \r ```azurecli\r az keyvault set-policy --name $keyvault_name --spn $sp_id \\\r   --key-permissions wrapKey \\\r   --secret-permissions set\r ```\r \r ## <a name=\"create-virtual-machine\"></a>创建虚拟机\r 为了实际加密一些虚拟磁盘，让我们创建一个 VM 并添加一个数据磁盘。 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建要加密的 VM 并附加一个 5Gb 数据磁盘。 只有特定应用商店映像才支持磁盘加密。 以下示例使用 CentOS 7.2n 映像创建一个名为 myVM 的 VM：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --image OpenLogic:CentOS:7.2n:7.2.20160629 \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --data-disk-sizes-gb 5\r ```\r \r 使用上一命令输出中显示的 `publicIpAddress` 通过 SSH 连接到 VM。 创建分区和文件系统，并安装数据磁盘。 有关详细信息，请参阅[连接 Linux VM 以安装新磁盘](add-disk.md?toc=%2fvirtual-machines%2flinux%2ftoc.json#connect-to-the-linux-vm-to-mount-the-new-disk)。 关闭 SSH 会话。\r \r ## <a name=\"encrypt-virtual-machine\"></a>加密虚拟机\r 要加密虚拟磁盘，可将前面的所有组件合并在一起：\r \r 1. 指定 Azure Active Directory 服务主体和密码。\r 2. 指定用于存储加密磁盘元数据的密钥保管库。\r 3. 指定用于实际加密和解密的加密密钥。\r 4. 指定是要加密 OS 磁盘、数据磁盘还是所有磁盘。\r \r 使用 [az vm encryption enable](https://docs.azure.cn/zh-cn/cli/vm/encryption?view=azure-cli-latest#enable) 加密 VM。 下面的示例使用之前的 `ad sp create-for-rbac` 命令中的 `$sp_id` 和 `$sp_password` 变量：\r \r ```azurecli\r az vm encryption enable \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --aad-client-id $sp_id \\\r     --aad-client-secret $sp_password \\\r     --disk-encryption-keyvault $keyvault_name \\\r     --key-encryption-key myKey \\\r     --volume-type all\r ```\r \r 需要一段时间才能完成磁盘加密过程。 使用 [az vm encryption show](https://docs.azure.cn/zh-cn/cli/vm/encryption?view=azure-cli-latest#show) 监视过程状态：\r \r ```azurecli\r az vm encryption show --resource-group myResourceGroup --name myVM\r ```\r \r 输出类似于下面截断的示例：\r \r ```json\r [\r   \"dataDisk\": \"EncryptionInProgress\",\r   \"osDisk\": \"EncryptionInProgress\",\r ]\r ```\r \r 请等待，直到 OS 磁盘的状态报告 **VMRestartPending**，并使用 [az vm restart](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#restart) 重启 VM：\r \r ```azurecli\r az vm restart --resource-group myResourceGroup --name myVM\r ```\r \r 磁盘加密过程会在启动过程中完成，因此请等待几分钟后再使用 **az vm encryption show** 查看加密状态：\r \r ```azurecli\r az vm encryption show --resource-group myResourceGroup --name myVM\r ```\r \r 现在，状态应将 OS 磁盘和数据磁盘均报告为 **Encrypted**。\r \r ## <a name=\"add-additional-data-disks\"></a>添加更多数据磁盘\r 加密数据磁盘后，可将更多的虚拟磁盘添加到 VM 并将其加密。 例如，按如下所示将另一个虚拟磁盘添加到 VM：\r \r ```azurecli\r az vm disk attach-new --resource-group myResourceGroup --vm-name myVM --size-in-gb 5\r ```\r \r 重新运行命令以加密虚拟磁盘，如下所示：\r \r ```azurecli\r az vm encryption enable \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --aad-client-id $sp_id \\\r     --aad-client-secret $sp_password \\\r     --disk-encryption-keyvault $keyvault_name \\\r     --key-encryption-key myKey \\\r     --volume-type all\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r * 有关管理 Azure 密钥保管库的详细信息，包括删除加密密钥和保管库，请参阅 [Manage Key Vault using CLI](../../key-vault/key-vault-manage-with-cli2.md)（使用 CLI 管理密钥保管库）。\r * 有关磁盘加密的详细信息，例如准备要上传到 Azure 的已加密自定义 VM，请参阅 [Azure Disk Encryption](../../security/azure-security-disk-encryption.md)（Azure 磁盘加密）。\r \r <!--Update_Description: update sample from Ubuntu to cent OS-->"}