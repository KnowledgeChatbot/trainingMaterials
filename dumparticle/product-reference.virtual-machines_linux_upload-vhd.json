{"Title":"使用 Azure CLI 2.0 从自定义磁盘创建 Linux VM","Description":"使用资源管理器部署模型和 Azure CLI 2.0 上传或复制自定义的虚拟机","Content":"# <a name=\"create-a-linux-vm-from-custom-disk-with-the-azure-cli-20\"></a>使用 Azure CLI 2.0 从自定义磁盘创建 Linux VM\r \r <!-- rename to create-vm-specialized -->\r \r 本文说明如何在 Azure 中上传自定义的虚拟硬盘 (VHD) 或复制现有 VHD，并从自定义磁盘创建 Linux 虚拟机 (VM)。 可以根据要求安装并配置 Linux 分发版，并使用该 VHD 快速创建新的 Azure 虚拟机。\r \r 如果想要从自定义磁盘创建多个 VM，则应该从 VM 或 VHD 创建映像。 有关详细信息，请参阅[使用 CLI 创建 Azure VM 的自定义映像](tutorial-custom-images.md)。\r \r 可以使用两个选项：\r * [上传 VHD](#option-1-upload-a-specialized-vhd)\r * [复制现有的 Azure VM](#option-2-copy-an-existing-azure-vm)\r \r ## <a name=\"quick-commands\"></a>快速命令\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 从自定义或专用的磁盘创建新 VM 时，请**附加**该磁盘 (--attach-os-disk)，而不要指定自定义映像或 Marketplace 映像 (--image)。 以下示例使用从自定义 VHD 创建的、名为 *myManagedDisk* 的托管磁盘，创建名为 *myVM* 的 VM：\r \r ```azurecli\r az vm create --resource-group myResourceGroup --location chinaeast --name myVM \\\r    --os-type linux --attach-os-disk myManagedDisk\r ```\r \r ## <a name=\"requirements\"></a>要求\r 若要完成以下步骤，需要：\r \r * 已准备好在 Azure 中使用的 Linux 虚拟机。 本文的[准备 VM](#prepare-the-vm) 部分介绍了如何查找有关安装 Azure Linux 代理 (waagent) 的特定于分发版的信息。要使 VM 在 Azure 中正常工作，以及要通过 SSH 连接到 VM，需要用到该代理。\r * 用于将 [Azure 认可的 Linux 分发版](endorsed-distros.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)（或参阅[关于未认可分发版的信息](create-upload-generic.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)）安装到采用 VHD 格式的虚拟磁盘的 VHD 文件。 可使用多种工具创建 VM 和 VHD：\r   * 安装并配置 [QEMU](https://en.wikibooks.org/wiki/QEMU/Installing_QEMU) 或 [KVM](http://www.linux-kvm.org/page/RunningKVM)，并注意使用 VHD 作为映像格式。 如果需要，可以使用 **qemu-img convert** [转换映像](https://en.wikibooks.org/wiki/QEMU/Images#Converting_image_formats)。\r   * 也可以在 [Windows 10](https://msdn.microsoft.com/virtualization/hyperv_on_windows/quick_start/walkthrough_install) 或 [Windows Server 2012/2012 R2](https://technet.microsoft.com/library/hh846766.aspx) 上使用 Hyper-V。\r \r > [!NOTE]\r > Azure 不支持更新的 VHDX 格式。 创建 VM 时，请将 VHD 指定为映像格式。 如果需要，可以使用 [qemu-img convert](https://en.wikibooks.org/wiki/QEMU/Images#Converting_image_formats) 或 [Convert-VHD](https://technet.microsoft.com/library/hh848454.aspx) PowerShell cmdlet 将 VHDX 磁盘转换为 VHD。 此外，Azure 不支持上传动态 VHD，因此，上传之前，需要将此类磁盘转换为静态 VHD。 可以使用 [Azure VHD Utilities for GO](https://github.com/Microsoft/azure-vhd-utils-for-go) 等工具在上传到 Azure 的过程中转换动态磁盘。\r > \r > \r \r * 确保已安装了最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 *myResourceGroup*、*mystorageaccount* 和 *mydisks*。\r \r <a id=\"prepimage\"> </a>\r \r ## <a name=\"prepare-the-vm\"></a>准备 VM\r \r Azure 支持各种 Linux 分发（请参阅[认可的分发](endorsed-distros.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)）。 以下文章指导用户准备 Azure 上支持的各种 Linux 分发版：\r \r * [基于 CentOS 的分发版](create-upload-centos.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [Debian Linux](debian-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [Oracle Linux](oracle-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [Red Hat Enterprise Linux](redhat-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [SLES 和 openSUSE](suse-create-upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [Ubuntu](create-upload-ubuntu.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r * [其他 - 非认可分发版](create-upload-generic.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r \r 另请参阅 [Linux 安装说明](create-upload-generic.md#general-linux-installation-notes)，获取更多有关如何为 Azure 准备 Linux 映像的一般提示。\r \r > [!NOTE]\r > 只有在使用某个认可的分发的时候也使用 [Azure 认可的分发中的 Linux](endorsed-distros.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 中“支持的版本”下指定的配置详细信息时，[Azure 平台 SLA](https://www.azure.cn/support/sla/virtual-machines/) 才适用于运行 Linux 的 VM。\r > \r > \r \r ## <a name=\"option-1-upload-a-vhd\"></a>选项 1：上传 VHD\r \r 可以上传本地计算机上运行的或者从另一个云导出的自定义 VHD。 若要使用 VHD 创建新的 Azure VM，需要将 VHD 上传到存储帐户，并从该 VHD 创建托管磁盘。 \r \r ### <a name=\"create-a-resource-group\"></a>创建资源组\r \r 在上传自定义磁盘和创建 VM 之前，首先需要使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建一个资源组。\r \r 以下示例在 *chinaeast* 位置创建名为 *myResourceGroup* 的资源组：[Azure 托管磁盘概述](../windows/managed-disks-overview.md)\r ```azurecli\r az group create \\\r     --name myResourceGroup \\\r     --location chinaeast\r ```\r \r ### <a name=\"create-a-storage-account\"></a>创建存储帐户\r \r 可以使用 [az storage account create](https://docs.azure.cn/zh-cn/cli/storage/account?view=azure-cli-latest#create)为自定义磁盘和 VM 创建存储帐户。 \r \r 以下示例在前面创建的资源组中创建名为 *mystorageaccount* 的存储帐户：\r \r ```azurecli\r az storage account create \\\r     --resource-group myResourceGroup \\\r     --location chinaeast \\\r     --name mystorageaccount \\\r     --kind Storage \\\r     --sku Standard_LRS\r ```\r \r ### <a name=\"list-storage-account-keys\"></a>列出存储帐户密钥\r Azure 为每个存储帐户生成两个 512 位的访问密钥。 在向存储帐户进行身份验证以执行操作（例如执行写入操作）时，会使用这些访问密钥。 从此处了解有关[管理对存储的访问](../../storage/common/storage-create-storage-account.md#manage-your-storage-account)的详细信息。 可以使用 [az storage account keys list](https://docs.azure.cn/zh-cn/cli/storage/account/keys?view=azure-cli-latest#list)查看访问密钥。\r \r 查看创建的存储帐户的访问密钥：\r \r ```azurecli\r az storage account keys list \\\r     --resource-group myResourceGroup \\\r     --account-name mystorageaccount\r ```\r \r 输出类似于：\r \r ```azurecli\r info:    Executing command storage account keys list\r + Getting storage account keys\r data:    Name  Key                                                                                       Permissions\r data:    ----  ----------------------------------------------------------------------------------------  -----------\r data:    key1  d4XAvZzlGAgWdvhlWfkZ9q4k9bYZkXkuPCJ15NTsQOeDeowCDAdB80r9zA/tUINApdSGQ94H9zkszYyxpe8erw==  Full\r data:    key2  Ww0T7g4UyYLaBnLYcxIOTVziGAAHvU+wpwuPvK4ZG0CDFwu/mAxS/YYvAQGHocq1w7/3HcalbnfxtFdqoXOw8g==  Full\r info:    storage account keys list command OK\r ```\r 记下 **key1**，因为在后续步骤中需要使用它来与存储帐户交互。\r \r ### <a name=\"create-a-storage-container\"></a>创建存储容器\r 在存储帐户中创建用于整理磁盘的容器的方式，与创建各种目录以便有条理地整理本地文件系统的方式相同。 一个存储帐户可以包含任意数目的容器。 可以使用 [az storage container create](https://docs.azure.cn/zh-cn/cli/storage/container?view=azure-cli-latest#create) 创建容器。\r \r 以下示例创建名为 *mydisks* 的容器：\r \r ```azurecli\r az storage container create \\\r     --account-name mystorageaccount \\\r     --name mydisks\r ```\r \r ### <a name=\"upload-the-vhd\"></a>上传 VHD\r 现在，使用 [az storage blob upload](https://docs.azure.cn/zh-cn/cli/storage/blob?view=azure-cli-latest#upload)上传自定义磁盘。 可以页 Blob 的形式上传和存储自定义磁盘。\r \r 指定访问密钥、在上一步中创建的容器，以及自定义磁盘在本地计算机上的路径：\r \r ```azurecli\r az storage blob upload --account-name mystorageaccount \\\r     --account-key key1 \\\r     --container-name mydisks \\\r     --type page \\\r     --file /path/to/disk/mydisk.vhd \\\r     --name myDisk.vhd\r ```\r 上传 VHD 可能需要一些时间。\r \r ### <a name=\"create-a-managed-disk\"></a>创建托管磁盘\r \r 使用 [az disk create](https://docs.azure.cn/zh-cn/cli/disk?view=azure-cli-latest#create) 从 VHD 创建托管磁盘。 以下示例从已上传到命名存储帐户和容器的 VHD 创建名为 *myManagedDisk* 的托管磁盘：\r \r ```azurecli\r az disk create \\\r     --resource-group myResourceGroup \\\r     --name myManagedDisk \\\r     --source https://mystorageaccount.blob.core.chinacloudapi.cn/mydisks/myDisk.vhd\r ```\r ## <a name=\"option-2-copy-an-existing-vm\"></a>选项 2：复制现有 VM\r \r 也可以在 Azure 中创建自定义的 VM，并复制 OS 磁盘并将其附加到新 VM 以创建另一个副本。 这种做法在测试中不会有任何问题，但若要将现有 Azure VM 作为多个新 VM 的模型，则必须改为创建**映像**。 有关从现有 Azure VM 创建映像的详细信息，请参阅[使用 CLI 创建 Azure VM 的自定义映像](tutorial-custom-images.md)\r \r ### <a name=\"create-a-snapshot\"></a>创建快照\r \r 此示例在资源组 *myResourceGroup* 中创建名为 *myVM* 的 VM 的快照，并创建名为 *osDiskSnapshot* 的快照。\r \r ```azure-cli\r osDiskId=$(az vm show -g myResourceGroup -n myVM --query \"storageProfile.osDisk.managedDisk.id\" -o tsv)\r az snapshot create \\\r     -g myResourceGroup \\\r     --source \"$osDiskId\" \\\r     --name osDiskSnapshot\r ```\r ###  <a name=\"create-the-managed-disk\"></a>创建托管磁盘\r \r 从快照创建新的托管磁盘。\r \r 获取快照的 ID。 在此示例中，快照名为 *osDiskSnapshot*，位于 *myResourceGroup* 资源组中。\r \r ```azure-cli\r snapshotId=$(az snapshot show --name osDiskSnapshot --resource-group myResourceGroup --query [id] -o tsv)\r ```\r \r 创建托管磁盘。 在此示例中，我们会在标准存储中从快照创建大小为 128GB、名为 *myManagedDisk* 的托管磁盘。\r \r ```azure-cli\r az disk create \\\r     --resource-group myResourceGroup \\\r     --name myManagedDisk \\\r     --sku Standard_LRS \\\r     --size-gb 128 \\\r     --source $snapshotId\r ```\r \r ## <a name=\"create-the-vm\"></a>创建 VM\r \r 现在，使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM，并将托管磁盘附加为 OS 磁盘 (--attach-os-disk)。 以下示例使用基于上传的 VHD 创建的托管磁盘创建名为 *myNewVM* 的 VM：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --location chinaeast \\\r     --name myNewVM \\\r     --os-type linux \\\r     --attach-os-disk myManagedDisk\r ```\r \r 现在，应该可以使用凭据通过 SSH 从源 VM 连接到该 VM。 \r \r ## <a name=\"next-steps\"></a>后续步骤\r 准备好并上传自定义虚拟磁盘之后，可以阅读有关[使用 Resource Manager 和模板](../../azure-resource-manager/resource-group-overview.md)的详细信息。 可能还需要向新 VM [添加数据磁盘](add-disk.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。 如果需要访问在 VM 上运行的应用程序，请务必[打开端口和终结点](nsg-quickstart.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。\r \r "}