{"Title":"如何使用 Java 操作密钥保管库管理及客户端 API","Description":"如何使用 Java 操作密钥保管库管理及客户端 API","Content":"# 如何使用 Java 操作密钥保管库管理及客户端 API\r \r ## **问题描述**\r \r 在创建 KeyVaultClient 时不能通过 ApplicationTokenCredentials 来进行认证，如何通过 Java 来获取密钥保管库的密钥或机密。\r \r ## **问题分析**\r \r 需要基于 ADAL Library ，通过重写 doAuthenticate 方法来创建 KeyVaultClient 来做认证。\r \r ## **解决方法**\r \r - PowerShell\r \r         Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r         Set-AzureRmContext -SubscriptionId \"sub id\"\r         New-AzureRmKeyVault -VaultName 'geovault02' -ResourceGroupName 'geogroup' -Location 'China North'\r         $securepfxpwd = ConvertTo-SecureString -String '1QAZxsw2' -AsPlainText -Force\r         $key = Add-AzureKeyVaultKey -VaultName 'geovault02' -Name 'key1' -KeyFilePath 'E:\\cer.pfx' -KeyFilePassword $securepfxpwd\r         $Key.key.kid\r         # 授权需要授予 get 权限，否则 Client API 读取时会报告权限问题\r         Set-AzureRmKeyVaultAccessPolicy -VaultName 'geovault02' -ServicePrincipalName ‘Clinet ID’ -PermissionsToKeys decrypt,sign,get\r         Set-AzureRmKeyVaultAccessPolicy -VaultName 'geovault02' -ServicePrincipalName ‘Clinet ID’ -PermissionsToSecrets Get\r \r - Maven Dependency\r \r         <dependency>\r         <groupId>com.microsoft.azure</groupId>\r             <artifactId>azure-keyvault</artifactId>\r             <version>1.0.0</version>\r         </dependency>\r         <dependency>\r             <groupId>com.microsoft.azure</groupId>\r             <artifactId>adal4j</artifactId>\r             <version>1.2.0</version>\r         </dependency>\r \r - Test Class\r \r     public class KeyVaultTest {\r         private ApplicationTokenCredentials tokenCredentials;\r         private KeyVaultClient keyVaultClient;\r         private Azure azure;\r \r         public KeyVaultTest(String clientId, String clientSecret) {\r             try {\r                 keyVaultClient = new KeyVaultClient(new KeyVaultCredentials() {\r                     @Override\r                     public String doAuthenticate(String authorization, String resource, String scope) {\r                         AuthenticationContext context;\r                         try {\r                             context = new AuthenticationContext(authorization, false, Executors.newFixedThreadPool(1));\r                             ClientCredential credentials = new ClientCredential(clientId, clientSecret);\r                             AuthenticationResult result = context.acquireToken(resource, credentials, null).get();\r                             return result.getAccessToken();\r                         } catch (Exception e) {\r                             e.printStackTrace();\r                         }\r                         return \"\";\r                     }\r                 });\r \r                 System.out.println(\"认证成功！\");\r \r             } catch (CloudException e) {\r                 e.printStackTrace();\r             } catch (IOException e) {\r                 e.printStackTrace();\r             }\r         }\r         public void getKey(String keyIdentifier) {\r             KeyBundle keyBundle = keyVaultClient.getKey(keyIdentifier);\r             System.out.println(keyBundle.toString());\r         }\r     }\r \r - Junit Test\r \r         @org.junit.Test\r             public void test(){\r                     KeyVaultTest keyVault = new KeyVaultTest(\r         \"Client ID\", \"Client Secret\");\r                     keyVault.getKey(\r         \"https://geovault02.vault.azure.cn:443/keys/key1\");\r         }\r \r         {\"key\":{\"kid\":\"https://geovault02.vault.azure.cn/keys/key1/a0e2b77b58824f9c96f0f3b1e48e4235\",\"kty\":\"RSA\",\"key_ops\":[\"encrypt\",\"decrypt\",\"sign\",\"verify\",\"wrapKey\",\"unwrapKey\"],\"n\":\"n2eviMHVMcV-HBVxOiqXV1qbxBy9vEW3c_lTv3VwFaqseWIdaTq5UQvZH7QJ-lRJB_CgRpxMansLEc1YlObhcvxQ_ASeuZiHe0MaZz54Ucen-dzWNpdWHGJuSAbL7y1o-_Kqmp3oJ0SfhS8QMruiOIB8AZDE0-rZ-f7H9y0FZbxRh8CjgtfapgU2OL1O4E-RkHqSX7coHo9R1TAfGdQVe9zttFiZQ5NBwQ3G_NHN1x8342zy52VlDASy5xM-LafYQekjSVF1IHFAVlhQ6-LZs4sE70F_9QyNGS56mHgYYI-lHKo5OnfMWtBe4esaanqyMxwXPQMNTPm-sH1SYOyaYQ\",\"e\":\"AQAB\",\"d\":null,\"dp\":null,\"dq\":null,\"qi\":null,\"p\":null,\"q\":null,\"k\":null,\"key_hsm\":null},\"attributes\":{\"enabled\":true,\"nbf\":null,\"exp\":null},\"tags\":null}\r "}