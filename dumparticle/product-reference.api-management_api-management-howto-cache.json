{"Title":"添加缓存以提高 Azure API 管理中的性能","Description":"了解如何改善 API 管理服务调用的延迟、带宽消耗和 web 服务负载。","Content":"# <a name=\"add-caching-to-improve-performance-in-azure-api-management\"></a>添加缓存以提高 Azure API 管理中的性能\r API 管理中的操作可以配置为响应缓存。 响应缓存可以显著减少 API 延迟、带宽消耗和不经常更改数据的 web 服务负载。\r \r 本指南介绍如何为 API 添加响应缓存，以及为示例 Echo API 操作配置策略。 然后，可以从开发人员门户调用操作以确认运行中的缓存。\r \r > [!NOTE]\r > 有关使用策略表达式按密钥缓存项目的信息，请参阅 [Azure API 管理中的自定义缓存](./api-management-sample-cache-by-key.md)。\r > \r > \r \r ## <a name=\"prerequisites\"></a>先决条件\r 执行本指南中的步骤之前，API 管理服务实例必须已配置 API 和产品。 如果尚未创建 API 管理服务实例，请参阅 [Azure API 管理入门][Get started with Azure API Management]教程中的[创建 API 管理服务实例][Create an API Management service instance]。\r \r ## <a name=\"configure-caching\"> </a>为缓存配置操作\r 在此步骤中，将查看示例 Echo API 的“GET 资源(已缓存)”操作的缓存设置。\r \r > [!NOTE]\r > 每个预先配置 Echo API 的 API 管理服务实例，都可用于试验和了解 API 管理。 有关详细信息，请参阅 [Azure API 管理入门][Get started with Azure API Management]。\r > \r > \r \r 若要开始，请单击 Azure 门户中 API 管理服务的“发布者门户”。 这会转到 API 管理发布者门户。\r \r ![发布者门户][api-management-management-console]\r \r 在左侧“API 管理”菜单中，单击“API”，并单击“Echo API”。\r \r ![Echo API][api-management-echo-api]\r \r 单击“操作”选项卡，并在“操作”列表中单击“GET 资源(已缓存)”操作。\r \r ![Echo API 操作][api-management-echo-api-operations]\r \r 单击“缓存”选项卡查看此操作的缓存设置。\r \r ![“缓存”选项卡][api-management-caching-tab]\r \r 要为操作启用缓存，请选中“启用”复选框。 在此示例中，已启用缓存。\r \r 每个操作的响应根据“随查询字符串参数变化”和“随标头变化”字段中的值进行键控。 如果要缓存基于查询字符串参数或标头的多个响应，可以在这两个字段中对它们进行配置。\r \r **持续时间**指定缓存响应的到期时间间隔。 在此示例中，时间间隔是 **3600** 秒，相当于一小时。\r \r 在此示例中使用缓存配置，对“GET 资源(已缓存)”操作的第一个请求将从后端服务返回一个响应。 将缓存此响应，由指定的标头和查询字符串参数进行键控。 采用匹配的参数，对操作的后续调用会返回缓存的响应，直到缓存时间间隔过期。\r \r ## <a name=\"caching-policies\"> </a>查看缓存策略\r 在此步骤中，会查看示例 Echo API 的“GET 资源(已缓存)”操作的缓存设置。\r \r 在“缓存”选项卡上为操作配置缓存设置时，会为操作添加缓存策略。 可以在策略编辑器中查看和编辑这些策略。\r \r 在左侧“API 管理”菜单中单击“策略”，并从“操作”下拉列表中选择“Echo API/GET 资源(已缓存)”。\r \r ![策略范围操作][api-management-operation-dropdown]\r \r 这会在策略编辑器中显示此操作的策略。\r \r ![API 管理策略编辑器][api-management-policy-editor]\r \r 此操作的策略定义包括定义缓存配置的策略，这些策略已在上一步中使用“缓存”选项卡进行审核。\r \r ```xml\r <policies>\r     <inbound>\r         <base />\r         <cache-lookup vary-by-developer=\"false\" vary-by-developer-groups=\"false\">\r             <vary-by-header>Accept</vary-by-header>\r             <vary-by-header>Accept-Charset</vary-by-header>\r         </cache-lookup>\r         <rewrite-uri template=\"/resource\" />\r     </inbound>\r     <outbound>\r         <base />\r         <cache-store caching-mode=\"cache-on\" duration=\"3600\" />\r     </outbound>\r </policies>\r ```\r \r > [!NOTE]\r > 在策略编辑器中对缓存策略进行的更改将反映在操作的“缓存”选项卡中，反之亦然。\r > \r > \r \r ## <a name=\"test-operation\"> </a>调用操作和测试缓存\r 要查看运行中的缓存，我们可以从开发人员门户调用操作。 单击右上方菜单中的“开发人员门户”。\r \r ![开发人员门户][api-management-developer-portal-menu]\r \r 单击顶部菜单中的“API”，并选择“Echo API”。\r \r ![Echo API][api-management-apis-echo-api]\r \r > 如果必须只有一个 API 已配置或对帐户可见，则单击 API 会直接转到该 API 的操作。\r > \r > \r \r 选择“GET 资源(已缓存)”操作，并单击“打开控制台”。\r \r ![打开控制台][api-management-open-console]\r \r 控制台允许直接从开发人员门户调用操作。\r \r ![控制台][api-management-console]\r \r 保留 param1 和 param2 的默认值。\r \r 从“订阅密钥”下拉列表中选择所需的密钥。 如果帐户只有一个订阅，则已处于选中状态。\r \r 在“请求标头”文本框中输入“sampleheader:value1”。\r \r 单击“HTTP Get”并记下响应标头。\r \r 在“请求标头”文本框中输入“sampleheader:value2”，并单击“HTTP Get”。\r \r 请注意，sampleheader 的值仍是响应中的 value1。 尝试一些不同的值，请注意返回来自第一次调用的缓存响应。\r \r 将“25”输入“param2”字段，然后单击“HTTP Get”。\r \r 请注意，响应中 sampleheader 的值现在是 value2。 因为操作结果由查询字符串进行键控，所以没有返回以前缓存的响应。\r \r ## <a name=\"next-steps\"> </a>后续步骤\r * 有关缓存策略的详细信息，请参阅 [API 管理策略参考][API Management policy reference]中的[缓存策略][Caching policies]。\r * 有关使用策略表达式按密钥缓存项目的信息，请参阅 [Azure API 管理中的自定义缓存](./api-management-sample-cache-by-key.md)。\r \r [api-management-management-console]: ./media/api-management-howto-cache/api-management-management-console.png\r [api-management-echo-api]: ./media/api-management-howto-cache/api-management-echo-api.png\r [api-management-echo-api-operations]: ./media/api-management-howto-cache/api-management-echo-api-operations.png\r [api-management-caching-tab]: ./media/api-management-howto-cache/api-management-caching-tab.png\r [api-management-operation-dropdown]: ./media/api-management-howto-cache/api-management-operation-dropdown.png\r [api-management-policy-editor]: ./media/api-management-howto-cache/api-management-policy-editor.png\r [api-management-developer-portal-menu]: ./media/api-management-howto-cache/api-management-developer-portal-menu.png\r [api-management-apis-echo-api]: ./media/api-management-howto-cache/api-management-apis-echo-api.png\r [api-management-open-console]: ./media/api-management-howto-cache/api-management-open-console.png\r [api-management-console]: ./media/api-management-howto-cache/api-management-console.png\r \r \r [How to add operations to an API]: ./api-management-howto-add-operations.md\r [How to add and publish a product]: ./api-management-howto-add-products.md\r [Monitoring and analytics]: ./api-management-monitoring.md\r [Add APIs to a product]: ./api-management-howto-add-products.md#add-apis\r [Publish a product]: ./api-management-howto-add-products.md#publish-product\r [Get started with Azure API Management]: ./api-management-get-started.md\r \r [API Management policy reference]: https://msdn.microsoft.com/library/azure/dn894081.aspx\r [Caching policies]: https://msdn.microsoft.com/library/azure/dn894086.aspx\r \r [Create an API Management service instance]: ./api-management-get-started.md#create-service-instance\r \r [Configure an operation for caching]: #configure-caching\r [Review the caching policies]: #caching-policies\r [Call an operation and test the caching]: #test-operation\r [Next steps]: #next-steps\r "}