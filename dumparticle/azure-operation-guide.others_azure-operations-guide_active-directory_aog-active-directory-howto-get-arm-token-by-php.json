{"Title":"如何通过 PHP 获取 Azure Active Directory 令牌","Description":"通过 PHP 获取 调用 Azure Rest API 所需的 Azure Active Directory 令牌","Content":"\r # 如何通过 PHP 获取 Azure Active Directory 令牌\r \r 在调用 Azure Rest API 时，如果是属于 Azure Resource Manager 的 API，则需要使用 Azure Active Directory (Azure AD)认证获取令牌（Token),然后才能够进行访问。\r \r >[!NOTE]\r >以下认证方式，只适用于 Azure Resource Manager 的 API。 即 endpoint 为 `management.chinacloudapi.cn` 的 API，不适用于 Azure Service Manager 的 API（endpoint 为 `management.core.chinacloudapi.cn` 的 API）。\r \r 以下是创建 Azure AD 应用，并授权其可以访问管理 Azure 的资源的步骤：\r \r ## 登录 Azure 账户（PowerShell）\r \r ![login](./media/aog-active-directory-howto-get-arm-token-by-php/login.jpg)\r \r 记录获取到的 TenantID 以供后续程序使用。\r \r ## 选择当前订阅 ID\r \r 设置当前订阅，多订阅环境下需要执行该步骤 :\r \r ```\r Set-AzureRmContext -SubscriptionId <subscription ID>\r ```\r \r ## 创建 AD 应用\r \r 查看新创建的应用对象，属性 ApplicationId,在后续会用来创建服务凭证，角色设置和 Access Token。\r \r ```\r $azureAdApplication = New-AzureRmADApplication -DisplayName \"exampleapp\" -HomePage \"https://www.contoso.org\" -IdentifierUris \"https://www.contoso.org/example\" -Password \"<Your_Password>\"\r ```\r \r ![new-azurermadapplication](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermadapplication.jpg)\r \r ## 创建服务凭证\r \r Azure AD 应用创建服务凭证:\r \r ```\r New-AzureRmADServicePrincipal -ApplicationId $azureAdApplication.ApplicationId\r ```\r \r ![new-azurermadserviceprincipal.jpg](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermadserviceprincipal.jpg)\r \r 当创建完成服务凭证后，初始是没有任何权限的，我们需要为其设置权限范围。\r \r ## 授权\r \r 为您的服务凭证添加角色设置，在该例中，为您的服务凭证设置访问您订阅下所有资源的读权限。 如果想了解更多内容，请参考：[Azure Role-based Access Control](https://azure.microsoft.com/en-us/documentation/articles/role-based-access-control-what-is/)。\r \r ```\r New-AzureRmRoleAssignment -RoleDefinitionName Contributor -ServicePrincipalName $azureAdApplication.ApplicationId\r ```\r \r 其中 `RoleDefinitionName` 有三种权限设置：\r \r 1. Reader      对Azure资源有读取权限。\r 2. Contributor 对Azure资源有管理权限，但无法授权他人。\r 3. Owner       对Azure资源拥有管理权限，也可以授权他人管理。\r \r ![new-azurermroleassignment](./media/aog-active-directory-howto-get-arm-token-by-php/new-azurermroleassignment.jpg)\r \r ## 调用 Oauth2 API 获取 Token\r \r 这样 Azure AD Application 就创建完成了，我们可以使用以下三个信息，来获取认证的 Token。\r \r 1. telent-id      对应订阅信息上使用的 telentID。\r 2. application-id 创建应用返回的 ApplicationID。\r 3. app password   创建应用时填写的密码。\r \r 获取 Token 的方式，使用 Azure login oauth2 的认证接口，如果想了解更多，请参考此文档：[Using the Azure Resource Manager REST API](https://blogs.msdn.microsoft.com/cloud_solution_architect/2016/02/20/using-the-azure-resource-manager-rest-api/)。\r \r 请参考以下代码：\r \r ```\r $tenlent_id = 'Your Sub Tenlent ID';\r $client_id = 'Application ID';\r $client_secret = 'Application Password';\r \r $auth_url = 'https://login.chinacloudapi.cn/'.$tenlent_id.'/oauth2/token?api-version=1.0';\r $auth = curl_init($auth_url);\r $post_data= 'grant_type=client_credentials&resource=https://management.chinacloudapi.cn/&client_id='.$client_id.'&client_secret='.urlencode($client_secret);\r \r curl_setopt_array($auth, array(\r CURLOPT_VERBOSE => 1,\r CURLOPT_POST => 1,\r CURLOPT_POSTFIELDS => $post_data,\r CURLOPT_SSL_VERIFYPEER => false,\r CURLOPT_SSL_VERIFYHOST => false,\r CURLOPT_HTTPHEADER => array(\r 'Content-Type: application/x-www-form-urlencoded'\r )\r ));\r curl_exec($atuh);\r echo \"\\n\";\r ```\r \r 执行查询后会得到 Token 数据， access_token 即为访问 Token。\r \r ```\r {\r \"token_type\": \"Bearer\",\r \"expires_in\": \"3600\",\r \"expires_on\": \"1455680701\",\r \"not_before\": \"1455676801\",\r \"resource\": \"https://management.azure.com/\",\r \"access_token\": \"eyJ0eXAiOi…\"\r }\r ```\r \r 然后将您要访问的 API 请求头上加上 Authorization 的 Header 设置，并将其值设置为：\r \r ![token](./media/aog-active-directory-howto-get-arm-token-by-php/token.jpg)\r \r >[!NOTE]\r >Token 之前要加上 Bearer。\r \r 调用示例：\r \r ```\r $token = 'eyJ0eXA…';\r $host = 'management.chinacloudapi.cn';\r $version = '2015-09-01';\r $url = 'https://'.$host.'/subscriptions/5bbf0cbb-647d-4bd8-b4e6-26629f109bd7/resourceGroups/Default-MySql-ChinaNorth/providers/Microsoft.MySql/servers/poddbtest/databases/kevintest?api-version='.$version;\r $ch = curl_init($url);\r $data = array(\r 'properties' => array(\r 'charset' => 'utf8',\r 'collation' => 'utf8_general_ci'\r ),\r );\r $json = json_encode($data);\r \r curl_setopt_array($ch, array(\r CURLOPT_VERBOSE => 1,\r CURLOPT_CUSTOMREQUEST => 'PUT',\r CURLOPT_POSTFIELDS => $json,\r CURLOPT_SSL_VERIFYPEER => false,\r CURLOPT_SSL_VERIFYHOST => false,\r CURLOPT_HTTPHEADER => array(\r 'Content-type:application/json',\r 'Authorization:Bearer '.$token\r )\r ));\r \r $ret =curl_exec($ch);\r if (empty($ret)) {\r     // some kind of an error happened\r     echo 'Curl error: ' . curl_error($ch);\r } else {\r     $info = curl_getinfo($ch);\r }\r echo \"\\n\";\r ```"}