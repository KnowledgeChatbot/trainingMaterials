{"Title":"如何在 Azure 中创建具有多个网络接口卡的 Linux 虚拟机","Description":"了解如何使用 Azure CLI 2.0 或 Resource Manager 模板创建具有多个 NIC 的 Linux VM。","Content":"# <a name=\"how-to-create-a-linux-virtual-machine-in-azure-with-multiple-network-interface-cards\"></a>如何在 Azure 中创建具有多个网络接口卡的 Linux 虚拟机\r 可以在 Azure 中创建附有多个虚拟网络接口 (NIC) 的虚拟机 (VM)。 一种常见方案是为前端和后端连接使用不同子网，或为监视或备份解决方案使用一个专用网络。 本文详细介绍如何创建具有多个 NIC 的 VM，以及如何在现有 VM 中添加或删除 NIC。 不同的 [VM 大小](sizes.md)支持不同数目的 NIC，因此请相应地调整 VM 的大小。\r \r 本文详述了如何使用 Azure CLI 2.0 创建具有多个 NIC 的 VM。 还可以使用 [Azure CLI 1.0](multiple-nics-nodejs.md) 执行这些步骤。\r \r ## <a name=\"create-supporting-resources\"></a>创建支持资源\r 安装最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-lates) 并使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 myResourceGroup、mystorageaccount 和 myVM。\r \r 首先，使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组。 以下示例在“chinaeast”位置创建名为“myResourceGroup”的资源组：\r \r ```azurecli\r az group create --name myResourceGroup --location chinaeast\r ```\r \r 使用 [az network vnet create](https://docs.azure.cn/zh-cn/cli/network/vnet?view=azure-cli-latest#create) 创建虚拟网络。 以下示例创建一个名为 myVnet 的虚拟网络和一个名为 mySubnetFrontEnd 的子网：\r \r ```azurecli\r az network vnet create \\\r     --resource-group myResourceGroup \\\r     --name myVnet \\\r     --address-prefix 192.168.0.0/16 \\\r     --subnet-name mySubnetFrontEnd \\\r     --subnet-prefix 192.168.1.0/24\r ```\r \r 使用 [az network vnet subnet create](https://docs.azure.cn/zh-cn/cli/network/vnet/subnet?view=azure-cli-latest#create) 为后端通信流创建子网。 以下示例创建名为 mySubnetBackEnd 的子网：\r \r ```azurecli\r az network vnet subnet create \\\r     --resource-group myResourceGroup \\\r     --vnet-name myVnet \\\r     --name mySubnetBackEnd \\\r     --address-prefix 192.168.2.0/24\r ```\r \r 使用 [az network nsg create](https://docs.azure.cn/zh-cn/cli/network/nsg?view=azure-cli-latest#create) 创建网络安全组。 以下示例创建名为“myNetworkSecurityGroup”的网络安全组：\r \r ```azurecli\r az network nsg create \\\r     --resource-group myResourceGroup \\\r     --name myNetworkSecurityGroup\r ```\r \r ## <a name=\"create-and-configure-multiple-nics\"></a>创建和配置多个 NIC\r 使用 [az network nic create](https://docs.azure.cn/zh-cn/cli/network/nic?view=azure-cli-latest#create) 创建两个 NIC。 以下示例创建两个连接到网络安全组的 NIC（名为 myNic1 和 myNic2），其中一个 NIC 连接到每个子网：\r \r ```azurecli\r az network nic create \\\r     --resource-group myResourceGroup \\\r     --name myNic1 \\\r     --vnet-name myVnet \\\r     --subnet mySubnetFrontEnd \\\r     --network-security-group myNetworkSecurityGroup\r az network nic create \\\r     --resource-group myResourceGroup \\\r     --name myNic2 \\\r     --vnet-name myVnet \\\r     --subnet mySubnetBackEnd \\\r     --network-security-group myNetworkSecurityGroup\r ```\r \r ## <a name=\"create-a-vm-and-attach-the-nics\"></a>创建 VM 并附加 NIC\r 创建 VM 时，请使用 `--nics`指定所创建的 NIC。 还需要谨慎选择 VM 的大小。 可添加到 VM 的 NIC 数目有限制。 详细了解 [Linux VM 大小](sizes.md)。 \r \r 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM。 以下示例创建一个名为 myVM 的 VM：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --image UbuntuLTS \\\r     --size Standard_DS3_v2 \\\r     --admin-username azureuser \\\r     --generate-ssh-keys \\\r     --nics myNic1 myNic2\r ```\r \r ## <a name=\"add-a-nic-to-a-vm\"></a>将 NIC 添加到 VM\r 之前的步骤创建了具有多个 NIC 的 VM。 还可使用 Azure CLI 2.0 将 NIC 添加到现有 VM。 不同的 [VM 大小](sizes.md)支持不同数目的 NIC，因此请相应地调整 VM 的大小。 如果需要，可[调整 VM 的大小](change-vm-size.md)。\r \r 使用 [az network nic create](https://docs.azure.cn/zh-cn/cli/network/nic?view=azure-cli-latest#create) 创建另一 NIC。 以下示例创建一个名为 myNic3 的 NIC，该 NIC 连接到后端子网和之前步骤中创建的网络安全组：\r \r ```azurecli\r az network nic create \\\r     --resource-group myResourceGroup \\\r     --name myNic3 \\\r     --vnet-name myVnet \\\r     --subnet mySubnetBackEnd \\\r     --network-security-group myNetworkSecurityGroup\r ```\r \r 若要将 NIC 添加到现有 VM，请先使用 [az vm deallocate](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#deallocate) 解除分配 VM。 以下示例解除分配名为 myVM 的 VM：\r \r ```azurecli\r az vm deallocate --resource-group myResourceGroup --name myVM\r ```\r \r 使用 [az vm nic add](https://docs.azure.cn/zh-cn/cli/vm/nic?view=azure-cli-latest#add) 添加 NIC。 以下示例将 myNic3 添加到 myVM：\r \r ```azurecli\r az vm nic add \\\r     --resource-group myResourceGroup \\\r     --vm-name myVM \\\r     --nics myNic3\r ```\r \r 使用 [az vm start](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#start) 启动 VM：\r \r ```azurecli\r az vm start --resource-group myResourceGroup --name myVM\r ```\r \r ## <a name=\"remove-a-nic-from-a-vm\"></a>从 VM 中删除 NIC\r 若要从现有 VM 中删除 NIC，请先使用 [az vm deallocate](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#deallocate) 解除分配 VM。 以下示例解除分配名为 myVM 的 VM：\r \r ```azurecli\r az vm deallocate --resource-group myResourceGroup --name myVM\r ```\r \r 使用 [az vm nic remove](https://docs.azure.cn/zh-cn/cli/vm/nic?view=azure-cli-latest#remove) 删除 NIC。 以下示例从 myVM 中删除 myNic3：\r \r ```azurecli\r az vm nic remove \\\r     --resource-group myResourceGroup \\\r     --vm-name myVM \\\r     --nics myNic3\r ```\r \r 使用 [az vm start](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#start) 启动 VM：\r \r ```azurecli\r az vm start --resource-group myResourceGroup --name myVM\r ```\r \r ## <a name=\"create-multiple-nics-using-resource-manager-templates\"></a>使用 Resource Manager 模板创建多个 NIC\r Azure Resource Manager 模板使用声明性 JSON 文件来定义环境。 可以阅读 [Azure Resource Manager 概述](../../azure-resource-manager/resource-group-overview.md)。 Resource Manager 模板可让你在部署期间创建资源的多个实例，例如，创建多个 NIC。 使用 *copy* 指定要创建的实例数：\r \r ```json\r \"copy\": {\r     \"name\": \"multiplenics\"\r     \"count\": \"[parameters('count')]\"\r }\r ```\r \r 阅读有关[使用 *copy* 创建多个实例](../../resource-group-create-multiple.md)的详细信息。 \r \r 也可以使用 `copyIndex()` 并在资源名称中追加一个数字，来创建 `myNic1`、`myNic2`，等等。下面显示了追加索引值的示例：\r \r ```json\r \"name\": \"[concat('myNic', copyIndex())]\", \r ```\r \r 可以阅读[使用 Resource Manager 模板创建多个 NIC](../../virtual-network/virtual-network-deploy-multinic-arm-template.md) 的完整示例。\r \r ## <a name=\"configure-guest-os-for-multiple-nics\"></a>为多个 NIC 配置来宾 OS\r 将多个 NIC 添加到一个 Linux VM 时，需要创建路由规则。 这些规则允许此 VM 发送和接收属于特定 NIC 的流量。 否则，所定义的默认路由无法正确处理属于 eth1 等的流量。\r \r 若要纠正此路由问题，请首先向 /etc/iproute2/rt_tables 添加两个路由表，如下所示：\r \r ```bash\r echo \"200 eth0-rt\" >> /etc/iproute2/rt_tables\r echo \"201 eth1-rt\" >> /etc/iproute2/rt_tables\r ```\r \r 要使更改长久有效并在网络堆栈激活期间应用，请编辑 /etc/sysconfig/network-scipts/ifcfg-eth0 和 /etc/sysconfig/network-scipts/ifcfg-eth1。 将行“NM_CONTROLLED=yes”更改为“NM_CONTROLLED=no”。 如不执行此步骤，则不会自动应用其他规则/路由。\r \r 然后扩展路由表。 假设已进行了如下设置：\r \r *路由*\r \r ```bash\r default via 10.0.1.1 dev eth0 proto static metric 100\r 10.0.1.0/24 dev eth0 proto kernel scope link src 10.0.1.4 metric 100\r 10.0.1.0/24 dev eth1 proto kernel scope link src 10.0.1.5 metric 101\r 168.63.129.16 via 10.0.1.1 dev eth0 proto dhcp metric 100\r 169.254.169.254 via 10.0.1.1 dev eth0 proto dhcp metric 100\r ```\r \r *接口*\r \r ```bash\r lo: inet 127.0.0.1/8 scope host lo\r eth0: inet 10.0.1.4/24 brd 10.0.1.255 scope global eth0    \r eth1: inet 10.0.1.5/24 brd 10.0.1.255 scope global eth1\r ```\r \r 然后，创建以下文件，并对每个文件添加相应的规则和路由：\r \r - /etc/sysconfig/network-scripts/rule-eth0\r \r     ```bash\r     from 10.0.1.4/32 table eth0-rt\r     to 10.0.1.4/32 table eth0-rt\r     ```\r \r - /etc/sysconfig/network-scripts/route-eth0\r \r     ```bash\r     10.0.1.0/24 dev eth0 table eth0-rt\r     default via 10.0.1.1 dev eth0 table eth0-rt\r     ```\r \r - /etc/sysconfig/network-scripts/rule-eth1\r \r     ```bash\r     from 10.0.1.5/32 table eth1-rt\r     to 10.0.1.5/32 table eth1-rt\r     ```\r \r - /etc/sysconfig/network-scripts/route-eth1\r \r     ```bash\r     10.0.1.0/24 dev eth1 table eth1-rt\r     default via 10.0.1.1 dev eth1 table eth1-rt\r     ```\r \r 若要应用更改，请重启网络服务，如下所示：\r \r ```bash\r systemctl restart network\r ```\r \r 路由规则现已准备就绪，可根据需要连接到任一接口。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 尝试创建具有多个 NIC 的 VM 时，请查看 [Lnux VM 大小](sizes.md)。 注意每个 VM 大小支持的 NIC 数目上限。\r \r <!--Update_Description: update meta properties, wording update, update link-->"}