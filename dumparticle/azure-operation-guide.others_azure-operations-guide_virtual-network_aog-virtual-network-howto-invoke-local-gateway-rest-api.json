{"Title":"Java 调用虚拟网络本地网关的 REST API","Description":"通过 Java 调用虚拟网络网关的 REST API 获取本地网关信息","Content":"\r # Java 调用虚拟网络本地网关的 REST API\r \r ## 准备工作\r \r 首先在 Azure 中创建好虚拟网络本地网关。\r \r ## 解决方法\r \r 1. 获取 Token :\r \r         {\r             this.tokenCredentials = new ApplicationTokenCredentials(clientId, tentant, clientSecret,\r             AzureEnvironment.AZURE_CHINA).withDefaultSubscriptionId(subId);                   \r                             \r             AzureEnvironment environment = tokenCredentials.getEnvironment();\r             String loginUrl = environment.getAuthenticationEndpoint();\r             String managementUrl = \"https://management.chinacloudapi.cn/\"; \r             String tenantId = tokenCredentials.getDomain();\r             String clientId1 = tokenCredentials.getClientId();\r             String secret = tokenCredentials.getSecret();\r             String accessToken = null;\r             URL url = new URL(String.format(loginUrl + \"%s/oauth2/token?api-version=1.0\", tenantId));\r             System.out.println(url.toString());\r             HttpsURLConnection conn = (HttpsURLConnection) url.openConnection();\r             conn.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\r             conn.setDoOutput(true);\r             DataOutputStream output = new DataOutputStream(conn.getOutputStream());\r             byte[] data = String.format(\"grant_type=client_credentials&resource=%s&client_id=%s&client_secret=%s\",managementUrl, clientId, URLEncoder.encode(secret, \"UTF-8\")).getBytes();\r             if (data != null)\r                 output.write(data);\r             output.flush();\r             output.close();\r             InputStream input = conn.getErrorStream();\r             if (input == null)\r                 input = conn.getInputStream();\r             String response = null;\r             try (Scanner scanner = new Scanner(input)) {\r                 scanner.useDelimiter(\"\\\\Z\");\r                 response = scanner.next();\r                 scanner.close();\r                 input.close();\r             }\r                 \r             if (response != null) {\r                 JSONObject json = mapper.readValue(response, JSONObject.class);\r                 Object obj = json.get(\"access_token\");\r                 accessToken = (obj == null ? null : obj.toString());\r             }\r             getRest(accessToken);\r         }\r \r 2. 调用虚拟网络网关 REST API：\r \r         public void getRest(String token) throws URISyntaxException, IOException{\r             String resourceManagerUrl = \"https://management.chinacloudapi.cn\";\r             String[] str = resourceManagerUrl.split(\"://\");\r             String scheme = str[0], authority = str[1], filter = \"api-version=\" + \"2017-03-01\";\r             String requestUrl = String.format(\"/subscriptions/%s/resourceGroups/%s/providers/Microsoft.Network/localNetworkGateways/%s?\",\r                     \"subid\", \"vik1\", \"vikd3\");\r                 \r             URL url2 = new URI(scheme, authority, requestUrl, filter, null).toURL();\r             System.out.println(url2.toString());\r             HttpsURLConnection conn2 = (HttpsURLConnection) url2.openConnection();\r             conn2.setRequestProperty(\"Authorization\", \"Bearer \" + token);\r             int responseCode = conn2.getResponseCode();\r             InputStream input2 = conn2.getErrorStream();\r             if (input2 == null) {\r                 input2 = conn2.getInputStream();\r             }\r                     \r             String response2 = null;\r             try (Scanner scanner2 = new Scanner(input2)) {\r                 scanner2.useDelimiter(\"\\\\Z\");\r                 response2 = scanner2.next();\r                 scanner2.close();\r                 input2.close();\r             }\r             if (responseCode != 200) {\r                 throw new RuntimeException(response2);\r             }\r         }\r \r 返回结果如下：\r \r ![result](media/aog-virtual-network-howto-invoke-local-gateway-rest-api/result.png)"}