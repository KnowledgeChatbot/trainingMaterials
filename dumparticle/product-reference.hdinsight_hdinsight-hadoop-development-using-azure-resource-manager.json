{"Title":"迁移到适用于 HDInsight 的 Azure Resource Manager 工具","Description":"如何迁移到适用于 HDInsight 群集的 Azure Resource Manager 开发工具","Content":"# <a name=\"migrating-to-azure-resource-manager-based-development-tools-for-hdinsight-clusters\"></a>迁移到适用于 HDInsight 群集的基于 Azure Resource Manager 的开发工具\r \r HDInsight 即将淘汰适用于 HDInsight 的基于 Azure 服务管理器 (ASM) 的工具。 如果你一直在使用 Azure PowerShell、Azure CLI 或 HDInsight.NET SDK 处理 HDInsight 群集，我们建议你今后使用基于 Azure Resource Manager (ARM) 的 PowerShell、CLI 和.NET SDK 版本。 本文章提供有关如何迁移到基于 ARM 的新方法的指导。 本文还将指出适用于 HDInsight 的 ASM 与 ARM 方法之间的差异（如果适用）。\r \r > [!IMPORTANT]\r > 2017 年 1 月 1 日，对基于 ASM 的 PowerShell、CLI 和 .NET SDK 的支持将会终止。\r > \r > \r \r ## <a name=\"migrating-azure-cli-to-azure-resource-manager\"></a>将 Azure CLI 迁移到 Azure Resource Manager\r Azure CLI 目前默认为 Azure Resource Manager (ARM) 模式，但如果从以前的安装版本升级则例外，在此情况下，可能需要使用 `azure config mode arm` 命令切换到 ARM 模式。\r \r Azure CLI 提供的用于通过 Azure 服务管理 (ASM) 使用 HDInsight 的基本命令与使用 ARM 时相同；不过，某些参数和开关可能有新名称，并且在使用 ARM 时，有许多新参数可供使用。 例如，现在可以使用 `azure hdinsight cluster create` 指定创建群集所在的 Azure 虚拟网络，或者 Hive 和 Oozie 的元存储信息。\r \r 用于通过 Azure Resource Manager 使用 HDInsight 的基本命令包括：\r \r * `azure hdinsight cluster create` - 创建新的 HDInsight 群集\r * `azure hdinsight cluster delete` - 删除现有 HDInsight 群集\r * `azure hdinsight cluster show` - 显示有关现有群集的信息\r * `azure hdinsight cluster list` - 列出 Azure 订阅的 HDInsight 群集\r \r 使用 `-h` 开关可以检查每个命令可用的参数和开关。\r \r ### <a name=\"new-commands\"></a>新命令\r 可用于 Azure Resource Manager 的新命令包括：\r \r * `azure hdinsight cluster resize` - 动态更改群集中的辅助角色节点数目\r * `azure hdinsight cluster enable-http-access` - 启用对群集的 HTTPs 访问（默认为打开）\r * `azure hdinsight cluster disable-http-access` - 禁用对群集的 HTTPs 访问\r * `azure hdinsight script-action` - 在群集上提供用于创建/管理脚本操作的命令\r * `azure hdinsight config` - 提供用于创建配置文件的命令，该配置文件可与 `hdinsight cluster create` 命令一起使用，提供配置信息。\r \r ### <a name=\"deprecated-commands\"></a>已弃用的命令\r 如果使用 `azure hdinsight job` 命令将作业提交到 HDInsight 群集，则无法通过 ARM 命令使用这些作业。 如果需要以编程方式通过脚本将作业提交到 HDInsight，应改用 HDInsight 提供的 REST API。 有关如何使用 REST API 提交作业的详细信息，请参阅以下文档。\r \r * [使用 cURL 通过 HDInsight 上的 Hadoop 运行 MapReduce 作业](hadoop/apache-hadoop-use-mapreduce-curl.md)\r * [使用 cURL 通过 HDInsight 上的 Hadoop 运行 Hive 查询](hadoop/apache-hadoop-use-hive-curl.md)\r * [使用 cURL 通过HDInsight 上的 Hadoop 运行 Pig 作业](hadoop/apache-hadoop-use-pig-curl.md)\r \r 有关以其他交互方式运行 MapReduce、Hive 和 Pig 的信息，请参阅[对 HDInsight 上的 Hadoop 使用 MapReduce](hadoop/hdinsight-use-mapreduce.md)、[对 HDInsight 上的 Hadoop 使用 Hive](hadoop/hdinsight-use-hive.md)和[对 HDInsight 上的 Hadoop 使用 Pig](hadoop/hdinsight-use-pig.md)。\r \r ### <a name=\"examples\"></a>示例\r 创建群集\r \r * 旧命令 (ASM) - `azure hdinsight cluster create myhdicluster --location northeurope --osType linux --storageAccountName mystorage --storageAccountKey <storagekey> --storageContainer mycontainer --userName admin --password mypassword --sshUserName sshuser --sshPassword mypassword`\r * 新命令 (ARM) - `azure hdinsight cluster create myhdicluster -g myresourcegroup --location northeurope --osType linux --clusterType hadoop --defaultStorageAccountName mystorage --defaultStorageAccountKey <storagekey> --defaultStorageContainer mycontainer --userName admin -password mypassword --sshUserName sshuser --sshPassword mypassword`\r \r 删除群集\r \r * 旧命令 (ASM) - `azure hdinsight cluster delete myhdicluster`\r * 新命令 (ARM) - `azure hdinsight cluster delete mycluster -g myresourcegroup`\r \r 列出群集\r \r * 旧命令 (ASM) - `azure hdinsight cluster list`\r * 新命令 (ARM) - `azure hdinsight cluster list`\r \r > [!NOTE]\r > 运行 list 命令时，使用 `-g` 指定资源组只会返回指定资源组中的群集。\r > \r > \r \r 显示群集信息\r \r * 旧命令 (ASM) - `azure hdinsight cluster show myhdicluster`\r * 新命令 (ARM) - `azure hdinsight cluster show myhdicluster -g myresourcegroup`\r \r ## <a name=\"migrating-azure-powershell-to-azure-resource-manager\"></a>将 Azure PowerShell 迁移到 Azure Resource Manager\r 有关处于 Azure 资源管理器 (ARM) 模式的 Azure PowerShell 的一般信息，请参阅[将 Azure PowerShell 与 Azure 资源管理器配合使用](../powershell-azure-resource-manager.md)。\r \r Azure PowerShell ARM cmdlet 可与 ASM cmdlet 一同安装。 两种模式下的 cmdlet 可按其名称来区分。  ARM 模式下的 cmdlet 名称中包含 AzureRmHDInsight，而在 ASM 模式下则包含 AzureHDInsight。  例如，前者为 New-AzureRmHDInsightCluster，后者为New-AzureHDInsightCluster。 某些参数和开关可能有新名称，并且在使用 ARM 时，有许多新参数可供使用。  例如，多个 cmdlet 需要名为 -ResourceGroupName 的新开关。 \r \r 在使用这些 HDInsight cmdlet 之前，必须先连接到 Azure 帐户并创建新资源组：\r \r * Login-AzureRmAccount -EnvironmentName AzureChinaCloud 或 [Select-AzureRmProfile](https://msdn.microsoft.com/library/mt619310.aspx). 请参阅[使用 Azure Resource Manager 对服务主体进行身份验证](../azure-resource-manager/resource-group-authenticate-service-principal.md)\r * [New-AzureRmResourceGroup](https://msdn.microsoft.com/library/mt603739.aspx)\r \r ### <a name=\"renamed-cmdlets\"></a>已重命名的 cmdlet\r 在 Windows PowerShell 控制台中列出 HDInsight ASM cmdlet：\r \r     help *azurermhdinsight*\r \r 下表列出了 ASM cmdlet 及其在 ARM 模式下的名称：\r \r | ASM cmdlet | ARM cmdlet |\r | --- | --- |\r | Add-AzureHDInsightConfigValues |[Add-AzureRmHDInsightConfigValues](https://msdn.microsoft.com/library/mt603530.aspx) |\r | Add-AzureHDInsightMetastore |[Add-AzureRmHDInsightMetastore](https://msdn.microsoft.com/library/mt603670.aspx) |\r | Add-AzureHDInsightScriptAction |[Add-AzureRmHDInsightScriptAction](https://msdn.microsoft.com/library/mt603527.aspx) |\r | Add-AzureHDInsightStorage |[Add-AzureRmHDInsightStorage](https://msdn.microsoft.com/library/mt619445.aspx) |\r | Get-AzureHDInsightCluster |[Get-AzureRmHDInsightCluster](https://msdn.microsoft.com/library/mt619371.aspx) |\r | Get-AzureHDInsightJob |[Get-AzureRmHDInsightJob](https://msdn.microsoft.com/library/mt603590.aspx) |\r | Get-AzureHDInsightJobOutput |[Get-AzureRmHDInsightJobOutput](https://msdn.microsoft.com/library/mt603793.aspx) |\r | Get-AzureHDInsightProperties |[Get-AzureRmHDInsightProperties](https://msdn.microsoft.com/library/mt603546.aspx) |\r | Grant-AzureHDInsightHttpServicesAccess |[Grant-AzureRmHDInsightHttpServicesAccess](https://msdn.microsoft.com/library/mt619407.aspx) |\r | Grant-AzureHdinsightRdpAccess |[Grant-AzureRmHDInsightRdpServicesAccess](https://msdn.microsoft.com/library/mt603717.aspx) |\r | Invoke-AzureHDInsightHiveJob |[Invoke-AzureRmHDInsightHiveJob](https://msdn.microsoft.com/library/mt603593.aspx) |\r | New-AzureHDInsightCluster |[New-AzureRmHDInsightCluster](https://msdn.microsoft.com/library/mt619331.aspx) |\r | New-AzureHDInsightClusterConfig |[New-AzureRmHDInsightClusterConfig](https://msdn.microsoft.com/library/mt603700.aspx) |\r | New-AzureHDInsightHiveJobDefinition |[New-AzureRmHDInsightHiveJobDefinition](https://msdn.microsoft.com/library/mt619448.aspx) |\r | New-AzureHDInsightMapReduceJobDefinition |[New-AzureRmHDInsightMapReduceJobDefinition](https://msdn.microsoft.com/library/mt603626.aspx) |\r | New-AzureHDInsightPigJobDefinition |[New-AzureRmHDInsightPigJobDefinition](https://msdn.microsoft.com/library/mt603671.aspx) |\r | New-AzureHDInsightSqoopJobDefinition |[New-AzureRmHDInsightSqoopJobDefinition](https://msdn.microsoft.com/library/mt608551.aspx) |\r | New-AzureHDInsightStreamingMapReduceJobDefinition |[New-AzureRmHDInsightStreamingMapReduceJobDefinition](https://msdn.microsoft.com/library/mt603626.aspx) |\r | Remove-AzureHDInsightCluster |[Remove-AzureRmHDInsightCluster](https://msdn.microsoft.com/library/mt619431.aspx) |\r | Revoke-AzureHDInsightHttpServicesAccess |[Revoke-AzureRmHDInsightHttpServicesAccess](https://msdn.microsoft.com/library/mt619375.aspx) |\r | Revoke-AzureHdinsightRdpAccess |[Revoke-AzureRmHDInsightRdpServicesAccess](https://msdn.microsoft.com/library/mt603523.aspx) |\r | Set-AzureHDInsightClusterSize |[Set-AzureRmHDInsightClusterSize](https://msdn.microsoft.com/library/mt603513.aspx) |\r | Set-AzureHDInsightDefaultStorage |[Set-AzureRmHDInsightDefaultStorage](https://msdn.microsoft.com/library/mt603486.aspx) |\r | Start-AzureHDInsightJob |[Start-AzureRmHDInsightJob](https://msdn.microsoft.com/library/mt603798.aspx) |\r | Stop-AzureHDInsightJob |[Stop-AzureRmHDInsightJob](https://msdn.microsoft.com/library/mt619424.aspx) |\r | Use-AzureHDInsightCluster |[Use-AzureRmHDInsightCluster](https://msdn.microsoft.com/library/mt619442.aspx) |\r | Wait-AzureHDInsightJob |[Wait-AzureRmHDInsightJob](https://msdn.microsoft.com/library/mt603834.aspx) |\r \r ### <a name=\"new-cmdlets\"></a>新 cmdlet\r 下面是只能在 ARM 模式下使用的新 cmdlet。 \r \r 与脚本操作相关的 cmdlet：\r \r * Get-AzureRmHDInsightPersistedScriptAction：获取群集的持久性脚本操作，并按时间顺序列出这些操作，或获取有关指定持久性脚本操作的详细信息。 \r * Get-AzureRmHDInsightScriptActionHistory：获取群集的脚本操作历史记录，并按时间顺序逆序列出这些操作，或获取有关以前执行的脚本操作的详细信息。 \r * Remove-AzureRmHDInsightPersistedScriptAction：从 HDInsight 群集中删除持久性脚本操作。\r * Set-AzureRmHDInsightPersistedScriptAction：将以前执行的脚本操作设置为持久性脚本操作。\r * Submit-AzureRmHDInsightScriptAction：将新的脚本操作提交到 Azure HDInsight 群集。 \r \r 有关其他用法信息，请参阅[使用脚本操作自定义基于 Linux 的 HDInsight 群集](hdinsight-hadoop-customize-cluster-linux.md)。\r \r ### <a name=\"examples\"></a>示例\r 创建群集\r \r 旧命令 (ASM)： \r \r     New-AzureHDInsightCluster `\r         -Name $clusterName `\r         -Location $location `\r         -DefaultStorageAccountName \"$storageAccountName.blob.core.chinacloudapi.cn\" `\r         -DefaultStorageAccountKey $storageAccountKey `\r         -DefaultStorageContainerName $containerName `\r         -ClusterSizeInNodes 2 `\r         -ClusterType Hadoop `\r         -OSType Linux `\r         -Version \"3.2\" `\r         -Credential $httpCredential `\r         -SshCredential $sshCredential\r \r 新命令 (ARM)：\r \r     New-AzureRmHDInsightCluster `\r         -ClusterName $clusterName `\r         -ResourceGroupName $resourceGroupName `\r         -Location $location `\r         -DefaultStorageAccountName \"$storageAccountName.blob.core.chinacloudapi.cn\" `\r         -DefaultStorageAccountKey $storageAccountKey `\r         -DefaultStorageContainer $containerName  `\r         -ClusterSizeInNodes 2 `\r         -ClusterType Hadoop `\r         -OSType Linux `\r         -Version \"3.2\" `\r         -HttpCredential $httpcredentials `\r         -SshCredential $sshCredentials\r \r 删除群集\r \r 旧命令 (ASM)：\r \r     Remove-AzureHDInsightCluster -name $clusterName \r \r 新命令 (ARM)：\r \r     Remove-AzureRmHDInsightCluster -ResourceGroupName $resourceGroupName -ClusterName $clusterName \r \r 列出群集\r \r 旧命令 (ASM)：\r \r     Get-AzureHDInsightCluster\r \r 新命令 (ARM)：\r \r     Get-AzureRmHDInsightCluster \r \r 显示群集\r \r 旧命令 (ASM)：\r \r     Get-AzureHDInsightCluster -Name $clusterName\r \r 新命令 (ARM)：\r \r     Get-AzureRmHDInsightCluster -ResourceGroupName $resourceGroupName -clusterName $clusterName\r \r #### <a name=\"other-samples\"></a>其他示例\r * [创建 HDInsight 群集](hdinsight-hadoop-create-linux-clusters-azure-powershell.md)\r * [提交 Hive 作业](hadoop/apache-hadoop-use-hive-powershell.md)\r * [提交 Pig 作业](hadoop/apache-hadoop-use-pig-powershell.md)\r * [提交 Sqoop 作业](hadoop/apache-hadoop-use-sqoop-powershell.md)\r \r ## <a name=\"migrating-to-the-arm-based-hdinsight-net-sdk\"></a>迁移到基于 ARM 的 HDInsight .NET SDK\r 基于 Azure 服务管理 (ASM) 的 [HDInsight.NET SDK](https://msdn.microsoft.com/library/azure/mt416619.aspx) 现已弃用。 建议使用基于 Azure 资源管理 (ARM) 的 HDInsight .NET SDK。 以下基于 ASM 的 HDInsight 包即将弃用。\r \r * `Microsoft.WindowsAzure.Management.HDInsight`\r * `Microsoft.Hadoop.Client`\r \r 本部分提供有关如何使用基于 ARM 的 SDK 执行特定任务的详细指导。\r \r | 如何...使用基于 ARM 的 HDInsight SDK | 链接 |\r | --- | --- |\r | 使用 .NET SDK 创建 HDInsight 群集 |请参阅[使用 .NET SDK 创建 HDInsight 群集](hdinsight-hadoop-create-linux-clusters-dotnet-sdk.md) |\r | 配合使用脚本操作与 .NET SDK 自定义群集 |请参阅[使用脚本操作自定义 HDInsight Linux 群集](hdinsight-hadoop-create-linux-clusters-dotnet-sdk.md#use-script-action) |\r | 配合使用 Azure Active Directory 与 .NET SDK 以交互方式对应用程序进行身份验证 |请参阅[使用 .NET SDK 运行 Hive 查询](hadoop/apache-hadoop-use-hive-dotnet-sdk.md)。 本文中的代码片段使用交互式身份验证方法。 |\r | 配合使用 Azure Active Directory 与 .NET SDK 以非交互方式对应用程序进行身份验证 |请参阅[为 HDInsight 创建非交互式应用程序](hdinsight-create-non-interactive-authentication-dotnet-applications.md) |\r | 使用 .NET SDK 提交 Hive 作业 |请参阅[提交 Hive 作业](hadoop/apache-hadoop-use-hive-dotnet-sdk.md) |\r | 使用 .NET SDK 提交 Pig 作业 |请参阅[提交 Pig 作业](hadoop/apache-hadoop-use-pig-dotnet-sdk.md) |\r | 使用 .NET SDK 提交 Sqoop 作业 |请参阅[提交 Sqoop 作业](hadoop/apache-hadoop-use-sqoop-dotnet-sdk.md) |\r | 使用 .NET SDK 列出 HDInsight 群集 |请参阅[列出 HDInsight 群集](hdinsight-administer-use-dotnet-sdk.md#list-clusters) |\r | 使用 .NET SDK 缩放 HDInsight 群集 |请参阅[缩放 HDInsight 群集](hdinsight-administer-use-dotnet-sdk.md#scale-clusters) |\r | 使用 .NET SDK 授予/吊销对 HDInsight 群集的访问权限 |请参阅[授予/吊销对 HDInsight 群集的访问权限](hdinsight-administer-use-dotnet-sdk.md#grantrevoke-access) |\r | 使用 .NET SDK 更新 HDInsight 群集的 HTTP 用户凭据 |请参阅[更新 HDInsight 群集的 HTTP 用户凭据](hdinsight-administer-use-dotnet-sdk.md#update-http-user-credentials) |\r | 使用 .NET SDK 查找 HDInsight 群集的默认存储帐户 |请参阅[查找 HDInsight 群集的默认存储帐户](hdinsight-administer-use-dotnet-sdk.md#find-the-default-storage-account) |\r | 使用 .NET SDK 删除 HDInsight 群集 |请参阅[删除 HDInsight 群集](hdinsight-administer-use-dotnet-sdk.md#delete-clusters) |\r \r ### <a name=\"examples\"></a>示例\r 下面是有关如何使用基于 ASM 的 SDK 和基于 ARM 的 SDK 的等效代码片段执行操作的一些示例。\r \r 创建群集 CRUD 客户端\r \r * 旧命令 (ASM)\r \r         //Certificate auth\r         //This logs the application in using a subscription administration certificate, which is not offered in Azure Resource Manager (ARM)\r \r         const string subid = \"454467d4-60ca-4dfd-a556-216eeeeeeee1\";\r         var cred = new HDInsightCertificateCredential(new Guid(subid), new X509Certificate2(@\"path\\to\\certificate.cer\"));\r         var client = HDInsightClient.Connect(cred);\r * 新命令 (ARM)（服务主体授权）\r \r         //Service principal auth\r         //This will log the application in as itself, rather than on behalf of a specific user.\r         //For details, including how to set up the application, see:\r         //   https://docs.azure.cn/hdinsight/hdinsight-create-non-interactive-authentication-dotnet-applications/\r \r         var authFactory = new AuthenticationFactory();\r \r         var account = new AzureAccount { Type = AzureAccount.AccountType.ServicePrincipal, Id = clientId };\r \r         var env = AzureEnvironment.PublicEnvironments[EnvironmentName.AzureChinaCloud];\r \r         var accessToken = authFactory.Authenticate(account, env, tenantId, secretKey, ShowDialog.Never).AccessToken;\r \r         var creds = new TokenCloudCredentials(subId.ToString(), accessToken);\r \r         _hdiManagementClient = new HDInsightManagementClient(creds, new Uri(\"https://management.chinacloudapi.cn/\"));\r * 新命令 (ARM)（用户授权）\r \r         //User auth\r         //This will log the application in on behalf of the user.\r         //The end-user will see a login popup.\r \r         var authFactory = new AuthenticationFactory();\r \r         var account = new AzureAccount { Type = AzureAccount.AccountType.User, Id = username };\r \r         var env = AzureEnvironment.PublicEnvironments[EnvironmentName.AzureChinaCloud];\r \r         var accessToken = authFactory.Authenticate(account, env, AuthenticationFactory.CommonAdTenant, password, ShowDialog.Auto).AccessToken;\r \r         var creds = new TokenCloudCredentials(subId.ToString(), accessToken);\r \r         _hdiManagementClient = new HDInsightManagementClient(creds, new Uri(\"https://management.chinacloudapi.cn/\"));\r \r 创建群集\r \r * 旧命令 (ASM)\r \r         var clusterInfo = new ClusterCreateParameters\r                     {\r                         Name = dnsName,\r                         DefaultStorageAccountKey = key,\r                         DefaultStorageContainer = defaultStorageContainer,\r                         DefaultStorageAccountName = storageAccountDnsName,\r                         ClusterSizeInNodes = 1,\r                         ClusterType = type,\r                         Location = \"China North\",\r                         UserName = \"admin\",\r                         Password = \"*******\",\r                         Version = version,\r                         HeadNodeSize = NodeVMSize.Large,\r                     };\r         clusterInfo.CoreConfiguration.Add(new KeyValuePair<string, string>(\"config1\", \"value1\"));\r         client.CreateCluster(clusterInfo);\r * 新命令 (ARM)\r \r         var clusterCreateParameters = new ClusterCreateParameters\r             {\r                 Location = \"China North\",\r                 ClusterType = \"Hadoop\",\r                 Version = \"3.1\",\r                 OSType = OSType.Linux,\r                 DefaultStorageAccountName = \"mystorage.blob.core.chinacloudapi.cn\",\r                 DefaultStorageAccountKey =\r                     \"O9EQvp3A3AjXq/W27rst1GQfLllhp0gUeiUUn2D8zX2lU3taiXSSfqkZlcPv+nQcYUxYw==\",\r                 UserName = \"hadoopuser\",\r                 Password = \"*******\",\r                 HeadNodeSize = \"ExtraLarge\",\r                 RdpUsername = \"hdirp\",\r                 RdpPassword = \"\"*******\",\r                 RdpAccessExpiry = new DateTime(2025, 3, 1),\r                 ClusterSizeInNodes = 5\r             };\r         var coreConfigs = new Dictionary<string, string> {{\"config1\", \"value1\"}};\r         clusterCreateParameters.Configurations.Add(ConfigurationKey.CoreSite, coreConfigs);\r \r 启用 HTTP 访问\r \r * 旧命令 (ASM)\r \r         client.EnableHttp(dnsName, \"China North\", \"admin\", \"*******\");\r * 新命令 (ARM)\r \r         var httpParams = new HttpSettingsParameters\r         {\r                HttpUserEnabled = true,\r                HttpUsername = \"admin\",\r                HttpPassword = \"*******\",\r         };\r         client.Clusters.ConfigureHttpSettings(resourceGroup, dnsname, httpParams);\r \r 删除群集\r \r * 旧命令 (ASM)\r \r         client.DeleteCluster(dnsName);\r * 新命令 (ARM)\r \r         client.Clusters.Delete(resourceGroup, dnsname);\r \r \r \r <!--Update_Description: update wording and link references-->"}