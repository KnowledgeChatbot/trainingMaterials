{"Title":"使用 SMB 在 Linux VM 上装载 Azure 文件存储","Description":"如何通过 Azure CLI 2.0 使用 SMB 在 Linux VM 上装载 Azure 文件存储","Content":"# <a name=\"mount-azure-file-storage-on-linux-vms-using-smb\"></a>使用 SMB 在 Linux VM 上装载 Azure 文件存储\r \r 本文说明如何通过 Azure CLI 2.0 使用 SMB 装载利用 Linux VM 上的 Azure 文件存储服务。 Azure 文件存储使用标准 SMB 协议在云中提供文件共享。 还可以使用 [Azure CLI 1.0](mount-azure-file-storage-on-linux-using-smb-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 执行这些步骤。 要求如下：\r \r - [一个 Azure 帐户](https://www.azure.cn/pricing/1rmb-trial/)\r - [SSH 公钥和私钥文件](mac-create-ssh-keys.md)\r \r ## <a name=\"quick-commands\"></a>快速命令\r \r * 资源组\r * Azure 虚拟网络\r * 使用 SSH 入站类型的网络安全组\r * 一个子网\r * 一个 Azure 存储帐户\r * Azure 存储帐户密钥\r * 一个 Azure 文件存储共享\r * 一个 Linux VM\r \r 将任何示例替换成自己的设置。\r \r ### <a name=\"create-a-directory-for-the-local-mount\"></a>为本地装载创建目录\r \r ```bash\r mkdir -p /mnt/mymountpoint\r ```\r \r ### <a name=\"mount-the-file-storage-smb-share-to-the-mount-point\"></a>将文件存储 SMB 共享装载到装入点\r \r ```bash\r sudo mount -t cifs //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint -o vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r ```\r \r ### <a name=\"persist-the-mount-after-a-reboot\"></a>在重新启动后保留装载\r 为此，请将以下代码行添加到 `/etc/fstab`：\r \r ```bash\r //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint cifs vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r ```\r \r ## <a name=\"detailed-walkthrough\"></a>详细演练\r \r 文件存储使用标准 SMB 协议在云中提供文件共享。 使用最新版本的文件存储，还可以从支持 SMB 3.0 的任何 OS 装载文件共享。 在 Linux 上使用 SMB 装载时，可轻松备份到 SLA 支持的可靠、永久的存档存储位置。\r \r 将文件从 VM 移至托管在文件存储上的 SMB 装载，可以很轻松地调试日志。 这是因为同一 SMB 共享可以通过本地方式装载到 Mac、Linux 或 Windows 工作站。 SMB 不会是实时流式处理 Linux 或应用程序日志的最佳解决方案，因为 SMB 协议并非为处理那样重的日志记录任务而构建。 专用统一的日志记录层工具（如 Fluentd）会是 SMB 之上的更好选择，可收集 Linux 和应用程序日志记录输出。\r \r 在此详细的演练中，我们创建所需的先决条件，即先创建文件存储共享，然后通过 SMB 将其装载到 Linux VM 上。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 1. 使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组，以便保存文件共享。\r \r     若要在“中国北部”位置创建名为 `myResourceGroup` 的资源组，请使用以下示例：\r \r     ```azurecli\r     az group create --name myResourceGroup --location chinanorth\r     ```\r \r 2. 使用 [az storage account create](https://docs.azure.cn/zh-cn/cli/storage/account?view=azure-cli-latest#create) 创建 Azure 存储帐户，用于存储实际文件。\r \r     若要通过 Standard_LRS 存储 SKU 创建名为 mystorageaccount 的存储帐户，请使用以下示例：\r \r     ```azurecli\r     az storage account create --resource-group myResourceGroup \\\r         --name mystorageaccount \\\r         --location chinanorth \\\r         --sku Standard_LRS\r     ```\r \r 3. 显示存储帐户密钥。\r \r     创建存储帐户时，帐户密钥是成对创建的，这样是为了不中断任何服务就可轮换密钥。 轮换到密钥对中的第二个密钥后，创建新的密钥对。 新的存储帐户密钥始终成对创建，可确保始终至少有一个未使用的存储帐户密钥可以轮换到。\r \r     使用 [az storage account keys list](https://docs.azure.cn/zh-cn/cli/storage/account/keys?view=azure-cli-latest#list) 查看存储帐户密钥。 名为 `mystorageaccount` 的存储帐户的密钥列在以下示例中：\r \r     ```azurecli\r     az storage account keys list --resource-group myResourceGroup \\\r         --account-name mystorageaccount\r     ```\r \r     若要提取单个密钥，请使用 `--query` 标志。 以下示例提取了第一个密钥 (`[0]`)：\r \r     ```azurecli\r     az storage account keys list --resource-group myResourceGroup \\\r         --account-name mystorageaccount \\\r         --query '[0].{Key:value}' --output tsv\r     ```\r \r 4. 创建文件存储共享。\r \r     使用 [az storage share create](https://docs.azure.cn/zh-cn/cli/storage/share?view=azure-cli-latest#create) 创建的文件存储共享包含 SMB 共享。 配额始终以千兆字节 (GB) 表示。 从前面的 `az storage account keys list` 命令传入其中一个密钥。 使用以下示例创建名为 mystorageshare 的共享，配额为 10 GB：\r \r     ```azurecli\r     az storage share create --name mystorageshare \\\r         --quota 10 \\\r         --account-name mystorageaccount \\\r         --account-key nPOgPR<--snip-->4Q==\r     ```\r \r 5. 创建一个装入点目录。\r \r     在 Linux 文件系统中创建将 SMB 共享装载到其中的本地目录。 写入到本地装载目录或从本地装载目录读取的任何内容都会转发到文件存储上托管的 SMB 共享。 若要在 /mnt/mymountdirectory 中创建本地目录，请使用以下示例：\r \r     ```bash\r     sudo mkdir -p /mnt/mymountdirectory\r     ```\r \r 6. 将 SMB 共享装载到本地目录。\r \r     提供自己的装载凭据的存储帐户用户名和存储帐户密钥，如下所示：\r \r     ```azurecli\r     sudo mount -t cifs //myStorageAccount.file.core.chinacloudapi.cn/mystorageshare /mnt/mymountdirectory -o vers=3.0,username=mystorageaccount,password=mystorageaccountkey,dir_mode=0777,file_mode=0777\r     ```\r \r 7. 重新启动后保留 SMB 装载。\r \r     重新启动 Linux VM 后，已装载的 SMB 共享会在关闭过程中卸载。 若要在启动时重新装载 SMB 共享，请向 Linux /etc/fstab 添加一行。 Linux 使用 fstab 文件列出在启动过程中需要装载的文件系统。 添加 SMB 共享可确保文件存储共享是 Linux VM 的永久装载文件系统。 使用 cloud-init 可以将文件存储 SMB 共享添加到新的 VM。\r \r     ```bash\r     //myaccountname.file.core.chinacloudapi.cn/mysharename /mymountpoint cifs vers=3.0,username=myaccountname,password=StorageAccountKeyEndingIn==,dir_mode=0777,file_mode=0777\r     ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r - [在创建期间使用 cloud-init 自定义 Linux VM](using-cloud-init.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r - [将磁盘添加到 Linux VM](add-disk.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r - [使用 Azure CLI 加密 Linux VM 上的磁盘](encrypt-disks.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r <!--Update_Description: wording update-->"}