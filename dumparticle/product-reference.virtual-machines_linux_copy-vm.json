{"Title":"使用 Azure CLI 2.0 和托管磁盘创建 Azure Linux VM 的副本","Description":"了解如何使用 Azure CLI 2.0 和托管磁盘创建 Azure Linux VM 的副本。","Content":"# <a name=\"create-a-copy-of-a-linux-vm-by-using-azure-cli-20-and-managed-disks\"></a>使用 Azure CLI 2.0 和托管磁盘创建 Azure Linux VM 的副本\r \r 本文说明了如何使用 Azure CLI 2.0 和 Azure Resource Manager 部署模型创建运行 Linux 的 Azure 虚拟机 (VM) 的副本。 还可以使用 [Azure CLI 1.0](copy-vm-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 执行这些步骤。\r \r 还可以[上传 VHD 并从中创建 VM](upload-vhd.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。\r \r ## <a name=\"prerequisites\"></a>先决条件\r \r -   安装 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest)\r \r -   使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到一个 Azure 帐户。\r \r -   使用一个 Azure VM 作为副本的来源。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r ## <a name=\"step-1-stop-the-source-vm\"></a>步骤 1：停止源 VM\r \r 使用 [az vm deallocate](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#deallocate) 解除分配源 VM。\r 以下示例解除分配资源组**myResourceGroup** 中名为 **myVM** 的 VM：\r \r ```azurecli\r az vm deallocate \\\r     --resource-group myResourceGroup \\\r     --name myVM\r ```\r \r ## <a name=\"step-2-copy-the-source-vm\"></a>步骤 2：复制源 VM\r \r 若要复制 VM，请创建基础虚拟硬盘的副本。 此过程将一个专用 VHD 创建为托管磁盘，其中包含与源 VM 相同的配置和设置。\r \r 有关 Azure 托管磁盘的详细信息，请参阅 [Azure 托管磁盘概述](../windows/managed-disks-overview.md)。 \r \r 1.  使用 [az vm list](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#list) 列出每个 VM 及其 OS 磁盘的名称。 以下示例列出了名为 **myResourceGroup** 的资源组中的所有 VM：\r \r     ```azurecli\r     az vm list -g myResourceGroup \\\r          --query '[].{Name:name,DiskName:storageProfile.osDisk.name}' \\\r          --output table\r     ```\r \r     输出类似于以下示例：\r \r     ```azurecli\r     Name    DiskName\r     ------  --------\r     myVM    myDisk\r     ```\r \r 1.  通过使用 [az disk create](https://docs.azure.cn/zh-cn/cli/disk?view=azure-cli-latest#create) 创建新的托管磁盘来复制磁盘。 以下示例基于名为 **myDisk** 的托管磁盘创建名为 **myCopiedDisk** 的磁盘：\r \r     ```azurecli\r     az disk create --resource-group myResourceGroup \\\r          --name myCopiedDisk --source myDisk\r     ``` \r \r 1.  现在请使用 [az disk list](https://docs.azure.cn/zh-cn/cli/disk?view=azure-cli-latest#list) 验证资源组中的托管磁盘。 以下示例列出了名为 **myResourceGroup** 的资源组中的托管磁盘：\r \r     ```azurecli\r     az disk list --resource-group myResourceGroup --output table\r     ```\r \r ## <a name=\"step-3-set-up-a-virtual-network\"></a>步骤 3：设置虚拟网络\r \r 以下可选步骤可创建新的虚拟网络、子网、公共 IP 地址和虚拟网络接口卡 (NIC)。\r \r 在复制 VM 来完成故障排除或其他部署操作时，用户可能不希望使用现有虚拟网络中的 VM。\r \r 如果希望为复制的 VM 创建虚拟网络基础结构，请按后续几个步骤操作。 如果不希望创建虚拟网络，请跳到[步骤 4：创建 VM](#step-4-create-a-vm)。\r \r 1.  使用 [az network vnet create](https://docs.azure.cn/zh-cn/cli/network/vnet?view=azure-cli-latest#create) 创建虚拟网络。 以下示例创建一个名为 **myVnet** 的虚拟网络和一个名为 **mySubnet** 的子网：\r \r     ```azurecli\r     az network vnet create --resource-group myResourceGroup \\\r         --location chinanorth --name myVnet \\\r         --address-prefix 192.168.0.0/16 \\\r         --subnet-name mySubnet \\\r         --subnet-prefix 192.168.1.0/24\r     ```\r \r 1.  使用 [az network public-ip create](https://docs.azure.cn/zh-cn/cli/network/public-ip?view=azure-cli-latest#create) 创建公共 IP。 以下示例创建一个名为 **myPublicIP** 的公共 IP，其 DNS 名称为 **mypublicdns**。 （DNS 名称必须唯一，因此请提供唯一名称。）\r \r     ```azurecli\r     az network public-ip create --resource-group myResourceGroup \\\r         --location chinanorth --name myPublicIP --dns-name mypublicdns \\\r         --allocation-method static --idle-timeout 4\r     ```\r \r 1.  使用 [az network nic create](https://docs.azure.cn/zh-cn/cli/network/nic?view=azure-cli-latest#create) 创建 NIC。\r     以下示例创建一个附加到 **mySubnet** 子网且名为 **myNic** 的 NIC：\r \r     ```azurecli\r     az network nic create --resource-group myResourceGroup \\\r         --location chinanorth --name myNic \\\r         --vnet-name myVnet --subnet mySubnet \\\r         --public-ip-address myPublicIP\r     ```\r \r ## <a name=\"step-4-create-a-vm\"></a>步骤 4：创建 VM\r \r 现在可使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 创建 VM。\r \r 指定复制的要用作 OS 磁盘的托管磁盘 (--attach-os-disk)，如下所示：\r \r ```azurecli\r az vm create --resource-group myResourceGroup \\\r     --name myCopiedVM --nics myNic \\\r     --size Standard_DS1_v2 --os-type Linux \\\r     --attach-os-disk myCopiedDisk\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 若要了解如何使用 Azure CLI 管理新 VM，请参阅 [Azure Resource Manager 的 Azure CLI 命令](../azure-cli-arm-commands.md)。\r \r <!--Update_Description: update link, wording update-->\r "}