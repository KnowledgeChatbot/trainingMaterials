{"Title":"使用 Azure 资源策略为资源组中的资源强制添加标签","Description":"使用 Azure 资源策略为资源组中的资源强制添加标签","Content":"# 使用 Azure 资源策略为资源组中的资源强制添加标签\r \r 使用资源策略可在组织中建立资源标签。通过资源标签，可以控制成本并更轻松地管理资源。\r \r 本文以具体示例讲述如何为不同的资源组分别添加标签。\r \r 示例中所使用的标签为：Env 和 Bill，分别代表资源所属的环境和部门。\r \r - 资源组 1 Env : Dev; Bill : IT\r - 资源组 2 Env : Prod; Bill ：HR\r \r ## 定义资源策略\r \r 对于已经有标签的资源，判断是否有 Bill 和 Env 这两个标签的键；若存在，无论值是否匹配，跳过添加标签；若没有，则添加标签并赋值。共有四组标签键值对，因此定义四个策略:\r \r 1. [tags-env-prod.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/tags-env-prod.json)\r 2. [tags-env-dev.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/tags-env-dev.json)\r 3. [tags-bill-it.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/tags-bill-it.json)\r 4. [tags-bill-hr.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/tags-bill-hr.json)\r \r 对于没有标签的资源，则添加两个标签的键值对。\r \r 1. [notags-prod-hr.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/notags-prod-hr.json)\r 2. [notags-dev-it.json](https://github.com/wacn/AOG-CodeSample/blob/master/AzureResocrceManager/json/notags-dev-it.json)\r \r ## 指定订阅和资源组\r \r 指定要配置资源策略的订阅和资源组:\r \r ```PowerShell\r $mysubscription = \"9ef8a15c-15a2-4ef1-a19b-e31876ab177c\"\r $myresourcegroup1 = \"lqi2ntoolrg\"\r $myresourcegroup2 = \"lqi2ntestvmssrg\"\r ```\r \r ## 登录订阅\r Azure PowerShell 登录订阅，选择订阅:\r \r ```PowerShell\r login-azurermaccount\r Get-AzureRmSubscription\r Select-AzureRmSubscription -SubscriptionId $mysubscription\r ```\r \r ## 定义资源策略\r \r 定义资源策略并分配给资源组。\r \r 这两个策略表示若资源已有标签，则判断是否有 Env 和 Bill 标签；若没有，则添加标签并赋值。\r \r > [!TIPS]\r > 请根据实际情况定义 Name, Description, Policy 文件所在的路径和文件名。\r \r ```PowerShell\r $policy = New-AzureRmPolicyDefinition -Name lqitags-env-dev -Description \"Policy to set environment\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\tags-env-dev.json\"\r New-AzureRmPolicyAssignment -Name lqitags-env-dev -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup1\r $policy = New-AzureRmPolicyDefinition -Name lqitags-env-prod -Description \"Policy to set environment\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\tags-env-prod.json\"\r New-AzureRmPolicyAssignment -Name lqitags-env-prod -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup2\r \r $policy = New-AzureRmPolicyDefinition -Name lqitags-bill-it -Description \"Policy to set bill owner\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\tags-bill-it.json\"\r New-AzureRmPolicyAssignment -Name lqitags-bill-it -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup1\r $policy = New-AzureRmPolicyDefinition -Name lqitags-bill-hr -Description \"Policy to set bill owner\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\tags-bill-hr.json\"\r New-AzureRmPolicyAssignment -Name lqitags-bill-hr -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup2\r ```\r \r 该策略表示若资源没有标签，则添加 Dev 和 Bill 标签，并赋指定的值。\r \r ```PowerShell\r $policy = New-AzureRmPolicyDefinition -Name lqinotags-dev-it -Description \"Policy to set env and bill\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\notags-dev-it.json\"\r New-AzureRmPolicyAssignment -Name lqinotags-dev-it -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup1\r $policy = New-AzureRmPolicyDefinition -Name lqinotags-prod-hr -Description \"Policy to set env and bill\" -Policy \"C:\\Users\\lqi.FAREAST\\Desktop\\notags-prod-hr.json\"\r New-AzureRmPolicyAssignment -Name lqinotags-prod-hr -PolicyDefinition $policy -Scope /subscriptions/$mysubscription/resourceGroups/$myresourcegroup2\r ```\r ## 更新标签\r \r 为资源组分配策略后，资源组中任何新建的资源（只要支持标签属性）将会被赋予标签。上面三条策略共同保证了标签不会被误删（删除后根据策略会自动加回），标签内容不能被修改。\r \r 但对于已存在的资源，策略不会回溯分配标签。因此，可以使用下面命令更新资源，为其添加标签。\r \r 下面命令在保留资源已有标签的前提下，为其添加缺少的标签。若资源已经有 Env/Bill 标签，但值不同，不会更新标签值。\r \r ```PowerShell\r $group = Get-AzureRmResourceGroup -Name $myresourcegroup1\r \r $resources = Find-AzureRmResource -ResourceGroupName $group.ResourceGroupName \r \r foreach($r in $resources)\r {\r     try{\r         $r | Set-AzureRmResource -Tags ($a=if($r.Tags -eq $NULL) { @{}} else {$r.Tags}) -Force -UsePatchSemantics\r     }\r     catch{\r         Write-Host  $r.ResourceId + \"can't be updated\"\r     }\r }\r ```\r \r 下面命令将强制清空所有已有标签，为其添加策略定义的标签。\r \r ```PowerShell\r $group = Get-AzureRmResourceGroup -Name $myresourcegroup1\r \r $resources = Find-AzureRmResource -ResourceGroupName $group.ResourceGroupName \r \r foreach($r in $resources)\r {\r     try{\r         $r | Set-AzureRmResource -Tags @{} -Force -UsePatchSemantics\r     }\r     catch{\r         Write-Host  $r.ResourceId + \"can't be updated\"\r     }\r }\r ```\r \r ## 示例结果\r \r 在门户中查看标签:\r \r ![portal](media/aog-azure-resource-manager-add-label-force-with-policy/portal.png)\r \r 关于资源策略的详细介绍请参考：[资源策略概述](https://docs.azure.cn/zh-cn/azure-resource-manager/resource-manager-policy)。"}