{"Title":"还原 Azure SQL 数据仓库 (PowerShell)","Description":"用于还原 SQL 数据仓库的 PowerShell 任务。","Content":"# <a name=\"restore-an-azure-sql-data-warehouse-powershell\"></a>还原 Azure SQL 数据仓库 (PowerShell)\r > [!div class=\"op_single_selector\"]\r > * [概述][Overview]\r > * [门户][Portal]\r > * [PowerShell][PowerShell]\r > * [REST][REST]\r > \r > \r \r 本文会介绍如何使用 PowerShell 还原 Azure SQL 数据仓库。\r \r ## <a name=\"before-you-begin\"></a>开始之前\r **验证 DTU 容量。** 每个 SQL 数据仓库都由一个具有默认 DTU 配额的 SQL 服务器（例如 myserver.database.chinacloudapi.cn）托管。  在还原 SQL 数据仓库之前，请确保 SQL Server 的剩余 DTU 配额足够进行数据库还原。 若要了解如何计算所需 DTU 或请求更多的 DTU，请参阅[请求 DTU 配额更改][Request a DTU quota change]。\r \r ### <a name=\"install-powershell\"></a>安装 PowerShell\r 若要对 SQL 数据仓库使用 Azure PowerShell，需要安装 Azure PowerShell 1.0 或更高版本。  可以通过运行 **Get-Module -ListAvailable -Name AzureRM**来检查版本。  可通过 [Microsoft Web 平台安装程序][Microsoft Web Platform Installer]安装最新版本。  有关安装最新版本的详细信息，请参阅[如何安装和配置 Azure PowerShell][How to install and configure Azure PowerShell]。\r \r ## <a name=\"restore-an-active-or-paused-database\"></a>还原活动或暂停的数据库\r 若要从快照还原数据库，请使用 [Restore-AzureRmSqlDatabase][Restore-AzureRmSqlDatabase] PowerShell cmdlet。\r \r 1. 打开 Windows PowerShell。\r 2. 连接到 Azure 帐户，并列出与帐户关联的所有订阅。\r 3. 选择包含要还原的数据库的订阅。\r 4. 列出数据库的还原点。\r 5. 使用 RestorePointCreationDate 选取所需的还原点。\r 6. 将数据库还原到所需的还原点。\r 7. 验证已还原的数据库是否处于联机状态。\r \r ```Powershell\r \r $SubscriptionName=\"<YourSubscriptionName>\"\r $ResourceGroupName=\"<YourResourceGroupName>\"\r $ServerName=\"<YourServerNameWithoutURLSuffixSeeNote>\"  # Without database.chinacloudapi.cn\r $DatabaseName=\"<YourDatabaseName>\"\r $NewDatabaseName=\"<YourDatabaseName>\"\r \r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r Get-AzureRmSubscription\r Select-AzureRmSubscription -SubscriptionName $SubscriptionName\r \r # List the last 10 database restore points\r ((Get-AzureRMSqlDatabaseRestorePoints -ResourceGroupName $ResourceGroupName -ServerName $ServerName -DatabaseName ($DatabaseName)).RestorePointCreationDate)[-10 .. -1]\r \r # Or list all restore points\r Get-AzureRmSqlDatabaseRestorePoints -ResourceGroupName $ResourceGroupName -ServerName $ServerName -DatabaseName $DatabaseName\r \r # Get the specific database to restore\r $Database = Get-AzureRmSqlDatabase -ResourceGroupName $ResourceGroupName -ServerName $ServerName -DatabaseName $DatabaseName\r \r # Pick desired restore point using RestorePointCreationDate\r $PointInTime=\"<RestorePointCreationDate>\"  \r \r # Restore database from a restore point\r $RestoredDatabase = Restore-AzureRmSqlDatabase -FromPointInTimeBackup -PointInTime $PointInTime -ResourceGroupName $Database.ResourceGroupName -ServerName $Database.$ServerName -TargetDatabaseName $NewDatabaseName -ResourceId $Database.ResourceID\r \r # Verify the status of restored database\r $RestoredDatabase.status\r \r ```\r \r > [!NOTE]\r > 完成还原后，即可按[在恢复后配置数据库][Configure your database after recovery]中的说明配置恢复的数据库。\r > \r > \r \r ## <a name=\"restore-a-deleted-database\"></a>还原已删除的数据库\r 若要还原已删除的数据库，请使用 [Restore-AzureRmSqlDatabase][Restore-AzureRmSqlDatabase] cmdlet。\r \r 1. 打开 Windows PowerShell。\r 2. 连接到 Azure 帐户，并列出与帐户关联的所有订阅。\r 3. 选择包含要还原的已删除数据库的订阅。\r 4. 获取特定的已删除数据库。\r 5. 还原已删除的数据库。\r 6. 验证已还原的数据库是否处于联机状态。\r \r ```Powershell\r $SubscriptionName=\"<YourSubscriptionName>\"\r $ResourceGroupName=\"<YourResourceGroupName>\"\r $ServerName=\"<YourServerNameWithoutURLSuffixSeeNote>\"  # Without database.chinacloudapi.cn\r $DatabaseName=\"<YourDatabaseName>\"\r $NewDatabaseName=\"<YourDatabaseName>\"\r \r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r Get-AzureRmSubscription\r Select-AzureRmSubscription -SubscriptionName $SubscriptionName\r \r # Get the deleted database to restore\r $DeletedDatabase = Get-AzureRmSqlDeletedDatabaseBackup -ResourceGroupName $ResourceGroupName -ServerName $ServerName -DatabaseName $DatabaseName\r \r # Restore deleted database\r $RestoredDatabase = Restore-AzureRmSqlDatabase -FromDeletedDatabaseBackup -DeletionDate $DeletedDatabase.DeletionDate -ResourceGroupName $DeletedDatabase.ResourceGroupName -ServerName $DeletedDatabase.ServerName -TargetDatabaseName $NewDatabaseName -ResourceId $DeletedDatabase.ResourceID\r \r # Verify the status of restored database\r $RestoredDatabase.status\r ```\r \r > [!NOTE]\r > 完成还原后，即可按[在恢复后配置数据库][Configure your database after recovery]中的说明配置恢复的数据库。\r > \r > \r \r ## <a name=\"restore-from-an-azure-geographical-region\"></a>从 Azure 地理区域还原\r 若要恢复数据库，请使用 [Restore-AzureRmSqlDatabase][Restore-AzureRmSqlDatabase] cmdlet。\r \r 1. 打开 Windows PowerShell。\r 2. 连接到 Azure 帐户，并列出与帐户关联的所有订阅。\r 3. 选择包含要还原的数据库的订阅。\r 4. 获取要恢复的数据库。\r 5. 创建对数据库的恢复请求。\r 6. 验证异地还原的数据库的状态。\r \r ```Powershell\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r Get-AzureRmSubscription\r Select-AzureRmSubscription -SubscriptionName \"<Subscription_name>\"\r \r # Get the database you want to recover\r $GeoBackup = Get-AzureRmSqlDatabaseGeoBackup -ResourceGroupName \"<YourResourceGroupName>\" -ServerName \"<YourServerName>\" -DatabaseName \"<YourDatabaseName>\"\r \r # Recover database\r $GeoRestoredDatabase = Restore-AzureRmSqlDatabase -FromGeoBackup -ResourceGroupName \"<YourResourceGroupName>\" -ServerName \"<YourTargetServer>\" -TargetDatabaseName \"<NewDatabaseName>\" -ResourceId $GeoBackup.ResourceID\r \r # Verify that the geo-restored database is online\r $GeoRestoredDatabase.status\r ```\r \r > [!NOTE]\r > 若要在完成还原后配置数据库，请参阅[在恢复后配置数据库][Configure your database after recovery]。\r > \r > \r \r 如果源数据库启用了 TDE，则已恢复的数据库会启用 TDE。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 若要了解 Azure SQL 数据库版本的业务连续性功能，请阅读 [Azure SQL 数据库业务连续性概述][Azure SQL Database business continuity overview]。\r \r <!--Image references-->\r \r <!--Article references-->\r [Azure SQL Database business continuity overview]: ../sql-database/sql-database-business-continuity.md\r <!-- Not available for support ticket[Request a DTU quota change]: sql-data-warehouse-get-started-create-support-ticket.md#request-quota-change-->\r [Configure your database after recovery]: ../sql-database/sql-database-disaster-recovery.md#configure-your-database-after-recovery\r [How to install and configure Azure PowerShell]: https://docs.microsoft.com/powershell/azureps-cmdlets-docs\r [Overview]: ./sql-data-warehouse-restore-database-overview.md\r [Portal]: ./sql-data-warehouse-restore-database-portal.md\r [PowerShell]: ./sql-data-warehouse-restore-database-powershell.md\r [REST]: ./sql-data-warehouse-restore-database-rest-api.md\r [Configure your database after recovery]: ../sql-database/sql-database-disaster-recovery.md#configure-your-database-after-recovery\r \r <!--MSDN references-->\r [Restore-AzureRmSqlDatabase]: https://msdn.microsoft.com/library/mt693390.aspx\r \r <!--Other Web references-->\r [Azure Portal]: https://portal.azure.cn/\r [Microsoft Web Platform Installer]: https://aka.ms/webpi-azps\r \r <!--Update_Description: update meta properties, wording update -->"}