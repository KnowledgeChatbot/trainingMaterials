{"Title":"排除 VMware/物理机到 Azure 的保护故障","Description":"本文介绍常见的 VMware 虚拟机复制故障及其解决方法","Content":"# <a name=\"troubleshoot-on-premises-vmwarephysical-server-replication-issues\"></a>排除本地 VMware/物理服务器复制问题\r 使用 Azure Site Recovery 保护 VMware 虚拟机或物理服务器时，可能会收到特定错误消息。 本文详细介绍遇到的一些更常见的错误消息，以及解决这些错误消息的故障排除步骤。\r \r ## <a name=\"initial-replication-is-stuck-at-0\"></a>初始复制进度卡在 0%\r 对于在支持方面遇到的初始复制故障，大多数都由源服务器到进程服务器或进程服务器到 Azure 之间的连接问题引起。\r 大多数情况下，用户可按照下列步骤自助解决这些问题。\r \r ###<a name=\"check-the-following-on-source-machine\"></a>对源计算机进行下列检查\r * 在源服务器计算机命令行中，使用 Telnet 通过 https 端口（默认为 9443）对进程服务器执行 ping 操作（如下所示），查看是否存在任何网络连接问题或防火墙端口阻止问题。\r \r     `telnet <PS IP address> <port>`\r > [!NOTE]\r     > 请使用 Telnet，不要使用 PING 测试连接。  如果未安装 Telnet，请按照[此处](https://technet.microsoft.com/library/cc771275(v=WS.10).aspx)的步骤列表进行操作\r \r 如果无法连接，则在进程服务器上允许入站端口 9443，然后检查问题是否仍然存在。 有时，当进程服务器受 DMZ 保护时，也会导致此问题。\r \r * 查看 `InMage Scout VX Agent - Sentinel/OutpostStart` 服务的状态，检查其是否未运行，然后检查问题是否仍然存在。   \r \r ###<a name=\"check-the-following-on-process-server\"></a>对进程服务器进行下列检查\r \r * **检查进程服务器是否主动将数据推送到 Azure** \r \r 在进程服务器计算机中，打开任务管理器（按 Ctrl-Shift-Esc）。 转到“性能”选项卡，单击“打开资源监视器”链接。 在资源管理器中，转到“网络”选项卡。检查“网络活动的进程”中的 cbengine.exe 是否正在主动发送大量数据（以 MB 为单位）。\r \r ![启用复制](./media/site-recovery-protection-common-errors/cbengine.png)\r \r 如果不是，请执行下列步骤：\r \r * **检查进程服务器是否能够连接 Azure Blob**：选择并勾选 cbengine.exe，查看“TCP 连接”，检查是否存在从进程服务器到 Azure 存储 Blob URL 的连接。\r \r ![启用复制](./media/site-recovery-protection-common-errors/rmonitor.png)\r \r 如果没有连接，则转到“控制面板”>“服务”，检查以下服务是否启动且正在运行：\r \r      * cxprocessserver\r      * InMage Scout VX Agent - Sentinel/Outpost\r      * Azure Recovery Services Agent\r      * Azure Site Recovery Service\r      * tmansvc\r      * \r （重新）启动所有未运行的服务，然后检查问题是否仍然存在。\r \r * **检查进程服务器是否能通过端口 443 连接到 Azure 公共 IP 地址**\r \r 从 `%programfiles%\\Azure Recovery Services Agent\\Temp` 打开最新的 CBEngineCurr.errlog，并搜索 :443 和失败的连接尝试。\r \r ![启用复制](./media/site-recovery-protection-common-errors/logdetails1.png)\r \r 如果存在问题，则在进程服务器命令行中，使用 telnet 通过端口 443 对在 CBEngineCurr.currLog 中找到的 Azure 公共 IP 地址（上图中已屏蔽）执行 ping 操作。\r \r       telnet <your Azure Public IP address as seen in CBEngineCurr.errlog>  443\r 如果无法连接，则检查访问问题是否由防火墙或代理导致（在下一步提供说明）。\r \r * **检查进程服务器上基于 IP 地址的防火墙是否未阻止访问**：如果在服务器上使用基于 IP 地址的防火墙规则，请从[此处](https://www.microsoft.com/download/details.aspx?id=42064)下载 Azure 数据中心 IP 范围的完整列表，并将其添加到防火墙配置，确保它们允许到 Azure（和 HTTPS (443) 端口）的通信。  允许订阅的 Azure 区域的 IP 地址范围以及中国北部的 IP 地址范围（用于访问控制和标识管理）。\r \r * **检查进程服务器上基于 URL 的防火墙是否未阻止访问**：如果在服务器上使用基于 URL 的防火墙规则，请确保将以下 URL 添加到防火墙配置。 \r \r   `*.accesscontrol.chinacloudapi.cn:` 用于访问控制和标识管理\r \r   `*.backup.windowsazure.cn:` 用于复制数据传输和协调\r \r   `*.blob.core.chinacloudapi.cn:` 用于访问存储所复制数据的存储帐户\r \r   `*.hypervrecoverymanager.windowsazure.cn:` 用于复制管理操作和协调\r \r   `time.nist.gov` 和 `time.windows.com`：用于检查系统时间与全球时间之间的时间同步。\r \r **Azure 政府云**的 URL：\r \r `* .ugv.hypervrecoverymanager.windowsazure.us`\r \r `* .ugv.backup.windowsazure.us`\r \r `* .ugi.hypervrecoverymanager.windowsazure.us`\r \r `* .ugi.backup.windowsazure.us` \r \r * **检查进程服务器上的代理设置是否未阻止访问**。  如果使用代理服务器，请确保代理服务器名称由 DNS 服务器解析。\r 若要查看在配置服务器安装期间提供的信息， 请转到注册表项\r \r     `HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Azure Site Recovery\\ProxySettings`\r \r 现在请确保 Azure Site Recovery 代理正在使用相同的设置发送数据。\r 搜索 Azure 备份 \r \r ![启用复制](./media/site-recovery-protection-common-errors/mab.png)\r \r 将其打开，再单击“操作”>“更改属性”。 “代理配置”选项卡下应显示代理地址，其应与注册表设置中显示的代理地址相同。 如果不同，请将其更改为相同的地址。\r \r ![启用复制](./media/site-recovery-protection-common-errors/mabproxy.png)\r \r * **检查进程服务器上的限制带宽是否不受约束**：增加带宽，并检查问题是否仍然存在。\r \r ##<a name=\"next-steps\"></a>后续步骤\r 如需更多帮助，请在 [ASR 论坛](https://social.msdn.microsoft.com/Forums/en-US/home?forum=hypervrecovmgr)中咨询。 我们的社区非常活跃，工程师会提供帮助。\r \r <!--Update_Description: new articles vmware to azure protection troublshoot in site recovery -->"}