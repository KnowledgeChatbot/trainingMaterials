{"Title":"如何在 Azure API 管理中将事件记录到 Azure 事件中心","Description":"了解如何在 Azure API 管理中将事件记录到 Azure 事件中心。","Content":"# <a name=\"how-to-log-events-to-azure-event-hubs-in-azure-api-management\"></a>如何在 Azure API 管理中将事件记录到 Azure 事件中心\r 事件中心是一个高度可缩放的引入服务，每秒可以引入数百万的事件，使用户能够处理和分析连接设备和应用程序生成的海量数据。 事件中心充当事件管道的“前门”，将数据收集到事件中心后，可以使用任何实时分析提供程序或批处理/存储适配器来转换和存储这些数据。 事件中心可将事件流的生成与这些事件的使用分离开来，因此，事件使用者可以根据自己的计划访问事件。\r \r 本文介绍如何使用 Azure 事件中心记录 API 管理事件。\r \r ## <a name=\"create-an-azure-event-hub\"></a>创建 Azure 事件中心\r 若要创建新事件中心，请登录到 [Azure 经典管理门户](https://manage.windowsazure.cn)并依次单击“新建”->“应用服务”->“服务总线”->“事件中心”->“快速创建”。 输入事件中心名称、区域，选择订阅，并选择命名空间。 如果之前未创建命名空间，可通过在“命名空间”文本框中键入名称来创建命名空间。 配置所有属性后，单击“创建新事件中心”创建事件中心。\r \r ![创建事件中心][create-event-hub]\r \r 接下来，导航到新事件中心的“配置”选项卡，并创建两个**共享访问策略**。 将第一个命名为“Sending”，并为其提供 **Send** 权限。\r \r ![Sending 策略][sending-policy]\r \r 将第二个命名为“Receiving”，并为其提供 **Listen** 权限，然后单击“保存”。\r \r ![Receiving 策略][receiving-policy]\r \r 每个共享访问策略都允许应用程序与事件中心之间发送和接收事件。 若要访问这些策略的连接字符串，请导航到事件中心的“仪表板”选项卡并单击“连接信息”。\r \r ![连接字符串][event-hub-dashboard]\r \r **Sending** 连接字符串在记录事件时使用，**Receiving** 连接字符串在从事件中心下载事件时使用。\r \r ![连接字符串][event-hub-connection-string]\r \r ## <a name=\"create-an-api-management-logger\"></a>创建 API 管理记录器\r 现在有了事件中心，下一步是在 API 管理服务中配置[记录器](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/azure-api-management-rest-api-logger-entity)，以便它可以将事件记录到事件中心。\r \r 使用 [API 管理 REST API](http://aka.ms/smapi) 配置 API 管理记录器。 在第一次使用 REST API 之前，查看[先决条件](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/api-management-rest#Prerequisites)并确保已[启用对 REST API 的访问](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/api-management-rest#EnableRESTAPI)。\r \r 若要创建记录器，请使用以下 URL 模板发出 HTTP PUT 请求。\r \r `https://{your service}.management.azure-api.cn/loggers/{new logger name}?api-version=2014-02-14-preview`\r \r * 将 `{your service}` 替换为 API 管理服务实例的名称。\r * 将 `{new logger name}` 替换为新记录器的所需名称。 配置 [log-to-eventhub](https://msdn.microsoft.com/library/azure/dn894085.aspx#log-to-eventhub) 策略时，将引用此名称\r \r 将以下标头添加到请求。\r \r * 内容类型：application/json\r * 授权：SharedAccessSignature 58...\r   * 有关生成 `SharedAccessSignature` 的说明，请参阅 [Azure API 管理 REST API 身份验证](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/azure-api-management-rest-api-authentication)。\r \r 使用以下模板指定请求正文。\r \r ```json\r {\r   \"type\" : \"AzureEventHub\",\r   \"description\" : \"Sample logger description\",\r   \"credentials\" : {\r     \"name\" : \"Name of the Event Hub from the Azure Classic Portal\",\r     \"connectionString\" : \"Endpoint=Event Hub Sender connection string\"\r     }\r }\r ```\r \r * `type` 必须设置为 `AzureEventHub`。\r * `description` 提供记录器的可选说明，并且可在需要时为零长度字符串。\r * `credentials` 包含 Azure 事件中心的 `name` 和 `connectionString`。\r \r 发出请求时，如果创建记录器，则返回 `201 Created` 的状态代码。\r \r > [!NOTE]\r > 有关其他可能的返回代码及其原因，请参阅[创建记录器](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/azure-api-management-rest-api-logger-entity#PUT)。 若要查看如何执行其他操作，如列表、更新和删除，请参阅[记录器](https://docs.microsoft.com/rest/api/apimanagement/apimanagementrest/azure-api-management-rest-api-logger-entity)实体文档。\r >\r >\r \r ## <a name=\"configure-log-to-eventhubs-policies\"></a>配置 log-to-eventhubs 策略\r 在 API 管理中配置记录器后，可配置 log-to-eventhubs 策略以记录所需事件。 log-to-eventhubs 策略可在入站策略部分或出站策略部分中使用。\r \r 要配置策略，请登录到 [Azure 门户](https://portal.azure.cn)，导航到 API 管理服务，并单击“发布者门户”访问发布者门户。\r \r ![发布者门户][publisher-portal]\r \r 单击左侧 API 管理菜单中的“策略”，选择所需的产品和 API，并单击“添加策略”。 在此示例中，我们向 **Unlimited** 产品中的 **Echo API** 添加策略。\r \r ![添加策略][add-policy]\r \r 将光标放在 `inbound` 策略部分中，并单击“Log to EventHub”策略插入 `log-to-eventhub` 策略声明模板。\r \r ![策略编辑器][event-hub-policy]\r \r ```xml\r <log-to-eventhub logger-id ='logger-id'>\r   @( string.Join(\",\", DateTime.UtcNow, context.Deployment.ServiceName, context.RequestId, context.Request.IpAddress, context.Operation.Name))\r </log-to-eventhub>\r ```\r \r 将 `logger-id` 替换为在上一步中配置的 API 管理记录器的名称。\r \r 可使用返回字符串作为 `log-to-eventhub` 元素值的任何表达式。 在此示例中，记录包含日期和时间、服务名称、请求 ID、请求 IP 地址和操作名称的字符串。\r \r 单击“保存”保存更新后的策略配置。 保存后，策略立即处于活动状态，并且事件记录到指定的事件中心。\r \r ## <a name=\"next-steps\"></a>后续步骤\r * 了解有关 Azure 事件中心的详细信息\r   * [Azure 事件中心入门](../event-hubs/event-hubs-c-getstarted-send.md)\r   * [使用 EventProcessorHost 接收消息](../event-hubs/event-hubs-dotnet-standard-getstarted-receive-eph.md)\r   * [事件中心编程指南](../event-hubs/event-hubs-programming-guide.md)\r * 了解有关 API 管理和事件中心集成的详细信息\r   * [记录器实体引用](https://docs.microsoft.com/rest/api/apimanagement/loggers)\r   * [log-to-eventhub 策略引用](./api-management-advanced-policies.md#log-to-eventhub)\r   * [使用 Azure API 管理、事件中心和 Runscope 监视 API](./api-management-log-to-eventhub-sample.md)    \r \r \r \r [publisher-portal]: ./media/api-management-howto-log-event-hubs/publisher-portal.png\r [create-event-hub]: ./media/api-management-howto-log-event-hubs/create-event-hub.png\r [event-hub-connection-string]: ./media/api-management-howto-log-event-hubs/event-hub-connection-string.png\r [event-hub-dashboard]: ./media/api-management-howto-log-event-hubs/event-hub-dashboard.png\r [receiving-policy]: ./media/api-management-howto-log-event-hubs/receiving-policy.png\r [sending-policy]: ./media/api-management-howto-log-event-hubs/sending-policy.png\r [event-hub-policy]: ./media/api-management-howto-log-event-hubs/event-hub-policy.png\r [add-policy]: ./media/api-management-howto-log-event-hubs/add-policy.png\r "}