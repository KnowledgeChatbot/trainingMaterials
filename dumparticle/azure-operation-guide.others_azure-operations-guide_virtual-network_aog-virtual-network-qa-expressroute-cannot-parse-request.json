{"Title":"将不同订阅中的虚拟网络连接到 ExpressRoute 线路时收到报错'Cannot parse the request'","Description":"通过 PowerShell 将不同订阅中的虚拟网络连接到 ExpressRoute","Content":"\r # 将不同订阅中的虚拟网络连接到 ExpressRoute 线路时收到报错“Cannot parse the request” #\r \r ### 问题描述 ###\r \r 将不同订阅中的 虚拟网络（VNET） 连接到 ExpressRoute 线路时收到报错 “`Cannot parse the request`” 。\r \r ### 问题现象 ###\r \r 跨订阅连接 VNET 到 ExpressRoute 时报错如下：\r \r ![powershell-link-vnet-er](./media/aog-virtual-network-qa-expressroute-cannot-parse-request/powershell-link-vnet-er.png)\r \r ```\r PS C:\\Users\\crane> New-AzureRmVirtualNetworkGatewayConnection -Name ERConnection -ResourceGroupName craneARMERtest -Location \"China East\" -VirtualNetworkGateway1 $gw -PeerId $id -ConnectionType ExpressRoute -AuthorizationKey \"d3d7375f-aa95-4a97-97bf-cd4a68278189\" \r WARNING: The output object type of this cmdlet will be modified in a future release.\r New-AzureRmVirtualNetworkGatewayConnection : Cannot parse the request.\r StatusCode: 400\r ReasonPhrase: Bad Request\r OperationID : '827b1999-b489-4278-b526-fbf0df64e64b'\r At line:1 char:1\r + New-AzureRmVirtualNetworkGatewayConnection -Name ERConnection -Resour ...\r + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r     + CategoryInfo          : CloseError: (:) [New-AzureRmVirt...tewayConnection], NetworkCloudException\r     + FullyQualifiedErrorId : Microsoft.Azure.Commands.Network.NewAzureVirtualNetworkGatewayConnectionCommand\r ```\r \r ### 解决方法 ###\r \r 首先，需要了解跨订阅连接 VNET 到 ExpressRoute 的操作过程：\r \r **登录订阅**\r \r ```\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r ```\r \r **创建授权**\r \r ```\r $circuit=Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\"\r Add-AzureRmExpressRouteCircuitAuthorization -ExpressRouteCircuit $circuit -Name \"MyAuthorization\"\r Set-AzureRmExpressRouteCircuit -ExpressRouteCircuit $circuit\r $auth1=Get-AzureRmExpressRouteCircuitAuthorization -ExpressRouteCircuit $circuit -Name MyAuthorization \r ```\r \r **获取授权ID**\r \r `$ID=(Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\").id`\r  或 `/subscriptions/8775dxxxxxxxxxxxxxxxxxxxxxxxxx518/resourceGroups/CraneER/providers/Microsoft.Network/expressRouteCircuits/21VDemoSH` （在如下 Get 命令的输出中，将 ID 对应的条目下参数值 Copy 后赋值给 $ID\r `Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\"`）\r \r **登录到另外一个订阅 WATSTEST02**\r \r ```\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r ```\r \r **兑现授权**\r \r ```\r $gw=Get-AzureRmVirtualNetworkGateway -Name CraneARMERtestGW -ResourceGroupName craneARMERtest \r New-AzureRmVirtualNetworkGatewayConnection -Name ERConnection -ResourceGroupName craneARMERtest -Location \"China East\" -VirtualNetworkGateway1 $gw -PeerId $ID -ConnectionType ExpressRoute -AuthorizationKey \"d3d7375f-aa95-4a97-97bf-cd4a68278189\" \r ```\r \r >[!NOTE]\r ><p>此处的 `$ID` 赋值应为 `(Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\").id` 即：`\"/subscriptions/8775dxxxxxxxxxxxxxxxxxxxxxxxxx518/resourceGroups/CraneER/providers/Microsoft.Network/expressRouteCircuits/21VDemoSH\"`\r <p>而不是：`(Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\").Authorizations.id` 即：`\"/subscriptions/8775dxxxxxxxxxxxxxxxxxxxxxxxxx518/resourceGroups/CraneER/providers/Microsoft.Network/expressRouteCircuits/21VDemoSH/authorizations/MyAuthorization\"`。\r \r 出现 “`Cannot parse the request`” 的错误是因为 `$ID` 赋错值了。在 `Get-AzureRmExpressRouteCircuit -Name \"21VDemoSH\" -ResourceGroupName \"CraneER\"` 的输出中会有如下两个参数： `id` 及 `Authorizations.id` 。\r \r 此处需要给 `$ID` 赋值的参数是 `.id`，而不是 `Authorizations.id`，至此问题即可解决。\r \r ### 其它资源 ###\r \r [将虚拟网络链接到 ExpressRoute 线路](/expressroute/expressroute-howto-linkvnet-arm)"}