{"Title":"使用 Azure CLI 1.0 创建完整的 Linux 环境","Description":"使用 Azure CLI 1.0 从头开始创建存储、Linux VM、虚拟网络和子网、负载均衡器、NIC、公共 IP 和网络安全组。","Content":"# <a name=\"create-a-complete-linux-environment-with-the-azure-cli-10\"></a>使用 Azure CLI 1.0 创建完整的 Linux 环境\r 在本文中，我们构建一个简单网络，其中包含一个负载均衡器，以及一对可用于开发和简单计算的 VM。 将以逐条命令的方式完成整个过程，直到创建两个可以从 Internet 上的任何位置连接的有效且安全的 Linux VM。 然后，便可以继续构建更复杂的网络和环境。\r \r 在此过程中，可以了解 Resource Manager 部署模型提供的依赖性层次结构及其提供的功能。 明白系统是如何构建的以后，即可使用 [Azure Resource Manager 模板](../../resource-group-authoring-templates.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)更快速地重新构建系统。 此外，了解环境的各个部分如何彼此配合运行后，可以更轻松创建模板以实现自动化。\r \r 该环境包含：\r \r * 两个位于可用性集中的 VM。\r * 端口 80 上有一个带负载均衡规则的负载均衡器。\r * 网络安全组 (NSG) 规则，阻止 VM 接受不需要的流量。\r \r 若要创建此自定义环境，需要在 Resource Manager 模式 (`azure config mode arm`) 下安装最新的 [Azure CLI 1.0](../../cli-install-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。 此外，还需要一个 JSON 分析工具。 本示例使用 [jq](https://stedolan.github.io/jq/)。\r \r ## <a name=\"cli-versions-to-complete-the-task\"></a>用于完成任务的 CLI 版本\r 可使用以下 CLI 版本之一完成任务：\r \r - [Azure CLI 1.0](#quick-commands) - 适用于经典部署模型和资源管理部署模型（本文）的 CLI\r - [Azure CLI 2.0](create-cli-complete.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) - 适用于资源管理部署模型的下一代 CLI\r \r ## <a name=\"quick-commands\"></a>快速命令\r 如果需要快速完成任务，请参阅以下部分，其中详细说明了用于将 VM 上传到 Azure 的基本命令。 本文档的余下部分（ [从此处开始](#detailed-walkthrough)）提供了每个步骤的更详细信息和应用背景。\r \r 确保已登录 [Azure CLI 1.0](../../cli-install-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 并使用 Resource Manager 模式：\r \r ```azurecli\r azure config mode arm\r ```\r \r 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 `myResourceGroup`、`mystorageaccount` 和 `myVM`。\r \r 创建资源组。 以下示例在 `chinanorth` 位置创建名为 `myResourceGroup` 的资源组：\r \r ```azurecli\r azure group create -n myResourceGroup -l chinanorth\r ```\r \r 使用 JSON 分析器验证资源组：\r \r ```azurecli\r azure group show myResourceGroup --json | jq '.'\r ```\r \r 创建存储帐户。 以下示例创建名为 `mystorageaccount` 的存储帐户。 （存储帐户名称必须唯一，因此，请提供自己的唯一名称。）\r \r ```azurecli\r azure storage account create -g myResourceGroup -l chinanorth \\\r   --kind Storage --sku-name GRS mystorageaccount\r ```\r \r 使用 JSON 分析器验证存储帐户：\r \r ```azurecli\r azure storage account show -g myResourceGroup mystorageaccount --json | jq '.'\r ```\r \r 创建虚拟网络。 以下示例创建名为 `myVnet`的虚拟网络：\r \r ```azurecli\r azure network vnet create -g myResourceGroup -l chinanorth\\\r   -n myVnet -a 192.168.0.0/16\r ```\r \r 创建子网。 以下示例创建名为 `mySubnet`的子网：\r \r ```azurecli\r azure network vnet subnet create -g myResourceGroup \\\r   -e myVnet -n mySubnet -a 192.168.1.0/24\r ```\r \r 使用 JSON 分析器验证虚拟网络和子网：\r \r ```azurecli\r azure network vnet show myResourceGroup myVnet --json | jq '.'\r ```\r \r 创建公共 IP。 以下示例创建名为 `myPublicIP`、DNS 名称为 `mypublicdns` 的公共 IP。 （DNS 名称必须唯一，因此，请提供自己的唯一名称。）\r \r ```azurecli\r azure network public-ip create -g myResourceGroup -l chinanorth \\\r   -n myPublicIP  -d mypublicdns -a static -i 4\r ```\r \r 创建负载均衡器。 以下示例创建名为 `myLoadBalancer`的负载均衡器：\r \r ```azurecli\r azure network lb create -g myResourceGroup -l chinanorth -n myLoadBalancer\r ```\r \r 创建负载均衡器的前端 IP 池并关联公共 IP。 以下示例创建名为 `mySubnetPool`的前端 IP 池：\r \r ```azurecli\r azure network lb frontend-ip create -g myResourceGroup -l myLoadBalancer \\\r   -i myPublicIP -n myFrontEndPool\r ```\r \r 创建负载均衡器的后端 IP 池。 以下示例创建名为 `myBackEndPool` 的后端 IP 池：\r \r ```azurecli\r azure network lb address-pool create -g myResourceGroup -l myLoadBalancer \\\r   -n myBackEndPool\r ```\r \r 创建负载均衡器的 SSH 入站网络地址转换 (NAT) 规则。 以下示例创建两个负载均衡器规则，分别名为 `myLoadBalancerRuleSSH1` 和 `myLoadBalancerRuleSSH2`：\r \r ```azurecli\r azure network lb inbound-nat-rule create -g myResourceGroup -l myLoadBalancer \\\r   -n myLoadBalancerRuleSSH1 -p tcp -f 4222 -b 22\r azure network lb inbound-nat-rule create -g myResourceGroup -l myLoadBalancer \\\r   -n myLoadBalancerRuleSSH2 -p tcp -f 4223 -b 22\r ```\r \r 创建负载均衡器的 Web 入站 NAT 规则。 以下示例创建名为 `myLoadBalancerRuleWeb`的负载均衡器规则：\r \r ```azurecli\r azure network lb rule create -g myResourceGroup -l myLoadBalancer \\\r   -n myLoadBalancerRuleWeb -p tcp -f 80 -b 80 \\\r   -t myFrontEndPool -o myBackEndPool\r ```\r \r 创建负载均衡器运行状况探测。 以下示例创建名为 `myHealthProbe`的 TCP 探测：\r \r ```azurecli\r azure network lb probe create -g myResourceGroup -l myLoadBalancer \\\r   -n myHealthProbe -p \"tcp\" -i 15 -c 4\r ```\r \r 使用 JSON 分析器验证负载均衡器、IP 池和 NAT 规则：\r \r ```azurecli\r azure network lb show -g myResourceGroup -n myLoadBalancer --json | jq '.'\r ```\r \r 创建第一个网络接口卡 (NIC)。 将 `#####-###-###` 部分替换为自己的 Azure 订阅 ID。 检查所创建的资源时，订阅 ID 不会记录在 **jq** 的输出中。 也可以使用 `azure account list`查看订阅 ID。\r \r 以下示例创建名为 `myNic1`的 NIC：\r \r ```azurecli\r azure network nic create -g myResourceGroup -l chinanorth \\\r   -n myNic1 -m myVnet -k mySubnet \\\r   -d \"/subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\" \\\r   -e \"/subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\"\r ```\r \r 创建第二个 NIC。 以下示例创建名为 `myNic2`的 NIC：\r \r ```azurecli\r azure network nic create -g myResourceGroup -l chinanorth \\\r   -n myNic2 -m myVnet -k mySubnet \\\r   -d \"/subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\" \\\r   -e \"/subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH2\"\r ```\r \r 使用 JSON 分析器验证两个 NIC。\r \r ```azurecli\r azure network nic show myResourceGroup myNic1 --json | jq '.'\r azure network nic show myResourceGroup myNic2 --json | jq '.'\r ```\r \r 创建网络安全组。 以下示例创建名为 `myNetworkSecurityGroup`的网络安全组：\r \r ```azurecli\r azure network nsg create -g myResourceGroup -l chinanorth \\\r   -n myNetworkSecurityGroup\r ```\r \r 为网络安全组添加两个入站规则。 以下示例创建两个规则，分别名为 `myNetworkSecurityGroupRuleSSH` 和 `myNetworkSecurityGroupRuleHTTP`：\r \r ```azurecli\r azure network nsg rule create -p tcp -r inbound -y 1000 -u 22 -c allow \\\r   -g myResourceGroup -a myNetworkSecurityGroup -n myNetworkSecurityGroupRuleSSH\r azure network nsg rule create -p tcp -r inbound -y 1001 -u 80 -c allow \\\r   -g myResourceGroup -a myNetworkSecurityGroup -n myNetworkSecurityGroupRuleHTTP\r ```\r \r 使用 JSON 分析器验证网络安全组和入站规则：\r \r ```azurecli\r azure network nsg show -g myResourceGroup -n myNetworkSecurityGroup --json | jq '.'\r ```\r \r 将网络安全组绑定到两个 NIC：\r \r ```azurecli\r azure network nic set -g myResourceGroup -o myNetworkSecurityGroup -n myNic1\r azure network nic set -g myResourceGroup -o myNetworkSecurityGroup -n myNic2\r ```\r \r 创建可用性集。 以下示例创建名为 `myAvailabilitySet`的可用性集：\r \r ```azurecli\r azure availset create -g myResourceGroup -l chinanorth -n myAvailabilitySet\r ```\r \r 创建第一个 Linux VM。 以下示例创建名为 `myVM1`的 VM：\r \r ```azurecli\r azure vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM1 \\\r     --location chinanorth \\\r     --os-type linux \\\r     --availset-name myAvailabilitySet \\\r     --nic-name myNic1 \\\r     --vnet-name myVnet \\\r     --vnet-subnet-name mySubnet \\\r     --storage-account-name mystorageaccount \\\r     --image-urn canonical:UbuntuServer:16.04.0-LTS:latest \\\r     --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r     --admin-username azureuser\r ```\r \r 创建第二个 Linux VM。 以下示例创建名为 `myVM2`的 VM：\r \r ```azurecli\r azure vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM2 \\\r     --location chinanorth \\\r     --os-type linux \\\r     --availset-name myAvailabilitySet \\\r     --nic-name myNic2 \\\r     --vnet-name myVnet \\\r     --vnet-subnet-name mySubnet \\\r     --storage-account-name mystorageaccount \\\r     --image-urn canonical:UbuntuServer:16.04.0-LTS:latest \\\r     --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r     --admin-username azureuser\r ```\r \r 使用 JSON 分析器验证构建的所有组件：\r \r ```azurecli\r azure vm show -g myResourceGroup -n myVM1 --json | jq '.'\r azure vm show -g myResourceGroup -n myVM2 --json | jq '.'\r ```\r \r 将新环境导出到模板，以便快速重新创建新实例：\r \r ```azurecli\r azure group export myResourceGroup\r ```\r \r ## <a name=\"detailed-walkthrough\"></a>详细演练\r 下面的详细步骤说明构建环境时每条命令的作用。 了解这些概念有助于构建自己的自定义开发或生产环境。\r \r 确保已登录 [Azure CLI 1.0](../../cli-install-nodejs.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 并使用 Resource Manager 模式：\r \r ```azurecli\r azure config mode arm\r ```\r \r 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 `myResourceGroup`、`mystorageaccount` 和 `myVM`。\r \r ## <a name=\"create-resource-groups-and-choose-deployment-locations\"></a>创建资源组并选择部署位置\r Azure 资源组是逻辑部署实体，包含用于启用资源部署逻辑管理的配置信息和元数据。 以下示例在 `chinanorth` 位置创建名为 `myResourceGroup` 的资源组：\r \r ```azurecli\r azure group create --name myResourceGroup --location chinanorth\r ```\r \r 输出：\r \r ```azurecli                        \r info:    Executing command group create\r + Getting resource group myResourceGroup\r + Creating resource group myResourceGroup\r info:    Created resource group myResourceGroup\r data:    Id:                  /subscriptions/guid/resourceGroups/myResourceGroup\r data:    Name:                myResourceGroup\r data:    Location:            chinanorth\r data:    Provisioning State:  Succeeded\r data:    Tags: null\r data:\r info:    group create command OK\r ```\r \r ## <a name=\"create-a-storage-account\"></a>创建存储帐户\r 需要为 VM 磁盘和要添加的任何其他数据磁盘创建存储帐户。 创建资源组后，应立即创建存储帐户。\r \r 此处，使用 `azure storage account create` 命令传递帐户的位置、控制该帐户的资源组，以及所需的存储支持类型。 以下示例创建名为 `mystorageaccount`的存储帐户：\r \r ```azurecli\r azure storage account create \\  \r   --location chinanorth \\\r   --resource-group myResourceGroup \\\r   --kind Storage --sku-name GRS \\\r   mystorageaccount\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command storage account create\r + Creating storage account\r info:    storage account create command OK\r ```\r \r 若要通过 `azure group show` 命令检查资源组，可在 [jq`--json` 工具中结合使用 ](https://stedolan.github.io/jq/) Azure CLI 选项。 （可以使用 **jsawk** 或用于分析 JSON 的任何语言库。）\r \r ```azurecli\r azure group show myResourceGroup --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"tags\": {},\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup\",\r   \"name\": \"myResourceGroup\",\r   \"provisioningState\": \"Succeeded\",\r   \"location\": \"chinanorth\",\r   \"properties\": {\r     \"provisioningState\": \"Succeeded\"\r   },\r   \"resources\": [\r     {\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount\",\r       \"name\": \"mystorageaccount\",\r       \"type\": \"storageAccounts\",\r       \"location\": \"chinanorth\",\r       \"tags\": null\r     }\r   ],\r   \"permissions\": [\r     {\r       \"actions\": [\r         \"*\"\r       ],\r       \"notActions\": []\r     }\r   ]\r }\r ```\r \r 若要使用 CLI 检查存储帐户，首先需要设置帐户名和密钥。 将下例中的存储帐户名替换为所选的名称：\r \r ```bash\r export AZURE_STORAGE_CONNECTION_STRING=\"$(azure storage account connectionstring show mystorageaccount --resource-group myResourceGroup --json | jq -r '.string')\"\r ```\r \r 然后，可以轻松查看存储信息：\r \r ```azurecli\r azure storage container list\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command storage container list\r + Getting storage containers\r data:    Name  Public-Access  Last-Modified\r data:    ----  -------------  -----------------------------\r data:    vhds  Off            Sun, 27 Sep 2015 19:03:54 GMT\r info:    storage container list command OK\r ```\r \r ## <a name=\"create-a-virtual-network-and-subnet\"></a>创建虚拟网络和子网\r 接下来，需要创建一个在 Azure 中运行的虚拟网络，以及一个可在其中创建 VM 的子网。 以下示例创建名为 `myVnet`、地址前缀为 `192.168.0.0/16` 的虚拟网络：\r \r ```azurecli\r azure network vnet create --resource-group myResourceGroup --location chinanorth \\\r   --name myVnet --address-prefixes 192.168.0.0/16\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network vnet create\r + Looking up virtual network \"myVnet\"\r + Creating virtual network \"myVnet\"\r + Loading virtual network state\r data:    Id                              : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet\r data:    Name                            : myVnet\r data:    Type                            : Microsoft.Network/virtualNetworks\r data:    Location                        : chinanorth\r data:    ProvisioningState               : Succeeded\r data:    Address prefixes:\r data:      192.168.0.0/16\r info:    network vnet create command OK\r ```\r \r 同样，让我们使用 `azure group show` 的 --json 选项和 `jq` 来了解如何构建资源。 现在，我们有了一个 `storageAccounts` 资源和一个 `virtualNetworks` 资源。  \r \r ```azurecli\r azure group show myResourceGroup --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"tags\": {},\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup\",\r   \"name\": \"myResourceGroup\",\r   \"provisioningState\": \"Succeeded\",\r   \"location\": \"chinanorth\",\r   \"properties\": {\r     \"provisioningState\": \"Succeeded\"\r   },\r   \"resources\": [\r     {\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet\",\r       \"name\": \"myVnet\",\r       \"type\": \"virtualNetworks\",\r       \"location\": \"chinanorth\",\r       \"tags\": null\r     },\r     {\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount\",\r       \"name\": \"mystorageaccount\",\r       \"type\": \"storageAccounts\",\r       \"location\": \"chinanorth\",\r       \"tags\": null\r     }\r   ],\r   \"permissions\": [\r     {\r       \"actions\": [\r         \"*\"\r       ],\r       \"notActions\": []\r     }\r   ]\r }\r ```\r \r 现在，需在部署 VM 的 `myVnet` 虚拟网络中创建子网。 使用 `azure network vnet subnet create` 命令以及已创建的资源：`myResourceGroup` 资源组和 `myVnet` 虚拟网络。 在以下示例中，会添加一个名为 `mySubnet` 的子网，其子网地址前缀为 `192.168.1.0/24`：\r \r ```azurecli\r azure network vnet subnet create --resource-group myResourceGroup \\\r   --vnet-name myVnet --name mySubnet --address-prefix 192.168.1.0/24\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network vnet subnet create\r + Looking up the subnet \"mySubnet\"\r + Creating subnet \"mySubnet\"\r + Looking up the subnet \"mySubnet\"\r data:    Id                              : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\r data:    Type                            : Microsoft.Network/virtualNetworks/subnets\r data:    ProvisioningState               : Succeeded\r data:    Name                            : mySubnet\r data:    Address prefix                  : 192.168.1.0/24\r data:\r info:    network vnet subnet create command OK\r ```\r \r 由于子网以逻辑方式出现在虚拟网络中，可使用稍微不同的命令来查找子网信息。 使用的命令为 `azure network vnet show`，但会继续使用 `jq` 检查 JSON 输出。\r \r ```azurecli\r azure network vnet show myResourceGroup myVnet --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"subnets\": [\r     {\r       \"ipConfigurations\": [],\r       \"addressPrefix\": \"192.168.1.0/24\",\r       \"provisioningState\": \"Succeeded\",\r       \"name\": \"mySubnet\",\r       \"etag\": \"W/\\\"974f3e2c-028e-4b35-832b-a4b16ad25eb6\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\"\r     }\r   ],\r   \"tags\": {},\r   \"addressSpace\": {\r     \"addressPrefixes\": [\r       \"192.168.0.0/16\"\r     ]\r   },\r   \"dhcpOptions\": {\r     \"dnsServers\": []\r   },\r   \"provisioningState\": \"Succeeded\",\r   \"etag\": \"W/\\\"974f3e2c-028e-4b35-832b-a4b16ad25eb6\\\"\",\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet\",\r   \"name\": \"myVnet\",\r   \"location\": \"chinanorth\"\r }\r ```\r \r ## <a name=\"create-a-public-ip-address\"></a>创建公共 IP 地址\r 现在，需要创建分配给负载均衡器的公共 IP 地址 (PIP)。 使用该地址可以通过 `azure network public-ip create` 命令从 Internet 连接到 VM。 由于默认地址是动态的，因此可使用 `--domain-name-label` 选项在 **chinacloudapp.cn** 域中创建一个命名的 DNS 条目。 以下示例创建名为 `myPublicIP`、DNS 名称为 `mypublicdns` 的公共 IP。 由于 DNS 名称必须唯一，因此，请提供自己的唯一 DNS 名称：\r \r ```azurecli\r azure network public-ip create --resource-group myResourceGroup \\\r   --location chinanorth --name myPublicIP --domain-name-label mypublicdns\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network public-ip create\r + Looking up the public ip \"myPublicIP\"\r + Creating public ip address \"myPublicIP\"\r + Looking up the public ip \"myPublicIP\"\r data:    Id                              : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\r data:    Name                            : myPublicIP\r data:    Type                            : Microsoft.Network/publicIPAddresses\r data:    Location                        : chinanorth\r data:    Provisioning state              : Succeeded\r data:    Allocation method               : Dynamic\r data:    Idle timeout                    : 4\r data:    Domain name label               : mypublicdns\r data:    FQDN                            : mypublicdns.chinanorth.chinacloudapp.cn\r info:    network public-ip create command OK\r ```\r \r 公共 IP 地址也是顶级资源，因此可以使用 `azure group show`查看。\r \r ```azurecli\r azure group show myResourceGroup --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r \"tags\": {},\r \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup\",\r \"name\": \"myResourceGroup\",\r \"provisioningState\": \"Succeeded\",\r \"location\": \"chinanorth\",\r \"properties\": {\r     \"provisioningState\": \"Succeeded\"\r },\r \"resources\": [\r     {\r     \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\",\r     \"name\": \"myPublicIP\",\r     \"type\": \"publicIPAddresses\",\r     \"location\": \"chinanorth\",\r     \"tags\": null\r     },\r     {\r     \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet\",\r     \"name\": \"myVnet\",\r     \"type\": \"virtualNetworks\",\r     \"location\": \"chinanorth\",\r     \"tags\": null\r     },\r     {\r     \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount\",\r     \"name\": \"mystorageaccount\",\r     \"type\": \"storageAccounts\",\r     \"location\": \"chinanorth\",\r     \"tags\": null\r     }\r ],\r \"permissions\": [\r     {\r     \"actions\": [\r         \"*\"\r     ],\r     \"notActions\": []\r     }\r ]\r }\r ```\r \r 可以查看更多资源详细信息，包括使用完整的 `azure network public-ip show` 命令查看子域的完全限定域名 (FQDN)。 公共 IP 地址资源已经以逻辑方式分配，但尚未分配有特定地址。 若要获取 IP 地址，需要一个负载均衡器，但该负载均衡器尚未创建。\r \r ```azurecli\r azure network public-ip show myResourceGroup myPublicIP --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r \"tags\": {},\r \"publicIpAllocationMethod\": \"Dynamic\",\r \"dnsSettings\": {\r     \"domainNameLabel\": \"mypublicdns\",\r     \"fqdn\": \"mypublicdns.chinanorth.chinacloudapp.cn\"\r },\r \"idleTimeoutInMinutes\": 4,\r \"provisioningState\": \"Succeeded\",\r \"etag\": \"W/\\\"c63154b3-1130-49b9-a887-877d74d5ebc5\\\"\",\r \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\",\r \"name\": \"myPublicIP\",\r \"location\": \"chinanorth\"\r }\r ```\r \r ## <a name=\"create-a-load-balancer-and-ip-pools\"></a>创建负载均衡器和 IP 池\r 创建负载均衡器时，可以将流量分散到多个 VM。 负载均衡器还可以在执行维护或承受重负载时运行多个 VM 来响应用户请求，为应用程序提供冗余。 以下示例创建名为 `myLoadBalancer`的负载均衡器：\r \r ```azurecli\r azure network lb create --resource-group myResourceGroup --location chinanorth \\\r   --name myLoadBalancer\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb create\r + Looking up the load balancer \"myLoadBalancer\"\r + Creating load balancer \"myLoadBalancer\"\r data:    Id                              : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer\r data:    Name                            : myLoadBalancer\r data:    Type                            : Microsoft.Network/loadBalancers\r data:    Location                        : chinanorth\r data:    Provisioning state              : Succeeded\r info:    network lb create command OK\r ```\r \r 我们的负载均衡器很空，因此让我们创建一些 IP 池。 我们想要为负载均衡器创建两个 IP 池：一个用于前端，一个用于后端。 前端 IP 池会公开显示。 它也是我们将前面创建的 PIP 分配到的位置。 然后我们使用后端池作为 VM 要连接到的位置。 这样，流量便可以通过负载均衡器流向 VM。\r \r 首先，创建前端 IP 池。 以下示例创建名为 `myFrontEndPool`的前端池：\r \r ```azurecli\r azure network lb frontend-ip create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --public-ip-name myPublicIP \\\r   --name myFrontEndPool\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb frontend-ip create\r + Looking up the load balancer \"myLoadBalancer\"\r + Looking up the public ip \"myPublicIP\"\r + Updating load balancer \"myLoadBalancer\"\r data:    Name                            : myFrontEndPool\r data:    Provisioning state              : Succeeded\r data:    Private IP allocation method    : Dynamic\r data:    Public IP address id            : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\r info:    network lb mySubnet-ip create command OK\r ```\r \r 请注意如何使用 `--public-ip-name` 开关传入前面创建的 `myPublicIP`。 通过将公共 IP 地址分配给负载均衡器，可以通过 Internet 访问 VM。\r \r 接下来，创建第二个 IP 池，用于传输后端流量。 以下示例创建名为 `myBackEndPool`的后端池：\r \r ```azurecli\r azure network lb address-pool create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --name myBackEndPool\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb address-pool create\r + Looking up the load balancer \"myLoadBalancer\"\r + Updating load balancer \"myLoadBalancer\"\r data:    Name                            : myBackEndPool\r data:    Provisioning state              : Succeeded\r info:    network lb address-pool create command OK\r ```\r \r 可以通过查看 `azure network lb show` 和 JSON 输出来了解负载均衡器的工作情况：\r \r ```azurecli\r azure network lb show myResourceGroup myLoadBalancer --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"etag\": \"W/\\\"29c38649-77d6-43ff-ab8f-977536b0047c\\\"\",\r   \"provisioningState\": \"Succeeded\",\r   \"resourceGuid\": \"f1446acb-09ba-44d9-b8b6-849d9983dc09\",\r   \"outboundNatRules\": [],\r   \"inboundNatPools\": [],\r   \"inboundNatRules\": [],\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer\",\r   \"name\": \"myLoadBalancer\",\r   \"type\": \"Microsoft.Network/loadBalancers\",\r   \"location\": \"chinanorth\",\r   \"mySubnetIPConfigurations\": [\r     {\r       \"etag\": \"W/\\\"29c38649-77d6-43ff-ab8f-977536b0047c\\\"\",\r       \"name\": \"myFrontEndPool\",\r       \"provisioningState\": \"Succeeded\",\r       \"publicIPAddress\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\"\r       },\r       \"privateIPAllocationMethod\": \"Dynamic\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\"\r     }\r   ],\r   \"backendAddressPools\": [\r     {\r       \"etag\": \"W/\\\"29c38649-77d6-43ff-ab8f-977536b0047c\\\"\",\r       \"name\": \"myBackEndPool\",\r       \"provisioningState\": \"Succeeded\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\"\r     }\r   ],\r   \"loadBalancingRules\": [],\r   \"probes\": []\r }\r ```\r \r ## <a name=\"create-load-balancer-nat-rules\"></a>创建负载均衡器 NAT 规则\r 若要获取流经负载均衡器的流量，需要创建网络地址转换 (NAT) 规则来指定入站或出站操作。 可以指定要使用的协议，并根据需要将外部端口映射到内部端口。 针对我们的环境，让我们创建一些规则，以允许通过负载均衡器对 VM 进行 SSH 访问。 将 TCP 端口 4222 和 4223 设置为定向到 VM 上的 TCP 端口 22（稍后会创建）。 以下示例创建名为 `myLoadBalancerRuleSSH1` 的规则，用于将 TCP 端口 4222 映射到端口 22：\r \r ```azurecli\r azure network lb inbound-nat-rule create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --name myLoadBalancerRuleSSH1 \\\r   --protocol tcp --frontend-port 4222 --backend-port 22\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb inbound-nat-rule create\r + Looking up the load balancer \"myLoadBalancer\"\r warn:    Using default enable floating ip: false\r warn:    Using default idle timeout: 4\r warn:    Using default mySubnet IP configuration \"myFrontEndPool\"\r + Updating load balancer \"myLoadBalancer\"\r data:    Name                            : myLoadBalancerRuleSSH1\r data:    Provisioning state              : Succeeded\r data:    Protocol                        : Tcp\r data:    mySubnet port                   : 4222\r data:    Backend port                    : 22\r data:    Enable floating IP              : false\r data:    Idle timeout in minutes         : 4\r data:    mySubnet IP configuration id    : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\r info:    network lb inbound-nat-rule create command OK\r ```\r \r 对于第二个 NAT 规则中的 SSH 访问，重复该过程。 以下示例创建名为 `myLoadBalancerRuleSSH2` 的规则，用于将 TCP 端口 4223 映射到端口 22：\r \r ```azurecli\r azure network lb inbound-nat-rule create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --name myLoadBalancerRuleSSH2 --protocol tcp \\\r   --frontend-port 4223 --backend-port 22\r ```\r \r 让我们继续为用于传输 Web 流量的 TCP 端口 80 创建 NAT 规则，并将该规则挂接到 IP 池。 如果将规则挂接到 IP 池，而不是将规则逐个挂接到 VM，则可以在 IP 池中添加或删除 VM。 负载均衡器会自动调整流量流。 以下示例创建名为 `myLoadBalancerRuleWeb` 的规则，用于将 TCP 端口 80 映射到端口 80：\r \r ```azurecli\r azure network lb rule create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --name myLoadBalancerRuleWeb --protocol tcp \\\r   --frontend-port 80 --backend-port 80 --frontend-ip-name myFrontEndPool \\\r   --backend-address-pool-name myBackEndPool\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb rule create\r + Looking up the load balancer \"myLoadBalancer\"\r warn:    Using default idle timeout: 4\r warn:    Using default enable floating ip: false\r warn:    Using default load distribution: Default\r + Updating load balancer \"myLoadBalancer\"\r data:    Name                            : myLoadBalancerRuleWeb\r data:    Provisioning state              : Succeeded\r data:    Protocol                        : Tcp\r data:    mySubnet port                   : 80\r data:    Backend port                    : 80\r data:    Enable floating IP              : false\r data:    Load distribution               : Default\r data:    Idle timeout in minutes         : 4\r data:    mySubnet IP configuration id    : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\r data:    Backend address pool id         : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\r info:    network lb rule create command OK\r ```\r \r ## <a name=\"create-a-load-balancer-health-probe\"></a>创建负载均衡器运行状况探测\r 运行状况探测定期检查受负载均衡器后面的 VM，以确保它们可以根据定义操作和响应请求。 否则，会从操作中删除这些 VM，确保不会将用户定向到它们。 可以针对运行状况探测定义自定义检查，以及间隔和超时值。 有关运行状况探测的详细信息，请参阅[负载均衡器探测](../../load-balancer/load-balancer-custom-probe-overview.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。 以下示例创建名为 `myHealthProbe`的 TCP 运行状况探测：\r \r ```azurecli\r azure network lb probe create --resource-group myResourceGroup \\\r   --lb-name myLoadBalancer --name myHealthProbe --protocol \"tcp\" \\\r   --interval 15 --count 4\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network lb probe create\r warn:    Using default probe port: 80\r + Looking up the load balancer \"myLoadBalancer\"\r + Updating load balancer \"myLoadBalancer\"\r data:    Name                            : myHealthProbe\r data:    Provisioning state              : Succeeded\r data:    Protocol                        : Tcp\r data:    Port                            : 80\r data:    Interval in seconds             : 15\r data:    Number of probes                : 4\r info:    network lb probe create command OK\r ```\r \r 此处我们指定了 15 秒的运行状况检查间隔。 在负载均衡器将该主机视为不再正常运行之前，我们最多可能会错过四个探测（1 分钟）。\r \r ## <a name=\"verify-the-load-balancer\"></a>验证负载均衡器\r 现已完成负载均衡器配置。 以下是执行的步骤：\r \r 1. 创建负载均衡器。\r 2. 创建前端 IP 池并为其分配公共 IP。\r 3. 创建 VM 可以连接到的后端 IP 池。\r 4. 创建允许通过 SSH 连接到 VM 以进行管理的 NAT 规则，以及允许对 Web 应用使用 TCP 端口 80 的规则。\r 5. 添加一个运行状况探测来定期检查 VM。 此运行状况探测可以确保用户不会尝试访问不再正常运行和不再提供内容的 VM。\r \r 让我们查看负载均衡器现在的情形：\r \r ```azurecli\r azure network lb show --resource-group myResourceGroup \\\r   --name myLoadBalancer --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r   \"provisioningState\": \"Succeeded\",\r   \"resourceGuid\": \"f1446acb-09ba-44d9-b8b6-849d9983dc09\",\r   \"outboundNatRules\": [],\r   \"inboundNatPools\": [],\r   \"inboundNatRules\": [\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myLoadBalancerRuleSSH1\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\",\r       \"mySubnetIPConfiguration\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\"\r       },\r       \"protocol\": \"Tcp\",\r       \"mySubnetPort\": 4222,\r       \"backendPort\": 22,\r       \"idleTimeoutInMinutes\": 4,\r       \"enableFloatingIP\": false,\r       \"provisioningState\": \"Succeeded\"\r     },\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myLoadBalancerRuleSSH2\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH2\",\r       \"mySubnetIPConfiguration\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\"\r       },\r       \"protocol\": \"Tcp\",\r       \"mySubnetPort\": 4223,\r       \"backendPort\": 22,\r       \"idleTimeoutInMinutes\": 4,\r       \"enableFloatingIP\": false,\r       \"provisioningState\": \"Succeeded\"\r     }\r   ],\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer\",\r   \"name\": \"myLoadBalancer\",\r   \"type\": \"Microsoft.Network/loadBalancers\",\r   \"location\": \"chinanorth\",\r   \"mySubnetIPConfigurations\": [\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myFrontEndPool\",\r       \"provisioningState\": \"Succeeded\",\r       \"publicIPAddress\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\"\r       },\r       \"privateIPAllocationMethod\": \"Dynamic\",\r       \"loadBalancingRules\": [\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/loadBalancingRules/myLoadBalancerRuleWeb\"\r         }\r       ],\r       \"inboundNatRules\": [\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\"\r         },\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH2\"\r         }\r       ],\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\"\r     }\r   ],\r   \"backendAddressPools\": [\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myBackEndPool\",\r       \"provisioningState\": \"Succeeded\",\r       \"loadBalancingRules\": [\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/loadBalancingRules/myLoadBalancerRuleWeb\"\r         }\r       ],\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\"\r     }\r   ],\r   \"loadBalancingRules\": [\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myLoadBalancerRuleWeb\",\r       \"provisioningState\": \"Succeeded\",\r       \"enableFloatingIP\": false,\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/loadBalancingRules/myLoadBalancerRuleWeb\",\r       \"mySubnetIPConfiguration\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/mySubnetIPConfigurations/myFrontEndPool\"\r       },\r       \"backendAddressPool\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\"\r       },\r       \"protocol\": \"Tcp\",\r       \"loadDistribution\": \"Default\",\r       \"mySubnetPort\": 80,\r       \"backendPort\": 80,\r       \"idleTimeoutInMinutes\": 4\r     }\r   ],\r   \"probes\": [\r     {\r       \"etag\": \"W/\\\"62a7c8e7-859c-48d3-8e76-5e078c5e4a02\\\"\",\r       \"name\": \"myHealthProbe\",\r       \"provisioningState\": \"Succeeded\",\r       \"numberOfProbes\": 4,\r       \"intervalInSeconds\": 15,\r       \"port\": 80,\r       \"protocol\": \"Tcp\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/probes/myHealthProbe\"\r     }\r   ]\r }\r ```\r \r ## <a name=\"create-an-nic-to-use-with-the-linux-vm\"></a>创建用于 Linux VM 的 NIC\r 由于可以对 NIC 使用应用规则，因此能以编程方式使用 NIC。 可以创建多个规则。 在下面的 `azure network nic create` 命令中，要将 NIC 挂接到负载后端 IP 池，并与 NAT 规则关联以允许 SSH 流量。\r \r 将 `#####-###-###` 部分替换为自己的 Azure 订阅 ID。 检查所创建的资源时，订阅 ID 不会记录在 `jq` 的输出中。 也可以使用 `azure account list`查看订阅 ID。\r \r 以下示例创建名为 `myNic1`的 NIC：\r \r ```azurecli\r azure network nic create --resource-group myResourceGroup --location chinanorth \\\r   --subnet-vnet-name myVnet --subnet-name mySubnet --name myNic1 \\\r   --lb-address-pool-ids /subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool \\\r   --lb-inbound-nat-rule-ids /subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command network nic create\r + Looking up the subnet \"mySubnet\"\r + Looking up the network interface \"myNic1\"\r + Creating network interface \"myNic1\"\r data:    Id                              : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNic1\r data:    Name                            : myNic1\r data:    Type                            : Microsoft.Network/networkInterfaces\r data:    Location                        : chinanorth\r data:    Provisioning state              : Succeeded\r data:    Enable IP forwarding            : false\r data:    IP configurations:\r data:      Name                          : Nic-IP-config\r data:      Provisioning state            : Succeeded\r data:      Private IP address            : 192.168.1.4\r data:      Private IP allocation method  : Dynamic\r data:      Subnet                        : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\r data:      Load balancer backend address pools:\r data:        Id                          : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\r data:      Load balancer inbound NAT rules:\r data:        Id                          : /subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\r data:\r info:    network nic create command OK\r ```\r \r 可以通过直接检查资源来查看详细信息。 使用 `azure network nic show` 命令检查资源：\r \r ```azurecli\r azure network nic show myResourceGroup myNic1 --json | jq '.'\r ```\r \r 输出：\r \r ```json\r {\r   \"etag\": \"W/\\\"fc1eaaa1-ee55-45bd-b847-5a08c7f4264a\\\"\",\r   \"provisioningState\": \"Succeeded\",\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNic1\",\r   \"name\": \"myNic1\",\r   \"type\": \"Microsoft.Network/networkInterfaces\",\r   \"location\": \"chinanorth\",\r   \"ipConfigurations\": [\r     {\r       \"etag\": \"W/\\\"fc1eaaa1-ee55-45bd-b847-5a08c7f4264a\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNic1/ipConfigurations/Nic-IP-config\",\r       \"loadBalancerBackendAddressPools\": [\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool\"\r         }\r       ],\r       \"loadBalancerInboundNatRules\": [\r         {\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH1\"\r         }\r       ],\r       \"privateIPAddress\": \"192.168.1.4\",\r       \"privateIPAllocationMethod\": \"Dynamic\",\r       \"subnet\": {\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\"\r       },\r       \"provisioningState\": \"Succeeded\",\r       \"name\": \"Nic-IP-config\"\r     }\r   ],\r   \"dnsSettings\": {\r     \"appliedDnsServers\": [],\r     \"dnsServers\": []\r   },\r   \"enableIPForwarding\": false,\r   \"resourceGuid\": \"a20258b8-6361-45f6-b1b4-27ffed28798c\"\r }\r ```\r \r 现在，我们创建第二个 NIC 并同样将其挂接到后端 IP 池。 这一次，第二个 NAT 规则允许 SSH 流。 以下示例创建名为 `myNic2`的 NIC：\r \r ```azurecli\r azure network nic create --resource-group myResourceGroup --location chinanorth \\\r   --subnet-vnet-name myVnet --subnet-name mySubnet --name myNic2 \\\r   --lb-address-pool-ids  /subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/backendAddressPools/myBackEndPool \\\r   --lb-inbound-nat-rule-ids /subscriptions/########-####-####-####-############/resourceGroups/myResourceGroup/providers/Microsoft.Network/loadBalancers/myLoadBalancer/inboundNatRules/myLoadBalancerRuleSSH2\r ```\r \r ## <a name=\"create-a-network-security-group-and-rules\"></a>创建网络安全组和规则\r 现在，我们创建网络安全组和用于控制 NIC 访问权限的入站规则。 可将网络安全组应用到 NIC 或子网。 定义用于控制传入和传出 VM 的流量流的规则。 以下示例创建名为 `myNetworkSecurityGroup` 的网络安全组：\r \r ```azurecli\r azure network nsg create --resource-group myResourceGroup --location chinanorth \\\r   --name myNetworkSecurityGroup\r ```\r \r 添加 NSG 的入站规则，允许端口 22 上的入站连接（以支持 SSH）。 以下示例创建名为 `myNetworkSecurityGroupRuleSSH` 的规则，以便在 端口 22 上允许 TCP：\r \r ```azurecli\r azure network nsg rule create --resource-group myResourceGroup \\\r   --nsg-name myNetworkSecurityGroup --protocol tcp --direction inbound \\\r   --priority 1000 --destination-port-range 22 --access allow \\\r   --name myNetworkSecurityGroupRuleSSH\r ```\r \r 现在，添加 NSG 的入站规则，允许端口 80 上的入站连接（以支持 Web 流量）。 以下示例创建名为 `myNetworkSecurityGroupRuleHTTP` 的规则，以便在 端口 80 上允许 TCP：\r \r ```azurecli\r azure network nsg rule create --resource-group myResourceGroup \\\r   --nsg-name myNetworkSecurityGroup --protocol tcp --direction inbound \\\r   --priority 1001 --destination-port-range 80 --access allow \\\r   --name myNetworkSecurityGroupRuleHTTP\r ```\r \r > [!NOTE]\r > 入站规则是入站网络连接的筛选器。 在本示例中，我们将 NSG 绑定到 VM 虚拟 NIC，这意味着任何对端口 22 的请求都会在 VM 上传递到 NIC。 此入站规则与网络连接相关，而不与终结点相关（终结点与经典部署相关）。 若要打开端口，必须将 `--source-port-range` 保持设置为“\\*”（默认值）才能接受来自**任何**请求端口的入站请求。 端口通常是动态的。\r >\r >\r \r ## <a name=\"bind-to-the-nic\"></a>绑定到 NIC\r 将 NSG 绑定到 NIC。 需要将 NIC 与网络安全组相连接。 运行以下两个命令来挂接两个 NIC：\r \r ```azurecli\r azure network nic set --resource-group myResourceGroup --name myNic1 \\\r   --network-security-group-name myNetworkSecurityGroup\r ```\r \r ```azurecli\r azure network nic set --resource-group myResourceGroup --name myNic2 \\\r   --network-security-group-name myNetworkSecurityGroup\r ```\r \r ## <a name=\"create-an-availability-set\"></a>创建可用性集\r 可用性集有助于将 VM 分散到容错域和升级域。 让我们为 VM 创建一个可用性集。 以下示例创建名为 `myAvailabilitySet`的可用性集：\r \r ```azurecli\r azure availset create --resource-group myResourceGroup --location chinanorth\r   --name myAvailabilitySet\r ```\r \r 容错域定义共享通用电源和网络交换机的一组虚拟机。 默认情况下，在可用性集中配置的虚拟机隔离在最多三个容错域中。 思路是其中一个容错域中的硬件问题不会影响运行应用的每个 VM。 将多个 VM 放入一个可用性集时，Azure 会自动将它们分散到容错域。\r \r 升级域表示虚拟机组以及可同时重新启动的基础物理硬件。 在计划内维护期间，升级域的重新启动顺序可能不会按序进行，但一次只重新启动一个升级域。 同样，将多个 VM 放入一个可用性站点时，Azure 会自动将它们分散到升级域。\r \r 请阅读有关[管理 VM 可用性](manage-availability.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)的详细信息。\r \r ## <a name=\"create-the-linux-vms\"></a>创建 Linux VM\r 已经创建存储和网络资源，支持可访问 Internet 的 VM。 现在，创建 VM 并使用不含密码的 SSH 密钥保护其安全。 在此情况下，我们需要基于最新的 LTS 创建 Ubuntu VM。 我们会根据 [查找 Azure VM 映像](../windows/cli-ps-findimage.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)中所述，使用 `azure vm image list` 来查找该映像信息。\r \r 我们使用命令 `azure vm image list chinanorth canonical | grep LTS` 选择了映像。 在此示例中，使用 `canonical:UbuntuServer:16.04.0-LTS:16.04.201608150`。 对于最后一个字段，我们传递 `latest`，以便将来可随时获取最新的内部版本。 （使用的字符串是 `canonical:UbuntuServer:16.04.0-LTS:16.04.201608150`）。\r \r 已使用 **ssh-keygen -t rsa -b 2048** 在 Linux 或 Mac 上创建 ssh rsa 公钥和私钥对的任何人都熟悉下一个步骤。 如果 `~/.ssh` 目录中没有任何证书密钥对，可以创建证书密钥对：\r \r * 使用 `azure vm create --generate-ssh-keys` 选项自动创建。\r * [根据说明手动自行创建](mac-create-ssh-keys.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。\r \r 或者，可以在创建 VM 之后，使用 `--admin-password` 方法对 SSH 连接进行身份验证。 此方法通常不太安全。\r \r 我们使用 `azure vm create` 命令并结合所有资源和信息来创建 VM：\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM1 \\\r   --location chinanorth \\\r   --os-type linux \\\r   --availset-name myAvailabilitySet \\\r   --nic-name myNic1 \\\r   --vnet-name myVnet \\\r   --vnet-subnet-name mySubnet \\\r   --storage-account-name mystorageaccount \\\r   --image-urn canonical:UbuntuServer:16.04.0-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username azureuser\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command vm create\r + Looking up the VM \"myVM1\"\r info:    Verifying the public key SSH file: /home/ahmet/.ssh/id_rsa.pub\r info:    Using the VM Size \"Standard_DS1\"\r info:    The [OS, Data] Disk or image configuration requires storage account\r + Looking up the storage account mystorageaccount\r + Looking up the availability set \"myAvailabilitySet\"\r info:    Found an Availability set \"myAvailabilitySet\"\r + Looking up the NIC \"myNic1\"\r info:    Found an existing NIC \"myNic1\"\r info:    Found an IP configuration with virtual network subnet id \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\" in the NIC \"myNic1\"\r info:    This is an NIC without publicIP configured\r info:    The storage URI 'https://mystorageaccount.blob.core.chinacloudapi.cn/' will be used for boot diagnostics settings, and it can be overwritten by the parameter input of '--boot-diagnostics-storage-uri'.\r info:    vm create command OK\r ```\r \r 可以使用默认的 SSH 密钥立即连接到 VM。 请确保指定适当的端口，因为我们要通过负载均衡器传递流量。 （对于第一个 VM，设置 NAT 规则以将端口 4222 转发到 VM。）\r \r ```bash\r ssh ops@mypublicdns.chinanorth.chinacloudapp.cn -p 4222\r ```\r \r 输出：\r \r ```bash\r The authenticity of host '[mypublicdns.chinanorth.chinacloudapp.cn]:4222 ([xx.xx.xx.xx]:4222)' can't be established.\r ECDSA key fingerprint is 94:2d:d0:ce:6b:fb:7f:ad:5b:3c:78:93:75:82:12:f9.\r Are you sure you want to continue connecting (yes/no)? yes\r Warning: Permanently added '[mypublicdns.chinanorth.chinacloudapp.cn]:4222,[xx.xx.xx.xx]:4222' (ECDSA) to the list of known hosts.\r Welcome to Ubuntu 16.04.1 LTS (GNU/Linux 4.4.0-34-generic x86_64)\r \r  * Documentation:  https://help.ubuntu.com\r  * Management:     https://landscape.canonical.com\r  * Support:        https://ubuntu.com/advantage\r \r   Get cloud support with Ubuntu Advantage Cloud Guest:\r     http://www.ubuntu.com/business/services/cloud\r \r 0 packages can be updated.\r 0 updates are security updates.\r \r ops@myVM1:~$\r ```\r \r 以相同的方式继续创建第二个 VM：\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM2 \\\r   --location chinanorth \\\r   --os-type linux \\\r   --availset-name myAvailabilitySet \\\r   --nic-name myNic2 \\\r   --vnet-name myVnet \\\r   --vnet-subnet-name mySubnet \\\r   --storage-account-name mystorageaccount \\\r   --image-urn canonical:UbuntuServer:16.04.0-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username azureuser\r ```\r \r 现在，可以使用 `azure vm show myResourceGroup myVM1` 命令检查创建的内容。 此时，已在 Azure 中运行了一个位于负载均衡器后面的 Ubuntu VM，只能使用 SSH 密钥对登录到该 VM（因为密码已禁用）。 可以安装 nginx 或 httpd、部署 Web 应用，以及查看流量是否通过负载均衡器流向两个 VM。\r \r ```azurecli\r azure vm show --resource-group myResourceGroup --name myVM1\r ```\r \r 输出：\r \r ```azurecli\r info:    Executing command vm show\r + Looking up the VM \"TestVM1\"\r + Looking up the NIC \"myNic1\"\r data:    Id                              :/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM1\r data:    ProvisioningState               :Succeeded\r data:    Name                            :myVM1\r data:    Location                        :chinanorth\r data:    Type                            :Microsoft.Compute/virtualMachines\r data:\r data:    Hardware Profile:\r data:      Size                          :Standard_DS1\r data:\r data:    Storage Profile:\r data:      Image reference:\r data:        Publisher                   :canonical\r data:        Offer                       :UbuntuServer\r data:        Sku                         :16.04.0-LTS\r data:        Version                     :latest\r data:\r data:      OS Disk:\r data:        OSType                      :Linux\r data:        Name                        :clib45a8b650f4428a1-os-1471973896525\r data:        Caching                     :ReadWrite\r data:        CreateOption                :FromImage\r data:        Vhd:\r data:          Uri                       :https://mystorageaccount.blob.core.chinacloudapi.cn/vhds/clib45a8b650f4428a1-os-1471973896525.vhd\r data:\r data:    OS Profile:\r data:      Computer Name                 :myVM1\r data:      User Name                     :ops\r data:      Linux Configuration:\r data:        Disable Password Auth       :true\r data:\r data:    Network Profile:\r data:      Network Interfaces:\r data:        Network Interface #1:\r data:          Primary                   :true\r data:          MAC Address               :00-0D-3A-24-D4-AA\r data:          Provisioning State        :Succeeded\r data:          Name                      :LmyNic1\r data:          Location                  :chinanorth\r data:\r data:    AvailabilitySet:\r data:      Id                            :/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Compute/availabilitySets/myAvailabilitySet\r data:\r data:    Diagnostics Profile:\r data:      BootDiagnostics Enabled       :true\r data:      BootDiagnostics StorageUri    :https://mystorageaccount.blob.core.chinacloudapi.cn/\r data:\r data:      Diagnostics Instance View:\r info:    vm show command OK\r \r ```\r \r ## <a name=\"export-the-environment-as-a-template\"></a>将环境导出为模板\r 现已构建此环境，如果要使用相同的参数创建与其相符的额外开发环境或生产环境，该怎么办？ Resource Manager 使用定义了所有环境参数的 JSON 模板。 通过引用此 JSON 模板构建出整个环境。 可以[手动构建 JSON 模板](../../resource-group-authoring-templates.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)，也可以通过导出现有环境来为自己创建 JSON 模板：\r \r ```azurecli\r azure group export --name myResourceGroup\r ```\r \r 此命令在当前工作目录中创建 `myResourceGroup.json` 文件。 从此模板创建环境时，系统会提示输入所有资源名称，包括负载均衡器、网络接口或 VM 的名称。 可以通过向前面所示的 `azure group export` 命令中添加 `-p` 或 `--includeParameterDefaultValue` 参数，在模板文件中填充这些名称。 请编辑 JSON 模板以指定资源名称，或[创建 parameters.json 文件](../../resource-group-authoring-templates.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)来指定资源名称。\r \r 使用模板创建环境：\r \r ```azurecli\r azure group deployment create --resource-group myNewResourceGroup \\\r   --template-file myResourceGroup.json\r ```\r \r 可能需要阅读[有关通过模板进行部署的详细信息](../../resource-group-template-deploy-cli.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。 了解如何对环境进行增量更新、如何使用参数文件，以及如何从单个存储位置访问模板。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 现在，已准备好开始使用多个网络组件和 VM。 可以使用本文介绍的核心组件，通过此示例环境构建应用程序。\r "}