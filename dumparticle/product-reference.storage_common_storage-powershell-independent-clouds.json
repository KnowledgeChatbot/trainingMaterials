{"Title":"使用 Azure PowerShell 管理 Azure 独立云中的存储","Description":"使用 Azure PowerShell 管理中国云、政府云和德国云中的存储","Content":"# <a name=\"managing-storage-in-the-azure-independent-clouds-using-powershell\"></a>使用 PowerShell 管理 Azure 独立云中的存储\r \r 大多数人为其全球 Azure 部署使用了 Azure 公有云。 但出于主权等方面的原因，还存在一些独立的 Microsoft Azure 部署。 这些独立部署称为“环境”。 以下列表详细说明了当前存在的独立云。\r \r * [Azure 政府云](https://azure.microsoft.com/features/gov/)\r * [由中国世纪互联运营的 Azure 中国云](http://www.windowsazure.cn/)\r * Azure 德国云\r \r ## <a name=\"using-an-independent-cloud\"></a>使用独立云 \r \r 若要在某个独立云中使用 Azure 存储，需要连接到该云而不是 Azure 公有云。 若要使用某个独立云而不是 Azure 公有云，需要：\r \r * 指定要连接到的环境。\r * 确定并使用可用的区域。\r * 使用正确的终结点后缀，它不同于 Azure 公有云。\r \r 本文中的示例需要 Azure PowerShell 模块 4.4.0 或更高版本。 在 PowerShell 窗口中，运行 `Get-Module -ListAvailable AzureRM` 可查找版本。 如果未列出任何信息或需要升级，请参阅[安装 Azure PowerShell 模块](https://docs.microsoft.com/powershell/azure/install-azurerm-ps)。 \r \r ## <a name=\"log-in-to-azure\"></a>登录 Azure\r \r 运行 [Get-AzureRmEnvironment](https://docs.microsoft.com/powershell/module/azurerm.profile/get-azurermenvironment) cmdlet 以查看可用的 Azure 环境：\r    \r ```powershell\r Get-AzureRmEnvironment\r ```\r \r 登录到有权访问所要连接的云的帐户，并设置环境。 此示例演示如何登录到使用 Azure 中国云的帐户。   \r \r ```powershell\r Login-AzureRmAccount –Environment AzureChinaCloud\r ```\r \r \r 此时，如果需要查看可在其中创建存储帐户或其他资源的位置列表，可以使用 [Get-AzureRmLocation](https://docs.microsoft.com/powershell/module/azurerm.resources/get-azurermlocation) 查询所选云可用的位置。\r \r ```powershell\r Get-AzureRmLocation | select Location, DisplayName\r ```\r \r 下表显示了针对中国云返回的位置。\r \r |位置 | DisplayName |\r |----|----|\r | chinanorth |  中国北部|\r | chinaeast | 中国东部 | \r \r \r ## <a name=\"endpoint-suffix\"></a>终结点后缀\r \r 其中每个环境的终结点后缀不同于 Azure 公有云终结点。 例如，Azure 公有云的 Blob 终结点后缀为 **blob.core.windows.net**。 对于中国云，Blob 终结点后缀为 **core.chinacloudapi.cn**。 \r \r ### <a name=\"get-endpoint-using-get-azurermenvironment\"></a>使用 Get-AzureRMEnvironment 获取终结点 \r \r 使用 [Get-AzureRMEnvironment](https://docs.microsoft.com/powershell/module/azurerm.profile/get-azurermenvironment) 检索终结点后缀。 终结点是环境的 *StorageEndpointSuffix* 属性。 以下代码片段演示了如何执行此操作。 \r \r 此代码片段检索所有环境，以及每个环境的终结点后缀。\r \r ```powershell\r Get-AzureRmEnvironment | select Name, StorageEndpointSuffix \r ```\r \r 此命令返回以下结果。\r \r | 名称| core.usgovcloudapi.net|\r |----|----|\r |AzureChinaCloud | core.chinacloudapi.cn|\r | AzureCloud | core.windows.net |\r | AzureGermanCloud | core.cloudapi.de|\r | AzureUSGovernment | core.usgov.cloudapi.net |\r \r \r 若要检索指定环境的所有属性，请调用 **Get-AzureRmEnvironment** 并指定云名称。 此代码片段返回属性列表；请在列表中查找 **StorageEndpointSuffix**。 以下示例适用于中国云。\r \r ```powershell\r Get-AzureRmEnvironment -Name AzureChinaCloud \r ```\r \r 结果如下所示：\r \r |属性名称|值|\r |----|----|\r | 名称 | AzureChinaCloud |\r | EnableAdfsAuthentication | False |\r | ActiveDirectoryServiceEndpointResourceI | https://management.core.chinacloudapi.cn/ |\r | GalleryURL | https://gallery.azure.com/ |\r | ManagementPortalUrl | http://go.microsoft.com/fwlink/?LinkId=301902 | \r | ServiceManagementUrl | https://management.core.chinacloudapi.cn/ |\r | PublishSettingsFileUrl| http://go.microsoft.com/fwlink/?LinkID=301776 |\r | ResourceManagerUrl | https://management.chinacloudapi.cn/ |\r | SqlDatabaseDnsSuffix | .database.chinacloudapi.cn |\r | **StorageEndpointSuffix** | core.chinacloudapi.cn |\r | ... | ... | \r \r 若只要检索存储终结点后缀属性，请检索特定的云，并仅请求该属性。\r \r ```powershell\r $environment = Get-AzureRmEnvironment -Name AzureChinaCloud\r Write-Host \"Storage EndPoint Suffix = \" $environment.StorageEndpointSuffix \r ```\r \r 此命令返回以下信息。\r \r ```\r Storage Endpoint Suffix = core.chinacloudapi.cn\r ```\r \r ### <a name=\"get-endpoint-from-a-storage-account\"></a>从存储帐户获取终结点\r \r 还可以通过检查存储帐户的属性来检索终结点。 如果已在 PowerShell 脚本中使用存储帐户，则这种方法很有帮助；可以做到只检索所需的终结点。 \r \r ```powershell\r # Get a reference to the storage account.\r $resourceGroup = \"myexistingresourcegroup\"\r $storageAccountName = \"myexistingstorageaccount\"\r $storageAccount = Get-AzureRmStorageAccount `\r   -ResourceGroupName $resourceGroup `\r   -Name $storageAccountName \r   # Output the endpoints.\r Write-Host \"blob endpoint = \" $storageAccount.PrimaryEndPoints.Blob \r Write-Host \"file endpoint = \" $storageAccount.PrimaryEndPoints.File\r Write-Host \"queue endpoint = \" $storageAccount.PrimaryEndPoints.Queue\r Write-Host \"table endpoint = \" $storageAccount.PrimaryEndPoints.Table\r ```\r \r 对于中国云中的存储帐户，此命令返回以下信息： \r \r ```\r blob endpoint = http://myexistingstorageaccount.blob.core.chinacloudapi.cn/\r file endpoint = http://myexistingstorageaccount.file.core.chinacloudapi.cn/\r queue endpoint = http://myexistingstorageaccount.queue.core.chinacloudapi.cn/\r table endpoint = http://myexistingstorageaccount.table.core.chinacloudapi.cn/\r ```\r \r ## <a name=\"after-setting-the-environment\"></a>设置环境之后\r \r 从现在起，可以根据[对 Azure 存储使用 Azure PowerShell](storage-powershell-guide-full.md) 一文中所述，使用管理存储帐户时所用的相同 PowerShell 以及访问数据平面。\r \r ## <a name=\"clean-up-resources\"></a>清理资源\r \r 如果在本练习中创建了新的资源组和存储帐户，可以通过删除资源组来删除所有资产。 这会一并删除组中包含的所有资源。 在这种情况下，它会删除创建的存储帐户以及资源组本身。\r \r ```powershell\r Remove-AzureRmResourceGroup -Name $resourceGroup\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r * [在不同的 PowerShell 会话中保留用户登录](https://docs.microsoft.com/powershell/azure/context-persistence)\r * [Azure 中国版应用程序开发人员说明](https://msdn.microsoft.com/library/azure/dn578439.aspx)"}