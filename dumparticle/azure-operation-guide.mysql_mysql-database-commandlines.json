{"Title":"使用PowerShell管理MySQL Database on Azure","Description":"本文介绍如何通过PowerShell实现更多MySQL Database on Azure的查询、创建、修改、删除等操作。","Content":"\r #使用PowerShell管理MySQL Database on Azure\r \r > [!div class=\"op_single_selector\"]\r > * [中文](https://docs.azure.cn/zh-cn/mysql/mysql-database-commandlines)\r > * [英文](https://docs.azure.cn/en-us/mysql/mysql-database-commandlines)\r \r 本文主要介绍如何通过PowerShell实现更多MySQL Database on Azure的创建、查看、删除、更改等操作。建议您先阅读[利用Azure 资源管理器与 PowerShell 来部署使用MySQL Database on Azure](./mysql-database-etoe-powershell.md),该文介绍了如何下载使用Azure PowerShell, 如何利用PowerShell来快速创建MySQL Database on Azure数据服务。\r \r 在开始之前，请确保已将 Azure PowerShell 准备就绪。\r \r 注意：本文主要针对Azure PowerShell 0.9*版本，如果您使用1.0.0+版本，请参考[Azure PowerShell 1.0.0以上版本在中国Azure使用的注意事项](http://blogs.msdn.com/b/azchina/archive/2015/12/18/azure-powershell-1.0.0_e54e0a4e48722c6728572d4efd56_azure_7f4f28758476e86c0f618b4e7998_.aspx)。将下述命令当中AzureResource改为AzureRmResource运行。\r \r ###目录\r - [了解 Azure 资源模板和资源组](#gettoknow)\r - [创建操作](#creat)\r - [查看操作](#view)\r - [修改操作](#set)\r - [删除操作](#delete)\r - [其它操作](#miscellaneous)\r \r ## <a id=\"gettoknow\"></a>1. 了解 Azure 资源模板和资源组\r \r 大多数部署和运行在 Azure 中的应用程序是通过不同云资源类型的组合构建的。Azure资源管理器模板使你能够集中部署和管理这些不同的资源，只需对资源和关联的配置及部署参数进行 JSON 描述即可。\r ###1.1 了解MySQL Database on Azure的资源类型参数信息\r 目前，MySQL Database on Azure的Json File中定义了六种资源类型： Servers, Databases, Users, Privileges, FirewallRules, Backups。用户可以通过\"Get\",\"New\",\"Set\",\"Remove\"指令分别对上述六种资源类型进行查看、创建、修改、删除的操作。\r 您可以通过下载[Json模板文件](http://wacnppe.blob.core.chinacloudapi.cn/marketing-resource/2015-09-01.json)来了解更多MySQL Database on Azure 服务的API参数定义。\r \r ## <a id=\"creat\"></a>2. 创建操作\r 通过New指令可以创建MySQL服务器、数据库、用户、用户权限、备份、防火墙规则等。\r ###2.1 创建服务器\r 编辑运行以下命令，定义您的服务器名称、位置、版本等信息来完成服务器创建。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -Location chinaeast -SkuObject @{name='MS4'} -PropertyObject @{version = '5.5'} \r ```\r \r ###2.2 创建服务器防火墙原则\r 编辑运行以下命令，定义您的防火墙原则名称、IP白名单范围（起始IP地址，终止IP地址）等信息来完成防火墙原则的创建。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers/firewallRules\" -ResourceName testPSH/rule1 -ApiVersion 2015-09-01 -PropertyObject @{startIpAddress=\"0.0.0.0\"; endIpAddress=\"255.255.255.255\"} -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###2.3 创建数据库\r 编辑运行以下命令，定义您的数据库名称、字符集等信息完成数据库创建。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases\" -ResourceName testPSH/demodb -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{collation='utf8_general_ci'; charset='utf8'}\r ```\r \r ###2.4 创建用户\r 编辑运行以下命令，定义您的用户名、密码等信息完成数据库创建。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers/users\" -ResourceName testPSH/admin -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{password='abc123'}\r ```\r \r ###2.5 添加用户权限\r 编辑运行以下命令，设置数据库读写权限给用户。权限分为\"Read\"以及\"ReadWrite\"。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases/privileges\" -ResourceName testPSH/demodb/admin -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{level='ReadWrite'}\r ```\r \r ###2.6 创建按需备份文件\r 编辑运行以下命令，制定备份文件名称，创建按需备份文件。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers/backups\" -ResourceName testPSH/back1 -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{}\r ```\r \r ###2.7 服务器备份恢复 （基于快照的恢复）\r 编辑运行以下命令，通过制定快照来恢复服务器。\r 其中，server和region的信息必填，backup不指定的情况下，默认通过最新的快照拷贝进行恢复。\r \r ```\r New-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testrestore -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -Location ChinaEast -Properties @{creationSource=@{server='testPSH';region='chinaEast' ; backup = 'testpsh1b0a9038-6953-42ad-ac8e-42f73180825b'};version = '5.5'}\r ```\r \r ## <a id=\"view\"></a>3. 查看操作\r 通过Get指令可以查看当前MySQL服务器、数据库、用户、用户权限、备份、防火墙规则等列表,也可以查看详细参数配置。\r ###3.1 查看服务器列表\r >[!NOTE]\r > ** 注意:“在Azure管理门户上创建的实例，按照实例所处的区域分别在默认资源组：Default-MySql-ChinaEast以及Default-MySql-ChinaNorth**\r \r 编辑运行以下命令，查看当前所有服务器列表\r \r ```\r Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers\"  -ApiVersion 2015-01-01 -ResourceGroupName resourcegroupchinaeast \r ```\r >[!NOTE]\r > ** 注意:与其他指令不同，查看服务器中的“-ApiVersion 2015-01-01”，指向ARM的API，其他指令中，均为“-ApiVersion 2015-09-01”，指向MySQL的API。**\r \r ###3.2 查看数据库列表及参数\r 编辑运行以下命令，查看当前资源组内某个服务器的所有数据库列表：\r \r ```\r  Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases\" -Name testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###3.3 查看用户列表及参数\r 编辑运行以下命令，查看当前资源组内某个服务器的所有用户列表：\r \r ```\r  Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/users\" -Name testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###3.4 查看用户权限列表及参数\r 编辑运行以下命令，查看当前资源组内某个数据库的用户权限：\r \r ```\r  Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases/privileges\" -Name testPSH/demodb -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###3.5 查看备份列表及参数\r 编辑运行以下命令，查看当前资源组内某个服务器的所有备份文件：\r \r ```\r  Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/backups\" -Name testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###3.6 查看防火墙规则列表及参数\r 编辑运行以下命令，查看当前资源组内某个服务器的所有防火墙规则：\r \r ```\r  Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/firewallRules\" -Name testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###3.7 查看慢查询日志\r 编辑运行以下命令，查看当前资源组内某个服务器的所有慢查询日志：\r \r ```\r Get-AzureRmResource -ResourceType \"Microsoft.MySql/servers/slowlogs\" -Name testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ## <a id=\"set\"></a>4. 修改操作\r 通过Set指令可以完成账户密码修改，权限修改，某些服务器参数修改等配置工作。\r ###4.1 修改账户密码\r 编辑运行以下命令，修改某个账户密码。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers/users\" -ResourceName testPSH/admin -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{password='abc1234'} -UsePatchSemantics\r ```\r \r ###4.2 修改某个用户的读写权限\r 编辑运行以下命令，修改某个用户的读写权限。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases/privileges\" \t\t\r -ResourceName testPSH/demodb/admin -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{level='Read'} -UsePatchSemantics\r ```\r \r ###4.3 允许所有Azure服务访问\r 编辑运行以下命令，允许所有Azure服务访问指定服务器。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{allowAzureServices='true'} -UsePatchSemantics\r ```\r \r ###4.4 修改默认每日备份时间\r 编辑运行以下命令，修改指定服务器的默认日备起始时间(此处为北京时间UTC+8)，0-24可选。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{dailyBackupTimeInHour='5'} -UsePatchSemantics\r ```\r \r ###4.5 开启慢查询日志\r 编辑运行以下命令，开启慢查询日志。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{options=@{slow_query_log='ON'}} -UsePatchSemantics\r ```\r \r ###4.6 修改防火墙原则\r 编辑运行以下命令，更改已有的防火墙原则。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers/firewallRules\" -ResourceName testPSH/rule1 -ApiVersion 2015-09-01 -PropertyObject @{startIpAddress=\"1.1.1.1\"} -ResourceGroupName resourcegroupChinaEast -UsePatchSemantics\r ```\r \r ###4.7 修改部分MySQL服务器设置\r 以wait\\_timeout参数为例，其他参数详见Json文件，编辑运行以下命令，更改wait_timeout默认值。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{options=@{wait_timeout=70}} -UsePatchSemantics\r ```\r 对其他参数的修改，可以参考下面Json文件的定义，参数的有效值范围可参考[定制MySQL Database on Azure服务器参数](./mysql-database-advanced-settings.md)：\r \r ```\r \t\"options\": {\r           \"type\": \"object\",\r           \"properties\": {\r             \"div_precision_increment\": {\r               \"type\": \"integer\"\r             },\r             \"event_scheduler\": {\r               \"type\": \"string\"\r             },\r             \"group_concat_max_len\": {\r               \"type\": \"integer\"\r             },\r             \"innodb_adaptive_hash_index\": {\r               \"type\": \"string\"\r             },\r             \"innodb_lock_wait_timeout\": {\r               \"type\": \"integer\"\r             },\r             \"interactive_timeout\": {\r               \"type\": \"integer\"\r             },\r             \"log_bin_trust_function_creators\": {\r               \"type\": \"string\"\r             },\r             \"log_queries_not_using_indexes\": {\r               \"type\": \"string\"\r             },\r             \"long_query_time\": {\r               \"type\": \"number\"\r             },\r             \"max_allowed_packet\": {\r               \"type\": \"integer\"\r             },\r             \"server-id\": {\r               \"type\": \"integer\"\r             },\r             \"slow_query_log\": {\r               \"type\": \"string\"\r             },\r             \"sql_mode\": {\r               \"type\": \"string\"\r             },\r             \"wait_timeout\": {\r               \"type\": \"integer\"\r             }\r           }\r         }\r ```\r \r ###4.8 修改MySQL服务器性能版本\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers \" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -SkuObject @{name=\"MS4\"} -UsePatchSemantics\r ```\r \r ## <a id=\"delete\"></a>5. 删除操作\r 通过Remove指令可以删除MySQL服务器、数据库、用户、备份、防火墙规则等。\r ###5.1 删除服务器\r 编辑运行以下命令，删除指定服务器。\r \r ```\r Remove-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast \r ```\r \r ###5.2 删除服务器防火墙原则\r 编辑运行以下命令，删除指定防火墙。\r \r ```\r Remove-AzureRmResource -ResourceType \"Microsoft.MySql/servers/firewallRules\" -ResourceName testPSH/rule1 -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###5.3 删除数据库\r 编辑运行以下命令，删除指定数据库。\r \r ```\r Remove-AzureRmResource -ResourceType \"Microsoft.MySql/servers/databases\" -ResourceName testPSH/demodb -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast \r ```\r \r ###5.4 删除用户\r 编辑运行以下命令，删除指定用户。\r \r ```\r Remove-AzureRmResource -ResourceType \"Microsoft.MySql/servers/users\" -ResourceName testPSH/admin -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast\r ```\r \r ###5.5 删除备份文件\r 编辑运行以下命令，删除指定备份文件。\r \r ```\r Remove-AzureRmResource -ResourceType \"Microsoft.MySql/servers/backups\" -ResourceName testPSH/back1 -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast \r ```\r ## <a id=\"miscellaneous\"></a>6 其它操作\r \r ### 6\\.1 Restart a server\r 编辑运行以下命令，重启当前资源组中的服务器。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers\" -ResourceName testPSH -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{setRestart='true'} -UsePatchSemantics\r ```\r \r ### 6\\.2 Download slowlogs\r 编辑运行以下命令，下载当前资源组中特定服务器的指定慢查询日志。\r \r ```\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers/slowlogs\" -ResourceName testPSH/testslowlogname -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{copyDestinationContainerUri=”your container uri\";CopyDestinationSasToken=\"your container sasToken\"} -UsePatchSemantics\r ```\r \r 以下为带参数下载慢查询日志的代码示例。\r \r ```$account = Get-AzureStorageAccount -StorageAccountName teststorageaccountname\r $container = New-AzureStorageContainer -Context $account.Context -Name newcontainer\r $sasToken = New-AzureStorageContainerSASToken -Name $container.Name -Permission rcw -StartTime (Get-Date).AddDays(-1) -Protocol HttpsOnly -ExpiryTime (Get-Date).AddDays(1) -Context $account.Context\r Set-AzureRmResource -ResourceType \"Microsoft.MySql/servers/slowlogs\" -ResourceName testPSH/testslowlogname -ApiVersion 2015-09-01 -ResourceGroupName resourcegroupChinaEast -PropertyObject @{copyDestinationContainerUri=”$($container.CloudBlobContainer.Uri.AbsoluteUri)\";CopyDestinationSasToken=\"$sasToken\"} -UsePatchSemantics\r ```\r \r 随着MySQL Database on Azure提供的功能增多，我们也会陆续更新相应的PowerShell指南。"}