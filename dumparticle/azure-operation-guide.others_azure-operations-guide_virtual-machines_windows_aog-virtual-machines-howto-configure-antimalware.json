{"Title":"Azure 虚拟机如何配置 AntiMalware","Description":"本文仅演示通过 PowerShell 方式安装并配置 AntiMalware 的过程","Content":"\r # Azure 虚拟机如何配置 AntiMalware\r \r 本文仅演示通过 PowerShell 方式安装并配置 AntiMalware 的过程。\r \r ## 经典虚拟机\r \r - 加载 Antimalware 扩展 :\r \r     ```\r     $vm = Get-AzureVM -ServiceName yourservicename -Name yourvmname\r     Set-AzureVMExtension -Publisher Microsoft.Azure.Security -ExtensionName IaaSAntimalware -Version <1.*> -VM $vm | Update-AzureVM\r     ```\r     > [!NOTE]\r     > 根据您的需要，指定合适的版本号。\r \r     此时虚拟机已经安装过 Antimalware 扩展，官方推荐使用配置文件的方式进行配置（更多的配置定义请参考后续的“[配置字段说明](#configuration)”）\r \r - 配置样例 :\r \r     Json:\r \r     ```\r     {\r         \"AntimalwareEnabled\": true,\r         \"RealtimeProtectionEnabled\": true,\r         \"ScheduledScanSettings\": {\r                 \"isEnabled\": true,\r         \"day\": 7,\r         \"time\": 120,\r         \"scanType\": \"Quick\"\r                 },\r                 \"Exclusions\": {\r         \"Extensions\": \".ext1;.ext2\",\r         \"Paths\": \"c:\\\\excluded-path-1;c:\\\\excluded-path-2\",\r         \"Processes\": \"excludedproc1.exe;excludedproc2.exe\"\r             }\r     }\r     ```\r \r     XML:\r \r     ```\r     <AntimalwareConfig>\r         <AntimalwareEnabled>true</AntimalwareEnabled> \r         <RealtimeProtectionEnabled>true</RealtimeProtectionEnabled>     \r         <ScheduledScanSettings isEnabled=\"true\" day=\"7\" time=\"120\" scanType=\"Quick\"/> \r         <Exclusions>\r             <Extensions>\r                 <Extension>.ext1</Extension>\r                 <Extension>.ext2</Extension>\r             </Extensions>\r             <Paths>\r                 <Path>c:\\excluded-path-1</Path>\r                 <Path>c:\\excluded-path-2</Path>\r             </Paths>\r             <Processes>\r                 <Process>excludedproc1.exe</Process>\r                 <Process>excludedproc2.exe</Process>\r             </Processes>\r         </Exclusions>\r         <Monitoring>ON</Monitoring>\r         <StorageAccountName>contosostorage</StorageAccountName>\r     </AntimalwareConfig>\r     ```\r \r - 操作步骤：\r \r 1. 创建一个配置文件 `D:\\anti.json`（本文以 Json 为例）。\r \r 2. 执行 PowerShell 命令 :\r \r     ```\r     Get-AzureVM -ServiceName yourservicename -Name yourvmname | Set-AzureVMMicrosoftAntimalwareExtension -AntimalwareConfigFile 'D:\\anti.json' | Update-AzureVM\r     ```\r \r 3. 执行成功后，可以获取一下当前虚拟机的 Antimalware 的配置 :\r \r     ```\r     Get-AzureVM -ServiceName yourservicename -Name yourvmname | get-AzureVMMicrosoftAntimalwareExtension\r     ```\r \r     ![antimalware-configuration](./media/aog-virtual-machines-howto-configure-antimalware/antimalware-configuration.png)\r \r     或通过登录到虚拟机内部查看配置 :\r \r     ![vm-settings](./media/aog-virtual-machines-howto-configure-antimalware/vm-settings.png)\r \r ## ARM虚拟机\r \r - 加载 Antimalware 扩展\r \r     ```\r     #通过 PowerShell 加载 Antimalware 扩展，应该至少先定义一个 Antimalware 启动的配置否则无法加载成功\r     ############################################################################\r     $SettingsString=@{\"AntimalwareEnabled\" = \"true\"}\r \r     Set-AzureRmVMExtension -Publisher Microsoft.Azure.Security -ExtensionType IaaSAntimalware -ResourceGroupName <yourgroupname>  -VMName <youvmname> -Name IaaSAntimalware -TypeHandlerVersion <1.*> -Location <chinanorth/chinaeast> -Settings $SettingsString\r     ```\r \r     > [!NOTE]\r     > 请将以上特定参数指定为您实际的资源组名称、虚拟机名称、版本号以及区域位置。\r \r ## <a id=\"configuration\"></a>配置字段说明\r \r ![configuration-fields](./media/aog-virtual-machines-howto-configure-antimalware/configuration-fields.png)\r \r ## 关于无法在虚拟机内部打开 System Center Endpoint Protection 界面并报错 :\r \r ![system-center-endpoint-protection](./media/aog-virtual-machines-howto-configure-antimalware/system-center-endpoint-protection.png)\r \r 进入指定目录执行以下命令 :\r \r ```\r C:\\Program Files\\Microsoft Security Client>ConfigSecurityPolicy.exe cleanuppolicy.xml\r ```\r \r ## 关于如何获取最新的 ARM 虚拟机 Antimalware 镜像扩展信息的方法 : \r \r ```\r #确认最新的 Antimalware 服务发布者的名称（有的时候这个名字会因为平台的更新改变）\r ####################################################\r Get-AzureRmVMImagePublisher -Location chinanorth\r ```\r \r ![antimalware-image](./media/aog-virtual-machines-howto-configure-antimalware/antimalware-image.png)\r \r ```\r #获取镜像类型信息\r ###################################################\r Get-AzureRmVMExtensionImageType -PublisherName Microsoft.Azure.Security -Location chinanorth \r ```\r \r ![antimalware-image-type](./media/aog-virtual-machines-howto-configure-antimalware/antimalware-image-type.png)\r \r ```\r #获取镜像版本信息\r ####################################################\r $PublisherName = 'Microsoft.Azure.Security'\r $PublisherType = 'IaaSAntimalware'\r $Location = 'chinanorth'\r $Publisher = Get-AzureRmVMExtensionImage -PublisherName $PublisherName -Type $PublisherType -Location $Location \r $Version = $Publisher.Version.Substring(0,3) \r $Version\r ```\r \r ![antimalware-extension-image](./media/aog-virtual-machines-howto-configure-antimalware/antimalware-extension-image.png)"}