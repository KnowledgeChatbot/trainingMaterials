{"Title":"通过 Azure CLI 1.0 使用 cloud-init 在创建期间自定义 Linux VM","Description":"如何通过 Azure CLI 1.0 使用 cloud-init 在创建期间自定义 Linux VM","Content":"<a name=\"use-cloud-init-to-customize-a-linux-vm-during-creation-with-the-azure-cli-10\"></a>\r \r # 通过 Azure CLI 1.0 使用 cloud-init 在创建期间自定义 Linux VM\r 本文说明如何制作 cloud-init 脚本来设置主机名、更新已安装的包及管理用户帐户。  在 VM 创建期间可以从 Azure CLI 调用 cloud-init 脚本。  本文需要以下条件：\r \r * 一个 Azure 帐户（[获取试用版](https://www.azure.cn/pricing/1rmb-trial/)）。\r * 已使用 `azure login -e AzureChinaCloud` 登录 [Azure CLI](../../cli-install-nodejs.md)。\r * Azure CLI *必须处于* Azure Resource Manager 模式`azure config mode arm`。\r \r <a name=\"cli-versions-to-complete-the-task\"></a>\r \r ## 用于完成任务的 CLI 版本\r 可使用以下 CLI 版本之一完成任务：\r \r - [Azure CLI 1.0](#quick-commands) - 适用于经典部署模型和资源管理部署模型（本文）的 CLI\r - [Azure CLI 2.0](using-cloud-init.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) - 适用于资源管理部署模型的下一代 CLI\r \r <a name=\"quick-commands\"></a>\r \r ## 快速命令\r 创建 cloud-init.txt 脚本，用于设置主机名、更新所有包，并将 sudo 用户添加到 Linux。\r \r ```sh\r #cloud-config\r hostname: myVMhostname\r apt_upgrade: true\r users:\r   - name: myNewAdminUser\r     groups: sudo\r     shell: /bin/bash\r     sudo: ['ALL=(ALL) NOPASSWD:ALL']\r     ssh-authorized-keys:\r       - ssh-rsa AAAAB3<snip>==myAdminUser@myVM\r ```\r 创建要在其中启动 VM 的资源组。\r \r ```azurecli\r azure group create myResourceGroup chinanorth\r ```\r \r 使用 cloud-init 创建要在启动过程中进行配置的 Linux VM。\r \r ```azurecli\r azure vm create \\\r   -g myResourceGroup \\\r   -n myVM \\\r   -l chinanorth \\\r   -y Linux \\\r   -f myVMnic \\\r   -F myVNet \\\r   -P 10.0.0.0/22 \\\r   -j mySubnet \\\r   -k 10.0.0.0/24 \\\r   -Q canonical:ubuntuserver:14.04.2-LTS:latest \\\r   -M ~/.ssh/id_rsa.pub \\\r   -u myAdminUser \\\r   -C cloud-init.txt\r ```\r \r <a name=\"detailed-walkthrough\"></a>\r \r ## 详细演练\r <a name=\"introduction\"></a>\r \r ### 介绍\r 启动新 Linux VM 时，将获得一个未经过任何自定义或者不能够现成地满足需求的标准 Linux VM。 [Cloud-init](https://cloudinit.readthedocs.org) 是在首次启动 Linux VM 时在其中注入脚本或配置设置的标准方法。\r \r Azure 有三种不同的方法可在部署或启动 Linux VM 时对其进行更改。\r \r * 使用 cloud-init 注入脚本。\r * 使用 Azure [VMAccess 扩展](using-vmaccess-extension.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)注入脚本。\r * 使用 cloud-init 的 Azure 模板。\r * 使用 [CustomScriptExtention](extensions-customscript.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) 的 Azure 模板。\r \r 若要在启动后随时注入脚本，请执行以下操作：\r \r * 直接通过 SSH 运行命令\r * 以命令方式或在 Azure 模板中使用 Azure [VMAccess 扩展](using-vmaccess-extension.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)注入脚本\r * Salt、Chef 和 Puppet 等配置管理工具。\r \r > [!NOTE]\r > VMAccess 扩展以使用 SSH 可以进行的相同方式以根用户身份执行脚本。  但是，使用 VM 扩展可以启用 Azure 提供的几项功能，这些功能可以很有用，具体取决于用户的方案。\r > \r > \r \r <a name=\"cloud-init-availability-on-azure-vm-quick-create-image-aliases\"></a>\r \r ## Azure VM 上的 Cloud-init 可用性快速创建映像别名：\r | 别名 | 发布者 | 产品 | SKU | 版本 | Cloud-init |\r |:--- |:--- |:--- |:--- |:--- |:--- |\r | CentOS |OpenLogic |Centos |7.2 |最新 |否 |\r | CoreOS |CoreOS |CoreOS |Stable |最新 |是 |\r | Debian |credativ |Debian |8 |最新 |否 |\r | openSUSE |SUSE |openSUSE |13.2 |最新 |否 |\r | UbuntuLTS |Canonical |UbuntuServer |14.04.3-LTS |最新 |是 |\r \r Microsoft 正在与合作伙伴合作，将 cloud-init 包含在用户向 Azure 提供的映像中并让它在其中正常工作。\r \r <a name=\"adding-a-cloud-init-script-to-the-vm-creation-with-the-azure-cli\"></a>\r \r ## 将 cloud-init 脚本添加到使用 Azure CLI 创建 VM 的操作中\r 在 Azure 中创建 VM 时，若要启动 cloud-init 脚本，请使用 Azure CLI `--custom-data` 开关来指定 cloud-init 文件。\r \r 创建要在其中启动 VM 的资源组。\r \r ```azurecli\r azure group create myResourceGroup chinanorth\r ```\r \r 使用 cloud-init 创建要在启动过程中进行配置的 Linux VM。\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM \\\r   --location chinanorth \\\r   --os-type Linux \\\r   --nic-name myVMnic \\\r   --vnet-name myVNet \\\r   --vnet-address-prefix 10.0.0.0/22 \\\r   --vnet-subnet-name mySubnet \\\r   --vnet-subnet-address-prefix 10.0.0.0/24 \\\r   --image-urn canonical:ubuntuserver:14.04.2-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username myAdminUser \\\r   --custom-data cloud-init.txt\r ```\r \r <a name=\"creating-a-cloud-init-script-to-set-the-hostname-of-a-linux-vm\"></a>\r \r ## 创建 cloud-init 脚本以设置 Linux VM 的主机名\r 对任何 Linux VM 而言，其中一个最简单且最重要的设置就是主机名。 使用 cloud-init 和此脚本就可以轻松设置此项。  \r \r <a name=\"example-cloud-init-script-named-cloudconfighostnametxt\"></a>\r \r ### 名为 `cloud_config_hostname.txt`的示例 cloud-init 脚本。\r ```sh\r #cloud-config\r hostname: myservername\r ```\r \r 初始启动 VM 期间，此 cloud-init 脚本将主机名设置为 `myservername`。\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM \\\r   --location chinanorth \\\r   --os-type Linux \\\r   --nic-name myVMnic \\\r   --vnet-name myVNet \\\r   --vnet-address-prefix 10.0.0.0/22 \\\r   --vnet-subnet-name mySubNet \\\r   --vnet-subnet-address-prefix 10.0.0.0/24 \\\r   --image-urn canonical:ubuntuserver:14.04.2-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username myAdminUser \\\r   --custom-data cloud_config_hostname.txt\r ```\r \r 登录并验证新 VM 的主机名。\r \r ```bash\r ssh myVM\r hostname\r myservername\r ```\r \r <a name=\"creating-a-cloud-init-script-to-update-linux\"></a>\r \r ## 创建 cloud-init 脚本以更新 Linux\r 为了安全，用户希望 Ubuntu VM 在首次启动时更新。  根据所用的 Linux 分发，我们可以使用 cloud-init 和以下脚本执行此操作。\r \r <a name=\"example-cloud-init-script-cloudconfigaptupgradetxt-for-the-debian-family\"></a>\r \r ### 适用于 Debian 系列的示例 cloud-init 脚本 `cloud_config_apt_upgrade.txt`\r ```sh\r #cloud-config\r apt_upgrade: true\r ```\r \r Linux 启动后，所有已安装的包将通过 `apt-get`进行更新。\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM \\\r   --location chinanorth \\\r   --os-type Linux \\\r   --nic-name myVMnic \\\r   --vnet-name myVNet \\\r   --vnet-address-prefix 10.0.0.0/22 \\\r   --vnet-subnet-name mySubNet \\\r   --vnet-subnet-address-prefix 10.0.0.0/24 \\\r   --image-urn canonical:ubuntuserver:14.04.2-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username myAdminUser \\\r   --custom-data cloud_config_apt_upgrade.txt\r ```\r \r 登录并验证所有包是否都已更新。\r \r ```bash\r ssh myUbuntuVM\r sudo apt-get upgrade\r Reading package lists... Done\r Building dependency tree\r Reading state information... Done\r Calculating upgrade... Done\r The following packages have been kept back:\r   linux-generic linux-headers-generic linux-image-generic\r 0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\r ```\r \r <a name=\"creating-a-cloud-init-script-to-add-a-user-to-linux\"></a>\r \r ## 创建 cloud-init 脚本以将用户添加到 Linux\r 任何新 Linux VM 的首要任务之一，就是为自己添加用户或避免使用 `root`。 对于安全性和易用性来说，SSH 密钥是最佳做法，可以使用此 cloud-init 脚本将它们添加到 `~/.ssh/authorized_keys` 文件。\r \r <a name=\"example-cloud-init-script-cloudconfigadduserstxt-for-debian-family\"></a>\r \r ### 适用于 Debian 系列的示例 cloud-init 脚本 `cloud_config_add_users.txt`\r ```sh\r #cloud-config\r users:\r   - name: myCloudInitAddedAdminUser\r     groups: sudo\r     shell: /bin/bash\r     sudo: ['ALL=(ALL) NOPASSWD:ALL']\r     ssh-authorized-keys:\r       - ssh-rsa AAAAB3<snip>==myAdminUser@myUbuntuVM\r ```\r \r Linux 启动后，所有列出的用户都已创建并添加到 sudo 组。\r \r ```azurecli\r azure vm create \\\r   --resource-group myResourceGroup \\\r   --name myVM \\\r   --location chinanorth \\\r   --os-type Linux \\\r   --nic-name myVMnic \\\r   --vnet-name myVNet \\\r   --vnet-address-prefix 10.0.0.0/22 \\\r   --vnet-subnet-name mySubNet \\\r   --vnet-subnet-address-prefix 10.0.0.0/24 \\\r   --image-urn canonical:ubuntuserver:14.04.2-LTS:latest \\\r   --ssh-publickey-file ~/.ssh/id_rsa.pub \\\r   --admin-username myAdminUser \\\r   --custom-data cloud_config_add_users.txt\r ```\r \r 登录并验证新建的用户。\r \r ```bash\r ssh myVM\r cat /etc/group\r ```\r \r 输出\r \r ```bash\r root:x:0:\r <snip />\r sudo:x:27:myCloudInitAddedAdminUser\r <snip />\r myCloudInitAddedAdminUser:x:1000:\r ```\r \r <a name=\"next-steps\"></a>\r \r ## 后续步骤\r Cloud-init 正成为在 Linux VM 启动时对其进行修改的一种标准方法。 Azure 还提供 VM 扩展，使用这些扩展可以在 LinuxVM 启动或运行时对其进行修改。 例如，可以使用 Azure VMAccessExtension 在 VM 运行时重置 SSH 或用户信息。 使用 cloud-init，需要重新启动才能重置密码。\r \r [关于虚拟机扩展和功能](../windows/extensions-features.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r \r [管理用户、SSH，并使用 VMAccess 扩展检查或修复 Azure Linux VM 上的磁盘](using-vmaccess-extension.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)\r "}