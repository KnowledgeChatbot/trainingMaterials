{"Title":"分批获取建议：机器学习建议 API","Description":"Azure 机器学习建议 - 分批获取建议","Content":"# <a name=\"get-recommendations-in-batches\"></a>批量获取建议\r > [!NOTE]\r > 批量获取建议比一次获取一条建议更为复杂。 请查看 API，了解有关如何获取单个请求的建议信息：\r > \r >  项到项的建议 <br>\r >  用户到项的建议 \r > \r > 批处理计分仅适用于 2016 年 7 月 21 日之后创建的生成。\r > \r > \r \r 有时需要一次性获取多个项的建议。 例如，你可能对建议缓存，甚至分析所获取的建议类型感兴趣。\r \r 批处理计分操作我们又称之为异步操作。 提交请求后，等待操作完成，并收集结果。  \r \r 具体请遵照以下步骤：\r \r 1. 如果还没有 Azure 存储容器，创建一个。\r 2. 将描述每个建议请求的输入文件上传到 Azure Blob 存储。\r 3. 开始对批处理作业进行计分。\r 4. 等待异步操作完成。\r 5. 完成后，从 Blob 存储中收集结果。\r \r 我们来看看上述每个步骤。\r \r ## <a name=\"create-a-storage-container-if-you-dont-have-one-already\"></a>如果还没有存储空间容器，创建一个。\r 转到 [Azure 门户](https://portal.azure.cn)，如果没有存储帐户，新建一个。 为此，请导航到“**新建**”“ > **数据** + ”“**存储**”“ > **存储帐户**”。\r \r 拥有存储帐户后，需要创建 blob 容器，以便存储批处理执行的输入和输出。\r \r 将描述每个建议请求的输入文件上传到 Blob 存储（这里我们将该文件称为 input.json）。\r 拥有容器后，需要上传描述每个请求的文件，这些请求需要通过建议服务执行。\r \r 一个批处理只能执行特定生成中的一个请求类型。 我们会在下一节中介绍如何定义此信息。 现在，假设要执行特定生成外的项建议。 输入文件则包含每个请求的输入信息（在本例中为种子项）。\r \r input.json 文件的外观如此示例所示：\r \r     {\r       \"requests\": [\r       { \"SeedItems\": [ \"C9F-00163\", \"FKF-00689\" ] },\r       { \"SeedItems\": [ \"F34-03453\" ] },\r       { \"SeedItems\": [ \"D16-3244\" ] },\r       { \"SeedItems\": [ \"C9F-00163\", \"FKF-00689\" ] },\r       { \"SeedItems\": [ \"F43-01467\" ] },\r       { \"SeedItems\": [ \"BD5-06013\" ] },\r       { \"SeedItems\": [ \"P45-00163\", \"FKF-00689\" ] },\r       { \"SeedItems\": [ \"C9A-69320\" ] }\r       ]\r     }\r \r 如你所见，该文件是一个 JSON 文件，其中每个请求都具有发送建议请求所必需的信息。 为需要完成的请求创建相似的 JSON 文件，并将其复制到刚才在 Blob 存储中创建的容器中。\r \r ## <a name=\"kick-start-the-batch-job\"></a>开始批处理作业\r 下一步是提交新的批处理作业。\r \r API 的请求正文需要定义输入、输出和错误文件的存储位置。 还需要定义访问这些位置所必需的凭据。 此外，还需要指定可应用于整个批处理的一些参数（要请求的建议类型、要使用的模型/生成、每个调用的结果数量等。）\r \r 请求正文的外观如以下示例所示：\r \r     {\r       \"input\": {\r         \"authenticationType\": \"PublicOrSas\",\r         \"baseLocation\": \"https://mystorage1.blob.core.chinacloudapi.cn/\",\r         \"relativeLocation\": \"container1/batchInput.json\",\r         \"sasBlobToken\": \"?sv=2015-07_restofToken_…4Z&sp=rw\"\r       },\r       \"output\": {\r         \"authenticationType\": \"PublicOrSas\",\r         \"baseLocation\": \"https://mystorage1.blob.core.chinacloudapi.cn/\",\r         \"relativeLocation\": \"container1/batchOutput.json \",\r         \"sasBlobToken\": \"?sv=2015-07_restofToken_…4Z&sp=rw\"\r       },\r       \"error\": {\r         \"authenticationType\": \"PublicOrSas\",\r         \"baseLocation\": \"https://mystorage1.blob.core.chinacloudapi.cn/\",\r         \"relativeLocation\": \"container1/errors.txt\",\r         \"sasBlobToken\": \"?sv=2015-07_restofToken_…4Z&sp=rw\"\r       },\r       \"job\": {\r         \"apiName\": \"ItemRecommend\",\r         \"modelId\": \"9ac12a0a-1add-4bdc-bf42-c6517942b3a6\",\r         \"buildId\": 1015703,\r         \"numberOfResults\": 10,\r         \"includeMetadata\": true,\r         \"minimalScore\": 0.0\r       }\r     }\r \r 此处需要注意几个要点：\r \r - 当前，**authenticationType** 应始终设置为 **PublicOrSas**。\r - 需要获取共享访问签名 (SAS) 令牌，以允许建议 API 读取和写入 Blob 存储帐户或该帐户进行读取和写入。 有关如何生成 SAS 令牌的详细信息，可查看[建议 API 页面](../storage/common/storage-dotnet-shared-access-signature-part-1.md)。\r - 当前支持的唯一 **apiName** 是 **ItemRecommend**，可用于项到项的建议。 批处理当前不支持用户到项的建议。\r \r ## <a name=\"wait-for-the-asynchronous-operation-to-finish\"></a>等待异步操作完成\r 启动批处理操作时，响应返回“操作位置”标头，为您提供跟踪操作所必需的信息。\r 可以使用“检索操作状态”API 跟踪操作，方法与跟踪生成操作的方法相似。\r \r ## <a name=\"get-the-results\"></a>获取结果\r 操作完成后，如果没有发生错误，便可以从输出 Blob 存储收集结果。\r \r 输出的外观如以下示例所示。 为简洁起见，此示例介绍了仅有两个请求的批处理结果。\r \r     {\r       \"results\":\r       [   \r         {\r           \"request\": { \"seedItems\": [ \"DAF-00500\", \"P3T-00003\" ] },\r           \"recommendations\": [\r             {\r               \"items\": [\r                 {\r                   \"itemId\": \"F5U-00011\",\r                   \"name\": \"L2 Ethernet Adapter-Win8Pro SC EN/XD/XX Hdwr\",\r                   \"metadata\": \"\"\r                 }\r               ],\r               \"rating\": 0.722,\r               \"reasoning\": [ \"People who like the selected items also like 'L2 Ethernet Adapter-Win8Pro SC EN/XD/XX Hdwr'\" ]\r             },\r             {\r               \"items\": [\r                 {\r                   \"itemId\": \"G5Y-00001\",\r                   \"name\": \"Docking Station for Srf Pro/Pro2 SC EN/XD/ES Hdwr\",\r                   \"metadata\": \"\"\r                 }\r               ],\r               \"rating\": 0.718,\r               \"reasoning\": [ \"People who like the selected items also like 'Docking Station for Srf Pro/Pro2 SC EN/XD/ES Hdwr'\" ]\r             }\r           ]\r         },\r         {\r           \"request\": { \"seedItems\": [ \"C9F-00163\" ] },\r           \"recommendations\": [\r             {\r               \"items\": [\r                 {\r                   \"itemId\": \"C9F-00172\",\r                   \"name\": \"Nokia 2K Shell for Nokia Lumia 630/635 - Green\",\r                   \"metadata\": \"\"\r                 }\r               ],\r               \"rating\": 0.649,\r               \"reasoning\": [ \"People who like 'MOZO Flip Cover for Nokia Lumia 635 - White' also like 'Nokia 2K Shell for Nokia Lumia 630/635 - Green'\" ]\r             },\r             {\r               \"items\": [\r                 {\r                   \"itemId\": \"C9F-00171\",\r                   \"name\": \"Nokia 2K Shell for Nokia Lumia 630/635 - Orange\",\r                   \"metadata\": \"\"\r                 }\r               ],\r               \"rating\": 0.647,\r               \"reasoning\": [ \"People who like 'MOZO Flip Cover for Nokia Lumia 635 - White' also like 'Nokia 2K Shell for Nokia Lumia 630/635 - Orange'\" ]\r             },\r             {\r               \"items\": [\r                 {\r                   \"itemId\": \"C9F-00170\",\r                   \"name\": \"Nokia 2K Shell for Nokia Lumia 630/635 - Yellow\",\r                   \"metadata\": \"\"\r                 }\r               ],\r               \"rating\": 0.646,\r               \"reasoning\": [ \"People who like 'MOZO Flip Cover for Nokia Lumia 635 - White' also like 'Nokia 2K Shell for Nokia Lumia 630/635 - Yellow'\" ]\r             }       \r           ]\r         }\r     ]}\r \r \r ## <a name=\"learn-about-the-limitations\"></a>了解相关限制\r - 每个订阅每次只能调用一个批处理作业。\r - 批处理作业输入文件不能超过 2 MB。\r \r \r "}