{"Title":"Azure Service Fabric 独立群集部署准备","Description":"在部署专用于处理生产工作负荷的群集之前要考虑的与准备环境和创建群集配置相关的文档。","Content":"<a name=\"preparemachines\"></a>\r # <a name=\"plan-and-prepare-your-service-fabric-standalone-cluster-deployment\"></a>规划和准备 Service Fabric 独立群集部署\r 在创建群集之前，请执行以下步骤。\r \r ## <a name=\"plan-your-cluster-infrastructure\"></a>规划群集基础结构\r 需要在“拥有的”计算机上创建 Service Fabric 群集，以便确定群集需应对的故障类型。 例如，是否需要为这些计算机单独提供电源线或 Internet 连接？ 此外，还应考虑这些计算机的物理安全性。 计算机位于何处，谁需要访问它们？ 在做出这些决定后，可以采用逻辑方式将计算机映射到多个容错域（请参阅下一步骤）。 相比于测试群集，生产群集的基础结构规划更复杂。\r \r ## <a name=\"determine-the-number-of-fault-domains-and-upgrade-domains\"></a>确定容错域和升级域的数目\r “容错域 (FD)”是故障的物理单元，与数据中心的物理基础结构直接相关。[](service-fabric-cluster-resource-manager-cluster-description.md) 容错域由共享单一故障点的硬件组件（计算机、交换机、网络等）组成。 尽管容错域与机架之间没有 1:1 映射，但是大致上，可将每个机架视为一个容错域。\r \r 在 ClusterConfig.json 中指定 FD 时，可以选择每个 FD 的名称。 Service Fabric 支持分层的 FD，因此，可以在 FD 中反映基础结构拓扑。  例如，以下 FD 是有效的：\r \r * \"faultDomain\": \"fd:/Room1/Rack1/Machine1\"\r * \"faultDomain\": \"fd:/FD1\"\r * \"faultDomain\": \"fd:/Room1/Rack1/PDU1/M1\"\r \r 升级域 (UD) 是节点的逻辑单元。 在 Service Fabric 协调式升级（应用程序升级或群集升级）期间，将关闭 UD 中的所有节点以执行升级，而其他 UD 中的节点仍可用来为请求提供服务。 对计算机进行的固件升级不遵循 UD，因此每次必须在一台计算机上执行此操作。\r \r 领会这些概念的最简单方法是将 FD 视为非计划内故障的单元，将 UD 视为计划维护的单元。\r \r 在 ClusterConfig.json 中指定 UD 时，可以选择每个 UD 的名称。 例如，以下名称是有效的：\r \r * \"upgradeDomain\": \"UD0\"\r * \"upgradeDomain\": \"UD1A\"\r * \"upgradeDomain\": \"DomainRed\"\r * \"upgradeDomain\": \"Blue\"\r \r 有关 FD 和 UD 的更多详细信息，请参阅 [Service Fabric 群集介绍](service-fabric-cluster-resource-manager-cluster-description.md)。\r \r 如果你能够完全控制节点的维护和管理，也就是说，你负责更新和更换计算机，则用于生产的群集应当跨至少三个 FD 以便在生产环境中受支持。 对于在你对计算机没有完全控制权限的环境（例如 Amazon Web Services VM 实例）中运行的群集，应当在群集中配备至少五个 FD。 每个 FD 可以有一个或多个节点。 这是为了防止计算机升级和更新导致发生问题，根据这些更新和升级的时间安排，它们可能会干扰群集中的应用程序和服务的运行。\r \r ## <a name=\"determine-the-initial-cluster-size\"></a>确定初始群集大小\r \r 通常，群集中的节点数目取决于业务需求，即，群集上将运行多少服务和容器，以及需要多少资源来支持工作负荷。 对于生产用群集，建议在群集中配备至少 5 个节点，跨 5 个 FD。 不过，如上所述，如果你对节点具有完全控制权并且可以跨三个 FD，则三个节点应当也可以胜任该工作。\r \r 运行有状态工作负荷的测试用群集应当具有三个节点，而运行无状态工作负荷的测试用群集只需要一个节点。 还应当注意，若是用于开发，可以在一台指定的计算机上配备多个节点。 不过，在生产环境中，对于每台物理机或虚拟机，Service Fabric 只支持一个节点。\r \r ## <a name=\"prepare-the-machines-that-will-serve-as-nodes\"></a>准备将充当节点的计算机\r \r 对于要添加到群集的每台计算机，下面提供了建议要满足的一些规格：\r \r * 至少 16 GB RAM\r * 至少 40 GB 可用磁盘空间\r * 一个 4 核心或更多核心的 CPU\r * 与所有计算机的安全网络建立连接\r * Windows Server 2012 R2 或 Windows Server 2016\r * [.NET Framework 4.5.1 或更高版本](https://www.microsoft.com/download/details.aspx?id=40773)的完整安装版\r * [Windows PowerShell 3.0](https://msdn.microsoft.com/powershell/scripting/setup/installing-windows-powershell)\r * 应在所有计算机上运行 [RemoteRegistry 服务](https://technet.microsoft.com/library/cc754820)\r \r 部署和配置群集的群集管理员必须拥有每台计算机的 [管理员权限](https://social.technet.microsoft.com/wiki/contents/articles/13436.windows-server-2012-how-to-add-an-account-to-a-local-administrator-group.aspx) 。 不能在域控制器上安装 Service Fabric。\r \r ## <a name=\"download-the-service-fabric-standalone-package-for-windows-server\"></a>下载适用于 Windows Server 的 Service Fabric 独立包\r [下载链接 - Service Fabric 独立包 - Windows Server](http://go.microsoft.com/fwlink/?LinkId=730690)，并将包解压缩到群集外的一台部署计算机中或解压缩到群集内的其中一台计算机中。\r \r ## <a name=\"modify-cluster-configuration\"></a>修改群集配置\r 若要创建独立群集，必须创建独立群集配置 ClusterConfig.json 文件，其中描述群集的规范。 可以基于在以下链接中找到的模板创建配置文件。 <br>\r [独立群集配置](https://github.com/Azure-Samples/service-fabric-dotnet-standalone-cluster-configuration/tree/master/Samples)\r \r 有关此文件中相关部分的详细信息，请参阅 [Windows 独立群集的配置设置](service-fabric-cluster-manifest.md)。\r \r 从已下载的程序包中打开某个 ClusterConfig.json 文件，并修改以下设置：\r | **配置设置** | **说明** |\r | --- | --- |\r | **NodeTypes** |节点类型可让你将群集节点划分到不同的组中。 一个群集必须至少有一个节点类型。 组中的所有节点具有以下共同特征： <br> 名称 - 即节点类型名称。 <br>终结点端口 - 即与此节点类型关联的各种命名终结点（端口）。 可以使用任何端口号，只要它们不会与此清单中的其他部分发生冲突，并且未被计算机/VM 上运行的其他应用程序使用。 <br> 放置属性 - 即此节点类型的相应属性，可用作系统服务或你拥有的服务的放置约束。 这些属性是用户定义的键/值对，可为指定节点提供额外的元数据。 节点属性的示例包括节点是否有硬盘或图形卡、其硬盘的轴数、内核数和其他物理属性。 <br> 容量 - 节点容量，定义特定节点提供的特定资源的名称和数量。 例如，节点可以定义名为“MemoryInMb”的指标容量，而且默认有 2048 MB 的可用内存。 这些容量在运行时使用，以确保将需要特定资源量的服务放在具有所需数量的可用资源的节点上。<br>IsPrimary - 如果定义了多个 NodeType，请确保只有一个设置为主节点（值为 true），系统服务将在该主节点上运行。 应将所有其他节点类型设置为 false 值 |\r | **Nodes** |这些是群集内的每个节点的详细信息（节点类型、节点名称、IP 地址、节点的容错域和升级域）。 要在其上创建群集的计算机必须与其 IP 地址一起列在此处。 <br> 如果对所有节点使用相同的 IP 地址，则会创建一个可用于测试的单机群集。 不要将单机群集用于部署生产工作负荷。 |\r \r 群集配置将所有设置配置到环境后，可针对群集环境对其进行测试（步骤 7）。\r \r <a id=\"environmentsetup\"></a>\r \r ## <a name=\"environment-setup\"></a>环境设置\r \r 群集管理员配置 Service Fabric 独立群集时，需按照以下准则设置环境： <br>\r 1. 创建群集的用户应对群集配置文件中作为节点列出的所有计算机具有管理员级别的安全特权。\r 2. 从中创建群集的计算机以及每个群集节点计算机必须：\r * 已卸载 Service Fabric SDK\r * 已卸载 Service Fabric 运行时 \r * 已启用 Windows 防火墙服务 (mpssvc)\r * 已启用远程注册表服务 (remoteregistry)\r * 已启用文件共享 (SMB)\r * 已基于群集配置端口打开了必要的端口\r * 已为 Windows SMB 和远程注册表服务打开了必要的端口：135、137、138、139 和 445\r * 已相互建立网络连接\r 3. 群集节点计算机不应为域控制器。\r 4. 如果要部署的群集是安全群集，请验证是否已具备必需的安全先决条件，以及是否已根据配置进行正确配置。\r 5. 如果群集计算机无法访问 Internet，请在群集配置中设置以下项：\r * 禁用遥测：在“属性”下，设置 *\"enableTelemetry\": false*\r * 禁用自动下载 Fabric 版本和禁用通知当前群集版本支持即将终止：在“属性”下，设置 *\"fabricClusterAutoupgradeEnabled\": false*\r * 或者，如果网络 Internet 访问仅限于白名单中的域，则需要自动升级以下域：go.microsoft.com   download.microsoft.com\r \r 6. 设置适当的 Service Fabric 防病毒排除项：\r \r | **防病毒排除目录** |\r | --- |\r | Program Files\\Microsoft Service Fabric |\r | FabricDataRoot（从群集配置中） |\r | FabricLogRoot（从群集配置中） |\r \r | **防病毒排除进程** |\r | --- |\r | Fabric.exe |\r | FabricHost.exe |\r | FabricInstallerService.exe |\r | FabricSetup.exe |\r | FabricDeployer.exe |\r | ImageBuilder.exe |\r | FabricGateway.exe |\r | FabricDCA.exe |\r | FabricFAS.exe |\r | FabricUOS.exe |\r | FabricRM.exe |\r | FileStoreService.exe |\r \r ## <a name=\"validate-environment-using-testconfiguration-script\"></a>使用 TestConfiguration 脚本验证环境\r 可以在独立包中找到 TestConfiguration.ps1 脚本。 它作为最佳做法分析器，可验证上述某些条件，并应该用作健全性检查来验证是否可以在给定环境上部署群集。 如果出现任何故障，请参阅[环境设置](service-fabric-cluster-standalone-deployment-preparation.md)下的列表进行故障排除。 \r \r 可以在对群集配置文件中列为节点的所有计算机具有管理员访问权限的任何计算机上运行此脚本。 运行此脚本的计算机不必要是群集的一部分。\r \r ```powershell\r PS C:\\temp\\Microsoft.Azure.ServiceFabric.WindowsServer> .\\TestConfiguration.ps1 -ClusterConfigFilePath .\\ClusterConfig.Unsecure.DevCluster.json\r Trace folder already exists. Traces will be written to existing trace folder: C:\\temp\\Microsoft.Azure.ServiceFabric.WindowsServer\\DeploymentTraces\r Running Best Practices Analyzer...\r Best Practices Analyzer completed successfully.\r \r LocalAdminPrivilege        : True\r IsJsonValid                : True\r IsCabValid                 : True\r RequiredPortsOpen          : True\r RemoteRegistryAvailable    : True\r FirewallAvailable          : True\r RpcCheckPassed             : True\r NoConflictingInstallations : True\r FabricInstallable          : True\r Passed                     : True\r ```\r \r 目前，此配置测试模块不会验证安全配置，因此必须单独执行验证。  \r \r > [!NOTE]\r > 我们正在不断改进，旨在使此模块更加可靠，因此如果遇到了可能由 TestConfiguration 导致的故障或丢失情况，请通过我们的[支持通道](/service-fabric/service-fabric-support)告知我们。   \r > \r > \r \r ## <a name=\"next-steps\"></a>后续步骤\r * [创建在 Windows Server 上运行的独立群集](service-fabric-cluster-creation-for-windows-server.md)\r \r <!--Update_Description: wording update-->"}