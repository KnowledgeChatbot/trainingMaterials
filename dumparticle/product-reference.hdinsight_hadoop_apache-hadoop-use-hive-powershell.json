{"Title":"在 HDInsight 中将 Hadoop Hive 与 PowerShell 配合使用 - Azure","Description":"使用 PowerShell 在 HDInsight 上的 Hadoop 中运行 Hive 查询。","Content":"# <a name=\"run-hive-queries-using-powershell\"></a>使用 PowerShell 运行 Hive 查询\r [!INCLUDE [hive-selector](../../../includes/hdinsight-selector-use-hive.md)]\r \r [!INCLUDE [azure-sdk-developer-differences](../../../includes/azure-sdk-developer-differences.md)]\r \r 本文档提供使用 Azure 资源组模式中的 Azure PowerShell 在 HDInsight 群集上的 Hadoop 中运行 Hive 查询的示例。\r \r > [!NOTE]\r > 本文档未详细描述示例中使用的 HiveQL 语句的作用。 有关此示例中使用的 HiveQL 的信息，请参阅[将 Hive 与 HDInsight 上的 Hadoop 配合使用](hdinsight-use-hive.md)。\r \r **先决条件**\r \r [!INCLUDE [hdinsight-linux-acn-version.md](../../../includes/hdinsight-linux-acn-version.md)]\r \r * **Azure HDInsight 群集**：无论该群集是基于 Windows 还是基于 Linux 都行。\r \r   > [!IMPORTANT]\r   > Linux 是在 HDInsight 3.4 版或更高版本上使用的唯一操作系统。 有关详细信息，请参阅 [HDInsight 在 Windows 上停用](../hdinsight-component-versioning.md#hdinsight-windows-retirement)。\r \r * **配备 Azure PowerShell 的工作站**。\r \r [!INCLUDE [upgrade-powershell](../../../includes/hdinsight-use-latest-powershell.md)]\r \r ## <a name=\"run-hive-queries-using-azure-powershell\"></a>使用 Azure PowerShell 运行 Hive 查询\r \r Azure PowerShell 提供 *cmdlet*，可在 HDInsight 上远程运行 Hive 查询。 cmdlet 在内部对 HDInsight 群集上的 [WebHCat](https://cwiki.apache.org/confluence/display/Hive/WebHCat) 进行 REST 调用。\r \r 在远程 HDInsight 群集上运行 Hive 查询时，使用以下 Cmdlet：\r \r * **Add-AzureRmAccount**：在 Azure 订阅中进行 Azure PowerShell 身份验证。\r * **New-AzureRmHDInsightHiveJobDefinition**：使用指定的 HiveQL 语句创建作业定义。\r * **Start-AzureRmHDInsightJob**：将作业定义发送到 HDInsight 并启动作业。 将返回作业对象。\r * **Wait-AzureRmHDInsightJob**：使用作业对象来检查作业的状态。 它等到作业完成或超出等待时间。\r * **Get-AzureRmHDInsightJobOutput**：用于检索作业输出。\r * **Invoke-AzureRmHDInsightHiveJob**：用于运行 HiveQL 语句。 此 cmdlet 将阻止查询完成，然后返回结果。\r * **Use-AzureRmHDInsightCluster**：设置要用于 Invoke-AzureRmHDInsightHiveJob 命令的当前群集。\r \r 以下步骤演示了如何使用这些 Cmdlet 在 HDInsight 群集上运行作业：\r \r 1. 使用编辑器将以下代码保存为 **hivejob.ps1**。\r \r     ```powershell\r     # Login to your Azure subscription\r     # Is there an active Azure subscription?\r     $sub = Get-AzureRmSubscription -ErrorAction SilentlyContinue\r     if(-not($sub))\r     {\r         Add-AzureRmAccount -EnvironmentName AzureChinaCloud\r     }\r \r     #Get cluster info\r     $clusterName = Read-Host -Prompt \"Enter the HDInsight cluster name\"\r     $creds=Get-Credential -Message \"Enter the login for the cluster\"\r \r     #HiveQL\r     #Note: set hive.execution.engine=tez; is not required for\r     #      Linux-based HDInsight\r     $queryString = \"set hive.execution.engine=tez;\" +\r                 \"DROP TABLE log4jLogs;\" +\r                 \"CREATE EXTERNAL TABLE log4jLogs(t1 string, t2 string, t3 string, t4 string, t5 string, t6 string, t7 string) ROW FORMAT DELIMITED FIELDS TERMINATED BY ' ' STORED AS TEXTFILE LOCATION 'wasbs:///example/data/';\" +\r                 \"SELECT * FROM log4jLogs WHERE t4 = '[ERROR]';\"\r \r     #Create an HDInsight Hive job definition\r     $hiveJobDefinition = New-AzureRmHDInsightHiveJobDefinition -Query $queryString \r \r     #Submit the job to the cluster\r     Write-Host \"Start the Hive job...\" -ForegroundColor Green\r \r     $hiveJob = Start-AzureRmHDInsightJob -ClusterName $clusterName -JobDefinition $hiveJobDefinition -ClusterCredential $creds\r \r     #Wait for the Hive job to complete\r     Write-Host \"Wait for the job to complete...\" -ForegroundColor Green\r     Wait-AzureRmHDInsightJob -ClusterName $clusterName -JobId $hiveJob.JobId -ClusterCredential $creds\r \r     # Print the output\r     Write-Host \"Display the standard output...\" -ForegroundColor Green\r     Get-AzureRmHDInsightJobOutput `\r         -Clustername $clusterName `\r         -JobId $hiveJob.JobId `\r         -HttpCredential $creds\r     ```\r \r 2. 打开一个新的 **Azure PowerShell** 命令提示符。 将目录更改为 **hivejob.ps1** 文件的所在位置，并使用以下命令来运行脚本：\r \r         .\\hivejob.ps1\r \r     脚本运行时，系统会提示输入群集名称和该群集的 HTTPS/管理员帐户凭据。 可能还会提示登录到 Azure 订阅。\r \r 3. 作业完成时，它会返回类似以下文本的信息：\r \r         Display the standard output...\r         2012-02-03      18:35:34        SampleClass0    [ERROR] incorrect       id\r         2012-02-03      18:55:54        SampleClass1    [ERROR] incorrect       id\r         2012-02-03      19:25:27        SampleClass4    [ERROR] incorrect       id\r \r 4. 如前所述，**Invoke-Hive** 可以用来运行查询，并等待响应。 使用以下脚本查看 Invoke-Hive 的工作原理：\r \r     ```powershell\r     # Login to your Azure subscription\r     # Is there an active Azure subscription?\r     $sub = Get-AzureRmSubscription -ErrorAction SilentlyContinue\r     if(-not($sub))\r     {\r         Add-AzureRmAccount -EnvironmentName AzureChinaCloud\r     }\r \r     #Get cluster info\r     $clusterName = Read-Host -Prompt \"Enter the HDInsight cluster name\"\r     $creds=Get-Credential -Message \"Enter the login for the cluster\"\r \r     # Set the cluster to use\r     Use-AzureRmHDInsightCluster -ClusterName $clusterName -HttpCredential $creds\r \r     $queryString = \"set hive.execution.engine=tez;\" +\r                 \"DROP TABLE log4jLogs;\" +\r                 \"CREATE EXTERNAL TABLE log4jLogs(t1 string, t2 string, t3 string, t4 string, t5 string, t6 string, t7 string) ROW FORMAT DELIMITED FIELDS TERMINATED BY ' ' STORED AS TEXTFILE LOCATION '/example/data/';\" +\r                 \"SELECT * FROM log4jLogs WHERE t4 = '[ERROR]';\"\r     Invoke-AzureRmHDInsightHiveJob `\r         -StatusFolder \"statusout\" `\r         -Query $queryString\r     ```\r \r     输出类似于以下文本：\r \r         2012-02-03    18:35:34    SampleClass0    [ERROR]    incorrect    id\r         2012-02-03    18:55:54    SampleClass1    [ERROR]    incorrect    id\r         2012-02-03    19:25:27    SampleClass4    [ERROR]    incorrect    id\r \r    > [!NOTE]\r    > 对于较长的 HiveQL 查询，可以使用 Azure PowerShell **Here-Strings** cmdlet 或 HiveQL 脚本文件。 以下代码段显示了如何使用 **Invoke-Hive** cmdlet 来运行 HiveQL 脚本文件。 HiveQL 脚本文件必须上传到 wasb://。\r    >\r    > `Invoke-AzureRmHDInsightHiveJob -File \"wasb://<ContainerName>@<StorageAccountName>/<Path>/query.hql\"`\r    >\r    > 有关 **Here-Strings** 的详细信息，请参阅<a href=\"http://technet.microsoft.com/library/ee692792.aspx\" target=\"_blank\">使用 Windows PowerShell Here-Strings</a>。\r \r ## <a name=\"troubleshooting\"></a>故障排除\r \r 如果作业完成时未返回任何信息，请查看错误日志。 如果要查看此作业的错误信息，请将以下内容添加到 **hivejob.ps1** 文件的末尾，保存，并重新运行该文件。\r \r ```powershell\r # Print the output of the Hive job.\r Get-AzureRmHDInsightJobOutput `\r         -Clustername $clusterName `\r         -JobId $job.JobId `\r         -HttpCredential $creds `\r         -DisplayOutputType StandardError\r ```\r \r 作业处理期间，此 cmdlet 返回写入到 STDERR 中的信息。\r \r ## <a name=\"summary\"></a>摘要\r \r 如你所见，Azure PowerShell 提供了简单的方法让你在 HDInsight 群集上运行 Hive 查询，监视作业状态，以及检索输出。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 HDInsight 中的 Hive 的一般信息：\r \r * [将 Hive 与 Hadoop on HDInsight 配合使用](hdinsight-use-hive.md)\r \r 有关 HDInsight 上 Hadoop 的其他使用方法的信息：\r \r * [将 Pig 与 Hadoop on HDInsight 配合使用](hdinsight-use-pig.md)\r * [将 MapReduce 与 HDInsight 上的 Hadoop 配合使用](hdinsight-use-mapreduce.md)\r \r \r \r <!--Update_Description: update wording and link references-->"}