{"Title":"配置负载均衡器的 TCP 空闲超时","Description":"配置负载均衡器的 TCP 空闲超时","Content":"# <a name=\"configure-tcp-idle-timeout-settings-for-azure-load-balancer\"></a>为 Azure 负载均衡器配置 TCP 空闲超时设置\r \r [!INCLUDE [load-balancer-basic-sku-include.md](../../includes/load-balancer-basic-sku-include.md)]\r \r 在默认配置中，Azure 负载均衡器的空闲超时设置为 4 分钟。 如果处于非活动状态的时间超过超时值，则不能保证在客户端和云服务之间保持 TCP 或 HTTP 会话。\r \r 当连接关闭时，客户端应用程序可能收到以下错误消息：“基础连接已关闭: 应保持连接状态的连接已由服务器关闭”。\r \r 常见的做法是使用 TCP 保持连接状态。 这种做法可以使连接状态保持更长时间。 有关详细信息，请参阅 [.NET 示例](https://msdn.microsoft.com/library/system.net.servicepoint.settcpkeepalive.aspx)。 在启用保持连接状态的情况下，在连接处于非活动状态时发送数据包。 这些用于保持连接状态的数据包可以确保始终达不到空闲超时值，于是就可以长时间维持连接。\r \r 此设置仅适用于入站连接。 为了避免断开连接，必须将 TCP 保持连接的时间间隔配置为小于空闲超时设置，或者增加空闲超时值。 我们已允许对空闲超时进行配置，以便支持这样的情况。 现在，可以将空闲超时的持续时间设置为 4 到 30 分钟。\r \r TCP 保持连接状态非常适用于不受电池寿命限制的情况。 不建议将其用于移动应用程序。 在移动应用程序中使用 TCP 保持连接状态可能会加快设备电池的耗尽速度。\r \r ![TCP 超时](./media/load-balancer-tcp-idle-timeout/image1.png)\r \r 以下章节介绍了如何更改虚拟机和云服务中的空闲超时设置\r \r ## <a name=\"configure-the-tcp-timeout-for-your-instance-level-public-ip-to-15-minutes\"></a>将实例级公共 IP 的 TCP 超时值配置为 15 分钟\r \r ```powershell\r Set-AzurePublicIP -PublicIPName webip -VM MyVM -IdleTimeoutInMinutes 15\r ```\r \r `IdleTimeoutInMinutes` 是可选项。 如果未设置，默认超时为 4 分钟。 可接受的超时范围为 4 到 30 分钟。\r \r ## <a name=\"set-the-idle-timeout-when-creating-an-azure-endpoint-on-a-virtual-machine\"></a>在虚拟机上创建 Azure 终结点时设置空闲超时\r \r 若要更改终结点的超时设置，请执行以下命令：\r \r ```powershell\r Get-AzureVM -ServiceName \"mySvc\" -Name \"MyVM1\" | Add-AzureEndpoint -Name \"HttpIn\" -Protocol \"tcp\" -PublicPort 80 -LocalPort 8080 -IdleTimeoutInMinutes 15| Update-AzureVM\r ```\r \r 若要检索空闲超时配置，请执行以下命令：\r \r ```\r PS C:\\> Get-AzureVM -ServiceName \"MyService\" -Name \"MyVM\" | Get-AzureEndpoint\r VERBOSE: 6:43:50 PM - Completed Operation: Get Deployment\r LBSetName : MyLoadBalancedSet\r LocalPort : 80\r Name : HTTP\r Port : 80\r Protocol : tcp\r Vip : 65.52.xxx.xxx\r ProbePath :\r ProbePort : 80\r ProbeProtocol : tcp\r ProbeIntervalInSeconds : 15\r ProbeTimeoutInSeconds : 31\r EnableDirectServerReturn : False\r Acl : {}\r InternalLoadBalancerName :\r IdleTimeoutInMinutes : 15\r ```\r \r ## <a name=\"set-the-tcp-timeout-on-a-load-balanced-endpoint-set\"></a>在负载均衡的终结点集上设置 TCP 超时\r \r 如果终结点是负载均衡的终结点集的一部分，则必须在负载均衡的终结点集上设置 TCP 超时。 例如：\r \r ```powershell\r Set-AzureLoadBalancedEndpoint -ServiceName \"MyService\" -LBSetName \"LBSet1\" -Protocol tcp -LocalPort 80 -ProbeProtocolTCP -ProbePort 8080 -IdleTimeoutInMinutes 15\r ```\r \r ## <a name=\"change-timeout-settings-for-cloud-services\"></a>更改云服务的超时设置\r \r 可以使用 Azure SDK 来更新云服务。 在 .csdef 文件中进行云服务的终结点设置。 更新云服务部署的 TCP 超时需要升级部署。 例外情况是如果仅针对公共 IP 指定 TCP 超时，则无需升级。 公共 IP 设置位于 .cscfg 文件中，可以通过部署更新和升级进行更新。\r \r 终结点设置的 .csdef 更改如下：\r \r ```xml\r <WorkerRole name=\"worker-role-name\" vmsize=\"worker-role-size\" enableNativeCodeExecution=\"[true|false]\">\r     <Endpoints>\r     <InputEndpoint name=\"input-endpoint-name\" protocol=\"[http|https|tcp|udp]\" localPort=\"local-port-number\" port=\"port-number\" certificate=\"certificate-name\" loadBalancerProbe=\"load-balancer-probe-name\" idleTimeoutInMinutes=\"tcp-timeout\" />\r     </Endpoints>\r </WorkerRole>\r ```\r \r 进行公共 IP 的超时设置时，.cscfg 更改如下：\r \r ```xml\r <NetworkConfiguration>\r     <VirtualNetworkSite name=\"VNet\"/>\r     <AddressAssignments>\r     <InstanceAddress roleName=\"VMRolePersisted\">\r     <PublicIPs>\r         <PublicIP name=\"public-ip-name\" idleTimeoutInMinutes=\"timeout-in-minutes\"/>\r     </PublicIPs>\r     </InstanceAddress>\r     </AddressAssignments>\r </NetworkConfiguration>\r ```\r \r ## <a name=\"rest-api-example\"></a>REST API 示例\r \r 可以通过使用服务管理 API 配置 TCP 空闲超时。 请确保 `x-ms-version` 标头设置为版本 `2014-06-01` 或更高版本。 通过一次部署，在所有虚拟机上更新指定的负载均衡的输入终结点的配置。\r \r ### <a name=\"request\"></a>请求\r \r ```\r POST https://management.core.chinacloudapi.cn/<subscription-id>/services/hostedservices/<cloudservice-name>/deployments/<deployment-name>\r ```\r \r ### <a name=\"response\"></a>响应\r \r ```xml\r <LoadBalancedEndpointList xmlns=\"http://schemas.microsoft.com/windowsazure\" xmlns:i=\"http://www.w3.org/2001/XMLSchema-instance\">\r     <InputEndpoint>\r     <LoadBalancedEndpointSetName>endpoint-set-name</LoadBalancedEndpointSetName>\r     <LocalPort>local-port-number</LocalPort>\r     <Port>external-port-number</Port>\r     <LoadBalancerProbe>\r         <Path>path-of-probe</Path>\r         <Port>port-assigned-to-probe</Port>\r         <Protocol>probe-protocol</Protocol>\r         <IntervalInSeconds>interval-of-probe</IntervalInSeconds>\r         <TimeoutInSeconds>timeout-for-probe</TimeoutInSeconds>\r     </LoadBalancerProbe>\r     <LoadBalancerName>name-of-internal-loadbalancer</LoadBalancerName>\r     <Protocol>endpoint-protocol</Protocol>\r     <IdleTimeoutInMinutes>15</IdleTimeoutInMinutes>\r     <EnableDirectServerReturn>enable-direct-server-return</EnableDirectServerReturn>\r     <EndpointACL>\r         <Rules>\r         <Rule>\r             <Order>priority-of-the-rule</Order>\r             <Action>permit-rule</Action>\r             <RemoteSubnet>subnet-of-the-rule</RemoteSubnet>\r             <Description>description-of-the-rule</Description>\r         </Rule>\r         </Rules>\r     </EndpointACL>\r     </InputEndpoint>\r </LoadBalancedEndpointList>\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r [内部负载均衡器概述](load-balancer-internal-overview.md)\r \r [开始配置面向 Internet 的负载均衡器](load-balancer-get-started-internet-arm-ps.md)\r \r [配置负载均衡器分发模式](load-balancer-distribution-mode.md)\r \r <!-- Update_Description: update meta properties -->"}