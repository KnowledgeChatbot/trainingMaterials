{"Title":"将用户添加到 Azure VM","Description":"将用户添加到 Azure 上的 Linux VM。","Content":"\r # 将用户添加到 Azure VM\r \r 对于任何新的 Linux VM，首要任务之一就是创建新用户。在本文中，将逐步创建 sudo 用户帐户、设置密码、添加 SSH 公钥，最后使用 `visudo` 来允许不带密码的 sudo。\r \r 先决条件包括：[Azure 帐户](https://www.azure.cn/pricing/1rmb-trial/)、[SSH 公钥与私钥](mac-create-ssh-keys.md)、Azure 资源组、已安装 Azure CLI，并已使用 `azure config mode arm` 切换到 Azure Resource Manager 模式。\r \r ## 快速命令\r \r ```bash\r # Add a new user on RedHat family distros\r sudo useradd -G wheel exampleUser\r \r # Add a new user on Debian family distros\r sudo useradd -G sudo exampleUser\r \r # Set a password\r sudo passwd exampleUser\r Enter new UNIX password:\r Retype new UNIX password:\r passwd: password updated successfully\r \r # Copy the SSH Public Key to the new user\r ssh-copy-id -i ~/.ssh/id_rsa exampleuser@exampleserver\r \r # Change sudoers to allow no password\r # Execute visudo as root to edit the /etc/sudoers file\r visudo\r \r # On RedHat family distros uncomment this line:\r ## Same thing without a password\r # %wheel        ALL=(ALL)       NOPASSWD: ALL\r \r # to this\r ## Same thing without a password\r %wheel        ALL=(ALL)       NOPASSWD: ALL\r \r # On Debian family distros change this line:\r # Allow members of group sudo to execute any command\r %sudo   ALL=(ALL:ALL) ALL\r \r # to this\r %sudo   ALL=(ALL) NOPASSWD:ALL\r \r # Verify everything\r # Verify the SSH keys & User account\r bill@slackware$ ssh -i ~/.ssh/id_rsa exampleuser@exampleserver\r \r # Verify sudo access\r sudo top\r ```\r \r ## 详细演练\r \r ### 介绍\r \r 新服务器的最常见首要任务之一是添加用户帐户。Root 登录应该禁用，root 帐户本身不应该用于 Linux 服务器，只有 sudo 可以。使用 sudo 提升用户的 root 权限，才是管理和使用 Linux 的正确方式。\r \r 使用命令 `useradd` 将用户帐户添加到 Linux VM。运行 `useradd` 修改 `/etc/passwd`、`/etc/shadow`、`/etc/group` 和 `/etc/gshadow`。我们将在 `useradd` 命令中添加一个命令行标志，以便同时将新用户添加到 Linux 上的正确 sudo 组。尽管 `useradd` 在 `/etc/passwd` 中创建条目，但不会为新用户帐户提供密码。我们将使用简单的 `passwd` 命令为新用户创建初始密码。最后一个步骤是修改 sudo 规则，以允许用户以 sudo 权限执行命令，而无需在执行每个命令时都输入密码。由于该用户已使用私钥登录，我们可以推断该用户帐户并非想要图谋不轨，因此允许该用户在不使用密码的情况下进行 sudo 访问。\r \r ### 将单个 sudo 用户添加到 Azure VM\r \r 使用 SSH 密钥登录到 Azure VM。\r \r `useradd` 命令将完成以下任务：\r \r - 创建新用户帐户\r - 以相同的名称创建新用户组\r - 在 `/etc/passwd` 中添加空白条目\r - 在 `/etc/gpasswd` 中添加空白条目\r \r `-G` 命令行标志将新用户帐户添加到正确的 Linux 组，并为新用户帐户分配 root 提升权限。\r \r #### 添加用户\r \r ```bash\r # On RedHat family distros\r sudo useradd -G wheel exampleUser\r \r # On Debian family distros\r sudo useradd -G sudo exampleUser\r ```\r \r #### 设置密码\r \r `useradd` 命令将创建用户，并向 `/etc/passwd` 和 `/etc/gpasswd` 同时添加条目，但不实际设置密码。使用 `passwd` 命令将密码添加到条目。\r \r ```bash\r sudo passwd exampleUser\r Enter new UNIX password:\r Retype new UNIX password:\r passwd: password updated successfully\r ```\r \r 现在，服务器上已有一个具有 sudo 权限的用户。\r \r ### 将 SSH 公钥添加到新用户帐户\r \r 在计算机上，结合新密码使用 `ssh-copy-id` 命令。\r \r ```bash\r ssh-copy-id -i ~/.ssh/id_rsa exampleuser@exampleserver\r ```\r \r ### 通过 visudo 允许使用不带密码的 sudo\r \r 使用 `visudo` 编辑 `/etc/sudoers` 文件可添加多层保护，避免不当地修改这个重要文件。执行 `visudo` 时将锁定 `/etc/sudoers` 文件，以确保没有任何其他用户能够在编辑文件时对文件进行更改。尝试保存或退出时，`visudo` 还会检查 `/etc/sudoers` 文件中是否有错误，因此无法保存已损坏的 sudoers 文件。\r \r 我们已将用户添加到正确的默认组中以进行 sudo 访问。现在我们要让这些组可以在没有密码的情况下使用 sudo。\r \r ```bash\r # Execute visudo as root to edit the /etc/sudoers file\r visudo\r \r # On RedHat family distros uncomment this line:\r ## Same thing without a password\r # %wheel        ALL=(ALL)       NOPASSWD: ALL\r \r # to this\r ## Same thing without a password\r %wheel        ALL=(ALL)       NOPASSWD: ALL\r \r # On Debian family distros change this line:\r # Allow members of group sudo to execute any command\r %sudo   ALL=(ALL:ALL) ALL\r \r # to this\r %sudo   ALL=(ALL) NOPASSWD:ALL\r ```\r \r ### 验证用户、ssh 密钥和 sudo\r \r ```bash\r # Verify the SSH keys & User account\r ssh -i ~/.ssh/id_rsa exampleuser@exampleserver\r \r # Verify sudo access\r sudo top\r ```\r \r <!---HONumber=Mooncake_1017_2016-->"}