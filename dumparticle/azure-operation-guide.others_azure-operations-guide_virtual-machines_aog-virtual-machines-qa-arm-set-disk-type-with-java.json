{"Title":"Java 创建 ARM 虚拟机磁盘类型选择的问题","Description":"Java 创建 ARM 虚拟机磁盘类型选择的问题","Content":"\r # Java 创建 ARM 虚拟机磁盘类型选择的问题\r \r ## **问题描述**\r \r 在[Azure 门户](https://portal.azure.cn/)创建 ARM 虚拟机时，我们直接可以选择虚拟机的磁盘类型，但是在 [Azure Management Libraries for Java](https://github.com/Azure/azure-sdk-for-java) 的 API 中我们无法找到直接设置磁盘类型的 API.默认创建的磁盘类型是 HDD，如何通过 API 设置磁盘类型？\r \r ![disk-type](./media/aog-virtual-machines-qa-arm-set-disk-type-with-java/disk-type.png)\r \r ## **问题分析**\r \r 系统磁盘或数据磁盘的类型取决于使用的存储账户类型，如果是基于普通存储账户创建的磁盘，则磁盘类型为 HDD；如果是基于高级存储创建的磁盘，则磁盘类型为 SDD。更多信息参考：\r \r - [关于 Azure Windows VM 的磁盘和 VHD（磁盘类型小节）](/storage/storage-about-disks-and-vhds-windows)\r - [高性能高级存储以及非托管 Azure VM 磁盘](/storage/storage-premium-storage)\r \r ## **解决方法**\r \r ### 认证凭据\r \r 在使用 Azure Management Libraries for Java 时，我们需要通过 AD Application 进行授权认证。建议使用最新版 Powershell 按以下脚本操作：\r \r ```\r # 1.在 PowerShell 中，登录 Azure 账户\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r \r # 2.选择当前订阅 ID\r Set-AzureRmContext -SubscriptionId \"订阅 ID\"\r \r # 3.创建 AD Application\r $azureAdApplication = New-AzureRmADApplication -DisplayName \"georgeapp\" -HomePage \"https://www.georgeapp.org\" -IdentifierUris \"https://www.georgeapp.org/example\" -Password \"1QAZxsw2\"\r $azureAdApplication\r \r # 4.为你的 AD 应用创建服务凭证\r New-AzureRmADServicePrincipal -ApplicationId $azureAdApplication.ApplicationId\r \r # 5.为服务凭证授权。如果想了解更多内容，请参考：https://azure.microsoft.com/en-us/documentation/articles/role-based-access-control-what-is/\r New-AzureRmRoleAssignment -RoleDefinitionName Contributor -ServicePrincipalName $azureAdApplication.ApplicationId\r ```\r \r 执行上述操作后，就可以获取可用的认证凭据信息：\r \r - tentant-id：第二步执行完成后返回\r - application-id：第三步执行完成后返回\r - application-password：第三步中设置的 Password\r \r ### 代码实现\r \r ```\r public void createWindows(\r String resourceGroupName,\r String vmName,\r String vmStorageAccountName,\r String vmUserName,\r String vmPassword,\r KnownWindowsVirtualMachineImage vmImage,\r Region vmRegion,\r VirtualMachineSizeTypes vmSize) throws Exception {\r \r if (azure == null) {\r     return;\r }\r \r StorageAccount storageAccount =azure\r .storageAccounts()\r .getByGroup(resourceGroupName, vmStorageAccountName);\r VirtualMachine windowsVM = azure\r .virtualMachines()\r .define(vmName)\r .withRegion(vmRegion)\r .withNewResourceGroup(resourceGroupName)\r .withNewPrimaryNetwork(\"10.0.0.0/28\")\r .withPrimaryPrivateIpAddressDynamic()\r .withoutPrimaryPublicIpAddress()\r .withPopularWindowsImage(vmImage)\r .withAdminUserName(vmUserName)\r .withPassword(vmPassword)\r .withNewDataDisk(10)\r .withExistingStorageAccount(storageAccount)\r .withSize(vmSize).create();\r }\r \r @org.junit.Test\r public void test() throws Exception {\r VmOperation vmOp = new VmOperation(\r \"tentant-id\",\r \"application-id\",\r \"application-password\",\r \"subId\");\r \r vmOp.createWindows(\r \"资源组\",\r \"虚拟机名称\",\r \"存储账户名称\",\r \"虚拟机 RDP 用户名\",\r \"虚拟机 RDP 密码\",\r \"虚拟机 Image\",\r \"虚拟机 Region\",\r \"虚拟机 Size\");\r ```\r \r ### 测试结果\r \r - 设定为普通存储账户\r \r     ![standard-storage-account](./media/aog-virtual-machines-qa-arm-set-disk-type-with-java/standard-storage-account.png)\r \r - 设定为高级存储账户\r \r     ![premium-storage-account](./media/aog-virtual-machines-qa-arm-set-disk-type-with-java/premium-storage-account.png)"}