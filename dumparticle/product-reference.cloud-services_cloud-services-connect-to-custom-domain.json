{"Title":"将云服务连接到自定义域控制器","Description":"了解如何使用 Powershell 和 AD 域扩展将 Web/辅助角色连接到自定义 AD 域","Content":"# <a name=\"connecting-azure-cloud-services-roles-to-a-custom-ad-domain-controller-hosted-in-azure\"></a>将 Azure 云服务角色连接到 Azure 中托管的自定义 AD 域控制器\r 我们先在 Azure 中设置一个虚拟网络 (VNet)。 然后将 Active Directory 域控制器（托管在 Azure 虚拟机上）添加到该 VNet。 接下来，将现有云服务角色添加预先创建的 VNet，然后将它们连接到域控制器。\r \r 在开始之前，请特别注意以下几点：\r \r 1. 本教程使用 Powershell，因此请确保已安装 Azure Powershell 并已准备就绪。有关设置 Azure Powershell 的帮助，请参阅[如何安装和配置 Azure PowerShell](../powershell-install-configure.md)。\r \r 2. AD 域控制器和 Web/辅助角色实例需要在 VNET 中。\r \r 请遵循以下分步指南。如果遇到任何问题，请在本文末尾留言。 我们将回复你（没错，我们真的会阅读留言）。\r \r 由云服务引用的网络必须为**经典虚拟网络**。\r \r ## <a name=\"create-a-virtual-network\"></a>创建虚拟网络\r 可以使用 Azure 门户或 PowerShell 在 Azure 中创建虚拟网络。 本教程将使用 PowerShell。 若要使用 Azure 门户创建虚拟网络，请参阅[创建虚拟网络](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)。\r \r ```powershell\r #Create Virtual Network\r \r $vnetStr =\r @\"<?xml version=\"1.0\" encoding=\"utf-8\"?>\r <NetworkConfiguration xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration\">\r   <VirtualNetworkConfiguration>\r     <VirtualNetworkSites>\r       <VirtualNetworkSite name=\"[your-vnet-name]\" Location=\"China North\">\r         <AddressSpace>\r           <AddressPrefix>[your-address-prefix]</AddressPrefix>\r         </AddressSpace>\r         <Subnets>\r           <Subnet name=\"[your-subnet-name]\">\r             <AddressPrefix>[your-subnet-range]</AddressPrefix>\r           </Subnet>\r         </Subnets>\r       </VirtualNetworkSite>\r     </VirtualNetworkSites>\r   </VirtualNetworkConfiguration>\r </NetworkConfiguration>\r \"@;\r \r $vnetConfigPath = \"<path-to-vnet-config>\"\r Set-AzureVNetConfig -ConfigurationPath $vnetConfigPath\r ```\r \r ## <a name=\"create-a-virtual-machine\"></a>创建虚拟机\r \r 完成虚拟网络的设置后，需要创建 AD 域控制器。 在本教程中，我们会在 Azure 虚拟机上设置 AD 域控制器。\r \r 为此，请在 PowerShell 中使用以下命令创建虚拟机：\r \r ```powershell\r # Initialize variables\r # VNet and subnet must be classic virtual network resources, not Azure Resource Manager resources.\r \r $vnetname = '<your-vnet-name>'\r $subnetname = '<your-subnet-name>'\r $vmsvc1 = '<your-hosted-service>'\r $vm1 = '<your-vm-name>'\r $username = '<your-username>'\r $password = '<your-password>'\r $affgrp = '<your- affgrp>'\r \r # Create a VM and add it to the Virtual Network\r \r New-AzureQuickVM -Windows -ServiceName $vmsvc1 -Name $vm1 -ImageName $imgname -AdminUsername $username -Password $password -AffinityGroup $affgrp -SubnetNames $subnetname -VNetName $vnetname\r ```\r \r ## <a name=\"promote-your-virtual-machine-to-a-domain-controller\"></a>将虚拟机提升为域控制器\r 要将虚拟机配置为 AD 域控制器，需要登录 VM 并对其进行配置。\r \r 若要登录 VM，你可以通过 PowerShell 获取 RDP 文件；请使用以下命令：\r \r ```powershell\r # Get RDP file\r Get-AzureRemoteDesktopFile -ServiceName $vmsvc1 -Name $vm1 -LocalPath <rdp-file-path>\r ```\r \r 登录 VM 后，请根据[如何设置客户 AD 域控制器](http://social.technet.microsoft.com/wiki/contents/articles/12370.windows-server-2012-set-up-your-first-domain-controller-step-by-step.aspx)中的分步指导，将虚拟机设置为 AD 域控制器。\r \r ## <a name=\"add-your-cloud-service-to-the-virtual-network\"></a>将云服务添加到虚拟网络\r 接下来，需要将云服务部署添加到新的 VNet。 为此，请使用 Visual Studio 或选择的编辑器将相关节添加到 cscfg，以修改云服务 cscfg。\r \r ```xml\r <ServiceConfiguration serviceName=\"[hosted-service-name]\" xmlns=\"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceConfiguration\" osFamily=\"[os-family]\" osVersion=\"*\">\r     <Role name=\"[role-name]\">\r     <Instances count=\"[number-of-instances]\" />\r   </Role>\r   <NetworkConfiguration>\r \r     <!--optional-->\r     <Dns>\r       <DnsServers><DnsServer name=\"[dns-server-name]\" IPAddress=\"[ip-address]\" /></DnsServers>\r     </Dns>\r     <!--optional-->\r \r <!--VNet settings\r     VNet and subnet must be classic virtual network resources, not Azure Resource Manager resources.-->\r <VirtualNetworkSite name=\"[virtual-network-name]\" />\r <AddressAssignments>\r     <InstanceAddress roleName=\"[role-name]\">\r     <Subnets>\r         <Subnet name=\"[subnet-name]\" />\r     </Subnets>\r     </InstanceAddress>\r </AddressAssignments>\r <!--VNet settings-->\r \r   </NetworkConfiguration>\r </ServiceConfiguration>\r ```\r \r 接下来，请生成云服务项目并将它部署到 Azure。 有关将云服务包部署到 Azure 的帮助，请参阅[如何创建和部署云服务](cloud-services-how-to-create-deploy-portal.md)\r \r ## <a name=\"connect-your-webworker-roles-to-the-domain\"></a>将 Web/辅助角色连接到域\r 在 Azure 上部署云服务项目后，请使用 AD 域扩展将角色实例连接到自定义 AD 域。 若要将 AD 域扩展添加到现有云服务部署并加入自定义域，请在 PowerShell 中执行以下命令：\r \r ```powershell\r # Initialize domain variables\r $domain = '<your-domain-name>'\r $dmuser = '$domain<your-username>'\r $dmpswd = '<your-domain-password>'\r $dmspwd = ConvertTo-SecureString $dmpswd -AsPlainText -Force\r $dmcred = New-Object System.Management.Automation.PSCredential ($dmuser, $dmspwd)\r \r # Add AD Domain Extension to the cloud service roles\r Set-AzureServiceADDomainExtension -Service <your-cloud-service-hosted-service-name> -Role <your-role-name> -Slot <staging-or-production> -DomainName $domain -Credential $dmcred -JoinOption 35\r ```\r \r 这就是所有的操作。\r \r 云服务现在应已加入自定义域控制器。如果想要详细了解可用于配置 AD 域扩展的其他选项，请如下所示使用 PowerShell 帮助。\r \r ```powershell\r help Set-AzureServiceADDomainExtension\r help New-AzureServiceADDomainExtensionConfig\r ```\r \r <!--Update_Description:update meta properties and wording-->"}