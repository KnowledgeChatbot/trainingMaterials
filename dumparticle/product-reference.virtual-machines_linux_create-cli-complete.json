{"Title":"使用 Azure CLI 创建完整的 Linux 虚拟机","Description":"使用 Azure CLI 2.0 从头开始创建存储、Linux VM、虚拟网络和子网、负载均衡器、NIC、公共 IP 和网络安全组。","Content":"# <a name=\"create-a-complete-linux-virtual-machine-with-the-azure-cli\"></a>使用 Azure CLI 创建完整的 Linux 虚拟机\r \r 若要在 Azure 中快速创建虚拟机 (VM)，可使用单个使用默认值的 Azure CLI 命令创建任何所需的支持资源。 虚拟网络、公共 IP 地址和网络安全组规则等资源均会自动创建。 为了在生产使用中更好地控制环境，可提前创建这些资源，并将 VM 添加到其中。 本文逐步介绍如何创建 VM 和每个支持资源。\r \r 确保已安装了最新的 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-az-cli2?view=azure-cli-latest) 并已使用 [az login](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#login) 登录到 Azure 帐户。\r \r [!INCLUDE [azure-cli-2-azurechinacloud-environment-parameter](../../../includes/azure-cli-2-azurechinacloud-environment-parameter.md)]\r \r 在以下示例中，请将示例参数名称替换成自己的值。 示例参数名称包括 *myResourceGroup*、*myVnet* 和 *myVM*。\r \r ## <a name=\"create-resource-group\"></a>创建资源组\r Azure 资源组是在其中部署和管理 Azure 资源的逻辑容器。 创建虚拟机和支持的虚拟网络资源前，必须先创建资源组。 使用 [az group create](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#create) 创建资源组。 以下示例在“chinaeast”位置创建名为“myResourceGroup”的资源组：\r \r ```azurecli\r az group create --name myResourceGroup --location chinaeast\r ```\r \r 默认情况下，Azure CLI 命令的输出采用 JSON（JavaScript 对象表示法）格式。 若要更改列表或表的默认输出，请使用 [az configure --output](https://docs.azure.cn/zh-cn/cli/?view=azure-cli-latest#configure)。 还可以向任何命令添加 `--output` 以一次性地更改输出格式。 以下示例显示了来自 `az group create` 命令的 JSON 输出：\r \r ```json                       \r {\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup\",\r   \"location\": \"chinaeast\",\r   \"name\": \"myResourceGroup\",\r   \"properties\": {\r     \"provisioningState\": \"Succeeded\"\r   },\r   \"tags\": null\r }\r ```\r \r ## <a name=\"create-a-virtual-network-and-subnet\"></a>创建虚拟网络和子网\r 接下来，在 Azure 中创建一个虚拟网络，以及一个可在其中创建 VM 的子网。 使用 [az network vnet create](https://docs.azure.cn/zh-cn/cli/network/vnet?view=azure-cli-latest#create) 创建一个名为 *myVnet* 的虚拟网络，其地址前缀为 *192.168.0.0/16*。 还需添加一个名为 *mySubnet* 的子网，其地址前缀为 *192.168.1.0/24*：\r \r ```azurecli\r az network vnet create \\\r     --resource-group myResourceGroup \\\r     --name myVnet \\\r     --address-prefix 192.168.0.0/16 \\\r     --subnet-name mySubnet \\\r     --subnet-prefix 192.168.1.0/24\r ```\r \r 输出显示了在虚拟网络内以逻辑方式创建的子网：\r \r ```json\r {\r   \"addressSpace\": {\r     \"addressPrefixes\": [\r       \"192.168.0.0/16\"\r     ]\r   },\r   \"dhcpOptions\": {\r     \"dnsServers\": []\r   },\r   \"etag\": \"W/\\\"e95496fc-f417-426e-a4d8-c9e4d27fc2ee\\\"\",\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet\",\r   \"location\": \"chinaeast\",\r   \"name\": \"myVnet\",\r   \"provisioningState\": \"Succeeded\",\r   \"resourceGroup\": \"myResourceGroup\",\r   \"resourceGuid\": \"ed62fd03-e9de-430b-84df-8a3b87cacdbb\",\r   \"subnets\": [\r     {\r       \"addressPrefix\": \"192.168.1.0/24\",\r       \"etag\": \"W/\\\"e95496fc-f417-426e-a4d8-c9e4d27fc2ee\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\",\r       \"ipConfigurations\": null,\r       \"name\": \"mySubnet\",\r       \"networkSecurityGroup\": null,\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"resourceNavigationLinks\": null,\r       \"routeTable\": null\r     }\r   ],\r   \"tags\": {},\r   \"type\": \"Microsoft.Network/virtualNetworks\",\r   \"virtualNetworkPeerings\": null\r }\r ```\r \r ## <a name=\"create-a-public-ip-address\"></a>创建公共 IP 地址\r 现在使用 [az network public-ip create](https://docs.azure.cn/zh-cn/cli/network/public-ip?view=azure-cli-latest#create) 创建公共 IP 地址。 可使用此公共 IP 地址从 Internet 连接到 VM。 因为默认地址是动态的，所以还需创建一个带 `--domain-name-label` 选项的命名 DNS 条目。 以下示例创建一个名为 *myPublicIP* 的公共 IP，其 DNS 名称为 *mypublicdns*。 DNS 名称必须唯一，因此请提供自己的唯一 DNS 名称：\r \r ```azurecli\r az network public-ip create \\\r     --resource-group myResourceGroup \\\r     --name myPublicIP \\\r     --dns-name mypublicdns\r ```\r \r 输出：\r \r ```json\r {\r   \"publicIp\": {\r     \"dnsSettings\": {\r       \"domainNameLabel\": \"mypublicdns\",\r       \"fqdn\": \"mypublicdns.chinaeast.chinacloudapp.cn\",\r       \"reverseFqdn\": null\r     },\r     \"etag\": \"W/\\\"2632aa72-3d2d-4529-b38e-b622b4202925\\\"\",\r     \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\",\r     \"idleTimeoutInMinutes\": 4,\r     \"ipAddress\": null,\r     \"ipConfiguration\": null,\r     \"location\": \"chinaeast\",\r     \"name\": \"myPublicIP\",\r     \"provisioningState\": \"Succeeded\",\r     \"publicIpAddressVersion\": \"IPv4\",\r     \"publicIpAllocationMethod\": \"Dynamic\",\r     \"resourceGroup\": \"myResourceGroup\",\r     \"resourceGuid\": \"4c65de38-71f5-4684-be10-75e605b3e41f\",\r     \"tags\": null,\r     \"type\": \"Microsoft.Network/publicIPAddresses\"\r   }\r }\r ```\r \r ## <a name=\"create-a-network-security-group\"></a>创建网络安全组\r 若要控制传入和传出 VM 的流量，请创建网络安全组。 可将网络安全组应用到 NIC 或子网。 以下示例使用 [az network nsg create](https://docs.azure.cn/zh-cn/cli/network/nsg?view=azure-cli-latest#create) 创建一个名为 *myNetworkSecurityGroup* 的网络安全组：\r \r ```azurecli\r az network nsg create \\\r     --resource-group myResourceGroup \\\r     --name myNetworkSecurityGroup\r ```\r \r 定义允许或拒绝特定流量的规则。 若要允许端口 22 上的入站连接（以支持 SSH），请使用 [az network nsg rule create](https://docs.azure.cn/zh-cn/cli/network/nsg/rule?view=azure-cli-latest#create) 为网络安全组创建入站规则。 以下示例创建名为 *myNetworkSecurityGroupRuleSSH* 的规则：\r \r ```azurecli\r az network nsg rule create \\\r     --resource-group myResourceGroup \\\r     --nsg-name myNetworkSecurityGroup \\\r     --name myNetworkSecurityGroupRuleSSH \\\r     --protocol tcp \\\r     --priority 1000 \\\r     --destination-port-range 22 \\\r     --access allow\r ```\r \r 若要允许端口 80 上的入站连接（以支持 Web 流量），请添加另一网络安全组规则。 以下示例创建名为 *myNetworkSecurityGroupRuleHTTP* 的规则：\r \r ```azurecli\r az network nsg rule create \\\r     --resource-group myResourceGroup \\\r     --nsg-name myNetworkSecurityGroup \\\r     --name myNetworkSecurityGroupRuleWeb \\\r     --protocol tcp \\\r     --priority 1001 \\\r     --destination-port-range 80 \\\r     --access allow\r ```\r \r 使用 [az network nsg show](https://docs.azure.cn/zh-cn/cli/network/nsg?view=azure-cli-latest#show)检查网络安全组和规则：\r \r ```azurecli\r az network nsg show --resource-group myResourceGroup --name myNetworkSecurityGroup\r ```\r \r 输出：\r \r ```json\r {\r   \"defaultSecurityRules\": [\r     {\r       \"access\": \"Allow\",\r       \"description\": \"Allow inbound traffic from all VMs in VNET\",\r       \"destinationAddressPrefix\": \"VirtualNetwork\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Inbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/AllowVnetInBound\",\r       \"name\": \"AllowVnetInBound\",\r       \"priority\": 65000,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"VirtualNetwork\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Allow\",\r       \"description\": \"Allow inbound traffic from azure load balancer\",\r       \"destinationAddressPrefix\": \"*\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Inbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/AllowAzureLoadBalancerInBou\r       \"name\": \"AllowAzureLoadBalancerInBound\",\r       \"priority\": 65001,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"AzureLoadBalancer\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Deny\",\r       \"description\": \"Deny all inbound traffic\",\r       \"destinationAddressPrefix\": \"*\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Inbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/DenyAllInBound\",\r       \"name\": \"DenyAllInBound\",\r       \"priority\": 65500,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"*\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Allow\",\r       \"description\": \"Allow outbound traffic from all VMs to all VMs in VNET\",\r       \"destinationAddressPrefix\": \"VirtualNetwork\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Outbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/AllowVnetOutBound\",\r       \"name\": \"AllowVnetOutBound\",\r       \"priority\": 65000,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"VirtualNetwork\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Allow\",\r       \"description\": \"Allow outbound traffic from all VMs to Internet\",\r       \"destinationAddressPrefix\": \"Internet\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Outbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/AllowInternetOutBound\",\r       \"name\": \"AllowInternetOutBound\",\r       \"priority\": 65001,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"*\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Deny\",\r       \"description\": \"Deny all outbound traffic\",\r       \"destinationAddressPrefix\": \"*\",\r       \"destinationPortRange\": \"*\",\r       \"direction\": \"Outbound\",\r       \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/defaultSecurityRules/DenyAllOutBound\",\r       \"name\": \"DenyAllOutBound\",\r       \"priority\": 65500,\r       \"protocol\": \"*\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"*\",\r       \"sourcePortRange\": \"*\"\r     }\r   ],\r   \"etag\": \"W/\\\"3371b313-ea9f-4687-a336-a8ebdfd80523\\\"\",\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup\",\r   \"location\": \"chinaeast\",\r   \"name\": \"myNetworkSecurityGroup\",\r   \"networkInterfaces\": null,\r   \"provisioningState\": \"Succeeded\",\r   \"resourceGroup\": \"myResourceGroup\",\r   \"resourceGuid\": \"47a9964e-23a3-438a-a726-8d60ebbb1c3c\",\r   \"securityRules\": [\r     {\r       \"access\": \"Allow\",\r       \"description\": null,\r       \"destinationAddressPrefix\": \"*\",\r       \"destinationPortRange\": \"22\",\r       \"direction\": \"Inbound\",\r       \"etag\": \"W/\\\"9e344b60-0daa-40a6-84f9-0ebbe4a4b640\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/securityRules/myNetworkSecurityGroupRuleSSH\",\r       \"name\": \"myNetworkSecurityGroupRuleSSH\",\r       \"priority\": 1000,\r       \"protocol\": \"Tcp\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"*\",\r       \"sourcePortRange\": \"*\"\r     },\r     {\r       \"access\": \"Allow\",\r       \"description\": null,\r       \"destinationAddressPrefix\": \"*\",\r       \"destinationPortRange\": \"80\",\r       \"direction\": \"Inbound\",\r       \"etag\": \"W/\\\"9e344b60-0daa-40a6-84f9-0ebbe4a4b640\\\"\",\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup/securityRules/myNetworkSecurityGroupRuleWeb\",\r       \"name\": \"myNetworkSecurityGroupRuleWeb\",\r       \"priority\": 1001,\r       \"protocol\": \"Tcp\",\r       \"provisioningState\": \"Succeeded\",\r       \"resourceGroup\": \"myResourceGroup\",\r       \"sourceAddressPrefix\": \"*\",\r       \"sourcePortRange\": \"*\"\r     }\r   ],\r   \"subnets\": null,\r   \"tags\": null,\r   \"type\": \"Microsoft.Network/networkSecurityGroups\"\r }\r ```\r \r ## <a name=\"create-a-virtual-nic\"></a>创建虚拟 NIC\r 由于可将规则应用到虚拟网络接口卡 (NIC) 的使用上，因此能以编程方式使用它。 可以创建多个规则。 在以下 [az network nic create](https://docs.azure.cn/zh-cn/cli/network/nic?view=azure-cli-latest#create) 命令中，会创建一个名为 *myNic* 的 NIC，并将其与网络安全组相关联。 公共 IP 地址 *myPublicIP* 也与此虚拟 NIC 相关联。\r \r ```azurecli\r az network nic create \\\r     --resource-group myResourceGroup \\\r     --name myNic \\\r     --vnet-name myVnet \\\r     --subnet mySubnet \\\r     --public-ip-address myPublicIP \\\r     --network-security-group myNetworkSecurityGroup\r ```\r \r 输出：\r \r ```json\r {\r   \"NewNIC\": {\r     \"dnsSettings\": {\r       \"appliedDnsServers\": [],\r       \"dnsServers\": [],\r       \"internalDnsNameLabel\": null,\r       \"internalDomainNameSuffix\": \"brqlt10lvoxedgkeuomc4pm5tb.bx.internal.chinacloudapp.cn\",\r       \"internalFqdn\": null\r     },\r     \"enableAcceleratedNetworking\": false,\r     \"enableIpForwarding\": false,\r     \"etag\": \"W/\\\"04b5ab44-d8f4-422a-9541-e5ae7de8466d\\\"\",\r     \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNic\",\r     \"ipConfigurations\": [\r       {\r         \"applicationGatewayBackendAddressPools\": null,\r         \"etag\": \"W/\\\"04b5ab44-d8f4-422a-9541-e5ae7de8466d\\\"\",\r         \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkInterfaces/myNic/ipConfigurations/ipconfig1\",\r         \"loadBalancerBackendAddressPools\": null,\r         \"loadBalancerInboundNatRules\": null,\r         \"name\": \"ipconfig1\",\r         \"primary\": true,\r         \"privateIpAddress\": \"192.168.1.4\",\r         \"privateIpAddressVersion\": \"IPv4\",\r         \"privateIpAllocationMethod\": \"Dynamic\",\r         \"provisioningState\": \"Succeeded\",\r         \"publicIpAddress\": {\r           \"dnsSettings\": null,\r           \"etag\": null,\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/publicIPAddresses/myPublicIP\",\r           \"idleTimeoutInMinutes\": null,\r           \"ipAddress\": null,\r           \"ipConfiguration\": null,\r           \"location\": null,\r           \"name\": null,\r           \"provisioningState\": null,\r           \"publicIpAddressVersion\": null,\r           \"publicIpAllocationMethod\": null,\r           \"resourceGroup\": \"myResourceGroup\",\r           \"resourceGuid\": null,\r           \"tags\": null,\r           \"type\": null\r         },\r         \"resourceGroup\": \"myResourceGroup\",\r         \"subnet\": {\r           \"addressPrefix\": null,\r           \"etag\": null,\r           \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet\",\r           \"ipConfigurations\": null,\r           \"name\": null,\r           \"networkSecurityGroup\": null,\r           \"provisioningState\": null,\r           \"resourceGroup\": \"myResourceGroup\",\r           \"resourceNavigationLinks\": null,\r           \"routeTable\": null\r         }\r       }\r     ],\r     \"location\": \"chinaeast\",\r     \"macAddress\": null,\r     \"name\": \"myNic\",\r     \"networkSecurityGroup\": {\r       \"defaultSecurityRules\": null,\r       \"etag\": null,\r       \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkSecurityGroups/myNetworkSecurityGroup\",\r       \"location\": null,\r       \"name\": null,\r       \"networkInterfaces\": null,\r       \"provisioningState\": null,\r       \"resourceGroup\": \"myResourceGroup\",\r       \"resourceGuid\": null,\r       \"securityRules\": null,\r       \"subnets\": null,\r       \"tags\": null,\r       \"type\": null\r     },\r     \"primary\": null,\r     \"provisioningState\": \"Succeeded\",\r     \"resourceGroup\": \"myResourceGroup\",\r     \"resourceGuid\": \"b3dbaa0e-2cf2-43be-a814-5cc49fea3304\",\r     \"tags\": null,\r     \"type\": \"Microsoft.Network/networkInterfaces\",\r     \"virtualMachine\": null\r   }\r }\r ```\r \r ## <a name=\"create-an-availability-set\"></a>创建可用性集\r 可用性集有助于将 VM 分散到容错域和更新域。 即使现在只创建一个 VM，也最好使用可用性集，以便将来更容易进行扩展。 \r \r 容错域定义共享通用电源和网络交换机的一组虚拟机。 默认情况下，在可用性集中配置的虚拟机隔离在最多三个容错域中。 其中一个容错域中的硬件问题不会影响运行应用的每个 VM。\r \r 更新域表示虚拟机组以及可同时重新启动的基础物理硬件。 在计划内维护期间，更新域的重新启动顺序可能不会按序进行，但一次只重新启动一个更新域。\r \r 将多个 VM 放入一个可用性集时，Azure 会自动将它们分散到容错域和更新域。 有关详细信息，请参阅[管理 VM 的可用性](manage-availability.md)。\r \r 使用 [az vm availability-set create](https://docs.azure.cn/zh-cn/cli/vm/availability-set?view=azure-cli-latest#create) 为 VM 创建可用性集。 以下示例创建名为“myAvailabilitySet”的可用性集：\r \r ```azurecli\r az vm availability-set create \\\r     --resource-group myResourceGroup \\\r     --name myAvailabilitySet\r ```\r \r 此输出表明了容错域和更新域：\r \r ```json\r {\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Compute/availabilitySets/myAvailabilitySet\",\r   \"location\": \"chinaeast\",\r   \"managed\": null,\r   \"name\": \"myAvailabilitySet\",\r   \"platformFaultDomainCount\": 2,\r   \"platformUpdateDomainCount\": 5,\r   \"resourceGroup\": \"myResourceGroup\",\r   \"sku\": {\r     \"capacity\": null,\r     \"managed\": true,\r     \"tier\": null\r   },\r   \"statuses\": null,\r   \"tags\": {},\r   \"type\": \"Microsoft.Compute/availabilitySets\",\r   \"virtualMachines\": []\r }\r ```\r \r ## <a name=\"create-the-linux-vms\"></a>创建 Linux VM\r 现已创建用于支持可访问 Internet 的 VM 的网络资源。 现在创建 VM，并使用 SSH 密钥进行保护。 在此情况下，我们需要基于最新的 LTS 创建 Ubuntu VM。 可使用 [az vm image list](https://docs.azure.cn/zh-cn/cli/vm/image?view=azure-cli-latest#list) 查找其他映像，如[查找 Azure VM 映像](cli-ps-findimage.md)中所述。\r \r 我们还会指定要用于身份验证的 SSH 密钥。 如果没有 SSH 公钥对，可[进行创建](mac-create-ssh-keys.md)或使用 `--generate-ssh-keys` 参数创建。 如果已有密钥对，此参数则使用 `~/.ssh` 中现有的密钥。\r \r 使用 [az vm create](https://docs.azure.cn/zh-cn/cli/vm?view=azure-cli-latest#create) 命令并结合所有资源和信息来创建 VM。 以下示例创建一个名为 myVM 的 VM：\r \r ```azurecli\r az vm create \\\r     --resource-group myResourceGroup \\\r     --name myVM \\\r     --location chinaeast \\\r     --availability-set myAvailabilitySet \\\r     --nics myNic \\\r     --image UbuntuLTS \\\r     --admin-username azureuser \\\r     --generate-ssh-keys\r ```\r \r 使用创建公共 IP 地址时提供的 DNS 条目通过 SSH 连接到 VM。 创建 VM 时，输出中会显示此 `fqdn`：\r \r ```json\r {\r   \"fqdns\": \"mypublicdns.chinaeast.chinacloudapp.cn\",\r   \"id\": \"/subscriptions/guid/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM\",\r   \"location\": \"chinaeast\",\r   \"macAddress\": \"00-0D-3A-13-71-C8\",\r   \"powerState\": \"VM running\",\r   \"privateIpAddress\": \"192.168.1.5\",\r   \"publicIpAddress\": \"13.90.94.252\",\r   \"resourceGroup\": \"myResourceGroup\"\r }\r ```\r \r ```bash\r ssh azureuser@mypublicdns.chinaeast.chinacloudapp.cn\r ```\r \r 输出：\r \r ```bash\r The authenticity of host 'mypublicdns.chinaeast.chinacloudapp.cn (13.90.94.252)' can't be established.\r ECDSA key fingerprint is SHA256:SylINP80Um6XRTvWiFaNz+H+1jcrKB1IiNgCDDJRj6A.\r Are you sure you want to continue connecting (yes/no)? yes\r Warning: Permanently added 'mypublicdns.chinaeast.chinacloudapp.cn,13.90.94.252' (ECDSA) to the list of known hosts.\r Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.4.0-81-generic x86_64)\r \r  * Documentation:  https://help.ubuntu.com\r  * Management:     https://landscape.canonical.com\r  * Support:        https://ubuntu.com/advantage\r \r   Get cloud support with Ubuntu Advantage Cloud Guest:\r     http://www.ubuntu.com/business/services/cloud\r \r 0 packages can be updated.\r 0 updates are security updates.\r \r The programs included with the Ubuntu system are free software;\r the exact distribution terms for each program are described in the\r individual files in /usr/share/doc/*/copyright.\r \r Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by\r applicable law.\r \r To run a command as administrator (user \"root\"), use \"sudo <command>\".\r See \"man sudo_root\" for details.\r \r azureuser@myVM:~$\r ```\r \r 可安装 NGINX 并查看到 VM 的流量。 安装 NGINX，如下所示：\r \r ```bash\r sudo apt-get install -y nginx\r ```\r \r 若要查看活动的默认 NGINX 站点，请打开 Web 浏览器并输入 FQDN：\r \r ![VM 上的默认 NGINX 站点](media/create-cli-complete/nginx.png)\r \r ## <a name=\"export-as-a-template\"></a>作为模板导出\r 如果现在要使用相同参数创建额外的开发环境或与其匹配的生产环境，该怎么办？ Resource Manager 使用定义了所有环境参数的 JSON 模板。 通过引用此 JSON 模板构建出整个环境。 可以[手动构建 JSON 模板](../../azure-resource-manager/resource-group-authoring-templates.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)，也可以通过导出现有环境来创建 JSON 模板。 使用 [az group export](https://docs.azure.cn/zh-cn/cli/group?view=azure-cli-latest#export) 导出资源组，如下所示：\r \r ```azurecli\r az group export --name myResourceGroup > myResourceGroup.json\r ```\r \r 此命令在当前工作目录中创建 `myResourceGroup.json` 文件。 从此模板创建环境时，系统会提示输入所有资源名称。 可以通过将 `--include-parameter-default-value` 参数添加到 `az group export` 命令在模板文件中填充这些名称。 请编辑 JSON 模板以指定资源名称，或[创建 parameters.json 文件](../../azure-resource-manager/resource-group-authoring-templates.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)来指定资源名称。\r \r 若要从模板创建环境，请使用 [az group deployment create](https://docs.azure.cn/zh-cn/cli/group/deployment?view=azure-cli-latest#create) ，如下所示：\r \r ```azurecli\r az group deployment create \\\r     --resource-group myNewResourceGroup \\\r     --template-file myResourceGroup.json\r ```\r \r 可能需要阅读[有关通过模板进行部署的详细信息](../../azure-resource-manager/resource-group-template-deploy-cli.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)。 了解如何对环境进行增量更新、如何使用参数文件，以及如何从单个存储位置访问模板。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 现在，已准备好开始使用多个网络组件和 VM。 可以使用本文介绍的核心组件，通过此示例环境构建应用程序。\r \r <!--Update_Description: simplify the steps-->"}