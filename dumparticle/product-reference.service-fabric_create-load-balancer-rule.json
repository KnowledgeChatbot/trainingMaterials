{"Title":"为群集创建 Azure 负载均衡器规则","Description":"配置 Azure 负载均衡器，为 Azure Service Fabric 群集打开端口。","Content":"# <a name=\"open-ports-for-a-service-fabric-cluster\"></a>为 Service Fabric 群集打开端口\r \r 使用 Azure Service Fabric 群集部署的负载均衡器将流量定向到在节点上运行的应用。 如果将应用更改为使用另一端口，必须在 Azure 负载均衡器中公开该端口（或路由另一端口）。\r \r 将 Service Fabric 群集部署到 Azure 后，系统会自动创建负载均衡器。 如果没有负载均衡器，请参阅[配置面向 Internet 的负载均衡器](..\\load-balancer\\load-balancer-get-started-internet-portal.md)。\r \r ## <a name=\"configure-service-fabric\"></a>配置 Service Fabric\r \r Service Fabric 应用程序 ServiceManifest.xml 配置文件定义应用程序应使用的终结点。 更新配置文件以定义终结点后，必须更新负载均衡器，公开该（或其他）端口。 有关如何创建 Service Fabric 终结点的详细信息，请参阅[设置终结点](service-fabric-service-manifest-resources.md)。\r \r ## <a name=\"create-a-load-balancer-rule\"></a>创建负载均衡器规则\r \r 负载均衡器规则可打开面向 Internet 的端口，并将流量转发至应用程序所用的内部节点的端口。 如果没有负载均衡器，请参阅[配置面向 Internet 的负载均衡器](..\\load-balancer\\load-balancer-get-started-internet-portal.md)。\r \r 要创建负载均衡器规则，需要收集以下信息：\r \r - 负载均衡器名称。\r - 负载均衡器和 Service Fabric 群集的资源组。\r - 外部端口。\r - 内部端口。\r \r ## <a name=\"azure-cli\"></a>Azure CLI\r 使用单个命令即可使用 Azure CLI 创建负载均衡器规则。 你只需知道用于创建新规则的负载均衡器和资源组的名称。\r \r >[!NOTE]\r >如果需要确定负载均衡器的名称，可使用此命令来快速获取所有负载均衡器和关联资源组的列表。\r >\r >`az network lb list --query \"[].{ResourceGroup: resourceGroup, Name: name}\"`\r >\r \r ```azurecli\r az network lb rule create --backend-port 40000 --frontend-port 39999 --protocol Tcp --lb-name LB-svcfab3 -g svcfab_cli -n my-app-rule\r ```\r \r Azure CLI 命令具有下表中所述的几个参数：\r \r | 参数 | 说明 |\r | --------- | ----------- |\r | `--backend-port`  | Service Fabric 应用程序正在侦听的端口。 |\r | `--frontend-port` | 负载均衡器针对外部连接公开的端口。 |\r | `-lb-name` | 要更改的负载均衡器的名称。 |\r | `-g`       | 同时包含负载均衡器与 Service Fabric 群集的资源组。 |\r | `-n`       | 所需的规则名称。 |\r \r >[!NOTE]\r >有关如何使用 Azure CLI 创建负载均衡器的详细信息，请参阅[使用 Azure CLI 创建负载均衡器](..\\load-balancer\\load-balancer-get-started-internet-arm-cli.md)。\r \r ## <a name=\"powershell\"></a>PowerShell\r \r PowerShell 比 Azure CLI 稍显复杂。 请按照这些概念步骤操作，创建规则：\r \r 1. 从 Azure 中获取负载均衡器。\r 2. 创建规则。\r 3. 将规则添加到负载均衡器。\r 4. 更新负载均衡器。\r \r >[!NOTE]\r >如果需要确定负载均衡器的名称，可使用此命令来快速获取所有负载均衡器和关联资源组的列表。\r >\r >`Get-AzureRmLoadBalancer | Select Name, ResourceGroupName`\r \r ```powershell\r # Get the load balancer\r $lb = Get-AzureRmLoadBalancer -Name LB-svcfab3 -ResourceGroupName svcfab_cli\r \r # Create the rule based on information from the load balancer.\r $lbrule = New-AzureRmLoadBalancerRuleConfig -Name my-app-rule7 -Protocol Tcp -FrontendPort 39990 -BackendPort 40009 `\r                                             -FrontendIpConfiguration $lb.FrontendIpConfigurations[0] `\r                                             -BackendAddressPool  $lb.BackendAddressPools[0] `\r                                             -Probe $lb.Probes[0]\r \r # Add the rule to the load balancer\r $lb.LoadBalancingRules.Add($lbrule)\r \r # Update the load balancer on Azure\r $lb | Set-AzureRmLoadBalancer\r ```\r \r 对于 `New-AzureRmLoadBalancerRuleConfig` 命令，`-FrontendPort` 表示负载均衡器针对外部连接公开的端口，而 `-BackendPort` 表示 Service Fabric 应用正在侦听的端口。\r \r >[!NOTE]\r >有关如何使用 PowerShell 创建负载均衡器的详细信息，请参阅[使用 PowerShell 创建负载均衡器](..\\load-balancer\\load-balancer-get-started-internet-arm-ps.md)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 详细了解 [Service Fabric 中的网络](service-fabric-patterns-networking.md)。\r "}