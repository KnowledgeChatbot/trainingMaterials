{"Title":"在 Azure Site Recovery 中管理配置服务器","Description":"本文介绍如何设置和管理配置服务器。","Content":"# <a name=\"manage-a-configuration-server\"></a>管理配置服务器\r \r 配置服务器充当 Site Recovery 服务与本地基础结构之间的协调器。 本文介绍如何设置、配置和管理配置服务器。\r \r > [!NOTE]\r > [容量规划](site-recovery-capacity-planner.md)是一个重要步骤，可确保使用符合负载要求的配置部署配置服务器。 阅读有关 [配置服务器大小要求](#sizing-requirements-for-a-configuration-server)的详细信息。\r \r ## <a name=\"prerequisites\"></a>先决条件\r 下面是设置配置服务器所需的最低硬件、软件和网络配置。\r > [!IMPORTANT]\r > 部署配置服务器以保护 VMware 虚拟机时，我们建议将其部署为高可用性 (HA) 虚拟机。\r \r [!INCLUDE [site-recovery-configuration-server-requirements](../../includes/site-recovery-configuration-and-scaleout-process-server-requirements.md)]\r \r ## <a name=\"downloading-the-configuration-server-software\"></a>下载配置服务器软件\r \r 1. 登录 Azure 门户并浏览到恢复服务保管库。\r 2. 浏览到“Site Recovery 基础结构” > “配置服务器”（在“适用于 VMware 和物理计算机”下面）。\r \r   ![添加服务器页](./media/site-recovery-vmware-to-azure-manage-configuration-server/AddServers.png)\r 3. 单击“+服务器”按钮。\r 4. 在“添加服务器”页中，单击“下载”按钮下载注册密钥。 在安装配置服务器的过程中，需要使用此密钥将它注册到 Azure Site Recovery 服务。\r 5. 单击“下载 Azure Site Recovery 统一安装程序”链接，下载最新版本的配置服务器。\r \r     ![“下载”页](./media/site-recovery-vmware-to-azure-manage-configuration-server/downloadcs.png)\r \r     > [!TIP]\r     > 可以直接从 [Microsoft 下载中心下载页](http://aka.ms/unifiedsetup)\r \r ## <a name=\"installing-and-registering-a-configuration-server-from-gui\"></a>通过 GUI 安装并注册配置服务器\r [!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]\r \r ## <a name=\"installing-and-registering-a-configuration-server-using-command-line\"></a>使用命令行安装并注册配置服务器\r \r ```\r UnifiedSetup.exe [/ServerMode <CS/PS>] [/InstallDrive <DriveLetter>] [/MySQLCredsFilePath <MySQL credentials file path>] [/VaultCredsFilePath <Vault credentials file path>] [/EnvType <VMWare/NonVMWare>] [/PSIP <IP address to be used for data transfer] [/CSIP <IP address of CS to be registered with>] [/PassphraseFilePath <Passphrase file path>]\r ```\r \r ### <a name=\"sample-usage\"></a>示例用法\r ```\r MicrosoftAzureSiteRecoveryUnifiedSetup.exe /q /xC:\\Temp\\Extracted\r cd C:\\Temp\\Extracted\r UNIFIEDSETUP.EXE /AcceptThirdpartyEULA /servermode \"CS\" /InstallLocation \"D:\\\" /MySQLCredsFilePath \"C:\\Temp\\MySQLCredentialsfile.txt\" /VaultCredsFilePath \"C:\\Temp\\MyVault.vaultcredentials\" /EnvType \"VMWare\"\r ```\r \r ### <a name=\"configuration-server-installer-command-line-arguments\"></a>配置服务器安装程序命令行参数。\r [!INCLUDE [site-recovery-unified-setup-parameters](../../includes/site-recovery-unified-installer-command-parameters.md)]\r \r ### <a name=\"create-a-mysql-credentials-file\"></a>创建 MySql 凭据文件\r MySQLCredsFilePath 参数使用某个文件作为输入。 创建使用以下格式的文件并将其作为输入 MySQLCredsFilePath 参数进行传递。\r ```\r [MySQLCredentials]\r MySQLRootPassword = \"Password>\"\r MySQLUserPassword = \"Password\"\r ```\r ### <a name=\"create-a-proxy-settings-configuration-file\"></a>创建代理设置配置文件\r ProxySettingsFilePath 参数使用某个文件作为输入。 创建使用以下格式的文件并将其作为输入 ProxySettingsFilePath 参数进行传递。\r \r ```\r [ProxySettings]\r ProxyAuthentication = \"Yes/No\"\r Proxy IP = \"IP Address\"\r ProxyPort = \"Port\"\r ProxyUserName=\"UserName\"\r ProxyPassword=\"Password\"\r ```\r ## <a name=\"modifying-proxy-settings-for-configuration-server\"></a>修改配置服务器的代理设置\r 1. 登录到配置服务器。\r 2. 使用桌面上的快捷方式启动 cspsconfigtool.exe。\r 3. 单击“保管库注册”  选项卡。\r 4. 从门户下载新的保管库注册文件，并将其作为输入提供给该工具。\r \r     ![register-configuration-server](./media/site-recovery-vmware-to-azure-manage-configuration-server/register-csonfiguration-server.png)\r 5. 提供新代理服务器的详细信息，并单击“注册”按钮。\r 6. 打开管理员 PowerShell 命令窗口。\r 7. 运行以下命令\r     ```\r     $pwd = ConvertTo-SecureString -String MyProxyUserPassword\r     Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumber - ProxyUserName domain\\username -ProxyPassword $pwd\r     net stop obengine\r     net start obengine\r     ```\r \r     > [!WARNING]\r     > 如果已将横向扩展进程服务器附加到此配置服务器，需在部署中[修复所有横向扩展进程服务器上的代理设置](site-recovery-vmware-to-azure-manage-scaleout-process-server.md#modifying-proxy-settings-for-scale-out-process-server)。\r \r ## <a name=\"modify-user-accounts-and-passwords\"></a>修改用户帐户和密码\r \r 使用 CSPSConfigTool.exe 可以管理用于“自动发现 VMware 虚拟机”的用户帐户，以及执行受保护计算机上的移动服务推送安装。 \r \r 1. 登录到配置服务器。\r 2. 单击桌面上的快捷方式启动 CSPSConfigtool.exe。\r 3. 单击“管理帐户”选项卡。\r 4. 选择需要修改其密码的帐户，单击“编辑”按钮。\r 5. 输入新密码，单击“确定”\r \r ## <a name=\"re-register-a-configuration-server-with-the-same-recovery-services-vault\"></a>将配置服务器重新注册到同一个恢复服务保管库\r 1. 登录到配置服务器。\r 2. 使用桌面上的快捷方式启动 cspsconfigtool.exe。\r 3. 单击“保管库注册”选项卡。\r 4. 从门户下载新的注册文件，并将其作为输入提供给该工具。\r     ![register-configuration-server](./media/site-recovery-vmware-to-azure-manage-configuration-server/register-csonfiguration-server.png)\r 5. 提供代理服务器的详细信息，并单击“注册”按钮  。  \r 6. 打开管理员 PowerShell 命令窗口。\r 7. 运行以下命令\r \r     ```\r     $pwd = ConvertTo-SecureString -String MyProxyUserPassword\r     Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumber - ProxyUserName domain\\username -ProxyPassword $pwd\r     net stop obengine\r     net start obengine\r     ```\r \r     >[!WARNING]\r     如果已将横向扩展进程服务器附加到此配置服务器，需在部署中[重新注册所有横向扩展进程服务器](site-recovery-vmware-to-azure-manage-scaleout-process-server.md#re-registering-a-scale-out-process-server)。\r \r ## <a name=\"registering-a-configuration-server-with-a-different-recovery-services-vault\"></a>将配置服务器注册到不同的恢复服务保管库。\r \r > [!WARNING]\r > 以下步骤在当前保管库中取消关联配置，并停止配置服务器下所有受保护虚拟机的复制。\r \r 1. 登录到配置服务器。\r 2. 在管理员命令提示符下，运行以下命令\r \r     ```\r     reg delete HKLM\\Software\\Microsoft\\Azure Site Recovery\\Registration\r     net stop dra\r     ```\r 3. 使用桌面上的快捷方式启动 cspsconfigtool.exe。\r 4. 单击“保管库注册”  选项卡。\r 5. 从门户下载新的注册文件，并将其作为输入提供给该工具。\r \r     ![register-configuration-server](./media/site-recovery-vmware-to-azure-manage-configuration-server/register-csonfiguration-server.png)\r 6. 提供代理服务器的详细信息，并单击“注册”按钮  。  \r 7. 打开管理员 PowerShell 命令窗口。\r 8. 运行以下命令\r     ```\r     $pwd = ConvertTo-SecureString -String MyProxyUserPassword\r     Set-OBMachineSetting -ProxyServer http://myproxyserver.domain.com -ProxyPort PortNumber - ProxyUserName domain\\username -ProxyPassword $pwd\r     net stop obengine\r     net start obengine\r     ```\r \r ## <a name=\"upgrading-a-configuration-server\"></a>升级配置服务器\r \r > [!WARNING]\r > 最多仅支持更新到之后的第 4 个版本。 例如，如果市场中的最新版本为 9.11，则可以从版本 9.10、9.9、9.8 或 9.7 直接更新到 9.11。 但是，如果所用版本小于或等于 9.6，则需要至少先更新为 9.7，然后才能将最新更新应用到配置服务器。 以前版本的下载链接可在 [Azure Site Recovery 服务更新](https://social.technet.microsoft.com/wiki/contents/articles/38544.azure-site-recovery-service-updates.aspx)下找到\r \r 1. 将更新安装程序下载到配置服务器上。\r 2. 双击该安装程序以启动安装程序。\r 3. 该安装程序检测计算机上的 Site Recovery 组件版本并提示进行确认。 \r 4. 单击“确定”按钮以提供确认并继续进行升级。\r \r ## <a name=\"delete-or-unregister-a-configuration-server\"></a>删除或取消注册配置服务器\r \r > [!WARNING]\r > 在开始解除配置服务器之前，请务必执行以下操作。\r > 1. 针对此配置服务器下的所有虚拟机[禁用保护](site-recovery-manage-registration-and-protection.md#disable-protection-for-a-vmware-vm-or-physical-server-vmware-to-azure)。\r > 2. 从配置服务器中[取消关联](site-recovery-setup-replication-settings-vmware.md#dissociate-a-configuration-server-from-a-replication-policy)和[删除](site-recovery-setup-replication-settings-vmware.md#delete-a-replication-policy)所有复制策略。\r > 3. [删除](site-recovery-vmware-to-azure-manage-vCenter.md#delete-a-vcenter-in-azure-site-recovery)所有与配置服务器关联的 vCenters 服务器/vSphere 主机。\r \r ### <a name=\"delete-the-configuration-server-from-azure-portal\"></a>从 Azure 门户中删除配置服务器\r 1. 在 Azure 门户中，从“保管库”菜单浏览到“Site Recovery 基础结构” > “配置服务器”。\r 2. 单击想要解除的配置服务器。\r 3. 在配置服务器的详细信息页中，单击“删除”按钮。\r \r     ![delete-configuration-server](./media/site-recovery-vmware-to-azure-manage-configuration-server/delete-configuration-server.PNG)\r 4. 单击“是”确认删除该服务器。\r \r ### <a name=\"uninstall-the-configuration-server-software-and-its-dependencies\"></a>卸载配置服务器软件及其依赖项\r > [!TIP]\r > 如果打算再次结合 Azure Site Recovery 重新使用该配置服务器，可以直接跳到步骤 4\r \r 1. 以管理员身份登录到配置服务器。\r 2. 打开“控制面板”>“程序”>“卸载程序”\r 3. 按以下顺序卸载程序：\r     * Azure 恢复服务代理\r     * Azure Site Recovery 移动服务/主目标服务器\r     * Azure Site Recovery 提供程序\r     * Azure Site Recovery 配置服务器/进程服务器\r     * Azure Site Recovery 配置服务器依赖项\r     * MySQL Server 5.5\r 4. 在管理员命令提示符下运行以下命令。\r     ```\r     reg delete HKLM\\Software\\Microsoft\\Azure Site Recovery\\Registration\r     ```\r \r ## <a name=\"delete-or-unregister-a-configuration-server-powershell\"></a>删除或取消注册配置服务器 (PowerShell)\r \r 1. [安装](https://docs.microsoft.com/powershell/azure/install-azurerm-ps?view=azurermps-4.4.0) Azure PowerShell 模块\r 2. 使用命令登录到 Azure 帐户\r \r     `Login-AzureRmAccount -EnvironmentName AzureChinaCloud`\r 3. 选择其下存在保管库的订阅\r \r     `Get-AzureRmSubscription -SubscriptionName <your subscription name> | Select-AzureRmSubscription`\r 4.  现在设置保管库上下文\r \r     ```\r     $vault = Get-AzureRmRecoveryServicesVault -Name <name of your vault>\r     Set-AzureRmSiteRecoveryVaultSettings -ARSVault $vault\r     ```\r 5. 选择配置服务器\r \r     `$fabric = Get-AzureRmSiteRecoveryFabric -FriendlyName <name of your configuration server>`\r 6. 删除配置服务器\r \r     `Remove-AzureRmSiteRecoveryFabric -Fabric $fabric [-Force] `\r \r > [!NOTE]\r > Remove-AzureRmSiteRecoveryFabric 中的 -Force 选项可用于强制执行删除配置服务器。\r \r ## <a name=\"renew-configuration-server-secure-socket-layerssl-certificates\"></a>续订配置服务器安全套接字层 (SSL) 证书\r 配置服务器具有一个内置的 Web 服务器，该服务器协调连接到配置服务器的移动服务、进程服务器和主目标服务器的活动。 配置服务器的 Web 服务器使用 SSL 证书对其客户端进行身份验证。 此证书在三年后过期，随时可使用以下方法续订：\r \r > [!WARNING]\r 只能在 9.4.XXXX.X 或更高版本上执行证书过期。 在启动“续订证书”工作流之前，请升级所有 Azure Site Recovery 组件（配置服务器、进程服务器、主目标服务器、移动服务）。\r \r 1. 在 Azure 门户中，浏览到“保管库”>“Site Recovery 基础结构”>“配置服务器”。\r 2. 单击需要为其续订 SSL 证书的配置服务器。\r 3. 在“配置服务器运行状况”下面，可以看到 SSL 证书的过期日期。\r 4. 单击“续订证书”操作续订证书，如下图所示  ：\r \r     ![delete-configuration-server](./media/site-recovery-vmware-to-azure-manage-configuration-server/renew-cert-page.png)\r \r ### <a name=\"secure-socket-layer-certificate-expiry-warning\"></a>安全套接字层证书过期警告\r \r > [!NOTE]\r > 在 2016 年 5 月之前为所有安装生成的 SSL 证书的有效期设置为一年。 Azure 门户中应该已经开始显示证书过期通知。\r \r 1. 如果配置服务器的 SSL 证书会在未来两个月内到期，服务将开始通过 Azure 门户和电子邮件（需要订阅 Azure Site Recovery 通知）通知用户。 随后，保管库的资源页上会开始出现通知横幅。\r \r     ![certificate-notification](./media/site-recovery-vmware-to-azure-manage-configuration-server/ssl-cert-renew-notification.png)\r 2. 单击该横幅可获取有关证书过期的其他详细信息。\r \r     ![certificate-details](./media/site-recovery-vmware-to-azure-manage-configuration-server/ssl-cert-expiry-details.png)\r \r     > [!TIP]\r     > 如果未出现“立即续订”按钮，则会出现“立即升级”按钮。 “立即升级”按钮表示环境中有些组件尚未升级到 9.4.xxxx.x 或更高版本。\r \r ## <a name=\"revive-a-configuration-server-if-the-secure-socket-layer-ssl-certificate-expired\"></a>如果安全套接字层 (SSL) 证书已过期，请续订配置服务器\r \r 1. 将配置服务器更新到[最新版本](http://aka.ms/unifiedinstaller)\r 2. 如果有任何横向扩展进程服务器、故障回复主目标服务器或故障回复进程服务器，请将其更新到最新版本\r 3. 将所有受保护虚拟机上的移动服务更新到最新版本。\r 4. 登录到配置服务器，并使用管理员特权打开命令提示符。\r 5. 浏览到文件夹 %ProgramData%\\ASR\\home\\svsystems\\bin\r 6. 运行 RenewCerts.exe，续订配置文件服务器上的 SSL 证书。\r 7. 如果该过程成功，应会看到消息“证书续订成功”\r \r ## <a name=\"sizing-requirements-for-a-configuration-server\"></a>配置服务器大小要求\r \r | **CPU** | **内存** | **缓存磁盘大小** | **数据更改率** | **受保护的计算机** |\r | --- | --- | --- | --- | --- |\r | 8 个 vCPU（2 个插槽 * 4 个核心 @ 2.5 GHz） |16 GB |300 GB |500 GB 或更少 |复制少于 100 台计算机。 |\r | 12 个 vCPU（2 个插槽 * 6 个核心 @ 2.5 GHz） |18 GB |600 GB |500 GB 到 1 TB |复制 100-150 台计算机。 |\r | 16 个 vCPU（2 个插槽 * 8 个核心 @ 2.5 GHz） |32 GB |1 TB |1 TB 到 2 TB |复制 150-200 台计算机。 |\r \r > [!TIP]\r > 如果每日数据改动量超过 2 TB 或者要复制超过 200 个虚拟机，则建议部署额外的进程服务器，对复制流量进行负载均衡。 详细了解如何部署横向扩展进程服务器。\r \r ## <a name=\"common-issues\"></a>常见问题\r [!INCLUDE [site-recovery-vmware-to-azure-install-register-issues](../../includes/site-recovery-vmware-to-azure-install-register-issues.md)]\r \r <!--Update_Description: update meta properties, wording update -->"}