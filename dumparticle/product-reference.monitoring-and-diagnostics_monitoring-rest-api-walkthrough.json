{"Title":"Azure 监视 REST API 演练","Description":"如何对请求进行身份验证，以及如何使用 Azure Monitor REST API 检索可用的指标定义和指标值。","Content":"# <a name=\"azure-monitoring-rest-api-walkthrough\"></a>Azure 监视 REST API 演练\r 本文说明如何执行身份验证，使代码能够遵循 [Microsoft Azure Monitor REST API 参考](https://msdn.microsoft.com/library/azure/dn931943.aspx)。         \r \r 使用 Azure Monitor API 能够以编程方式检索可用的默认指标定义、粒度和指标值。 可将数据保存在独立的数据存储（例如 Azure SQL 数据库、Azure Cosmos DB）中。 然后，可以根据需要从该处执行其他分析。\r \r 除了处理各种指标数据点以外，使用监视 API 还可以查看活动日志以及执行其他许多操作。 有关可用操作的完整列表，请参阅 [Microsoft Azure Monitor REST API 参考](https://msdn.microsoft.com/library/azure/dn931943.aspx)。\r \r ## <a name=\"authenticating-azure-monitor-requests\"></a>对 Azure Monitor 请求进行身份验证\r 第一步是对请求进行身份验证。\r \r 针对 Azure 监视器 API 执行的所有任务都使用 Azure Resource Manager 身份验证模型。 因此，所有请求必须使用 Azure Active Directory (Azure AD) 进行身份验证。 对客户端应用程序进行身份验证的方法之一是创建 Azure AD 服务主体，并检索身份验证 (JWT) 令牌。 以下示例脚本演示如何通过 PowerShell 创建 Azure AD 服务主体。 有关更详细的演练，请参阅有关[使用 Azure PowerShell 创建用于访问资源的服务主体](../azure-resource-manager/resource-group-authenticate-service-principal.md#create-service-principal-with-password)的文档。 还可以[通过 Azure 门户创建服务主体](../azure-resource-manager/resource-group-create-service-principal-portal.md)。\r \r ```PowerShell\r $subscriptionId = \"{azure-subscription-id}\"\r $resourceGroupName = \"{resource-group-name}\"\r $location = \"chinaeast\"\r \r # Authenticate to a specific Azure subscription.\r Login-AzureRmAccount -SubscriptionId $subscriptionId\r \r # Password for the service principal\r $pwd = \"{service-principal-password}\"\r \r # Create a new Azure AD application\r $azureAdApplication = New-AzureRmADApplication `\r                         -DisplayName \"My Azure Monitor\" `\r                         -HomePage \"https://localhost/azure-monitor\" `\r                         -IdentifierUris \"https://localhost/azure-monitor\" `\r                         -Password $pwd\r \r # Create a new service principal associated with the designated application\r New-AzureRmADServicePrincipal -ApplicationId $azureAdApplication.ApplicationId\r \r # Assign Reader role to the newly created service principal\r New-AzureRmRoleAssignment -RoleDefinitionName Reader `\r                           -ServicePrincipalName $azureAdApplication.ApplicationId.Guid\r \r ```\r \r 若要查询 Azure 监视器 API，客户端应用程序应使用事先创建的服务主体进行身份验证。 以下示例 PowerShell 脚本演示了一种使用 Active Directory 身份验证库 (ADAL) 来获取 JWT 身份验证令牌的方法。 JWT 令牌作为请求中 HTTP 授权参数的一部分传递给 Azure Monitor REST API。\r \r ```PowerShell\r $azureAdApplication = Get-AzureRmADApplication -IdentifierUri \"https://localhost/azure-monitor\"\r \r $subscription = Get-AzureRmSubscription -SubscriptionId $subscriptionId\r \r $clientId = $azureAdApplication.ApplicationId.Guid\r $tenantId = $subscription.TenantId\r $authUrl = \"https://login.chinacloudapi.cn/${tenantId}\"\r \r $AuthContext = [Microsoft.IdentityModel.Clients.ActiveDirectory.AuthenticationContext]$authUrl\r $cred = New-Object -TypeName Microsoft.IdentityModel.Clients.ActiveDirectory.ClientCredential -ArgumentList ($clientId, $pwd)\r \r $result = $AuthContext.AcquireToken(\"https://management.core.chinacloudapi.cn/\", $cred)\r \r # Build an array of HTTP header values\r $authHeader = @{\r 'Content-Type'='application/json'\r 'Accept'='application/json'\r 'Authorization'=$result.CreateAuthorizationHeader()\r }\r ```\r \r 进行身份验证后，可以针对 Azure Monitor REST API 执行查询。 有两个有用的查询：\r \r 1. 列出资源的指标定义\r 2. 检索指标值\r \r ## <a name=\"retrieve-metric-definitions-multi-dimensional-api\"></a>检索指标定义（多维 API）\r \r 使用[Azure 监视器指标定义 REST API](https://docs.microsoft.com/en-us/rest/api/monitor/metricdefinitions)访问服务可用的指标列表。\r \r **方法**：GET\r \r **请求 URI**：https://management.azure.cn/subscriptions/*{subscriptionId}*/resourceGroups/*{resourceGroupName}*/providers/*{resourceProviderNamespace}*/*{resourceType}*/*{resourceName*/providers/microsoft.insights/metricDefinitions?api-version=*{apiVersion}*\r \r 例如，若要检索 Azure 存储帐户的指标定义，请求将如下所示：\r \r ```PowerShell\r $request = \"https://management.azure.cn/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/microsoft.insights/metricDefinitions?api-version=2017-05-01-preview\"\r \r Invoke-RestMethod -Uri $request `\r                   -Headers $authHeader `\r                   -Method Get `\r                   -OutFile \".\\contosostorage-metricdef-results.json\" `\r                   -Verbose\r \r ```\r > [!NOTE]\r > 若要使用多维 Azure Monitor 指标 REST API 检索指标定义，请使用“2017-05-01-preview”作为 API 版本。\r >\r >\r \r 生成的 JSON 响应正文将类似于以下示例：（请注意，第二个指标具有维）\r \r ```JSON\r {\r     \"value\": [\r         {\r             \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/microsoft.insights/metricdefinitions/UsedCapacity\",\r             \"resourceId\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage\",\r             \"category\": \"Capacity\",\r             \"name\": {\r                 \"value\": \"UsedCapacity\",\r                 \"localizedValue\": \"Used capacity\"\r             },\r             \"isDimensionRequired\": false,\r             \"unit\": \"Bytes\",\r             \"primaryAggregationType\": \"Average\",\r             \"metricAvailabilities\": [\r                 {\r                     \"timeGrain\": \"PT1M\",\r                     \"retention\": \"P30D\"\r                 },\r                 {\r                     \"timeGrain\": \"PT1H\",\r                     \"retention\": \"P30D\"\r                 }\r             ]\r         },\r         {\r             \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/microsoft.insights/metricdefinitions/Transactions\",\r             \"resourceId\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage\",\r             \"category\": \"Transaction\",\r             \"name\": {\r                 \"value\": \"Transactions\",\r                 \"localizedValue\": \"Transactions\"\r             },\r             \"isDimensionRequired\": false,\r             \"unit\": \"Count\",\r             \"primaryAggregationType\": \"Total\",\r             \"metricAvailabilities\": [\r                 {\r                     \"timeGrain\": \"PT1M\",\r                     \"retention\": \"P30D\"\r                 },\r                 {\r                     \"timeGrain\": \"PT1H\",\r                     \"retention\": \"P30D\"\r                 }\r             ],\r             \"dimensions\": [\r                 {\r                     \"value\": \"ResponseType\",\r                     \"localizedValue\": \"Response type\"\r                 },\r                 {\r                     \"value\": \"GeoType\",\r                     \"localizedValue\": \"Geo type\"\r                 },\r                 {\r                     \"value\": \"ApiName\",\r                     \"localizedValue\": \"API name\"\r                 }\r             ]\r         },\r         ...\r     ]\r }\r ```\r \r ## <a name=\"retrieve-dimension-values-multi-dimensional-api\"></a>检索维值（多维 API）\r 了解可用的指标定义后，可能会发现一些指标具有多个维。 在查询指标前，可能需要查明某个维具有的值的范围。 然后，根据这些维值，在查询指标时，可以选择根据维值对指标进行筛选或分段。 将指标的名称“value”（而不是“localizedValue”）用于任何筛选请求（例如，检索“CpuTime”和“Requests”指标数据点）。 如果未指定筛选器，则返回默认指标。\r \r > [!NOTE]\r > 若要使用 Azure Monitor REST API 检索维值，请使用“2017-05-01-preview”作为 API 版本。\r >\r >\r \r **方法**：GET\r \r **请求 URI**：https://management.azure.cn/subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/*{resource-provider-namespace}*/*{resource-type}*/*{resource-name}*/providers/microsoft.insights/metrics?metric=*{metric}*&timespan=*{starttime/endtime}*&$filter=*{filter}*&resultType=metadata&api-version=*{apiVersion}*\r \r 例如，若要检索“Transactions”指标的“API Name 维”在给定时间范围内的可能值的列表，请求将如下所示：\r \r ```PowerShell\r $filter = \"APIName eq '*'\"\r $request = \"https://management.azure.cn/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/microsoft.insights/metrics?metric=Transactions&timespan=2017-09-01T00:00:00Z/2017-09-10T00:00:00Z&resultType=metadata&$filter=${filter}&api-version=2017-05-01-preview\"\r Invoke-RestMethod -Uri $request `\r     -Headers $authHeader `\r     -Method Get `\r     -OutFile \".\\contosostorage-dimension-values.json\" `\r     -Verbose\r ```\r 生成的 JSON 响应正文将类似于以下示例：\r \r ```JSON\r {\r   \"timespan\": \"2017-09-01T00:00:00Z/2017-09-10T00:00:00Z\",\r   \"value\": [\r     {\r       \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/Microsoft.Insights/metrics/Transactions\",\r       \"type\": \"Microsoft.Insights/metrics\",\r       \"name\": {\r         \"value\": \"Transactions\",\r         \"localizedValue\": \"Transactions\"\r       },\r       \"unit\": \"Count\",\r       \"timeseries\": [\r         {\r           \"metadatavalues\": [\r             {\r               \"name\": {\r                 \"value\": \"apiname\",\r                 \"localizedValue\": \"apiname\"\r               },\r               \"value\": \"DeleteBlob\"\r             }\r           ]\r         },\r         {\r           \"metadatavalues\": [\r             {\r               \"name\": {\r                 \"value\": \"apiname\",\r                 \"localizedValue\": \"apiname\"\r               },\r               \"value\": \"SetBlobProperties\"\r             }\r           ]\r         },\r         {\r           \"metadatavalues\": [\r             {\r               \"name\": {\r                 \"value\": \"apiname\",\r                 \"localizedValue\": \"apiname\"\r               },\r               \"value\": \"PutPage\"\r             }\r           ]\r         },\r         {\r           \"metadatavalues\": [\r             {\r               \"name\": {\r                 \"value\": \"apiname\",\r                 \"localizedValue\": \"apiname\"\r               },\r               \"value\": \"Unknown\"\r             }\r           ]\r         },\r         ...\r       ]    \r     }\r   ]\r }\r ```\r \r ## <a name=\"retrieve-metric-values-multi-dimensional-api\"></a>检索指标值（多维 API）\r 知道可用的指标定义和可能的维值后，即可检索相关的指标值。 对于任何筛选请求，请使用指标的名称“value”（而非“localizedValue”）。 如果未指定维筛选器，则会返回汇总的聚合指标。\r \r > [!NOTE]\r > 若要使用 Azure Monitor REST API 检索多维指标值，请使用“2017-05-01-preview”作为 API 版本。\r >\r >\r \r **方法**：GET\r \r **请求 URI**：https://management.azure.cn/subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/*{resource-provider-namespace}*/*{resource-type}*/*{resource-name}*/providers/microsoft.insights/metrics?metric=*{metric}*&timespan=*{starttime/endtime}*&$filter=*{filter}*&interval=*{timeGrain}*&aggregation=*{aggreation}*&api-version=*{apiVersion}*\r \r 例如，若要针对 API 名称“GetBlobProperties”的所有事务处理检索存储“Transactions”指标在 5 分钟范围内的指标值，请求将如下所示：\r \r ```PowerShell\r $filter = \"APIName eq 'GetBlobProperties'\"\r $request = \"https://management.azure.cn/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/microsoft.insights/metrics?metric=Transactions&timespan=2017-09-19T02:00:00Z/2017-09-19T02:05:00Z&$filter=${filter}&interval=PT1M&aggregation=Count&api-version=2017-05-01-preview\"\r Invoke-RestMethod -Uri $request `\r                   -Headers $authHeader `\r                   -Method Get `\r     -OutFile \".\\contosostorage-metric-values.json\" `\r                   -Verbose\r ```\r 生成的 JSON 响应正文将类似于以下示例：\r \r ```JSON\r {\r   \"cost\": 0,\r   \"timespan\": \"2017-09-19T02:00:00Z/2017-09-19T02:05:00Z\",\r   \"interval\": \"PT1M\",\r   \"value\": [\r     {\r       \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/accounts/ContosoStorage/providers/Microsoft.Insights/metrics/Transactions\",\r       \"type\": \"Microsoft.Insights/metrics\",\r       \"name\": {\r         \"value\": \"Transactions\",\r         \"localizedValue\": \"Transactions\"\r       },\r       \"unit\": \"Count\",\r       \"timeseries\": [\r         {\r           \"metadatavalues\": [\r             {\r               \"name\": {\r                 \"value\": \"apiname\",\r                 \"localizedValue\": \"apiname\"\r               },\r               \"value\": \"GetBlobProperties\"\r             }\r           ],\r           \"data\": [\r             {\r               \"timeStamp\": \"2017-09-19T02:00:00Z\",\r               \"count\": 2.0\r             },\r             {\r               \"timeStamp\": \"2017-09-19T02:01:00Z\",\r               \"count\": 1.0\r             },\r             {\r               \"timeStamp\": \"2017-09-19T02:02:00Z\",\r               \"count\": 3.0\r             },\r             {\r               \"timeStamp\": \"2017-09-19T02:03:00Z\",\r               \"count\": 7.0\r             },\r             {\r               \"timeStamp\": \"2017-09-19T02:04:00Z\",\r               \"count\": 2.0\r             }\r           ]\r         }\r       ]\r     }\r   ]\r }\r ```\r \r ## <a name=\"retrieve-metric-definitions\"></a>检索指标定义\r 使用 [Azure Monitor 指标定义 REST API](https://msdn.microsoft.com/library/mt743621.aspx) 可以访问服务可用的指标列表。\r \r **方法**：GET\r \r **请求 URI**：https://management.azure.cn/subscriptions/*{subscriptionId}*/resourceGroups/*{resourceGroupName}*/providers/*{resourceProviderNamespace}*/*{resourceType}*/*{resourceName}*/providers/microsoft.insights/metricDefinitions?api-version=*{apiVersion}*\r \r 例如，若要检索给定时间范围内时间粒度为 1 小时的 RunsSucceeded 指标数据点，请求将如下所示：\r \r ```PowerShell\r $apiVersion = \"2016-06-01\"\r $filter = \"(name.value eq 'RunsSucceeded') and aggregationType eq 'Total' and startTime eq 2016-09-23 and endTime eq 2016-09-24 and timeGrain eq duration'PT1H'\"\r $request = \"https://management.azure.cn/subscriptions/${subscriptionId}/resourceGroups/${resourceGroupName}/providers/${resourceProviderNamespace}/${resourceType}/${resourceName}/providers/microsoft.insights/metrics?`$filter=${filter}&api-version=${apiVersion}\"\r (Invoke-RestMethod -Uri $request `\r                    -Headers $authHeader `\r                    -Method Get `\r                    -Verbose).Value | ConvertTo-Json\r ```\r \r 生成的 JSON 响应正文将类似于以下示例：\r \r ```JSON\r {\r   \"value\": [\r     {\r       \"data\": [\r         {\r           \"timeStamp\": \"2017-08-18T19:00:00Z\",\r           \"total\": 0.0\r         },\r         {\r           \"timeStamp\": \"2017-08-18T20:00:00Z\",\r           \"total\": 159.0\r         },\r         {\r           \"timeStamp\": \"2017-08-18T21:00:00Z\",\r           \"total\": 174.0\r         },\r         {\r           \"timeStamp\": \"2017-08-18T22:00:00Z\",\r           \"total\": 97.0\r         }\r       ],\r       \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Logic/workflows/ContosoTweets/providers/Microsoft.Insights/metrics/RunsSucceeded\",\r       \"name\": {\r         \"value\": \"RunsSucceeded\",\r         \"localizedValue\": \"Runs Succeeded\"\r       },\r       \"type\": \"Microsoft.Insights/metrics\",\r       \"unit\": \"Count\"\r     }\r   ]\r }\r ```\r \r 要检索多个数据点或聚合点，请将指标定义名称和聚合类型添加到筛选器，如以下示例中所示：\r \r ```PowerShell\r $filter = \"(name.value eq 'ActionsCompleted' or name.value eq 'RunsSucceeded') and (aggregationType eq 'Total' or aggregationType eq 'Average') and startTime eq 2017-08-18T21:00:00 and endTime eq 2017-08-18T21:30:00 and timeGrain eq duration'PT1M'\"\r $request = \"https://management.azure.cn/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Logic/workflows/ContosoTweets/providers/microsoft.insights/metrics?$filter=${filter}&api-version=2016-09-01\"\r Invoke-RestMethod -Uri $request `\r     -Headers $authHeader `\r     -Method Get `\r     -OutFile \".\\contostweets-metrics-multiple-results.json\" `\r     -Verbose\r ```\r \r 生成的 JSON 响应正文将类似于以下示例：\r \r ```JSON\r {\r   \"value\": [\r     {\r       \"data\": [\r         {\r           \"timeStamp\": \"2017-08-18T21:03:00Z\",\r           \"total\": 5.0,\r           \"average\": 1.0\r         },\r         {\r           \"timeStamp\": \"2017-08-18T21:04:00Z\",\r           \"total\": 7.0,\r           \"average\": 1.0\r         }\r       ],\r       \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Logic/workflows/ContosoTweets/providers/Microsoft.Insights/metrics/ActionsCompleted\",\r       \"name\": {\r         \"value\": \"ActionsCompleted\",\r         \"localizedValue\": \"Actions Completed \"\r       },\r       \"type\": \"Microsoft.Insights/metrics\",\r       \"unit\": \"Count\"\r     },\r     {\r       \"data\": [\r         {\r           \"timeStamp\": \"2017-08-18T21:03:00Z\",\r           \"total\": 5.0,\r           \"average\": 1.0\r         },\r         {\r           \"timeStamp\": \"2017-08-18T21:04:00Z\",\r           \"total\": 7.0,\r           \"average\": 1.0\r         }\r       ],\r       \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Logic/workflows/ContosoTweets/providers/Microsoft.Insights/metrics/RunsSucceeded\",\r       \"name\": {\r         \"value\": \"RunsSucceeded\",\r         \"localizedValue\": \"Runs Succeeded\"\r       },\r       \"type\": \"Microsoft.Insights/metrics\",\r       \"unit\": \"Count\"\r     }\r   ]\r }\r ```\r \r ### <a name=\"use-armclient\"></a>使用 ARMClient\r 另一种方法是使用 Windows 计算机上的 [ARMClient](https://github.com/projectkudu/armclient)。 ARMClient 将自动处理 Azure AD 身份验证（及生成的 JWT 令牌）。 以下步骤概述如何使用 ARMClient 检索指标数据：\r \r 1. 安装 [Chocolatey](https://chocolatey.org/) 和 [ARMClient](https://github.com/projectkudu/armclient)。\r 2. 在终端窗口中，键入 *armclient.exe login*。 这样做会提示登录到 Azure。\r 3. 键入 *armclient GET [your_resource_id]/providers/microsoft.insights/metricdefinitions?api-version=2016-03-01*\r 4. 键入 *armclient GET [your_resource_id]/providers/microsoft.insights/metrics?api-version=2016-09-01*\r \r \r \r ## <a name=\"retrieve-the-resource-id\"></a>检索资源 ID\r 使用 REST API 确实有助于了解可用的指标定义、粒度和相关值。 使用 [Azure 管理库](https://msdn.microsoft.com/library/azure/mt417623.aspx)时，这些信息很有用。\r \r 对于上述代码，要使用的资源 ID 是所需 Azure 资源的完整路径。 例如，要针对某个 Azure Web 应用执行查询，资源 ID 将是：\r \r */subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{site-name}/*\r \r 以下列表包含各种 Azure 资源的几个资源 ID 格式示例：\r \r * **IoT 中心** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.Devices/IotHubs/*{iot-hub-name}*\r * **SQL 弹性池** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.Sql/servers/*{pool-db}*/elasticpools/*{sql-pool-name}*\r * **SQL 数据库 (v12)** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.Sql/servers/*{server-name}*/databases/*{database-name}*\r * **服务总线** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.ServiceBus/*{namespace}*/*{servicebus-name}*\r * **虚拟机规模集** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.Compute/virtualMachineScaleSets/*{vm-name}*\r * **VM** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.Compute/virtualMachines/*{vm-name}*\r * **事件中心** - /subscriptions/*{subscription-id}*/resourceGroups/*{resource-group-name}*/providers/Microsoft.EventHub/namespaces/*{eventhub-namespace}*\r \r 还可以通过其他方法检索资源 ID，包括通过 Azure 门户、PowerShell 或 Azure CLI 查看所需的资源。\r \r ### <a name=\"azure-portal\"></a>Azure 门户\r 还可以从 Azure 门户获取资源 ID。 为此，请导航到所需的资源，并选择“属性”。 资源 ID 将显示在“属性”部分中，如以下屏幕截图中所示：\r \r ![Alt \"Azure 门户的“属性”边栏选项卡中显示的资源 ID\"](./media/monitoring-rest-api-walkthrough/resourceid_azure_portal.png)\r \r ### <a name=\"azure-powershell\"></a>Azure PowerShell\r 也可以使用 Azure PowerShell cmdlet 检索资源 ID。 例如，若要获取某个 Azure Web 应用的资源 ID，请执行 Get-AzureRmWebApp cmdlet，如以下屏幕截图中所示：\r \r ![Alt \"通过 PowerShell 获取资源 ID\"](./media/monitoring-rest-api-walkthrough/resourceid_powershell.png)\r \r ### <a name=\"azure-cli\"></a>Azure CLI\r 若要使用 Azure CLI 检索某个 Azure 存储帐户的资源 ID，请执行“az storage account show”命令，如以下示例中所示：\r \r ```\r az storage account show -g azmon-rest-api-walkthrough -n contosotweets2017\r ```\r \r 结果应类似于以下示例：\r ```JSON\r {\r   \"accessTier\": null,\r   \"creationTime\": \"2017-08-18T19:58:41.840552+00:00\",\r   \"customDomain\": null,\r   \"enableHttpsTrafficOnly\": false,\r   \"encryption\": null,\r   \"id\": \"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/azmon-rest-api-walkthrough/providers/Microsoft.Storage/storageAccounts/contosotweets2017\",\r   \"identity\": null,\r   \"kind\": \"Storage\",\r   \"lastGeoFailoverTime\": null,\r   \"location\": \"centralus\",\r   \"name\": \"contosotweets2017\",\r   \"networkAcls\": null,\r   \"primaryEndpoints\": {\r     \"blob\": \"https://contosotweets2017.blob.core.windows.net/\",\r     \"file\": \"https://contosotweets2017.file.core.windows.net/\",\r     \"queue\": \"https://contosotweets2017.queue.core.windows.net/\",\r     \"table\": \"https://contosotweets2017.table.core.windows.net/\"\r   },\r   \"primaryLocation\": \"centralus\",\r   \"provisioningState\": \"Succeeded\",\r   \"resourceGroup\": \"azmon-rest-api-walkthrough\",\r   \"secondaryEndpoints\": null,\r   \"secondaryLocation\": \"eastus2\",\r   \"sku\": {\r     \"name\": \"Standard_GRS\",\r     \"tier\": \"Standard\"\r   },\r   \"statusOfPrimary\": \"available\",\r   \"statusOfSecondary\": \"available\",\r   \"tags\": {},\r   \"type\": \"Microsoft.Storage/storageAccounts\"\r }\r ```\r \r \r ## <a name=\"retrieve-activity-log-data\"></a>检索活动日志数据\r 除了指标定义和相关值以外，还可以使用 Azure Monitor REST API 检索有关 Azure 资源的其他需关注的深入信息。 例如，可查询[活动日志](https://msdn.microsoft.com/library/azure/dn931934.aspx)数据。 以下示例演示如何使用 Azure 监视器 REST API 查询 Azure 订阅在特定日期范围内的活动日志数据：\r \r ```PowerShell\r $apiVersion = \"2015-04-01\"\r $filter = \"eventTimestamp ge '2017-08-18' and eventTimestamp le '2017-08-19'and eventChannels eq 'Admin, Operation'\"\r $request = \"https://management.azure.cn/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/providers/microsoft.insights/eventtypes/management/values?api-version=${apiVersion}&$filter=${filter}\"\r Invoke-RestMethod -Uri $request `\r     -Headers $authHeader `\r     -Method Get `\r     -Verbose\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r * 查看[监视概述](monitoring-overview.md)。\r * 查看 [Azure 监视器支持的指标](monitoring-supported-metrics.md)。\r * 查看 [Microsoft Azure 监视器 REST API 参考](https://msdn.microsoft.com/library/azure/dn931943.aspx)。\r * 查看 [Azure 管理库](https://msdn.microsoft.com/library/azure/mt417623.aspx)。\r \r \r <!--Update_Description:update meta properties and wording-->"}