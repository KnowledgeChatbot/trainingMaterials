{"Title":"如何将同一云服务下的虚拟机从经典部署模型迁移到 Azure Resource Manager","Description":"如何将同一云服务下的虚拟机从经典部署模型迁移到 Azure Resource Manager","Content":"# 如何将同一云服务下的虚拟机从经典部署模型迁移到 Azure Resource Manager\r \r ## 适用场景\r \r 用户希望将特定云服务下的所有虚拟机从经典部署模型(以下简称：ASM)迁移到 Azure Resource Manager(以下简称：ARM)。\r \r > [!NOTE]\r > 如果云服务下使用 VNET 也希望将虚拟机从 ASM 模式迁移到 ARM 模式，您可以参考这篇文章：[如何将同一个 VNET 下的虚拟机从 ASM 迁移到 ARM 上](aog-virtual-machines-howto-migrate-from-asm-to-arm-within-same-vnet.md)\r \r ## 解决方案\r \r \r 1.\t首先，我们登陆到需要迁移的虚拟机所在的订阅下，注册迁移服务：\r \r     ```PowerShell\r     #登陆到需要迁移的虚拟机所在的订阅下\r     PS C:\\windows\\system32> Login-AzureRmAccount –Environment AzureChinaCloud\r \r     Environment           : AzureChinaCloud\r     Account               : XXX@mcpod.partner.onmschina.cn\r     TenantId              : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r     SubscriptionId        : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r     SubscriptionName      : <订阅名称>\r     CurrentStorageAccount :\r \r     #如果您需要迁移某个特定订阅下的虚拟机，需要手动进行指定\r     PS C:\\windows\\system32> Select-AzureRmSubscription –SubscriptionName \"<订阅名称>\"\r \r     #注册迁移服务\r     PS C:\\windows\\system32> Register-AzureRmResourceProvider -ProviderNamespace Microsoft.ClassicInfrastructureMigrate\r \r     #迁移服务注册一般需要 5 分钟左右，您可以通过下述命令查看完成情况，\r     PS C:\\windows\\system32> Get-AzureRmResourceProvider -ProviderNamespace Microsoft.ClassicInfrastructureMigrate\r \r     ProviderNamespace : Microsoft.ClassicInfrastructureMigrate\r     RegistrationState : Registered\r     ResourceTypes     : {classicInfrastructureResources}\r     Locations         : {China North, China East}\r \r     #最后登陆到经典模式中需要迁移的虚拟机所在订阅下\r     PS C:\\windows\\system32> Add-AzureAccount -Environment AzureChinaCloud\r \r     Id                                Type Subscriptions                        Tenants\r     --                                ---- -------------                        -------\r     XXX@mcpod.partner.onmschina.cn User xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx { xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx }\r \r     #如果您需要迁移某个特定订阅下的虚拟机，需要手动进行指定\r     Select-AzureSubscription –SubscriptionName \"<订阅名称>\"\r     ```\r \r     > [!NOTE]\r     > 注册迁移服务为一次性操作，注册完成后以后迁移时无需再次注册，但是如果您在未注册前尝试迁移，会收到报错说该订阅未注册迁移服务。\r \r 2.\t检查 ARM 模式下您订阅里的配额，确保需要迁移的虚拟机有足够的配额可以使用：\r \r     ```PowerShell\r     #您可以根据虚拟机所在的区域选择 China North 或者 China East\r     PS C:\\windows\\system32> Get-AzureRmVMUsage -Location \"China East\"\r \r     Name                             Current Value Limit  Unit\r     ----                             ------------- -----  ----\r     Availability Sets                            2  2000 Count\r     Total Regional Cores                        39   100 Count\r     Virtual Machines                            17 10000 Count\r     Virtual Machine Scale Sets                   1  2000 Count\r     Standard Dv2 Family Cores                    4   100 Count\r     Standard FS Family Cores                    16   100 Count\r     Standard A0-A7 Family Cores                 11   100 Count\r     Standard D Family Cores                      1   100 Count\r     Standard Av2 Family Cores                    2   100 Count\r     Standard DSv2 Family Cores                   4   100 Count\r     Standard DS Family Cores                     1   100 Count\r     Basic A Family Cores                         0   100 Count\r     Standard A8-A11 Family Cores                 0   100 Count\r     Standard G Family Cores                      0   100 Count\r     Standard GS Family Cores                     0   100 Count\r     Standard F Family Cores                      0   100 Count\r     Standard NV Family Cores                     0     0 Count\r     Standard NC Family Cores                     0     0 Count\r     Standard H Family Cores                      0     0 Count\r     Standard LS Family Cores                     0   100 Count\r     Standard Dv2 Promo Family Cores              0   100 Count\r     Standard DSv2 Promo Family Cores             0   100 Count\r     Standard MS Family Cores                     0     0 Count\r     Standard Dv3 Family Cores                    0   100 Count\r     Standard DSv3 Family Cores                   0   100 Count\r     Standard Ev3 Family Cores                    0   100 Count\r     Standard ESv3 Family Cores                   0   100 Count\r     Standard Storage Managed Disks               0 10000 Count\r     Premium Storage Managed Disks                0 10000 Count\r     ```\r \r 3.\t将同一个云服务下的虚拟机从 ASM 迁移到 ARM 上:\r \r     ```PowerShell\r     #查询云服务并找出您想要迁移的云服务，此处以 1vnet2cs02 为例\r     PS C:\\windows\\system32> Get-AzureService|ft Servicename\r \r     ServiceName\r     -----------\r     1vent2cs04\r     1vnet2cs01\r     1vnet2cs02\r     1vnet2cs03\r \r     #获取部署名称\r     PS C:\\windows\\system32> $serviceName = \"1vnet2cs02\"\r     PS C:\\windows\\system32> $deployment = Get-AzureDeployment -ServiceName $serviceName\r     PS C:\\windows\\system32> $deploymentName = $deployment.DeploymentName\r     Result             : Validation Passed with warnings. Please see ValidationMessages object for a list of resources\r                         that will be migrated and additional detail on the warnings.\r     ValidationMessages : {test4as, test01, test01, test01...} \r     ```\r \r     - 选择 1：将 VM 迁移到一个新建的虚拟网络中:\r \r         ```PowerShell\r         #验证云服务\r         PS C:\\windows\\system32> Move-AzureService -Validate -ServiceName $serviceName ` -DeploymentName $deploymentName -CreateNewVirtualNetwork\r \r         OperationId        : 119a8709-4160-4122-859d-a1bc2dc8c603\r         Result             : Validation Passed. Please see ValidationMessages object for a list of resources that will be migrated.\r         ValidationMessages : {cs03, cs03, cs03}\r \r         #上述验证通过后接下来执行迁移准备操作\r         PS C:\\windows\\system32> Move-AzureService -Prepare -ServiceName $serviceName `\r         >>     -DeploymentName $deploymentName -CreateNewVirtualNetwork\r \r         OperationDescription OperationId                          OperationStatus\r         -------------------- -----------                          ---------------\r         Move-AzureService    7a6931ef-6f42-47dc-8d99-0929fbdc5658 Succeeded\r \r         #如果迁移准备步骤操作成功，那么可以执行下述命令来生效迁移操作\r         PS C:\\windows\\system32> Move-AzureService -Commit -ServiceName $serviceName -DeploymentName $deploymentName\r \r         OperationDescription OperationId                          OperationStatus\r         -------------------- -----------                          ---------------\r         Move-AzureService    e88c11c0-21d4-46c0-abb0-700c324b21ba Succeeded\r         ```\r \r     - 选择 2：将 VM 迁移到一个已有的虚拟网络中:\r  \r         ```PowerShell\r         #准备已有虚拟网络的相关信息\r         PS C:\\windows\\system32> $existingVnetRGName = \"<虚拟网络所在的资源组名称>\"\r         PS C:\\windows\\system32> $vnetName = \"<虚拟网络名称>\"\r         PS C:\\windows\\system32> $subnetName = \"<子网名称>\"\r \r         #验证云服务\r         PS C:\\windows\\system32> Move-AzureService -Validate -ServiceName $serviceName `\r         >>     -DeploymentName $deploymentName -UseExistingVirtualNetwork -VirtualNetworkResourceGroupName $existingVnetRGName -VirtualNetworkName $vnetName -SubnetName $subnetName\r \r         #上述验证通过后接下来执行迁移准备操作\r         PS C:\\windows\\system32> Move-AzureService -Prepare -ServiceName $serviceName -DeploymentName $deploymentName `\r         >>     -UseExistingVirtualNetwork -VirtualNetworkResourceGroupName $existingVnetRGName `\r         >>     -VirtualNetworkName $vnetName -SubnetName $subnetName\r \r         OperationDescription OperationId                          OperationStatus\r         -------------------- -----------                          ---------------\r         Move-AzureService    9c9e01a6-183e-4884-b51d-04f25112934e Succeeded\r \r         #如果迁移准备步骤操作成功，那么可以执行下述命令来生效迁移操作\r         PS C:\\windows\\system32> Move-AzureService -Commit -ServiceName $serviceName -DeploymentName $deploymentName\r \r         OperationDescription OperationId                          OperationStatus\r         -------------------- -----------                          ---------------\r         Move-AzureService    c803cc0d-1446-4922-bcb1-af1330828c69 Succeeded\r         ```\r \r 4.\t迁移虚拟机所在的存储账号:\r \r     ```PowerShell\r     #检查存储账号下是否有未被迁移的虚拟机的 VHD 存在\r     PS C:\\windows\\system32> $storageAccountName =\"<存储账号名称>\"\r     PS C:\\windows\\system32> Get-AzureDisk | where-Object {$_.MediaLink.Host.Contains($storageAccountName)} | Select-Object -ExpandProperty AttachedTo -Property `\r     >>   DiskName | Format-List -Property RoleName, DiskName\r \r     #检查存储账号下是否有已分离的虚拟机磁盘，如有需要进行删除，如果您仍然需要这些磁盘可以将其复制到其他存储账号中\r     PS C:\\windows\\system32> Get-AzureDisk | where-Object {$_.MediaLink.Host.Contains($storageAccountName)} | Where-Object -Property AttachedTo -EQ $null | Format-List\r     -Property DiskName\r \r     DiskName : disktest\r \r     #删除磁盘\r     PS C:\\windows\\system32> Remove-AzureDisk -DiskName \"disktest\"\r \r     OperationDescription OperationId                          OperationStatus\r     -------------------- -----------                          ---------------\r     Remove-AzureDisk     9661659d-3bcf-4e6e-bdc4-cce7c8d7a1e0 Succeeded\r \r     #删除存储账号中 OS 盘和数据盘中的虚拟机镜像\r     PS C:\\windows\\system32> Get-AzureVmImage | Where-Object { $_.OSDiskConfiguration.MediaLink -ne $null -and $_.OSDiskConfiguration.MediaLink.Host.Contains($storageA\r     ccountName)`\r     >>                            } | Select-Object -Property ImageName, ImageLabel\r \r     ImageName                   ImageLabel\r     ---------                   ----------\r     captureTest-20160902-436096\r \r     PS C:\\windows\\system32> Get-AzureVmImage | Where-Object {$_.DataDiskConfigurations -ne $null `\r     >>                                     -and ($_.DataDiskConfigurations | Where-Object {$_.MediaLink -ne $null -and $_.MediaLink.Host.Contains($storageAccountName)\r     }).Count -gt 0 `\r     >>                                    } | Select-Object -Property ImageName, ImageLabel\r \r     PS C:\\windows\\system32> Remove-AzureVMImage -ImageName \"captureTest-20160902-436096\"\r \r     OperationDescription OperationId                          OperationStatus\r     -------------------- -----------                          ---------------\r     Remove-AzureVMImage  b8f1c164-147a-4d98-9805-432dcd3b7105 Succeeded\r \r \r     #验证存储账号是否符合迁移条件\r     PS C:\\windows\\system32> Move-AzureStorageAccount -Validate -StorageAccountName $storageAccountName\r \r     OperationId        : 68f3501e-f965-4732-aae5-a1da5b58103b\r     Result             : Validation Passed. Please see ValidationMessages object for a list of resources that will be migrated.\r     ValidationMessages : {<存储账号名称>}\r \r     PS C:\\windows\\system32> $val=Move-AzureStorageAccount -Validate -StorageAccountName $storageAccountName\r     PS C:\\windows\\system32> $val.ValidationMessages\r \r     ResourceType       : Storage\r     ResourceName       : <存储账号名称>\r     Category           : Information\r     Message            : Storage Account tcportalvhdsgrnnb3k173zr is eligible for migration.\r     VirtualMachineName :\r \r     #上述验证通过后接下来执行迁移准备操作\r     PS C:\\windows\\system32> Move-AzureStorageAccount -Prepare -StorageAccountName $storageAccountName\r \r     OperationDescription     OperationId                          OperationStatus\r     --------------------     -----------                          ---------------\r     Move-AzureStorageAccount 4086a517-a14a-4360-97aa-2714543dd345 Succeeded\r \r     #如果在迁移准备操作中出现了报错，或者您想取消本次迁移操作，可以使用下面命令进行取消\r \r     PS C:\\windows\\system32> Move-AzureStorageAccount -Abort -StorageAccountName $storageAccountName\r \r     OperationDescription     OperationId                          OperationStatus\r     --------------------     -----------                          ---------------\r     Move-AzureStorageAccount 8473i405-b3fg-7942-345h-8236hdy63i2f Succeeded\r \r     #如果迁移准备步骤操作成功，那么可以执行下述命令来生效迁移操作\r \r     PS C:\\windows\\system32> Move-AzureStorageAccount -Commit -StorageAccountName $storageAccountName\r \r     OperationDescription     OperationId                          OperationStatus\r     --------------------     -----------                          ---------------\r     Move-AzureStorageAccount cf4e80b3-8e26-4d65-96f2-98dda2266d49 Succeeded\r     ```"}