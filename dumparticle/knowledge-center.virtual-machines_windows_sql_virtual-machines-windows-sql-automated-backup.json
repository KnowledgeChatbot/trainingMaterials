{"Title":"SQL Server 2014 虚拟机的自动备份 (Resource Manager)","Description":"介绍适用于 Azure 中运行的 SQL Server 2014 VM 的自动备份功能。 本文仅适用于使用 Resource Manager 的 VM。","Content":"# <a name=\"automated-backup-for-sql-server-2014-virtual-machines-resource-manager\"></a>SQL Server 2014 虚拟机的自动备份 (Resource Manager)\r \r 自动备份将在运行 SQL Server 2014 Standard 或 Enterprise 的 Azure VM 上自动为所有现有数据库和新数据库配置[托管备份到 Azure](https://msdn.microsoft.com/library/dn449496.aspx)。 这样，便可以配置使用持久 Azure Blob 存储的定期数据库备份。 自动备份依赖于 [SQL Server IaaS 代理扩展](virtual-machines-windows-sql-server-agent-extension.md)。\r \r [!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]\r \r ## <a name=\"prerequisites\"></a>先决条件\r 若要使用自动备份，请考虑以下先决条件：\r \r **操作系统**：\r \r - Windows Server 2012\r - Windows Server 2012 R2\r - Windows Server 2016\r \r **SQL Server 版本**：\r \r - SQL Server 2014 Standard\r - SQL Server 2014 Enterprise\r \r **数据库配置**：\r \r - 目标数据库必须使用完整恢复模式。 有关对备份使用完整恢复模型产生的影响的详细信息，请参阅 [Backup Under the Full Recovery Model](https://technet.microsoft.com/library/ms190217.aspx)（使用完整恢复模型的备份）。\r - 目标数据库必须位于默认 SQL Server 实例上。 SQL Server IaaS 扩展不支持命名实例。\r \r **Azure 部署模型**：\r \r - Resource Manager\r \r **Azure PowerShell**：\r \r - 如果打算使用 PowerShell 配置自动备份，请[安装最新的 Azure PowerShell 命令](https://docs.microsoft.com/powershell/azure/overview)。\r \r > [!NOTE]\r > 自动备份依赖 SQL Server IaaS 代理扩展。 当前的 SQL 虚拟机库映像默认添加此扩展。 有关详细信息，请参阅 [SQL Server IaaS 代理扩展](virtual-machines-windows-sql-server-agent-extension.md)。\r \r ## <a name=\"settings\"></a>设置\r \r 下表描述了可为自动备份配置的选项。 实际配置步骤根据你使用的是 Azure 门户还是 Azure Windows PowerShell 命令而有所不同。\r \r | 设置 | 范围（默认值） | 说明 |\r | --- | --- | --- |\r | **自动备份** | 启用/禁用（已禁用） | 为运行 SQL Server 2014 Standard 或 Enterprise 的 Azure VM 启用或禁用自动备份。 |\r | **保留期** | 1-30 天（30 天） | 保留备份的天数。 |\r | **存储帐户** | Azure 存储帐户 | 用于在 Blob 存储中存储自动备份文件的 Azure 存储帐户。 会在此位置创建容器，用于存储所有备份文件。 备份文件命名约定包括日期、时间和计算机名称。 |\r | **加密** | 启用/禁用（已禁用） | 启用或禁用加密。 启用加密时，用于还原备份的证书会使用相同的命名约定存放在同一 `automaticbackup` 容器中的指定存储帐户内。 如果密码发生更改，则使用该密码生成新证书，但旧证书在备份之前仍会还原。 |\r | **密码** | 密码文本 | 加密密钥的密码。 仅当启用了加密时才需要此设置。 若要还原加密的备份，必须具有创建该备份时使用的正确密码和相关证书。 |\r \r ## <a name=\"configuration-in-the-portal\"></a>门户中的配置\r \r 可以在预配期间或针对现有的 SQL Server 2014 VM 使用 Azure 门户来配置自动备份。\r \r ### <a name=\"new-vms\"></a>新的 VM\r \r 在 Resource Manager 部署模型中创建新的 SQL Server 2014 虚拟机时，可以使用 Azure 门户配置自动备份。\r \r 在“SQL Server 设置”边栏选项卡中，选择“自动备份”。 下面的 Azure 门户屏幕截图显示了“SQL 自动备份”边栏选项卡。\r \r ![Azure 门户中的 SQL 自动备份配置](./media/virtual-machines-windows-sql-automated-backup/azure-sql-arm-autobackup.png)\r \r 若要了解上下文，请参阅有关[在 Azure 中预配 SQL Server 虚拟机](virtual-machines-windows-portal-sql-server-provision.md)的完整主题。\r \r ### <a name=\"existing-vms\"></a>现有 VM\r \r 对于现有的 SQL Server 虚拟机，请选择 SQL Server 虚拟机。 然后选择“设置”边栏选项卡的“SQL Server 配置”部分。\r \r ![现有 VM 的 SQL 自动备份](./media/virtual-machines-windows-sql-automated-backup/azure-sql-rm-autobackup-existing-vms.png)\r \r 在“SQL Server 配置”边栏选项卡的“自动备份”部分，单击“编辑”按钮。\r \r ![为现有 VM 配置 SQL 自动备份](./media/virtual-machines-windows-sql-automated-backup/azure-sql-rm-autobackup-configuration.png)\r \r 完成后，单击“SQL Server 配置”边栏选项卡底部的“确定”按钮保存更改。\r \r 首次启用自动备份时，Azure 会在后台配置 SQL Server IaaS 代理。 在此期间，Azure 门户可能不会显示自动备份已配置。 请等待几分钟，以便安装和配置代理。 之后，Azure 门户将反映新设置。\r \r > [!NOTE]\r > 也可以使用模板来配置自动备份。 有关详细信息，请参阅 [Azure quickstart template for Automated Backup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vm-sql-existing-autobackup-update)（用于自动备份的 Azure 快速入门模板）。\r \r ## <a name=\"configuration-with-powershell\"></a>使用 PowerShell 进行配置\r \r 可使用 PowerShell 配置自动备份。 开始之前，必须：\r \r - [下载并安装最新的 Azure PowerShell](http://aka.ms/webpi-azps)。\r - 打开 Windows PowerShell 并将其关联到帐户。 可以遵循预配主题的[配置订阅](/virtual-machines/windows/sql/virtual-machines-windows-ps-sql-create#configure-your-subscription)部分中的步骤执行此操作。\r \r ### <a name=\"install-the-sql-iaas-extension\"></a>安装 SQL IaaS 扩展\r 如果通过 Azure 门户预配了 SQL Server 虚拟机，应已安装 SQL Server IaaS 扩展。 可通过调用 **Get-AzureRmVM** 命令并检查 **Extensions** 属性，来确定是否为 VM 安装了该扩展。\r \r ```powershell\r $vmname = \"vmname\"\r $resourcegroupname = \"resourcegroupname\"\r \r (Get-AzureRmVM -Name $vmname -ResourceGroupName $resourcegroupname).Extensions\r ```\r \r 如果已安装 SQL Server IaaS 代理扩展，应会看到列出的“SqlIaaSAgent”或“SQLIaaSExtension”。 **ProvisioningState** 应显示“Succeeded”。\r \r 如果未安装或未能预配该扩展，可使用以下命令来安装。 除了 VM 名称和资源组以外，还必须指定 VM 所在的区域 (**$region**)。\r \r ```powershell\r $region = \"EASTUS2\"\r Set-AzureRmVMSqlServerExtension -VMName $vmname `\r     -ResourceGroupName $resourcegroupname -Name \"SQLIaasExtension\" `\r     -Version \"1.2\" -Location $region\r ```\r \r ### <a id=\"verifysettings\"></a>验证当前设置\r \r 如果在预配期间启用了自动备份，可以使用 PowerShell 检查当前配置。 运行 **Get-AzureRmVMSqlServerExtension** 命令并检查 **AutoBackupSettings** 属性：\r \r ```powershell\r (Get-AzureRmVMSqlServerExtension -VMName $vmname -ResourceGroupName $resourcegroupname).AutoBackupSettings\r ```\r \r 应会看到类似于下面的输出：\r \r ```\r Enable                      : False\r EnableEncryption            : False\r RetentionPeriod             : -1\r StorageUrl                  : NOTSET\r StorageAccessKey            : \r Password                    : \r BackupSystemDbs             : False\r BackupScheduleType          : \r FullBackupFrequency         : \r FullBackupStartTime         : \r FullBackupWindowHours       : \r LogBackupFrequency          : \r ```\r \r 如果输出显示 **Enable** 设置为 **False**，则必须启用自动备份。 幸运的是，可通过相同的方式启用和配置自动备份。 有关信息，请参阅下一部分。\r \r > [!NOTE] \r > 如果在进行更改后立即检查设置，看到的可能是旧配置值。 请等待几分钟再检查设置，确保更改已应用。\r \r ### <a name=\"configure-automated-backup\"></a>配置自动备份\r 随时可以使用 PowerShell 来启用自动备份以及修改其配置和行为。\r \r 首先，为备份文件选择或创建存储帐户。 以下脚本选择一个存储帐户，或者创建一个存储帐户（如果不存在）。\r \r ```powershell\r $storage_accountname = \"yourstorageaccount\"\r $storage_resourcegroupname = $resourcegroupname\r \r $storage = Get-AzureRmStorageAccount -ResourceGroupName $resourcegroupname `\r     -Name $storage_accountname -ErrorAction SilentlyContinue\r If (-Not $storage)\r     { $storage = New-AzureRmStorageAccount -ResourceGroupName $storage_resourcegroupname `\r     -Name $storage_accountname -SkuName Standard_GRS -Location $region }\r ```\r \r > [!NOTE]\r > 自动备份不支持在高级存储中存储备份，但可以从使用高级存储的 VM 磁盘创建备份。\r \r 然后，使用 **New-AzureRmVMSqlServerAutoBackupConfig** 命令启用并配置自动备份设置，以便在 Azure 存储帐户中存储备份。 在本示例中，备份设置为保留 10 天。 第二个命令 **Set-AzureRmVMSqlServerExtension**使用这些设置更新指定的 Azure VM。\r \r ```powershell\r $autobackupconfig = New-AzureRmVMSqlServerAutoBackupConfig -Enable `\r     -RetentionPeriodInDays 10 -StorageContext $storage.Context `\r     -ResourceGroupName $storage_resourcegroupname\r \r Set-AzureRmVMSqlServerExtension -AutoBackupSettings $autobackupconfig `\r     -VMName $vmname -ResourceGroupName $resourcegroupname\r ```\r \r 可能需要花费几分钟来安装和配置 SQL Server IaaS 代理。\r \r > [!NOTE]\r > 还有仅适用于 SQL Server 2016 和自动备份 v2 的其他 **New-AzureRmVMSqlServerAutoBackupConfig** 设置。 SQL Server 2014 不支持以下设置：**BackupSystemDbs**、**BackupScheduleType**、**FullBackupFrequency**、**FullBackupStartHour**、**FullBackupWindowInHours** 和 **LogBackupFrequencyInMinutes**。 如果尝试在 SQL Server 2014 虚拟机上配置这些设置，则不存在错误，但不会应用这些设置。\r \r 要启用加密，请修改上述脚本，使其将 **EnableEncryption** 参数连同 **CertificatePassword** 参数的密码（安全字符串）一起传递。 以下脚本启用上一示例中的自动备份设置，并添加加密。\r \r ```powershell\r $password = \"P@ssw0rd\"\r $encryptionpassword = $password | ConvertTo-SecureString -AsPlainText -Force\r \r $autobackupconfig = New-AzureRmVMSqlServerAutoBackupConfig -Enable `\r     -EnableEncryption -CertificatePassword $encryptionpassword `\r     -RetentionPeriodInDays 10 -StorageContext $storage.Context `\r     -ResourceGroupName $storage_resourcegroupname\r \r Set-AzureRmVMSqlServerExtension -AutoBackupSettings $autobackupconfig `\r     -VMName $vmname -ResourceGroupName $resourcegroupname\r ```\r \r 若要确认是否应用了这些设置，请 [检查自动备份配置](#verifysettings)。\r \r ### <a name=\"disable-automated-backup\"></a>禁用自动备份\r \r 若要禁用自动备份，请运行同一个脚本，但不要为 **New-AzureRmVMSqlServerAutoBackupConfig** 命令指定 **-Enable** 参数。 缺少 **-Enable** 参数会向该命令发出指示以禁用此功能。 与安装一样，可能需要花费几分钟时间来禁用自动备份。\r \r ```powershell\r $autobackupconfig = New-AzureRmVMSqlServerAutoBackupConfig -ResourceGroupName $storage_resourcegroupname\r \r Set-AzureRmVMSqlServerExtension -AutoBackupSettings $autobackupconfig `\r     -VMName $vmname -ResourceGroupName $resourcegroupname\r ```\r \r ### <a name=\"example-script\"></a>示例脚本\r \r 以下脚本提供一组可自定义的变量，用来为 VM 启用和配置自动备份。 根据具体的情况，可能需要根据要求自定义该脚本。 例如，如果想要禁用系统数据库备份或启用加密，则必须更改该脚本。\r \r ```powershell\r $vmname = \"yourvmname\"\r $resourcegroupname = \"vmresourcegroupname\"\r $region = \"Azure region name such as EASTUS2\"\r $storage_accountname = \"storageaccountname\"\r $storage_resourcegroupname = $resourcegroupname\r $retentionperiod = 10\r \r # ResourceGroupName is the resource group which is hosting the VM where you are deploying the SQL IaaS Extension\r \r Set-AzureRmVMSqlServerExtension -VMName $vmname `\r     -ResourceGroupName $resourcegroupname -Name \"SQLIaasExtension\" `\r     -Version \"1.2\" -Location $region\r \r # Creates/use a storage account to store the backups\r \r $storage = Get-AzureRmStorageAccount -ResourceGroupName $resourcegroupname `\r     -Name $storage_accountname -ErrorAction SilentlyContinue\r If (-Not $storage)\r     { $storage = New-AzureRmStorageAccount -ResourceGroupName $storage_resourcegroupname `\r     -Name $storage_accountname -SkuName Standard_GRS -Location $region }\r \r # Configure Automated Backup settings\r \r $autobackupconfig = New-AzureRmVMSqlServerAutoBackupConfig -Enable `\r     -RetentionPeriodInDays $retentionperiod -StorageContext $storage.Context `\r     -ResourceGroupName $storage_resourcegroupname\r \r # Apply the Automated Backup settings to the VM\r \r Set-AzureRmVMSqlServerExtension -AutoBackupSettings $autobackupconfig `\r     -VMName $vmname -ResourceGroupName $resourcegroupname\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 自动备份会在 Azure VM 上配置托管备份。 因此，请务必[查看有关托管备份的文档](https://msdn.microsoft.com/library/dn449496.aspx)，了解其行为和影响。\r \r 可以在以下主题中找到针对 Azure VM 上的 SQL Server 的其他备份和还原指导：[Azure 虚拟机中 SQL Server 的备份和还原](virtual-machines-windows-sql-backup-recovery.md)。\r \r 有关其他可用自动化任务的信息，请参阅 [SQL Server IaaS 代理扩展](virtual-machines-windows-sql-server-agent-extension.md)。\r \r 有关在 Azure VM 中运行 SQL Server 的详细信息，请参阅 [Azure 虚拟机中的 SQL Server 概述](virtual-machines-windows-sql-server-iaas-overview.md)。\r \r <!--Update_Description: add sql server 2016-->"}