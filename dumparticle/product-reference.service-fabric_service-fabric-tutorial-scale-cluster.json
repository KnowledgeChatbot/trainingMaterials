{"Title":"缩放 Azure Service Fabric 群集","Description":"了解如何快速缩放 Service Fabric 群集。","Content":"# <a name=\"scale-a-service-fabric-cluster\"></a>缩放 Service Fabric 群集\r \r 本教程是系列教程的第二部分，介绍如何扩大和缩小现有群集。 完成时，将知道如何缩放群集以及如何清理剩余的资源。\r \r 本教程介绍如何执行下列操作：\r \r > [!div class=\"checklist\"]\r > * 读取群集节点计数\r > * 添加群集节点（扩大）\r > * 移除群集节点（缩小）\r \r ## <a name=\"prerequisites\"></a>先决条件\r 在开始学习本教程之前：\r - 如果还没有 Azure 订阅，请创建一个[试用帐户](https://www.azure.cn/pricing/1rmb-trial/?WT.mc_id=A261C142F)\r - 安装 [Azure PowerShell 模块 4.1 或更高版本](https://docs.microsoft.com/powershell/azure/install-azurerm-ps)或 [Azure CLI 2.0](https://docs.azure.cn/zh-cn/cli/install-azure-cli)。\r - 在 Azure 上创建安全的 [Windows 群集](service-fabric-tutorial-create-vnet-and-windows-cluster.md)或 [Linux 群集](service-fabric-tutorial-create-vnet-and-linux-cluster.md)\r - 如果部署 Windows 群集，请设置 Windows 开发环境。 安装 [Visual Studio 2017](http://www.visualstudio.com) 和 **Azure 开发**、**ASP.NET 和 Web 开发**以及 **.NET Core 跨平台开发**工作负荷。  然后设置 [.NET 开发环境](service-fabric-get-started.md)。\r - 如果部署 Linux 群集，请在 [Linux](service-fabric-get-started-linux.md) 或 [MacOS](service-fabric-get-started-mac.md) 上设置一个 Java 开发环境。  安装 [Service Fabric CLI](service-fabric-cli.md?view=azure-cli-latest)。 \r \r ## <a name=\"sign-in-to-azure\"></a>登录 Azure\r 执行 Azure 命令之前，登录到你的 Azure 帐户并选择你的订阅。\r \r ```powershell\r Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r Get-AzureRmSubscription\r Set-AzureRmContext -SubscriptionId <guid>\r ```\r \r ```azurecli\r az login\r az account set --subscription <guid>\r ```\r \r ## <a name=\"connect-to-the-cluster\"></a>连接至群集\r \r 若要成功完成此部分教程，需要连接到 Service Fabric 群集和虚拟机规模集（用于托管群集）。 虚拟机规模集是在 Azure 上托管 Service Fabric 的 Azure 资源。\r \r 连接到群集时，可以进行信息查询。 可以使用群集了解群集识别的节点。 连接到以下代码中的群集使用在本系列的第一部分创建的相同证书。 请确保将 `$endpoint` 和 `$thumbprint` 变量设置为自己的值。\r \r ```powershell\r $endpoint = \"<mycluster>.chinaeast.cloudapp.chinacloudapi.cn:19000\"\r $thumbprint = \"63EB5BA4BC2A3BADC42CA6F93D6F45E5AD98A1E4\"\r \r Connect-ServiceFabricCluster -ConnectionEndpoint $endpoint `\r           -KeepAliveIntervalInSec 10 `\r           -X509Credential -ServerCertThumbprint $thumbprint `\r           -FindType FindByThumbprint -FindValue $thumbprint `\r           -StoreLocation CurrentUser -StoreName My\r \r Get-ServiceFabricClusterHealth\r ```\r \r ```azurecli\r sfctl cluster select --endpoint https://aztestcluster.chinaeast.cloudapp.chinacloudapi.cn:19080 \\\r --pem ./aztestcluster201709151446.pem --no-verify\r ```\r \r 连接后，即可使用命令获取群集中每个节点的状态。 对于 PowerShell，请使用 `Get-ServiceFabricClusterHealth` 命令，而对于 sfctl，请使用 `` 命令。\r \r ## <a name=\"scale-out\"></a>向外扩展\r \r 扩大时，添加更多虚拟机实例到规模集。 这些实例成为 Service Fabric 使用的节点。 Service Fabric 知道规模集什么时候添加了更多实例（通过扩大实现）并自动做出反应。 以下代码按名称获取规模集，并使规模集的容量增加 1。\r \r ```powershell\r $scaleset = Get-AzureRmVmss -ResourceGroupName SFCLUSTERTUTORIALGROUP -VMScaleSetName nt1vm\r $scaleset.Sku.Capacity += 1\r \r Update-AzureRmVmss -ResourceGroupName SFCLUSTERTUTORIALGROUP -VMScaleSetName nt1vm -VirtualMachineScaleSet $scaleset\r ```\r \r 此代码将容量设为 6。\r \r ```azurecli\r # Get the name of the node with\r az vmss list-instances -n nt1vm -g sfclustertutorialgroup --query [*].name\r \r # Use the name to scale\r az vmss scale -g sfclustertutorialgroup -n nt1vm --new-capacity 6\r ```\r \r ## <a name=\"scale-in\"></a>缩小\r \r 缩小和扩大相同，只是使用的是更低的容量值。 缩小规模集时，将从规模集中移除虚拟机实例。 通常情况下，Service Fabric 不能识别发生了什么，并且它认为节点已丢失。 然后 Service Fabric 将报告群集的不正常状态。 为防止错误状态，必须通知 Service Fabric 你希望节点消失。\r \r ### <a name=\"remove-the-service-fabric-node\"></a>移除 Service Fabric 节点\r \r > [!NOTE]\r > 此部分仅应用于 Bronze 持续性层。 有关持续性的详细信息，请参阅 [Service Fabric 群集容量规划][durability]。\r \r 缩小虚拟机规模集时，规模集（大多情况下）会移除上次创建的虚拟机实例。 因此，需要找到上次创建的相应 Service Fabric 节点。 可以通过检查 Service Fabric 节点上最大 `NodeInstanceId` 属性值找到最近的节点。 下面的代码示例按节点实例排序并返回有最大 ID 值的实例的详细信息。 \r \r ```powershell\r Get-ServiceFabricNode | Sort-Object NodeInstanceId -Descending | Select-Object -First 1\r ```\r \r ```azurecli\r `sfctl node list --query \"sort_by(items[*], &instanceId)[-1]\"`\r ```\r \r Service Fabric 群集需要了解此节点将被移除。 需要执行以下三个步骤：\r \r 1. 禁用节点，使其不再是数据复制。  \r PowerShell：`Disable-ServiceFabricNode`  \r sfcli：`sfctl node disable`\r \r 2. 停止节点，使 Service Fabric 运行时完全关闭且应用获取终止请求。  \r PowerShell：`Start-ServiceFabricNodeTransition -Stop`  \r sfcli：`sfctl node transition --node-transition-type Stop`\r \r 2. 从群集移除节点。  \r PowerShell：`Remove-ServiceFabricNodeState`  \r sfcli：`sfctl node remove-state`\r \r 对节点执行这三个步骤后，即可将其从规模集中移除。 如果使用除 [bronze][durability] 以外的任意持续性层，在移除规模集实例时会完成这些步骤。\r \r 以下代码块获取最近创建的节点，禁用、停止并将节点从群集中移除。\r \r ```powershell\r # Get the node that was created last\r $node = Get-ServiceFabricNode | Sort-Object NodeInstanceId -Descending | Select-Object -First 1\r \r # Node details for the disable/stop process\r $nodename = $node.NodeName\r $nodeid = $node.NodeInstanceId\r \r $loopTimeout = 10\r \r # Run disable logic\r Disable-ServiceFabricNode -NodeName $nodename -Intent RemoveNode -TimeoutSec 300 -Force\r \r $state = Get-ServiceFabricNode | Where-Object NodeName -eq $nodename | Select-Object -ExpandProperty NodeStatus\r \r while (($state -ne [System.Fabric.Query.NodeStatus]::Disabled) -and ($loopTimeout -ne 0))\r {\r     Start-Sleep 5\r     $loopTimeout -= 1\r     $state = Get-ServiceFabricNode | Where-Object NodeName -eq $nodename | Select-Object -ExpandProperty NodeStatus\r     Write-Host \"Checking state... $state found\"\r }\r \r # Exit if the node was unable to be disabled\r if ($state -ne [System.Fabric.Query.NodeStatus]::Disabled)\r {\r     Write-Error \"Disable failed with state $state\"\r }\r else\r {\r     # Stop node\r     $stopid = New-Guid\r     Start-ServiceFabricNodeTransition -Stop -OperationId $stopid -NodeName $nodename -NodeInstanceId $nodeid -StopDurationInSeconds 300\r \r     $state = (Get-ServiceFabricNodeTransitionProgress -OperationId $stopid).State\r     $loopTimeout = 10\r \r     # Watch the transaction\r     while (($state -eq [System.Fabric.TestCommandProgressState]::Running) -and ($loopTimeout -ne 0))\r     {\r         Start-Sleep 5\r         $state = (Get-ServiceFabricNodeTransitionProgress -OperationId $stopid).State\r         Write-Host \"Checking state... $state found\"\r     }\r \r     if ($state -ne [System.Fabric.TestCommandProgressState]::Completed)\r     {\r         Write-Error \"Stop transaction failed with $state\"\r     }\r     else\r     {\r         # Remove the node from the cluster\r         Remove-ServiceFabricNodeState -NodeName $nodename -TimeoutSec 300 -Force\r     }\r }\r ```\r \r 在下面的“sfctl”代码中，使用以下命令获取最近创建节点 `sfctl node list --query \"sort_by(items[*], &instanceId)[-1].[instanceId,name]\"` 的 “node-name”和“node-instance-id”值。\r \r ```azurecli\r # Inform the node that it is going to be removed\r sfctl node disable --node-name _nt1vm_5 --deactivation-intent 4 -t 300\r \r # Stop the node using a random guid as our operation id\r sfctl node transition --node-instance-id 131541348482680775 --node-name _nt1vm_5 --node-transition-type Stop --operation-id c17bb4c5-9f6c-4eef-950f-3d03e1fef6fc --stop-duration-in-seconds 14400 -t 300\r \r # Remove the node from the cluster\r sfctl node remove-state --node-name _nt1vm_5\r ```\r \r > [!TIP]\r > 使用以下“sfctl”查询检查每个步骤的状态。\r >\r > **检查停用状态**  \r > `sfctl node list --query \"sort_by(items[*], &instanceId)[-1].nodeDeactivationInfo\"`\r >\r > **检查停止状态**  \r > `sfctl node list --query \"sort_by(items[*], &instanceId)[-1].isStopped\"`\r >\r \r ### <a name=\"scale-in-the-scale-set\"></a>缩小规模集\r \r 将 Service Fabric 节点从群集中移除后，即可缩小虚拟机规模集。 在下面的示例中，规模集容量缩小了 1。\r \r ```powershell\r $scaleset = Get-AzureRmVmss -ResourceGroupName SFCLUSTERTUTORIALGROUP -VMScaleSetName nt1vm\r $scaleset.Sku.Capacity -= 1\r \r Update-AzureRmVmss -ResourceGroupName SFCLUSTERTUTORIALGROUP -VMScaleSetName nt1vm -VirtualMachineScaleSet $scaleset\r ```\r \r 此代码将容量设为 5。\r \r ```azurecli\r # Get the name of the node with\r az vmss list-instances -n nt1vm -g sfclustertutorialgroup --query [*].name\r \r # Use the name to scale\r az vmss scale -g sfclustertutorialgroup -n nt1vm --new-capacity 5\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 在本教程中，你已学习了如何执行以下操作：\r \r > [!div class=\"checklist\"]\r > * 读取群集节点计数\r > * 添加群集节点（扩大）\r > * 移除群集节点（缩小）\r \r 接下来，转到以下教程了解如何部署应用程序和使用 API 管理。\r > [!div class=\"nextstepaction\"]\r > [部署 API 管理](service-fabric-tutorial-deploy-api-management.md)\r \r [durability]: service-fabric-cluster-capacity.md#the-durability-characteristics-of-the-cluster\r \r <!-- Update_Description: new articles on tutorial about scale service fabric cluster -->"}