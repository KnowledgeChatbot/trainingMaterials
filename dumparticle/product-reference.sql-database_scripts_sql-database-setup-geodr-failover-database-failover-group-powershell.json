{"Title":"PowerShell 示例 - 异地复制故障转移组 - 单个 Azure SQL 数据库","Description":"为单个 Azure SQL 数据库设置活动异地复制故障转移组并进行故障转移的 Azure PowerShell 示例脚本。","Content":"# <a name=\"use-powershell-to-configure-an-active-geo-replication-failover-group-for-a-single-azure-sql-database\"></a>使用 PowerShell 为单个 Azure SQL 数据库配置活动异地复制故障转移组\r \r 此 PowerShell 脚本示例为单个 Azure SQL 数据库配置活动异地复制故障转移组，并将其故障转移到 Azure SQL 数据库的次要副本。\r \r [!INCLUDE [sample-powershell-install](../../../includes/sample-powershell-install-no-ssh.md)]\r \r ## <a name=\"sample-scripts\"></a>示例脚本\r \r ```powershell\r # Login-AzureRmAccount -EnvironmentName AzureChinaCloud\r # Set the resource group name and location for your primary server\r $primaryresourcegroupname = \"myPrimaryResourceGroup-$(Get-Random)\"\r $primarylocation = \"China East\"\r # Set the resource group name and location for your secondary server\r $secondarylocation = \"China North\"\r # Set an admin login and password for your servers\r $adminlogin = \"ServerAdmin\"\r $password = \"ChangeYourAdminPassword1\"\r # Set failover group name - the failover group name has to be unique in the system\r $failovergroupname = \"failovergroupname-$(Get-Random)\"\r # Set server names - the logical server names have to be unique in the system\r $primaryservername = \"primary-server-$(Get-Random)\"\r $secondaryservername = \"secondary-server-$(Get-Random)\"\r # The sample database name\r $databasename = \"mySampleDatabase\"\r # The ip address range that you want to allow to access your servers\r $primarystartip = \"0.0.0.0\"\r $primaryendip = \"0.0.0.0\"\r $secondarystartip = \"0.0.0.0\"\r $secondaryendip = \"0.0.0.0\"\r \r # Create new resource group\r $primaryresourcegroup = New-AzureRmResourceGroup -Name $primaryresourcegroupname -Location $primarylocation\r $primaryresourcegroup\r # Create two new logical servers with a system wide unique server name\r $primaryserver = New-AzureRmSqlServer -ResourceGroupName $primaryresourcegroupname `\r     -ServerName $primaryservername `\r     -Location $primarylocation `\r     -SqlAdministratorCredentials $(New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $adminlogin, $(ConvertTo-SecureString -String $password -AsPlainText -Force))\r $primaryserver\r $secondaryserver = New-AzureRmSqlServer -ResourceGroupName $primaryresourcegroupname `\r     -ServerName $secondaryservername `\r     -Location $secondarylocation `\r     -SqlAdministratorCredentials $(New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $adminlogin, $(ConvertTo-SecureString -String $password -AsPlainText -Force))\r $secondaryserver\r # Create a server firewall rule that allows access from the specified IP range\r $primaryserverfirewallrule = New-AzureRmSqlServerFirewallRule -ResourceGroupName $primaryresourcegroupname `\r     -ServerName $primaryservername `\r     -FirewallRuleName \"AllowedIPs\" -StartIpAddress $primarystartip -EndIpAddress $primaryendip\r $primaryserverfirewallrule\r $secondaryserverfirewallrule = New-AzureRmSqlServerFirewallRule -ResourceGroupName $primaryresourcegroupname `\r     -ServerName $secondaryservername `\r     -FirewallRuleName \"AllowedIPs\" -StartIpAddress $secondarystartip -EndIpAddress $secondaryendip\r $secondaryserverfirewallrule\r # Create a blank database with S0 performance level on the primary server\r $database = New-AzureRmSqlDatabase  -ResourceGroupName $primaryresourcegroupname `\r     -ServerName $primaryservername `\r     -DatabaseName $databasename -RequestedServiceObjectiveName \"S0\"\r $database\r # Create failover group\r $failovergroup = New-AzureRMSqlDatabaseFailoverGroup `\r       –ResourceGroupName $primaryresourcegroupname `\r       -ServerName $primaryservername `\r       -PartnerServerName $secondaryservername  `\r       –FailoverGroupName $failovergroupname `\r       –FailoverPolicy Automatic `\r       -GracePeriodWithDataLossHours 2\r $failovergroup\r # Add database to failover group\r $failovergroup = Get-AzureRmSqlDatabase `\r    -ResourceGroupName $primaryresourcegroupname `\r    -ServerName $primaryservername `\r    -DatabaseName $databasename | `\r    Add-AzureRmSqlDatabaseToFailoverGroup `\r    -ResourceGroupName $primaryresourcegroupname ` `\r    -ServerName $primaryservername `\r    -FailoverGroupName $failovergroupname\r $failovergroup\r # Initiate a planned failover\r Switch-AzureRMSqlDatabaseFailoverGroup `\r    -ResourceGroupName $primaryresourcegroupname  `\r    -ServerName $secondaryservername `\r    -FailoverGroupName $failovergroupname \r \r # Monitor Geo-Replication config and health after failover\r Get-AzureRMSqlDatabaseFailoverGroup `\r    -ResourceGroupName $primaryresourcegroupname  `\r    -ServerName $primaryservername \r Get-AzureRMSqlDatabaseFailoverGroup `\r    -ResourceGroupName $primaryresourcegroupname  `\r    -ServerName $secondaryservername \r \r # Remove the replication link after the failover\r Remove-AzureRmSqlDatabaseFailoverGroup `\r    -ResourceGroupName $primaryresourcegroupname  `\r    -ServerName $secondaryservername `\r    -FailoverGroupName $failovergroupname\r \r # Clean up deployment \r # Remove-AzureRmResourceGroup -ResourceGroupName $primaryresourcegroupname\r \r ```\r \r ## <a name=\"clean-up-deployment\"></a>清理部署\r \r 运行脚本示例后，可以使用以下命令删除资源组以及与其关联的所有资源。\r \r ```powershell\r Remove-AzureRmResourceGroup -ResourceGroupName $primaryresourcegroupname\r Remove-AzureRmResourceGroup -ResourceGroupName $secondaryresourcegroupname\r ```\r \r ## <a name=\"script-explanation\"></a>脚本说明\r \r 此脚本使用以下命令。 表中的每条命令均链接到特定于命令的文档。\r \r | 命令 | 说明 |\r |---|---|\r | [New-AzureRmResourceGroup](https://docs.microsoft.com/powershell/module/azurerm.resources/new-azurermresourcegroup) | 创建用于存储所有资源的资源组。 |\r | [New-AzureRmSqlServer](https://docs.microsoft.com/powershell/module/azurerm.sql/new-azurermsqlserver) | 创建用于托管数据库或弹性池的逻辑服务器。 |\r | [New-AzureRmSqlElasticPool](https://docs.microsoft.com/powershell/module/azurerm.sql/new-azurermsqlelasticpool) | 在逻辑服务器中创建弹性池。 |\r | [Set-AzureRmSqlDatabase](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabase) | 更新数据库属性，或者将数据库移入、移出弹性池或在弹性池之间移动。 |\r | [New-AzureRmSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/azurerm.sql/new-azurermsqldatabasesecondary)| 为现有数据库创建辅助数据库，并开始数据复制。 |\r | [Get-AzureRmSqlDatabase](https://docs.microsoft.com/powershell/module/azurerm.sql/get-azurermsqldatabase)| 获取一个或多个数据库。 |\r | [Set-AzureRmSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/azurerm.sql/set-azurermsqldatabasesecondary)| 将辅助数据库切换为主数据库，启动故障转移。|\r | [Get-AzureRmSqlDatabaseReplicationLink](https://docs.microsoft.com/powershell/module/azurerm.sql/get-azurermsqldatabasereplicationlink) | 获取 Azure SQL 数据库和资源组或 SQL Server 之间的异地复制链路。 |\r | [Remove-AzureRmSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/azurerm.sql/remove-azurermsqldatabasesecondary) | 终止 SQL 数据库和指定的辅助数据库之间的数据复制。 |\r | [Remove-AzureRmResourceGroup](https://docs.microsoft.com/powershell/module/azurerm.resources/remove-azurermresourcegroup) | 删除资源组，包括所有嵌套的资源。 |\r |||\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 有关 Azure PowerShell 的详细信息，请参阅 [Azure PowerShell 文档](https://docs.microsoft.com/powershell/azure/overview)。\r \r 可以在 [Azure SQL 数据库 PowerShell 脚本](../sql-database-powershell-samples.md)中找到更多 SQL 数据库 PowerShell 脚本示例。\r "}