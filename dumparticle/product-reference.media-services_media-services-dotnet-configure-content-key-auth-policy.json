{"Title":"使用媒体服务 .NET SDK 配置内容密钥授权策略","Description":"了解如何使用适用于 .NET 的媒体服务 SDK 配置内容密钥的授权策略。","Content":"# <a name=\"dynamic-encryption-configure-content-key-authorization-policy\"></a>动态加密：配置内容密钥授权策略\r \r [!INCLUDE [media-services-selector-content-key-auth-policy](../../includes/media-services-selector-content-key-auth-policy.md)] \r \r ## <a name=\"overview\"></a>概述\r Azure 媒体服务允许传送受高级加密标准 (AES)（使用 128 位加密密钥）或受 [Microsoft PlayReady DRM](https://www.microsoft.com/playready/overview/) 保护的 MPEG-DASH 流、平滑流式处理流和 HTTP-Live-Streaming (HLS) 流。 PlayReady 是按通用加密 (ISO/IEC 23001-7 CENC) 规范加密的。 \r \r 媒体服务还提供了一个密钥/许可证传送服务，客户端可从中获取 AES 密钥或 PlayReady 许可证，以用于播放加密的内容。 \r \r 如果希望媒体服务加密资产，需要将加密密钥（CommonEncryption 或 EnvelopeEncryption）与资产相关联（如[此处](media-services-dotnet-create-contentkey.md)所述），并配置密钥授权策略（如本文所述）。\r \r 播放器请求流时，媒体服务会使用指定的密钥通过 AES 或 DRM 加密来动态加密内容。 为了解密流，播放器会从密钥传送服务请求密钥。 为了确定用户是否有权获取密钥，服务会评估为密钥指定的授权策略。\r \r 媒体服务支持通过多种方式对发出密钥请求的用户进行身份验证。 内容密钥授权策略可能受到一种或多种授权限制：开放或令牌限制。 令牌限制策略必须附带由安全令牌服务 (STS) 颁发的令牌。 媒体服务支持采用**简单 Web 令牌** ([SWT](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_2)) 格式和 **JSON Web 令牌** ([JWT](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3)) 格式的令牌。\r \r 媒体服务不提供安全令牌服务。 可以创建自定义 STS 或利用 Microsoft Azure ACS 颁发令牌。 必须将 STS 配置为创建令牌，该令牌使用指定密钥以及你在令牌限制配置中指定的颁发声明进行签名（如本文所述）。 如果令牌有效，而且令牌中的声明与为内容密钥配置的声明相匹配，则媒体服务密钥传送服务会将加密密钥返回到客户端。\r \r 有关详细信息，请参阅 \r \r [JWT 令牌身份验证](http://www.gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/)\r \r [将基于 Azure 媒体服务 OWIN MVC 的应用与 Azure Active Directory 相集成，并基于 JWT 声明限制内容密钥传送](http://www.gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/)。\r \r [使用 Azure ACS 颁发令牌](http://mingfeiy.com/acs-with-key-services)。\r \r ### <a name=\"some-considerations-apply\"></a>请注意以下事项：\r * 创建 AMS 帐户后，会将一个处于“已停止”状态的默认流式处理终结点添加到帐户。 若要开始流式传输内容并利用动态打包和动态加密，流式处理终结点必须处于“正在运行”状态。 \r * 资产必须包含一组自适应比特率 MP4 或自适应比特率平滑流式处理文件。 有关详细信息，请参阅[对资产进行编码](media-services-encode-asset.md)。\r * 使用 **AssetCreationOptions.StorageEncrypted** 选项上传资产并对其进行编码。\r * 如果打算创建需要相同策略配置的多个内容密钥，我们强烈建议创建单个授权策略，并将其重复用于多个内容密钥。\r * 密钥传送服务将 ContentKeyAuthorizationPolicy 及其相关对象（策略选项和限制）缓存 15 分钟。  如果创建 ContentKeyAuthorizationPolicy 并指定使用“令牌”限制，并对其进行测试，再将策略更新为“开放”限制，则现有策略切换到“开放”版本的策略需要大约 15 分钟。\r * 如果添加或更新资产的传送策略，则必须删除现有定位符（如果有）并创建新定位符。\r * 目前，无法加密渐进式下载。\r \r ## <a name=\"aes-128-dynamic-encryption\"></a>AES-128 动态加密\r ### <a name=\"open-restriction\"></a>开放限制\r 开放限制意味着系统会将密钥传送到发出密钥请求的任何用户。 此限制可能适用于测试用途。\r \r 以下示例创建开放授权策略，并将其添加到内容密钥。\r \r     static public void AddOpenAuthorizationPolicy(IContentKey contentKey)\r     {\r         // Create ContentKeyAuthorizationPolicy with Open restrictions\r         // and create authorization policy\r         IContentKeyAuthorizationPolicy policy = _context.\r         ContentKeyAuthorizationPolicies.\r         CreateAsync(\"Open Authorization Policy\").Result;\r         \r         List<ContentKeyAuthorizationPolicyRestriction> restrictions =\r             new List<ContentKeyAuthorizationPolicyRestriction>();\r \r         ContentKeyAuthorizationPolicyRestriction restriction =\r             new ContentKeyAuthorizationPolicyRestriction\r             {\r                 Name = \"HLS Open Authorization Policy\",\r                 KeyRestrictionType = (int)ContentKeyRestrictionType.Open,\r                 Requirements = null // no requirements needed for HLS\r             };\r \r         restrictions.Add(restriction);\r \r         IContentKeyAuthorizationPolicyOption policyOption =\r             _context.ContentKeyAuthorizationPolicyOptions.Create(\r             \"policy\", \r             ContentKeyDeliveryType.BaselineHttp, \r             restrictions, \r             \"\");\r \r         policy.Options.Add(policyOption);\r \r         // Add ContentKeyAutorizationPolicy to ContentKey\r         contentKey.AuthorizationPolicyId = policy.Id;\r         IContentKey updatedKey = contentKey.UpdateAsync().Result;\r         Console.WriteLine(\"Adding Key to Asset: Key ID is \" + updatedKey.Id);\r     }\r \r \r ### <a name=\"token-restriction\"></a>令牌限制\r 本部分介绍如何创建内容密钥授权策略，以及如何将其与内容密钥相关联。 授权策略描述了必须达到什么授权要求才能确定用户是否有权接收密钥（例如，“验证密钥”列表是否包含令牌签名时使用的密钥）。\r \r 要配置令牌限制选项，需要使用 XML 描述令牌的授权要求。 令牌限制配置 XML 必须符合以下 XML 架构。\r \r #### <a id=\"schema\"></a>令牌限制架构\r     <?xml version=\"1.0\" encoding=\"utf-8\"?>\r     <xs:schema xmlns:tns=\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\" elementFormDefault=\"qualified\" targetNamespace=\"http://schemas.microsoft.com/Azure/MediaServices/KeyDelivery/TokenRestrictionTemplate/v1\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\">\r       <xs:complexType name=\"TokenClaim\">\r         <xs:sequence>\r           <xs:element name=\"ClaimType\" nillable=\"true\" type=\"xs:string\" />\r           <xs:element minOccurs=\"0\" name=\"ClaimValue\" nillable=\"true\" type=\"xs:string\" />\r         </xs:sequence>\r       </xs:complexType>\r       <xs:element name=\"TokenClaim\" nillable=\"true\" type=\"tns:TokenClaim\" />\r       <xs:complexType name=\"TokenRestrictionTemplate\">\r         <xs:sequence>\r           <xs:element minOccurs=\"0\" name=\"AlternateVerificationKeys\" nillable=\"true\" type=\"tns:ArrayOfTokenVerificationKey\" />\r           <xs:element name=\"Audience\" nillable=\"true\" type=\"xs:anyURI\" />\r           <xs:element name=\"Issuer\" nillable=\"true\" type=\"xs:anyURI\" />\r           <xs:element name=\"PrimaryVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r           <xs:element minOccurs=\"0\" name=\"RequiredClaims\" nillable=\"true\" type=\"tns:ArrayOfTokenClaim\" />\r         </xs:sequence>\r       </xs:complexType>\r       <xs:element name=\"TokenRestrictionTemplate\" nillable=\"true\" type=\"tns:TokenRestrictionTemplate\" />\r       <xs:complexType name=\"ArrayOfTokenVerificationKey\">\r         <xs:sequence>\r           <xs:element minOccurs=\"0\" maxOccurs=\"unbounded\" name=\"TokenVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r         </xs:sequence>\r       </xs:complexType>\r       <xs:element name=\"ArrayOfTokenVerificationKey\" nillable=\"true\" type=\"tns:ArrayOfTokenVerificationKey\" />\r       <xs:complexType name=\"TokenVerificationKey\">\r         <xs:sequence />\r       </xs:complexType>\r       <xs:element name=\"TokenVerificationKey\" nillable=\"true\" type=\"tns:TokenVerificationKey\" />\r       <xs:complexType name=\"ArrayOfTokenClaim\">\r         <xs:sequence>\r           <xs:element minOccurs=\"0\" maxOccurs=\"unbounded\" name=\"TokenClaim\" nillable=\"true\" type=\"tns:TokenClaim\" />\r         </xs:sequence>\r       </xs:complexType>\r       <xs:element name=\"ArrayOfTokenClaim\" nillable=\"true\" type=\"tns:ArrayOfTokenClaim\" />\r       <xs:complexType name=\"SymmetricVerificationKey\">\r         <xs:complexContent mixed=\"false\">\r           <xs:extension base=\"tns:TokenVerificationKey\">\r             <xs:sequence>\r               <xs:element name=\"KeyValue\" nillable=\"true\" type=\"xs:base64Binary\" />\r             </xs:sequence>\r           </xs:extension>\r         </xs:complexContent>\r       </xs:complexType>\r       <xs:element name=\"SymmetricVerificationKey\" nillable=\"true\" type=\"tns:SymmetricVerificationKey\" />\r     </xs:schema>\r \r 配置令牌限制策略时，必须指定主验证密钥、颁发者和受众参数。 主验证密钥包含用于为令牌签名的密钥，颁发者是颁发令牌的安全令牌服务。 受众（有时称为范围）描述该令牌的意图，或者令牌授权访问的资源。 媒体服务密钥传送服务验证令牌中的这些值是否与模板中的值匹配。 \r \r 使用适用于 .NET 的媒体服务 SDK 时，可以使用 TokenRestrictionTemplate 类来生成限制令牌。\r 以下示例创建包含令牌限制的授权策略。 在此示例中，客户端必须出示令牌，其中包含：签名密钥 (VerificationKey)、令牌颁发者和必需的声明。\r \r     public static string AddTokenRestrictedAuthorizationPolicy(IContentKey contentKey)\r     {\r         string tokenTemplateString = GenerateTokenRequirements();\r \r         IContentKeyAuthorizationPolicy policy = _context.\r                                 ContentKeyAuthorizationPolicies.\r                                 CreateAsync(\"HLS token restricted authorization policy\").Result;\r \r         List<ContentKeyAuthorizationPolicyRestriction> restrictions =\r                 new List<ContentKeyAuthorizationPolicyRestriction>();\r \r         ContentKeyAuthorizationPolicyRestriction restriction =\r                 new ContentKeyAuthorizationPolicyRestriction\r                 {\r                     Name = \"Token Authorization Policy\",\r                     KeyRestrictionType = (int)ContentKeyRestrictionType.TokenRestricted,\r                     Requirements = tokenTemplateString\r                 };\r \r         restrictions.Add(restriction);\r \r         //You could have multiple options \r         IContentKeyAuthorizationPolicyOption policyOption =\r             _context.ContentKeyAuthorizationPolicyOptions.Create(\r                 \"Token option for HLS\",\r                 ContentKeyDeliveryType.BaselineHttp,\r                 restrictions,\r                 null  // no key delivery data is needed for HLS\r                 );\r \r         policy.Options.Add(policyOption);\r \r         // Add ContentKeyAutorizationPolicy to ContentKey\r         contentKey.AuthorizationPolicyId = policy.Id;\r         IContentKey updatedKey = contentKey.UpdateAsync().Result;\r         Console.WriteLine(\"Adding Key to Asset: Key ID is \" + updatedKey.Id);\r \r         return tokenTemplateString;\r     }\r \r     static private string GenerateTokenRequirements()\r     {\r         TokenRestrictionTemplate template = new TokenRestrictionTemplate(TokenType.SWT);\r \r         template.PrimaryVerificationKey = new SymmetricVerificationKey();\r         template.AlternateVerificationKeys.Add(new SymmetricVerificationKey());\r             template.Audience = _sampleAudience.ToString();\r             template.Issuer = _sampleIssuer.ToString();\r \r         template.RequiredClaims.Add(TokenClaim.ContentKeyIdentifierClaim);\r \r         return TokenRestrictionTemplateSerializer.Serialize(template);\r     }\r \r #### <a id=\"test\"></a>测试令牌\r 若要获取用于密钥授权策略，基于令牌限制的测试令牌，请执行以下操作。\r \r     // Deserializes a string containing an Xml representation of a TokenRestrictionTemplate\r     // back into a TokenRestrictionTemplate class instance.\r     TokenRestrictionTemplate tokenTemplate =\r         TokenRestrictionTemplateSerializer.Deserialize(tokenTemplateString);\r \r     // Generate a test token based on the the data in the given TokenRestrictionTemplate.\r     // Note, you need to pass the key id Guid because we specified \r     // TokenClaim.ContentKeyIdentifierClaim in during the creation of TokenRestrictionTemplate.\r     Guid rawkey = EncryptionUtils.GetKeyIdAsGuid(key.Id);\r \r     //The GenerateTestToken method returns the token without the word “Bearer” in front\r     //so you have to add it in front of the token string. \r     string testToken = TokenRestrictionTemplateSerializer.GenerateTestToken(tokenTemplate, null, rawkey);\r     Console.WriteLine(\"The authorization token is:\\nBearer {0}\", testToken);\r     Console.WriteLine();\r \r \r ## <a name=\"playready-dynamic-encryption\"></a>PlayReady 动态加密\r 媒体服务允许配置相应的权限和限制，以便在用户尝试播放受保护的内容时，PlayReady DRM 运行时会强制实施这些权限和限制。 \r \r 使用 PlayReady 保护内容时，需要在授权策略中指定的项目之一是用于定义 [PlayReady 许可证模板](media-services-playready-license-template-overview.md)的 XML 字符串。 在适用于 .NET 的媒体服务 SDK 中，PlayReadyLicenseResponseTemplate 和 PlayReadyLicenseTemplate 类有助于定义 PlayReady 许可证模板。\r \r [本主题](media-services-protect-with-drm.md)演示如何使用 PlayReady 加密内容。\r \r ### <a name=\"open-restriction\"></a>开放限制\r 开放限制意味着系统会将密钥传送到发出密钥请求的任何用户。 此限制可能适用于测试用途。\r \r 以下示例创建开放授权策略，并将其添加到内容密钥。\r \r     static public void AddOpenAuthorizationPolicy(IContentKey contentKey)\r     {\r \r         // Create ContentKeyAuthorizationPolicy with Open restrictions \r         // and create authorization policy          \r \r         List<ContentKeyAuthorizationPolicyRestriction> restrictions = new List<ContentKeyAuthorizationPolicyRestriction>\r         {\r             new ContentKeyAuthorizationPolicyRestriction \r             { \r                 Name = \"Open\", \r                 KeyRestrictionType = (int)ContentKeyRestrictionType.Open, \r                 Requirements = null\r             }\r         };\r \r         // Configure PlayReady license template.\r         string newLicenseTemplate = ConfigurePlayReadyLicenseTemplate();\r \r         IContentKeyAuthorizationPolicyOption policyOption =\r             _context.ContentKeyAuthorizationPolicyOptions.Create(\"\",\r                 ContentKeyDeliveryType.PlayReadyLicense,\r                     restrictions, newLicenseTemplate);\r \r         IContentKeyAuthorizationPolicy contentKeyAuthorizationPolicy = _context.\r                     ContentKeyAuthorizationPolicies.\r                     CreateAsync(\"Deliver Common Content Key with no restrictions\").\r                     Result;\r \r         contentKeyAuthorizationPolicy.Options.Add(policyOption);\r \r         // Associate the content key authorization policy with the content key.\r         contentKey.AuthorizationPolicyId = contentKeyAuthorizationPolicy.Id;\r         contentKey = contentKey.UpdateAsync().Result;\r     }\r \r ### <a name=\"token-restriction\"></a>令牌限制\r 要配置令牌限制选项，需要使用 XML 描述令牌的授权要求。 令牌限制配置 XML 必须符合 [此](#schema) 部分中所示的 XML 架构。\r \r     public static string AddTokenRestrictedAuthorizationPolicy(IContentKey contentKey)\r     {\r         string tokenTemplateString = GenerateTokenRequirements();\r \r         IContentKeyAuthorizationPolicy policy = _context.\r                                 ContentKeyAuthorizationPolicies.\r                                 CreateAsync(\"HLS token restricted authorization policy\").Result;\r \r         List<ContentKeyAuthorizationPolicyRestriction> restrictions = new List<ContentKeyAuthorizationPolicyRestriction>\r         {\r             new ContentKeyAuthorizationPolicyRestriction \r             { \r                 Name = \"Token Authorization Policy\", \r                 KeyRestrictionType = (int)ContentKeyRestrictionType.TokenRestricted,\r                 Requirements = tokenTemplateString, \r             }\r         };\r \r         // Configure PlayReady license template.\r         string newLicenseTemplate = ConfigurePlayReadyLicenseTemplate();\r \r         IContentKeyAuthorizationPolicyOption policyOption =\r             _context.ContentKeyAuthorizationPolicyOptions.Create(\"Token option\",\r                 ContentKeyDeliveryType.PlayReadyLicense,\r                     restrictions, newLicenseTemplate);\r \r         IContentKeyAuthorizationPolicy contentKeyAuthorizationPolicy = _context.\r                     ContentKeyAuthorizationPolicies.\r                     CreateAsync(\"Deliver Common Content Key with no restrictions\").\r                     Result;\r \r         policy.Options.Add(policyOption);\r \r         // Add ContentKeyAutorizationPolicy to ContentKey\r         contentKeyAuthorizationPolicy.Options.Add(policyOption);\r \r         // Associate the content key authorization policy with the content key\r         contentKey.AuthorizationPolicyId = contentKeyAuthorizationPolicy.Id;\r         contentKey = contentKey.UpdateAsync().Result;\r \r         return tokenTemplateString;\r     }\r \r     static private string GenerateTokenRequirements()\r     {\r \r         TokenRestrictionTemplate template = new TokenRestrictionTemplate(TokenType.SWT);\r \r         template.PrimaryVerificationKey = new SymmetricVerificationKey();\r         template.AlternateVerificationKeys.Add(new SymmetricVerificationKey());\r             template.Audience = _sampleAudience.ToString();\r             template.Issuer = _sampleIssuer.ToString();\r \r         template.RequiredClaims.Add(TokenClaim.ContentKeyIdentifierClaim);\r \r         return TokenRestrictionTemplateSerializer.Serialize(template);\r     } \r \r     static private string ConfigurePlayReadyLicenseTemplate()\r     {\r         // The following code configures PlayReady License Template using .NET classes\r         // and returns the XML string.\r \r         //The PlayReadyLicenseResponseTemplate class represents the template for the response sent back to the end user. \r         //It contains a field for a custom data string between the license server and the application \r         //(may be useful for custom app logic) as well as a list of one or more license templates.\r         PlayReadyLicenseResponseTemplate responseTemplate = new PlayReadyLicenseResponseTemplate();\r \r         // The PlayReadyLicenseTemplate class represents a license template for creating PlayReady licenses\r         // to be returned to the end users. \r         //It contains the data on the content key in the license and any rights or restrictions to be \r         //enforced by the PlayReady DRM runtime when using the content key.\r         PlayReadyLicenseTemplate licenseTemplate = new PlayReadyLicenseTemplate();\r         //Configure whether the license is persistent (saved in persistent storage on the client) \r         //or non-persistent (only held in memory while the player is using the license).  \r         licenseTemplate.LicenseType = PlayReadyLicenseType.Nonpersistent;\r \r         // AllowTestDevices controls whether test devices can use the license or not.  \r         // If true, the MinimumSecurityLevel property of the license\r         // is set to 150.  If false (the default), the MinimumSecurityLevel property of the license is set to 2000.\r         licenseTemplate.AllowTestDevices = true;\r \r         // You can also configure the Play Right in the PlayReady license by using the PlayReadyPlayRight class. \r         // It grants the user the ability to playback the content subject to the zero or more restrictions \r         // configured in the license and on the PlayRight itself (for playback specific policy). \r         // Much of the policy on the PlayRight has to do with output restrictions \r         // which control the types of outputs that the content can be played over and \r         // any restrictions that must be put in place when using a given output.\r         // For example, if the DigitalVideoOnlyContentRestriction is enabled, \r         //then the DRM runtime will only allow the video to be displayed over digital outputs \r         //(analog video outputs won’t be allowed to pass the content).\r \r         //IMPORTANT: These types of restrictions can be very powerful but can also affect the consumer experience. \r         // If the output protections are configured too restrictive, \r         // the content might be unplayable on some clients. For more information, see the PlayReady Compliance Rules document.\r \r         // For example:\r         //licenseTemplate.PlayRight.AgcAndColorStripeRestriction = new AgcAndColorStripeRestriction(1);\r \r         responseTemplate.LicenseTemplates.Add(licenseTemplate);\r \r         return MediaServicesLicenseTemplateSerializer.Serialize(responseTemplate);\r     }\r \r \r 若要获取用于密钥授权策略，基于令牌限制的测试令牌，请参阅 [此](#test) 部分。 \r \r ## <a id=\"types\"></a>定义 ContentKeyAuthorizationPolicy 时使用的类型\r ### <a id=\"ContentKeyRestrictionType\"></a>ContentKeyRestrictionType\r     public enum ContentKeyRestrictionType\r     {\r         Open = 0,\r         TokenRestricted = 1,\r         IPRestricted = 2,\r     }\r \r ### <a id=\"ContentKeyDeliveryType\"></a>ContentKeyDeliveryType\r     public enum ContentKeyDeliveryType\r     {\r       None = 0,\r       PlayReadyLicense = 1,\r       BaselineHttp = 2,\r       Widevine = 3\r     }\r \r ### <a id=\"TokenType\"></a>TokenType\r     public enum TokenType\r     {\r         Undefined = 0,\r         SWT = 1,\r         JWT = 2,\r     }\r \r \r ## <a name=\"next-step\"></a>后续步骤\r 现在已配置内容密钥的授权策略，请转到[如何配置资产传送策略](media-services-dotnet-configure-asset-delivery-policy.md)主题。\r \r "}