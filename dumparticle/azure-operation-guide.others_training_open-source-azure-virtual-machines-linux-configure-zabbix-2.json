{"Title":"使用 Zabbix 监控 Nginx","Description":"本文介绍在 Azure Linux 虚拟机上使用 Zabbix 监控 Nginx","Content":"\r #使用 Zabbix 监控 Nginx\r \r 1. Nginx server 必须安装 zabbix agent 软件包，以及打开10050,10051和它的服务端口，比如80. 然后启动 zabbix agent 进程，添加到监控列表。\r \r 2. 查看 nginx server 是否安装了 http_stub_status 模块. 使用 nginx -V 命令检查. 如果没有，重新编译。下面是一个简单示例 (CentOS 7 为例)\r \r 3. 连接到 nginx server , 执行 `$ sudo yum install zlib zlib-devel pcre pcre-devel openssl openssl-devel -y`\r \r 4. 下载，安装 nginx\r \r     ```\r     $ sudo wget http://nginx.org/download/nginx-1.9.8.tar.gz\r     $sudo tar xzvf nginx-1.9.8.tar.gz\r     $cd nginx-1.9.8\r     $sudo ./configure --prefix=/opt/nginx --with-http_stub_status_module --with-http_ssl_module --with-threads\r     $sudo make\r     $sudo make install\r     ```\r \r 5. 编辑 /opt/nginx/conf/nginx.conf, 添加如下红色部分\r \r     ```\r     server {\r         listen       80;\r         server_name  localhost;\r \r         #charset koi8-r;\r \r         #access_log  logs/host.access.log  main;\r \r         location / {\r             root   html;\r             index  index.html index.htm;\r         }\r         location /nginx_status {\r             stub_status on;\t\r         }\r         #error_page  404              /404.html;\r \r         # redirect server error pages to the static page /50x.html\r         #\r         error_page   500 502 503 504  /50x.html;\r         location = /50x.html {\r             root   html;\r     }\r     ```\r 6. 启动 nginx 进程\r \r     ```\r     $sudo /opt/nginx/sbin/nginx\r     ```\r \r 7. 检查 nginx 连接状态. 打开 http://nginx server ip/nginx_status\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/31.png)\r \r 8. Zabbix agent 设置。创建目录\r \r     ```\r     $ sudo mkdir -p /usr/local/zabbix/scripts\r     ```\r \r 9. 编辑 /usr/local/zabbix/etc/zabbix_agentd.conf, 添加如下 \r \r     ```\r     #nginx\r     UserParameter=nginx.accepts,/usr/local/zabbix/scripts/nginx_status.sh accepts\r     UserParameter=nginx.handled,/usr/local/zabbix/scripts/nginx_status.sh handled\r     UserParameter=nginx.requests,/usr/local/zabbix/scripts/nginx_status.sh requests\r     UserParameter=nginx.connections.active,/usr/local/zabbix/scripts/nginx_status.sh active\r     UserParameter=nginx.connections.reading,/usr/local/zabbix/scripts/nginx_status.sh reading\r     UserParameter=nginx.connections.writing,/usr/local/zabbix/scripts/nginx_status.sh writing\r     UserParameter=nginx.connections.waiting,/usr/local/zabbix/scripts/nginx_status.sh waiting\r     ```\r \r 10. 编辑 /usr/local/zabbix/scripts/nginx_status.sh, 内容如下\r \r     ```\r     #!/bin/bash\r \r     # Set Variables\r     BKUP_DATE=`/bin/date +%Y%m%d`\r     LOG=\"/var/log/nginx_status.log\"\r     #HOST=`/sbin/ifconfig eth0 | sed -n '/inet /{s/.*addr://;s/ .*//;p}'`\r     HOST=`/sbin/ifconfig eth0 |sed -n '/inet /{s/.*inet \\([0-9.]\\+\\).*/\\1/p}'`\r     #HOST=`curl ifconfig.me 2>/dev/null`\r     PORT=\"80\"\r     #PORT=\"443\"\r \r     # Functions to return nginx stats\r \r     function active {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| grep 'Active' | awk '{print $NF}' \r             } \r \r     function reading {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| grep 'Reading' | awk '{print $2}' \r             } \r \r     function writing {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| grep 'Writing' | awk '{print $4}' \r             } \r \r     function waiting {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| grep 'Waiting' | awk '{print $6}' \r             } \r \r     function accepts {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| awk NR==3 | awk '{print $1}'\r             } \r \r     function handled {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| awk NR==3 | awk '{print $2}'\r             } \r \r     function requests {\r             /usr/bin/curl -k \"http://$HOST:$PORT/nginx_status\" 2>/dev/null| awk NR==3 | awk '{print $3}'\r             }\r \r     # Run the requested function\r     $1\r     ```\r \r 11. 设置执行权限\r \r     ```\r     $sudo chmod o+x /usr/local/zabbix/scripts/nginx_status.sh\r     ```\r \r 12. 重启 zabbix agent 进程\r \r     ```\r     $sudo /etc/init.d/zabbix_agentd restart\r     ```\r \r 13. 可以去到 [zabbix 模板官网](https://www.zabbix.org/wiki/Zabbix_Templates#Official_templates)下载相应的 nginx 模板并依据相关的指导完成 nginx 模板的导入和设置。步骤14-19是用从 zabbix community 社区找到的 nginx 模板所做的相关测试。模板放置在[链接](https://github.com/joey100/ZabbixTemplates)。下载此 nginx 模板 并关联到 nginx server。（注：此模板非官方提供，由社区贡献，如有顾虑，建议从官网下载 nginx 模板。）\r \r 14. 点击“Configuration” -- > “Templates” -- > “Import”\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/32.png)\r \r 15. 点击 “Browse” -- >选择模板文件, 这里我们选择下载下来的 “nginx_status 2.0.xml”, 点击 “Import”\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/33.png)\r \r 16. 点击 ‘Configuration’ -- > ‘Hosts’ -- > 选择 nginx server\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/34.png)\r \r 17. 点击 “Templates” -- > “Select” -- > 选择 “Nginx Status” 模板 , 点击“Select”, 然后点击 “Add” -- > “Save”\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/35.png)\r \r 18. 然后我们发现 nginx server 的 nginx 状态已经被监控。去到 “Monitoring” -- > “Graphs” -- > 选择 nginx server, 选择“Nginx Socket Status” 图, 会看到类似下图\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/36.png)\r \r 19. 您也可以选择 “Nginx Clients Status” 图。\r \r   ![](./media/open-source-azure-virtual-machines-linux-configure-zabbix-2/37.png)"}