{"Title":"在 Azure 应用程序网关上配置 SSL 策略 - PowerShell","Description":"本页提供有关在 Azure 应用程序网关上配置 SSL 策略的说明","Content":"# <a name=\"configure-ssl-policy-versions-and-cipher-suites-on-application-gateway\"></a>在应用程序网关上配置 SSL 策略版本和密码套件\r \r 了解如何在应用程序网关上配置 SSL 策略版本和密码套件。 [预定义策略列表](#predefined-ssl-policies)中包含各种 SSL 策略版本配置和启用的密码套件，你可从中进行选择。 此外，还可基于自身需求定义[自定义 SSL 策略](#configure-a-custom-ssl-policy)。\r \r ## <a name=\"get-available-ssl-options\"></a>获取可用的 SSL 选项\r \r `Get-AzureRMApplicationGatewayAvailableSslOptions` cmdlet 提供了一列可用的预定义策略、可用的密码套件和可配置的协议版本。 以下示例显示运行此 cmdlet 的示例输出。\r \r ```\r DefaultPolicy: AppGwSslPolicy20150501\r PredefinedPolicies:\r     /subscriptions/147a22e9-2356-4e56-b3de-1f5842ae4a3b/resourceGroups//providers/Microsoft.Network/ApplicationGatewayAvailableSslOptions/default/Applic\r ationGatewaySslPredefinedPolicy/AppGwSslPolicy20150501\r     /subscriptions/147a22e9-2356-4e56-b3de-1f5842ae4a3b/resourceGroups//providers/Microsoft.Network/ApplicationGatewayAvailableSslOptions/default/Applic\r ationGatewaySslPredefinedPolicy/AppGwSslPolicy20170401\r     /subscriptions/147a22e9-2356-4e56-b3de-1f5842ae4a3b/resourceGroups//providers/Microsoft.Network/ApplicationGatewayAvailableSslOptions/default/Applic\r ationGatewaySslPredefinedPolicy/AppGwSslPolicy20170401S\r \r AvailableCipherSuites:\r     TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\r     TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\r     TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384\r     TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256\r     TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA\r     TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA\r     TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\r     TLS_DHE_RSA_WITH_AES_128_GCM_SHA256\r     TLS_DHE_RSA_WITH_AES_256_CBC_SHA\r     TLS_DHE_RSA_WITH_AES_128_CBC_SHA\r     TLS_RSA_WITH_AES_256_GCM_SHA384\r     TLS_RSA_WITH_AES_128_GCM_SHA256\r     TLS_RSA_WITH_AES_256_CBC_SHA256\r     TLS_RSA_WITH_AES_128_CBC_SHA256\r     TLS_RSA_WITH_AES_256_CBC_SHA\r     TLS_RSA_WITH_AES_128_CBC_SHA\r     TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\r     TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\r     TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\r     TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256\r     TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA\r     TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA\r     TLS_DHE_DSS_WITH_AES_256_CBC_SHA256\r     TLS_DHE_DSS_WITH_AES_128_CBC_SHA256\r     TLS_DHE_DSS_WITH_AES_256_CBC_SHA\r     TLS_DHE_DSS_WITH_AES_128_CBC_SHA\r     TLS_RSA_WITH_3DES_EDE_CBC_SHA\r     TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA\r \r AvailableProtocols:\r     TLSv1_0\r     TLSv1_1\r     TLSv1_2\r ```\r \r ## <a name=\"list-pre-defined-ssl-policies\"></a>列出预定义 SSL 策略\r \r 应用程序网关包含 3 个可使用的预定义策略。 `Get-AzureRmApplicationGatewaySslPredefinedPolicy` cmdlet 会检索这些策略。 每个策略启用不同的协议版本和密码套件。 这些预定义策略可用于在应用程序网关上快速配置 SSL 策略。 如果未定义特定 SSL 策略，则默认选择 AppGwSslPolicy20170401。\r \r 以下是运行 `Get-AzureRmApplicationGatewaySslPredefinedPolicy` 的一个示例。\r \r ```\r Name: AppGwSslPolicy20150501\r MinProtocolVersion: TLSv1_0\r CipherSuites:\r     TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\r     TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\r     TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384\r     TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256\r     TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA\r     TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA\r     TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\r     TLS_DHE_RSA_WITH_AES_128_GCM_SHA256\r     TLS_DHE_RSA_WITH_AES_256_CBC_SHA\r     TLS_DHE_RSA_WITH_AES_128_CBC_SHA\r     TLS_RSA_WITH_AES_256_GCM_SHA384\r  ...\r Name: AppGwSslPolicy20170401\r MinProtocolVersion: TLSv1_1\r CipherSuites:\r     TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\r     TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\r     TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA\r     TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA\r     TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256\r     TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\r     TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\r ...\r ```\r \r ## <a name=\"configure-a-custom-ssl-policy\"></a>配置自定义 SSL 策略\r \r 如下示例将在应用程序网关上设置自定义 SSL 策略。 它将最低协议版本设置为 `TLSv1_1`，并启用以下密码套件：\r \r - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\r - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\r \r > [!IMPORTANT]\r > 配置自定义 SSL 策略时，必须在以下列表中至少选择一个密码套件。 应用程序网关使用 RSA SHA256 密码套件进行后端管理。\r > * TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 \r > * TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256\r > * TLS_DHE_RSA_WITH_AES_128_GCM_SHA256\r > * TLS_RSA_WITH_AES_128_GCM_SHA256\r > * TLS_RSA_WITH_AES_256_CBC_SHA256\r > * TLS_RSA_WITH_AES_128_CBC_SHA256\r \r ```powershell\r # get an application gateway resource\r $gw = Get-AzureRmApplicationGateway -Name AdatumAppGateway -ResourceGroup AdatumAppGatewayRG\r \r # set the SSL policy on the application gateway\r Set-AzureRmApplicationGatewaySslPolicy -ApplicationGateway $gw -PolicyType Custom -MinProtocolVersion TLSv1_1 -CipherSuite \"TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\", \"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\", \"TLS_RSA_WITH_AES_128_GCM_SHA256\"\r ```\r \r ## <a name=\"create-an-application-gateway-with-a-pre-defined-ssl-policy\"></a>使用预定义 SSL 策略创建应用程序网关\r \r 如下示例会使用预定义 SSL 策略创建一个新的应用程序网关。\r \r ```powershell\r # Create a resource group\r $rg = New-AzureRmResourceGroup -Name ContosoRG -Location \"China North\"\r # Create a subnet for the application gateway\r $subnet = New-AzureRmVirtualNetworkSubnetConfig -Name subnet01 -AddressPrefix 10.0.0.0/24\r # Create a virtual network with a 10.0.0.0/16 address space\r $vnet = New-AzureRmVirtualNetwork -Name appgwvnet -ResourceGroupName $rg.ResourceGroupName -Location \"China North\" -AddressPrefix 10.0.0.0/16 -Subnet $subnet\r # Retrieve the subnet object for later use\r $subnet = $vnet.Subnets[0]\r # Create a public IP address\r $publicip = New-AzureRmPublicIpAddress -ResourceGroupName $rg.ResourceGroupName -name publicIP01 -location \"China North\" -AllocationMethod Dynamic\r # Create a ip configuration object\r $gipconfig = New-AzureRmApplicationGatewayIPConfiguration -Name gatewayIP01 -Subnet $subnet\r # Create a backend pool for backend web servers\r $pool = New-AzureRmApplicationGatewayBackendAddressPool -Name pool01 -BackendIPAddresses 134.170.185.46, 134.170.188.221,134.170.185.50\r # Define the backend http settings to be used.\r $poolSetting = New-AzureRmApplicationGatewayBackendHttpSettings -Name poolsetting01 -Port 80 -Protocol Http -CookieBasedAffinity Enabled\r # Create a new port for SSL\r $fp = New-AzureRmApplicationGatewayFrontendPort -Name frontendport01  -Port 443\r # Upload an existing pfx certificate for SSL offload\r $cert = New-AzureRmApplicationGatewaySslCertificate -Name cert01 -CertificateFile C:\\folder\\contoso.pfx -Password \"P@ssw0rd\"\r # Create a frontend IP configuration for the public IP address\r $fipconfig = New-AzureRmApplicationGatewayFrontendIPConfig -Name fipconfig01 -PublicIPAddress $publicip\r # Create a new listener with the certificate, port, and frontend ip.\r $listener = New-AzureRmApplicationGatewayHttpListener -Name listener01  -Protocol Https -FrontendIPConfiguration $fipconfig -FrontendPort $fp -SslCertificate $cert\r # Create a new rule for backend traffic routing\r $rule = New-AzureRmApplicationGatewayRequestRoutingRule -Name rule01 -RuleType Basic -BackendHttpSettings $poolSetting -HttpListener $listener -BackendAddressPool $pool\r # Define the size of the application gateway\r $sku = New-AzureRmApplicationGatewaySku -Name Standard_Small -Tier Standard -Capacity 2\r # Configure the SSL policy to use a different pre-defined policy\r $policy = New-AzureRmApplicationGatewaySslPolicy -PolicyType Predefined -PolicyName AppGwSslPolicy20170401S\r # Create the application gateway.\r $appgw = New-AzureRmApplicationGateway -Name appgwtest -ResourceGroupName $rg.ResourceGroupName -Location \"China North\" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting -FrontendIpConfigurations $fipconfig  -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener -RequestRoutingRules $rule -Sku $sku -SslCertificates $cert -SslPolicy $policy\r ```\r \r ## <a name=\"next-steps\"></a>后续步骤\r \r 请访问[应用程序网关重定向概述](application-gateway-redirect-overview.md)，了解如何将 HTTP 流量重定向至 HTTPS 终结点。\r \r "}