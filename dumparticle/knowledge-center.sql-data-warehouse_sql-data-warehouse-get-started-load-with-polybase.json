{"Title":"SQL 数据仓库中的 PolyBase 教程","Description":"了解什么是 PolyBase，以及如何将其用于数据仓库方案。","Content":"# <a name=\"load-data-with-polybase-in-sql-data-warehouse\"></a>在 SQL 数据仓库中使用 PolyBase 加载数据\r \r > [!div class=\"op_single_selector\"]\r > * [Redgate](sql-data-warehouse-load-with-redgate.md)  \r > * [PolyBase](sql-data-warehouse-get-started-load-with-polybase.md)  \r > * [BCP](sql-data-warehouse-load-with-bcp.md)\r > \r > \r <!-- Data Factory not supported on Azure.cn-->\r <!-- - [Data Factory](sql-data-warehouse-get-started-load-with-azure-data-factory.md)-->\r \r 本教程说明如何使用 AzCopy 和 PolyBase 将数据载入 SQL 数据仓库。 完成后，可以了解如何：\r \r * 使用 AzCopy 将数据复制到 Azure Blob 存储\r * 创建数据库对象以定义数据\r * 运行 T-SQL 查询以加载数据\r \r <!-- Not Available [!VIDEO https://channel9.msdn.com/Blogs/Azure/Loading-data-with-PolyBase-in-Azure-SQL-Data-Warehouse/player] -->\r ## <a name=\"prerequisites\"></a>先决条件\r 若要逐步完成本教程，需要：\r \r * 一个 SQL 数据仓库数据库。\r * 一个标准本地冗余存储 (Standard-LRS)、标准异地冗余存储 (Standard-GRS) 或标准读取访问权限异地冗余存储 (Standard-RAGRS) 类型的 Azure 存储帐户。\r * AzCopy 命令行实用工具。 下载并安装 Azure 存储工具随附的 [最新版本的 AzCopy][latest version of AzCopy] 。\r \r     ![Azure 存储工具](./media/sql-data-warehouse-get-started-load-with-polybase/install-azcopy.png)\r \r ## <a name=\"step-1-add-sample-data-to-azure-blob-storage\"></a>步骤 1：将示例数据添加到 Azure Blob 存储\r 为了加载数据，我们需要将一些示例数据放入 Azure Blob 存储。 在此步骤中，我们会将示例数据填入 Azure 存储 Blob。 稍后，我们会使用 PolyBase 将这些示例数据加载到 SQL 数据仓库数据库。\r \r ### <a name=\"a-prepare-a-sample-text-file\"></a>A. 准备一个示例文本文件\r 若要准备示例文本文件，请执行以下操作：\r \r 1. 打开“记事本”并将以下数据行复制到一个新文件。 将此文件保存到本地临时目录，路径为 %temp%\\DimDate2.txt。\r \r ```\r 20150301,1,3\r 20150501,2,4\r 20151001,4,2\r 20150201,1,3\r 20151201,4,2\r 20150801,3,1\r 20150601,2,4\r 20151101,4,2\r 20150401,2,4\r 20150701,3,1\r 20150901,3,1\r 20150101,1,3\r ```\r \r ### <a name=\"b-find-your-blob-service-endpoint\"></a>B. 查找 Blob 服务终结点\r 要查找 Blob 服务终结点，请执行以下操作：\r \r 1. 在 Azure 门户中，选择“浏览” > “存储帐户”。\r 2. 单击要使用的存储帐户。\r 3. 在“存储帐户”边栏选项卡中，单击“Blob”\r \r     ![单击“Blob”](./media/sql-data-warehouse-get-started-load-with-polybase/click-blobs.png)\r \r 4. 保存 Blob 服务终结点 URL 以供以后使用。\r \r     ![Blob 服务终结点](./media/sql-data-warehouse-get-started-load-with-polybase/blob-service.png)\r \r ### <a name=\"c-find-your-azure-storage-key\"></a>C. 查找 Azure 存储密钥\r 要查找 Azure 存储密钥，请执行以下操作：\r \r 1. 在 Azure 门户中，选择“浏览” > “存储帐户”。\r 2. 单击要使用的存储帐户。\r 3. 选择“所有设置” > “访问密钥”。\r 4. 单击复制框，将访问密钥之一复制到剪贴板。\r \r     ![复制 Azure 存储密钥](./media/sql-data-warehouse-get-started-load-with-polybase/access-key.png)\r \r ### <a name=\"d-copy-the-sample-file-to-azure-blob-storage\"></a>D. 将示例文件复制到 Azure Blob 存储\r 要将数据复制到 Azure Blob 存储，请执行以下操作：\r \r 1. 打开命令提示符，并将目录更改为 AzCopy 安装目录。 此命令可将目录更改为 64 位 Windows 客户端上的默认安装目录。\r \r     ```\r     cd /d \"%ProgramFiles(x86)%\\Microsoft SDKs\\Azure\\AzCopy\"\r     ```\r \r 2. 运行以下命令以上传该文件。 指定 <blob service endpoint URL> 的 BLOB 服务终结点 URL，以及 <azure_storage_account_key> 的 Azure 存储帐户密钥。\r \r     ```\r     .\\AzCopy.exe /Source:C:\\Temp\\ /Dest:<blob service endpoint URL> /datacontainer/datedimension/ /DestKey:<azure_storage_account_key> /Pattern:DimDate2.txt\r     ```\r \r 另请参阅 [AzCopy 命令行实用工具入门][Getting Started with the AzCopy Command-Line Utility]。\r \r ### <a name=\"e-explore-your-blob-storage-container\"></a>E. 浏览 Blob 存储容器\r 若要查看已上传到 Blob 存储的文件，请执行以下操作：\r \r 1. 返回 Blob 服务边栏选项卡。\r 2. 在“容器”下，双击“datacontainer”。\r 3. 如果要浏览数据的路径，请单击文件夹 **datedimension**，并将看到已上传的文件 **DimDate2.txt**。\r 4. 若要查看属性，请单击“DimDate2.txt”。\r 5. 请注意，在 Blob 属性边栏选项卡中，可以下载或删除该文件。\r \r     ![查看 Azure 存储 Blob](./media/sql-data-warehouse-get-started-load-with-polybase/view-blob.png)\r \r ## <a name=\"step-2-create-an-external-table-for-the-sample-data\"></a>步骤 2：为示例数据创建外部表\r 在本部分中，我们创建一个用于定义示例数据的外部表。\r \r PolyBase 使用外部表访问 Azure Blob 存储中的数据。 由于数据不是存储在 SQL 数据仓库中，PolyBase 使用数据库范围的凭据处理对外部数据的身份验证。\r \r 本步骤中的示例使用这些 Transact-SQL 语句来创建外部表。\r \r * [Create Master Key (Transact-SQL)][Create Master Key (Transact-SQL)]：加密数据库范围凭据的机密。\r * [Create Database Scoped Credential (Transact-SQL)][Create Database Scoped Credential (Transact-SQL)]：指定 Azure 存储帐户的身份验证信息。\r * [Create External Data Source (Transact-SQL)][Create External Data Source (Transact-SQL)]：指定 Azure Blob 存储的位置。\r * [Create External File Format (Transact-SQL)][Create External File Format (Transact-SQL)]：指定数据的格式。\r * [Create External Table (Transact-SQL)][Create External Table (Transact-SQL)]：指定表定义和数据的位置。\r \r 请针对 SQL 数据仓库数据库运行此查询。 它会在 dbo 架构中创建指向 Azure Blob 存储中 DimDate2.txt 示例数据的外部表（名为 DimDate2External）。\r \r ```sql\r -- A: Create a master key.\r -- Only necessary if one does not already exist.\r -- Required to encrypt the credential secret in the next step.\r \r CREATE MASTER KEY;\r \r -- B: Create a database scoped credential\r -- IDENTITY: Provide any string, it is not used for authentication to Azure storage.\r -- SECRET: Provide your Azure storage account key.\r \r CREATE DATABASE SCOPED CREDENTIAL AzureStorageCredential\r WITH\r     IDENTITY = 'user',\r     SECRET = '<azure_storage_account_key>'\r ;\r \r -- C: Create an external data source\r -- TYPE: HADOOP - PolyBase uses Hadoop APIs to access data in Azure blob storage.\r -- LOCATION: Provide Azure storage account name and blob container name.\r -- CREDENTIAL: Provide the credential created in the previous step.\r \r CREATE EXTERNAL DATA SOURCE AzureStorage\r WITH (\r     TYPE = HADOOP,\r     LOCATION = 'wasbs://<blob_container_name>@<azure_storage_account_name>.blob.core.chinacloudapi.cn',\r     CREDENTIAL = AzureStorageCredential\r );\r \r -- D: Create an external file format\r -- FORMAT_TYPE: Type of file format in Azure storage (supported: DELIMITEDTEXT, RCFILE, ORC, PARQUET).\r -- FORMAT_OPTIONS: Specify field terminator, string delimiter, date format etc. for delimited text files.\r -- Specify DATA_COMPRESSION method if data is compressed.\r \r CREATE EXTERNAL FILE FORMAT TextFile\r WITH (\r     FORMAT_TYPE = DelimitedText,\r     FORMAT_OPTIONS (FIELD_TERMINATOR = ',')\r );\r \r -- E: Create the external table\r -- Specify column names and data types. This needs to match the data in the sample file.\r -- LOCATION: Specify path to file or directory that contains the data (relative to the blob container).\r -- To point to all files under the blob container, use LOCATION='.'\r \r CREATE EXTERNAL TABLE dbo.DimDate2External (\r     DateId INT NOT NULL,\r     CalendarQuarter TINYINT NOT NULL,\r     FiscalQuarter TINYINT NOT NULL\r )\r WITH (\r     LOCATION='/datedimension/',\r     DATA_SOURCE=AzureStorage,\r     FILE_FORMAT=TextFile\r );\r \r -- Run a query on the external table\r \r SELECT count(*) FROM dbo.DimDate2External;\r ```\r \r 在 Visual Studio 的 SQL Server 对象资源管理器中，可以看到外部文件格式、外部数据源和 DimDate2External 表。\r \r ![查看外部表](./media/sql-data-warehouse-get-started-load-with-polybase/external-table.png)\r \r ## <a name=\"step-3-load-data-into-sql-data-warehouse\"></a>步骤 3：将数据加载到 SQL 数据仓库\r 创建外部表后，可以将数据载入新表，或将其插入到现有表。\r \r * 要将数据载入新表，请运行 [CREATE TABLE AS SELECT (Transact-SQL)][CREATE TABLE AS SELECT (Transact-SQL)] 语句。 新表包含查询中指定的列。 列的数据类型将与外部表定义中的数据类型匹配。\r * 要将数据载入现有表，请使用 [INSERT...SELECT (Transact-SQL)][INSERT...SELECT (Transact-SQL)] 语句。\r \r ```sql\r -- Load the data from Azure blob storage to SQL Data Warehouse\r \r CREATE TABLE dbo.DimDate2\r WITH\r (   \r     CLUSTERED COLUMNSTORE INDEX,\r     DISTRIBUTION = ROUND_ROBIN\r )\r AS\r SELECT * FROM [dbo].[DimDate2External];\r ```\r \r ## <a name=\"step-4-create-statistics-on-your-newly-loaded-data\"></a>步骤 4：基于新加载的数据创建统计信息\r SQL 数据仓库不会自动创建或自动更新统计信息。 因此，若要实现较高的查询性能，必须在首次加载后基于每个表的每个列创建统计信息。 此外，在对数据做出重大更改后，必须更新统计信息。\r \r 本示例基于新的 DimDate2 表创建单列统计信息。\r \r ```sql\r CREATE STATISTICS [DateId] on [DimDate2] ([DateId]);\r CREATE STATISTICS [CalendarQuarter] on [DimDate2] ([CalendarQuarter]);\r CREATE STATISTICS [FiscalQuarter] on [DimDate2] ([FiscalQuarter]);\r ```\r \r 若要了解详细信息，请参阅 [统计信息][Statistics]。  \r \r ## <a name=\"next-steps\"></a>后续步骤\r 有关在开发使用 PolyBase 的解决方案时应了解的其他信息，请参阅 [PolyBase 指南][PolyBase guide] 。\r \r <!--Image references-->\r \r <!--Article references-->\r [PolyBase in SQL Data Warehouse Tutorial]: ./sql-data-warehouse-get-started-load-with-polybase.md\r [Load data with bcp]: ./sql-data-warehouse-load-with-bcp.md\r [Statistics]: ./sql-data-warehouse-tables-statistics.md\r [PolyBase guide]: ./sql-data-warehouse-load-polybase-guide.md\r [Getting Started with the AzCopy Command-Line Utility]:../storage/common/storage-use-azcopy.md\r [latest version of AzCopy]:../storage/common/storage-use-azcopy.md\r \r <!--External references-->\r <!-- Not Available [supported source/sink]: https://msdn.microsoft.com/library/dn894007.aspx /data-factory/data-factory-data-movement-activities.md-->\r <!-- Not Available [copy activity]: https://msdn.microsoft.com/library/dn835035.aspx /data-factory/data-factory-data-movement-activities-->\r [SQL Server destination adapter]: https://msdn.microsoft.com/library/ms141095.aspx\r [SSIS]: https://msdn.microsoft.com/library/ms141026.aspx\r \r [CREATE EXTERNAL DATA SOURCE (Transact-SQL)]:https://msdn.microsoft.com/library/dn935022.aspx\r [CREATE EXTERNAL FILE FORMAT (Transact-SQL)]:https://msdn.microsoft.com/library/dn935026.aspx\r [CREATE EXTERNAL TABLE (Transact-SQL)]:https://msdn.microsoft.com/library/dn935021.aspx\r \r [DROP EXTERNAL DATA SOURCE (Transact-SQL)]:https://msdn.microsoft.com/library/mt146367.aspx\r [DROP EXTERNAL FILE FORMAT (Transact-SQL)]:https://msdn.microsoft.com/library/mt146379.aspx\r [DROP EXTERNAL TABLE (Transact-SQL)]:https://msdn.microsoft.com/library/mt130698.aspx\r \r [CREATE TABLE AS SELECT (Transact-SQL)]:https://msdn.microsoft.com/library/mt204041.aspx\r [INSERT...SELECT (Transact-SQL)]:https://msdn.microsoft.com/library/ms174335.aspx\r [CREATE MASTER KEY (Transact-SQL)]:https://msdn.microsoft.com/library/ms174382.aspx\r [CREATE CREDENTIAL (Transact-SQL)]:https://msdn.microsoft.com/library/ms189522.aspx\r [CREATE DATABASE SCOPED CREDENTIAL (Transact-SQL)]:https://msdn.microsoft.com/library/mt270260.aspx\r [DROP CREDENTIAL (Transact-SQL)]:https://msdn.microsoft.com/library/ms189450.aspx\r \r <!--Update_Description: wording update, wording update-->"}