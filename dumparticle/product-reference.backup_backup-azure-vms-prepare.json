{"Title":"准备好环境以备份 Azure 虚拟机","Description":"确保对环境进行准备，以便在 Azure 中备份虚拟机","Content":"# <a name=\"prepare-your-environment-to-back-up-azure-virtual-machines\"></a>准备环境以便备份 Azure 虚拟机\r > [!div class=\"op_single_selector\"]\r > * [Resource Manager 模型](backup-azure-arm-vms-prepare.md)\r > * [经典模型](backup-azure-vms-prepare.md)\r >\r >\r \r 在备份 Azure 虚拟机 (VM) 之前，必须满足三个条件。\r \r - 需要*在与 VM 相同的区域*中创建备份保管库，或标识现有的备份保管库。\r - 在 Azure 公共 Internet 地址和 Azure 存储终结点之间建立网络连接。\r - 在 VM 上安装 VM 代理。\r \r 如果确定环境满足这些条件，请转到[备份 VM 的文章](backup-azure-vms.md)。 否则，请继续阅读本文，它将引导逐步完成准备环境以便备份 Azure VM 的过程。\r \r ##<a name=\"supported-operating-system-for-backup\"></a>支持用于备份的操作系统\r  - **Linux**：Azure 备份支持 [Azure 认可的分发版列表](../virtual-machines/linux/endorsed-distros.md?toc=%2fvirtual-machines%2flinux%2ftoc.json) ，但 Core OS Linux 除外。 _只要虚拟机上装有 VM 代理且支持 Python，其他自带 Linux 分发版应该也能正常运行。但是，我们不赞同将这些分发版用于备份。_\r  - **Windows Server**：不支持低于 Windows Server 2008 R2 的版本。\r \r \r ## <a name=\"limitations-when-backing-up-and-restoring-a-vm\"></a>备份和还原 VM 时的限制\r > [!NOTE]\r > Azure 有两种用于创建和使用资源的部署模型：[Resource Manager 部署模型和经典部署模型](../azure-resource-manager/resource-manager-deployment-model.md)。 以下列表提供了在经典模型中部署时的限制。\r >\r >\r \r - 不支持备份拥有 16 个以上数据磁盘的虚拟机。\r - 不支持备份使用保留 IP 地址且未定义终结点的虚拟机。\r - 备份数据不包括连接到 VM 的网络挂载驱动器。\r - 不支持在还原过程中替换现有虚拟机。 首先删除现有虚拟机以及任何关联的磁盘，然后从备份还原数据。\r - 不支持跨区域备份和恢复。\r - Azure 的所有公共区域都支持使用 Azure 备份服务来备份虚拟机（请参阅受支持区域的[清单](https://azure.microsoft.com/regions/#services)）。 在创建保管库期间，如果要寻找的区域目前不受支持，则不会在下拉列表中显示它。\r - 只有特定操作系统版本才支持使用 Azure 备份服务备份虚拟机：\r - 仅支持通过 PowerShell 还原属于多 DC 配置的域控制器 (DC) VM。 阅读有关[还原多 DC 域控制器](backup-azure-restore-vms.md#restoring-domain-controller-vms)的详细信息。\r - 仅支持通过 PowerShell 还原采用以下特殊网络配置的虚拟机。 还原操作完成后，在 UI 中使用还原工作流创建的虚拟机将不采用这些网络配置。 若要了解详细信息，请参阅[还原采用特殊网络配置的 VM](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations)。\r   - 采用负载均衡器配置的虚拟机（内部和外部）\r   - 使用多个保留 IP 地址的虚拟机\r   - 使用多个网络适配器的虚拟机\r \r ## <a name=\"create-a-backup-vault-for-a-vm\"></a>为 VM 创建备份保管库\r 备份保管库是存储所有按时间创建的备份和恢复点的实体。 备份保管库还包含会应用到要备份的虚拟机的备份策略。\r \r > [!IMPORTANT]\r > 从 2017 年 3 月开始，无法再使用经典管理门户来创建备份保管库。 仍支持现有备份保管库，并且可以[使用 Azure PowerShell 创建备份保管库](./backup-client-automation-classic.md#create-a-backup-vault)。 不过，Microsoft 建议为所有部署创建恢复服务保管库，因为将来只会对恢复服务保管库进行增强。\r \r \r 下图显示了各种 Azure 备份实体之间的关系：![Azure 备份实体和关系](./media/backup-azure-vms-prepare/vault-policy-vm.png)\r \r \r \r ## <a name=\"network-connectivity\"></a>网络连接\r 为了管理 VM 快照，备份扩展需要连接 Azure 公共 IP 地址。 如果未建立适当的 Internet 连接，虚拟机的 HTTP 请求会超时，并且备份操作会失败。 如果部署中配置了访问限制（如通过网络安全组 (NSG)），请选择其中一个选项来提供备份流量的明确路径：\r \r - [Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=42064)（将 Azure 数据中心 IP 范围加入允许列表）— 请参阅相关文章，获取有关如何将 IP 地址加入允许列表的说明。\r - 部署 HTTP 代理服务器来路由流量。\r \r 确定要使用的选项时，需在可管理性、精度控制和成本之间进行取舍。\r \r | 选项 | 优点 | 缺点 |\r | --- | --- | --- |\r | 将 IP 范围加入允许列表 |无额外成本。<br><br>若要在 NSG 中打开访问权限，请使用 <i>Set-AzureNetworkSecurityRule</i> cmdlet。 |管理起来很复杂，因为受影响的 IP 范围会不断变化。<br><br>允许访问整个 Azure，而不只是存储。 |\r | HTTP 代理 |允许在代理中对存储 URL 进行精细控制。 若要在代理中设置精细控制，需要将 https://\\*.blob.core.chinacloudapi.cn/\\* URL 模式加入允许列表。 若要仅将 VM 使用的存储帐户加入允许列表，需要将 https://\\<storageAccount\\>.blob.core.chinacloudapi.cn/\\* URL 模式加入允许列表。 <br>对 VM 进行单点 Internet 访问。<br>不受 Azure IP 地址变化的影响。 |通过代理软件运行 VM 带来的额外成本。 |\r \r ### <a name=\"whitelist-the-azure-datacenter-ip-ranges\"></a>Whitelist the Azure datacenter IP ranges\r 若要将 Azure 数据中心 IP 范围加入允许列表，请参阅 [Azure 网站](http://www.microsoft.com/en-us/download/details.aspx?id=42064)，获取有关 IP 范围的详细信息和说明。\r \r ### <a name=\"using-an-http-proxy-for-vm-backups\"></a>使用 HTTP 代理进行 VM 备份\r 备份 VM 时，VM 上的备份扩展会使用 HTTPS API 将快照管理命令发送到 Azure 存储。 将通过 HTTP 代理路由备份扩展流量，因为它是为了访问公共 Internet 而配置的唯一组件。\r \r > [!NOTE]\r > 至于应该使用何种代理软件，我们不提供任何建议。 请确保所选代理具有出站粘性且可用于执行以下配置步骤。 请确保第三方软件不修改代理设置\r >\r >\r \r 以下示例图像显示了使用 HTTP 代理所要执行的三个配置步骤：\r \r - 应用程序 VM 通过代理 VM 路由所有发往公共 Internet 的 HTTP 流量。\r - 代理 VM 允许来自虚拟网络中 VM 的传入流量。\r - 名为 NSF-lockdown 的网络安全组 (NSG) 需要一个安全规则来允许代理 VM 的出站 Internet 流量。\r \r ![NSG 与 HTTP 代理部署图](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)\r \r 若要使用 HTTP 代理来与公共 Internet 通信，请遵循以下步骤：\r \r #### <a name=\"step-1-configure-outgoing-network-connections\"></a>步骤 1。 配置传出网络连接\r ###### <a name=\"for-windows-machines\"></a>对于 Windows 计算机\r 将设置本地系统帐户的代理服务器配置。\r \r 1. 下载 [PsExec](https://technet.microsoft.com/sysinternals/bb897553)\r 2. 在提升的提示符下运行以下命令：\r \r      ```\r      psexec -i -s \"c:\\Program Files\\Internet Explorer\\iexplore.exe\"\r      ```\r      该命令将打开 Internet Explorer 窗口。\r 3. 转到“工具”->“Internet 选项”->“连接”->“LAN 设置”。\r 4. 验证系统帐户的代理设置。 设置代理 IP 和端口。\r 5. 关闭 Internet Explorer。\r \r 这样就会设置计算机范围的代理配置，可以用于任何传出的 HTTP/HTTPS 流量。\r \r 如果已在当前用户帐户（非本地系统帐户）中设置代理服务器，请使用以下脚本将设置应用到 SYSTEMACCOUNT：\r \r ```\r    $obj = Get-ItemProperty -Path Registry::\"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections\"\r    Set-ItemProperty -Path Registry::\"HKEY_USERS\\S-1-5-18\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections\" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings\r    Set-ItemProperty -Path Registry::\"HKEY_USERS\\S-1-5-18\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections\" -Name SavedLegacySettings -Value $obj.SavedLegacySettings\r    $obj = Get-ItemProperty -Path Registry::\"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\"\r    Set-ItemProperty -Path Registry::\"HKEY_USERS\\S-1-5-18\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" -Name ProxyEnable -Value $obj.ProxyEnable\r    Set-ItemProperty -Path Registry::\"HKEY_USERS\\S-1-5-18\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" -Name Proxyserver -Value $obj.Proxyserver\r ```\r \r > [!NOTE]\r > 如果在代理服务器日志中发现“(407)需要代理身份验证”，请检查身份验证设置是否正确。\r >\r >\r \r ###### <a name=\"for-linux-machines\"></a>对于 Linux 计算机\r 将以下代码行添加到 ```/etc/environment``` 文件：\r \r ```\r http_proxy=http://<proxy IP>:<proxy port>\r ```\r \r 将以下代码行添加到 ```/etc/waagent.conf``` 文件：\r \r ```\r HttpProxy.Host=<proxy IP>\r HttpProxy.Port=<proxy port>\r ```\r \r #### <a name=\"step-2-allow-incoming-connections-on-the-proxy-server\"></a>步骤 2. 在代理服务器上允许传入连接：\r 1. 在代理服务器上打开 Windows 防火墙。 访问防火墙的最简单方法是搜索“具有高级安全性的 Windows 防火墙”。\r \r     ![打开防火墙](./media/backup-azure-vms-prepare/firewall-01.png)\r 2. 在“Windows 防火墙”对话框中，右键单击“**入站规则**”，并单击“**新建规则...**”。\r \r     ![创建新规则](./media/backup-azure-vms-prepare/firewall-02.png)\r 3. 在“**新建入站规则向导**”中针对“**规则类型**”选择“**自定义**”选项，并单击“**下一步**”。\r 4. 若要在页面上选择“程序”，可先选择“所有程序”，并后单击“下一步”。\r 5. 在“**协议和端口**”页面上输入以下信息，并单击“**下一步**”：\r \r     ![创建新规则](./media/backup-azure-vms-prepare/firewall-03.png)\r \r    - 对于“*协议类型*”，请选择 *TCP*\r    - 对于“*本地端口*”，请选择“*特定端口*”，并在下面的字段中指定已配置的 ```<Proxy Port>```。\r    - 对于“*远程端口*”，请选择“*所有端口*”\r \r      至于该向导的其余部分，可一路单击到最后，并为此规则指定一个名称。\r \r #### <a name=\"step-3-add-an-exception-rule-to-the-nsg\"></a>步骤 3. 向 NSG 添加例外规则：\r 在 Azure PowerShell 命令提示符下输入以下命令：\r \r 以下命令在 NSG 中添加一个例外。 此例外允许从 10.0.0.5 上的任何端口流向端口 80 (HTTP) 或 443 (HTTPS) 上的任何 Internet 地址的 TCP 流量。 如果需要访问公共 Internet 中的特定端口，请确保也将该端口添加到 ```-DestinationPortRange```。\r \r ```\r Get-AzureNetworkSecurityGroup -Name \"NSG-lockdown\" |\r Set-AzureNetworkSecurityRule -Name \"allow-proxy \" -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix \"10.0.0.5/32\" -SourcePortRange \"*\" -DestinationAddressPrefix Internet -DestinationPortRange \"80-443\"\r ```\r \r \r             *确保使用与部署相对应的详细信息替换示例中的名称。*\r \r ## <a name=\"vm-agent\"></a>VM 代理\r 在备份 Azure 虚拟机之前，应确保 Azure VM 代理已正确安装到虚拟机上。 由于创建虚拟机时 VM 代理是可选组件，因此请确保选中 VM 代理的复选框，再对虚拟机进行预配。\r \r ### <a name=\"manual-installation-and-update\"></a>手动安装和更新\r VM 代理已存在于从 Azure 库创建的 VM 中。 但是，从本地数据中心迁移的虚拟机上未安装 VM 代理。 对于此类 VM，必须显式安装 VM 代理。 \r \r | **操作** | **Windows** | **Linux** |\r | --- | --- | --- |\r | 安装 VM 代理 |下载并安装 [代理 MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)。 需要管理员权限才能完成安装。<li>[更新 VM 属性](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) ，指明已安装代理。 |<li> 安装最新的 [Linux 代理](../virtual-machines/linux/agent-user-guide.md)。 需要管理员权限才能完成安装。 我们建议从分发存储库安装代理。 我们 **不建议** 直接从 github 安装 Linux VM 代理。  |\r | 更新 VM 代理 |更新 VM 代理与重新安装 [VM 代理二进制文件](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)一样简单。 <br>确保在更新 VM 代理时，没有任何正在运行的备份操作。 |按照[更新 Linux VM 代理](../virtual-machines/linux/update-agent.md?toc=%2fvirtual-machines%2flinux%2ftoc.json)中的说明进行操作。 我们建议从分发存储库更新代理。 我们**不建议**直接从 github 更新 Linux VM 代理。<br>确保在更新 VM 代理时，没有任何正在运行的备份操作。 |\r | 验证 VM 代理安装 |<li>导航到 Azure VM 中的 *C:\\WindowsAzure\\Packages* 文件夹。 <li>应会发现 WaAppAgent.exe 文件已存在。<li> 右键单击该文件，转到“**属性**”，并选择“**详细信息**”选项卡。“产品版本”字段应为 2.6.1198.718 或更高。 |不适用 |\r \r 了解 [VM 代理](/virtual-machines/windows/extensions-features)以及[如何安装它](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/)。\r \r ### <a name=\"backup-extension\"></a>备份扩展\r 为了备份虚拟机，Azure 备份服务会将扩展安装到 VM 代理上。 Azure 备份服务会无缝地升级和修补备份扩展，不需用户进行额外的干预。\r \r 如果 VM 正在运行，则会安装备份扩展。 运行中的 VM 最可能获得应用程序一致的恢复点。 但是，即使 VM 已关闭并且无法安装扩展（即脱机 VM），Azure 备份服务也会继续备份 VM。 在这种情况下，恢复点将是*崩溃一致性*恢复点，如上文所述。\r \r ## <a name=\"questions\"></a>存在疑问？\r 如果有疑问，或者希望包含某种功能，请 [给我们反馈](http://aka.ms/azurebackup_feedback)。\r \r ## <a name=\"next-steps\"></a>后续步骤\r 现在已准备好环境来备份 VM，下一个逻辑步骤是创建备份。 “计划”一文提供了有关备份 VM 的更详细信息。\r \r - [备份虚拟机](backup-azure-vms.md)\r - [规划 VM 备份基础结构](backup-azure-vms-introduction.md)\r - [管理虚拟机备份](backup-azure-manage-vms.md)\r \r <!--Update_Description: wording update-->\r "}