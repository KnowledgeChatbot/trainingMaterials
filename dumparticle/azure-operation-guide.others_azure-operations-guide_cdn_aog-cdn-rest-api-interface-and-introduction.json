{"Title":"CDN REST 接口调用及说明","Description":"CDN REST 接口调用及说明","Content":"# CDN REST 接口调用及说明\r \r 有些客户在尝试使用 REST 接口访问 CDN 服务会遇到了一些问题，导致调用失败。比如，在请求时不清楚 Authorization 的构建、或者在构建 Authorization 时出现各种异常，这篇文章将对这些问题进行解答。\r \r 需要注意的是，目前 CDN 提供了两套 REST 接口，一套是 ASM（经典模式），另外一套是 ARM（资源管理器），API 接口地址参考：\r \r - ASM CDN：https://docs.azure.cn/zh-cn/cdn/cdn-api \r - ARM CDN：https://docs.microsoft.com/zh-cn/rest/api/cdn/\r \r 本节我们重点介绍以下 3 个 ASM CDN REST 接口的使用，如果对于 ARM CDN 的使用有更多问题，可以联系通过 400-085-0319 联系开发技术支持团队。\r \r - [创建节点 (JAVA 示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-create-endpoint)\r - [节点管理 - 获取节点信息 (JAVA 示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-get-endpoint)\r - [缓存刷新 (C#示例)](https://docs.azure.cn/zh-cn/cdn/cdn-api-add-purge)\r \r ## 创建节点调用详解\r \r - Endpoint：\r \r     `POST https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints?apiVersion=1.0`\r \r - 请求参数：\r \r     | 参数名称 | 参数值 |\r     | ------- | ------ |\r     | x-azurecdn-request-date | 必填。符合 yyyy-MM-dd hh:mm:ss 格式的 UTC 当前请求时间 |\r     | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r     | content-type |\t必填。application/json |\r     | Body | 必填。参考 API 连接中的解释 |\r \r     这里我们主要解释 Authorization 的生成，[CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature)中提供了不同语言生成认证头的代码示例，这里我们以 Java 作为说明，方法定义如下：\r \r     ```Java\r     public static String calculateAuthorizationHeader(\r         String requestURL, \r         String requestTime, \r         String keyID, \r         String keyValue, \r         String httpMethod) throws Exception {\r     …\r     }\r     ```\r \r - requestURL\r \r     即填充后的 Endpoint 值，subscriptionId 需要设置为实际值，参考示例：\r     https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints?apiVersion=1.0\r \r - requestTime\r \r     该参数的设置与请求中 `x-azurecdn-request-date` 的值一致，符合 `yyyy-MM-dd hh:mm:ss` 格式的 UTC 时间即可。参数示例：\r \r     `2017-09-01 09:00:00`\r \r - keyID 与 keyValue\r \r     通过 Azure 门户登录 CDN 节点管理门户，在 “**安全管理**” - “**秘钥管理**” 中获取秘钥，需要注意的是，秘钥的读写权限需要与请求的 URL 方法权限吻合。比如 “**Post**” 或 “**Put**” 类的请求，需要 “**写**” 权限的秘钥，对于 “**Get**” 请求则需要 “**读**” 权限的秘钥。\r \r     ![portal](media/aog-cdn-rest-api-interface-and-introduction/portal.png)\r \r - httpMethod\r \r     请求方法类型，参数值示例：`POST`。\r \r ### 测试用例\r \r ```Java\r String requestURL = \"https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints?apiVersion=1.0\";\r  \r String requestTimestamp = TimeUtil.getUTCTime();\r String keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r String keyValue = \"<cdn-key>\";\r String httpMethod = \"POST\";\r \r CdnOperation cOperation = new CdnOperation();\r String authorization = cOperation.calculateAuthorizationHeader(\r             requestURL, \r             requestTimestamp,\r             keyID, \r             keyValue, \r             httpMethod);\r             \r // 创建节点\r String requestBody = Files.toString(\r new File(\"D:\\\\workspace\\\\java\\\\azure-cdn-\r demo\\\\src\\\\test\\\\java\\\\geo\\\\azure\\\\cdn\\\\request_body.json\",\r             Charsets.UTF_8);\r \r String result = cOperation.postRequest(\r             requestURL,\r             authorization, \r             requestBody,\r             requestTimestamp);\r System.out.println(result);\r \r 2017-7-26 5:37:18\r AzureCDN cc65a046-2a32-4f7d-ab22-9ae49507d719:CB82B4555573CCE40FF2BAB1C5AA256C35CFDA5175F4B3E7C5A4905A98E08BF9\r {\"EndpointId\":\"8137ecc4-71c4-11e7-8259-0017fa00a611\",\"Settings\":{\"CustomDomain\":\"file.azurecloudapi.cn\",\"Host\":\"file.azurecloudapi.cn\",\"Origin\":{\"Addresses\":[\"devstoragerm.blob.core.chinacloudapi.cn\"]},\"ICP\":\"?ICP?16013159?\",\"ServiceType\":\"Download\",\"AllowedScheme\":0},\"Status\":{\"Enabled\":false,\"IcpVerifyStatus\":\"IcpVerifying\",\"LifetimeStatus\":\"Creating\",\"CNameConfigured\":false,\"FreeTrialExpired\":false,\"TimeLastUpdated\":\"2017-07-26T05:37:47.4718609+00:00\"}}\r ```\r \r ## 获取节点信息调用详解\r \r - Endpoint\r \r     `GET https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints/{endpointId}?apiVersion=1.0`\r \r - 请求参数\r \r     | 参数名称 | 参数值 |\r     | ------- | ------ |\r     | x-azurecdn-request-date | 必填。符合yyyy-MM-dd hh:mm:ss格式的UTC当前请求时间 |\r     | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r \r ### 测试用例\r \r ```Java\r String requestURL = \"https://restapi.cdn.azure.cn/subscriptions/e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb/endpoints/8137ecc4-71c4-11e7-8259-0017fa00a611?apiVersion=1.0\";\r  \r String requestTimestamp = TimeUtil.getUTCTime();\r String keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r String keyValue = \"<cdn-key>\";\r String httpMethod = \"GET\";\r \r CdnOperation cOperation = new CdnOperation();\r String authorization = cOperation.calculateAuthorizationHeader(\r             requestURL, \r             requestTimestamp,\r             keyID, \r             keyValue, \r             httpMethod);\r       \r String result = cOperation.getRequest(\r             requestURL,\r             authorization, \r             requestTimestamp);\r System.out.println(result);\r \r AzureCDN cc65a046-2a32-4f7d-ab22-9ae49507d719:AE889EA579556251F5CA57B19361BE57C22550F0D8E4941E50819CB9F0296967\r {\"EndpointId\":\"8137ecc4-71c4-11e7-8259-0017fa00a611\",\"Settings\":{\"CustomDomain\":\"file.azurecloudapi.cn\",\"Host\":\"file.azurecloudapi.cn\",\"Origin\":{\"Addresses\":[\"devstoragerm.blob.core.chinacloudapi.cn\"],\"SchemePort\":{\"Scheme\":\"Http\",\"HttpPort\":80}},\"ICP\":\"?ICP?16013159?\",\"ServiceType\":\"Download\",\"AllowedScheme\":\"Http\",\"CName\":\"file.azurecloudapi.cn.mschcdn.com\"},\"Status\":{\"Enabled\":true,\"IcpVerifyStatus\":\"IcpVerified\",\"LifetimeStatus\":\"Normal\",\"CNameConfigured\":false,\"FreeTrialExpired\":false,\"TimeLastUpdated\":\"2017-07-26T05:46:00+00:00\"}}\r ```\r \r ## 刷新缓存调用详解\r \r - Endpoint：\r \r     `POST https://restapi.cdn.azure.cn/subscriptions/{subscriptionId}/endpoints/{endpointId}/purges?apiVersion=1.0`\r \r - 请求参数\r \r     | 参数名称 | 参数值 |\r     | ------- | ------ |\r     | x-azurecdn-request-date | 必填。符合yyyy-MM-dd hh:mm:ss格式的UTC当前请求时间 |\r     | Authorization | 必填。授权头请参考 [CDN API 签名机制](https://docs.azure.cn/zh-cn/cdn/cdn-api-signature) |\r     | content-type | application/json |\r \r ### 测试用例\r \r ```Java\r static void Main(string[] args)\r {\r // get\r     var requestUrl = string.Format(\"https://restapi.cdn.azure.cn/subscriptions/{0}/endpoints?apiVersion=1.0\", \"e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb\");\r     var requestTime = DateTime.Now.AddHours(-8)\r         .ToString(\"yyyy-MM-dd hh:mm:ss\");\r     var keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r     var keySecret = \"秘钥\";\r     var requestAuth = CalculateAuthorizationHeader(\r \t\trequestUrl, requestTime, keyID, keySecret, \"GET\");\r     Console.WriteLine(requestTime);\r     Console.WriteLine(requestAuth);   \r     get(requestUrl, requestAuth, requestTime);\r \r     requestUrl = string.Format(\"https://restapi.cdn.azure.cn/subscriptions/{0}/endpoints/{1}/purges?apiVersion=1.0\", \"e0fbea86-6cf2-4b2d-81e2-9c59f4f96bcb\", \"4f7e4141-83d0-11e7-8259-0017fa00a611\");\r     requestTime = DateTime.Now.AddHours(-8)\r \t\t.ToString(\"yyyy-MM-dd hh:mm:ss\");\r     keyID = \"cc65a046-2a32-4f7d-ab22-9ae49507d719\";\r     keySecret = \"秘钥\";\r     requestAuth = CalculateAuthorizationHeader(\r         requestUrl, requestTime, keyID, keySecret, \"POST\");\r     var requestBody = \"{\\\"Files\\\": [\\\"http://azurecloudapi.cn/wp-content/uploads/2016/09/logo2-1.png\\\"],\\\"Directories\\\": [ \\\"http://azurecloudapi.cn/wp-content/uploads/2016/09/\\\"]}\";\r     post(requestUrl, requestAuth, requestTime,requestBody);\r     Console.ReadLine();\r }\r \r static  void get(string requestUrl, string requestAuth, string requestTime)\r {\r \r     Uri uri = new Uri(requestUrl);\r     HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri);\r     request.Method = \"GET\";\r     request.Headers[\"x-azurecdn-request-date\"] = requestTime;\r     request.Headers[\"Authorization\"] = requestAuth;\r \r     try\r     {\r         HttpWebResponse response = (HttpWebResponse)request.GetResponse();\r         using (StreamReader reader = new \r         StreamReader(response.GetResponseStream()))\r         {\r             var result = reader.ReadToEnd();\r             Console.WriteLine(result);\r         }\r         response.Close();\r \r     }\r     catch (WebException ex)\r     {\r         Console.WriteLine(ex);\r     }\r }\r \r static async void post(string requestUrl, string requestAuth, string requestTime, string requestBody)\r {\r     Uri uri = new Uri(requestUrl);\r     HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri);\r     request.Method = \"POST\";\r     request.Headers[\"x-azurecdn-request-date\"] = requestTime;\r     request.Headers[\"Authorization\"] = requestAuth;\r \r     byte[] byteArray = Encoding.UTF8.GetBytes(requestBody);\r     request.ContentLength = byteArray.Length;\r     Stream newStream = request.GetRequestStream();\r     newStream.Write(byteArray, 0, byteArray.Length);\r     newStream.Close();\r \r     try\r     {\r         HttpWebResponse response = (HttpWebResponse)request.GetResponse();\r \r         using (StreamReader reader = new StreamReader(response.GetResponseStream()))\r         {\r             var result = reader.ReadToEnd();\r             Console.WriteLine(result);\r         }\r         response.Close();\r     }\r     catch (WebException ex)\r     {\r         Console.WriteLine(ex);\r     }\r }\r ```\r \r ## 示例代码\r \r [Azure CDN Demo](https://github.com/wacn/AOG-CodeSample/tree/master/cdn/Java/azure-cdn-demo-master)"}